require=(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({"framework7":[function(require,module,exports){
/**
 * Framework7 1.4.2
 * Full Featured Mobile HTML Framework For Building iOS & Android Apps
 * 
 * http://www.idangero.us/framework7
 * 
 * Copyright 2016, Vladimir Kharlampidi
 * The iDangero.us
 * http://www.idangero.us/
 * 
 * Licensed under MIT
 * 
 * Released on: February 27, 2016
 */
(function () {

    'use strict';
    /*===========================
    Framework 7
    ===========================*/
    window.Framework7 = function (params) {
        // App
        var app = this;
    
        // Version
        app.version = '1.4.2';
    
        // Default Parameters
        app.params = {
            cache: true,
            cacheIgnore: [],
            cacheIgnoreGetParameters: false,
            cacheDuration: 1000 * 60 * 10, // Ten minutes
            preloadPreviousPage: true,
            uniqueHistory: false,
            uniqueHistoryIgnoreGetParameters: false,
            dynamicPageUrl: 'content-{{index}}',
            allowDuplicateUrls: false,
            router: true,
            // Push State
            pushState: false,
            pushStateRoot: undefined,
            pushStateNoAnimation: false,
            pushStateSeparator: '#!/',
            pushStateOnLoad: true,
            // Fast clicks
            fastClicks: true,
            fastClicksDistanceThreshold: 10,
            fastClicksDelayBetweenClicks: 50,
            // Tap Hold
            tapHold: false,
            tapHoldDelay: 750,
            tapHoldPreventClicks: true,
            // Active State
            activeState: true,
            activeStateElements: 'a, button, label, span',
            // Animate Nav Back Icon
            animateNavBackIcon: false,
            // Swipe Back
            swipeBackPage: true,
            swipeBackPageThreshold: 0,
            swipeBackPageActiveArea: 30,
            swipeBackPageAnimateShadow: true,
            swipeBackPageAnimateOpacity: true,
            // Ajax
            ajaxLinks: undefined, // or CSS selector
            // External Links
            externalLinks: '.external', // CSS selector
            // Sortable
            sortable: true,
            // Scroll toolbars
            hideNavbarOnPageScroll: false,
            hideToolbarOnPageScroll: false,
            hideTabbarOnPageScroll: false,
            showBarsOnPageScrollEnd: true,
            showBarsOnPageScrollTop: true,
            // Swipeout
            swipeout: true,
            swipeoutActionsNoFold: false,
            swipeoutNoFollow: false,
            // Smart Select Back link template
            smartSelectOpenIn: 'page', // or 'popup' or 'picker'
            smartSelectBackText: 'Back',
            smartSelectPopupCloseText: 'Close',
            smartSelectPickerCloseText: 'Done',
            smartSelectSearchbar: false,
            smartSelectBackOnSelect: false,
            // Tap Navbar or Statusbar to scroll to top
            scrollTopOnNavbarClick: false,
            scrollTopOnStatusbarClick: false,
            // Panels
            swipePanel: false, // or 'left' or 'right'
            swipePanelActiveArea: 0,
            swipePanelCloseOpposite: true,
            swipePanelOnlyClose: false,
            swipePanelNoFollow: false,
            swipePanelThreshold: 0,
            panelsCloseByOutside: true,
            // Modals
            modalButtonOk: 'OK',
            modalButtonCancel: 'Cancel',
            modalUsernamePlaceholder: 'Username',
            modalPasswordPlaceholder: 'Password',
            modalTitle: 'Framework7',
            modalCloseByOutside: false,
            actionsCloseByOutside: true,
            popupCloseByOutside: true,
            modalPreloaderTitle: 'Loading... ',
            modalStack: true,
            // Lazy Load
            imagesLazyLoadThreshold: 0,
            imagesLazyLoadSequential: true,
            // Name space
            viewClass: 'view',
            viewMainClass: 'view-main',
            viewsClass: 'views',
            // Notifications defaults
            notificationCloseOnClick: false,
            notificationCloseIcon: true,
            notificationCloseButtonText: 'Close',
            // Animate Pages
            animatePages: true,
            // Template7
            templates: {},
            template7Data: {},
            template7Pages: false,
            precompileTemplates: false,
            // Material
            material: false,
            materialPageLoadDelay: 0,
            materialPreloaderSvg: '<svg xmlns="http://www.w3.org/2000/svg" height="75" width="75" viewbox="0 0 75 75"><circle cx="37.5" cy="37.5" r="33.5" stroke-width="8"/></svg>',
            materialPreloaderHtml:
                '<span class="preloader-inner">' +
                    '<span class="preloader-inner-gap"></span>' +
                    '<span class="preloader-inner-left">' +
                        '<span class="preloader-inner-half-circle"></span>' +
                    '</span>' +
                    '<span class="preloader-inner-right">' +
                        '<span class="preloader-inner-half-circle"></span>' +
                    '</span>' +
                '</span>',
            materialRipple: true,
            materialRippleElements: '.ripple, a.link, a.item-link, .button, .modal-button, .tab-link, .label-radio, .label-checkbox, .actions-modal-button, a.searchbar-clear, a.floating-button, .floating-button > a, .speed-dial-buttons a',
            // Auto init
            init: true,
        };
    
        // Extend defaults with parameters
        for (var param in params) {
            app.params[param] = params[param];
        }
    
        // DOM lib
        var $ = Dom7;
    
        // Template7 lib
        var t7 = Template7;
        app._compiledTemplates = {};
    
        // Touch events
        app.touchEvents = {
            start: app.support.touch ? 'touchstart' : 'mousedown',
            move: app.support.touch ? 'touchmove' : 'mousemove',
            end: app.support.touch ? 'touchend' : 'mouseup'
        };
    
        // Link to local storage
        app.ls = window.localStorage;
    
        // RTL
        app.rtl = $('body').css('direction') === 'rtl';
        if (app.rtl) $('html').attr('dir', 'rtl');
    
        // Overwrite statusbar overlay
        if (typeof app.params.statusbarOverlay !== 'undefined') {
            if (app.params.statusbarOverlay) $('html').addClass('with-statusbar-overlay');
            else $('html').removeClass('with-statusbar-overlay');
        }
    
        
    

        /*======================================================
        ************   Views   ************
        ======================================================*/
        app.views = [];
        var View = function (selector, params) {
            var defaults = {
                dynamicNavbar: false,
                domCache: false,
                linksView: undefined,
                reloadPages: false,
                uniqueHistory: app.params.uniqueHistory,
                uniqueHistoryIgnoreGetParameters: app.params.uniqueHistoryIgnoreGetParameters,
                allowDuplicateUrls: app.params.allowDuplicateUrls,
                swipeBackPage: app.params.swipeBackPage,
                swipeBackPageAnimateShadow: app.params.swipeBackPageAnimateShadow,
                swipeBackPageAnimateOpacity: app.params.swipeBackPageAnimateOpacity,
                swipeBackPageActiveArea: app.params.swipeBackPageActiveArea,
                swipeBackPageThreshold: app.params.swipeBackPageThreshold,
                animatePages: app.params.animatePages,
                preloadPreviousPage: app.params.preloadPreviousPage
            };
            var i;
        
            // Params
            params = params || {};
        
            // Disable dynamic navbar for material theme
            if (params.dynamicNavbar && app.params.material) params.dynamicNavbar = false;
        
            // Extend params with defaults
            for (var def in defaults) {
                if (typeof params[def] === 'undefined') {
                    params[def] = defaults[def];
                }
            }
            // View
            var view = this;
            view.params = params;
        
            // Selector
            view.selector = selector;
        
            // Container
            var container = $(selector);
            view.container = container[0];
        
            // Fix Selector
        
            if (typeof selector !== 'string') {
                // Supposed to be HTMLElement or Dom7
                selector = (container.attr('id') ? '#' + container.attr('id') : '') + (container.attr('class') ? '.' + container.attr('class').replace(/ /g, '.').replace('.active', '') : '');
                view.selector = selector;
            }
        
            // Is main
            view.main = container.hasClass(app.params.viewMainClass);
        
            // Content cache
            view.contentCache = {};
        
            // Pages cache
            view.pagesCache = {};
        
            // Store View in element for easy access
            container[0].f7View = view;
        
            // Pages
            view.pagesContainer = container.find('.pages')[0];
            view.initialPages = [];
            view.initialPagesUrl = [];
            view.initialNavbars = [];
            if (view.params.domCache) {
                var initialPages = container.find('.page');
                for (i = 0; i < initialPages.length; i++) {
                    view.initialPages.push(initialPages[i]);
                    view.initialPagesUrl.push('#' + initialPages.eq(i).attr('data-page'));
                }
                if (view.params.dynamicNavbar) {
                    var initialNavbars = container.find('.navbar-inner');
                    for (i = 0; i < initialNavbars.length; i++) {
                        view.initialNavbars.push(initialNavbars[i]);
                    }
                }
        
            }
        
            view.allowPageChange = true;
        
            // Location
            var docLocation = document.location.href;
        
            // History
            view.history = [];
            var viewURL = docLocation;
            var pushStateSeparator = app.params.pushStateSeparator;
            var pushStateRoot = app.params.pushStateRoot;
            if (app.params.pushState && view.main) {
                if (pushStateRoot) {
                    viewURL = pushStateRoot;
                }
                else {
                    if (viewURL.indexOf(pushStateSeparator) >= 0 && viewURL.indexOf(pushStateSeparator + '#') < 0) viewURL = viewURL.split(pushStateSeparator)[0];
                }
        
            }
        
            // Active Page
            var currentPage, currentPageData;
            if (!view.activePage) {
                currentPage = $(view.pagesContainer).find('.page-on-center');
                if (currentPage.length === 0) {
                    currentPage = $(view.pagesContainer).find('.page:not(.cached)');
                    currentPage = currentPage.eq(currentPage.length - 1);
                }
                if (currentPage.length > 0) {
                    currentPageData = currentPage[0].f7PageData;
                }
            }
        
            // View startup URL
            if (view.params.domCache && currentPage) {
                view.url = container.attr('data-url') || view.params.url || '#' + currentPage.attr('data-page');   
                view.pagesCache[view.url] = currentPage.attr('data-page');
            }
            else view.url = container.attr('data-url') || view.params.url || viewURL;
        
            // Update current page Data
            if (currentPageData) {
                currentPageData.view = view;
                currentPageData.url = view.url;
                if (view.params.domCache && view.params.dynamicNavbar && !currentPageData.navbarInnerContainer) {
                    currentPageData.navbarInnerContainer = view.initialNavbars[view.initialPages.indexOf(currentPageData.container)];
                }
                view.activePage = currentPageData;
                currentPage[0].f7PageData = currentPageData;
            }
        
            // Store to history main view's url
            if (view.url) {
                view.history.push(view.url);
            }
        
            // Touch events
            var isTouched = false,
                isMoved = false,
                touchesStart = {},
                isScrolling,
                activePage = [],
                previousPage = [],
                viewContainerWidth,
                touchesDiff,
                allowViewTouchMove = true,
                touchStartTime,
                activeNavbar = [],
                previousNavbar = [],
                activeNavElements,
                previousNavElements,
                activeNavBackIcon,
                previousNavBackIcon,
                dynamicNavbar,
                pageShadow,
                el;
        
            view.handleTouchStart = function (e) {
                if (!allowViewTouchMove || !view.params.swipeBackPage || isTouched || app.swipeoutOpenedEl || !view.allowPageChange) return;
                isMoved = false;
                isTouched = true;
                isScrolling = undefined;
                touchesStart.x = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
                touchesStart.y = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                touchStartTime = (new Date()).getTime();
                dynamicNavbar = view.params.dynamicNavbar && container.find('.navbar-inner').length > 1;
            };
        
            view.handleTouchMove = function (e) {
                if (!isTouched) return;
                var pageX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                var pageY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                if (typeof isScrolling === 'undefined') {
                    isScrolling = !!(isScrolling || Math.abs(pageY - touchesStart.y) > Math.abs(pageX - touchesStart.x));
                }
                if (isScrolling || e.f7PreventSwipeBack || app.preventSwipeBack) {
                    isTouched = false;
                    return;
                }
                if (!isMoved) {
                    var cancel = false;
                    // Calc values during first move fired
                    viewContainerWidth = container.width();
                    var target = $(e.target);
                    var swipeout = target.hasClass('swipeout') ? target : target.parents('.swipeout');
                    if (swipeout.length > 0) {
                        if (!app.rtl && swipeout.find('.swipeout-actions-left').length > 0) cancel = true;
                        if (app.rtl && swipeout.find('.swipeout-actions-right').length > 0) cancel = true;
                    }
                    activePage = target.is('.page') ? target : target.parents('.page');
                    if (activePage.hasClass('no-swipeback')) cancel = true;
                    previousPage = container.find('.page-on-left:not(.cached)');
                    var notFromBorder = touchesStart.x - container.offset().left > view.params.swipeBackPageActiveArea;
                    if (app.rtl) {
                        notFromBorder = touchesStart.x < container.offset().left - container[0].scrollLeft + viewContainerWidth - view.params.swipeBackPageActiveArea;
                    }
                    else {
                        notFromBorder = touchesStart.x - container.offset().left > view.params.swipeBackPageActiveArea;
                    }
                    if (notFromBorder) cancel = true;
                    if (previousPage.length === 0 || activePage.length === 0) cancel = true;
                    if (cancel) {
                        isTouched = false;
                        return;
                    }
        
                    if (view.params.swipeBackPageAnimateShadow && !app.device.android) {
                        pageShadow = activePage.find('.swipeback-page-shadow');
                        if (pageShadow.length === 0) {
                            pageShadow = $('<div class="swipeback-page-shadow"></div>');
                            activePage.append(pageShadow);
                        }
                    }
        
                    if (dynamicNavbar) {
                        activeNavbar = container.find('.navbar-on-center:not(.cached)');
                        previousNavbar = container.find('.navbar-on-left:not(.cached)');
                        activeNavElements = activeNavbar.find('.left, .center, .right, .subnavbar, .fading');
                        previousNavElements = previousNavbar.find('.left, .center, .right, .subnavbar, .fading');
                        if (app.params.animateNavBackIcon) {
                            activeNavBackIcon = activeNavbar.find('.left.sliding .back .icon');
                            previousNavBackIcon = previousNavbar.find('.left.sliding .back .icon');
                        }
                    }
        
                    // Close/Hide Any Picker
                    if ($('.picker-modal.modal-in').length > 0) {
                        app.closeModal($('.picker-modal.modal-in'));
                    }
                }
                e.f7PreventPanelSwipe = true;
                isMoved = true;
                e.preventDefault();
        
                // RTL inverter
                var inverter = app.rtl ? -1 : 1;
        
                // Touches diff
                touchesDiff = (pageX - touchesStart.x - view.params.swipeBackPageThreshold) * inverter;
                if (touchesDiff < 0) touchesDiff = 0;
                var percentage = touchesDiff / viewContainerWidth;
        
                // Swipe Back Callback
                var callbackData = {
                    percentage: percentage,
                    activePage: activePage[0],
                    previousPage: previousPage[0],
                    activeNavbar: activeNavbar[0],
                    previousNavbar: previousNavbar[0]
                };
                if (view.params.onSwipeBackMove) {
                    view.params.onSwipeBackMove(callbackData);
                }
                container.trigger('swipeBackMove', callbackData);
        
                // Transform pages
                var activePageTranslate = touchesDiff * inverter;
                var previousPageTranslate = (touchesDiff / 5 - viewContainerWidth / 5) * inverter;
                if (app.device.pixelRatio === 1) {
                    activePageTranslate = Math.round(activePageTranslate);
                    previousPageTranslate = Math.round(previousPageTranslate);
                }
        
                activePage.transform('translate3d(' + activePageTranslate + 'px,0,0)');
                if (view.params.swipeBackPageAnimateShadow && !app.device.android) pageShadow[0].style.opacity = 1 - 1 * percentage;
        
                previousPage.transform('translate3d(' + previousPageTranslate + 'px,0,0)');
                if (view.params.swipeBackPageAnimateOpacity) previousPage[0].style.opacity = 0.9 + 0.1 * percentage;
        
                // Dynamic Navbars Animation
                if (dynamicNavbar) {
                    var i;
                    for (i = 0; i < activeNavElements.length; i++) {
                        el = $(activeNavElements[i]);
                        if (!el.is('.subnavbar.sliding')) el[0].style.opacity = (1 - percentage * 1.3);
                        if (el[0].className.indexOf('sliding') >= 0) {
                            var activeNavTranslate = percentage * el[0].f7NavbarRightOffset;
                            if (app.device.pixelRatio === 1) activeNavTranslate = Math.round(activeNavTranslate);
                            el.transform('translate3d(' + activeNavTranslate + 'px,0,0)');
                            if (app.params.animateNavBackIcon) {
                                if (el[0].className.indexOf('left') >= 0 && activeNavBackIcon.length > 0) {
                                    activeNavBackIcon.transform('translate3d(' + -activeNavTranslate + 'px,0,0)');
                                }
                            }
                        }
                    }
                    for (i = 0; i < previousNavElements.length; i++) {
                        el = $(previousNavElements[i]);
                        if (!el.is('.subnavbar.sliding')) el[0].style.opacity = percentage * 1.3 - 0.3;
                        if (el[0].className.indexOf('sliding') >= 0) {
                            var previousNavTranslate = el[0].f7NavbarLeftOffset * (1 - percentage);
                            if (app.device.pixelRatio === 1) previousNavTranslate = Math.round(previousNavTranslate);
                            el.transform('translate3d(' + previousNavTranslate + 'px,0,0)');
                            if (app.params.animateNavBackIcon) {
                                if (el[0].className.indexOf('left') >= 0 && previousNavBackIcon.length > 0) {
                                    previousNavBackIcon.transform('translate3d(' + -previousNavTranslate + 'px,0,0)');
                                }
                            }
                        }
                    }
                }
            };
        
            view.handleTouchEnd = function (e) {
                if (!isTouched || !isMoved) {
                    isTouched = false;
                    isMoved = false;
                    return;
                }
                isTouched = false;
                isMoved = false;
                if (touchesDiff === 0) {
                    $([activePage[0], previousPage[0]]).transform('').css({opacity: '', boxShadow: ''});
                    if (dynamicNavbar) {
                        activeNavElements.transform('').css({opacity: ''});
                        previousNavElements.transform('').css({opacity: ''});
                        if (activeNavBackIcon && activeNavBackIcon.length > 0) activeNavBackIcon.transform('');
                        if (previousNavBackIcon && activeNavBackIcon.length > 0) previousNavBackIcon.transform('');
                    }
                    return;
                }
                var timeDiff = (new Date()).getTime() - touchStartTime;
                var pageChanged = false;
                // Swipe back to previous page
                if (
                        timeDiff < 300 && touchesDiff > 10 ||
                        timeDiff >= 300 && touchesDiff > viewContainerWidth / 2
                    ) {
                    activePage.removeClass('page-on-center').addClass('page-on-right');
                    previousPage.removeClass('page-on-left').addClass('page-on-center');
                    if (dynamicNavbar) {
                        activeNavbar.removeClass('navbar-on-center').addClass('navbar-on-right');
                        previousNavbar.removeClass('navbar-on-left').addClass('navbar-on-center');
                    }
                    pageChanged = true;
                }
                // Reset custom styles
                // Add transitioning class for transition-duration
                $([activePage[0], previousPage[0]]).transform('').css({opacity: '', boxShadow: ''}).addClass('page-transitioning');
                if (dynamicNavbar) {
                    activeNavElements.css({opacity: ''})
                    .each(function () {
                        var translate = pageChanged ? this.f7NavbarRightOffset : 0;
                        var sliding = $(this);
                        sliding.transform('translate3d(' + translate + 'px,0,0)');
                        if (app.params.animateNavBackIcon) {
                            if (sliding.hasClass('left') && activeNavBackIcon.length > 0) {
                                activeNavBackIcon.addClass('page-transitioning').transform('translate3d(' + -translate + 'px,0,0)');
                            }
                        }
        
                    }).addClass('page-transitioning');
        
                    previousNavElements.transform('').css({opacity: ''}).each(function () {
                        var translate = pageChanged ? 0 : this.f7NavbarLeftOffset;
                        var sliding = $(this);
                        sliding.transform('translate3d(' + translate + 'px,0,0)');
                        if (app.params.animateNavBackIcon) {
                            if (sliding.hasClass('left') && previousNavBackIcon.length > 0) {
                                previousNavBackIcon.addClass('page-transitioning').transform('translate3d(' + -translate + 'px,0,0)');
                            }
                        }
                    }).addClass('page-transitioning');
                }
                allowViewTouchMove = false;
                view.allowPageChange = false;
                // Swipe Back Callback
                var callbackData = {
                    activePage: activePage[0],
                    previousPage: previousPage[0],
                    activeNavbar: activeNavbar[0],
                    previousNavbar: previousNavbar[0]
                };
                if (pageChanged) {
                    // Update View's URL
                    var url = view.history[view.history.length - 2];
                    view.url = url;
        
                    // Page before animation callback
                    app.pageBackCallback('before', view, {pageContainer: activePage[0], url: url, position: 'center', newPage: previousPage, oldPage: activePage, swipeBack: true});
                    app.pageAnimCallback('before', view, {pageContainer: previousPage[0], url: url, position: 'left', newPage: previousPage, oldPage: activePage, swipeBack: true});
        
                    if (view.params.onSwipeBackBeforeChange) {
                        view.params.onSwipeBackBeforeChange(callbackData);
                    }
                    container.trigger('swipeBackBeforeChange', callbackData);
                }
                else {
                    if (view.params.onSwipeBackBeforeReset) {
                        view.params.onSwipeBackBeforeReset(callbackData);
                    }
                    container.trigger('swipeBackBeforeReset', callbackData);
                }
        
                activePage.transitionEnd(function () {
                    $([activePage[0], previousPage[0]]).removeClass('page-transitioning');
                    if (dynamicNavbar) {
                        activeNavElements.removeClass('page-transitioning').css({opacity: ''});
                        previousNavElements.removeClass('page-transitioning').css({opacity: ''});
                        if (activeNavBackIcon && activeNavBackIcon.length > 0) activeNavBackIcon.removeClass('page-transitioning');
                        if (previousNavBackIcon && previousNavBackIcon.length > 0) previousNavBackIcon.removeClass('page-transitioning');
                    }
                    allowViewTouchMove = true;
                    view.allowPageChange = true;
                    if (pageChanged) {
                        if (app.params.pushState && view.main) history.back();
                        // Page after animation callback
                        app.pageBackCallback('after', view, {pageContainer: activePage[0], url: url, position: 'center', newPage: previousPage, oldPage: activePage, swipeBack: true});
                        app.pageAnimCallback('after', view, {pageContainer: previousPage[0], url: url, position: 'left', newPage: previousPage, oldPage: activePage, swipeBack: true});
                        app.router.afterBack(view, activePage, previousPage);
        
                        if (view.params.onSwipeBackAfterChange) {
                            view.params.onSwipeBackAfterChange(callbackData);
                        }
                        container.trigger('swipeBackAfterChange', callbackData);
                    }
                    else {
                        if (view.params.onSwipeBackAfterReset) {
                            view.params.onSwipeBackAfterReset(callbackData);
                        }
                        container.trigger('swipeBackAfterReset', callbackData);
                    }
                    if (pageShadow && pageShadow.length > 0) pageShadow.remove();
                });
            };
            view.attachEvents = function (detach) {
                var action = detach ? 'off' : 'on';
                container[action](app.touchEvents.start, view.handleTouchStart);
                container[action](app.touchEvents.move, view.handleTouchMove);
                container[action](app.touchEvents.end, view.handleTouchEnd);
            };
            view.detachEvents = function () {
                view.attachEvents(true);
            };
        
            // Init
            if (view.params.swipeBackPage && !app.params.material) {
                view.attachEvents();
            }
        
            // Add view to app
            app.views.push(view);
            if (view.main) app.mainView = view;
        
            // Router 
            view.router = {
                load: function (options) {
                    return app.router.load(view, options);
                },
                back: function (options) {
                    return app.router.back(view, options);  
                },
                // Shortcuts
                loadPage: function (options) {
                    options = options || {};
                    if (typeof options === 'string') {
                        var url = options;
                        options = {};
                        if (url && url.indexOf('#') === 0 && view.params.domCache) {
                            options.pageName = url.split('#')[1];
                        }
                        else options.url = url;
                    }
                    return app.router.load(view, options);
                },
                loadContent: function (content) {
                    return app.router.load(view, {content: content});
                },
                reloadPage: function (url) {
                    return app.router.load(view, {url: url, reload: true});
                },
                reloadContent: function (content) {
                    return app.router.load(view, {content: content, reload: true});
                },
                reloadPreviousPage: function (url) {
                    return app.router.load(view, {url: url, reloadPrevious: true, reload: true});
                },
                reloadPreviousContent: function (content) {
                    return app.router.load(view, {content: content, reloadPrevious: true, reload: true});
                },
                refreshPage: function () {
                    var options = {
                        url: view.url,
                        reload: true,
                        ignoreCache: true
                    };
                    if (options.url && options.url.indexOf('#') === 0) {
                        if (view.params.domCache && view.pagesCache[options.url]) {
                            options.pageName = view.pagesCache[options.url];
                            options.url = undefined;
                            delete options.url;
                        }
                        else if (view.contentCache[options.url]) {
                            options.content = view.contentCache[options.url];
                            options.url = undefined;
                            delete options.url;
                        }
                    }
                    return app.router.load(view, options);
                },
                refreshPreviousPage: function () {
                    var options = {
                        url: view.history[view.history.length - 2],
                        reload: true,
                        reloadPrevious: true,
                        ignoreCache: true
                    };
                    if (options.url && options.url.indexOf('#') === 0 && view.params.domCache && view.pagesCache[options.url]) {
                        options.pageName = view.pagesCache[options.url];
                        options.url = undefined;
                        delete options.url;
                    }
                    return app.router.load(view, options);
                }
            };
        
            // Aliases for temporary backward compatibility
            view.loadPage = view.router.loadPage;
            view.loadContent = view.router.loadContent;
            view.reloadPage = view.router.reloadPage;
            view.reloadContent = view.router.reloadContent;
            view.reloadPreviousPage = view.router.reloadPreviousPage;
            view.reloadPreviousContent = view.router.reloadPreviousContent;
            view.refreshPage = view.router.refreshPage;
            view.refreshPreviousPage = view.router.refreshPreviousPage;
            view.back = view.router.back;
        
            // Bars methods
            view.hideNavbar = function () {
                return app.hideNavbar(container.find('.navbar'));
            };
            view.showNavbar = function () {
                return app.showNavbar(container.find('.navbar'));
            };
            view.hideToolbar = function () {
                return app.hideToolbar(container.find('.toolbar'));
            };
            view.showToolbar = function () {
                return app.showToolbar(container.find('.toolbar'));
            };
        
            // Push State on load
            if (app.params.pushState && app.params.pushStateOnLoad && view.main) {
                var pushStateUrl;
                var pushStateUrlSplit = docLocation.split(pushStateSeparator)[1];
                if (pushStateRoot) {
                    pushStateUrl = docLocation.split(app.params.pushStateRoot + pushStateSeparator)[1];
                }
                else if (pushStateSeparator && docLocation.indexOf(pushStateSeparator) >= 0 && docLocation.indexOf(pushStateSeparator + '#') < 0) {
                    pushStateUrl = pushStateUrlSplit;
                }
                var pushStateAnimatePages = app.params.pushStateNoAnimation ? false : undefined;
                var historyState = history.state;
                if (pushStateUrl) {
                    if (pushStateUrl.indexOf('#') >= 0 && view.params.domCache && historyState && historyState.pageName && 'viewIndex' in historyState) {
                        app.router.load(view, {pageName: historyState.pageName, url: historyState.url, animatePages: pushStateAnimatePages, pushState: false});
                    }
                    else if (pushStateUrl.indexOf('#') >= 0 && view.params.domCache && view.initialPagesUrl.indexOf(pushStateUrl) >= 0) {
                        app.router.load(view, {pageName: pushStateUrl.replace('#',''), animatePages: pushStateAnimatePages, pushState: false});
                    }
                    else app.router.load(view, {url: pushStateUrl, animatePages: pushStateAnimatePages, pushState: false});
                }
                else if (view.params.domCache && docLocation.indexOf(pushStateSeparator + '#') >= 0) {
                    if (historyState && historyState.pageName && 'viewIndex' in historyState) {
                        app.router.load(view, {pageName: historyState.pageName, url: historyState.url, animatePages: pushStateAnimatePages, pushState: false});
                    }
                    else if (pushStateSeparator && pushStateUrlSplit.indexOf('#') === 0) {
                        if (view.initialPagesUrl.indexOf(pushStateUrlSplit)) {
                            app.router.load(view, {pageName: pushStateUrlSplit.replace('#', ''), animatePages: pushStateAnimatePages, pushState: false});
                        }
                    }
                }
            }
        
            // Destroy
            view.destroy = function () {
                view.detachEvents();
                view = undefined;
            };
        
            // Plugin hook
            app.pluginHook('addView', view);
        
            // Return view
            return view;
        };
        
        app.addView = function (selector, params) {
            return new View(selector, params);
        };
        
        app.getCurrentView = function (index) {
            var popoverView = $('.popover.modal-in .view');
            var popupView = $('.popup.modal-in .view');
            var panelView = $('.panel.active .view');
            var appViews = $('.views');
            // Find active view as tab
            var appView = appViews.children('.view');
            // Propably in tabs or split view
            if (appView.length > 1) {
                if (appView.hasClass('tab')) {
                    // Tabs
                    appView = appViews.children('.view.active');
                }
                else {
                    // Split View, leave appView intact
                }
            }
            if (popoverView.length > 0 && popoverView[0].f7View) return popoverView[0].f7View;
            if (popupView.length > 0 && popupView[0].f7View) return popupView[0].f7View;
            if (panelView.length > 0 && panelView[0].f7View) return panelView[0].f7View;
            if (appView.length > 0) {
                if (appView.length === 1 && appView[0].f7View) return appView[0].f7View;
                if (appView.length > 1) {
                    var currentViews = [];
                    for (var i = 0; i < appView.length; i++) {
                        if (appView[i].f7View) currentViews.push(appView[i].f7View);
                    }
                    if (currentViews.length > 0 && typeof index !== 'undefined') return currentViews[index];
                    if (currentViews.length > 1) return currentViews;
                    if (currentViews.length === 1) return currentViews[0];
                    return undefined;
                }
            }
            return undefined;
        };
        

        /*======================================================
        ************   Navbars && Toolbars   ************
        ======================================================*/
        // On Navbar Init Callback
        app.navbarInitCallback = function (view, pageContainer, navbarContainer, navbarInnerContainer) {
            if (!navbarContainer && navbarInnerContainer) navbarContainer = $(navbarInnerContainer).parent('.navbar')[0];
            if (navbarInnerContainer.f7NavbarInitialized && view && !view.params.domCache) return;
            var navbarData = {
                container: navbarContainer,
                innerContainer: navbarInnerContainer
            };
            var pageData = pageContainer && pageContainer.f7PageData;
        
            var eventData = {
                page: pageData,
                navbar: navbarData
            };
        
            if (navbarInnerContainer.f7NavbarInitialized && ((view && view.params.domCache) || (!view && $(navbarContainer).parents('.popup, .popover, .login-screen, .modal, .actions-modal, .picker-modal').length > 0))) {
                // Reinit Navbar
                app.reinitNavbar(navbarContainer, navbarInnerContainer);
        
                // Plugin hook
                app.pluginHook('navbarReinit', eventData);
        
                // Event
                $(navbarInnerContainer).trigger('navbarReinit', eventData);
                return;
            }
            navbarInnerContainer.f7NavbarInitialized = true;
            // Before Init
            app.pluginHook('navbarBeforeInit', navbarData, pageData);
            $(navbarInnerContainer).trigger('navbarBeforeInit', eventData);
        
            // Initialize Navbar
            app.initNavbar(navbarContainer, navbarInnerContainer);
        
            // On init
            app.pluginHook('navbarInit', navbarData, pageData);
            $(navbarInnerContainer).trigger('navbarInit', eventData);
        };
        // Navbar Remove Callback
        app.navbarRemoveCallback = function (view, pageContainer, navbarContainer, navbarInnerContainer) {
            if (!navbarContainer && navbarInnerContainer) navbarContainer = $(navbarInnerContainer).parent('.navbar')[0];
            var navbarData = {
                container: navbarContainer,
                innerContainer: navbarInnerContainer
            };
            var pageData = pageContainer.f7PageData;
        
            var eventData = {
                page: pageData,
                navbar: navbarData
            };
            app.pluginHook('navbarBeforeRemove', navbarData, pageData);
            $(navbarInnerContainer).trigger('navbarBeforeRemove', eventData);
        };
        app.initNavbar = function (navbarContainer, navbarInnerContainer) {
            // Init Subnavbar Searchbar
            if (app.initSearchbar) app.initSearchbar(navbarInnerContainer);
        };
        app.reinitNavbar = function (navbarContainer, navbarInnerContainer) {
            // Re init navbar methods
        };
        app.initNavbarWithCallback = function (navbarContainer) {
            navbarContainer = $(navbarContainer);
            var viewContainer = navbarContainer.parents('.' + app.params.viewClass);
            var view;
            if (viewContainer.length === 0) return;
            if (navbarContainer.parents('.navbar-through').length === 0 && viewContainer.find('.navbar-through').length === 0) return;
            view = viewContainer[0].f7View || undefined;
        
            navbarContainer.find('.navbar-inner').each(function () {
                var navbarInnerContainer = this;
                var pageContainer;
                if ($(navbarInnerContainer).attr('data-page')) {
                    // For dom cache
                    pageContainer = viewContainer.find('.page[data-page="' + $(navbarInnerContainer).attr('data-page') + '"]')[0];
                }
                if (!pageContainer) {
                    var pages = viewContainer.find('.page');
                    if (pages.length === 1) {
                        pageContainer = pages[0];
                    }
                    else {
                        viewContainer.find('.page').each(function () {
                            if (this.f7PageData && this.f7PageData.navbarInnerContainer === navbarInnerContainer) {
                                pageContainer = this;
                            }
                        });
                    }
                }
                app.navbarInitCallback(view, pageContainer, navbarContainer[0], navbarInnerContainer);
            });
        };
        
        // Size Navbars
        app.sizeNavbars = function (viewContainer) {
            if (app.params.material) return;
            var navbarInner = viewContainer ? $(viewContainer).find('.navbar .navbar-inner:not(.cached)') : $('.navbar .navbar-inner:not(.cached)');
            navbarInner.each(function () {
                var n = $(this);
                if (n.hasClass('cached')) return;
                var left = app.rtl ? n.find('.right') : n.find('.left'),
                    right = app.rtl ? n.find('.left') : n.find('.right'),
                    center = n.find('.center'),
                    subnavbar = n.find('.subnavbar'),
                    noLeft = left.length === 0,
                    noRight = right.length === 0,
                    leftWidth = noLeft ? 0 : left.outerWidth(true),
                    rightWidth = noRight ? 0 : right.outerWidth(true),
                    centerWidth = center.outerWidth(true),
                    navbarStyles = n.styles(),
                    navbarWidth = n[0].offsetWidth - parseInt(navbarStyles.paddingLeft, 10) - parseInt(navbarStyles.paddingRight, 10),
                    onLeft = n.hasClass('navbar-on-left'),
                    currLeft, diff;
        
                if (noRight) {
                    currLeft = navbarWidth - centerWidth;
                }
                if (noLeft) {
                    currLeft = 0;
                }
                if (!noLeft && !noRight) {
                    currLeft = (navbarWidth - rightWidth - centerWidth + leftWidth) / 2;
                }
                var requiredLeft = (navbarWidth - centerWidth) / 2;
                if (navbarWidth - leftWidth - rightWidth > centerWidth) {
                    if (requiredLeft < leftWidth) {
                        requiredLeft = leftWidth;
                    }
                    if (requiredLeft + centerWidth > navbarWidth - rightWidth) {
                        requiredLeft = navbarWidth - rightWidth - centerWidth;
                    }
                    diff = requiredLeft - currLeft;
                }
                else {
                    diff = 0;
                }
                // RTL inverter
                var inverter = app.rtl ? -1 : 1;
        
                if (center.hasClass('sliding')) {
                    center[0].f7NavbarLeftOffset = -(currLeft + diff) * inverter;
                    center[0].f7NavbarRightOffset = (navbarWidth - currLeft - diff - centerWidth) * inverter;
                    if (onLeft) {
                        if (app.params.animateNavBackIcon) {
                            var activeNavbarBackLink = n.parent().find('.navbar-on-center').find('.left.sliding .back .icon ~ span');
                            if (activeNavbarBackLink.length > 0) {
                                center[0].f7NavbarLeftOffset += activeNavbarBackLink[0].offsetLeft;
                            }
                        }
                        center.transform('translate3d(' + center[0].f7NavbarLeftOffset + 'px, 0, 0)');
                    }
                }
                if (!noLeft && left.hasClass('sliding')) {
                    if (app.rtl) {
                        left[0].f7NavbarLeftOffset = -(navbarWidth - left[0].offsetWidth) / 2 * inverter;
                        left[0].f7NavbarRightOffset = leftWidth * inverter;
                    }
                    else {
                        left[0].f7NavbarLeftOffset = -leftWidth;
                        left[0].f7NavbarRightOffset = (navbarWidth - left[0].offsetWidth) / 2;
                        if (app.params.animateNavBackIcon && left.find('.back .icon').length > 0) {
                            left[0].f7NavbarRightOffset -= left.find('.back .icon')[0].offsetWidth;
                        }
                    }
                    if (onLeft) left.transform('translate3d(' + left[0].f7NavbarLeftOffset + 'px, 0, 0)');
                }
                if (!noRight && right.hasClass('sliding')) {
                    if (app.rtl) {
                        right[0].f7NavbarLeftOffset = -rightWidth * inverter;
                        right[0].f7NavbarRightOffset = (navbarWidth - right[0].offsetWidth) / 2 * inverter;
                    }
                    else {
                        right[0].f7NavbarLeftOffset = -(navbarWidth - right[0].offsetWidth) / 2;
                        right[0].f7NavbarRightOffset = rightWidth;
                    }
                    if (onLeft) right.transform('translate3d(' + right[0].f7NavbarLeftOffset + 'px, 0, 0)');
                }
                if (subnavbar.length && subnavbar.hasClass('sliding')) {
                    subnavbar[0].f7NavbarLeftOffset = app.rtl ? subnavbar[0].offsetWidth : -subnavbar[0].offsetWidth;
                    subnavbar[0].f7NavbarRightOffset = -subnavbar[0].f7NavbarLeftOffset;
                }
        
                // Center left
                var centerLeft = diff;
                if (app.rtl && noLeft && noRight && center.length > 0) centerLeft = -centerLeft;
                center.css({left: centerLeft + 'px'});
                
            });
        };
        
        // Hide/Show Navbars/Toolbars
        app.hideNavbar = function (navbarContainer) {
            $(navbarContainer).addClass('navbar-hidden');
            return true;
        };
        app.showNavbar = function (navbarContainer) {
            var navbar = $(navbarContainer);
            navbar.addClass('navbar-hiding').removeClass('navbar-hidden').transitionEnd(function () {
                navbar.removeClass('navbar-hiding');
            });
            return true;
        };
        app.hideToolbar = function (toolbarContainer) {
            $(toolbarContainer).addClass('toolbar-hidden');
            return true;
        };
        app.showToolbar = function (toolbarContainer) {
            var toolbar = $(toolbarContainer);
            toolbar.addClass('toolbar-hiding').removeClass('toolbar-hidden').transitionEnd(function () {
                toolbar.removeClass('toolbar-hiding');
            });
        };
        

        /*======================================================
        ************   Searchbar   ************
        ======================================================*/
        var Searchbar = function (container, params) {
            var defaults = {
                input: null,
                clearButton: null,
                cancelButton: null,
                searchList: null,
                searchIn: '.item-title',
                searchBy: '',
                found: null,
                notFound: null,
                overlay: null,
                ignore: '.searchbar-ignore',
                customSearch: false,
                removeDiacritics: false,
                hideDividers: true,
                hideGroups: true,
                /* Callbacks
                onSearch
                onEnable
                onDisable
                onClear
                */
        
            };
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined' || params[def] === null) {
                    params[def] = defaults[def];
                }
            }
            
            // Instance
            var s = this;
        
            // Material
            s.material = app.params.material;
        
            // Params
            s.params = params;
        
            // Container
            container = $(container);
            s.container = container;
        
            // Active
            s.active = false;
        
            // Input
            s.input = s.params.input ? $(s.params.input) : s.container.find('input[type="search"]');
            s.clearButton = s.params.clearButton ? $(s.params.clearButton) : s.container.find('.searchbar-clear');
            s.cancelButton = s.params.cancelButton ? $(s.params.cancelButton) : s.container.find('.searchbar-cancel');
        
            // Search List
            s.searchList = $(s.params.searchList);
        
            // Is Virtual List
            s.isVirtualList = s.searchList.hasClass('virtual-list');
        
            // Is In Page
            s.pageContainer = s.container.parents('.page').eq(0);
        
            // Overlay
            if (!s.params.overlay) {
                s.overlay = s.pageContainer.length > 0 ? s.pageContainer.find('.searchbar-overlay') : $('.searchbar-overlay');
            }
            else {
                s.overlay = $(s.params.overlay);
            }
            // Found and not found
            if (!s.params.found) {
                s.found = s.pageContainer.length > 0 ? s.pageContainer.find('.searchbar-found') : $('.searchbar-found');
            }
            else {
                s.found = $(s.params.found);
            }
            if (!s.params.notFound) {
                s.notFound = s.pageContainer.length > 0 ? s.pageContainer.find('.searchbar-not-found') : $('.searchbar-not-found');
            }
            else {
                s.notFound = $(s.params.notFound);
            }
        
            
        
            // Diacritics
            var defaultDiacriticsRemovalap = [
                {base:'A', letters:'\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F'},
                {base:'AA',letters:'\uA732'},
                {base:'AE',letters:'\u00C6\u01FC\u01E2'},
                {base:'AO',letters:'\uA734'},
                {base:'AU',letters:'\uA736'},
                {base:'AV',letters:'\uA738\uA73A'},
                {base:'AY',letters:'\uA73C'},
                {base:'B', letters:'\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181'},
                {base:'C', letters:'\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E'},
                {base:'D', letters:'\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779'},
                {base:'DZ',letters:'\u01F1\u01C4'},
                {base:'Dz',letters:'\u01F2\u01C5'},
                {base:'E', letters:'\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E'},
                {base:'F', letters:'\u0046\u24BB\uFF26\u1E1E\u0191\uA77B'},
                {base:'G', letters:'\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E'},
                {base:'H', letters:'\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D'},
                {base:'I', letters:'\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197'},
                {base:'J', letters:'\u004A\u24BF\uFF2A\u0134\u0248'},
                {base:'K', letters:'\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2'},
                {base:'L', letters:'\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780'},
                {base:'LJ',letters:'\u01C7'},
                {base:'Lj',letters:'\u01C8'},
                {base:'M', letters:'\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C'},
                {base:'N', letters:'\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4'},
                {base:'NJ',letters:'\u01CA'},
                {base:'Nj',letters:'\u01CB'},
                {base:'O', letters:'\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C'},
                {base:'OI',letters:'\u01A2'},
                {base:'OO',letters:'\uA74E'},
                {base:'OU',letters:'\u0222'},
                {base:'OE',letters:'\u008C\u0152'},
                {base:'oe',letters:'\u009C\u0153'},
                {base:'P', letters:'\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754'},
                {base:'Q', letters:'\u0051\u24C6\uFF31\uA756\uA758\u024A'},
                {base:'R', letters:'\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782'},
                {base:'S', letters:'\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784'},
                {base:'T', letters:'\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786'},
                {base:'TZ',letters:'\uA728'},
                {base:'U', letters:'\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244'},
                {base:'V', letters:'\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245'},
                {base:'VY',letters:'\uA760'},
                {base:'W', letters:'\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72'},
                {base:'X', letters:'\u0058\u24CD\uFF38\u1E8A\u1E8C'},
                {base:'Y', letters:'\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE'},
                {base:'Z', letters:'\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762'},
                {base:'a', letters:'\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250'},
                {base:'aa',letters:'\uA733'},
                {base:'ae',letters:'\u00E6\u01FD\u01E3'},
                {base:'ao',letters:'\uA735'},
                {base:'au',letters:'\uA737'},
                {base:'av',letters:'\uA739\uA73B'},
                {base:'ay',letters:'\uA73D'},
                {base:'b', letters:'\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253'},
                {base:'c', letters:'\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184'},
                {base:'d', letters:'\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A'},
                {base:'dz',letters:'\u01F3\u01C6'},
                {base:'e', letters:'\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD'},
                {base:'f', letters:'\u0066\u24D5\uFF46\u1E1F\u0192\uA77C'},
                {base:'g', letters:'\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F'},
                {base:'h', letters:'\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265'},
                {base:'hv',letters:'\u0195'},
                {base:'i', letters:'\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131'},
                {base:'j', letters:'\u006A\u24D9\uFF4A\u0135\u01F0\u0249'},
                {base:'k', letters:'\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3'},
                {base:'l', letters:'\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747'},
                {base:'lj',letters:'\u01C9'},
                {base:'m', letters:'\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F'},
                {base:'n', letters:'\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5'},
                {base:'nj',letters:'\u01CC'},
                {base:'o', letters:'\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275'},
                {base:'oi',letters:'\u01A3'},
                {base:'ou',letters:'\u0223'},
                {base:'oo',letters:'\uA74F'},
                {base:'p',letters:'\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755'},
                {base:'q',letters:'\u0071\u24E0\uFF51\u024B\uA757\uA759'},
                {base:'r',letters:'\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783'},
                {base:'s',letters:'\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B'},
                {base:'t',letters:'\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787'},
                {base:'tz',letters:'\uA729'},
                {base:'u',letters: '\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289'},
                {base:'v',letters:'\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C'},
                {base:'vy',letters:'\uA761'},
                {base:'w',letters:'\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73'},
                {base:'x',letters:'\u0078\u24E7\uFF58\u1E8B\u1E8D'},
                {base:'y',letters:'\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF'},
                {base:'z',letters:'\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763'}
            ];
        
            var diacriticsMap = {};
            for (var i=0; i < defaultDiacriticsRemovalap.length; i++){
                var letters = defaultDiacriticsRemovalap[i].letters;
                for (var j=0; j < letters.length ; j++){
                    diacriticsMap[letters[j]] = defaultDiacriticsRemovalap[i].base;
                }
            }
        
            function removeDiacritics (str) {
                return str.replace(/[^\u0000-\u007E]/g, function(a){ 
                   return diacriticsMap[a] || a; 
                });
            }
        
            // Set Cancel button
            var cancelMarginProp = app.rtl ? 'margin-left' : 'margin-right';
            var cancelButtonHasMargin = false;
            s.setCancelButtonMargin = function () {
                s.cancelButton.transition(0).show();
                s.cancelButton.css(cancelMarginProp, -s.cancelButton[0].offsetWidth + 'px');
                var clientLeft = s.cancelButton[0].clientLeft;
                s.cancelButton.transition('');
                cancelButtonHasMargin = true;
            };
        
            // Trigger
            s.triggerEvent = function (eventName, callbackName, eventData) {
                s.container.trigger(eventName, eventData);
                if (s.searchList.length > 0) s.searchList.trigger(eventName, eventData);
                if (callbackName && s.params[callbackName]) s.params[callbackName](s, eventData);
            };
        
            // Enable/disalbe
            s.enable = function (e) {
                function _enable() {
                    if ((s.searchList.length || s.params.customSearch) && !s.container.hasClass('searchbar-active') && !s.query) s.overlay.addClass('searchbar-overlay-active');
                    s.container.addClass('searchbar-active');
                    if (s.cancelButton.length > 0 && !s.material) {
                        if (!cancelButtonHasMargin) {
                            s.setCancelButtonMargin();
                        }
                        s.cancelButton.css(cancelMarginProp, '0px');
                    }
                    s.triggerEvent('enableSearch', 'onEnable');
                    s.active = true;
                }
                if (app.device.ios && !app.params.material && e && e.type === 'focus') {
                    setTimeout(function () {
                        _enable();
                    }, 400);
                }
                else {
                    _enable();
                }
            };
        
            s.disable = function () {
                s.input.val('').trigger('change');
                s.container.removeClass('searchbar-active searchbar-not-empty');
                if (s.cancelButton.length > 0 && !s.material) s.cancelButton.css(cancelMarginProp, -s.cancelButton[0].offsetWidth + 'px');
        
                if (s.searchList.length || s.params.customSearch) s.overlay.removeClass('searchbar-overlay-active');
        
                s.active = false;
                function _disable() {
                    s.input.blur();
                }
                if (app.device.ios) {
                    setTimeout(function () {
                        _disable();
                    }, 400);
                }
                else {
                    _disable();
                }
                s.triggerEvent('disableSearch', 'onDisable');
            };
        
            // Clear
            s.clear = function (e) {
                if (!s.query && e && $(e.target).hasClass('searchbar-clear')) {
                    s.disable();
                    return;
                }
                s.input.val('').trigger('change').focus();
                s.triggerEvent('clearSearch', 'onClear');
            };
        
            // Search
            s.handleInput = function () {
                setTimeout(function () {
                    var value = s.input.val().trim();
                    if ((s.searchList.length > 0 || s.params.customSearch) && (s.params.searchIn || s.isVirtualList)) s.search(value, true);
                }, 0);
            };
        
            var previousQuery = '';
            var virtualList;
            s.search = function (query, internal) {
                if (query.trim() === previousQuery) return;
                previousQuery = query.trim();
        
                if (!internal) {
                    if (!s.active) {
                        s.enable();
                    }
                    s.input.val(query);
                }
                s.query = s.value = query;
                // Add active/inactive classes on overlay
                if (query.length === 0) {
                    s.container.removeClass('searchbar-not-empty');
                    if (s.searchList.length && s.container.hasClass('searchbar-active')) s.overlay.addClass('searchbar-overlay-active');
                }
                else {
                    s.container.addClass('searchbar-not-empty');
                    if (s.searchList.length && s.container.hasClass('searchbar-active')) s.overlay.removeClass('searchbar-overlay-active');
                }
        
                if (s.params.customSearch) {
                    s.triggerEvent('search', 'onSearch', {query: query});
                    return;
                }
                
                var foundItems = [];
                if (s.isVirtualList) {
                    virtualList = s.searchList[0].f7VirtualList;
                    if (query.trim() === '') {
                        virtualList.resetFilter();
                        s.notFound.hide();
                        s.found.show();
                        return;
                    }
                    if (virtualList.params.searchAll) {
                        foundItems = virtualList.params.searchAll(query, virtualList.items) || [];
                    }
                    else if (virtualList.params.searchByItem) {
                        for (var i = 0; i < virtualList.items.length; i++) {
                            if(virtualList.params.searchByItem(query, i, virtualList.params.items[i])) {
                                foundItems.push(i);
                            }
                        }
                    }
                }
                else {
                    var values;
                    if (s.params.removeDiacritics) values = removeDiacritics(query.trim().toLowerCase()).split(' ');
                    else {
                        values = query.trim().toLowerCase().split(' ');
                    }
                    s.searchList.find('li').removeClass('hidden-by-searchbar').each(function (index, el) {
                        el = $(el);
                        var compareWithText = [];
                        el.find(s.params.searchIn).each(function () {
                            var itemText = $(this).text().trim().toLowerCase();
                            if (s.params.removeDiacritics) itemText = removeDiacritics(itemText);
                            compareWithText.push(itemText);
                        });
                        compareWithText = compareWithText.join(' ');
                        var wordsMatch = 0;
                        for (var i = 0; i < values.length; i++) {
                            if (compareWithText.indexOf(values[i]) >= 0) wordsMatch++;
                        }
                        if (wordsMatch !== values.length && !(s.params.ignore && el.is(s.params.ignore))) {
                            el.addClass('hidden-by-searchbar');
                        }
                        else {
                            foundItems.push(el[0]);
                        }
                    });
        
                    if (s.params.hideDividers) {
                        s.searchList.find('.item-divider, .list-group-title').each(function () {
                            var title = $(this);
                            var nextElements = title.nextAll('li');
                            var hide = true;
                            for (var i = 0; i < nextElements.length; i++) {
                                var nextEl = $(nextElements[i]);
                                if (nextEl.hasClass('list-group-title') || nextEl.hasClass('item-divider')) break;
                                if (!nextEl.hasClass('hidden-by-searchbar')) {
                                    hide = false;
                                }
                            }
                            var ignore = s.params.ignore && title.is(s.params.ignore);
                            if (hide && !ignore) title.addClass('hidden-by-searchbar');
                            else title.removeClass('hidden-by-searchbar');
                        });
                    }
                    if (s.params.hideGroups) {
                        s.searchList.find('.list-group').each(function () {
                            var group = $(this);
                            var ignore = s.params.ignore && group.is(s.params.ignore);
                            var notHidden = group.find('li:not(.hidden-by-searchbar)');
                            if (notHidden.length === 0 && !ignore) {
                                group.addClass('hidden-by-searchbar');
                            }
                            else {
                                group.removeClass('hidden-by-searchbar');
                            }
                        });
                    }
                }
                s.triggerEvent('search', 'onSearch', {query: query, foundItems: foundItems});
                if (foundItems.length === 0) {
                    s.notFound.show();
                    s.found.hide();
                }
                else {
                    s.notFound.hide();
                    s.found.show();
                }
                if (s.isVirtualList) {
                    virtualList.filterItems(foundItems);
                }
            };
        
            // Events
            function preventSubmit(e) {
                e.preventDefault();
            }
        
            s.attachEvents = function (destroy) {
                var method = destroy ? 'off' : 'on';
                s.container[method]('submit', preventSubmit);
                if (!s.material) s.cancelButton[method]('click', s.disable);
                s.overlay[method]('click', s.disable);
                s.input[method]('focus', s.enable);
                s.input[method]('change keydown keypress keyup', s.handleInput);
                s.clearButton[method]('click', s.clear);
                    
            };
            s.detachEvents = function() {
                s.attachEvents(true);
            };
        
            // Init Destroy
            s.init = function () {
                s.attachEvents();
            };
            s.destroy = function () {
                if (!s) return;
                s.detachEvents();
                s = null;
            };
        
            // Init
            s.init();
        
            s.container[0].f7Searchbar = s;
            return s;
        
        };
        app.searchbar = function (container, params) {
            return new Searchbar(container, params);
        };
        app.initSearchbar = function (container) {
            container = $(container);
            var searchbar = container.hasClass('searchbar') ? container : container.find('.searchbar');
            if (searchbar.length === 0) return;
            if (!searchbar.hasClass('searchbar-init')) return;
        
            var sb = app.searchbar(searchbar, searchbar.dataset());
        
            function onBeforeRemove() {
                if (sb) sb.destroy();
            }
            if (container.hasClass('page')) {
                container.once('pageBeforeRemove', onBeforeRemove);   
            }
            else if (container.hasClass('navbar-inner')) {
                container.once('navbarBeforeRemove', onBeforeRemove);
            }
        };

        /*======================================================
        ************   Messagebar   ************
        ======================================================*/
        var Messagebar = function (container, params) {
            var defaults = {
                textarea: null,
                maxHeight: null,
            };
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined' || params[def] === null) {
                    params[def] = defaults[def];
                }
            }
            
            // Instance
            var m = this;
        
            // Params
            m.params = params;
        
            // Container
            m.container = $(container);
            if (m.container.length === 0) return;
        
            // Textarea
            m.textarea = m.params.textarea ? $(m.params.textarea) : m.container.find('textarea');
        
            // Is In Page
            m.pageContainer = m.container.parents('.page').eq(0);
            m.pageContent = m.pageContainer.find('.page-content');
        
            // Initial Sizes
            m.pageContentPadding = parseInt(m.pageContent.css('padding-bottom'));
            m.initialBarHeight = m.container[0].offsetHeight;
            m.initialAreaHeight = m.textarea[0].offsetHeight;
            
        
            // Resize textarea
            m.sizeTextarea = function () {
                // Reset
                m.textarea.css({'height': ''});
                
                var height = m.textarea[0].offsetHeight;
                var diff = height - m.textarea[0].clientHeight;
                var scrollHeight = m.textarea[0].scrollHeight;
        
                // Update
                if (scrollHeight + diff > height) {
                    var newAreaHeight = scrollHeight + diff;
                    var newBarHeight = m.initialBarHeight + (newAreaHeight - m.initialAreaHeight);
                    var maxBarHeight = m.params.maxHeight || m.container.parents('.view')[0].offsetHeight - 88;
                    if (newBarHeight > maxBarHeight) {
                        newBarHeight = parseInt(maxBarHeight, 10);
                        newAreaHeight = newBarHeight - m.initialBarHeight + m.initialAreaHeight;
                    }
                    m.textarea.css('height', newAreaHeight + 'px');
                    m.container.css('height', newBarHeight + 'px');
                    var onBottom = (m.pageContent[0].scrollTop === m.pageContent[0].scrollHeight - m.pageContent[0].offsetHeight);
                    if (m.pageContent.length > 0) {
                        m.pageContent.css('padding-bottom', newBarHeight + 'px');
                        if (m.pageContent.find('.messages-new-first').length === 0 && onBottom) {
                            m.pageContent.scrollTop(m.pageContent[0].scrollHeight - m.pageContent[0].offsetHeight);
                        }
                    }
                }
                else {
                    if (m.pageContent.length > 0) {
                        m.container.css({'height': '', 'bottom': ''});
                        m.pageContent.css({'padding-bottom': ''});
                    }
                }
            };
            
            // Clear
            m.clear = function () {
                m.textarea.val('').trigger('change');
            };
            m.value = function (value) {
                if (typeof value === 'undefined') return m.textarea.val();
                else m.textarea.val(value).trigger('change');  
            };
            
            // Handle textarea
            m.textareaTimeout = undefined;
            m.handleTextarea = function (e) {
                clearTimeout(m.textareaTimeout);
                m.textareaTimeout = setTimeout(function () {
                    m.sizeTextarea();
                }, 0);
            };
        
            //Events
            function preventSubmit(e) {
                e.preventDefault();
            }
        
            m.attachEvents = function (destroy) {
                var method = destroy ? 'off' : 'on';
                m.container[method]('submit', preventSubmit);
                m.textarea[method]('change keydown keypress keyup paste cut', m.handleTextarea);
            };
            m.detachEvents = function () {
                m.attachEvents(true);
            };
            
            // Init Destroy
            m.init = function () {
                m.attachEvents();
            };
            m.destroy = function () {
                m.detachEvents();
                m = null;
            };
        
            // Init
            m.init();
        
            m.container[0].f7Messagebar = m;
            return m;
        };
        app.messagebar = function (container, params) {
            return new Messagebar(container, params);
        };
        app.initPageMessagebar = function (pageContainer) {
            pageContainer = $(pageContainer);
            var messagebar = pageContainer.hasClass('messagebar') ? pageContainer : pageContainer.find('.messagebar');
            if (messagebar.length === 0) return;
            if (!messagebar.hasClass('messagebar-init')) return;
            var mb = app.messagebar(messagebar, messagebar.dataset());
        
            // Destroy on page remove
            function pageBeforeRemove() {
                mb.destroy();
                pageContainer.off('pageBeforeRemove', pageBeforeRemove);
            }
            if (pageContainer.hasClass('page')) {
                pageContainer.on('pageBeforeRemove', pageBeforeRemove);
            }
        };

        /*======================================================
        ************   XHR   ************
        ======================================================*/
        // XHR Caching
        app.cache = [];
        app.removeFromCache = function (url) {
            var index = false;
            for (var i = 0; i < app.cache.length; i++) {
                if (app.cache[i].url === url) index = i;
            }
            if (index !== false) app.cache.splice(index, 1);
        };
        
        // XHR
        app.xhr = false;
        app.get = function (url, view, ignoreCache, callback) {
            // should we ignore get params or not
            var _url = url;
            if (app.params.cacheIgnoreGetParameters && url.indexOf('?') >= 0) {
                _url = url.split('?')[0];
            }
            if (app.params.cache && !ignoreCache && url.indexOf('nocache') < 0 && app.params.cacheIgnore.indexOf(_url) < 0) {
                // Check is the url cached
                for (var i = 0; i < app.cache.length; i++) {
                    if (app.cache[i].url === _url) {
                        // Check expiration
                        if ((new Date()).getTime() - app.cache[i].time < app.params.cacheDuration) {
                            // Load from cache
                            callback(app.cache[i].content);
                            return false;
                        }
                    }
                }
            }
        
            app.xhr = $.ajax({
                url: url,
                method: 'GET',
                beforeSend: app.params.onAjaxStart,
                complete: function (xhr) {
                    if ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 0) {
                        if (app.params.cache) {
                            app.removeFromCache(_url);
                            app.cache.push({
                                url: _url,
                                time: (new Date()).getTime(),
                                content: xhr.responseText
                            });
                        }
                        callback(xhr.responseText, false);
                    }
                    else {
                        callback(xhr.responseText, true);
                    }
                    if (app.params.onAjaxComplete) app.params.onAjaxComplete(xhr);
                },
                error: function (xhr) {
                    callback(xhr.responseText, true);
                    if (app.params.onAjaxError) app.params.onAjaxError(xhr);
                }
            });
            if (view) view.xhr = app.xhr;
        
            return app.xhr;
        };
        

        /*======================================================
        ************   Pages   ************
        ======================================================*/
        // Page Callbacks API
        app.pageCallbacks = {};
        
        app.onPage = function (callbackName, pageName, callback) {
            if (pageName && pageName.split(' ').length > 1) {
                var pageNames = pageName.split(' ');
                var returnCallbacks = [];
                for (var i = 0; i < pageNames.length; i++) {
                    returnCallbacks.push(app.onPage(callbackName, pageNames[i], callback));
                }
                returnCallbacks.remove = function () {
                    for (var i = 0; i < returnCallbacks.length; i++) {
                        returnCallbacks[i].remove();
                    }
                };
                returnCallbacks.trigger = function () {
                    for (var i = 0; i < returnCallbacks.length; i++) {
                        returnCallbacks[i].trigger();
                    }
                };
                return returnCallbacks;
            }
            var callbacks = app.pageCallbacks[callbackName][pageName];
            if (!callbacks) {
                callbacks = app.pageCallbacks[callbackName][pageName] = [];
            }
            app.pageCallbacks[callbackName][pageName].push(callback);
            return {
                remove: function () {
                    var removeIndex;
                    for (var i = 0; i < callbacks.length; i++) {
                        if (callbacks[i].toString() === callback.toString()) {
                            removeIndex = i;
                        }
                    }
                    if (typeof removeIndex !== 'undefined') callbacks.splice(removeIndex, 1);
                },
                trigger: callback
            };
        };
        
        //Create callbacks methods dynamically
        function createPageCallback(callbackName) {
            var capitalized = callbackName.replace(/^./, function (match) {
                return match.toUpperCase();
            });
            app['onPage' + capitalized] = function (pageName, callback) {
                return app.onPage(callbackName, pageName, callback);
            };
        }
        
        var pageCallbacksNames = ('beforeInit init reinit beforeAnimation afterAnimation back afterBack beforeRemove').split(' ');
        for (var i = 0; i < pageCallbacksNames.length; i++) {
            app.pageCallbacks[pageCallbacksNames[i]] = {};
            createPageCallback(pageCallbacksNames[i]);
        }
        
        app.triggerPageCallbacks = function (callbackName, pageName, pageData) {
            var allPagesCallbacks = app.pageCallbacks[callbackName]['*'];
            if (allPagesCallbacks) {
                for (var j = 0; j < allPagesCallbacks.length; j++) {
                    allPagesCallbacks[j](pageData);
                }
            }
            var callbacks = app.pageCallbacks[callbackName][pageName];
            if (!callbacks || callbacks.length === 0) return;
            for (var i = 0; i < callbacks.length; i++) {
                callbacks[i](pageData);
            }
        };
        
        // On Page Init Callback
        app.pageInitCallback = function (view, params) {
            var pageContainer = params.pageContainer;
            if (pageContainer.f7PageInitialized && view && !view.params.domCache) return;
        
            var pageQuery = params.query;
            if (!pageQuery) {
                if (params.url && params.url.indexOf('?') > 0) {
                    pageQuery = $.parseUrlQuery(params.url || '');
                }
                else if (pageContainer.f7PageData && pageContainer.f7PageData.query) {
                    pageQuery = pageContainer.f7PageData.query;
                }
                else {
                    pageQuery = {};
                }
            }
        
            // Page Data
            var pageData = {
                container: pageContainer,
                url: params.url,
                query: pageQuery,
                name: $(pageContainer).attr('data-page'),
                view: view,
                from: params.position,
                context: params.context,
                navbarInnerContainer: params.navbarInnerContainer,
                fromPage: params.fromPage
            };
            if (params.fromPage && !params.fromPage.navbarInnerContainer && params.oldNavbarInnerContainer) {
                params.fromPage.navbarInnerContainer = params.oldNavbarInnerContainer;
            }
        
            if (pageContainer.f7PageInitialized && ((view && view.params.domCache) || (!view && $(pageContainer).parents('.popup, .popover, .login-screen, .modal, .actions-modal, .picker-modal').length > 0))) {
                // Reinit Page
                app.reinitPage(pageContainer);
        
                // Callbacks
                app.pluginHook('pageReinit', pageData);
                if (app.params.onPageReinit) app.params.onPageReinit(app, pageData);
                app.triggerPageCallbacks('reinit', pageData.name, pageData);
                $(pageData.container).trigger('pageReinit', {page: pageData});
                return;
            }
            pageContainer.f7PageInitialized = true;
        
            // Store pagedata in page
            pageContainer.f7PageData = pageData;
        
            // Update View's activePage
            if (view && !params.preloadOnly && !params.reloadPrevious) {
                // Add data-page on view
                $(view.container).attr('data-page', pageData.name);
                // Update View active page data
                view.activePage = pageData;
            }
        
            // Before Init Callbacks
            app.pluginHook('pageBeforeInit', pageData);
            if (app.params.onPageBeforeInit) app.params.onPageBeforeInit(app, pageData);
            app.triggerPageCallbacks('beforeInit', pageData.name, pageData);
            $(pageData.container).trigger('pageBeforeInit', {page: pageData});
        
            // Init page
            app.initPage(pageContainer);
        
            // Init Callback
            app.pluginHook('pageInit', pageData);
            if (app.params.onPageInit) app.params.onPageInit(app, pageData);
            app.triggerPageCallbacks('init', pageData.name, pageData);
            $(pageData.container).trigger('pageInit', {page: pageData});
        };
        app.pageRemoveCallback = function (view, pageContainer, position) {
            var pageContext;
            if (pageContainer.f7PageData) pageContext = pageContainer.f7PageData.context;
            // Page Data
            var pageData = {
                container: pageContainer,
                name: $(pageContainer).attr('data-page'),
                view: view,
                url: pageContainer.f7PageData && pageContainer.f7PageData.url,
                query: pageContainer.f7PageData && pageContainer.f7PageData.query,
                navbarInnerContainer: pageContainer.f7PageData && pageContainer.f7PageData.navbarInnerContainer,
                from: position,
                context: pageContext
            };
            // Before Init Callback
            app.pluginHook('pageBeforeRemove', pageData);
            if (app.params.onPageBeforeRemove) app.params.onPageBeforeRemove(app, pageData);
            app.triggerPageCallbacks('beforeRemove', pageData.name, pageData);
            $(pageData.container).trigger('pageBeforeRemove', {page: pageData});
        };
        app.pageBackCallback = function (callback, view, params) {
            // Page Data
            var pageContainer = params.pageContainer;
            var pageContext;
            if (pageContainer.f7PageData) pageContext = pageContainer.f7PageData.context;
        
            var pageData = {
                container: pageContainer,
                name: $(pageContainer).attr('data-page'),
                url: pageContainer.f7PageData && pageContainer.f7PageData.url,
                query: pageContainer.f7PageData && pageContainer.f7PageData.query,
                view: view,
                from: params.position,
                context: pageContext,
                navbarInnerContainer: pageContainer.f7PageData && pageContainer.f7PageData.navbarInnerContainer,
                swipeBack: params.swipeBack
            };
        
            if (callback === 'after') {
                app.pluginHook('pageAfterBack', pageData);
                if (app.params.onPageAfterBack) app.params.onPageAfterBack(app, pageData);
                app.triggerPageCallbacks('afterBack', pageData.name, pageData);
                $(pageContainer).trigger('pageAfterBack', {page: pageData});
        
            }
            if (callback === 'before') {
                app.pluginHook('pageBack', pageData);
                if (app.params.onPageBack) app.params.onPageBack(app, pageData);
                app.triggerPageCallbacks('back', pageData.name, pageData);
                $(pageData.container).trigger('pageBack', {page: pageData});
            }
        };
        app.pageAnimCallback = function (callback, view, params) {
            var pageContainer = params.pageContainer;
            var pageContext;
            if (pageContainer.f7PageData) pageContext = pageContainer.f7PageData.context;
        
            var pageQuery = params.query;
            if (!pageQuery) {
                if (params.url && params.url.indexOf('?') > 0) {
                    pageQuery = $.parseUrlQuery(params.url || '');
                }
                else if (pageContainer.f7PageData && pageContainer.f7PageData.query) {
                    pageQuery = pageContainer.f7PageData.query;
                }
                else {
                    pageQuery = {};
                }
            }
            // Page Data
            var pageData = {
                container: pageContainer,
                url: params.url,
                query: pageQuery,
                name: $(pageContainer).attr('data-page'),
                view: view,
                from: params.position,
                context: pageContext,
                swipeBack: params.swipeBack,
                navbarInnerContainer: pageContainer.f7PageData && pageContainer.f7PageData.navbarInnerContainer,
                fromPage: params.fromPage
            };
            var oldPage = params.oldPage,
                newPage = params.newPage;
        
            // Update page date
            pageContainer.f7PageData = pageData;
        
            if (callback === 'after') {
                app.pluginHook('pageAfterAnimation', pageData);
                if (app.params.onPageAfterAnimation) app.params.onPageAfterAnimation(app, pageData);
                app.triggerPageCallbacks('afterAnimation', pageData.name, pageData);
                $(pageData.container).trigger('pageAfterAnimation', {page: pageData});
        
            }
            if (callback === 'before') {
                // Add data-page on view
                $(view.container).attr('data-page', pageData.name);
        
                // Update View's activePage
                if (view) view.activePage = pageData;
        
                // Hide/show navbar dynamically
                if (newPage.hasClass('no-navbar') && !oldPage.hasClass('no-navbar')) {
                    view.hideNavbar();
                }
                if (!newPage.hasClass('no-navbar') && (oldPage.hasClass('no-navbar') || oldPage.hasClass('no-navbar-by-scroll'))) {
                    view.showNavbar();
                }
                // Hide/show navbar toolbar
                if (newPage.hasClass('no-toolbar') && !oldPage.hasClass('no-toolbar')) {
                    view.hideToolbar();
                }
                if (!newPage.hasClass('no-toolbar') && (oldPage.hasClass('no-toolbar') || oldPage.hasClass('no-toolbar-by-scroll'))) {
                    view.showToolbar();
                }
                // Hide/show tabbar
                var tabBar;
                if (newPage.hasClass('no-tabbar') && !oldPage.hasClass('no-tabbar')) {
                    tabBar = $(view.container).find('.tabbar');
                    if (tabBar.length === 0) tabBar = $(view.container).parents('.' + app.params.viewsClass).find('.tabbar');
                    app.hideToolbar(tabBar);
                }
                if (!newPage.hasClass('no-tabbar') && (oldPage.hasClass('no-tabbar') || oldPage.hasClass('no-tabbar-by-scroll'))) {
                    tabBar = $(view.container).find('.tabbar');
                    if (tabBar.length === 0) tabBar = $(view.container).parents('.' + app.params.viewsClass).find('.tabbar');
                    app.showToolbar(tabBar);
                }
        
                oldPage.removeClass('no-navbar-by-scroll no-toolbar-by-scroll');
                // Callbacks
                app.pluginHook('pageBeforeAnimation', pageData);
                if (app.params.onPageBeforeAnimation) app.params.onPageBeforeAnimation(app, pageData);
                app.triggerPageCallbacks('beforeAnimation', pageData.name, pageData);
                $(pageData.container).trigger('pageBeforeAnimation', {page: pageData});
            }
        };
        
        // Init Page Events and Manipulations
        app.initPage = function (pageContainer) {
            pageContainer = $(pageContainer);
            if (pageContainer.length === 0) return;
            // Size navbars on page load
            if (app.sizeNavbars) app.sizeNavbars(pageContainer.parents('.' + app.params.viewClass)[0]);
            // Init messages
            if (app.initPageMessages) app.initPageMessages(pageContainer);
            // Init forms storage
            if (app.initFormsStorage) app.initFormsStorage(pageContainer);
            // Init smart select
            if (app.initSmartSelects) app.initSmartSelects(pageContainer);
            // Init slider
            if (app.initPageSwiper) app.initPageSwiper(pageContainer);
            // Init pull to refres
            if (app.initPullToRefresh) app.initPullToRefresh(pageContainer);
            // Init infinite scroll
            if (app.initPageInfiniteScroll) app.initPageInfiniteScroll(pageContainer);
            // Init searchbar
            if (app.initSearchbar) app.initSearchbar(pageContainer);
            // Init message bar
            if (app.initPageMessagebar) app.initPageMessagebar(pageContainer);
            // Init scroll toolbars
            if (app.initPageScrollToolbars) app.initPageScrollToolbars(pageContainer);
            // Init lazy images
            if (app.initImagesLazyLoad) app.initImagesLazyLoad(pageContainer);
            // Init progress bars
            if (app.initPageProgressbar) app.initPageProgressbar(pageContainer);
            // Init resizeable textareas
            if (app.initPageResizableTextarea) app.initPageResizableTextarea(pageContainer);
            // Init Material Preloader
            if (app.params.material && app.initPageMaterialPreloader) app.initPageMaterialPreloader(pageContainer);
            // Init Material Inputs
            if (app.params.material && app.initPageMaterialInputs) app.initPageMaterialInputs(pageContainer);
            // Init Material Tabbar
            if (app.params.material && app.initPageMaterialTabbar) app.initPageMaterialTabbar(pageContainer);
        };
        app.reinitPage = function (pageContainer) {
            pageContainer = $(pageContainer);
            if (pageContainer.length === 0) return;
            // Size navbars on page reinit
            if (app.sizeNavbars) app.sizeNavbars(pageContainer.parents('.' + app.params.viewClass)[0]);
            // Reinit slider
            if (app.reinitPageSwiper) app.reinitPageSwiper(pageContainer);
            // Reinit lazy load
            if (app.reinitLazyLoad) app.reinitLazyLoad(pageContainer);
        };
        app.initPageWithCallback = function (pageContainer) {
            pageContainer = $(pageContainer);
            var viewContainer = pageContainer.parents('.' + app.params.viewClass);
            if (viewContainer.length === 0) return;
            var view = viewContainer[0].f7View || undefined;
            var url = view && view.url ? view.url : undefined;
            if (viewContainer && pageContainer.attr('data-page')) {
                viewContainer.attr('data-page', pageContainer.attr('data-page'));
            }
            app.pageInitCallback(view, {pageContainer: pageContainer[0], url: url, position: 'center'});
        };

        /*======================================================
        ************   Navigation / Router   ************
        ======================================================*/
        app.router = {
            // Temporary DOM Element
            temporaryDom: document.createElement('div'),
        
            // Find page or navbar in passed container which are related to View
            findElement: function (selector, container, view, notCached) {
                container = $(container);
                if (notCached) selector = selector + ':not(.cached)';
                var found = container.find(selector);
                if (found.length > 1) {
                    if (typeof view.selector === 'string') {
                        // Search in related view
                        found = container.find(view.selector + ' ' + selector);
                    }
                    if (found.length > 1) {
                        // Search in main view
                        found = container.find('.' + app.params.viewMainClass + ' ' + selector);
                    }
                }
                if (found.length === 1) return found;
                else {
                    // Try to find non cached
                    if (!notCached) found = app.router.findElement(selector, container, view, true);
                    if (found && found.length === 1) return found;
                    else return undefined;
                }
            },
        
            // Set pages classess for animationEnd
            animatePages: function (leftPage, rightPage, direction, view) {
                // Loading new page
                var removeClasses = 'page-on-center page-on-right page-on-left';
                if (direction === 'to-left') {
                    leftPage.removeClass(removeClasses).addClass('page-from-center-to-left');
                    rightPage.removeClass(removeClasses).addClass('page-from-right-to-center');
                }
                // Go back
                if (direction === 'to-right') {
                    leftPage.removeClass(removeClasses).addClass('page-from-left-to-center');
                    rightPage.removeClass(removeClasses).addClass('page-from-center-to-right');
        
                }
            },
        
            // Prepare navbar before animarion
            prepareNavbar: function (newNavbarInner, oldNavbarInner, newNavbarPosition) {
                $(newNavbarInner).find('.sliding').each(function () {
                    var sliding = $(this);
                    var slidingOffset = newNavbarPosition === 'right' ? this.f7NavbarRightOffset : this.f7NavbarLeftOffset;
        
                    if (app.params.animateNavBackIcon) {
                        if (sliding.hasClass('left') && sliding.find('.back .icon').length > 0) {
                            sliding.find('.back .icon').transform('translate3d(' + (-slidingOffset) + 'px,0,0)');
                        }
                    }
                    sliding.transform('translate3d(' + slidingOffset + 'px,0,0)');
                });
            },
        
            // Set navbars classess for animation
            animateNavbars: function (leftNavbarInner, rightNavbarInner, direction, view) {
                // Loading new page
                var removeClasses = 'navbar-on-right navbar-on-center navbar-on-left';
                if (direction === 'to-left') {
                    rightNavbarInner.removeClass(removeClasses).addClass('navbar-from-right-to-center');
                    rightNavbarInner.find('.sliding').each(function () {
                        var sliding = $(this);
                        sliding.transform('translate3d(0px,0,0)');
                        if (app.params.animateNavBackIcon) {
                            if (sliding.hasClass('left') && sliding.find('.back .icon').length > 0) {
                                sliding.find('.back .icon').transform('translate3d(0px,0,0)');
                            }
                        }
                    });
        
                    leftNavbarInner.removeClass(removeClasses).addClass('navbar-from-center-to-left');
                    leftNavbarInner.find('.sliding').each(function () {
                        var sliding = $(this);
                        var rightText;
                        if (app.params.animateNavBackIcon) {
                            if (sliding.hasClass('center') && rightNavbarInner.find('.sliding.left .back .icon').length > 0) {
                                rightText = rightNavbarInner.find('.sliding.left .back span');
                                if (rightText.length > 0) this.f7NavbarLeftOffset += rightText[0].offsetLeft;
                            }
                            if (sliding.hasClass('left') && sliding.find('.back .icon').length > 0) {
                                sliding.find('.back .icon').transform('translate3d(' + (-this.f7NavbarLeftOffset) + 'px,0,0)');
                            }
                        }
                        sliding.transform('translate3d(' + (this.f7NavbarLeftOffset) + 'px,0,0)');
                    });
                }
                // Go back
                if (direction === 'to-right') {
                    leftNavbarInner.removeClass(removeClasses).addClass('navbar-from-left-to-center');
                    leftNavbarInner.find('.sliding').each(function () {
                        var sliding = $(this);
                        sliding.transform('translate3d(0px,0,0)');
                        if (app.params.animateNavBackIcon) {
                            if (sliding.hasClass('left') && sliding.find('.back .icon').length > 0) {
                                sliding.find('.back .icon').transform('translate3d(0px,0,0)');
                            }
                        }
                    });
        
                    rightNavbarInner.removeClass(removeClasses).addClass('navbar-from-center-to-right');
                    rightNavbarInner.find('.sliding').each(function () {
                        var sliding = $(this);
                        if (app.params.animateNavBackIcon) {
                            if (sliding.hasClass('left') && sliding.find('.back .icon').length > 0) {
                                sliding.find('.back .icon').transform('translate3d(' + (-this.f7NavbarRightOffset) + 'px,0,0)');
                            }
                        }
                        sliding.transform('translate3d(' + (this.f7NavbarRightOffset) + 'px,0,0)');
                    });
                }
            },
        
            preprocess: function(view, content, url, next) {
                // Plugin hook
                app.pluginHook('routerPreprocess', view, content, url, next);
        
                // Preprocess by plugin
                content = app.pluginProcess('preprocess', content);
        
                if (view && view.params && view.params.preprocess) {
                    content = view.params.preprocess(content, url, next);
                    if (typeof content !== 'undefined') {
                        next(content);
                    }
                }
                else if (app.params.preprocess) {
                    content = app.params.preprocess(content, url, next);
                    if (typeof content !== 'undefined') {
                        next(content);
                    }
                }
                else {
                    next(content);
                }
            },
            preroute: function(view, options) {
                app.pluginHook('routerPreroute', view, options);
                if ((app.params.preroute && app.params.preroute(view, options) === false) || (view && view.params.preroute && view.params.preroute(view, options) === false)) {
                    return true;
                }
                else {
                    return false;
                }
            },
        
            template7Render: function (view, options) {
                var url = options.url,
                    content = options.content, //initial content
                    t7_rendered_content = options.content, // will be rendered using Template7
                    context = options.context, // Context data for Template7
                    contextName = options.contextName,
                    template = options.template, // Template 7 compiled template
                    pageName = options.pageName;
        
                var t7_ctx, t7_template;
                if (typeof content === 'string') {
                    if (url) {
                        if (app.template7Cache[url] && !options.ignoreCache) t7_template = t7.cache[url];
                        else {
                            t7_template = t7.compile(content);
                            t7.cache[url] = t7_template;
                        }
                    }
                    else t7_template = t7.compile(content);
                }
                else if (template) {
                    t7_template = template;
                }
        
                if (context) t7_ctx = context;
                else {
                    if (contextName) {
                        if (contextName.indexOf('.') >= 0) {
                            var _ctx_path = contextName.split('.');
                            var _ctx = t7.data[_ctx_path[0]];
                            for (var i = 1; i < _ctx_path.length; i++) {
                                if (_ctx_path[i]) _ctx = _ctx[_ctx_path[i]];
                            }
                            t7_ctx = _ctx;
                        }
                        else t7_ctx = t7.data[contextName];
                    }
                    if (!t7_ctx && url) {
                        t7_ctx = t7.data['url:' + url];
                    }
                    if (!t7_ctx && typeof content === 'string' && !template) {
                        //try to find by page name in content
                        var pageNameMatch = content.match(/(data-page=["'][^"^']*["'])/);
                        if (pageNameMatch) {
                            var page = pageNameMatch[0].split('data-page=')[1].replace(/['"]/g, '');
                            if (page) t7_ctx = t7.data['page:' + page];
                        }
                    }
                    if (!t7_ctx && template && t7.templates) {
                        // Try to find matched template name in t7.templates
                        for (var templateName in t7.templates) {
                            if (t7.templates[templateName] === template) t7_ctx = t7.data[templateName];
                        }
                    }
                    if (!t7_ctx) t7_ctx = {};
                }
        
                if (t7_template && t7_ctx) {
                    if (typeof t7_ctx === 'function') t7_ctx = t7_ctx();
                    if (url) {
                        // Extend data with URL query
                        var query = $.parseUrlQuery(url);
                        t7_ctx.url_query = {};
                        for (var key in query) {
                            t7_ctx.url_query[key] = query[key];
                        }
                    }
                    t7_rendered_content = t7_template(t7_ctx);
                }
        
                return {content: t7_rendered_content, context: t7_ctx};
            }
        };
        
        
        app.router._load = function (view, options) {
            options = options || {};
        
            var url = options.url,
                content = options.content, //initial content
                t7_rendered = {content: options.content},
                template = options.template, // Template 7 compiled template
                pageName = options.pageName,
                viewContainer = $(view.container),
                pagesContainer = $(view.pagesContainer),
                animatePages = options.animatePages,
                newPage, oldPage, pagesInView, i, oldNavbarInner, newNavbarInner, navbar, dynamicNavbar, reloadPosition,
                isDynamicPage = typeof url === 'undefined' && content || template,
                pushState = options.pushState;
        
            if (typeof animatePages === 'undefined') animatePages = view.params.animatePages;
        
            // Plugin hook
            app.pluginHook('routerLoad', view, options);
        
            // Render with Template7
            if (app.params.template7Pages && typeof content === 'string' || template) {
                t7_rendered = app.router.template7Render(view, options);
                if (t7_rendered.content && !content) {
                    content = t7_rendered.content;
                }
            }
        
            app.router.temporaryDom.innerHTML = '';
        
            // Parse DOM
            if (!pageName) {
                if ((typeof content === 'string') || (url && (typeof content === 'string'))) {
                    app.router.temporaryDom.innerHTML = t7_rendered.content;
                } else {
                    if ('length' in content && content.length > 1) {
                        for (var ci = 0; ci < content.length; ci++) {
                            $(app.router.temporaryDom).append(content[ci]);
                        }
                    } else {
                        $(app.router.temporaryDom).append(content);
                    }
                }
            }
        
            // Reload position
            reloadPosition = options.reload && (options.reloadPrevious ? 'left' : 'center');
        
            // Find new page
            if (pageName) newPage = pagesContainer.find('.page[data-page="' + pageName + '"]');
            else {
                newPage = app.router.findElement('.page', app.router.temporaryDom, view);
            }
        
            // If page not found exit
            if (!newPage || newPage.length === 0 || (pageName && view.activePage && view.activePage.name === pageName)) {
                view.allowPageChange = true;
                return;
            }
        
            newPage.addClass(options.reload ? 'page-on-' + reloadPosition : 'page-on-right');
        
            // Find old page (should be the last one) and remove older pages
            pagesInView = pagesContainer.children('.page:not(.cached)');
        
            if (options.reload && options.reloadPrevious && pagesInView.length === 1)  {
                view.allowPageChange = true;
                return;
            }
        
            if (options.reload) {
                oldPage = pagesInView.eq(pagesInView.length - 1);
            }
            else {
                if (pagesInView.length > 1) {
                    for (i = 0; i < pagesInView.length - 2; i++) {
                        if (!view.params.domCache) {
                            app.pageRemoveCallback(view, pagesInView[i], 'left');
                            $(pagesInView[i]).remove();
                        }
                        else {
                            $(pagesInView[i]).addClass('cached');
                        }
                    }
                    if (!view.params.domCache) {
                        app.pageRemoveCallback(view, pagesInView[i], 'left');
                        $(pagesInView[i]).remove();
                    }
                    else {
                        $(pagesInView[i]).addClass('cached');
                    }
                }
                oldPage = pagesContainer.children('.page:not(.cached)');
            }
            if(view.params.domCache) newPage.removeClass('cached');
        
            // Dynamic navbar
            if (view.params.dynamicNavbar) {
                dynamicNavbar = true;
                // Find navbar
                if (pageName) {
                    newNavbarInner = viewContainer.find('.navbar-inner[data-page="' + pageName + '"]');
                }
                else {
                    newNavbarInner = app.router.findElement('.navbar-inner', app.router.temporaryDom, view);
                }
                if (!newNavbarInner || newNavbarInner.length === 0) {
                    dynamicNavbar = false;
                }
                navbar = viewContainer.find('.navbar');
                if (options.reload) {
                    oldNavbarInner = navbar.find('.navbar-inner:not(.cached):last-child');
                }
                else {
                    oldNavbarInner = navbar.find('.navbar-inner:not(.cached)');
        
                    if (oldNavbarInner.length > 0) {
                        for (i = 0; i < oldNavbarInner.length - 1; i++) {
                            if (!view.params.domCache) {
                                app.navbarRemoveCallback(view, pagesInView[i], navbar[0], oldNavbarInner[i]);
                                $(oldNavbarInner[i]).remove();
                            }
                            else
                                $(oldNavbarInner[i]).addClass('cached');
                        }
                        if (!newNavbarInner && oldNavbarInner.length === 1) {
                            if (!view.params.domCache) {
                                app.navbarRemoveCallback(view, pagesInView[0], navbar[0], oldNavbarInner[0]);
                                $(oldNavbarInner[0]).remove();
                            }
                            else
                                $(oldNavbarInner[0]).addClass('cached');
                        }
                        oldNavbarInner = navbar.find('.navbar-inner:not(.cached)');
                    }
                }
            }
            if (dynamicNavbar) {
                newNavbarInner.addClass(options.reload ? 'navbar-on-' + reloadPosition : 'navbar-on-right');
                if(view.params.domCache) newNavbarInner.removeClass('cached');
                newPage[0].f7RelatedNavbar = newNavbarInner[0];
                newNavbarInner[0].f7RelatedPage = newPage[0];
            }
        
            // save content areas into view's cache
            if (!url) {
                var newPageName = pageName || newPage.attr('data-page');
                if (isDynamicPage) url = '#' + app.params.dynamicPageUrl.replace(/{{name}}/g, newPageName).replace(/{{index}}/g, view.history.length - (options.reload ? 1 : 0));
                else url = '#' + newPageName;
                if (!view.params.domCache) {
                    view.contentCache[url] = content;
                }
                if (view.params.domCache && pageName) {
                    view.pagesCache[url] = pageName;
                }
            }
        
            // Push State
            if (app.params.pushState && !options.reloadPrevious && view.main)  {
                if (typeof pushState === 'undefined') pushState = true;
                var pushStateRoot = app.params.pushStateRoot || '';
                var method = options.reload ? 'replaceState' : 'pushState';
                if (pushState) {
                    if (!isDynamicPage && !pageName) {
                        history[method]({url: url, viewIndex: app.views.indexOf(view)}, '', pushStateRoot + app.params.pushStateSeparator + url);
                    }
                    else if (isDynamicPage && content) {
                        history[method]({content: typeof content === 'string' ? content : '', url: url, viewIndex: app.views.indexOf(view)}, '', pushStateRoot + app.params.pushStateSeparator + url);
                    }
                    else if (pageName) {
                        history[method]({pageName: pageName, url: url, viewIndex: app.views.indexOf(view)}, '', pushStateRoot + app.params.pushStateSeparator + url);
                    }
                }
            }
        
            // Update View history
            view.url = url;
            if (options.reload) {
                var lastUrl = view.history[view.history.length - (options.reloadPrevious ? 2 : 1)];
                if (lastUrl &&
                    lastUrl.indexOf('#') === 0 &&
                    lastUrl in view.contentCache &&
                    lastUrl !== url &&
                    view.history.indexOf(lastUrl) === -1) {
                    view.contentCache[lastUrl] = null;
                    delete view.contentCache[lastUrl];
                }
                view.history[view.history.length - (options.reloadPrevious ? 2 : 1)] = url;
            }
            else {
                view.history.push(url);
            }
        
            // Unique history
            var historyBecameUnique = false;
            if (view.params.uniqueHistory) {
                var _history = view.history;
                var _url = url;
                if (view.params.uniqueHistoryIgnoreGetParameters) {
                    _history = [];
                    _url = url.split('?')[0];
                    for (i = 0; i < view.history.length; i++) {
                        _history.push(view.history[i].split('?')[0]);
                    }
                }
        
                if (_history.indexOf(_url) !== _history.lastIndexOf(_url)) {
                    view.history = view.history.slice(0, _history.indexOf(_url));
                    view.history.push(url);
                    historyBecameUnique = true;
                }
            }
            // Dom manipulations
            if (options.reloadPrevious) {
                oldPage = oldPage.prev('.page');
                newPage.insertBefore(oldPage);
                if (dynamicNavbar) {
                    oldNavbarInner = oldNavbarInner.prev('.navbar-inner');
                    newNavbarInner.insertAfter(oldNavbarInner);
                }
            }
            else {
                pagesContainer.append(newPage[0]);
                if (dynamicNavbar) navbar.append(newNavbarInner[0]);
            }
            // Remove Old Page And Navbar
            if (options.reload) {
                if (view.params.domCache && view.initialPages.indexOf(oldPage[0]) >= 0) {
                    oldPage.addClass('cached');
                    if (dynamicNavbar) oldNavbarInner.addClass('cached');
                }
                else {
                    app.pageRemoveCallback(view, oldPage[0], reloadPosition);
                    if (dynamicNavbar) app.navbarRemoveCallback(view, oldPage[0], navbar[0], oldNavbarInner[0]);
                    oldPage.remove();
                    if (dynamicNavbar) oldNavbarInner.remove();
                }
            }
        
            // Page Init Events
            app.pageInitCallback(view, {
                pageContainer: newPage[0],
                url: url,
                position: options.reload ? reloadPosition : 'right',
                navbarInnerContainer: dynamicNavbar ? newNavbarInner && newNavbarInner[0] : undefined,
                oldNavbarInnerContainer: dynamicNavbar ? oldNavbarInner && oldNavbarInner[0] : undefined,
                context: t7_rendered.context,
                query: options.query,
                fromPage: oldPage && oldPage.length && oldPage[0].f7PageData,
                reload: options.reload,
                reloadPrevious: options.reloadPrevious
            });
        
            // Navbar init event
            if (dynamicNavbar) {
                app.navbarInitCallback(view, newPage[0], navbar[0], newNavbarInner[0], url, options.reload ? reloadPosition : 'right');
            }
        
            if (options.reload) {
                view.allowPageChange = true;
                if (historyBecameUnique) view.refreshPreviousPage();
                return;
            }
        
            if (dynamicNavbar && animatePages) {
                app.router.prepareNavbar(newNavbarInner, oldNavbarInner, 'right');
            }
            // Force reLayout
            var clientLeft = newPage[0].clientLeft;
        
            // Before Anim Callback
            app.pageAnimCallback('before', view, {
                pageContainer: newPage[0],
                url: url,
                position: 'right',
                oldPage: oldPage,
                newPage: newPage,
                query: options.query,
                fromPage: oldPage && oldPage.length && oldPage[0].f7PageData
            });
        
            function afterAnimation() {
                view.allowPageChange = true;
                newPage.removeClass('page-from-right-to-center page-on-right page-on-left').addClass('page-on-center');
                oldPage.removeClass('page-from-center-to-left page-on-center page-on-right').addClass('page-on-left');
                if (dynamicNavbar) {
                    newNavbarInner.removeClass('navbar-from-right-to-center navbar-on-left navbar-on-right').addClass('navbar-on-center');
                    oldNavbarInner.removeClass('navbar-from-center-to-left navbar-on-center navbar-on-right').addClass('navbar-on-left');
                }
                app.pageAnimCallback('after', view, {
                    pageContainer: newPage[0],
                    url: url,
                    position: 'right',
                    oldPage: oldPage,
                    newPage: newPage,
                    query: options.query,
                    fromPage: oldPage && oldPage.length && oldPage[0].f7PageData
                });
                if (app.params.pushState && view.main) app.pushStateClearQueue();
                if (!(view.params.swipeBackPage || view.params.preloadPreviousPage)) {
                    if (view.params.domCache) {
                        oldPage.addClass('cached');
                        if (dynamicNavbar) oldNavbarInner.addClass('cached');
                    }
                    else {
                        if (!(url.indexOf('#') === 0 && newPage.attr('data-page').indexOf('smart-select-') === 0)) {
                            app.pageRemoveCallback(view, oldPage[0], 'left');
                            if (dynamicNavbar) app.navbarRemoveCallback(view, oldPage[0], navbar[0], oldNavbarInner[0]);
                            oldPage.remove();
                            if (dynamicNavbar) oldNavbarInner.remove();
                        }
                    }
                }
                if (view.params.uniqueHistory && historyBecameUnique) {
                    view.refreshPreviousPage();
                }
            }
            if (animatePages) {
                // Set pages before animation
                if (app.params.material && app.params.materialPageLoadDelay) {
                    setTimeout(function () {
                        app.router.animatePages(oldPage, newPage, 'to-left', view);
                    }, app.params.materialPageLoadDelay);
                }
                else {
                    app.router.animatePages(oldPage, newPage, 'to-left', view);
                }
        
                // Dynamic navbar animation
                if (dynamicNavbar) {
                    setTimeout(function() {
                        app.router.animateNavbars(oldNavbarInner, newNavbarInner, 'to-left', view);
                    }, 0);
                }
                newPage.animationEnd(function (e) {
                    afterAnimation();
                });
            }
            else {
                if (dynamicNavbar) newNavbarInner.find('.sliding, .sliding .back .icon').transform('');
                afterAnimation();
            }
        
        };
        
        app.router.load = function (view, options) {
            if (app.router.preroute(view, options)) {
                return false;
            }
            options = options || {};
            var url = options.url;
            var content = options.content;
            var pageName = options.pageName;
            if (pageName) {
                if (pageName.indexOf('?') > 0) {
                    options.query = $.parseUrlQuery(pageName);
                    options.pageName = pageName = pageName.split('?')[0];
                }
            }
            var template = options.template;
            if (view.params.reloadPages === true) options.reload = true;
        
            if (!view.allowPageChange) return false;
            if (url && view.url === url && !options.reload && !view.params.allowDuplicateUrls) return false;
            view.allowPageChange = false;
            if (app.xhr && view.xhr && view.xhr === app.xhr) {
                app.xhr.abort();
                app.xhr = false;
            }
            function proceed(content) {
                app.router.preprocess(view, content, url, function (content) {
                    options.content = content;
                    app.router._load(view, options);
                });
            }
            if (content || pageName) {
                proceed(content);
                return;
            }
            else if (template) {
                app.router._load(view, options);
                return;
            }
        
            if (!options.url || options.url === '#') {
                view.allowPageChange = true;
                return;
            }
            app.get(options.url, view, options.ignoreCache, function (content, error) {
                if (error) {
                    view.allowPageChange = true;
                    return;
                }
                proceed(content);
            });
        };
        
        app.router._back = function (view, options) {
            options = options || {};
            var url = options.url,
                content = options.content,
                t7_rendered = {content: options.content}, // will be rendered using Template7
                template = options.template, // Template 7 compiled template
                animatePages = options.animatePages,
                preloadOnly = options.preloadOnly,
                pushState = options.pushState,
                ignoreCache = options.ignoreCache,
                force = options.force,
                pageName = options.pageName;
        
            var viewContainer = $(view.container),
                pagesContainer = $(view.pagesContainer),
                pagesInView = pagesContainer.children('.page:not(.cached)'),
                oldPage, newPage, oldNavbarInner, newNavbarInner, navbar, navbarInners, dynamicNavbar, manipulateDom = true;
        
            if (typeof animatePages === 'undefined') animatePages = view.params.animatePages;
        
            app.pluginHook('routerBack', view, options);
        
            // Render with Template7
            if (app.params.template7Pages && typeof content === 'string' || template) {
                t7_rendered = app.router.template7Render(view, options);
                if (t7_rendered.content && !content) {
                    content = t7_rendered.content;
                }
            }
        
            // Animation
            function afterAnimation() {
                app.pageBackCallback('after', view, {
                    pageContainer: oldPage[0],
                    url: url,
                    position: 'center',
                    oldPage: oldPage,
                    newPage: newPage,
                });
                app.pageAnimCallback('after', view, {
                    pageContainer: newPage[0],
                    url: url,
                    position: 'left',
                    oldPage: oldPage,
                    newPage: newPage,
                    query: options.query,
                    fromPage: oldPage && oldPage.length && oldPage[0].f7PageData
                });
                app.router.afterBack(view, oldPage[0], newPage[0]);
            }
            function animateBack() {
                // Page before animation callback
                app.pageBackCallback('before', view, {
                    pageContainer: oldPage[0],
                    url: url,
                    position: 'center',
                    oldPage: oldPage,
                    newPage: newPage,
                });
                app.pageAnimCallback('before', view, {
                    pageContainer: newPage[0],
                    url: url,
                    position: 'left',
                    oldPage: oldPage,
                    newPage: newPage,
                    query: options.query,
                    fromPage: oldPage && oldPage.length && oldPage[0].f7PageData
                });
        
                if (animatePages) {
                    // Set pages before animation
                    app.router.animatePages(newPage, oldPage, 'to-right', view);
        
                    // Dynamic navbar animation
                    if (dynamicNavbar) {
                        setTimeout(function () {
                            app.router.animateNavbars(newNavbarInner, oldNavbarInner, 'to-right', view);
                        }, 0);
                    }
        
                    newPage.animationEnd(function () {
                        afterAnimation();
                    });
                }
                else {
                    if (dynamicNavbar) newNavbarInner.find('.sliding, .sliding .back .icon').transform('');
                    afterAnimation();
                }
            }
        
            function parseNewPage() {
                app.router.temporaryDom.innerHTML = '';
                // Parse DOM
                if ((typeof content === 'string') || (url && (typeof content === 'string'))) {
                    app.router.temporaryDom.innerHTML = t7_rendered.content;
                } else {
                    if ('length' in content && content.length > 1) {
                        for (var ci = 0; ci < content.length; ci++) {
                            $(app.router.temporaryDom).append(content[ci]);
                        }
                    } else {
                        $(app.router.temporaryDom).append(content);
                    }
                }
                newPage = app.router.findElement('.page', app.router.temporaryDom, view);
        
                if (view.params.dynamicNavbar) {
                    // Find navbar
                    newNavbarInner = app.router.findElement('.navbar-inner', app.router.temporaryDom, view);
                }
            }
            function setPages() {
                // If pages not found or there are still more than one, exit
                if (!newPage || newPage.length === 0) {
                    view.allowPageChange = true;
                    return;
                }
                if (view.params.dynamicNavbar && typeof dynamicNavbar === 'undefined') {
                    if (!newNavbarInner || newNavbarInner.length === 0) {
                        dynamicNavbar = false;
                    }
                    else {
                        dynamicNavbar = true;
                    }
                }
        
                newPage.addClass('page-on-left').removeClass('cached');
                if (dynamicNavbar) {
                    navbar = viewContainer.find('.navbar');
                    navbarInners = viewContainer.find('.navbar-inner:not(.cached)');
                    newNavbarInner.addClass('navbar-on-left').removeClass('cached');
                }
                // Remove/hide previous page in force mode
                if (force) {
                    var pageToRemove, navbarToRemove;
                    pageToRemove = $(pagesInView[pagesInView.length - 2]);
        
                    if (dynamicNavbar) navbarToRemove = $(pageToRemove[0] && pageToRemove[0].f7RelatedNavbar || navbarInners[navbarInners.length - 2]);
                    if (view.params.domCache && view.initialPages.indexOf(pageToRemove[0]) >= 0) {
                        if (pageToRemove.length && pageToRemove[0] !== newPage[0]) pageToRemove.addClass('cached');
                        if (dynamicNavbar && navbarToRemove.length && navbarToRemove[0] !== newNavbarInner[0]) {
                            navbarToRemove.addClass('cached');
                        }
                    }
                    else {
                        var removeNavbar = dynamicNavbar && navbarToRemove.length;
                        if (pageToRemove.length) {
                            app.pageRemoveCallback(view, pageToRemove[0], 'right');
                            if (removeNavbar) {
                                app.navbarRemoveCallback(view, pageToRemove[0], navbar[0], navbarToRemove[0]);
                            }
                            pageToRemove.remove();
                            if (removeNavbar) navbarToRemove.remove();
                        }
                        else if (removeNavbar) {
                            app.navbarRemoveCallback(view, pageToRemove[0], navbar[0], navbarToRemove[0]);
                            navbarToRemove.remove();
                        }
                    }
                    pagesInView = pagesContainer.children('.page:not(.cached)');
                    if (dynamicNavbar) {
                        navbarInners = viewContainer.find('.navbar-inner:not(.cached)');
                    }
                    if (view.history.indexOf(url) >= 0) {
                        view.history = view.history.slice(0, view.history.indexOf(url) + 2);
                    }
                    else {
                        if (view.history[[view.history.length - 2]]) {
                            view.history[view.history.length - 2] = url;
                        }
                        else {
                            view.history.unshift(url);
                        }
                    }
                }
        
                oldPage = $(pagesInView[pagesInView.length - 1]);
                if (view.params.domCache) {
                    if (oldPage[0] === newPage[0]) {
                        oldPage = pagesContainer.children('.page.page-on-center');
                        if (oldPage.length === 0 && view.activePage) oldPage = $(view.activePage.container);
                    }
                }
        
                if (dynamicNavbar && !oldNavbarInner) {
                    oldNavbarInner = $(navbarInners[navbarInners.length - 1]);
                    if (view.params.domCache) {
                        if (oldNavbarInner[0] === newNavbarInner[0]) {
                            oldNavbarInner = navbar.children('.navbar-inner.navbar-on-center:not(.cached)');
                        }
                        if (oldNavbarInner.length === 0) {
                            oldNavbarInner = navbar.children('.navbar-inner[data-page="'+oldPage.attr('data-page')+'"]');
                        }
                    }
                    if (oldNavbarInner.length === 0 || newNavbarInner[0] === oldNavbarInner[0]) dynamicNavbar = false;
                }
        
                if (dynamicNavbar) {
                    if (manipulateDom) newNavbarInner.insertBefore(oldNavbarInner);
                    newNavbarInner[0].f7RelatedPage = newPage[0];
                    newPage[0].f7RelatedNavbar = newNavbarInner[0];
                }
                if (manipulateDom) newPage.insertBefore(oldPage);
        
                // Page Init Events
                app.pageInitCallback(view, {
                    pageContainer: newPage[0],
                    url: url,
                    position: 'left',
                    navbarInnerContainer: dynamicNavbar ? newNavbarInner[0] : undefined,
                    oldNavbarInnerContainer: dynamicNavbar ? oldNavbarInner && oldNavbarInner[0] : undefined,
                    context: t7_rendered.context,
                    query: options.query,
                    fromPage: oldPage && oldPage.length && oldPage[0].f7PageData,
                    preloadOnly: preloadOnly
                });
                if (dynamicNavbar) {
                    app.navbarInitCallback(view, newPage[0], navbar[0], newNavbarInner[0], url, 'right');
                }
        
                if (dynamicNavbar && newNavbarInner.hasClass('navbar-on-left') && animatePages) {
                    app.router.prepareNavbar(newNavbarInner,  oldNavbarInner, 'left');
                }
        
                if (preloadOnly) {
                    view.allowPageChange = true;
                    return;
                }
        
                // Update View's URL
                view.url = url;
        
                // Force reLayout
                var clientLeft = newPage[0].clientLeft;
        
                animateBack();
        
                // Push state
                if (app.params.pushState && view.main)  {
                    if (typeof pushState === 'undefined') pushState = true;
                    if (!preloadOnly && history.state && pushState) {
                        history.back();
                    }
                }
                return;
            }
        
            // Simple go back when we have pages on left
            if (pagesInView.length > 1 && !force) {
                // Exit if only preloadOnly
                if (preloadOnly) {
                    view.allowPageChange = true;
                    return;
                }
                // Update View's URL
                view.url = view.history[view.history.length - 2];
                url = view.url;
        
                // Define old and new pages
                newPage = $(pagesInView[pagesInView.length - 2]);
                oldPage = $(pagesInView[pagesInView.length - 1]);
        
                // Dynamic navbar
                if (view.params.dynamicNavbar) {
                    dynamicNavbar = true;
                    // Find navbar
                    navbarInners = viewContainer.find('.navbar-inner:not(.cached)');
                    newNavbarInner = $(navbarInners[0]);
                    oldNavbarInner = $(navbarInners[1]);
                    if (newNavbarInner.length === 0 || oldNavbarInner.length === 0 || oldNavbarInner[0] === newNavbarInner[0]) {
                        dynamicNavbar = false;
                    }
                }
                manipulateDom = false;
                setPages();
                return;
            }
        
            if (!force) {
                // Go back when there is no pages on left
                if (!preloadOnly) {
                    view.url = view.history[view.history.length - 2];
                    url = view.url;
                }
        
                if (content) {
                    parseNewPage();
                    setPages();
                    return;
                }
                else if (pageName) {
                    // Get dom cached pages
                    newPage = $(viewContainer).find('.page[data-page="' + pageName + '"]');
                    if (view.params.dynamicNavbar) {
                        newNavbarInner = $(viewContainer).find('.navbar-inner[data-page="' + pageName + '"]');
                        if (newNavbarInner.length === 0 && newPage[0].f7RelatedNavbar) {
                            newNavbarInner = $(newPage[0].f7RelatedNavbar);
                        }
                        if (newNavbarInner.length === 0 && newPage[0].f7PageData) {
                            newNavbarInner = $(newPage[0].f7PageData.navbarInnerContainer);
                        }
                    }
                    setPages();
                    return;
                }
                else {
                    view.allowPageChange = true;
                    return;
                }
            }
            else {
                if (url && url === view.url || pageName && view.activePage && view.activePage.name === pageName) {
                    view.allowPageChange = true;
                    return;
                }
                // Go back with force url
                if (content) {
                    parseNewPage();
                    setPages();
                    return;
                }
                else if (pageName && view.params.domCache) {
                    if (pageName) url = '#' + pageName;
        
                    newPage = $(viewContainer).find('.page[data-page="' + pageName + '"]');
                    if (newPage[0].f7PageData && newPage[0].f7PageData.url) {
                        url = newPage[0].f7PageData.url;
                    }
                    if (view.params.dynamicNavbar) {
                        newNavbarInner = $(viewContainer).find('.navbar-inner[data-page="' + pageName + '"]');
                        if (newNavbarInner.length === 0 && newPage[0].f7RelatedNavbar) {
                            newNavbarInner = $(newPage[0].f7RelatedNavbar);
                        }
                        if (newNavbarInner.length === 0 && newPage[0].f7PageData) {
                            newNavbarInner = $(newPage[0].f7PageData.navbarInnerContainer);
                        }
                    }
                    setPages();
                    return;
                }
                else {
                    view.allowPageChange = true;
                    return;
                }
            }
        
        };
        app.router.back = function (view, options) {
            if (app.router.preroute(view, options)) {
                return false;
            }
            options = options || {};
            var url = options.url;
            var content = options.content;
            var pageName = options.pageName;
            if (pageName) {
                if (pageName.indexOf('?') > 0) {
                    options.query = $.parseUrlQuery(pageName);
                    options.pageName = pageName = pageName.split('?')[0];
                }
            }
            var force = options.force;
            if (!view.allowPageChange) return false;
            view.allowPageChange = false;
            if (app.xhr && view.xhr && view.xhr === app.xhr) {
                app.xhr.abort();
                app.xhr = false;
            }
            var pagesInView = $(view.pagesContainer).find('.page:not(.cached)');
        
            function proceed(content) {
                app.router.preprocess(view, content, url, function (content) {
                    options.content = content;
                    app.router._back(view, options);
                });
            }
            if (pagesInView.length > 1 && !force) {
                // Simple go back to previos page in view
                app.router._back(view, options);
                return;
            }
            if (!force) {
                url = options.url = view.history[view.history.length - 2];
                if (!url) {
                    view.allowPageChange = true;
                    return;
                }
                if (url.indexOf('#') === 0 && view.contentCache[url]) {
                    proceed(view.contentCache[url]);
                    return;
                }
                else if (url.indexOf('#') === 0 && view.params.domCache) {
                    if (!pageName) options.pageName = url.split('#')[1];
                    proceed();
                    return;
                }
                else if (url.indexOf('#') !== 0) {
                    // Load ajax page
                    app.get(options.url, view, options.ignoreCache, function (content, error) {
                        if (error) {
                            view.allowPageChange = true;
                            return;
                        }
                        proceed(content);
                    });
                    return;
                }
            }
            else {
                // Go back with force url
                if (!url && content) {
                    proceed(content);
                    return;
                }
                else if (!url && pageName) {
                    if (pageName) url = '#' + pageName;
                    proceed();
                    return;
                }
                else if (url) {
                    app.get(options.url, view, options.ignoreCache, function (content, error) {
                        if (error) {
                            view.allowPageChange = true;
                            return;
                        }
                        proceed(content);
                    });
                    return;
                }
            }
            view.allowPageChange = true;
            return;
        };
        
        app.router.afterBack = function (view, oldPage, newPage) {
            // Remove old page and set classes on new one
            oldPage = $(oldPage);
            newPage = $(newPage);
        
            if (view.params.domCache && view.initialPages.indexOf(oldPage[0]) >= 0) {
                oldPage.removeClass('page-from-center-to-right').addClass('cached');
            }
            else {
                app.pageRemoveCallback(view, oldPage[0], 'right');
                oldPage.remove();
            }
        
            newPage.removeClass('page-from-left-to-center page-on-left').addClass('page-on-center');
            view.allowPageChange = true;
        
            // Update View's History
            var previousURL = view.history.pop();
        
            var newNavbar;
        
            // Updated dynamic navbar
            if (view.params.dynamicNavbar) {
                var inners = $(view.container).find('.navbar-inner:not(.cached)');
                var oldNavbar = $(oldPage[0].f7RelatedNavbar || inners[1]);
                if (view.params.domCache && view.initialNavbars.indexOf(oldNavbar[0]) >= 0) {
                    oldNavbar.removeClass('navbar-from-center-to-right').addClass('cached');
                }
                else {
                    app.navbarRemoveCallback(view, oldPage[0], undefined, oldNavbar[0]);
                    oldNavbar.remove();
                }
                newNavbar = $(inners[0]).removeClass('navbar-on-left navbar-from-left-to-center').addClass('navbar-on-center');
            }
        
            // Remove pages in dom cache
            if (view.params.domCache) {
                $(view.container).find('.page.cached').each(function () {
                    var page = $(this);
                    var index = page.index();
                    var pageUrl = page[0].f7PageData && page[0].f7PageData.url;
                    if (pageUrl && view.history.indexOf(pageUrl) < 0 && view.initialPages.indexOf(this) < 0) {
                        app.pageRemoveCallback(view, page[0], 'right');
                        if (page[0].f7RelatedNavbar && view.params.dynamicNavbar) app.navbarRemoveCallback(view, page[0], undefined, page[0].f7RelatedNavbar);
                        page.remove();
                        if (page[0].f7RelatedNavbar && view.params.dynamicNavbar) $(page[0].f7RelatedNavbar).remove();
                    }
                });
            }
        
            // Check previous page is content based only and remove it from content cache
            if (!view.params.domCache &&
                previousURL &&
                previousURL.indexOf('#') > -1 &&
                (previousURL in view.contentCache) &&
                // If the same page is in the history multiple times, don't remove it.
                view.history.indexOf(previousURL) === -1) {
                view.contentCache[previousURL] = null;
                delete view.contentCache[previousURL];
            }
        
            if (app.params.pushState && view.main) app.pushStateClearQueue();
        
            // Preload previous page
            if (view.params.preloadPreviousPage) {
                if (view.params.domCache && view.history.length > 1) {
                    var preloadUrl = view.history[view.history.length - 2];
                    var previousPage;
                    var previousNavbar;
                    if (preloadUrl && view.pagesCache[preloadUrl]) {
                        // Load by page name
                        previousPage = $(view.container).find('.page[data-page="' + view.pagesCache[preloadUrl] + '"]');
                        if (previousPage.next('.page')[0] !== newPage[0]) previousPage.insertBefore(newPage);
                        if (newNavbar) {
                            previousNavbar = $(view.container).find('.navbar-inner[data-page="' + view.pagesCache[preloadUrl] + '"]');
                            if(!previousNavbar || previousNavbar.length === 0) previousNavbar = newNavbar.prev('.navbar-inner.cached');
                            if (previousNavbar.next('.navbar-inner')[0] !== newNavbar[0]) previousNavbar.insertBefore(newNavbar);
                        }
                    }
                    else {
                        // Just load previous page
                        previousPage = newPage.prev('.page.cached');
                        if (newNavbar) previousNavbar = newNavbar.prev('.navbar-inner.cached');
                    }
                    if (previousPage && previousPage.length > 0) previousPage.removeClass('cached page-on-right page-on-center').addClass('page-on-left');
                    if (previousNavbar && previousNavbar.length > 0) previousNavbar.removeClass('cached navbar-on-right navbar-on-center').addClass('navbar-on-left');
                }
                else {
                    app.router.back(view, {preloadOnly: true});
                }
            }
        };
        

        /*======================================================
        ************   Modals   ************
        ======================================================*/
        var _modalTemplateTempDiv = document.createElement('div');
        app.modalStack = [];
        app.modalStackClearQueue = function () {
            if (app.modalStack.length) {
                (app.modalStack.shift())();
            }
        };
        app.modal = function (params) {
            params = params || {};
            var modalHTML = '';
            if (app.params.modalTemplate) {
                if (!app._compiledTemplates.modal) app._compiledTemplates.modal = t7.compile(app.params.modalTemplate);
                modalHTML = app._compiledTemplates.modal(params);
            }
            else {
                var buttonsHTML = '';
                if (params.buttons && params.buttons.length > 0) {
                    for (var i = 0; i < params.buttons.length; i++) {
                        buttonsHTML += '<span class="modal-button' + (params.buttons[i].bold ? ' modal-button-bold' : '') + '">' + params.buttons[i].text + '</span>';
                    }
                }
                var titleHTML = params.title ? '<div class="modal-title">' + params.title + '</div>' : '';
                var textHTML = params.text ? '<div class="modal-text">' + params.text + '</div>' : '';
                var afterTextHTML = params.afterText ? params.afterText : '';
                var noButtons = !params.buttons || params.buttons.length === 0 ? 'modal-no-buttons' : '';
                var verticalButtons = params.verticalButtons ? 'modal-buttons-vertical': '';
                var modalButtonsHTML = params.buttons && params.buttons.length > 0 ? '<div class="modal-buttons modal-buttons-' + params.buttons.length + ' ' + verticalButtons + '">' + buttonsHTML + '</div>' : '';
                modalHTML = '<div class="modal ' + noButtons + ' ' + (params.cssClass || '') + '"><div class="modal-inner">' + (titleHTML + textHTML + afterTextHTML) + '</div>' + modalButtonsHTML + '</div>';
            }
        
            _modalTemplateTempDiv.innerHTML = modalHTML;
        
            var modal = $(_modalTemplateTempDiv).children();
        
            $('body').append(modal[0]);
        
            // Add events on buttons
            modal.find('.modal-button').each(function (index, el) {
                $(el).on('click', function (e) {
                    if (params.buttons[index].close !== false) app.closeModal(modal);
                    if (params.buttons[index].onClick) params.buttons[index].onClick(modal, e);
                    if (params.onClick) params.onClick(modal, index);
                });
            });
            app.openModal(modal);
            return modal[0];
        };
        app.alert = function (text, title, callbackOk) {
            if (typeof title === 'function') {
                callbackOk = arguments[1];
                title = undefined;
            }
            return app.modal({
                text: text || '',
                title: typeof title === 'undefined' ? app.params.modalTitle : title,
                buttons: [ {text: app.params.modalButtonOk, bold: true, onClick: callbackOk} ]
            });
        };
        app.confirm = function (text, title, callbackOk, callbackCancel) {
            if (typeof title === 'function') {
                callbackCancel = arguments[2];
                callbackOk = arguments[1];
                title = undefined;
            }
            return app.modal({
                text: text || '',
                title: typeof title === 'undefined' ? app.params.modalTitle : title,
                buttons: [
                    {text: app.params.modalButtonCancel, onClick: callbackCancel},
                    {text: app.params.modalButtonOk, bold: true, onClick: callbackOk}
                ]
            });
        };
        app.prompt = function (text, title, callbackOk, callbackCancel) {
            if (typeof title === 'function') {
                callbackCancel = arguments[2];
                callbackOk = arguments[1];
                title = undefined;
            }
            return app.modal({
                text: text || '',
                title: typeof title === 'undefined' ? app.params.modalTitle : title,
                afterText: '<div class="input-field"><input type="text" class="modal-text-input"></div>',
                buttons: [
                    {
                        text: app.params.modalButtonCancel
                    },
                    {
                        text: app.params.modalButtonOk,
                        bold: true
                    }
                ],
                onClick: function (modal, index) {
                    if (index === 0 && callbackCancel) callbackCancel($(modal).find('.modal-text-input').val());
                    if (index === 1 && callbackOk) callbackOk($(modal).find('.modal-text-input').val());
                }
            });
        };
        app.modalLogin = function (text, title, callbackOk, callbackCancel) {
            if (typeof title === 'function') {
                callbackCancel = arguments[2];
                callbackOk = arguments[1];
                title = undefined;
            }
            return app.modal({
                text: text || '',
                title: typeof title === 'undefined' ? app.params.modalTitle : title,
                afterText: '<div class="input-field modal-input-double"><input type="text" name="modal-username" placeholder="' + app.params.modalUsernamePlaceholder + '" class="modal-text-input"></div><div class="input-field modal-input-double"><input type="password" name="modal-password" placeholder="' + app.params.modalPasswordPlaceholder + '" class="modal-text-input"></div>',
                buttons: [
                    {
                        text: app.params.modalButtonCancel
                    },
                    {
                        text: app.params.modalButtonOk,
                        bold: true
                    }
                ],
                onClick: function (modal, index) {
                    var username = $(modal).find('.modal-text-input[name="modal-username"]').val();
                    var password = $(modal).find('.modal-text-input[name="modal-password"]').val();
                    if (index === 0 && callbackCancel) callbackCancel(username, password);
                    if (index === 1 && callbackOk) callbackOk(username, password);
                }
            });
        };
        app.modalPassword = function (text, title, callbackOk, callbackCancel) {
            if (typeof title === 'function') {
                callbackCancel = arguments[2];
                callbackOk = arguments[1];
                title = undefined;
            }
            return app.modal({
                text: text || '',
                title: typeof title === 'undefined' ? app.params.modalTitle : title,
                afterText: '<div class="input-field"><input type="password" name="modal-password" placeholder="' + app.params.modalPasswordPlaceholder + '" class="modal-text-input"></div>',
                buttons: [
                    {
                        text: app.params.modalButtonCancel
                    },
                    {
                        text: app.params.modalButtonOk,
                        bold: true
                    }
                ],
                onClick: function (modal, index) {
                    var password = $(modal).find('.modal-text-input[name="modal-password"]').val();
                    if (index === 0 && callbackCancel) callbackCancel(password);
                    if (index === 1 && callbackOk) callbackOk(password);
                }
            });
        };
        app.showPreloader = function (title) {
            return app.modal({
                title: title || app.params.modalPreloaderTitle,
                text: '<div class="preloader">' + (app.params.material ? app.params.materialPreloaderHtml : '') + '</div>',
                cssClass: 'modal-preloader'
            });
        };
        app.hidePreloader = function () {
            app.closeModal('.modal.modal-in');
        };
        app.showIndicator = function () {
            $('body').append('<div class="preloader-indicator-overlay"></div><div class="preloader-indicator-modal"><span class="preloader preloader-white">' + (app.params.material ? app.params.materialPreloaderHtml : '') + '</span></div>');
        };
        app.hideIndicator = function () {
            $('.preloader-indicator-overlay, .preloader-indicator-modal').remove();
        };
        // Action Sheet
        app.actions = function (target, params) {
            var toPopover = false, modal, groupSelector, buttonSelector;
            if (arguments.length === 1) {
                // Actions
                params = target;
            }
            else {
                // Popover
                if (app.device.ios) {
                    if (app.device.ipad) toPopover = true;
                }
                else {
                    if ($(window).width() >= 768) toPopover = true;
                }
            }
            params = params || [];
        
            if (params.length > 0 && !$.isArray(params[0])) {
                params = [params];
            }
            var modalHTML;
            if (toPopover) {
                var actionsToPopoverTemplate = app.params.modalActionsToPopoverTemplate ||
                    '<div class="popover actions-popover">' +
                      '<div class="popover-inner">' +
                        '{{#each this}}' +
                        '<div class="list-block">' +
                          '<ul>' +
                            '{{#each this}}' +
                            '{{#if label}}' +
                            '<li class="actions-popover-label {{#if color}}color-{{color}}{{/if}} {{#if bold}}actions-popover-bold{{/if}}">{{text}}</li>' +
                            '{{else}}' +
                            '<li><a href="#" class="item-link list-button {{#if color}}color-{{color}}{{/if}} {{#if bg}}bg-{{bg}}{{/if}} {{#if bold}}actions-popover-bold{{/if}} {{#if disabled}}disabled{{/if}}">{{text}}</a></li>' +
                            '{{/if}}' +
                            '{{/each}}' +
                          '</ul>' +
                        '</div>' +
                        '{{/each}}' +
                      '</div>' +
                    '</div>';
                if (!app._compiledTemplates.actionsToPopover) {
                    app._compiledTemplates.actionsToPopover = t7.compile(actionsToPopoverTemplate);
                }
                var popoverHTML = app._compiledTemplates.actionsToPopover(params);
                modal = $(app.popover(popoverHTML, target, true));
                groupSelector = '.list-block ul';
                buttonSelector = '.list-button';
            }
            else {
                if (app.params.modalActionsTemplate) {
                    if (!app._compiledTemplates.actions) app._compiledTemplates.actions = t7.compile(app.params.modalActionsTemplate);
                    modalHTML = app._compiledTemplates.actions(params);
                }
                else {
                    var buttonsHTML = '';
                    for (var i = 0; i < params.length; i++) {
                        for (var j = 0; j < params[i].length; j++) {
                            if (j === 0) buttonsHTML += '<div class="actions-modal-group">';
                            var button = params[i][j];
                            var buttonClass = button.label ? 'actions-modal-label' : 'actions-modal-button';
                            if (button.bold) buttonClass += ' actions-modal-button-bold';
                            if (button.color) buttonClass += ' color-' + button.color;
                            if (button.bg) buttonClass += ' bg-' + button.bg;
                            if (button.disabled) buttonClass += ' disabled';
                            buttonsHTML += '<div class="' + buttonClass + '">' + button.text + '</div>';
                            if (j === params[i].length - 1) buttonsHTML += '</div>';
                        }
                    }
                    modalHTML = '<div class="actions-modal">' + buttonsHTML + '</div>';
                }
                _modalTemplateTempDiv.innerHTML = modalHTML;
                modal = $(_modalTemplateTempDiv).children();
                $('body').append(modal[0]);
                groupSelector = '.actions-modal-group';
                buttonSelector = '.actions-modal-button';
            }
        
            var groups = modal.find(groupSelector);
            groups.each(function (index, el) {
                var groupIndex = index;
                $(el).children().each(function (index, el) {
                    var buttonIndex = index;
                    var buttonParams = params[groupIndex][buttonIndex];
                    var clickTarget;
                    if (!toPopover && $(el).is(buttonSelector)) clickTarget = $(el);
                    if (toPopover && $(el).find(buttonSelector).length > 0) clickTarget = $(el).find(buttonSelector);
        
                    if (clickTarget) {
                        clickTarget.on('click', function (e) {
                            if (buttonParams.close !== false) app.closeModal(modal);
                            if (buttonParams.onClick) buttonParams.onClick(modal, e);
                        });
                    }
                });
            });
            if (!toPopover) app.openModal(modal);
            return modal[0];
        };
        app.popover = function (modal, target, removeOnClose) {
            if (typeof removeOnClose === 'undefined') removeOnClose = true;
            if (typeof modal === 'string' && modal.indexOf('<') >= 0) {
                var _modal = document.createElement('div');
                _modal.innerHTML = modal.trim();
                if (_modal.childNodes.length > 0) {
                    modal = _modal.childNodes[0];
                    if (removeOnClose) modal.classList.add('remove-on-close');
                    $('body').append(modal);
                }
                else return false; //nothing found
            }
            modal = $(modal);
            target = $(target);
            if (modal.length === 0 || target.length === 0) return false;
            if (modal.parents('body').length === 0) {
                if (removeOnClose) modal.addClass('remove-on-close');
                $('body').append(modal[0]);
            }
            if (modal.find('.popover-angle').length === 0 && !app.params.material) {
                modal.append('<div class="popover-angle"></div>');
            }
            modal.show();
        
            var material = app.params.material;
        
            function sizePopover() {
                modal.css({left: '', top: ''});
                var modalWidth =  modal.width();
                var modalHeight =  modal.height(); // 13 - height of angle
                var modalAngle, modalAngleSize = 0, modalAngleLeft, modalAngleTop;
                if (!material) {
                    modalAngle = modal.find('.popover-angle');
                    modalAngleSize = modalAngle.width() / 2;
                    modalAngle.removeClass('on-left on-right on-top on-bottom').css({left: '', top: ''});
                }
                else {
                    modal.removeClass('popover-on-left popover-on-right popover-on-top popover-on-bottom').css({left: '', top: ''});
                }
        
                var targetWidth = target.outerWidth();
                var targetHeight = target.outerHeight();
                var targetOffset = target.offset();
                var targetParentPage = target.parents('.page');
                if (targetParentPage.length > 0) {
                    targetOffset.top = targetOffset.top - targetParentPage[0].scrollTop;
                }
        
                var windowHeight = $(window).height();
                var windowWidth = $(window).width();
        
                var modalTop = 0;
                var modalLeft = 0;
                var diff = 0;
                // Top Position
                var modalPosition = material ? 'bottom' : 'top';
                if (material) {
                    if (modalHeight < windowHeight - targetOffset.top - targetHeight) {
                        // On bottom
                        modalPosition = 'bottom';
                        modalTop = targetOffset.top;
                    }
                    else if (modalHeight < targetOffset.top) {
                        // On top
                        modalTop = targetOffset.top - modalHeight + targetHeight;
                        modalPosition = 'top';
                    }
                    else {
                        // On middle
                        modalPosition = 'bottom';
                        modalTop = targetOffset.top;
                    }
        
                    if (modalTop <= 0) {
                        modalTop = 8;
                    }
                    else if (modalTop + modalHeight >= windowHeight) {
                        modalTop = windowHeight - modalHeight - 8;
                    }
        
                    // Horizontal Position
                    modalLeft = targetOffset.left;
                    if (modalLeft + modalWidth >= windowWidth - 8) {
                        modalLeft = targetOffset.left + targetWidth - modalWidth - 8;
                    }
                    if (modalLeft < 8) {
                        modalLeft = 8;
                    }
                    if (modalPosition === 'top') {
                        modal.addClass('popover-on-top');
                    }
                    if (modalPosition === 'bottom') {
                        modal.addClass('popover-on-bottom');
                    }
                    if (target.hasClass('floating-button-to-popover') && !modal.hasClass('modal-in')) {
                        modal.addClass('popover-floating-button');
                        var diffX = (modalLeft + modalWidth / 2) - (targetOffset.left + targetWidth / 2),
                            diffY = (modalTop + modalHeight / 2) - (targetOffset.top + targetHeight / 2);
                        target
                            .addClass('floating-button-to-popover-in')
                            .transform('translate3d(' + diffX + 'px, ' + diffY + 'px,0)')
                            .transitionEnd(function (e) {
                                if (!target.hasClass('floating-button-to-popover-in')) return;
                                target
                                    .addClass('floating-button-to-popover-scale')
                                    .transform('translate3d(' + diffX + 'px, ' + diffY + 'px,0) scale(' + (modalWidth/targetWidth) + ', ' + (modalHeight/targetHeight) + ')');
                            });
        
                        modal.once('close', function () {
                            target
                                .removeClass('floating-button-to-popover-in floating-button-to-popover-scale')
                                .addClass('floating-button-to-popover-out')
                                .transform('')
                                .transitionEnd(function (e) {
                                    target.removeClass('floating-button-to-popover-out');
                                });
                        });
                        modal.once('closed', function () {
                            modal.removeClass('popover-floating-button');
                        });
                    }
        
                }
                else {
                    if ((modalHeight + modalAngleSize) < targetOffset.top) {
                        // On top
                        modalTop = targetOffset.top - modalHeight - modalAngleSize;
                    }
                    else if ((modalHeight + modalAngleSize) < windowHeight - targetOffset.top - targetHeight) {
                        // On bottom
                        modalPosition = 'bottom';
                        modalTop = targetOffset.top + targetHeight + modalAngleSize;
                    }
                    else {
                        // On middle
                        modalPosition = 'middle';
                        modalTop = targetHeight / 2 + targetOffset.top - modalHeight / 2;
                        diff = modalTop;
                        if (modalTop <= 0) {
                            modalTop = 5;
                        }
                        else if (modalTop + modalHeight >= windowHeight) {
                            modalTop = windowHeight - modalHeight - 5;
                        }
                        diff = diff - modalTop;
                    }
        
                    // Horizontal Position
                    if (modalPosition === 'top' || modalPosition === 'bottom') {
                        modalLeft = targetWidth / 2 + targetOffset.left - modalWidth / 2;
                        diff = modalLeft;
                        if (modalLeft < 5) modalLeft = 5;
                        if (modalLeft + modalWidth > windowWidth) modalLeft = windowWidth - modalWidth - 5;
                        if (modalPosition === 'top') {
                            modalAngle.addClass('on-bottom');
                        }
                        if (modalPosition === 'bottom') {
                            modalAngle.addClass('on-top');
                        }
                        diff = diff - modalLeft;
                        modalAngleLeft = (modalWidth / 2 - modalAngleSize + diff);
                        modalAngleLeft = Math.max(Math.min(modalAngleLeft, modalWidth - modalAngleSize * 2 - 13), 13);
                        modalAngle.css({left: modalAngleLeft + 'px'});
        
                    }
                    else if (modalPosition === 'middle') {
                        modalLeft = targetOffset.left - modalWidth - modalAngleSize;
                        modalAngle.addClass('on-right');
                        if (modalLeft < 5 || (modalLeft + modalWidth > windowWidth)) {
                            if (modalLeft < 5) modalLeft = targetOffset.left + targetWidth + modalAngleSize;
                            if (modalLeft + modalWidth > windowWidth) modalLeft = windowWidth - modalWidth - 5;
                            modalAngle.removeClass('on-right').addClass('on-left');
                        }
                        modalAngleTop = (modalHeight / 2 - modalAngleSize + diff);
                        modalAngleTop = Math.max(Math.min(modalAngleTop, modalHeight - modalAngleSize * 2 - 13), 13);
                        modalAngle.css({top: modalAngleTop + 'px'});
                    }
                }
        
        
                // Apply Styles
                modal.css({top: modalTop + 'px', left: modalLeft + 'px'});
            }
        
            sizePopover();
        
            $(window).on('resize', sizePopover);
        
            modal.on('close', function () {
                $(window).off('resize', sizePopover);
            });
        
            app.openModal(modal);
            return modal[0];
        };
        app.popup = function (modal, removeOnClose) {
            if (typeof removeOnClose === 'undefined') removeOnClose = true;
            if (typeof modal === 'string' && modal.indexOf('<') >= 0) {
                var _modal = document.createElement('div');
                _modal.innerHTML = modal.trim();
                if (_modal.childNodes.length > 0) {
                    modal = _modal.childNodes[0];
                    if (removeOnClose) modal.classList.add('remove-on-close');
                    $('body').append(modal);
                }
                else return false; //nothing found
            }
            modal = $(modal);
            if (modal.length === 0) return false;
            if (modal.parents('body').length === 0) {
                if (removeOnClose) modal.addClass('remove-on-close');
                $('body').append(modal[0]);
            }
            modal.show();
        
            app.openModal(modal);
            return modal[0];
        };
        app.pickerModal = function (modal, removeOnClose) {
            if (typeof removeOnClose === 'undefined') removeOnClose = true;
            if (typeof modal === 'string' && modal.indexOf('<') >= 0) {
                modal = $(modal);
                if (modal.length > 0) {
                    if (removeOnClose) modal.addClass('remove-on-close');
                    $('body').append(modal[0]);
                }
                else return false; //nothing found
            }
            modal = $(modal);
            if (modal.length === 0) return false;
            if (modal.parents('body').length === 0) {
                if (removeOnClose) modal.addClass('remove-on-close');
                $('body').append(modal[0]);
            }
            if ($('.picker-modal.modal-in:not(.modal-out)').length > 0 && !modal.hasClass('modal-in')) {
                app.closeModal('.picker-modal.modal-in:not(.modal-out)');
            }
            modal.show();
            app.openModal(modal);
            return modal[0];
        };
        app.loginScreen = function (modal) {
            if (!modal) modal = '.login-screen';
            modal = $(modal);
            if (modal.length === 0) return false;
            if ($('.login-screen.modal-in:not(.modal-out)').length > 0 && !modal.hasClass('modal-in')) {
                app.closeModal('.login-screen.modal-in:not(.modal-out)');
            }
            modal.show();
            
            app.openModal(modal);
            return modal[0];
        };
        app.openModal = function (modal) {
            modal = $(modal);
            var isModal = modal.hasClass('modal');
            if ($('.modal.modal-in:not(.modal-out)').length && app.params.modalStack && isModal) {
                app.modalStack.push(function () {
                    app.openModal(modal);
                });
                return;
            }
            // do nothing if this modal already shown
            if (true === modal.data('f7-modal-shown')) {
                return;
            }
            modal.data('f7-modal-shown', true);
            modal.once('close', function() {
               modal.removeData('f7-modal-shown');
            });
            var isPopover = modal.hasClass('popover');
            var isPopup = modal.hasClass('popup');
            var isLoginScreen = modal.hasClass('login-screen');
            var isPickerModal = modal.hasClass('picker-modal');
            if (isModal) {
                modal.show();
                modal.css({
                    marginTop: - Math.round(modal.outerHeight() / 2) + 'px'
                });
            }
        
            var overlay;
            if (!isLoginScreen && !isPickerModal) {
                if ($('.modal-overlay').length === 0 && !isPopup) {
                    $('body').append('<div class="modal-overlay"></div>');
                }
                if ($('.popup-overlay').length === 0 && isPopup) {
                    $('body').append('<div class="popup-overlay"></div>');
                }
                overlay = isPopup ? $('.popup-overlay') : $('.modal-overlay');
            }
            if (app.params.material && isPickerModal) {
                if (modal.hasClass('picker-calendar')) {
                    if ($('.picker-modal-overlay').length === 0 && !isPopup) {
                        $('body').append('<div class="picker-modal-overlay"></div>');
                    }
                    overlay = $('.picker-modal-overlay');
                }
            }
        
            //Make sure that styles are applied, trigger relayout;
            var clientLeft = modal[0].clientLeft;
        
            // Trugger open event
            modal.trigger('open');
        
            // Picker modal body class
            if (isPickerModal) {
                $('body').addClass('with-picker-modal');
            }
        
            // Init Pages and Navbars in modal
            if (modal.find('.' + app.params.viewClass).length > 0) {
                modal.find('.page').each(function () {
                    app.initPageWithCallback(this);
                });
                modal.find('.navbar').each(function () {
                    app.initNavbarWithCallback(this); 
                });
            }
        
            // Classes for transition in
            if (!isLoginScreen && !isPickerModal) overlay.addClass('modal-overlay-visible');
            if (app.params.material && isPickerModal && overlay) overlay.addClass('modal-overlay-visible');
            modal.removeClass('modal-out').addClass('modal-in').transitionEnd(function (e) {
                if (modal.hasClass('modal-out')) modal.trigger('closed');
                else modal.trigger('opened');
            });
            return true;
        };
        app.closeModal = function (modal) {
            modal = $(modal || '.modal-in');
            if (typeof modal !== 'undefined' && modal.length === 0) {
                return;
            }
            var isModal = modal.hasClass('modal');
            var isPopover = modal.hasClass('popover');
            var isPopup = modal.hasClass('popup');
            var isLoginScreen = modal.hasClass('login-screen');
            var isPickerModal = modal.hasClass('picker-modal');
        
            var removeOnClose = modal.hasClass('remove-on-close');
        
            var overlay;
            
            if (isPopup) overlay = $('.popup-overlay');
            else {
                if (isPickerModal && app.params.material) overlay = $('.picker-modal-overlay');
                else if (!isPickerModal) overlay = $('.modal-overlay');
            }
        
            if (isPopup){
                if (modal.length === $('.popup.modal-in').length) {
                    overlay.removeClass('modal-overlay-visible');
                }
            }
            else if (overlay && overlay.length > 0) {
                overlay.removeClass('modal-overlay-visible');
            }
        
            modal.trigger('close');
        
            // Picker modal body class
            if (isPickerModal) {
                $('body').removeClass('with-picker-modal');
                $('body').addClass('picker-modal-closing');
            }
        
            if (!(isPopover && !app.params.material)) {
                modal.removeClass('modal-in').addClass('modal-out').transitionEnd(function (e) {
                    if (modal.hasClass('modal-out')) modal.trigger('closed');
                    else {
                        modal.trigger('opened');
                        if (isPopover) return;
                    }
        
                    if (isPickerModal) {
                        $('body').removeClass('picker-modal-closing');
                    }
                    if (isPopup || isLoginScreen || isPickerModal || isPopover) {
                        modal.removeClass('modal-out').hide();
                        if (removeOnClose && modal.length > 0) {
                            modal.remove();
                        }
                    }
                    else {
                        modal.remove();
                    }
                });
                if (isModal && app.params.modalStack) {
                    app.modalStackClearQueue();
                }
            }
            else {
                modal.removeClass('modal-in modal-out').trigger('closed').hide();
                if (removeOnClose) {
                    modal.remove();
                }
            }
            return true;
        };
        

        /*===============================================================================
        ************   Progress Bar   ************
        ===============================================================================*/
        app.setProgressbar = function (container, progress, speed) {
            container = $(container || 'body');
            if (container.length === 0) return;
            if (progress) progress = Math.min(Math.max(progress, 0), 100);
            var progressbar;
            if (container.hasClass('progressbar')) progressbar = container;
            else {
                progressbar = container.children('.progressbar');
            }
            if (progressbar.length === 0 || progressbar.hasClass('progressbar-infinite')) return;
            var clientLeft = progressbar[0].clientLeft;
            progressbar.children('span').transform('translate3d(' + (-100 + progress) + '%,0,0)');
            if (typeof speed !== 'undefined') {
                progressbar.children('span').transition(speed);
            }
            else {
                progressbar.children('span').transition('');
            }
            return progressbar[0];
        };
        app.showProgressbar = function (container, progress, color) {
            if (typeof container === 'number') {
                container = 'body';
                progress = arguments[0];
                color = arguments[1];
            }
            if (progress && typeof progress === 'string' && parseFloat(progress) !== progress * 1) {
                color = progress;
                progress = undefined;
            }
            container = $(container || 'body');
            if (container.length === 0) return;
            var progressbar;
            if (container.hasClass('progressbar')) progressbar = container;
            else {
                progressbar = container.children('.progressbar:not(.progressbar-out), .progressbar-infinite:not(.progressbar-out)');
                if (progressbar.length === 0) {
                    // Create one
                    if (typeof progress !== 'undefined') {
                        // Determined
                        progressbar = $('<span class="progressbar progressbar-in' + (color ? ' color-' + color : '') + '"><span></span></span>');
                    }
                    else {
                        // Infinite
                        progressbar = $('<span class="progressbar-infinite progressbar-in' + (color ? ' color-' + color : '') + '"></span>');
                    }
                    container.append(progressbar);
                }
            }
            if (progress) app.setProgressbar(container, progress);
            return progressbar[0];
        };
        app.hideProgressbar = function (container) {
            container = $(container || 'body');
            if (container.length === 0) return;
            var progressbar;
            if (container.hasClass('progressbar')) progressbar = container;
            else {
                progressbar = container.children('.progressbar, .progressbar-infinite');
            }
            if (progressbar.length === 0 || !progressbar.hasClass('progressbar-in') || progressbar.hasClass('progressbar-out')) return;
            progressbar.removeClass('progressbar-in').addClass('progressbar-out').animationEnd(function () {
                progressbar.remove();
                progressbar = null;
            });
            return;
        };
        app.initPageProgressbar = function (pageContainer) {
            pageContainer = $(pageContainer);
            pageContainer.find('.progressbar').each(function () {
                var p = $(this);
                if (p.children('span').length === 0) p.append('<span></span>');
                if (p.attr('data-progress')) app.setProgressbar(p, p.attr('data-progress'));
            });
        };

        /*======================================================
        ************   Panels   ************
        ======================================================*/
        app.allowPanelOpen = true;
        app.openPanel = function (panelPosition) {
            if (!app.allowPanelOpen) return false;
            var panel = $('.panel-' + panelPosition);
            if (panel.length === 0 || panel.hasClass('active')) return false;
            app.closePanel(); // Close if some panel is opened
            app.allowPanelOpen = false;
            var effect = panel.hasClass('panel-reveal') ? 'reveal' : 'cover';
            panel.css({display: 'block'}).addClass('active');
            panel.trigger('open');
            if (app.params.material) {
                $('.panel-overlay').show();
            }
            if (panel.find('.' + app.params.viewClass).length > 0) {
                if (app.sizeNavbars) app.sizeNavbars(panel.find('.' + app.params.viewClass)[0]);
            }
        
            // Trigger reLayout
            var clientLeft = panel[0].clientLeft;
            
            // Transition End;
            var transitionEndTarget = effect === 'reveal' ? $('.' + app.params.viewsClass) : panel;
            var openedTriggered = false;
            
            function panelTransitionEnd() {
                transitionEndTarget.transitionEnd(function (e) {
                    if ($(e.target).is(transitionEndTarget)) {
                        if (panel.hasClass('active')) {
                            panel.trigger('opened');
                        }
                        else {
                            panel.trigger('closed');
                        }
                        if (app.params.material) $('.panel-overlay').css({display: ''});
                        app.allowPanelOpen = true;
                    }
                    else panelTransitionEnd();
                });
            }
            panelTransitionEnd();
        
            $('body').addClass('with-panel-' + panelPosition + '-' + effect);
            return true;
        };
        app.closePanel = function () {
            var activePanel = $('.panel.active');
            if (activePanel.length === 0) return false;
            var effect = activePanel.hasClass('panel-reveal') ? 'reveal' : 'cover';
            var panelPosition = activePanel.hasClass('panel-left') ? 'left' : 'right';
            activePanel.removeClass('active');
            var transitionEndTarget = effect === 'reveal' ? $('.' + app.params.viewsClass) : activePanel;
            activePanel.trigger('close');
            app.allowPanelOpen = false;
        
            transitionEndTarget.transitionEnd(function () {
                if (activePanel.hasClass('active')) return;
                activePanel.css({display: ''});
                activePanel.trigger('closed');
                $('body').removeClass('panel-closing');
                app.allowPanelOpen = true;
            });
        
            $('body').addClass('panel-closing').removeClass('with-panel-' + panelPosition + '-' + effect);
        };
        /*======================================================
        ************   Swipe panels   ************
        ======================================================*/
        app.initSwipePanels = function () {
            var panel, side;
            if (app.params.swipePanel) {
                panel = $('.panel.panel-' + app.params.swipePanel);
                side = app.params.swipePanel;
                if (panel.length === 0) return;
            }
            else {
                if (app.params.swipePanelOnlyClose) {
                    if ($('.panel').length === 0) return;
                }
                else return;
            }
            
            var panelOverlay = $('.panel-overlay');
            var isTouched, isMoved, isScrolling, touchesStart = {}, touchStartTime, touchesDiff, translate, overlayOpacity, opened, panelWidth, effect, direction;
            var views = $('.' + app.params.viewsClass);
        
            function handleTouchStart(e) {
                if (!app.allowPanelOpen || (!app.params.swipePanel && !app.params.swipePanelOnlyClose) || isTouched) return;
                if ($('.modal-in, .photo-browser-in').length > 0) return;
                if (!(app.params.swipePanelCloseOpposite || app.params.swipePanelOnlyClose)) {
                    if ($('.panel.active').length > 0 && !panel.hasClass('active')) return;
                }
                touchesStart.x = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
                touchesStart.y = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                if (app.params.swipePanelCloseOpposite || app.params.swipePanelOnlyClose) {
                    if ($('.panel.active').length > 0) {
                        side = $('.panel.active').hasClass('panel-left') ? 'left' : 'right';
                    }
                    else {
                        if (app.params.swipePanelOnlyClose) return;
                        side = app.params.swipePanel;
                    }
                    if (!side) return;
                }
                panel = $('.panel.panel-' + side);
                opened = panel.hasClass('active');
                if (app.params.swipePanelActiveArea && !opened) {
                    if (side === 'left') {
                        if (touchesStart.x > app.params.swipePanelActiveArea) return;
                    }
                    if (side === 'right') {
                        if (touchesStart.x < window.innerWidth - app.params.swipePanelActiveArea) return;
                    }
                }
                isMoved = false;
                isTouched = true;
                isScrolling = undefined;
                
                touchStartTime = (new Date()).getTime();
                direction = undefined;
            }
            function handleTouchMove(e) {
                if (!isTouched) return;
                if (e.f7PreventPanelSwipe) return;
                var pageX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                var pageY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                if (typeof isScrolling === 'undefined') {
                    isScrolling = !!(isScrolling || Math.abs(pageY - touchesStart.y) > Math.abs(pageX - touchesStart.x));
                }
                if (isScrolling) {
                    isTouched = false;
                    return;
                }
                if (!direction) {
                    if (pageX > touchesStart.x) {
                        direction = 'to-right';
                    }
                    else {
                        direction = 'to-left';
                    }
        
                    if (
                        side === 'left' &&
                        (
                            direction === 'to-left' && !panel.hasClass('active')
                        ) ||
                        side === 'right' &&
                        (
                            direction === 'to-right' && !panel.hasClass('active')
                        )
                    )
                    {
                        isTouched = false;
                        return;
                    }
                }
        
                if (app.params.swipePanelNoFollow) {
                    var timeDiff = (new Date()).getTime() - touchStartTime;
                    if (timeDiff < 300) {
                        if (direction === 'to-left') {
                            if (side === 'right') app.openPanel(side);
                            if (side === 'left' && panel.hasClass('active')) app.closePanel();
                        }
                        if (direction === 'to-right') {
                            if (side === 'left') app.openPanel(side);
                            if (side === 'right' && panel.hasClass('active')) app.closePanel();
                        }
                    }
                    isTouched = false;
                    isMoved = false;
                    return;
                }
        
                if (!isMoved) {
                    effect = panel.hasClass('panel-cover') ? 'cover' : 'reveal';
                    if (!opened) {
                        panel.show();
                        panelOverlay.show();
                    }
                    panelWidth = panel[0].offsetWidth;
                    panel.transition(0);
                    if (panel.find('.' + app.params.viewClass).length > 0) {
                        if (app.sizeNavbars) app.sizeNavbars(panel.find('.' + app.params.viewClass)[0]);
                    }
                }
        
                isMoved = true;
        
                e.preventDefault();
                var threshold = opened ? 0 : -app.params.swipePanelThreshold;
                if (side === 'right') threshold = -threshold;
                
                touchesDiff = pageX - touchesStart.x + threshold;
        
                if (side === 'right') {
                    translate = touchesDiff  - (opened ? panelWidth : 0);
                    if (translate > 0) translate = 0;
                    if (translate < -panelWidth) {
                        translate = -panelWidth;
                    }
                }
                else {
                    translate = touchesDiff  + (opened ? panelWidth : 0);
                    if (translate < 0) translate = 0;
                    if (translate > panelWidth) {
                        translate = panelWidth;
                    }
                }
                if (effect === 'reveal') {
                    views.transform('translate3d(' + translate + 'px,0,0)').transition(0);
                    panelOverlay.transform('translate3d(' + translate + 'px,0,0)').transition(0);
                    
                    app.pluginHook('swipePanelSetTransform', views[0], panel[0], Math.abs(translate / panelWidth));
                }
                else {
                    panel.transform('translate3d(' + translate + 'px,0,0)').transition(0);
                    if (app.params.material) {
                        panelOverlay.transition(0);
                        overlayOpacity = Math.abs(translate/panelWidth);
                        panelOverlay.css({opacity: overlayOpacity});
                    }
                    app.pluginHook('swipePanelSetTransform', views[0], panel[0], Math.abs(translate / panelWidth));
                }
            }
            function handleTouchEnd(e) {
                if (!isTouched || !isMoved) {
                    isTouched = false;
                    isMoved = false;
                    return;
                }
                isTouched = false;
                isMoved = false;
                var timeDiff = (new Date()).getTime() - touchStartTime;
                var action;
                var edge = (translate === 0 || Math.abs(translate) === panelWidth);
        
                if (!opened) {
                    if (translate === 0) {
                        action = 'reset';
                    }
                    else if (
                        timeDiff < 300 && Math.abs(translate) > 0 ||
                        timeDiff >= 300 && (Math.abs(translate) >= panelWidth / 2)
                    ) {
                        action = 'swap';
                    }
                    else {
                        action = 'reset';
                    }
                }
                else {
                    if (translate === -panelWidth) {
                        action = 'reset';
                    }
                    else if (
                        timeDiff < 300 && Math.abs(translate) >= 0 ||
                        timeDiff >= 300 && (Math.abs(translate) <= panelWidth / 2)
                    ) {
                        if (side === 'left' && translate === panelWidth) action = 'reset';
                        else action = 'swap';
                    }
                    else {
                        action = 'reset';
                    }
                }
                if (action === 'swap') {
                    app.allowPanelOpen = true;
                    if (opened) {
                        app.closePanel();
                        if (edge) {
                            panel.css({display: ''});
                            $('body').removeClass('panel-closing');
                        }
                    }
                    else {
                        app.openPanel(side);
                    }
                    if (edge) app.allowPanelOpen = true;
                }
                if (action === 'reset') {
                    if (opened) {
                        app.allowPanelOpen = true;
                        app.openPanel(side);
                    }
                    else {
                        app.closePanel();
                        if (edge) {
                            app.allowPanelOpen = true;
                            panel.css({display: ''});
                        }
                        else {
                            var target = effect === 'reveal' ? views : panel;
                            panel.trigger('close');
                            $('body').addClass('panel-closing');
                            target.transitionEnd(function () {
                                panel.trigger('closed');
                                panel.css({display: ''});
                                $('body').removeClass('panel-closing');
                                app.allowPanelOpen = true;
                            });
                        }
                    }
                }
                if (effect === 'reveal') {
                    views.transition('');
                    views.transform('');
                }
                panel.transition('').transform('');
                panelOverlay.css({display: ''}).transform('').transition('').css('opacity', '');
            }
            $(document).on(app.touchEvents.start, handleTouchStart);
            $(document).on(app.touchEvents.move, handleTouchMove);
            $(document).on(app.touchEvents.end, handleTouchEnd);
        };
        

        /*======================================================
        ************   Image Lazy Loading   ************
        ************   Based on solution by Marc Godard, https://github.com/MarcGodard   ************
        ======================================================*/
        app.initImagesLazyLoad = function (pageContainer) {
            pageContainer = $(pageContainer);
        
            // Lazy images
            var lazyLoadImages;
            if (pageContainer.hasClass('lazy')) {
                lazyLoadImages = pageContainer;
                pageContainer = lazyLoadImages.parents('.page');
            }
            else {
                lazyLoadImages = pageContainer.find('.lazy');
            }
            if (lazyLoadImages.length === 0) return;
        
            // Scrollable page content
            var pageContent;
            if (pageContainer.hasClass('page-content'))  {
                pageContent = pageContainer;
                pageContainer = pageContainer.parents('.page');
            }
            else  {
                pageContent = pageContainer.find('.page-content');
            }
            if (pageContent.length === 0) return;
        
            // Placeholder
            var placeholderSrc = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAA1BMVEXCwsK592mkAAAACklEQVQI12NgAAAAAgAB4iG8MwAAAABJRU5ErkJggg==';
            if (typeof app.params.imagesLazyLoadPlaceholder === 'string') {
                placeholderSrc = app.params.imagesLazyLoadPlaceholder;
            }
            if (app.params.imagesLazyLoadPlaceholder !== false) lazyLoadImages.each(function(){
                if ($(this).attr('data-src')) $(this).attr('src', placeholderSrc);
            });
        
            // load image
            var imagesSequence = [];
            var imageIsLoading = false;
            function loadImage(el) {
                el = $(el);
        
                var bg = el.attr('data-background');
                var src = bg ? bg : el.attr('data-src');
                if (!src) return;
        
                function onLoad() {
                    el.removeClass('lazy').addClass('lazy-loaded');
                    if (bg) {
                        el.css('background-image', 'url(' + src + ')');
                    }
                    else {
                        el.attr('src', src);
                    }
        
                    if (app.params.imagesLazyLoadSequential) {
                        imageIsLoading = false;
                        if (imagesSequence.length > 0) {
                            loadImage(imagesSequence.shift());
                        }
                    }
                }
        
                if (app.params.imagesLazyLoadSequential) {
                    if (imageIsLoading) {
                        if (imagesSequence.indexOf(el[0]) < 0) imagesSequence.push(el[0]);
                        return;
                    }
                }
        
                // Loading flag
                imageIsLoading = true;
                
                var image = new Image();
                image.onload = onLoad;
                image.onerror = onLoad;
                image.src =src;
            }
            function lazyHandler() {
                lazyLoadImages = pageContainer.find('.lazy');
                lazyLoadImages.each(function(index, el) {
                    el = $(el);
                    if (el.parents('.tab:not(.active)').length > 0) {
                        return;
                    }
                    if (isElementInViewport(el[0])) {
                        loadImage(el);
                    }
                });
            }
        
            function isElementInViewport (el) {
                var rect = el.getBoundingClientRect();
                var threshold = app.params.imagesLazyLoadThreshold || 0;
                return (
                    rect.top >= (0 - threshold) &&
                    rect.left >= (0 - threshold) &&
                    rect.top <= (window.innerHeight + threshold) &&
                    rect.left <= (window.innerWidth + threshold)
                );
            }
        
            function attachEvents(destroy) {
                var method = destroy ? 'off' : 'on';
                lazyLoadImages[method]('lazy', lazyHandler);
                lazyLoadImages.parents('.tab')[method]('show', lazyHandler);
                pageContainer[method]('lazy', lazyHandler);
                pageContent[method]('lazy', lazyHandler);
                pageContent[method]('scroll', lazyHandler);
                $(window)[method]('resize', lazyHandler);
            }
            function detachEvents() {
                attachEvents(true);
            }
        
            // Store detach function
            pageContainer[0].f7DestroyImagesLazyLoad = detachEvents;
        
            // Attach events
            attachEvents();
        
            // Destroy on page remove
            if (pageContainer.hasClass('page')) {
                pageContainer.once('pageBeforeRemove', detachEvents);
            }
        
            // Run loader on page load/init
            lazyHandler();
        
            // Run after page animation
            pageContainer.once('pageAfterAnimation', lazyHandler);
        };
        app.destroyImagesLazyLoad = function (pageContainer) {
            pageContainer = $(pageContainer);
            if (pageContainer.length > 0 && pageContainer[0].f7DestroyImagesLazyLoad) {
                pageContainer[0].f7DestroyImagesLazyLoad();
            }
        };
        app.reinitImagesLazyLoad = function (pageContainer) {
            pageContainer = $(pageContainer);
            if (pageContainer.length > 0) {
                pageContainer.trigger('lazy');
            }
        };

        /*======================================================
        ************   Material Preloader   ************
        ======================================================*/
        app.initPageMaterialPreloader = function (pageContainer) {
            $(pageContainer).find('.preloader').each(function () {
                if ($(this).children().length === 0) {
                    $(this).html(app.params.materialPreloaderHtml);
                }
            });
        };

        /*======================================================
        ************   Messages   ************
        ======================================================*/
        var Messages = function (container, params) {
            var defaults = {
                autoLayout: true,
                newMessagesFirst: false,
                messageTemplate: 
                    '{{#if day}}' +
                    '<div class="messages-date">{{day}} {{#if time}}, <span>{{time}}</span>{{/if}}</div>' +
                    '{{/if}}' +
                    '<div class="message message-{{type}} {{#if hasImage}}message-pic{{/if}} {{#if avatar}}message-with-avatar{{/if}} {{#if position}}message-appear-from-{{position}}{{/if}}">' +
                        '{{#if name}}<div class="message-name">{{name}}</div>{{/if}}' +
                        '<div class="message-text">{{text}}{{#if date}}<div class="message-date">{{date}}</div>{{/if}}</div>' +
                        '{{#if avatar}}<div class="message-avatar" style="background-image:url({{avatar}})"></div>{{/if}}' +
                        '{{#if label}}<div class="message-label">{{label}}</div>{{/if}}' +
                    '</div>'
            };
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined' || params[def] === null) {
                    params[def] = defaults[def];
                }
            }
        
            // Instance
            var m = this;
        
            // Params
            m.params = params;
        
            // Container
            m.container = $(container);
            if (m.container.length === 0) return;
        
            // Autolayout
            if (m.params.autoLayout) m.container.addClass('messages-auto-layout');
        
            // New messages first
            if (m.params.newMessagesFirst) m.container.addClass('messages-new-first');
        
            // Is In Page
            m.pageContainer = m.container.parents('.page').eq(0);
            m.pageContent = m.pageContainer.find('.page-content');
        
            // Compiled template
            m.template = Template7.compile(m.params.messageTemplate);
        
            // Auto Layout
            m.layout = function () {
                if (!m.container.hasClass('messages-auto-layout')) m.container.addClass('messages-auto-layout');
                m.container.find('.message').each(function () {
                    var message = $(this);
                    if (message.find('.message-text img').length > 0) message.addClass('message-pic');
                    if (message.find('.message-avatar').length > 0) message.addClass('message-with-avatar');
                });
                m.container.find('.message').each(function () {
                    var message = $(this);
                    var isSent = message.hasClass('message-sent');
                    var next = message.next('.message-' + (isSent ? 'sent' : 'received'));
                    var prev = message.prev('.message-' + (isSent ? 'sent' : 'received'));
                    if (next.length === 0) {
                        message.addClass('message-last message-with-tail');
                    }
                    else message.removeClass('message-last message-with-tail');
        
                    if (prev.length === 0) {
                        message.addClass('message-first');
                    }
                    else message.removeClass('message-first');
        
                    if (prev.length > 0 && prev.find('.message-name').length > 0 && message.find('.message-name').length > 0) {
                        if (prev.find('.message-name').text() !== message.find('.message-name').text()) {
                            prev.addClass('message-last message-with-tail');
                            message.addClass('message-first');
                        }
                    }
                });
                
            };
        
            // Add Message
            m.appendMessage = function (props, animate) {
                return m.addMessage(props, 'append', animate);
            };
            m.prependMessage = function (props, animate) {
                return m.addMessage(props, 'prepend', animate);
            };
            m.addMessage = function (props, method, animate) {
                return m.addMessages([props], method, animate);
            };
            m.addMessages = function (newMessages, method, animate) {
                if (typeof animate === 'undefined') {
                    animate = true;
                }
                if (typeof method === 'undefined') {
                    method = m.params.newMessagesFirst ? 'prepend' : 'append';
                }
                var newMessagesHTML = '', i;
                for (i = 0; i < newMessages.length; i++) {
                    var props = newMessages[i] || {};
                    props.type = props.type || 'sent';
                    if (!props.text) continue;
                    props.hasImage = props.text.indexOf('<img') >= 0;
                    if (animate) props.position = method === 'append' ? 'bottom' : 'top';
        
                    newMessagesHTML += m.template(props);
                }
                var heightBefore, scrollBefore;
                if (method === 'prepend') {
                    heightBefore = m.pageContent[0].scrollHeight;
                    scrollBefore = m.pageContent[0].scrollTop;
                }
                m.container[method](newMessagesHTML);
                if (m.params.autoLayout) m.layout();
                if (method === 'prepend') {
                    m.pageContent[0].scrollTop = scrollBefore + (m.pageContent[0].scrollHeight - heightBefore);
                }
                if ((method === 'append' && !m.params.newMessagesFirst) || (method === 'prepend' && m.params.newMessagesFirst)) {
                    m.scrollMessages(animate ? undefined : 0);
                }
                var messages = m.container.find('.message');
                if (newMessages.length === 1) {
                    return method === 'append' ? messages[messages.length - 1] : messages[0];
                }
                else {
                    var messagesToReturn = [];
                    if (method === 'append') {
                        for (i = messages.length - newMessages.length; i < messages.length; i++) {
                            messagesToReturn.push(messages[i]);
                        }
                    }
                    else {
                        for (i = 0; i < newMessages.length; i++) {
                            messagesToReturn.push(messages[i]);
                        }   
                    }
                    return messagesToReturn;
                }
                
            };
            m.removeMessage = function (message) {
                message = $(message);
                if (message.length === 0) {
                    return false;
                }
                else {
                    message.remove();
                    if (m.params.autoLayout) m.layout();
                    return true;
                }
            };
            m.removeMessages = function (messages) {
                m.removeMessage(messages);
            };
            m.clean = function () {
                m.container.html('');
            };
        
            // Scroll
            m.scrollMessages = function (duration, scrollTop) {
                if (typeof duration === 'undefined') duration = 400;
                var currentScroll = m.pageContent[0].scrollTop;
                var newScroll;
                if (typeof scrollTop !== 'undefined') newScroll = scrollTop;
                else {
                    newScroll = m.params.newMessagesFirst ? 0 : m.pageContent[0].scrollHeight - m.pageContent[0].offsetHeight;
                    if (newScroll === currentScroll) return;
                }
                m.pageContent.scrollTop(newScroll, duration);
            };
        
            // Init Destroy
            m.init = function () {
                if (m.params.messages) {
                    m.addMessages(m.params.messages, undefined, false);
                }
                else {
                    if (m.params.autoLayout) m.layout();    
                    m.scrollMessages(0);
                }
                
            };
            m.destroy = function () {
                m = null;
            };
        
            // Init
            m.init();
        
            m.container[0].f7Messages = m;
            return m;
        };
        app.messages = function (container, params) {
            return new Messages (container, params);
        };
        app.initPageMessages = function (pageContainer) {
            pageContainer = $(pageContainer);
            var messages = pageContainer.find('.messages');
            if (messages.length === 0) return;
            if (!messages.hasClass('messages-init')) {
                return;
            }
            var m = app.messages(messages, messages.dataset());
        
            // Destroy on page remove
            function pageBeforeRemove() {
                m.destroy();
                pageContainer.off('pageBeforeRemove', pageBeforeRemove);
            }
            if (pageContainer.hasClass('page')) {
                pageContainer.on('pageBeforeRemove', pageBeforeRemove);
            }
        };
        

        /*===============================================================================
        ************   Swipeout Actions (Swipe to delete)   ************
        ===============================================================================*/
        app.swipeoutOpenedEl = undefined;
        app.allowSwipeout = true;
        app.initSwipeout = function (swipeoutEl) {
            var isTouched, isMoved, isScrolling, touchesStart = {}, touchStartTime, touchesDiff, swipeOutEl, swipeOutContent, actionsRight, actionsLeft, actionsLeftWidth, actionsRightWidth, translate, opened, openedActions, buttonsLeft, buttonsRight, direction, overswipeLeftButton, overswipeRightButton, overswipeLeft, overswipeRight, noFoldLeft, noFoldRight;
            $(document).on(app.touchEvents.start, function (e) {
                if (app.swipeoutOpenedEl) {
                    var target = $(e.target);
                    if (!(
                        app.swipeoutOpenedEl.is(target[0]) ||
                        target.parents('.swipeout').is(app.swipeoutOpenedEl) ||
                        target.hasClass('modal-in') ||
                        target.hasClass('modal-overlay') ||
                        target.hasClass('actions-modal') || 
                        target.parents('.actions-modal.modal-in, .modal.modal-in').length > 0
                        )) {
                        app.swipeoutClose(app.swipeoutOpenedEl);
                    }
                }
            });
        
            function handleTouchStart(e) {
                if (!app.allowSwipeout) return;
                isMoved = false;
                isTouched = true;
                isScrolling = undefined;
                touchesStart.x = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
                touchesStart.y = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                touchStartTime = (new Date()).getTime();
            }
            function handleTouchMove(e) {
                if (!isTouched) return;
                var pageX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                var pageY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                if (typeof isScrolling === 'undefined') {
                    isScrolling = !!(isScrolling || Math.abs(pageY - touchesStart.y) > Math.abs(pageX - touchesStart.x));
                }
                if (isScrolling) {
                    isTouched = false;
                    return;
                }
        
                if (!isMoved) {
                    if ($('.list-block.sortable-opened').length > 0) return;
                    /*jshint validthis:true */
                    swipeOutEl = $(this);
                    swipeOutContent = swipeOutEl.find('.swipeout-content');
                    actionsRight = swipeOutEl.find('.swipeout-actions-right');
                    actionsLeft = swipeOutEl.find('.swipeout-actions-left');
                    actionsLeftWidth = actionsRightWidth = buttonsLeft = buttonsRight = overswipeRightButton = overswipeLeftButton = null;
                    noFoldLeft = actionsLeft.hasClass('swipeout-actions-no-fold') || app.params.swipeoutActionsNoFold;
                    noFoldRight = actionsRight.hasClass('swipeout-actions-no-fold') || app.params.swipeoutActionsNoFold;
                    if (actionsLeft.length > 0) {
                        actionsLeftWidth = actionsLeft.outerWidth();
                        buttonsLeft = actionsLeft.children('a');
                        overswipeLeftButton = actionsLeft.find('.swipeout-overswipe');
                    }
                    if (actionsRight.length > 0) {
                        actionsRightWidth = actionsRight.outerWidth();
                        buttonsRight = actionsRight.children('a');
                        overswipeRightButton = actionsRight.find('.swipeout-overswipe');
                    }
                    opened = swipeOutEl.hasClass('swipeout-opened');
                    if (opened) {
                        openedActions = swipeOutEl.find('.swipeout-actions-left.swipeout-actions-opened').length > 0 ? 'left' : 'right';
                    }
                    swipeOutEl.removeClass('transitioning');
                    if (!app.params.swipeoutNoFollow) {
                        swipeOutEl.find('.swipeout-actions-opened').removeClass('swipeout-actions-opened');
                        swipeOutEl.removeClass('swipeout-opened');
                    }
                }
                isMoved = true;
                e.preventDefault();
                
                touchesDiff = pageX - touchesStart.x;
                translate = touchesDiff;
        
                if (opened) {
                    if (openedActions === 'right') translate = translate - actionsRightWidth;
                    else translate = translate + actionsLeftWidth;
                }
        
                if (translate > 0 && actionsLeft.length === 0 || translate < 0 && actionsRight.length === 0) {
                    if (!opened) {
                        isTouched = isMoved = false;
                        swipeOutContent.transform('');
                        if (buttonsRight && buttonsRight.length > 0) {
                            buttonsRight.transform('');
                        }
                        if (buttonsLeft && buttonsLeft.length > 0) {
                            buttonsLeft.transform('');
                        }
                        return;
                    }
                    translate = 0;
                }
        
                if (translate < 0) direction = 'to-left';
                else if (translate > 0) direction = 'to-right';
                else {
                    if (direction) direction = direction;
                    else direction = 'to-left';
                }
                
                var i, buttonOffset, progress;
                
                e.f7PreventPanelSwipe = true;
                if (app.params.swipeoutNoFollow) {
                    if (opened) {
                        if (openedActions === 'right' && touchesDiff > 0) {
                            app.swipeoutClose(swipeOutEl);
                        }
                        if (openedActions === 'left' && touchesDiff < 0) {
                            app.swipeoutClose(swipeOutEl);
                        }
                    }
                    else {
                        if (touchesDiff < 0 && actionsRight.length > 0) {
                            app.swipeoutOpen(swipeOutEl, 'right');
                        }
                        if (touchesDiff > 0 && actionsLeft.length > 0) {
                            app.swipeoutOpen(swipeOutEl, 'left');
                        }
                    }
                    isTouched = false;
                    isMoved = false;
                    return;
                }
                overswipeLeft = false;
                overswipeRight = false;
                var $button;
                if (actionsRight.length > 0) {
                    // Show right actions
                    progress = translate / actionsRightWidth;
                    if (translate < -actionsRightWidth) {
                        translate = -actionsRightWidth - Math.pow(-translate - actionsRightWidth, 0.8);
                        if (overswipeRightButton.length > 0) {
                            overswipeRight = true;
                        }
                    }
                    for (i = 0; i < buttonsRight.length; i++) {
                        if (typeof buttonsRight[i]._buttonOffset === 'undefined') {
                            buttonsRight[i]._buttonOffset = buttonsRight[i].offsetLeft;
                        }
                        buttonOffset = buttonsRight[i]._buttonOffset;
                        $button = $(buttonsRight[i]);
                        if (overswipeRightButton.length > 0 && $button.hasClass('swipeout-overswipe')) {
                            $button.css({left: (overswipeRight ? -buttonOffset : 0) + 'px'});
                            if (overswipeRight) {
                                $button.addClass('swipeout-overswipe-active');
                            }
                            else {
                                $button.removeClass('swipeout-overswipe-active');   
                            }
                        }
                        $button.transform('translate3d(' + (translate - buttonOffset * (1 + Math.max(progress, -1))) + 'px,0,0)');
                    }
                }
                if (actionsLeft.length > 0) {
                    // Show left actions
                    progress = translate / actionsLeftWidth;
                    if (translate > actionsLeftWidth) {
                        translate = actionsLeftWidth + Math.pow(translate - actionsLeftWidth, 0.8);
                        if (overswipeLeftButton.length > 0) {
                            overswipeLeft = true;
                        }
                    }
                    for (i = 0; i < buttonsLeft.length; i++) {
                        if (typeof buttonsLeft[i]._buttonOffset === 'undefined') {
                            buttonsLeft[i]._buttonOffset = actionsLeftWidth - buttonsLeft[i].offsetLeft - buttonsLeft[i].offsetWidth;
                        }
                        buttonOffset = buttonsLeft[i]._buttonOffset;
                        $button = $(buttonsLeft[i]);
                        if (overswipeLeftButton.length > 0 && $button.hasClass('swipeout-overswipe')) {
                            $button.css({left: (overswipeLeft ? buttonOffset : 0) + 'px'});
                            if (overswipeLeft) {
                                $button.addClass('swipeout-overswipe-active');
                            }
                            else {
                                $button.removeClass('swipeout-overswipe-active');   
                            }
                        }
                        if (buttonsLeft.length > 1) {
                            $button.css('z-index', buttonsLeft.length - i); 
                        }
                        $button.transform('translate3d(' + (translate + buttonOffset * (1 - Math.min(progress, 1))) + 'px,0,0)');
                    }
                }
                swipeOutContent.transform('translate3d(' + translate + 'px,0,0)');
            }
            function handleTouchEnd(e) {
                if (!isTouched || !isMoved) {
                    isTouched = false;
                    isMoved = false;
                    return;
                }
        
                isTouched = false;
                isMoved = false;
                var timeDiff = (new Date()).getTime() - touchStartTime;
                var action, actionsWidth, actions, buttons, i, noFold;
                
                noFold = direction === 'to-left' ? noFoldRight : noFoldLeft;
                actions = direction === 'to-left' ? actionsRight : actionsLeft;
                actionsWidth = direction === 'to-left' ? actionsRightWidth : actionsLeftWidth;
        
                if (
                    timeDiff < 300 && (touchesDiff < -10 && direction === 'to-left' || touchesDiff > 10 && direction === 'to-right') ||
                    timeDiff >= 300 && Math.abs(translate) > actionsWidth / 2
                ) {
                    action = 'open';
                }
                else {
                    action = 'close';
                }
                if (timeDiff < 300) {
                    if (Math.abs(translate) === 0) action = 'close';
                    if (Math.abs(translate) === actionsWidth) action = 'open';
                }
                
                if (action === 'open') {
                    app.swipeoutOpenedEl = swipeOutEl;
                    swipeOutEl.trigger('open');
                    swipeOutEl.addClass('swipeout-opened transitioning');
                    var newTranslate = direction === 'to-left' ? -actionsWidth : actionsWidth;
                    swipeOutContent.transform('translate3d(' + newTranslate + 'px,0,0)');
                    actions.addClass('swipeout-actions-opened');
                    buttons = direction === 'to-left' ? buttonsRight : buttonsLeft;
                    if (buttons) {
                        for (i = 0; i < buttons.length; i++) {
                            $(buttons[i]).transform('translate3d(' + newTranslate + 'px,0,0)');
                        }
                    }
                    if (overswipeRight) {
                        actionsRight.find('.swipeout-overswipe')[0].click();
                    }
                    if (overswipeLeft) {
                        actionsLeft.find('.swipeout-overswipe')[0].click();
                    }
                }
                else {
                    swipeOutEl.trigger('close');
                    app.swipeoutOpenedEl = undefined;
                    swipeOutEl.addClass('transitioning').removeClass('swipeout-opened');
                    swipeOutContent.transform('');
                    actions.removeClass('swipeout-actions-opened');
                }
                
                var buttonOffset;
                if (buttonsLeft && buttonsLeft.length > 0 && buttonsLeft !== buttons) {
                    for (i = 0; i < buttonsLeft.length; i++) {
                        buttonOffset = buttonsLeft[i]._buttonOffset;
                        if (typeof buttonOffset === 'undefined') {
                            buttonsLeft[i]._buttonOffset = actionsLeftWidth - buttonsLeft[i].offsetLeft - buttonsLeft[i].offsetWidth;
                        }
                        $(buttonsLeft[i]).transform('translate3d(' + (buttonOffset) + 'px,0,0)');
                    }
                }
                if (buttonsRight && buttonsRight.length > 0 && buttonsRight !== buttons) {
                    for (i = 0; i < buttonsRight.length; i++) {
                        buttonOffset = buttonsRight[i]._buttonOffset;
                        if (typeof buttonOffset === 'undefined') {
                            buttonsRight[i]._buttonOffset = buttonsRight[i].offsetLeft;
                        }
                        $(buttonsRight[i]).transform('translate3d(' + (-buttonOffset) + 'px,0,0)');
                    }
                }
                swipeOutContent.transitionEnd(function (e) {
                    if (opened && action === 'open' || closed && action === 'close') return;
                    swipeOutEl.trigger(action === 'open' ? 'opened' : 'closed');
                    if (opened && action === 'close') {
                        if (actionsRight.length > 0) {
                            buttonsRight.transform('');
                        }
                        if (actionsLeft.length > 0) {
                            buttonsLeft.transform('');
                        }
                    }
                });
            }
            if (swipeoutEl) {
                $(swipeoutEl).on(app.touchEvents.start, handleTouchStart);
                $(swipeoutEl).on(app.touchEvents.move, handleTouchMove);
                $(swipeoutEl).on(app.touchEvents.end, handleTouchEnd);
            }
            else {
                $(document).on(app.touchEvents.start, '.list-block li.swipeout', handleTouchStart);
                $(document).on(app.touchEvents.move, '.list-block li.swipeout', handleTouchMove);
                $(document).on(app.touchEvents.end, '.list-block li.swipeout', handleTouchEnd);
            }
                
        };
        app.swipeoutOpen = function (el, dir, callback) {
            el = $(el);
            if (arguments.length === 2) {
                if (typeof arguments[1] === 'function') {
                    callback = dir;
                }
            }
        
            if (el.length === 0) return;
            if (el.length > 1) el = $(el[0]);
            if (!el.hasClass('swipeout') || el.hasClass('swipeout-opened')) return;
            if (!dir) {
                if (el.find('.swipeout-actions-right').length > 0) dir = 'right';
                else dir = 'left';
            }
            var swipeOutActions = el.find('.swipeout-actions-' + dir);
            if (swipeOutActions.length === 0) return;
            var noFold = swipeOutActions.hasClass('swipeout-actions-no-fold') || app.params.swipeoutActionsNoFold;
            el.trigger('open').addClass('swipeout-opened').removeClass('transitioning');
            swipeOutActions.addClass('swipeout-actions-opened');
            var buttons = swipeOutActions.children('a');
            var swipeOutActionsWidth = swipeOutActions.outerWidth();
            var translate = dir === 'right' ? -swipeOutActionsWidth : swipeOutActionsWidth;
            var i;
            if (buttons.length > 1) {
                for (i = 0; i < buttons.length; i++) {
                    if (dir === 'right') {
                        $(buttons[i]).transform('translate3d(' + (- buttons[i].offsetLeft) + 'px,0,0)');
                    }
                    else {
                        $(buttons[i]).css('z-index', buttons.length - i).transform('translate3d(' + (swipeOutActionsWidth - buttons[i].offsetWidth - buttons[i].offsetLeft) + 'px,0,0)');
                    }
                }
                var clientLeft = buttons[1].clientLeft;
            }
            el.addClass('transitioning');
            for (i = 0; i < buttons.length; i++) {
                $(buttons[i]).transform('translate3d(' + (translate) + 'px,0,0)');
            }
            el.find('.swipeout-content').transform('translate3d(' + translate + 'px,0,0)').transitionEnd(function () {
                el.trigger('opened');
                if (callback) callback.call(el[0]);
            });
            app.swipeoutOpenedEl = el;
        };
        app.swipeoutClose = function (el, callback) {
            el = $(el);
            if (el.length === 0) return;
            if (!el.hasClass('swipeout-opened')) return;
            var dir = el.find('.swipeout-actions-opened').hasClass('swipeout-actions-right') ? 'right' : 'left';
            var swipeOutActions = el.find('.swipeout-actions-opened').removeClass('swipeout-actions-opened');
            var noFold = swipeOutActions.hasClass('swipeout-actions-no-fold') || app.params.swipeoutActionsNoFold;
            var buttons = swipeOutActions.children('a');
            var swipeOutActionsWidth = swipeOutActions.outerWidth();
            app.allowSwipeout = false;
            el.trigger('close');
            el.removeClass('swipeout-opened').addClass('transitioning');
        
            var closeTO;
            function onSwipeoutClose() {
                app.allowSwipeout = true;
                if (el.hasClass('swipeout-opened')) return;
                el.removeClass('transitioning');
                buttons.transform('');
                el.trigger('closed');
                if (callback) callback.call(el[0]);
                if (closeTO) clearTimeout(closeTO);
            }
            el.find('.swipeout-content').transform('').transitionEnd(onSwipeoutClose);
            closeTO = setTimeout(onSwipeoutClose, 500);
            
            for (var i = 0; i < buttons.length; i++) {
                if (dir === 'right') {
                    $(buttons[i]).transform('translate3d(' + (-buttons[i].offsetLeft) + 'px,0,0)');
                }
                else {
                    $(buttons[i]).transform('translate3d(' + (swipeOutActionsWidth - buttons[i].offsetWidth - buttons[i].offsetLeft) + 'px,0,0)');
                }
                $(buttons[i]).css({left:0 + 'px'}).removeClass('swipeout-overswipe-active');
            }
            if (app.swipeoutOpenedEl && app.swipeoutOpenedEl[0] === el[0]) app.swipeoutOpenedEl = undefined;
        };
        app.swipeoutDelete = function (el, callback) {
            el = $(el);
            if (el.length === 0) return;
            if (el.length > 1) el = $(el[0]);
            app.swipeoutOpenedEl = undefined;
            el.trigger('delete');
            el.css({height: el.outerHeight() + 'px'});
            var clientLeft = el[0].clientLeft;
            el.css({height: 0 + 'px'}).addClass('deleting transitioning').transitionEnd(function () {
                el.trigger('deleted');
                if (callback) callback.call(el[0]);
                if (el.parents('.virtual-list').length > 0) {
                    var virtualList = el.parents('.virtual-list')[0].f7VirtualList;
                    var virtualIndex = el[0].f7VirtualListIndex;
                    if (virtualList && typeof virtualIndex !== 'undefined') virtualList.deleteItem(virtualIndex);
                }
                else {
                    el.remove();
                }
            });
            var translate = '-100%';
            el.find('.swipeout-content').transform('translate3d(' + translate + ',0,0)');
        };
        

        /*===============================================================================
        ************   Sortable   ************
        ===============================================================================*/
        app.sortableToggle = function (sortableContainer) {
            sortableContainer = $(sortableContainer);
            if (sortableContainer.length === 0) sortableContainer = $('.list-block.sortable');
            sortableContainer.toggleClass('sortable-opened');
            if (sortableContainer.hasClass('sortable-opened')) {
                sortableContainer.trigger('open');
            }
            else {
                sortableContainer.trigger('close');
            }
            return sortableContainer;
        };
        app.sortableOpen = function (sortableContainer) {
            sortableContainer = $(sortableContainer);
            if (sortableContainer.length === 0) sortableContainer = $('.list-block.sortable');
            sortableContainer.addClass('sortable-opened');
            sortableContainer.trigger('open');
            return sortableContainer;
        };
        app.sortableClose = function (sortableContainer) {
            sortableContainer = $(sortableContainer);
            if (sortableContainer.length === 0) sortableContainer = $('.list-block.sortable');
            sortableContainer.removeClass('sortable-opened');
            sortableContainer.trigger('close');
            return sortableContainer;
        };
        app.initSortable = function () {
            var isTouched, isMoved, touchStartY, touchesDiff, sortingEl, sortingElHeight, sortingItems, minTop, maxTop, insertAfter, insertBefore, sortableContainer;
            
            function handleTouchStart(e) {
                isMoved = false;
                isTouched = true;
                touchStartY = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                /*jshint validthis:true */
                sortingEl = $(this).parent();
                sortingItems = sortingEl.parent().find('li');
                sortableContainer = sortingEl.parents('.sortable');
                e.preventDefault();
                app.allowPanelOpen = app.allowSwipeout = false;
            }
            function handleTouchMove(e) {
                if (!isTouched || !sortingEl) return;
                var pageX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                var pageY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                if (!isMoved) {
                    sortingEl.addClass('sorting');
                    sortableContainer.addClass('sortable-sorting');
                    minTop = sortingEl[0].offsetTop;
                    maxTop = sortingEl.parent().height() - sortingEl[0].offsetTop - sortingEl.height();
                    sortingElHeight = sortingEl[0].offsetHeight;
                }
                isMoved = true;
        
                e.preventDefault();
                e.f7PreventPanelSwipe = true;
                touchesDiff = pageY - touchStartY;
                var translate = touchesDiff;
                if (translate < -minTop) translate = -minTop;
                if (translate > maxTop) translate = maxTop;
                sortingEl.transform('translate3d(0,' + translate + 'px,0)');
        
                insertBefore = insertAfter = undefined;
        
                sortingItems.each(function () {
                    var currentEl = $(this);
                    if (currentEl[0] === sortingEl[0]) return;
                    var currentElOffset = currentEl[0].offsetTop;
                    var currentElHeight = currentEl.height();
                    var sortingElOffset = sortingEl[0].offsetTop + translate;
        
                    if ((sortingElOffset >= currentElOffset - currentElHeight / 2) && sortingEl.index() < currentEl.index()) {
                        currentEl.transform('translate3d(0, '+(-sortingElHeight)+'px,0)');
                        insertAfter = currentEl;
                        insertBefore = undefined;
                    }
                    else if ((sortingElOffset <= currentElOffset + currentElHeight / 2) && sortingEl.index() > currentEl.index()) {
                        currentEl.transform('translate3d(0, '+(sortingElHeight)+'px,0)');
                        insertAfter = undefined;
                        if (!insertBefore) insertBefore = currentEl;
                    }
                    else {
                        $(this).transform('translate3d(0, 0%,0)');
                    }
                });
            }
            function handleTouchEnd(e) {
                app.allowPanelOpen = app.allowSwipeout = true;
                if (!isTouched || !isMoved) {
                    isTouched = false;
                    isMoved = false;
                    return;
                }
                e.preventDefault();
                sortingItems.transform('');
                sortingEl.removeClass('sorting');
                sortableContainer.removeClass('sortable-sorting');
                var virtualList, oldIndex, newIndex;
                if (insertAfter) {
                    sortingEl.insertAfter(insertAfter);
                    sortingEl.trigger('sort');
                }
                if (insertBefore) {
                    sortingEl.insertBefore(insertBefore);
                    sortingEl.trigger('sort');
                }
                if ((insertAfter || insertBefore) && sortableContainer.hasClass('virtual-list')) {
                    virtualList = sortableContainer[0].f7VirtualList;
                    oldIndex = sortingEl[0].f7VirtualListIndex;
                    newIndex = insertBefore ? insertBefore[0].f7VirtualListIndex : insertAfter[0].f7VirtualListIndex;
                    if (virtualList) virtualList.moveItem(oldIndex, newIndex);
                }
                insertAfter = insertBefore = undefined;
                isTouched = false;
                isMoved = false;
            }
            $(document).on(app.touchEvents.start, '.list-block.sortable .sortable-handler', handleTouchStart);
            if (app.support.touch) {
                $(document).on(app.touchEvents.move, '.list-block.sortable .sortable-handler', handleTouchMove);
                $(document).on(app.touchEvents.end, '.list-block.sortable .sortable-handler', handleTouchEnd);
            }
            else {
                $(document).on(app.touchEvents.move, handleTouchMove);
                $(document).on(app.touchEvents.end, handleTouchEnd);
            }
                
        };
        

        /*===============================================================================
        ************   Smart Select   ************
        ===============================================================================*/
        app.initSmartSelects = function (pageContainer) {
            pageContainer = $(pageContainer);
            var selects;
            if (pageContainer.is('.smart-select')) {
                selects = pageContainer;
            }
            else {
                selects = pageContainer.find('.smart-select');
            }
            if (selects.length === 0) return;
        
            selects.each(function () {
                var smartSelect = $(this);
        
                var $select = smartSelect.find('select');
                if ($select.length === 0) return;
        
                var select = $select[0];
                if (select.length === 0) return;
        
                var valueText = [];
                for (var i = 0; i < select.length; i++) {
                    if (select[i].selected) valueText.push(select[i].textContent.trim());
                }
        
                var itemAfter = smartSelect.find('.item-after');
                if (itemAfter.length === 0) {
                    smartSelect.find('.item-inner').append('<div class="item-after">' + valueText.join(', ') + '</div>');
                }
                else {
                    var selectedText = itemAfter.text();
                    if (itemAfter.hasClass('smart-select-value')) {
                        for (i = 0; i < select.length; i++) {
                            select[i].selected = select[i].textContent.trim() === selectedText.trim();
                        }
                    } else {
                        itemAfter.text(valueText.join(', '));
                    }
                }
                
            });
            
        };
        app.smartSelectAddOption = function (select, option, index) {
            select = $(select);
            var smartSelect = select.parents('.smart-select');
            if (typeof index === 'undefined') {
                select.append(option);
            }
            else {
                $(option).insertBefore(select.find('option').eq(index));
            }
            app.initSmartSelects(smartSelect);
            var selectName = smartSelect.find('select').attr('name');
            var opened = $('.page.smart-select-page[data-select-name="' + selectName + '"]').length > 0;
            if (opened) {
                app.smartSelectOpen(smartSelect, true);
            }
        };
        app.smartSelectOpen = function (smartSelect, reLayout) {
            smartSelect = $(smartSelect);
            if (smartSelect.length === 0) return;
        
            // Find related view
            var view = smartSelect.parents('.' + app.params.viewClass);
            if (view.length === 0) return;
            view = view[0].f7View;
        
            // Parameters
            var openIn = smartSelect.attr('data-open-in') || app.params.smartSelectOpenIn;
            if (openIn === 'popup') {
                if ($('.popup.smart-select-popup').length > 0) return;
            }
            else if (openIn === 'picker') {
                if ($('.picker-modal.modal-in').length > 0 && !reLayout){
                    if (smartSelect[0].f7SmartSelectPicker !== $('.picker-modal.modal-in:not(.modal-out)')[0]) app.closeModal($('.picker-modal.modal-in:not(.modal-out)'));
                    else return;
                }
            }
            else {
                if (!view) return;
            }
        
            var smartSelectData = smartSelect.dataset();
            var pageTitle = smartSelectData.pageTitle || smartSelect.find('.item-title').text();
            var backText = smartSelectData.backText || app.params.smartSelectBackText;
            var closeText;
            if (openIn === 'picker') {
                closeText = smartSelectData.pickerCloseText || smartSelectData.backText || app.params.smartSelectPickerCloseText ;   
            }
            else {
                closeText = smartSelectData.popupCloseText || smartSelectData.backText || app.params.smartSelectPopupCloseText ;      
            }
            var backOnSelect = smartSelectData.backOnSelect !== undefined ? smartSelectData.backOnSelect : app.params.smartSelectBackOnSelect;
            var formTheme = smartSelectData.formTheme || app.params.smartSelectFormTheme;
            var navbarTheme = smartSelectData.navbarTheme || app.params.smartSelectNavbarTheme;
            var toolbarTheme = smartSelectData.toolbarTheme || app.params.smartSelectToolbarTheme;
            var virtualList = smartSelectData.virtualList;
            var virtualListHeight = smartSelectData.virtualListHeight;
            var material = app.params.material;
            var pickerHeight = smartSelectData.pickerHeight || app.params.smartSelectPickerHeight;
        
            // Collect all options/values
            var select = smartSelect.find('select')[0];
            var $select = $(select);
            var $selectData = $select.dataset();
            if (select.disabled || smartSelect.hasClass('disabled') || $select.hasClass('disabled')) {
                return;
            }
            var values = [];
            var id = (new Date()).getTime();
            var inputType = select.multiple ? 'checkbox' : 'radio';
            var inputName = inputType + '-' + id;
            var maxLength = $select.attr('maxlength');
            var selectName = select.name;
            var option, optionHasMedia, optionImage, optionIcon, optionGroup, optionGroupLabel, optionPreviousGroup, optionIsLabel, previousGroup, optionColor, optionClassName, optionData;
            for (var i = 0; i < select.length; i++) {
                option = $(select[i]);
                optionData = option.dataset();
                optionImage = optionData.optionImage || $selectData.optionImage || smartSelectData.optionImage;
                optionIcon = optionData.optionIcon || $selectData.optionIcon || smartSelectData.optionIcon;
                optionHasMedia = optionImage || optionIcon || inputType === 'checkbox';
                if (material) optionHasMedia = optionImage || optionIcon;
                optionColor = optionData.optionColor;
                optionClassName = optionData.optionClass;
                if (option[0].disabled) optionClassName += ' disabled';
                optionGroup = option.parent('optgroup')[0];
                optionGroupLabel = optionGroup && optionGroup.label;
                optionIsLabel = false;
                if (optionGroup) {
                    if (optionGroup !== previousGroup) {
                        optionIsLabel = true;
                        previousGroup = optionGroup;
                        values.push({
                            groupLabel: optionGroupLabel,
                            isLabel: optionIsLabel
                        });
                    }
                }
                values.push({
                    value: option[0].value,
                    text: option[0].textContent.trim(),
                    selected: option[0].selected,
                    group: optionGroup,
                    groupLabel: optionGroupLabel,
                    image: optionImage,
                    icon: optionIcon,
                    color: optionColor,
                    className: optionClassName,
                    disabled: option[0].disabled,
                    inputType: inputType,
                    id: id,
                    hasMedia: optionHasMedia,
                    checkbox: inputType === 'checkbox',
                    inputName: inputName,
                    material: app.params.material
                });
            }
        
        
            // Item template/HTML
            if (!app._compiledTemplates.smartSelectItem) {
                app._compiledTemplates.smartSelectItem = t7.compile(app.params.smartSelectItemTemplate || 
                    '{{#if isLabel}}' +
                    '<li class="item-divider">{{groupLabel}}</li>' +
                    '{{else}}' +
                    '<li{{#if className}} class="{{className}}"{{/if}}>' +
                        '<label class="label-{{inputType}} item-content">' +
                            '<input type="{{inputType}}" name="{{inputName}}" value="{{value}}" {{#if selected}}checked{{/if}}>' +
                            '{{#if material}}' +
                                '{{#if hasMedia}}' +
                                '<div class="item-media">' +
                                    '{{#if icon}}<i class="icon {{icon}}"></i>{{/if}}' +
                                    '{{#if image}}<img src="{{image}}">{{/if}}' +
                                '</div>' +
                                '<div class="item-inner">' +
                                    '<div class="item-title{{#if color}} color-{{color}}{{/if}}">{{text}}</div>' +
                                '</div>' +
                                '<div class="item-after">' +
                                    '<i class="icon icon-form-{{inputType}}"></i>' +
                                '</div>' +
                                '{{else}}' +
                                '<div class="item-media">' +
                                    '<i class="icon icon-form-{{inputType}}"></i>' +
                                '</div>' +
                                '<div class="item-inner">' +
                                    '<div class="item-title{{#if color}} color-{{color}}{{/if}}">{{text}}</div>' +
                                '</div>' +
                                '{{/if}}' +
                            '{{else}}' +
                                '{{#if hasMedia}}' +
                                '<div class="item-media">' +
                                    '{{#if checkbox}}<i class="icon icon-form-checkbox"></i>{{/if}}' +
                                    '{{#if icon}}<i class="icon {{icon}}"></i>{{/if}}' +
                                    '{{#if image}}<img src="{{image}}">{{/if}}' +
                                '</div>' +
                                '{{/if}}' +
                                '<div class="item-inner">' +
                                    '<div class="item-title{{#if color}} color-{{color}}{{/if}}">{{text}}</div>' +
                                '</div>' +
                            '{{/if}}' +
                        '</label>' +
                    '</li>' +
                    '{{/if}}'
                );
            }
            var smartSelectItemTemplate = app._compiledTemplates.smartSelectItem;
            
            var inputsHTML = '';
            if (!virtualList) {
                for (var j = 0; j < values.length; j++) {
                    inputsHTML += smartSelectItemTemplate(values[j]);
                }
            }
        
            // Toolbar / Navbar
            var toolbarHTML = '', navbarHTML;
            var noNavbar = '', noToolbar = '', noTabbar = '', navbarLayout;
        
            if (openIn === 'picker') {
                if (!app._compiledTemplates.smartSelectToolbar) {
                    app._compiledTemplates.smartSelectToolbar = t7.compile(app.params.smartSelectToolbarTemplate || 
                        '<div class="toolbar {{#if toolbarTheme}}theme-{{toolbarTheme}}{{/if}}">' +
                          '<div class="toolbar-inner">' +
                            '<div class="left"></div>' +
                            '<div class="right"><a href="#" class="link close-picker"><span>{{closeText}}</span></a></div>' +
                        '</div>' +
                      '</div>'
                    );
                }
        
                toolbarHTML = app._compiledTemplates.smartSelectToolbar({
                    pageTitle: pageTitle,
                    closeText: closeText,
                    openIn: openIn,
                    toolbarTheme: toolbarTheme,
                    inPicker: openIn === 'picker'              
                });
            }
            else {
                // Navbar HTML
                if (!app._compiledTemplates.smartSelectNavbar) {
                    app._compiledTemplates.smartSelectNavbar = t7.compile(app.params.smartSelectNavbarTemplate || 
                        '<div class="navbar {{#if navbarTheme}}theme-{{navbarTheme}}{{/if}}">' +
                            '<div class="navbar-inner">' +
                                '{{leftTemplate}}' +
                                '<div class="center sliding">{{pageTitle}}</div>' +
                            '</div>' +
                        '</div>'
                    );
                }
                navbarHTML = app._compiledTemplates.smartSelectNavbar({
                    pageTitle: pageTitle,
                    backText: backText,
                    closeText: closeText,
                    openIn: openIn,
                    navbarTheme: navbarTheme,
                    inPopup: openIn === 'popup',
                    inPage: openIn === 'page',
                    leftTemplate: openIn === 'popup' ? 
                        (app.params.smartSelectPopupCloseTemplate || (material ? '<div class="left"><a href="#" class="link close-popup icon-only"><i class="icon icon-back"></i></a></div>' : '<div class="left"><a href="#" class="link close-popup"><i class="icon icon-back"></i><span>{{closeText}}</span></a></div>')).replace(/{{closeText}}/g, closeText) :
                        (app.params.smartSelectBackTemplate || (material ? '<div class="left"><a href="#" class="back link icon-only"><i class="icon icon-back"></i></a></div>' : '<div class="left sliding"><a href="#" class="back link"><i class="icon icon-back"></i><span>{{backText}}</span></a></div>')).replace(/{{backText}}/g, backText)
                });
                // Determine navbar layout type - static/fixed/through
                if (openIn === 'page') {
                    navbarLayout = 'static';
                    if (smartSelect.parents('.navbar-through').length > 0) navbarLayout = 'through';
                    if (smartSelect.parents('.navbar-fixed').length > 0) navbarLayout = 'fixed';
                    noToolbar = smartSelect.parents('.page').hasClass('no-toolbar') ? 'no-toolbar' : '';
                    noNavbar  = smartSelect.parents('.page').hasClass('no-navbar')  ? 'no-navbar'  : 'navbar-' + navbarLayout;
                    noTabbar = smartSelect.parents('.page').hasClass('no-tabbar') ? 'no-tabbar' : '';
                }
                else {
                    navbarLayout = 'fixed';
                }
            }
                
        
            // Page Layout
            var pageName = 'smart-select-' + inputName;
        
            var useSearchbar = typeof smartSelect.data('searchbar') === 'undefined' ? app.params.smartSelectSearchbar : (smartSelect.data('searchbar') === 'true' ? true : false);
            var searchbarPlaceholder, searchbarCancel;
                
            if (useSearchbar) {
                searchbarPlaceholder = smartSelect.data('searchbar-placeholder') || 'Search';
                searchbarCancel = smartSelect.data('searchbar-cancel') || 'Cancel';
            }
        
            var searchbarHTML =   '<form class="searchbar searchbar-init" data-search-list=".smart-select-list-' + id + '" data-search-in=".item-title">' +
                                    '<div class="searchbar-input">' +
                                        '<input type="search" placeholder="' + searchbarPlaceholder + '">' +
                                        '<a href="#" class="searchbar-clear"></a>' +
                                    '</div>' +
                                    (material ? '' : '<a href="#" class="searchbar-cancel">' + searchbarCancel + '</a>') +
                                  '</form>' +
                                  '<div class="searchbar-overlay"></div>';
        
            var pageHTML =
                (openIn !== 'picker' && navbarLayout === 'through' ? navbarHTML : '') +
                '<div class="pages">' +
                '  <div data-page="' + pageName + '" data-select-name="' + selectName + '" class="page smart-select-page ' + noNavbar + ' ' + noToolbar + ' ' + noTabbar + '">' +
                     (openIn !== 'picker' && navbarLayout === 'fixed' ? navbarHTML : '') +
                     (useSearchbar ? searchbarHTML : '') +
                '    <div class="page-content">' +
                       (openIn !== 'picker' && navbarLayout === 'static' ? navbarHTML : '') +
                '      <div class="list-block ' + (virtualList ? 'virtual-list' : '') + ' smart-select-list-' + id + ' ' + (formTheme ? 'theme-' + formTheme : '') + '">' +
                '        <ul>' +
                            (virtualList ? '' : inputsHTML) +
                '        </ul>' +
                '      </div>' +
                '    </div>' +
                '  </div>' +
                '</div>';
        
            // Define popup and picker
            var popup, picker;
        
            // Scroll SS Picker To Input
            function scrollToInput() {
                var pageContent = smartSelect.parents('.page-content');
                if (pageContent.length === 0) return;
                var paddingTop = parseInt(pageContent.css('padding-top'), 10),
                    paddingBottom = parseInt(pageContent.css('padding-bottom'), 10),
                    pageHeight = pageContent[0].offsetHeight - paddingTop - picker.height(),
                    pageScrollHeight = pageContent[0].scrollHeight - paddingTop - picker.height(),
                    newPaddingBottom;
                var inputTop = smartSelect.offset().top - paddingTop + smartSelect[0].offsetHeight;
                if (inputTop > pageHeight) {
                    var scrollTop = pageContent.scrollTop() + inputTop - pageHeight;
                    if (scrollTop + pageHeight > pageScrollHeight) {
                        newPaddingBottom = scrollTop + pageHeight - pageScrollHeight + paddingBottom;
                        if (pageHeight === pageScrollHeight) {
                            newPaddingBottom = picker.height();
                        }
                        pageContent.css({'padding-bottom': (newPaddingBottom) + 'px'});
                    }
                    pageContent.scrollTop(scrollTop, 300);
                }
            }
            // Close SS Picker on HTML Click
            function closeOnHTMLClick(e) {
                var close = true;
                if (e.target === smartSelect[0] || $(e.target).parents(smartSelect[0]).length > 0) {
                    close = false;
                }
                if ($(e.target).parents('.picker-modal').length > 0) {
                    close = false;
                }
                if (close) {
                    app.closeModal('.smart-select-picker.modal-in');   
                }
            }
        
            // Check max length
            function checkMaxLength(container) {
                if (select.selectedOptions.length >= maxLength) {
                    container.find('input[type="checkbox"]').each(function () {
                        if (!this.checked) {
                            $(this).parents('li').addClass('disabled');
                        }
                        else {
                            $(this).parents('li').removeClass('disabled');   
                        }
                    });
                }
                else {
                    container.find('.disabled').removeClass('disabled');
                }
            }
            // Event Listeners on new page
            function handleInputs(container) {
                container = $(container);
                if (virtualList) {
                    var virtualListInstance = app.virtualList(container.find('.virtual-list'), {
                        items: values,
                        template: smartSelectItemTemplate,
                        height: virtualListHeight || undefined,
                        searchByItem: function (query, index, item) {
                            if (item.text.toLowerCase().indexOf(query.trim().toLowerCase()) >=0 ) return true;
                            return false;
                        }
                    });
                    container.once(openIn === 'popup' || openIn === 'picker' ? 'closed': 'pageBeforeRemove', function () {
                        if (virtualListInstance && virtualListInstance.destroy) virtualListInstance.destroy();
                    });
                }
                if (maxLength) {
                    checkMaxLength(container);
                }
                container.on('change', 'input[name="' + inputName + '"]', function () {
                    var input = this;
                    var value = input.value;
                    var optionText = [];
                    if (input.type === 'checkbox') {
                        var values = [];
                        for (var i = 0; i < select.options.length; i++) {
                            var option = select.options[i];
                            if (option.value === value) {
                                option.selected = input.checked;
                            }
                            if (option.selected) {
                                optionText.push(option.textContent.trim());
                            }
                        }
                        if (maxLength) {
                            checkMaxLength(container);
                        }
                    }
                    else {
                        optionText = [smartSelect.find('option[value="' + value + '"]').text()];
                        select.value = value;
                    }
                        
                    $select.trigger('change');
                    smartSelect.find('.item-after').text(optionText.join(', '));
                    if (backOnSelect && inputType === 'radio') {
                        if (openIn === 'popup') app.closeModal(popup);
                        else if (openIn === 'picker') app.closeModal(picker);
                        else view.router.back();
                    }
                });
            }
            function pageInit(e) {
                var page = e.detail.page;
                if (page.name === pageName) {
                    handleInputs(page.container);
                }
            }
            if (openIn === 'popup') {
                if (reLayout) {
                    popup = $('.popup.smart-select-popup .view');
                    popup.html(pageHTML);
                }
                else {
                    popup = app.popup(
                        '<div class="popup smart-select-popup smart-select-popup-' + inputName + '">' +
                            '<div class="view navbar-fixed">' +
                                pageHTML +
                            '</div>' +
                        '</div>'
                        );
                    popup = $(popup);
                }
                app.initPage(popup.find('.page'));
                handleInputs(popup);
            }
            else if (openIn === 'picker') {
                if (reLayout) {
                    picker = $('.picker-modal.smart-select-picker .view');
                    picker.html(pageHTML);
                }
                else {
                    picker = app.pickerModal(
                        '<div class="picker-modal smart-select-picker smart-select-picker-' + inputName + '"' + (pickerHeight ? ' style="height:' + pickerHeight + '"' : '') + '>' +
                            toolbarHTML +
                            '<div class="picker-modal-inner">' +
                                '<div class="view">' +
                                    pageHTML +
                                '</div>' +
                            '</div>' +
                        '</div>'
                        );
                    picker = $(picker);
        
                    // Scroll To Input
                    scrollToInput();
        
                    // Close On Click
                    $('html').on('click', closeOnHTMLClick);
        
                    // On Close
                    picker.once('close', function () {
                        // Reset linked picker
                        smartSelect[0].f7SmartSelectPicker = undefined;
                        
                        // Detach html click
                        $('html').off('click', closeOnHTMLClick);    
                        
                        // Restore page padding bottom
                        smartSelect.parents('.page-content').css({paddingBottom: ''});
                    });
        
                    // Link Picker
                    smartSelect[0].f7SmartSelectPicker = picker[0];
                }
        
                // Init Page
                app.initPage(picker.find('.page'));
        
                // Attach events
                handleInputs(picker);
            }
            else {
                $(document).once('pageInit', '.smart-select-page', pageInit);
                view.router.load({
                    content: pageHTML,
                    reload: reLayout ? true : undefined
                });
            }
        };
        

        /*===============================================================================
        ************   Virtual List   ************
        ===============================================================================*/
        var VirtualList = function (listBlock, params) {
            var defaults = {
                cols: 1,
                height: app.params.material ? 48 : 44,
                cache: true,
                dynamicHeightBufferSize: 1,
                showFilteredItemsOnly: false
            };
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined') {
                    params[def] = defaults[def];
                }
            }
        
            // Preparation
            var vl = this;
            vl.listBlock = $(listBlock);
            vl.params = params;
            vl.items = vl.params.items;
            if (vl.params.showFilteredItemsOnly) {
                vl.filteredItems = [];
            }
            if (vl.params.template) {
                if (typeof vl.params.template === 'string') vl.template = t7.compile(vl.params.template);
                else if (typeof vl.params.template === 'function') vl.template = vl.params.template;
            }
            vl.pageContent = vl.listBlock.parents('.page-content');
        
            // Bad scroll
            var updatableScroll;
            if (typeof vl.params.updatableScroll !== 'undefined') {
                updatableScroll = vl.params.updatableScroll;
            }
            else {
                updatableScroll = true;
                if (app.device.ios && app.device.osVersion.split('.')[0] < 8) {
                    updatableScroll = false;
                }
            }
        
            // Append <ul>
            vl.ul = vl.params.ul ? $(vl.params.ul) : vl.listBlock.children('ul');
            if (vl.ul.length === 0) {
                vl.listBlock.append('<ul></ul>');
                vl.ul = vl.listBlock.children('ul');
            }
        
            // DOM cached items
            vl.domCache = {};
            vl.displayDomCache = {};
        
            // Temporary DOM Element
            vl.tempDomElement = document.createElement('ul');
        
            // Last repain position
            vl.lastRepaintY = null;
        
            // Fragment
            vl.fragment = document.createDocumentFragment();
        
            // Filter
            vl.filterItems = function (indexes, resetScrollTop) {
                vl.filteredItems = [];
                var firstIndex = indexes[0];
                var lastIndex = indexes[indexes.length - 1];
                for (var i = 0; i < indexes.length; i++) {
                    vl.filteredItems.push(vl.items[indexes[i]]);
                }
                if (typeof resetScrollTop === 'undefined') resetScrollTop = true;
                if (resetScrollTop) {
                    vl.pageContent[0].scrollTop = 0;
                }
                vl.update();
            };
            vl.resetFilter = function () {
                if (vl.params.showFilteredItemsOnly) {
                    vl.filteredItems = [];
                }
                else {
                    vl.filteredItems = null;
                    delete vl.filteredItems;    
                }
                vl.update();
            };
        
            var pageHeight, rowsPerScreen, rowsBefore, rowsAfter, rowsToRender, maxBufferHeight = 0, listHeight;
            var dynamicHeight = typeof vl.params.height === 'function';
        
            // Set list size
            vl.setListSize = function () {
                var items = vl.filteredItems || vl.items;
                pageHeight = vl.pageContent[0].offsetHeight;
                if (dynamicHeight) {
                    listHeight = 0;
                    vl.heights = [];
                    for (var i = 0; i < items.length; i++) {
                        var itemHeight = vl.params.height(items[i]);
                        listHeight += itemHeight;
                        vl.heights.push(itemHeight);
                    }
                }
                else {
                    listHeight = items.length * vl.params.height / vl.params.cols;
                    rowsPerScreen = Math.ceil(pageHeight / vl.params.height);
                    rowsBefore = vl.params.rowsBefore || rowsPerScreen * 2;
                    rowsAfter = vl.params.rowsAfter || rowsPerScreen;
                    rowsToRender = (rowsPerScreen + rowsBefore + rowsAfter);
                    maxBufferHeight = rowsBefore / 2 * vl.params.height;
                }
        
                if (updatableScroll) {
                    vl.ul.css({height: listHeight + 'px'});
                }
            };
        
            // Render items
            vl.render = function (force, forceScrollTop) {
                if (force) vl.lastRepaintY = null;
        
                var scrollTop = -(vl.listBlock[0].getBoundingClientRect().top - vl.pageContent[0].getBoundingClientRect().top);
        
                if (typeof forceScrollTop !== 'undefined') scrollTop = forceScrollTop;
        
                if (vl.lastRepaintY === null || Math.abs(scrollTop - vl.lastRepaintY) > maxBufferHeight || (!updatableScroll && (vl.pageContent[0].scrollTop + pageHeight >= vl.pageContent[0].scrollHeight))) {
                    vl.lastRepaintY = scrollTop;
                }
                else {
                    return;
                }
        
                var items = vl.filteredItems || vl.items, 
                    fromIndex, toIndex, heightBeforeFirstItem = 0, heightBeforeLastItem = 0;
                if (dynamicHeight) {
                    var itemTop = 0, j, itemHeight; 
                    maxBufferHeight = pageHeight;
        
                    for (j = 0; j < vl.heights.length; j++) {
                        itemHeight = vl.heights[j];
                        if (typeof fromIndex === 'undefined') {
                            if (itemTop + itemHeight >= scrollTop - pageHeight * 2 * vl.params.dynamicHeightBufferSize) fromIndex = j;
                            else heightBeforeFirstItem += itemHeight;
                        }
        
                        if (typeof toIndex === 'undefined') {
                            if (itemTop + itemHeight >= scrollTop + pageHeight * 2 * vl.params.dynamicHeightBufferSize || j === vl.heights.length - 1) toIndex = j + 1;
                            heightBeforeLastItem += itemHeight;
                        }
                        itemTop += itemHeight;
                    }
                    toIndex = Math.min(toIndex, items.length);
                }
                else {
                    fromIndex = (parseInt(scrollTop / vl.params.height) - rowsBefore) * vl.params.cols;
                    if (fromIndex < 0) {
                        fromIndex = 0;
                    }
                    toIndex = Math.min(fromIndex + rowsToRender * vl.params.cols, items.length);
                }
        
                var topPosition;
                vl.reachEnd = false;
                for (var i = fromIndex; i < toIndex; i++) {
                    var item, index;
                    // Define real item index
                    index = vl.items.indexOf(items[i]);
        
                    if (i === fromIndex) vl.currentFromIndex = index;
                    if (i === toIndex - 1) vl.currentToIndex = index;
                    if (index === vl.items.length - 1) vl.reachEnd = true;
        
                    // Find items
                    if (vl.domCache[index]) {
                        item = vl.domCache[index];
                    }
                    else {
                        if (vl.template) {
                            vl.tempDomElement.innerHTML = vl.template(items[i], {index: index}).trim();
                        }
                        else if (vl.params.renderItem) {
                            vl.tempDomElement.innerHTML = vl.params.renderItem(index, items[i]).trim();
                        }
                        else {
                            vl.tempDomElement.innerHTML = items[i].trim();
                        }
                        item = vl.tempDomElement.childNodes[0];
                        if (vl.params.cache) vl.domCache[index] = item;
                    }
                    item.f7VirtualListIndex = index;
        
                    // Set item top position
                    if (i === fromIndex) {
                        if (dynamicHeight) {
                            topPosition = heightBeforeFirstItem;
                        }
                        else {
                            topPosition = (i * vl.params.height / vl.params.cols);
                        }
                    }
                    item.style.top = topPosition + 'px';
        
                    // Before item insert
                    if (vl.params.onItemBeforeInsert) vl.params.onItemBeforeInsert(vl, item);
        
                    // Append item to fragment
                    vl.fragment.appendChild(item);
        
        
                }
        
                // Update list height with not updatable scroll
                if (!updatableScroll) {
                    if (dynamicHeight) {
                        vl.ul[0].style.height = heightBeforeLastItem + 'px';
                    }
                    else {
                        vl.ul[0].style.height = i * vl.params.height / vl.params.cols + 'px';
                    }
                }
        
        
                // Update list html
                if (vl.params.onBeforeClear) vl.params.onBeforeClear(vl, vl.fragment);
                vl.ul[0].innerHTML = '';
        
                if (vl.params.onItemsBeforeInsert) vl.params.onItemsBeforeInsert(vl, vl.fragment);
                vl.ul[0].appendChild(vl.fragment);
                if (vl.params.onItemsAfterInsert) vl.params.onItemsAfterInsert(vl, vl.fragment);
        
                if (typeof forceScrollTop !== 'undefined' && force) {
                    vl.pageContent.scrollTop(forceScrollTop, 0);
                }
            };
        
            vl.scrollToItem = function (index) {
                if (index > vl.items.length) return false;
        
                var itemTop = 0, listTop;
                if (dynamicHeight) {
                    for (var i = 0; i < index; i++) {
                        itemTop += vl.heights[i];
                    }
                }
                else {
                    itemTop = index * vl.params.height;
                }
                listTop = vl.listBlock[0].offsetTop;
                vl.render(true, listTop + itemTop - parseInt(vl.pageContent.css('padding-top'), 10));
                return true;
            };
        
            // Handle scroll event
            vl.handleScroll = function (e) {
                vl.render();
            };
            // Handle resize event
            vl.handleResize = function (e) {
                vl.setListSize();
                vl.render(true);
            };
        
            vl.attachEvents = function (detach) {
                var action = detach ? 'off' : 'on';
                vl.pageContent[action]('scroll', vl.handleScroll);
                vl.listBlock.parents('.tab').eq(0)[action]('show', vl.handleResize);
                $(window)[action]('resize', vl.handleResize);
            };
        
            // Init Virtual List
            vl.init = function () {
                vl.attachEvents();
                vl.setListSize();
                vl.render();
            };
        
            // Append
            vl.appendItems = function (items) {
                for (var i = 0; i < items.length; i++) {
                    vl.items.push(items[i]);
                }
                vl.update();
            };
            vl.appendItem = function (item) {
                vl.appendItems([item]);
            };
            // Replace
            vl.replaceAllItems = function (items) {
                vl.items = items;
                delete vl.filteredItems;
                vl.domCache = {};
                vl.update();
            };
            vl.replaceItem = function (index, item) {
                vl.items[index] = item;
                if (vl.params.cache) delete vl.domCache[index];
                vl.update();
            };
            // Prepend
            vl.prependItems = function (items) {
                for (var i = items.length - 1; i >= 0; i--) {
                    vl.items.unshift(items[i]);
                }
                if (vl.params.cache) {
                    var newCache = {};
                    for (var cached in vl.domCache) {
                        newCache[parseInt(cached, 10) + items.length] = vl.domCache[cached];
                    }
                    vl.domCache = newCache;
                }
                vl.update();
            };
            vl.prependItem = function (item) {
                vl.prependItems([item]);
            };
        
            // Move
            vl.moveItem = function (oldIndex, newIndex) {
                if (oldIndex === newIndex) return;
                // remove item from array
                var item = vl.items.splice(oldIndex, 1)[0];
                if (newIndex >= vl.items.length) {
                    // Add item to the end
                    vl.items.push(item);
                    newIndex = vl.items.length - 1;
                }
                else {
                    // Add item to new index
                    vl.items.splice(newIndex, 0, item);
                }
                // Update cache
                if (vl.params.cache) {
                    var newCache = {};
                    for (var cached in vl.domCache) {
                        var cachedIndex = parseInt(cached, 10);
                        var leftIndex = oldIndex < newIndex ? oldIndex : newIndex;
                        var rightIndex = oldIndex < newIndex ? newIndex : oldIndex;
                        var indexShift = oldIndex < newIndex ? -1 : 1;
                        if (cachedIndex < leftIndex || cachedIndex > rightIndex) newCache[cachedIndex] = vl.domCache[cachedIndex];
                        if (cachedIndex === leftIndex) newCache[rightIndex] = vl.domCache[cachedIndex];
                        if (cachedIndex > leftIndex && cachedIndex <= rightIndex) newCache[cachedIndex + indexShift] = vl.domCache[cachedIndex];
                    }
                    vl.domCache = newCache;
                }
                vl.update();
            };
            // Insert before
            vl.insertItemBefore = function (index, item) {
                if (index === 0) {
                    vl.prependItem(item);
                    return;
                }
                if (index >= vl.items.length) {
                    vl.appendItem(item);
                    return;
                }
                vl.items.splice(index, 0, item);
                // Update cache
                if (vl.params.cache) {
                    var newCache = {};
                    for (var cached in vl.domCache) {
                        var cachedIndex = parseInt(cached, 10);
                        if (cachedIndex >= index) {
                            newCache[cachedIndex + 1] = vl.domCache[cachedIndex];
                        }
                    }
                    vl.domCache = newCache;
                }
                vl.update();
            };
            // Delete
            vl.deleteItems = function (indexes) {
                var prevIndex, indexShift = 0;
                for (var i = 0; i < indexes.length; i++) {
                    var index = indexes[i];
                    if (typeof prevIndex !== 'undefined') {
                        if (index > prevIndex) {
                            indexShift = -i;
                        }
                    }
                    index = index + indexShift;
                    prevIndex = indexes[i];
                    // Delete item
                    var deletedItem = vl.items.splice(index, 1)[0];
        
                    // Delete from filtered
                    if (vl.filteredItems && vl.filteredItems.indexOf(deletedItem) >= 0) {
                        vl.filteredItems.splice(vl.filteredItems.indexOf(deletedItem), 1);
                    }
                    // Update cache
                    if (vl.params.cache) {
                        var newCache = {};
                        for (var cached in vl.domCache) {
                            var cachedIndex = parseInt(cached, 10);
                            if (cachedIndex === index) {
                                delete vl.domCache[index];
                            }
                            else if (parseInt(cached, 10) > index) {
                                newCache[cachedIndex - 1] = vl.domCache[cached];
                            }
                            else {
                                newCache[cachedIndex] = vl.domCache[cached];   
                            }
                        }
                        vl.domCache = newCache;
                    }
                }
                vl.update();
            };
            vl.deleteAllItems = function () {
                vl.items = [];
                delete vl.filteredItems;
                if (vl.params.cache) vl.domCache = {};
                vl.update();
            };
            vl.deleteItem = function (index) {
                vl.deleteItems([index]);
            };
        
            // Clear cache
            vl.clearCache = function () {
                vl.domCache = {};
            };
        
            // Update Virtual List
            vl.update = function () {
                vl.setListSize();
                vl.render(true);
            };
        
            // Destroy
            vl.destroy = function () {
                vl.attachEvents(true);
                delete vl.items;
                delete vl.domCache;
            };
        
            // Init Virtual List
            vl.init();
        
            // Store vl in container
            vl.listBlock[0].f7VirtualList = vl;
            return vl;
        };
        
        // App Method
        app.virtualList = function (listBlock, params) {
            return new VirtualList(listBlock, params);
        };
        
        app.reinitVirtualList = function (pageContainer) {
            var page = $(pageContainer);
            var vlists = page.find('.virtual-list');
            if (vlists.length === 0) return;
            for (var i = 0; i < vlists.length; i++) {
                var vlistInstance = vlists[i].f7VirtualList;
                if (vlistInstance) {
                    vlistInstance.update();
                }
            }
        };

        /*======================================================
        ************   Pull To Refresh   ************
        ======================================================*/
        app.initPullToRefresh = function (pageContainer) {
            var eventsTarget = $(pageContainer);
            if (!eventsTarget.hasClass('pull-to-refresh-content')) {
                eventsTarget = eventsTarget.find('.pull-to-refresh-content');
            }
            if (!eventsTarget || eventsTarget.length === 0) return;
        
            var touchId, isTouched, isMoved, touchesStart = {}, isScrolling, touchesDiff, touchStartTime, container, refresh = false, useTranslate = false, startTranslate = 0, translate, scrollTop, wasScrolled, layer, triggerDistance, dynamicTriggerDistance, pullStarted;
            var page = eventsTarget.hasClass('page') ? eventsTarget : eventsTarget.parents('.page');
            var hasNavbar = false;
            if (page.find('.navbar').length > 0 || page.parents('.navbar-fixed, .navbar-through').length > 0 || page.hasClass('navbar-fixed') || page.hasClass('navbar-through')) hasNavbar = true;
            if (page.hasClass('no-navbar')) hasNavbar = false;
            if (!hasNavbar) eventsTarget.addClass('pull-to-refresh-no-navbar');
        
            container = eventsTarget;
        
            // Define trigger distance
            if (container.attr('data-ptr-distance')) {
                dynamicTriggerDistance = true;
            }
            else {
                triggerDistance = 44;   
            }
            
            function handleTouchStart(e) {
                if (isTouched) {
                    if (app.device.os === 'android') {
                        if ('targetTouches' in e && e.targetTouches.length > 1) return;
                    }
                    else return;
                }
                
                /*jshint validthis:true */
                container = $(this);
                if (container.hasClass('refreshing')) {
                    return;
                }
                
                isMoved = false;
                pullStarted = false;
                isTouched = true;
                isScrolling = undefined;
                wasScrolled = undefined;
                if (e.type === 'touchstart') touchId = e.targetTouches[0].identifier;
                touchesStart.x = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
                touchesStart.y = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                touchStartTime = (new Date()).getTime();
                
            }
            
            function handleTouchMove(e) {
                if (!isTouched) return;
                var pageX, pageY, touch;
                if (e.type === 'touchmove') {
                    if (touchId && e.touches) {
                        for (var i = 0; i < e.touches.length; i++) {
                            if (e.touches[i].identifier === touchId) {
                                touch = e.touches[i];
                            }
                        }
                    }
                    if (!touch) touch = e.targetTouches[0];
                    pageX = touch.pageX;
                    pageY = touch.pageY;
                }
                else {
                    pageX = e.pageX;
                    pageY = e.pageY;
                }
                if (!pageX || !pageY) return;
                    
        
                if (typeof isScrolling === 'undefined') {
                    isScrolling = !!(isScrolling || Math.abs(pageY - touchesStart.y) > Math.abs(pageX - touchesStart.x));
                }
                if (!isScrolling) {
                    isTouched = false;
                    return;
                }
        
                scrollTop = container[0].scrollTop;
                if (typeof wasScrolled === 'undefined' && scrollTop !== 0) wasScrolled = true; 
        
                if (!isMoved) {
                    /*jshint validthis:true */
                    container.removeClass('transitioning');
                    if (scrollTop > container[0].offsetHeight) {
                        isTouched = false;
                        return;
                    }
                    if (dynamicTriggerDistance) {
                        triggerDistance = container.attr('data-ptr-distance');
                        if (triggerDistance.indexOf('%') >= 0) triggerDistance = container[0].offsetHeight * parseInt(triggerDistance, 10) / 100;
                    }
                    startTranslate = container.hasClass('refreshing') ? triggerDistance : 0;
                    if (container[0].scrollHeight === container[0].offsetHeight || app.device.os !== 'ios') {
                        useTranslate = true;
                    }
                    else {
                        useTranslate = false;
                    }
                }
                isMoved = true;
                touchesDiff = pageY - touchesStart.y;
                
                if (touchesDiff > 0 && scrollTop <= 0 || scrollTop < 0) {
                    // iOS 8 fix
                    if (app.device.os === 'ios' && parseInt(app.device.osVersion.split('.')[0], 10) > 7 && scrollTop === 0 && !wasScrolled) useTranslate = true;
        
                    if (useTranslate) {
                        e.preventDefault();
                        translate = (Math.pow(touchesDiff, 0.85) + startTranslate);
                        container.transform('translate3d(0,' + translate + 'px,0)');
                    }
                    if ((useTranslate && Math.pow(touchesDiff, 0.85) > triggerDistance) || (!useTranslate && touchesDiff >= triggerDistance * 2)) {
                        refresh = true;
                        container.addClass('pull-up').removeClass('pull-down');
                    }
                    else {
                        refresh = false;
                        container.removeClass('pull-up').addClass('pull-down');
                    }
                    if (!pullStarted) {
                        container.trigger('pullstart');
                        pullStarted = true;
                    }
                    container.trigger('pullmove', {
                        event: e,
                        scrollTop: scrollTop,
                        translate: translate,
                        touchesDiff: touchesDiff
                    });
                }
                else {
                    pullStarted = false;
                    container.removeClass('pull-up pull-down');
                    refresh = false;
                    return;
                }
            }
            function handleTouchEnd(e) {
                if (e.type === 'touchend' && e.changedTouches && e.changedTouches.length > 0 && touchId) {
                    if (e.changedTouches[0].identifier !== touchId) return;
                }
                if (!isTouched || !isMoved) {
                    isTouched = false;
                    isMoved = false;
                    return;
                }
                if (translate) {
                    container.addClass('transitioning');
                    translate = 0;
                }
                container.transform('');
                if (refresh) {
                    container.addClass('refreshing');
                    container.trigger('refresh', {
                        done: function () {
                            app.pullToRefreshDone(container);
                        }
                    });
                }
                else {
                    container.removeClass('pull-down');
                }
                isTouched = false;
                isMoved = false;
                if (pullStarted) container.trigger('pullend');
            }
        
            // Attach Events
            eventsTarget.on(app.touchEvents.start, handleTouchStart);
            eventsTarget.on(app.touchEvents.move, handleTouchMove);
            eventsTarget.on(app.touchEvents.end, handleTouchEnd);
        
            // Detach Events on page remove
            if (page.length === 0) return;
            function destroyPullToRefresh() {
                eventsTarget.off(app.touchEvents.start, handleTouchStart);
                eventsTarget.off(app.touchEvents.move, handleTouchMove);
                eventsTarget.off(app.touchEvents.end, handleTouchEnd);
            }
            eventsTarget[0].f7DestroyPullToRefresh = destroyPullToRefresh;
            function detachEvents() {
                destroyPullToRefresh();
                page.off('pageBeforeRemove', detachEvents);
            }
            page.on('pageBeforeRemove', detachEvents);
        
        };
        
        app.pullToRefreshDone = function (container) {
            container = $(container);
            if (container.length === 0) container = $('.pull-to-refresh-content.refreshing');
            container.removeClass('refreshing').addClass('transitioning');
            container.transitionEnd(function () {
                container.removeClass('transitioning pull-up pull-down');
                container.trigger('refreshdone');
            });
        };
        app.pullToRefreshTrigger = function (container) {
            container = $(container);
            if (container.length === 0) container = $('.pull-to-refresh-content');
            if (container.hasClass('refreshing')) return;
            container.addClass('transitioning refreshing');
            container.trigger('refresh', {
                done: function () {
                    app.pullToRefreshDone(container);
                }
            });
        };
        
        app.destroyPullToRefresh = function (pageContainer) {
            pageContainer = $(pageContainer);
            var pullToRefreshContent = pageContainer.hasClass('pull-to-refresh-content') ? pageContainer : pageContainer.find('.pull-to-refresh-content');
            if (pullToRefreshContent.length === 0) return;
            if (pullToRefreshContent[0].f7DestroyPullToRefresh) pullToRefreshContent[0].f7DestroyPullToRefresh();
        };
        

        /* ===============================================================================
        ************   Infinite Scroll   ************
        =============================================================================== */
        function handleInfiniteScroll() {
            /*jshint validthis:true */
            var inf = $(this);
            var scrollTop = inf[0].scrollTop;
            var scrollHeight = inf[0].scrollHeight;
            var height = inf[0].offsetHeight;
            var distance = inf[0].getAttribute('data-distance');
            var virtualListContainer = inf.find('.virtual-list');
            var virtualList;
            var onTop = inf.hasClass('infinite-scroll-top');
            if (!distance) distance = 50;
            if (typeof distance === 'string' && distance.indexOf('%') >= 0) {
                distance = parseInt(distance, 10) / 100 * height;
            }
            if (distance > height) distance = height;
            if (onTop) {
                if (scrollTop < distance) {
                    inf.trigger('infinite');
                }
            }
            else {
                if (scrollTop + height >= scrollHeight - distance) {
                    if (virtualListContainer.length > 0) {
                        virtualList = virtualListContainer[0].f7VirtualList;
                        if (virtualList && !virtualList.reachEnd) return;
                    }
                    inf.trigger('infinite');
                }
            }
        
        }
        app.attachInfiniteScroll = function (infiniteContent) {
            $(infiniteContent).on('scroll', handleInfiniteScroll);
        };
        app.detachInfiniteScroll = function (infiniteContent) {
            $(infiniteContent).off('scroll', handleInfiniteScroll);
        };
        
        app.initPageInfiniteScroll = function (pageContainer) {
            pageContainer = $(pageContainer);
            var infiniteContent = pageContainer.find('.infinite-scroll');
            if (infiniteContent.length === 0) return;
            app.attachInfiniteScroll(infiniteContent);
            function detachEvents() {
                app.detachInfiniteScroll(infiniteContent);
                pageContainer.off('pageBeforeRemove', detachEvents);
            }
            pageContainer.on('pageBeforeRemove', detachEvents);
        };

        /*=============================================================
        ************   Hide/show Toolbar/Navbar on scroll   ************
        =============================================================*/
        app.initPageScrollToolbars = function (pageContainer) {
            pageContainer = $(pageContainer);
            var scrollContent = pageContainer.find('.page-content');
            if (scrollContent.length === 0) return;
            var hideNavbar = (app.params.hideNavbarOnPageScroll || scrollContent.hasClass('hide-navbar-on-scroll') || scrollContent.hasClass('hide-bars-on-scroll')) && !(scrollContent.hasClass('keep-navbar-on-scroll') || scrollContent.hasClass('keep-bars-on-scroll'));
            var hideToolbar = (app.params.hideToolbarOnPageScroll || scrollContent.hasClass('hide-toolbar-on-scroll') || scrollContent.hasClass('hide-bars-on-scroll')) && !(scrollContent.hasClass('keep-toolbar-on-scroll') || scrollContent.hasClass('keep-bars-on-scroll'));
            var hideTabbar = (app.params.hideTabbarOnPageScroll || scrollContent.hasClass('hide-tabbar-on-scroll')) && !(scrollContent.hasClass('keep-tabbar-on-scroll'));
        
            if (!(hideNavbar || hideToolbar || hideTabbar)) return;
            
            var viewContainer = scrollContent.parents('.' + app.params.viewClass);
            if (viewContainer.length === 0) return;
        
            var navbar = viewContainer.find('.navbar'), 
                toolbar = viewContainer.find('.toolbar'), 
                tabbar;
            if (hideTabbar) {
                tabbar = viewContainer.find('.tabbar');
                if (tabbar.length === 0) tabbar = viewContainer.parents('.' + app.params.viewsClass).find('.tabbar');
            }
        
            var hasNavbar = navbar.length > 0,
                hasToolbar = toolbar.length > 0,
                hasTabbar = tabbar && tabbar.length > 0;
        
            var previousScroll, currentScroll;
                previousScroll = currentScroll = scrollContent[0].scrollTop;
        
            var scrollHeight, offsetHeight, reachEnd, action, navbarHidden, toolbarHidden, tabbarHidden;
        
            var toolbarHeight = (hasToolbar && hideToolbar) ? toolbar[0].offsetHeight : 0;
            var tabbarHeight = (hasTabbar && hideTabbar) ? tabbar[0].offsetHeight : 0;
            var bottomBarHeight = tabbarHeight || toolbarHeight;
        
            function handleScroll(e) {
                if (pageContainer.hasClass('page-on-left')) return;
                currentScroll = scrollContent[0].scrollTop;
                scrollHeight = scrollContent[0].scrollHeight;
                offsetHeight = scrollContent[0].offsetHeight;
                reachEnd =  currentScroll + offsetHeight >= scrollHeight - bottomBarHeight;
                navbarHidden = navbar.hasClass('navbar-hidden');
                toolbarHidden = toolbar.hasClass('toolbar-hidden');
                tabbarHidden = tabbar && tabbar.hasClass('toolbar-hidden');
        
                if (reachEnd) {
                    if (app.params.showBarsOnPageScrollEnd) {
                        action = 'show';
                    }
                }
                else if (previousScroll > currentScroll) {
                    if (app.params.showBarsOnPageScrollTop || currentScroll <= 44) {
                        action = 'show';
                    }
                    else {
                        action = 'hide';
                    }
                }
                else {
                    if (currentScroll > 44) {
                        action = 'hide';
                    }
                    else {
                        action = 'show';
                    }
                }
        
                if (action === 'show') {
                    if (hasNavbar && hideNavbar && navbarHidden) {
                        app.showNavbar(navbar);
                        pageContainer.removeClass('no-navbar-by-scroll'); 
                        navbarHidden = false;
                    }
                    if (hasToolbar && hideToolbar && toolbarHidden) {
                        app.showToolbar(toolbar);
                        pageContainer.removeClass('no-toolbar-by-scroll'); 
                        toolbarHidden = false;
                    }
                    if (hasTabbar && hideTabbar && tabbarHidden) {
                        app.showToolbar(tabbar);
                        pageContainer.removeClass('no-tabbar-by-scroll'); 
                        tabbarHidden = false;
                    }
                }
                else {
                    if (hasNavbar && hideNavbar && !navbarHidden) {
                        app.hideNavbar(navbar);
                        pageContainer.addClass('no-navbar-by-scroll'); 
                        navbarHidden = true;
                    }
                    if (hasToolbar && hideToolbar && !toolbarHidden) {
                        app.hideToolbar(toolbar);
                        pageContainer.addClass('no-toolbar-by-scroll'); 
                        toolbarHidden = true;
                    }
                    if (hasTabbar && hideTabbar && !tabbarHidden) {
                        app.hideToolbar(tabbar);
                        pageContainer.addClass('no-tabbar-by-scroll'); 
                        tabbarHidden = true;
                    }
                }
                    
                previousScroll = currentScroll;
            }
            scrollContent.on('scroll', handleScroll);
            scrollContent[0].f7ScrollToolbarsHandler = handleScroll;
        };
        app.destroyScrollToolbars = function (pageContainer) {
            pageContainer = $(pageContainer);
            var scrollContent = pageContainer.find('.page-content');
            if (scrollContent.length === 0) return;
            var handler = scrollContent[0].f7ScrollToolbarsHandler;
            if (!handler) return;
            scrollContent.off('scroll', scrollContent[0].f7ScrollToolbarsHandler);
        };

        /*======================================================
        ************   Material Tabbar   ************
        ======================================================*/
        app.materialTabbarSetHighlight = function (tabbar, activeLink) {
            tabbar = $(tabbar);
            activeLink = activeLink || tabbar.find('.tab-link.active');
        
            var tabLinkWidth, highlightTranslate;
            if (tabbar.hasClass('tabbar-scrollable')) {
                tabLinkWidth = activeLink[0].offsetWidth + 'px';
                highlightTranslate = (app.rtl ? - activeLink[0].offsetLeft: activeLink[0].offsetLeft) + 'px';
            }
            else {
                tabLinkWidth = 1 / tabbar.find('.tab-link').length * 100 + '%';
                highlightTranslate = (app.rtl ? - activeLink.index(): activeLink.index()) * 100 + '%';
            }
        
            tabbar.find('.tab-link-highlight')
                .css({width: tabLinkWidth})
                .transform('translate3d(' + highlightTranslate + ',0,0)');
        };
        app.initPageMaterialTabbar = function (pageContainer) {
            pageContainer = $(pageContainer);
            var tabbar = $(pageContainer).find('.tabbar');
        
            function tabbarSetHighlight() {
                app.materialTabbarSetHighlight(tabbar);
            }
            if (tabbar.length > 0) {
                if (tabbar.find('.tab-link-highlight').length === 0) {
                    tabbar.find('.toolbar-inner').append('<span class="tab-link-highlight"></span>');
                }
        
                tabbarSetHighlight();
                $(window).on('resize', tabbarSetHighlight);
                pageContainer.once('pageBeforeRemove', function () {
                    $(window).off('resize', tabbarSetHighlight);
                });
            }
        };

        /* ===============================================================================
        ************   Tabs   ************
        =============================================================================== */
        app.showTab = function (tab, tabLink, force) {
            var newTab = $(tab);
            if (arguments.length === 2) {
                if (typeof tabLink === 'boolean') {
                    force = tabLink;
                }
            }
            if (newTab.length === 0) return false;
            if (newTab.hasClass('active')) {
                if (force) newTab.trigger('show');
                return false;
            }
            var tabs = newTab.parent('.tabs');
            if (tabs.length === 0) return false;
        
            // Return swipeouts in hidden tabs
            app.allowSwipeout = true;
        
            // Animated tabs
            var isAnimatedTabs = tabs.parent().hasClass('tabs-animated-wrap');
            if (isAnimatedTabs) {
                var tabTranslate = (app.rtl ? newTab.index() : -newTab.index()) * 100;
                tabs.transform('translate3d(' + tabTranslate + '%,0,0)');
            }
        
            // Swipeable tabs
            var isSwipeableTabs = tabs.parent().hasClass('tabs-swipeable-wrap'), swiper;
            if (isSwipeableTabs) {
                swiper = tabs.parent()[0].swiper;
                if (swiper.activeIndex !== newTab.index()) swiper.slideTo(newTab.index(), undefined, false);
            }
        
            // Remove active class from old tabs
            var oldTab = tabs.children('.tab.active').removeClass('active');
            // Add active class to new tab
            newTab.addClass('active');
            // Trigger 'show' event on new tab
            newTab.trigger('show');
        
            // Update navbars in new tab
            if (!isAnimatedTabs && !isSwipeableTabs && newTab.find('.navbar').length > 0) {
                // Find tab's view
                var viewContainer;
                if (newTab.hasClass(app.params.viewClass)) viewContainer = newTab[0];
                else viewContainer = newTab.parents('.' + app.params.viewClass)[0];
                app.sizeNavbars(viewContainer);
            }
        
            // Find related link for new tab
            if (tabLink) tabLink = $(tabLink);
            else {
                // Search by id
                if (typeof tab === 'string') tabLink = $('.tab-link[href="' + tab + '"]');
                else tabLink = $('.tab-link[href="#' + newTab.attr('id') + '"]');
                // Search by data-tab
                if (!tabLink || tabLink && tabLink.length === 0) {
                    $('[data-tab]').each(function () {
                        if (newTab.is($(this).attr('data-tab'))) tabLink = $(this);
                    });
                }
            }
            if (tabLink.length === 0) return;
        
            // Find related link for old tab
            var oldTabLink;
            if (oldTab && oldTab.length > 0) {
                // Search by id
                var oldTabId = oldTab.attr('id');
                if (oldTabId) oldTabLink = $('.tab-link[href="#' + oldTabId + '"]');
                // Search by data-tab
                if (!oldTabLink || oldTabLink && oldTabLink.length === 0) {
                    $('[data-tab]').each(function () {
                        if (oldTab.is($(this).attr('data-tab'))) oldTabLink = $(this);
                    });
                }
            }
        
            // Update links' classes
            if (tabLink && tabLink.length > 0) {
                tabLink.addClass('active');
                // Material Highlight
                if (app.params.material) {
                    var tabbar = tabLink.parents('.tabbar');
                    if (tabbar.length > 0) {
                        if (tabbar.find('.tab-link-highlight').length === 0) {
                            tabbar.find('.toolbar-inner').append('<span class="tab-link-highlight"></span>');
                        }
                        app.materialTabbarSetHighlight(tabbar, tabLink);
                    }
                }
            }
            if (oldTabLink && oldTabLink.length > 0) oldTabLink.removeClass('active');
        
            return true;
        };

        /*===============================================================================
        ************   Accordion   ************
        ===============================================================================*/
        app.accordionToggle = function (item) {
            item = $(item);
            if (item.length === 0) return;
            if (item.hasClass('accordion-item-expanded')) app.accordionClose(item);
            else app.accordionOpen(item);
        };
        app.accordionOpen = function (item) {
            item = $(item);
            var list = item.parents('.accordion-list').eq(0);
            var content = item.children('.accordion-item-content');
            if (content.length === 0) content = item.find('.accordion-item-content');
            var expandedItem = list.length > 0 && item.parent().children('.accordion-item-expanded');
            if (expandedItem.length > 0) {
                app.accordionClose(expandedItem);
            }
            content.css('height', content[0].scrollHeight + 'px').transitionEnd(function () {
                if (item.hasClass('accordion-item-expanded')) {
                    content.transition(0);
                    content.css('height', 'auto');
                    var clientLeft = content[0].clientLeft;
                    content.transition('');
                    item.trigger('opened');
                }
                else {
                    content.css('height', '');
                    item.trigger('closed');
                }
            });
            item.trigger('open');
            item.addClass('accordion-item-expanded');
        };
        app.accordionClose = function (item) {
            item = $(item);
            var content = item.children('.accordion-item-content');
            if (content.length === 0) content = item.find('.accordion-item-content');
            item.removeClass('accordion-item-expanded');
            content.transition(0);
            content.css('height', content[0].scrollHeight + 'px');
            // Relayout
            var clientLeft = content[0].clientLeft;
            // Close
            content.transition('');
            content.css('height', '').transitionEnd(function () {
                if (item.hasClass('accordion-item-expanded')) {
                    content.transition(0);
                    content.css('height', 'auto');
                    var clientLeft = content[0].clientLeft;
                    content.transition('');
                    item.trigger('opened');
                }
                else {
                    content.css('height', '');
                    item.trigger('closed');
                }
            });
            item.trigger('close');
        };

        /*===============================================================================
        ************   Fast Clicks   ************
        ************   Inspired by https://github.com/ftlabs/fastclick   ************
        ===============================================================================*/
        app.initFastClicks = function () {
            if (app.params.activeState) {
                $('html').addClass('watch-active-state');
            }
            if (app.device.ios && app.device.webView) {
                // Strange hack required for iOS 8 webview to work on inputs
                window.addEventListener('touchstart', function () {});
            }
        
            var touchStartX, touchStartY, touchStartTime, targetElement, trackClick, activeSelection, scrollParent, lastClickTime, isMoved, tapHoldFired, tapHoldTimeout;
            var activableElement, activeTimeout, needsFastClick, needsFastClickTimeOut;
            var rippleWave, rippleTarget, rippleTransform, rippleTimeout;
            function findActivableElement(el) {
                var target = $(el);
                var parents = target.parents(app.params.activeStateElements);
                var activable;
                if (target.is(app.params.activeStateElements)) {
                    activable = target;
                }
                if (parents.length > 0) {
                    activable = activable ? activable.add(parents) : parents;
                }
                return activable ? activable : target;
            }
            function isInsideScrollableView(el) {
                var pageContent = el.parents('.page-content, .panel');
        
                if (pageContent.length === 0) {
                    return false;
                }
        
                // This event handler covers the "tap to stop scrolling".
                if (pageContent.prop('scrollHandlerSet') !== 'yes') {
                    pageContent.on('scroll', function() {
                      clearTimeout(activeTimeout);
                      clearTimeout(rippleTimeout);
                    });
                    pageContent.prop('scrollHandlerSet', 'yes');
                }
        
                return true;
            }
            function addActive() {
                if (!activableElement) return;
                activableElement.addClass('active-state');
            }
            function removeActive(el) {
                if (!activableElement) return;
                activableElement.removeClass('active-state');
                activableElement = null;
            }
            function isFormElement(el) {
                var nodes = ('input select textarea label').split(' ');
                if (el.nodeName && nodes.indexOf(el.nodeName.toLowerCase()) >= 0) return true;
                return false;
            }
            function androidNeedsBlur(el) {
                var noBlur = ('button input textarea select').split(' ');
                if (document.activeElement && el !== document.activeElement && document.activeElement !== document.body) {
                    if (noBlur.indexOf(el.nodeName.toLowerCase()) >= 0) {
                        return false;
                    }
                    else {
                        return true;
                    }
                }
                else {
                    return false;
                }
            }
            function targetNeedsFastClick(el) {
                var $el = $(el);
                if (el.nodeName.toLowerCase() === 'input' && el.type === 'file') return false;
                if ($el.hasClass('no-fastclick') || $el.parents('.no-fastclick').length > 0) return false;
                return true;
            }
            function targetNeedsFocus(el) {
                if (document.activeElement === el) {
                    return false;
                }
                var tag = el.nodeName.toLowerCase();
                var skipInputs = ('button checkbox file image radio submit').split(' ');
                if (el.disabled || el.readOnly) return false;
                if (tag === 'textarea') return true;
                if (tag === 'select') {
                    if (app.device.android) return false;
                    else return true;
                }
                if (tag === 'input' && skipInputs.indexOf(el.type) < 0) return true;
            }
            function targetNeedsPrevent(el) {
                el = $(el);
                var prevent = true;
                if (el.is('label') || el.parents('label').length > 0) {
                    if (app.device.android) {
                        prevent = false;
                    }
                    else if (app.device.ios && el.is('input')) {
                        prevent = true;
                    }
                    else prevent = false;
                }
                return prevent;
            }
        
            // Mouse Handlers
            function handleMouseDown (e) {
                findActivableElement(e.target).addClass('active-state');
                if ('which' in e && e.which === 3) {
                    setTimeout(function () {
                        $('.active-state').removeClass('active-state');
                    }, 0);
                }
                if (app.params.material && app.params.materialRipple) {
                    touchStartX = e.pageX;
                    touchStartY = e.pageY;
                    rippleTouchStart(e.target, e.pageX, e.pageY);
                }
            }
            function handleMouseMove (e) {
                $('.active-state').removeClass('active-state');
                if (app.params.material && app.params.materialRipple) {
                    rippleTouchMove();
                }
            }
            function handleMouseUp (e) {
                $('.active-state').removeClass('active-state');
                if (app.params.material && app.params.materialRipple) {
                    rippleTouchEnd();
                }
            }
        
            // Material Touch Ripple Effect
            function findRippleElement(el) {
                var needsRipple = app.params.materialRippleElements;
                var $el = $(el);
                if ($el.is(needsRipple)) {
                    if ($el.hasClass('no-ripple')) {
                        return false;
                    }
                    return $el;
                }
                else if ($el.parents(needsRipple).length > 0) {
                    var rippleParent = $el.parents(needsRipple).eq(0);
                    if (rippleParent.hasClass('no-ripple')) {
                        return false;
                    }
                    return rippleParent;
                }
                else return false;
            }
            function createRipple(x, y, el) {
                var box = el[0].getBoundingClientRect();
                var center = {
                    x: x - box.left,
                    y: y - box.top
                },
                    height = box.height,
                    width = box.width;
                var diameter = Math.max(Math.pow((Math.pow(height, 2) + Math.pow(width, 2)), 0.5), 48);
        
                rippleWave = $(
                    '<div class="ripple-wave" style="width: ' + diameter + 'px; height: '+diameter+'px; margin-top:-'+diameter/2+'px; margin-left:-'+diameter/2+'px; left:'+center.x+'px; top:'+center.y+'px;"></div>'
                );
                el.prepend(rippleWave);
                var clientLeft = rippleWave[0].clientLeft;
                rippleTransform = 'translate3d('+(-center.x + width/2)+'px, '+(-center.y + height/2)+'px, 0) scale(1)';
                rippleWave.transform(rippleTransform);
            }
        
            function removeRipple() {
                if (!rippleWave) return;
                var toRemove = rippleWave;
        
                var removeTimeout = setTimeout(function () {
                    toRemove.remove();
                }, 400);
        
                rippleWave
                    .addClass('ripple-wave-fill')
                    .transform(rippleTransform.replace('scale(1)', 'scale(1.01)'))
                    .transitionEnd(function () {
                        clearTimeout(removeTimeout);
        
                        var rippleWave = $(this)
                            .addClass('ripple-wave-out')
                            .transform(rippleTransform.replace('scale(1)', 'scale(1.01)'));
        
                        removeTimeout = setTimeout(function () {
                            rippleWave.remove();
                        }, 700);
        
                        setTimeout(function () {
                            rippleWave.transitionEnd(function(){
                                clearTimeout(removeTimeout);
                                $(this).remove();
                            });
                        }, 0);
                    });
        
                rippleWave = rippleTarget = undefined;
            }
        
            function rippleTouchStart (el, x, y) {
                rippleTarget = findRippleElement(el);
                if (!rippleTarget || rippleTarget.length === 0) {
                    rippleTarget = undefined;
                    return;
                }
                if (!isInsideScrollableView(rippleTarget)) {
                    createRipple(touchStartX, touchStartY, rippleTarget);
                }
                else {
                    rippleTimeout = setTimeout(function () {
                        createRipple(touchStartX, touchStartY, rippleTarget);
                    }, 80);
                }
            }
            function rippleTouchMove() {
                clearTimeout(rippleTimeout);
                removeRipple();
            }
            function rippleTouchEnd() {
                if (rippleWave) {
                    removeRipple();
                }
                else if (rippleTarget && !isMoved) {
                    clearTimeout(rippleTimeout);
                    createRipple(touchStartX, touchStartY, rippleTarget);
                    setTimeout(removeRipple, 0);
                }
                else {
                    removeRipple();
                }
            }
        
            // Send Click
            function sendClick(e) {
                var touch = e.changedTouches[0];
                var evt = document.createEvent('MouseEvents');
                var eventType = 'click';
                if (app.device.android && targetElement.nodeName.toLowerCase() === 'select') {
                    eventType = 'mousedown';
                }
                evt.initMouseEvent(eventType, true, true, window, 1, touch.screenX, touch.screenY, touch.clientX, touch.clientY, false, false, false, false, 0, null);
                evt.forwardedTouchEvent = true;
                targetElement.dispatchEvent(evt);
            }
        
            // Touch Handlers
            function handleTouchStart(e) {
                isMoved = false;
                tapHoldFired = false;
                if (e.targetTouches.length > 1) {
                    if (activableElement) removeActive();
                    return true;
                }
                if (e.touches.length > 1 && activableElement) {
                    removeActive();
                }
                if (app.params.tapHold) {
                    if (tapHoldTimeout) clearTimeout(tapHoldTimeout);
                    tapHoldTimeout = setTimeout(function () {
                        if (e && e.touches && e.touches.length > 1) return;
                        tapHoldFired = true;
                        e.preventDefault();
                        $(e.target).trigger('taphold');
                    }, app.params.tapHoldDelay);
                }
                if (needsFastClickTimeOut) clearTimeout(needsFastClickTimeOut);
                needsFastClick = targetNeedsFastClick(e.target);
        
                if (!needsFastClick) {
                    trackClick = false;
                    return true;
                }
                if (app.device.ios) {
                    var selection = window.getSelection();
                    if (selection.rangeCount && selection.focusNode !== document.body && (!selection.isCollapsed || document.activeElement === selection.focusNode)) {
                        activeSelection = true;
                        return true;
                    }
                    else {
                        activeSelection = false;
                    }
                }
                if (app.device.android)  {
                    if (androidNeedsBlur(e.target)) {
                        document.activeElement.blur();
                    }
                }
        
                trackClick = true;
                targetElement = e.target;
                touchStartTime = (new Date()).getTime();
                touchStartX = e.targetTouches[0].pageX;
                touchStartY = e.targetTouches[0].pageY;
        
                // Detect scroll parent
                if (app.device.ios) {
                    scrollParent = undefined;
                    $(targetElement).parents().each(function () {
                        var parent = this;
                        if (parent.scrollHeight > parent.offsetHeight && !scrollParent) {
                            scrollParent = parent;
                            scrollParent.f7ScrollTop = scrollParent.scrollTop;
                        }
                    });
                }
                if ((e.timeStamp - lastClickTime) < app.params.fastClicksDelayBetweenClicks) {
                    e.preventDefault();
                }
        
                if (app.params.activeState) {
                    activableElement = findActivableElement(targetElement);
                    // If it's inside a scrollable view, we don't trigger active-state yet,
                    // because it can be a scroll instead. Based on the link:
                    // http://labnote.beedesk.com/click-scroll-and-pseudo-active-on-mobile-webk
                    if (!isInsideScrollableView(activableElement)) {
                        addActive();
                    } else {
                        activeTimeout = setTimeout(addActive, 80);
                    }
                }
                if (app.params.material && app.params.materialRipple) {
                    rippleTouchStart(targetElement, touchStartX, touchStartY);
                }
            }
            function handleTouchMove(e) {
                if (!trackClick) return;
                var _isMoved = false;
                var distance = app.params.fastClicksDistanceThreshold;
                if (distance) {
                    var pageX = e.targetTouches[0].pageX;
                    var pageY = e.targetTouches[0].pageY;
                    if (Math.abs(pageX - touchStartX) > distance ||  Math.abs(pageY - touchStartY) > distance) {
                        _isMoved = true;
                    }
                }
                else {
                    _isMoved = true;
                }
                if (_isMoved) {
                    trackClick = false;
                    targetElement = null;
                    isMoved = true;
                    if (app.params.tapHold) {
                        clearTimeout(tapHoldTimeout);
                    }
        			if (app.params.activeState) {
        				clearTimeout(activeTimeout);
        				removeActive();
        			}
                    if (app.params.material && app.params.materialRipple) {
                        rippleTouchMove();
                    }
                }
            }
            function handleTouchEnd(e) {
                clearTimeout(activeTimeout);
                clearTimeout(tapHoldTimeout);
        
                if (!trackClick) {
                    if (!activeSelection && needsFastClick) {
                        if (!(app.device.android && !e.cancelable)) {
                            e.preventDefault();
                        }
                    }
                    return true;
                }
        
                if (document.activeElement === e.target) {
                    if (app.params.activeState) removeActive();
                    if (app.params.material && app.params.materialRipple) {
                        rippleTouchEnd();
                    }
                    return true;
                }
        
                if (!activeSelection) {
                    e.preventDefault();
                }
        
                if ((e.timeStamp - lastClickTime) < app.params.fastClicksDelayBetweenClicks) {
                    setTimeout(removeActive, 0);
                    return true;
                }
        
                lastClickTime = e.timeStamp;
        
                trackClick = false;
        
                if (app.device.ios && scrollParent) {
                    if (scrollParent.scrollTop !== scrollParent.f7ScrollTop) {
                        return false;
                    }
                }
        
                // Add active-state here because, in a very fast tap, the timeout didn't
                // have the chance to execute. Removing active-state in a timeout gives
                // the chance to the animation execute.
                if (app.params.activeState) {
                    addActive();
                    setTimeout(removeActive, 0);
                }
                // Remove Ripple
                if (app.params.material && app.params.materialRipple) {
                    rippleTouchEnd();
                }
        
                // Trigger focus when required
                if (targetNeedsFocus(targetElement)) {
                    if (app.device.ios && app.device.webView) {
                        if ((event.timeStamp - touchStartTime) > 159) {
                            targetElement = null;
                            return false;
                        }
                        targetElement.focus();
                        return false;
                    }
                    else {
                        targetElement.focus();
                    }
                }
        
                // Blur active elements
                if (document.activeElement && targetElement !== document.activeElement && document.activeElement !== document.body && targetElement.nodeName.toLowerCase() !== 'label') {
                    document.activeElement.blur();
                }
        
                // Send click
                e.preventDefault();
                sendClick(e);
                return false;
            }
            function handleTouchCancel(e) {
                trackClick = false;
                targetElement = null;
        
                // Remove Active State
                clearTimeout(activeTimeout);
                clearTimeout(tapHoldTimeout);
                if (app.params.activeState) {
                    removeActive();
                }
        
                // Remove Ripple
                if (app.params.material && app.params.materialRipple) {
                    rippleTouchEnd();
                }
            }
        
            function handleClick(e) {
                var allowClick = false;
        
                if (trackClick) {
                    targetElement = null;
                    trackClick = false;
                    return true;
                }
                if (e.target.type === 'submit' && e.detail === 0) {
                    return true;
                }
                if (!targetElement) {
                    if (!isFormElement(e.target)) {
                        allowClick =  true;
                    }
                }
                if (!needsFastClick) {
                    allowClick = true;
                }
                if (document.activeElement === targetElement) {
                    allowClick =  true;
                }
                if (e.forwardedTouchEvent) {
                    allowClick =  true;
                }
                if (!e.cancelable) {
                    allowClick =  true;
                }
                if (app.params.tapHold && app.params.tapHoldPreventClicks && tapHoldFired) {
                    allowClick = false;
                }
                if (!allowClick) {
                    e.stopImmediatePropagation();
                    e.stopPropagation();
                    if (targetElement) {
                        if (targetNeedsPrevent(targetElement) || isMoved) {
                            e.preventDefault();
                        }
                    }
                    else {
                        e.preventDefault();
                    }
                    targetElement = null;
                }
                needsFastClickTimeOut = setTimeout(function () {
                    needsFastClick = false;
                }, (app.device.ios || app.device.androidChrome ? 100 : 400));
        
                if (app.params.tapHold) {
                    tapHoldTimeout = setTimeout(function () {
                        tapHoldFired = false;
                    }, (app.device.ios || app.device.androidChrome ? 100 : 400));
                }
        
                return allowClick;
            }
            if (app.support.touch) {
                document.addEventListener('click', handleClick, true);
        
                document.addEventListener('touchstart', handleTouchStart);
                document.addEventListener('touchmove', handleTouchMove);
                document.addEventListener('touchend', handleTouchEnd);
                document.addEventListener('touchcancel', handleTouchCancel);
            }
            else {
                if (app.params.activeState) {
                    document.addEventListener('mousedown', handleMouseDown);
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                }
            }
            if (app.params.material && app.params.materialRipple) {
                document.addEventListener('contextmenu', function (e) {
                    if (activableElement) removeActive();
                    rippleTouchEnd();
                });
            }
        
        };
        

        /*===============================================================================
        ************   Handle clicks and make them fast (on tap);   ************
        ===============================================================================*/
        app.initClickEvents = function () {
            function handleScrollTop(e) {
                /*jshint validthis:true */
                var clicked = $(this);
                var target = $(e.target);
                var isLink = clicked[0].nodeName.toLowerCase() === 'a' ||
                             clicked.parents('a').length > 0 ||
                             target[0].nodeName.toLowerCase() === 'a' ||
                             target.parents('a').length > 0;
        
                if (isLink) return;
                var pageContent, page;
                if (app.params.scrollTopOnNavbarClick && clicked.is('.navbar .center')) {
                    // Find active page
                    var navbar = clicked.parents('.navbar');
        
                    // Static Layout
                    pageContent = navbar.parents('.page-content');
        
                    if (pageContent.length === 0) {
                        // Fixed Layout
                        if (navbar.parents('.page').length > 0) {
                            pageContent = navbar.parents('.page').find('.page-content');
                        }
                        // Through Layout
                        if (pageContent.length === 0) {
                            if (navbar.nextAll('.pages').length > 0) {
                                pageContent = navbar.nextAll('.pages').find('.page:not(.page-on-left):not(.page-on-right):not(.cached)').find('.page-content');
                            }
                        }
                    }
                }
                if (app.params.scrollTopOnStatusbarClick && clicked.is('.statusbar-overlay')) {
                    if ($('.popup.modal-in').length > 0) {
                        // Check for opened popup
                        pageContent = $('.popup.modal-in').find('.page:not(.page-on-left):not(.page-on-right):not(.cached)').find('.page-content');
                    }
                    else if ($('.panel.active').length > 0) {
                        // Check for opened panel
                        pageContent = $('.panel.active').find('.page:not(.page-on-left):not(.page-on-right):not(.cached)').find('.page-content');
                    }
                    else if ($('.views > .view.active').length > 0) {
                        // View in tab bar app layout
                        pageContent = $('.views > .view.active').find('.page:not(.page-on-left):not(.page-on-right):not(.cached)').find('.page-content');
                    }
                    else {
                        // Usual case
                        pageContent = $('.views').find('.page:not(.page-on-left):not(.page-on-right):not(.cached)').find('.page-content');
                    }
                }
        
                if (pageContent && pageContent.length > 0) {
                    // Check for tab
                    if (pageContent.hasClass('tab')) {
                        pageContent = pageContent.parent('.tabs').children('.page-content.active');
                    }
                    if (pageContent.length > 0) pageContent.scrollTop(0, 300);
                }
            }
            function handleClicks(e) {
                /*jshint validthis:true */
                var clicked = $(this);
                var url = clicked.attr('href');
                var isLink = clicked[0].nodeName.toLowerCase() === 'a';
        
                // Check if link is external
                if (isLink) {
                    if (clicked.is(app.params.externalLinks) || (url && url.indexOf('javascript:') >= 0)) {
                        if(url && clicked.attr('target') === '_system') {
                            e.preventDefault();
                            window.open(url, '_system');
                        }
                        return;
                    }
                }
        
                // Collect Clicked data- attributes
                var clickedData = clicked.dataset();
        
                // Smart Select
                if (clicked.hasClass('smart-select')) {
                    if (app.smartSelectOpen) app.smartSelectOpen(clicked);
                }
        
                // Open Panel
                if (clicked.hasClass('open-panel')) {
                    if ($('.panel').length === 1) {
                        if ($('.panel').hasClass('panel-left')) app.openPanel('left');
                        else app.openPanel('right');
                    }
                    else {
                        if (clickedData.panel === 'right') app.openPanel('right');
                        else app.openPanel('left');
                    }
                }
                // Close Panel
                if (clicked.hasClass('close-panel')) {
                    app.closePanel();
                }
        
                if (clicked.hasClass('panel-overlay') && app.params.panelsCloseByOutside) {
                    app.closePanel();
                }
                // Popover
                if (clicked.hasClass('open-popover')) {
                    var popover;
                    if (clickedData.popover) {
                        popover = clickedData.popover;
                    }
                    else popover = '.popover';
                    app.popover(popover, clicked);
                }
                if (clicked.hasClass('close-popover')) {
                    app.closeModal('.popover.modal-in');
                }
                // Popup
                var popup;
                if (clicked.hasClass('open-popup')) {
                    if (clickedData.popup) {
                        popup = clickedData.popup;
                    }
                    else popup = '.popup';
                    app.popup(popup);
                }
                if (clicked.hasClass('close-popup')) {
                    if (clickedData.popup) {
                        popup = clickedData.popup;
                    }
                    else popup = '.popup.modal-in';
                    app.closeModal(popup);
                }
                // Login Screen
                var loginScreen;
                if (clicked.hasClass('open-login-screen')) {
                    if (clickedData.loginScreen) {
                        loginScreen = clickedData.loginScreen;
                    }
                    else loginScreen = '.login-screen';
                    app.loginScreen(loginScreen);
                }
                if (clicked.hasClass('close-login-screen')) {
                    app.closeModal('.login-screen.modal-in');
                }
                // Close Modal
                if (clicked.hasClass('modal-overlay')) {
                    if ($('.modal.modal-in').length > 0 && app.params.modalCloseByOutside)
                        app.closeModal('.modal.modal-in');
                    if ($('.actions-modal.modal-in').length > 0 && app.params.actionsCloseByOutside)
                        app.closeModal('.actions-modal.modal-in');
        
                    if ($('.popover.modal-in').length > 0) app.closeModal('.popover.modal-in');
                }
                if (clicked.hasClass('popup-overlay')) {
                    if ($('.popup.modal-in').length > 0 && app.params.popupCloseByOutside)
                        app.closeModal('.popup.modal-in');
                }
                if (clicked.hasClass('picker-modal-overlay')) {
                    if ($('.picker-modal.modal-in').length > 0)
                        app.closeModal('.picker-modal.modal-in');
                }
        
                // Picker
                if (clicked.hasClass('close-picker')) {
                    var pickerToClose = $('.picker-modal.modal-in');
                    if (pickerToClose.length > 0) {
                        app.closeModal(pickerToClose);
                    }
                    else {
                        pickerToClose = $('.popover.modal-in .picker-modal');
                        if (pickerToClose.length > 0) {
                            app.closeModal(pickerToClose.parents('.popover'));
                        }
                    }
                }
                if (clicked.hasClass('open-picker')) {
                    var pickerToOpen;
                    if (clickedData.picker) {
                        pickerToOpen = clickedData.picker;
                    }
                    else pickerToOpen = '.picker-modal';
                    app.pickerModal(pickerToOpen, clicked);
                }
        
                // Tabs
                var isTabLink;
                if (clicked.hasClass('tab-link')) {
                    isTabLink = true;
                    app.showTab(clickedData.tab || clicked.attr('href'), clicked);
                }
                // Swipeout Close
                if (clicked.hasClass('swipeout-close')) {
                    app.swipeoutClose(clicked.parents('.swipeout-opened'));
                }
                // Swipeout Delete
                if (clicked.hasClass('swipeout-delete')) {
                    if (clickedData.confirm) {
                        var text = clickedData.confirm;
                        var title = clickedData.confirmTitle;
                        if (title) {
                            app.confirm(text, title, function () {
                                app.swipeoutDelete(clicked.parents('.swipeout'));
                            }, function () {
                                if (clickedData.closeOnCancel) app.swipeoutClose(clicked.parents('.swipeout'));
                            });
                        }
                        else {
                            app.confirm(text, function () {
                                app.swipeoutDelete(clicked.parents('.swipeout'));
                            }, function () {
                                if (clickedData.closeOnCancel) app.swipeoutClose(clicked.parents('.swipeout'));
                            });
                        }
                    }
                    else {
                        app.swipeoutDelete(clicked.parents('.swipeout'));
                    }
        
                }
                // Sortable
                if (clicked.hasClass('toggle-sortable')) {
                    app.sortableToggle(clickedData.sortable);
                }
                if (clicked.hasClass('open-sortable')) {
                    app.sortableOpen(clickedData.sortable);
                }
                if (clicked.hasClass('close-sortable')) {
                    app.sortableClose(clickedData.sortable);
                }
                // Accordion
                if (clicked.hasClass('accordion-item-toggle') || (clicked.hasClass('item-link') && clicked.parent().hasClass('accordion-item'))) {
                    var accordionItem = clicked.parent('.accordion-item');
                    if (accordionItem.length === 0) accordionItem = clicked.parents('.accordion-item');
                    if (accordionItem.length === 0) accordionItem = clicked.parents('li');
                    app.accordionToggle(accordionItem);
                }
        
                // Speed Dial
                if (app.params.material) {
                    if (clicked.hasClass('floating-button') && clicked.parent().hasClass('speed-dial')) {
                        clicked.parent().toggleClass('speed-dial-opened');
                    }
                    if (clicked.hasClass('close-speed-dial')) {
                        $('.speed-dial-opened').removeClass('speed-dial-opened');
                    }
                }
        
                // Load Page
                if (app.params.ajaxLinks && !clicked.is(app.params.ajaxLinks) || !isLink || !app.params.router) {
                    return;
                }
                if (isLink) {
                    e.preventDefault();
                }
        
                var validUrl = url && url.length > 0 && url !== '#' && !isTabLink;
                var template = clickedData.template;
                if (validUrl || clicked.hasClass('back') || template) {
                    var view;
                    if (clickedData.view) {
                        view = $(clickedData.view)[0].f7View;
                    }
                    else {
                        view = clicked.parents('.' + app.params.viewClass)[0] && clicked.parents('.' + app.params.viewClass)[0].f7View;
                        if (view && view.params.linksView) {
                            if (typeof view.params.linksView === 'string') view = $(view.params.linksView)[0].f7View;
                            else if (view.params.linksView instanceof View) view = view.params.linksView;
                        }
                    }
                    if (!view) {
                        if (app.mainView) view = app.mainView;
                    }
                    if (!view) return;
        
                    var pageName;
                    if (!template) {
                        if (url.indexOf('#') === 0 && url !== '#')  {
                            if (view.params.domCache) {
                                pageName = url.split('#')[1];
                            }
                            else return;
                        }
                        if (url === '#' && !clicked.hasClass('back')) return;
                    }
                    else {
                        url = undefined;
                    }
        
                    var animatePages;
                    if (typeof clickedData.animatePages !== 'undefined') {
                        animatePages = clickedData.animatePages;
                    }
                    else {
                        if (clicked.hasClass('with-animation')) animatePages = true;
                        if (clicked.hasClass('no-animation')) animatePages = false;
                    }
        
                    var options = {
                        animatePages: animatePages,
                        ignoreCache: clickedData.ignoreCache,
                        force: clickedData.force,
                        reload: clickedData.reload,
                        reloadPrevious: clickedData.reloadPrevious,
                        pageName: pageName,
                        pushState: clickedData.pushState,
                        url: url
                    };
        
                    if (app.params.template7Pages) {
                        options.contextName = clickedData.contextName;
                        var context = clickedData.context;
                        if (context) {
                            options.context = JSON.parse(context);
                        }
                    }
                    if (template && template in t7.templates) {
                        options.template = t7.templates[template];
                    }
        
                    if (clicked.hasClass('back')) view.router.back(options);
                    else view.router.load(options);
                }
            }
            $(document).on('click', 'a, .open-panel, .close-panel, .panel-overlay, .modal-overlay, .popup-overlay, .swipeout-delete, .swipeout-close, .close-popup, .open-popup, .open-popover, .open-login-screen, .close-login-screen .smart-select, .toggle-sortable, .open-sortable, .close-sortable, .accordion-item-toggle, .close-picker, .picker-modal-overlay', handleClicks);
            if (app.params.scrollTopOnNavbarClick || app.params.scrollTopOnStatusbarClick) {
                $(document).on('click', '.statusbar-overlay, .navbar .center', handleScrollTop);
            }
        
            // Prevent scrolling on overlays
            function preventScrolling(e) {
                e.preventDefault();
            }
            if (app.support.touch && !app.device.android) {
                $(document).on((app.params.fastClicks ? 'touchstart' : 'touchmove'), '.panel-overlay, .modal-overlay, .preloader-indicator-overlay, .popup-overlay, .searchbar-overlay', preventScrolling);
            }
        };
        

        /*======================================================
        ************   App Resize Actions   ************
        ======================================================*/
        // Prevent iPad horizontal body scrolling when soft keyboard is opened
        function _fixIpadBodyScrolLeft() {
            if (app.device.ipad) {
                document.body.scrollLeft = 0;
                setTimeout(function () {
                    document.body.scrollLeft = 0;
                }, 0);
            }
        }
        app.initResize = function () {
            $(window).on('resize', app.resize);
            $(window).on('orientationchange', app.orientationchange);
        };
        app.resize = function () {
            if (app.sizeNavbars) app.sizeNavbars();
            _fixIpadBodyScrolLeft();
            
        };
        app.orientationchange = function () {
            if (app.device && app.device.minimalUi) {
                if (window.orientation === 90 || window.orientation === -90) document.body.scrollTop = 0;
            }
            _fixIpadBodyScrolLeft();
        };
        

        /*===============================================================================
        ************   Store and parse forms data   ************
        ===============================================================================*/
        app.formsData = {};
        app.formStoreData = function (formId, formJSON) {
            // Store form data in app.formsData
            app.formsData[formId] = formJSON;
        
            // Store form data in local storage also
            app.ls['f7form-' + formId] = JSON.stringify(formJSON);
        };
        app.formDeleteData = function (formId) {
            // Delete form data from app.formsData
            if (app.formsData[formId]) {
                app.formsData[formId] = '';
                delete app.formsData[formId];
            }
        
            // Delete form data from local storage also
            if (app.ls['f7form-' + formId]) {
                app.ls['f7form-' + formId] = '';
                app.ls.removeItem('f7form-' + formId);
            }
        };
        app.formGetData = function (formId) {
            // First of all check in local storage
            if (app.ls['f7form-' + formId]) {
                return JSON.parse(app.ls['f7form-' + formId]);
            }
            // Try to get it from formsData obj
            else if (app.formsData[formId]) return app.formsData[formId];
        };
        app.formToJSON = function (form) {
            form = $(form);
            if (form.length !== 1) return false;
        
            // Form data
            var formData = {};
        
            // Skip input types
            var skipTypes = ['submit', 'image', 'button', 'file'];
            var skipNames = [];
            form.find('input, select, textarea').each(function () {
                var input = $(this);
                var name = input.attr('name');
                var type = input.attr('type');
                var tag = this.nodeName.toLowerCase();
                if (skipTypes.indexOf(type) >= 0) return;
                if (skipNames.indexOf(name) >= 0 || !name) return;
                if (tag === 'select' && input.prop('multiple')) {
                    skipNames.push(name);
                    formData[name] = [];
                    form.find('select[name="' + name + '"] option').each(function () {
                        if (this.selected) formData[name].push(this.value);
                    });
                }
                else {
                    switch (type) {
                        case 'checkbox' :
                            skipNames.push(name);
                            formData[name] = [];
                            form.find('input[name="' + name + '"]').each(function () {
                                if (this.checked) formData[name].push(this.value);
                            });
                            break;
                        case 'radio' :
                            skipNames.push(name);
                            form.find('input[name="' + name + '"]').each(function () {
                                if (this.checked) formData[name] = this.value;
                            });
                            break;
                        default :
                            formData[name] = input.val();
                            break;
                    }
                }
                    
            });
            form.trigger('formToJSON', {formData: formData});
        
            return formData;
        };
        app.formFromJSON = function (form, formData) {
            form = $(form);
            if (form.length !== 1) return false;
        
            // Skip input types
            var skipTypes = ['submit', 'image', 'button', 'file'];
            var skipNames = [];
        
            form.find('input, select, textarea').each(function () {
                var input = $(this);
                var name = input.attr('name');
                var type = input.attr('type');
                var tag = this.nodeName.toLowerCase();
                if (!formData[name]) return;
                if (skipTypes.indexOf(type) >= 0) return;
                if (skipNames.indexOf(name) >= 0 || !name) return;
                if (tag === 'select' && input.prop('multiple')) {
                    skipNames.push(name);
                    form.find('select[name="' + name + '"] option').each(function () {
                        if (formData[name].indexOf(this.value) >= 0) this.selected = true;
                        else this.selected = false;
                    });
                }
                else {
                    switch (type) {
                        case 'checkbox' :
                            skipNames.push(name);
                            form.find('input[name="' + name + '"]').each(function () {
                                if (formData[name].indexOf(this.value) >= 0) this.checked = true;
                                else this.checked = false;
                            });
                            break;
                        case 'radio' :
                            skipNames.push(name);
                            form.find('input[name="' + name + '"]').each(function () {
                                if (formData[name] === this.value) this.checked = true;
                                else this.checked = false;
                            });
                            break;
                        default :
                            input.val(formData[name]);
                            break;
                    }
                }
                    
            });
            form.trigger('formFromJSON', {formData: formData});
        };
        app.initFormsStorage = function (pageContainer) {
            pageContainer = $(pageContainer);
            var forms = pageContainer.find('form.store-data');
            if (forms.length === 0) return;
            
            // Parse forms data and fill form if there is such data
            forms.each(function () {
                var id = this.getAttribute('id');
                if (!id) return;
                var formData = app.formGetData(id);
                if (formData) app.formFromJSON(this, formData);
            });
            // Update forms data on inputs change
            function storeForm() {
                /*jshint validthis:true */
                var form = $(this);
                var formId = form[0].id;
                if (!formId) return;
                var formJSON = app.formToJSON(form);
                if (!formJSON) return;
                app.formStoreData(formId, formJSON);
                form.trigger('store', {data: formJSON});
            }
            forms.on('change submit', storeForm);
        
            // Detach Listeners
            function pageBeforeRemove() {
                forms.off('change submit', storeForm);
                pageContainer.off('pageBeforeRemove', pageBeforeRemove);
            }
            pageContainer.on('pageBeforeRemove', pageBeforeRemove);
        };

        /*===============================================================================
        ************   Ajax submit for forms   ************
        ===============================================================================*/
        // Ajax submit on forms
        $(document).on('submit change', 'form.ajax-submit, form.ajax-submit-onchange', function (e) {
            var form = $(this);
            if (e.type === 'change' && !form.hasClass('ajax-submit-onchange')) return;
            if (e.type === 'submit') e.preventDefault();
            
            var method = form.attr('method') || 'GET';
            var contentType = form.prop('enctype') || form.attr('enctype');
        
            var url = form.attr('action');
            if (!url) return;
        
            var data;
            if (method === 'POST') data = new FormData(form[0]);
            else data = $.serializeObject(app.formToJSON(form[0]));
        
            var xhr = $.ajax({
                method: method,
                url: url,
                contentType: contentType,
                data: data,
                beforeSend: function (xhr) {
                    form.trigger('beforeSubmit', {data:data, xhr: xhr});
                },
                error: function (xhr) {
                    form.trigger('submitError', {data:data, xhr: xhr});  
                },
                success: function (data) {
                    form.trigger('submitted', {data: data, xhr: xhr});
                }
            });
        });
        
        

        /*===============================================================================
        ************   Resizable textarea   ************
        ===============================================================================*/
        app.resizeTextarea = function (textarea) {
            textarea = $(textarea);
            if (!textarea.hasClass('resizable')) {
                return;
            }
            textarea.css({'height': ''});
            var height = textarea[0].offsetHeight;
            var diff = height - textarea[0].clientHeight;
            var scrollHeight = textarea[0].scrollHeight;
        
            if (scrollHeight + diff > height) {
                var newAreaHeight = scrollHeight + diff;
                textarea.css('height', newAreaHeight + 'px');
            }
        };
        app.resizableTextarea = function (textarea) {
            textarea = $(textarea);
            if (textarea.length === 0) return;
            var textareaTimeout;
            function handleTextarea() {
                clearTimeout(textareaTimeout);
                textareaTimeout = setTimeout(function () {
                    app.resizeTextarea(textarea);
                }, 0);
            }
            textarea[0].f7DestroyResizableTextarea = function () {
                textarea.off('change keydown keypress keyup paste cut', handleTextarea);
            };
            return textarea.on('change keydown keypress keyup paste cut', handleTextarea);
        };
        app.destroyResizableTextarea = function (pageContainer) {
            pageContainer = $(pageContainer);
            if (pageContainer.length > 0 && pageContainer.is('textarea') && pageContainer[0].f7DestroyResizableTextarea) {
                pageContainer[0].f7DestroyResizableTextarea();
            }
            else if (pageContainer.length > 0) {
                pageContainer.find('textarea.resiable').each(function () {
                    var textarea = this;
                    if (textarea.f7DestroyResizableTextarea) {
                        textarea.f7DestroyResizableTextarea ();
                    }
                });
            }
        };
        app.initPageResizableTextarea = function (pageContainer) {
            pageContainer = $(pageContainer);
            var textareas = pageContainer.find('textarea.resizable');
            textareas.each(function () {
                app.resizableTextarea(this);
            });
        };

        /*======================================================
        ************   Material Text Inputs   ************
        ======================================================*/
        app.initPageMaterialInputs = function (pageContainer) {
            pageContainer = $(pageContainer);
            var textareas = pageContainer.find('textarea.resizable');
            pageContainer.find('.item-input').each(function () {
                var itemInput = $(this);
                var notInputs = ['checkbox', 'button', 'submit', 'range', 'radio', 'image'];
                itemInput.find('input, select, textarea').each(function () {
                    var input = $(this);
                    if (notInputs.indexOf(input.attr('type')) < 0) {
                        itemInput.addClass('item-input-field');
                        if (input.val().trim() !== '') {
                            input.parents('.item-input, .input-field').add(input.parents('.item-inner')).addClass('not-empty-state');
                        }
                    }
                });
                if (itemInput.parents('.input-item, .inputs-list').length > 0) return;
                itemInput.parents('.list-block').eq(0).addClass('inputs-list');
            });
        };
        /*======================================================
        ************   Material Focus Inputs   ************
        ======================================================*/
        app.initMaterialWatchInputs = function () {
            var notInputs = ['checkbox', 'button', 'submit', 'range', 'radio', 'image'];
            function addFocusState(e) {
                /*jshint validthis:true*/
                var i = $(this);
                var type = i.attr('type');
                if (notInputs.indexOf(type) >= 0) return;
                var els = i.add(i.parents('.item-input, .input-field')).add(i.parents('.item-inner').eq(0));
                els.addClass('focus-state');
            }
            function removeFocusState(e) {
                /*jshint validthis:true*/
                var i = $(this), value = i.val();
                var type = i.attr('type');
                if (notInputs.indexOf(type) >= 0) return;
                var els = i.add(i.parents('.item-input, .input-field')).add(i.parents('.item-inner').eq(0));
                els.removeClass('focus-state');
                if (value && value.trim() !== '') {
                    els.addClass('not-empty-state');
                }
                else {
                    els.removeClass('not-empty-state');
                }
            }
            function watchChangeState(e) {
                /*jshint validthis:true*/
                var i = $(this), value = i.val();
                var type = i.attr('type');
                if (notInputs.indexOf(type) >= 0) return;
                var els = i.add(i.parents('.item-input, .input-field')).add(i.parents('.item-inner').eq(0));
                if (value && value.trim() !== '') {
                    els.addClass('not-empty-state');
                }
                else {
                    els.removeClass('not-empty-state');
                }
            }
            $(document).on('change', '.item-input input, .item-input select, .item-input textarea, input, textarea, select', watchChangeState, true);
            $(document).on('focus', '.item-input input, .item-input select, .item-input textarea, input, textarea, select', addFocusState, true);
            $(document).on('blur', '.item-input input, .item-input select, .item-input textarea, input, textarea, select', removeFocusState, true);
        };

        /*======================================================
        ************   Handle Browser's History   ************
        ======================================================*/
        app.pushStateQueue = [];
        app.pushStateClearQueue = function () {
            if (app.pushStateQueue.length === 0) return;
            var queue = app.pushStateQueue.pop();
            var animatePages;
            if (app.params.pushStateNoAnimation === true) animatePages = false;
            if (queue.action === 'back') {
                app.router.back(queue.view, {animatePages: animatePages});
            }
            if (queue.action === 'loadPage') {
                app.router.load(queue.view, {url: queue.stateUrl, animatePages: animatePages, pushState: false});
            }
            if (queue.action === 'loadContent') {
                app.router.load(queue.view, {content: queue.stateContent, animatePages: animatePages, pushState: false});
            }
            if (queue.action === 'loadPageName') {
                app.router.load(queue.view, {pageName: queue.statePageName, url: queue.stateUrl, animatePages: animatePages, pushState: false});
            }
        };
        
        app.initPushState = function () {
            var blockPopstate = true;
            $(window).on('load', function () {
                setTimeout(function () {
                    blockPopstate = false;
                }, 0);
            });
        
            if (document.readyState && document.readyState === 'complete') {
                blockPopstate = false;
            }
        
            function handlePopState(e) {
                if (blockPopstate) return;
                var mainView = app.mainView;
                if (!mainView) return;
                var state = e.state;
                if (!state) {
                    state = {
                        viewIndex: app.views.indexOf(mainView),
                        url : mainView.history[0]
                    };
                }
                if (state.viewIndex < 0) return;
                var view = app.views[state.viewIndex];
                var stateUrl = state && state.url || undefined;
                var stateContent = state && state.content || undefined;
                var statePageName = state && state.pageName || undefined;
                var animatePages;
        
                if (app.params.pushStateNoAnimation === true) animatePages = false;
        
                if (stateUrl !== view.url) {
                    if (view.history.indexOf(stateUrl) >= 0) {
                        // Go Back
                        if (view.allowPageChange) {
                            app.router.back(view, {url:undefined, animatePages: animatePages, pushState: false, preloadOnly:false});
                        }
                        else {
                            app.pushStateQueue.push({
                                action: 'back',
                                view: view
                            });
                        }
                    }
                    else if (stateContent) {
                        // Load Page
                        if (view.allowPageChange) {
                            app.router.load(view, {content:stateContent, animatePages: animatePages, pushState: false});
                        }
                        else {
                            app.pushStateQueue.unshift({
                                action: 'loadContent',
                                stateContent: stateContent,
                                view: view
                            });
                        }
        
                    }
                    else if (statePageName) {
                        // Load Page by page name with Dom Cache
                        if (view.allowPageChange) {
                            app.router.load(view, {pageName:statePageName, url: stateUrl, animatePages: animatePages, pushState: false});
                        }
                        else {
                            app.pushStateQueue.unshift({
                                action: 'loadPageName',
                                statePageName: statePageName,
                                view: view
                            });
                        }
                    }
                    else  {
                        // Load Page
                        if (view.allowPageChange) {
                            app.router.load(view, {url:stateUrl, animatePages: animatePages, pushState: false});
                        }
                        else {
                            app.pushStateQueue.unshift({
                                action: 'loadPage',
                                stateUrl: stateUrl,
                                view: view
                            });
                        }
                    }
                }
            }
            $(window).on('popstate', handlePopState);
        };
        

        /*===========================
        Framework7 Swiper Additions
        ===========================*/
        app.swiper = function (container, params) {
            return new Swiper(container, params);
        };
        app.initPageSwiper = function (pageContainer) {
            pageContainer = $(pageContainer);
            var swipers = pageContainer.find('.swiper-init, .tabs-swipeable-wrap');
            if (swipers.length === 0) return;
            function destroySwiperOnRemove(slider) {
                function destroySwiper() {
                    slider.destroy();
                    pageContainer.off('pageBeforeRemove', destroySwiper);
                }
                pageContainer.on('pageBeforeRemove', destroySwiper);
            }
            swipers.each(function () {
                var swiper = $(this);
                if (swiper.hasClass('tabs-swipeable-wrap')) {
                    swiper.addClass('swiper-container').children('.tabs').addClass('swiper-wrapper').children('.tab').addClass('swiper-slide');
                }
                var params;
                if (swiper.data('swiper')) {
                    params = JSON.parse(swiper.data('swiper'));
                }
                else {
                    params = swiper.dataset();
                }
                if (swiper.hasClass('tabs-swipeable-wrap')) {
                    params.onSlideChangeStart = function (s) {
                        app.showTab(s.slides.eq(s.activeIndex));
                    };
                }
                var _slider = app.swiper(swiper[0], params);
                destroySwiperOnRemove(_slider);
            });
        };
        app.reinitPageSwiper = function (pageContainer) {
            pageContainer = $(pageContainer);
            var sliders = pageContainer.find('.swiper-init, .tabs-swipeable-wrap');
            if (sliders.length === 0) return;
            for (var i = 0; i < sliders.length; i++) {
                var sliderInstance = sliders[0].swiper;
                if (sliderInstance) {
                    sliderInstance.update(true);
                }
            }
        };
        

        /*======================================================
        ************   Photo Browser   ************
        ======================================================*/
        var PhotoBrowser = function (params) {
            var pb = this, i;
        
            var defaults = {
                photos : [],
                initialSlide: 0,
                spaceBetween: 20,
                speed: 300,
                zoom: true,
                maxZoom: 3,
                minZoom: 1,
                exposition: true,
                expositionHideCaptions: false,
                type: 'standalone',
                navbar: true,
                toolbar: true,
                theme: 'light',
                swipeToClose: true,
                backLinkText: 'Close',
                ofText: 'of',
                loop: false,
                lazyLoading: false,
                lazyLoadingInPrevNext: false,
                lazyLoadingOnTransitionStart: false,
                material: app.params.material,
                materialPreloaderSvg: app.params.materialPreloaderSvg,
                materialPreloaderHtml: app.params.materialPreloaderHtml,
                /*
                Callbacks:
                onLazyImageLoad(pb, slide, img)
                onLazyImageReady(pb, slide, img)
                onOpen(pb)
                onClose(pb)
                onTransitionStart(swiper)
                onTransitionEnd(swiper)
                onSlideChangeStart(swiper)
                onSlideChangeEnd(swiper)
                onTap(swiper, e)
                onClick(swiper, e)
                onDoubleTap(swiper, e)
                onSwipeToClose(pb)
                */
            };
            
            params = params || {};
            if (!params.backLinkText && app.params.material) defaults.backLinkText = '';
            for (var def in defaults) {
                if (typeof params[def] === 'undefined') {
                    params[def] = defaults[def];
                }
            }
        
            pb.params = params;
            pb.params.iconsColorClass = pb.params.iconsColor ? 'color-' + pb.params.iconsColor : (pb.params.theme === 'dark' ? 'color-white' : '');
            pb.params.preloaderColorClass = pb.params.theme === 'dark' ? 'preloader-white' : '';
        
            // Templates
            var photoTemplate = pb.params.photoTemplate || 
                '<div class="photo-browser-slide swiper-slide">' +
                    '<span class="photo-browser-zoom-container">' +
                        '<img src="{{js "this.url || this"}}">' +
                    '</span>' +
                '</div>';
            var photoLazyTemplate = pb.params.lazyPhotoTemplate ||
                '<div class="photo-browser-slide photo-browser-slide-lazy swiper-slide">' +
                    '<div class="preloader {{@root.preloaderColorClass}}">{{#if @root.material}}{{@root.materialPreloaderHtml}}{{/if}}</div>' +
                    '<span class="photo-browser-zoom-container">' +
                        '<img data-src="{{js "this.url || this"}}" class="swiper-lazy">' +
                    '</span>' +
                '</div>';
            var objectTemplate = pb.params.objectTemplate ||
                '<div class="photo-browser-slide photo-browser-object-slide swiper-slide">{{js "this.html || this"}}</div>';
            var captionTemplate = pb.params.captionTemplate ||
                '<div class="photo-browser-caption" data-caption-index="{{@index}}">' +
                    '{{caption}}' +
                '</div>';
            var navbarTemplate = pb.params.navbarTemplate ||
                '<div class="navbar">' +
                    '<div class="navbar-inner">' +
                        '<div class="left sliding">' +
                            '<a href="#" class="link close-popup photo-browser-close-link {{#unless backLinkText}}icon-only{{/unless}} {{js "this.type === \'page\' ? \'back\' : \'\'"}}">' +
                                '<i class="icon icon-back {{iconsColorClass}}"></i>' +
                                '{{#if backLinkText}}<span>{{backLinkText}}</span>{{/if}}' +
                            '</a>' +
                        '</div>' +
                        '<div class="center sliding">' +
                            '<span class="photo-browser-current"></span> ' +
                            '<span class="photo-browser-of">{{ofText}}</span> ' +
                            '<span class="photo-browser-total"></span>' +
                        '</div>' +
                        '<div class="right"></div>' +
                    '</div>' +
                '</div>';
            var toolbarTemplate = pb.params.toolbarTemplate ||
                '<div class="toolbar tabbar">' +
                    '<div class="toolbar-inner">' +
                        '<a href="#" class="link photo-browser-prev">' +
                            '<i class="icon icon-prev {{iconsColorClass}}"></i>' +
                        '</a>' +
                        '<a href="#" class="link photo-browser-next">' +
                            '<i class="icon icon-next {{iconsColorClass}}"></i>' +
                        '</a>' +
                    '</div>' +
                '</div>';
        
            var htmlTemplate = t7.compile('<div class="photo-browser photo-browser-{{theme}}">' +
                    '<div class="view navbar-fixed toolbar-fixed">' +
                        '{{#unless material}}{{#if navbar}}' +
                        navbarTemplate +
                        '{{/if}}{{/unless}}' +
                        '<div class="page no-toolbar {{#unless navbar}}no-navbar{{/unless}} toolbar-fixed navbar-fixed" data-page="photo-browser-slides">' +
                            '{{#if material}}{{#if navbar}}' +
                            navbarTemplate +
                            '{{/if}}{{/if}}' +
                            '{{#if toolbar}}' +
                            toolbarTemplate +
                            '{{/if}}' +
                            '<div class="photo-browser-captions photo-browser-captions-{{js "this.captionsTheme || this.theme"}}">' +
                                '{{#each photos}}{{#if caption}}' +
                                captionTemplate +
                                '{{/if}}{{/each}}' +
                            '</div>' +
                            '<div class="photo-browser-swiper-container swiper-container">' +
                                '<div class="photo-browser-swiper-wrapper swiper-wrapper">' +
                                    '{{#each photos}}' +
                                    '{{#js_compare "this.html || ((typeof this === \'string\' || this instanceof String) && (this.indexOf(\'<\') >= 0 || this.indexOf(\'>\') >= 0))"}}' +
                                        objectTemplate +
                                    '{{else}}' +
                                        '{{#if @root.lazyLoading}}' +
                                        photoLazyTemplate +
                                        '{{else}}' +
                                        photoTemplate +
                                        '{{/if}}' +
                                    '{{/js_compare}}' +
                                    '{{/each}}' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>')(pb.params);
        
            pb.activeIndex = pb.params.initialSlide;
            pb.openIndex = pb.activeIndex;
            pb.opened = false;
        
            pb.open = function (index) {
                if (typeof index === 'undefined') index = pb.activeIndex;
                index = parseInt(index, 10);
                if (pb.opened && pb.swiper) {
                    pb.swiper.slideTo(index);
                    return;
                }
                pb.opened = true;
                pb.openIndex = index;
                if (pb.params.type === 'standalone') {
                    $('body').append(htmlTemplate);
                }
                if (pb.params.type === 'popup') {
                    pb.popup = app.popup('<div class="popup photo-browser-popup">' + htmlTemplate + '</div>');
                    $(pb.popup).on('closed', pb.onPopupClose);
                }
                if (pb.params.type === 'page') {
                    $(document).on('pageBeforeInit', pb.onPageBeforeInit);
                    $(document).on('pageBeforeRemove', pb.onPageBeforeRemove);
                    if (!pb.params.view) pb.params.view = app.mainView;
                    pb.params.view.loadContent(htmlTemplate);
                    return;
                }
                pb.layout(pb.openIndex);
                if (pb.params.onOpen) {
                    pb.params.onOpen(pb);
                }
        
            };
            pb.close = function () {
                pb.opened = false;
                if (!pb.swiperContainer || pb.swiperContainer.length === 0) {
                    return;
                }
                if (pb.params.onClose) {
                    pb.params.onClose(pb);
                }
                // Detach events
                pb.attachEvents(true);
                // Delete from DOM
                if (pb.params.type === 'standalone') {
                    pb.container.removeClass('photo-browser-in').addClass('photo-browser-out').animationEnd(function () {
                        pb.container.remove();
                    });
                }
                // Destroy slider
                pb.swiper.destroy();
                // Delete references
                pb.swiper = pb.swiperContainer = pb.swiperWrapper = pb.slides = gestureSlide = gestureImg = gestureImgWrap = undefined;
            };
        
            pb.onPopupClose = function (e) {
                pb.close();
                $(pb.popup).off('pageBeforeInit', pb.onPopupClose);
            };
            pb.onPageBeforeInit = function (e) {
                if (e.detail.page.name === 'photo-browser-slides') {
                    pb.layout(pb.openIndex);
                }
                $(document).off('pageBeforeInit', pb.onPageBeforeInit);
            };
            pb.onPageBeforeRemove = function (e) {
                if (e.detail.page.name === 'photo-browser-slides') {
                    pb.close();
                }
                $(document).off('pageBeforeRemove', pb.onPageBeforeRemove);
            };
        
            pb.onSliderTransitionStart = function (swiper) {
                pb.activeIndex = swiper.activeIndex;
        
                var current = swiper.activeIndex + 1;
                var total = swiper.slides.length;
                if (pb.params.loop) {
                    total = total - 2;
                    current = current - swiper.loopedSlides;
                    if (current < 1) current = total + current;
                    if (current > total) current = current - total;
                }
                pb.container.find('.photo-browser-current').text(current);
                pb.container.find('.photo-browser-total').text(total);
        
                $('.photo-browser-prev, .photo-browser-next').removeClass('photo-browser-link-inactive');
                
                if (swiper.isBeginning && !pb.params.loop) {
                    $('.photo-browser-prev').addClass('photo-browser-link-inactive');
                }
                if (swiper.isEnd && !pb.params.loop) {
                    $('.photo-browser-next').addClass('photo-browser-link-inactive');
                }
        
                // Update captions
                if (pb.captions.length > 0) {
                    pb.captionsContainer.find('.photo-browser-caption-active').removeClass('photo-browser-caption-active');
                    var captionIndex = pb.params.loop ? swiper.slides.eq(swiper.activeIndex).attr('data-swiper-slide-index') : pb.activeIndex;
                    pb.captionsContainer.find('[data-caption-index="' + captionIndex + '"]').addClass('photo-browser-caption-active');
                }
        
        
                // Stop Video
                var previousSlideVideo = swiper.slides.eq(swiper.previousIndex).find('video');
                if (previousSlideVideo.length > 0) {
                    if ('pause' in previousSlideVideo[0]) previousSlideVideo[0].pause();
                }
                // Callback
                if (pb.params.onTransitionStart) pb.params.onTransitionStart(swiper);
            };
            pb.onSliderTransitionEnd = function (swiper) {
                // Reset zoom
                if (pb.params.zoom && gestureSlide && swiper.previousIndex !== swiper.activeIndex) {
                    gestureImg.transform('translate3d(0,0,0) scale(1)');
                    gestureImgWrap.transform('translate3d(0,0,0)');
                    gestureSlide = gestureImg = gestureImgWrap = undefined;
                    scale = currentScale = 1;
                }
                if (pb.params.onTransitionEnd) pb.params.onTransitionEnd(swiper);
            };
            
            pb.layout = function (index) {
                if (pb.params.type === 'page') {
                    pb.container = $('.photo-browser-swiper-container').parents('.view');
                }
                else {
                    pb.container = $('.photo-browser');
                }
                if (pb.params.type === 'standalone') {
                    pb.container.addClass('photo-browser-in');
                    app.sizeNavbars(pb.container);
                }
                pb.swiperContainer = pb.container.find('.photo-browser-swiper-container');
                pb.swiperWrapper = pb.container.find('.photo-browser-swiper-wrapper');
                pb.slides = pb.container.find('.photo-browser-slide');
                pb.captionsContainer = pb.container.find('.photo-browser-captions');
                pb.captions = pb.container.find('.photo-browser-caption');
                
                var sliderSettings = {
                    nextButton: pb.params.nextButton || '.photo-browser-next',
                    prevButton: pb.params.prevButton || '.photo-browser-prev',
                    indexButton: pb.params.indexButton,
                    initialSlide: index,
                    spaceBetween: pb.params.spaceBetween,
                    speed: pb.params.speed,
                    loop: pb.params.loop,
                    lazyLoading: pb.params.lazyLoading,
                    lazyLoadingInPrevNext: pb.params.lazyLoadingInPrevNext,
                    lazyLoadingOnTransitionStart: pb.params.lazyLoadingOnTransitionStart,
                    preloadImages: pb.params.lazyLoading ? false : true,
                    onTap: function (swiper, e) {
                        if (pb.params.onTap) pb.params.onTap(swiper, e);
                    },
                    onClick: function (swiper, e) {
                        if (pb.params.exposition) pb.toggleExposition();
                        if (pb.params.onClick) pb.params.onClick(swiper, e);
                    },
                    onDoubleTap: function (swiper, e) {
                        pb.toggleZoom(e);
                        if (pb.params.onDoubleTap) pb.params.onDoubleTap(swiper, e);
                    },
                    onTransitionStart: function (swiper) {
                        pb.onSliderTransitionStart(swiper);
                    },
                    onTransitionEnd: function (swiper) {
                        pb.onSliderTransitionEnd(swiper);  
                    },
                    onSlideChangeStart: pb.params.onSlideChangeStart,
                    onSlideChangeEnd: pb.params.onSlideChangeEnd,
                    onLazyImageLoad: function (swiper, slide, img) {
                        if (pb.params.onLazyImageLoad) pb.params.onLazyImageLoad(pb, slide, img);
                    },
                    onLazyImageReady: function (swiper, slide, img) {
                        $(slide).removeClass('photo-browser-slide-lazy');
                        if (pb.params.onLazyImageReady) pb.params.onLazyImageReady(pb, slide, img);
                    }
                };
        
                if (pb.params.swipeToClose && pb.params.type !== 'page') {
                    sliderSettings.onTouchStart = pb.swipeCloseTouchStart;
                    sliderSettings.onTouchMoveOpposite = pb.swipeCloseTouchMove;
                    sliderSettings.onTouchEnd = pb.swipeCloseTouchEnd;
                }
        
                pb.swiper = app.swiper(pb.swiperContainer, sliderSettings);
                if (index === 0) {
                    pb.onSliderTransitionStart(pb.swiper);
                }
                pb.attachEvents();
            };
            pb.attachEvents = function (detach) {
                var action = detach ? 'off' : 'on';
                // Slide between photos
        
                if (pb.params.zoom) {
                    var target = pb.params.loop ? pb.swiper.slides : pb.slides;
                    // Scale image
                    target[action]('gesturestart', pb.onSlideGestureStart);
                    target[action]('gesturechange', pb.onSlideGestureChange);
                    target[action]('gestureend', pb.onSlideGestureEnd);
        
                    // Move image
                    target[action](app.touchEvents.start, pb.onSlideTouchStart);
                    target[action](app.touchEvents.move, pb.onSlideTouchMove);
                    target[action](app.touchEvents.end, pb.onSlideTouchEnd);
                }
                pb.container.find('.photo-browser-close-link')[action]('click', pb.close);
            };
        
            var isTouched, isMoved, touchesStart = {}, touchesCurrent = {}, touchStartTime, isScrolling, animating = false, currentTranslate;
            var allowClick = true;
        
            // Expose
            pb.exposed = false;
            pb.toggleExposition = function () {
                if (pb.container) pb.container.toggleClass('photo-browser-exposed');
                if (pb.params.expositionHideCaptions) pb.captionsContainer.toggleClass('photo-browser-captions-exposed');
                pb.exposed = !pb.exposed;
            };
            pb.enableExposition = function () {
                if (pb.container) pb.container.addClass('photo-browser-exposed');
                if (pb.params.expositionHideCaptions) pb.captionsContainer.addClass('photo-browser-captions-exposed');
                pb.exposed = true;
            };
            pb.disableExposition = function () {
                if (pb.container) pb.container.removeClass('photo-browser-exposed');
                if (pb.params.expositionHideCaptions) pb.captionsContainer.removeClass('photo-browser-captions-exposed');
                pb.exposed = false;
            };
            
            // Gestures
            var gestureSlide, gestureImg, gestureImgWrap, scale = 1, currentScale = 1, isScaling = false;
            pb.onSlideGestureStart = function (e) {
                if (!gestureSlide || !gestureSlide.length) {
                    gestureSlide = $(this);
                    if (gestureSlide.length === 0) gestureSlide = pb.swiper.slides.eq(pb.swiper.activeIndex);
                    gestureImg = gestureSlide.find('img, svg, canvas');
                    gestureImgWrap = gestureImg.parent('.photo-browser-zoom-container');
                    if (gestureImgWrap.length === 0) {
                        gestureImg = undefined;
                        return;
                    }
                }
                gestureImg.transition(0);
                isScaling = true;
            };
            pb.onSlideGestureChange = function (e) {
                if (!gestureImg || gestureImg.length === 0) return;
                scale = e.scale * currentScale;
                if (scale > pb.params.maxZoom) {
                    scale = pb.params.maxZoom - 1 + Math.pow((scale - pb.params.maxZoom + 1), 0.5);
                }
                if (scale < pb.params.minZoom) {
                    scale =  pb.params.minZoom + 1 - Math.pow((pb.params.minZoom - scale + 1), 0.5);
                }
                gestureImg.transform('translate3d(0,0,0) scale(' + scale + ')');
            };
            pb.onSlideGestureEnd = function (e) {
                if (!gestureImg || gestureImg.length === 0) return;
                scale = Math.max(Math.min(scale, pb.params.maxZoom), pb.params.minZoom);
                gestureImg.transition(pb.params.speed).transform('translate3d(0,0,0) scale(' + scale + ')');
                currentScale = scale;
                isScaling = false;
                if (scale === 1) gestureSlide = undefined;
            };
            pb.toggleZoom = function (e) {
                if (!gestureSlide) {
                    gestureSlide = pb.swiper.slides.eq(pb.swiper.activeIndex);
                    gestureImg = gestureSlide.find('img, svg, canvas');
                    gestureImgWrap = gestureImg.parent('.photo-browser-zoom-container');
                }
                if (!gestureImg || gestureImg.length === 0) return;
                
                var touchX, touchY, offsetX, offsetY, diffX, diffY, translateX, translateY, imageWidth, imageHeight, scaledWidth, scaledHeight, translateMinX, translateMinY, translateMaxX, translateMaxY;
        
                if (typeof imageTouchesStart.x === 'undefined' && e) {
                    touchX = e.type === 'touchend' ? e.changedTouches[0].pageX : e.pageX;
                    touchY = e.type === 'touchend' ? e.changedTouches[0].pageY : e.pageY;
                }
                else {
                    touchX = imageTouchesStart.x;
                    touchY = imageTouchesStart.y;
                }
                
                if (scale && scale !== 1) {
                    // Zoom Out
                    scale = currentScale = 1;
                    gestureImgWrap.transition(300).transform('translate3d(0,0,0)');
                    gestureImg.transition(300).transform('translate3d(0,0,0) scale(1)');
                    gestureSlide = undefined;
                }
                else {
                    // Zoom In
                    scale = currentScale = pb.params.maxZoom;
                    if (e) {
                        offsetX = pb.container.offset().left;
                        offsetY = pb.container.offset().top;
                        diffX = offsetX + pb.container[0].offsetWidth/2 - touchX;
                        diffY = offsetY + pb.container[0].offsetHeight/2 - touchY;
        
                        imageWidth = gestureImg[0].offsetWidth;
                        imageHeight = gestureImg[0].offsetHeight;
                        scaledWidth = imageWidth * scale;
                        scaledHeight = imageHeight * scale;
        
                        translateMinX = Math.min((pb.swiper.width / 2 - scaledWidth / 2), 0);
                        translateMinY = Math.min((pb.swiper.height / 2 - scaledHeight / 2), 0);
                        translateMaxX = -translateMinX;
                        translateMaxY = -translateMinY;
        
                        translateX = diffX * scale;
                        translateY = diffY * scale;
                        
                        if (translateX < translateMinX) {
                            translateX =  translateMinX;
                        }
                        if (translateX > translateMaxX) {
                            translateX = translateMaxX;
                        }
                        
                        if (translateY < translateMinY) {
                            translateY =  translateMinY;
                        }
                        if (translateY > translateMaxY) {
                            translateY = translateMaxY;
                        }
                    }
                    else {
                        translateX = 0;
                        translateY = 0;
                    }
                    gestureImgWrap.transition(300).transform('translate3d(' + translateX + 'px, ' + translateY + 'px,0)');
                    gestureImg.transition(300).transform('translate3d(0,0,0) scale(' + scale + ')');
                }
            };
        
            var imageIsTouched, imageIsMoved, imageCurrentX, imageCurrentY, imageMinX, imageMinY, imageMaxX, imageMaxY, imageWidth, imageHeight, imageTouchesStart = {}, imageTouchesCurrent = {}, imageStartX, imageStartY, velocityPrevPositionX, velocityPrevTime, velocityX, velocityPrevPositionY, velocityY;
        
            pb.onSlideTouchStart = function (e) {
                if (!gestureImg || gestureImg.length === 0) return;
                if (imageIsTouched) return;
                if (app.device.os === 'android') e.preventDefault();
                imageIsTouched = true;
                imageTouchesStart.x = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
                imageTouchesStart.y = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
            };
            pb.onSlideTouchMove = function (e) {
                if (!gestureImg || gestureImg.length === 0) return;
                pb.swiper.allowClick = false;
                if (!imageIsTouched || !gestureSlide) return;
        
                if (!imageIsMoved) {
                    imageWidth = gestureImg[0].offsetWidth;
                    imageHeight = gestureImg[0].offsetHeight;
                    imageStartX = $.getTranslate(gestureImgWrap[0], 'x') || 0;
                    imageStartY = $.getTranslate(gestureImgWrap[0], 'y') || 0;
                    gestureImgWrap.transition(0);
                }
                // Define if we need image drag
                var scaledWidth = imageWidth * scale;
                var scaledHeight = imageHeight * scale;
        
                if (scaledWidth < pb.swiper.width && scaledHeight < pb.swiper.height) return;
        
                imageMinX = Math.min((pb.swiper.width / 2 - scaledWidth / 2), 0);
                imageMaxX = -imageMinX;
                imageMinY = Math.min((pb.swiper.height / 2 - scaledHeight / 2), 0);
                imageMaxY = -imageMinY;
                
                imageTouchesCurrent.x = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                imageTouchesCurrent.y = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
        
                if (!imageIsMoved && !isScaling) {
                    if (
                        (Math.floor(imageMinX) === Math.floor(imageStartX) && imageTouchesCurrent.x < imageTouchesStart.x) ||
                        (Math.floor(imageMaxX) === Math.floor(imageStartX) && imageTouchesCurrent.x > imageTouchesStart.x)
                        ) {
                        imageIsTouched = false;
                        return;
                    }
                }
                e.preventDefault();
                e.stopPropagation();
                imageIsMoved = true;
                imageCurrentX = imageTouchesCurrent.x - imageTouchesStart.x + imageStartX;
                imageCurrentY = imageTouchesCurrent.y - imageTouchesStart.y + imageStartY;
                
                if (imageCurrentX < imageMinX) {
                    imageCurrentX =  imageMinX + 1 - Math.pow((imageMinX - imageCurrentX + 1), 0.8);
                }
                if (imageCurrentX > imageMaxX) {
                    imageCurrentX = imageMaxX - 1 + Math.pow((imageCurrentX - imageMaxX + 1), 0.8);
                }
                
                if (imageCurrentY < imageMinY) {
                    imageCurrentY =  imageMinY + 1 - Math.pow((imageMinY - imageCurrentY + 1), 0.8);
                }
                if (imageCurrentY > imageMaxY) {
                    imageCurrentY = imageMaxY - 1 + Math.pow((imageCurrentY - imageMaxY + 1), 0.8);
                }
        
                //Velocity
                if (!velocityPrevPositionX) velocityPrevPositionX = imageTouchesCurrent.x;
                if (!velocityPrevPositionY) velocityPrevPositionY = imageTouchesCurrent.y;
                if (!velocityPrevTime) velocityPrevTime = Date.now();
                velocityX = (imageTouchesCurrent.x - velocityPrevPositionX) / (Date.now() - velocityPrevTime) / 2;
                velocityY = (imageTouchesCurrent.y - velocityPrevPositionY) / (Date.now() - velocityPrevTime) / 2;
                if (Math.abs(imageTouchesCurrent.x - velocityPrevPositionX) < 2) velocityX = 0;
                if (Math.abs(imageTouchesCurrent.y - velocityPrevPositionY) < 2) velocityY = 0;
                velocityPrevPositionX = imageTouchesCurrent.x;
                velocityPrevPositionY = imageTouchesCurrent.y;
                velocityPrevTime = Date.now();
        
                gestureImgWrap.transform('translate3d(' + imageCurrentX + 'px, ' + imageCurrentY + 'px,0)');
            };
            pb.onSlideTouchEnd = function (e) {
                if (!gestureImg || gestureImg.length === 0) return;
                if (!imageIsTouched || !imageIsMoved) {
                    imageIsTouched = false;
                    imageIsMoved = false;
                    return;
                }
                imageIsTouched = false;
                imageIsMoved = false;
                var momentumDurationX = 300;
                var momentumDurationY = 300;
                var momentumDistanceX = velocityX * momentumDurationX;
                var newPositionX = imageCurrentX + momentumDistanceX;
                var momentumDistanceY = velocityY * momentumDurationY;
                var newPositionY = imageCurrentY + momentumDistanceY;
        
                //Fix duration
                if (velocityX !== 0) momentumDurationX = Math.abs((newPositionX - imageCurrentX) / velocityX);
                if (velocityY !== 0) momentumDurationY = Math.abs((newPositionY - imageCurrentY) / velocityY);
                var momentumDuration = Math.max(momentumDurationX, momentumDurationY);
        
                imageCurrentX = newPositionX;
                imageCurrentY = newPositionY;
        
                // Define if we need image drag
                var scaledWidth = imageWidth * scale;
                var scaledHeight = imageHeight * scale;
                imageMinX = Math.min((pb.swiper.width / 2 - scaledWidth / 2), 0);
                imageMaxX = -imageMinX;
                imageMinY = Math.min((pb.swiper.height / 2 - scaledHeight / 2), 0);
                imageMaxY = -imageMinY;
                imageCurrentX = Math.max(Math.min(imageCurrentX, imageMaxX), imageMinX);
                imageCurrentY = Math.max(Math.min(imageCurrentY, imageMaxY), imageMinY);
        
                gestureImgWrap.transition(momentumDuration).transform('translate3d(' + imageCurrentX + 'px, ' + imageCurrentY + 'px,0)');
            };
        
            // Swipe Up To Close
            var swipeToCloseIsTouched = false;
            var allowSwipeToClose = true;
            var swipeToCloseDiff, swipeToCloseStart, swipeToCloseCurrent, swipeToCloseStarted = false, swipeToCloseActiveSlide, swipeToCloseTimeStart;
            pb.swipeCloseTouchStart = function (swiper, e) {
                if (!allowSwipeToClose) return;
                swipeToCloseIsTouched = true;
            };
            pb.swipeCloseTouchMove = function (swiper, e) {
                if (!swipeToCloseIsTouched) return;
                if (!swipeToCloseStarted) {
                    swipeToCloseStarted = true;
                    swipeToCloseStart = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                    swipeToCloseActiveSlide = pb.swiper.slides.eq(pb.swiper.activeIndex);
                    swipeToCloseTimeStart = (new Date()).getTime();
                }
                e.preventDefault();
                swipeToCloseCurrent = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                swipeToCloseDiff = swipeToCloseStart - swipeToCloseCurrent;
                var opacity = 1 - Math.abs(swipeToCloseDiff) / 300;
                swipeToCloseActiveSlide.transform('translate3d(0,' + (-swipeToCloseDiff) + 'px,0)');
                pb.swiper.container.css('opacity', opacity).transition(0);
            };
            pb.swipeCloseTouchEnd = function (swiper, e) {
                swipeToCloseIsTouched = false;
                if (!swipeToCloseStarted) {
                    swipeToCloseStarted = false;
                    return;
                }
                swipeToCloseStarted = false;
                allowSwipeToClose = false;
                var diff = Math.abs(swipeToCloseDiff);
                var timeDiff = (new Date()).getTime() - swipeToCloseTimeStart;
                if ((timeDiff < 300 && diff > 20) || (timeDiff >= 300 && diff > 100)) {
                    setTimeout(function () {
                        if (pb.params.type === 'standalone') {
                            pb.close();
                        }
                        if (pb.params.type === 'popup') {
                            app.closeModal(pb.popup);
                        }
                        if (pb.params.onSwipeToClose) {
                            pb.params.onSwipeToClose(pb);
                        }
                        allowSwipeToClose = true;
                    }, 0);
                    return;
                }
                if (diff !== 0) {
                    swipeToCloseActiveSlide.addClass('transitioning').transitionEnd(function () {
                        allowSwipeToClose = true;
                        swipeToCloseActiveSlide.removeClass('transitioning');
                    });
                }
                else {
                    allowSwipeToClose = true;
                }
                pb.swiper.container.css('opacity', '').transition('');
                swipeToCloseActiveSlide.transform('');
            };
        
            return pb;
        };
        
        app.photoBrowser = function (params) {
            return new PhotoBrowser(params);
        };
        

        /*===============================================================================
        ************   Autocomplete   ************
        ===============================================================================*/
        var Autocomplete = function (params) {
            var a = this;
        
            // Params
            var defaults = {
                // Standalone Options
                /*
                opener: undefined,
                */
                popupCloseText: 'Close',
                backText: 'Back',
                searchbarPlaceholderText: 'Search...',
                searchbarCancelText: 'Cancel',
                openIn: 'page',
                backOnSelect: false,
                notFoundText: 'Nothing found',
                /*
                pageTitle: undefined,
                */
        
                // Handle Data
                /*
                source: undefined,
                limit: undefined,
                */
                valueProperty: 'id',
                textProperty: 'text',
        
                // Dropdown Options
                /*
                dropdownPlaceholderText: 'Type anything...',
                */
                updateInputValueOnSelect: true,
                expandInput: false,
        
                // Preloader
                preloaderColor: false,
                preloader: false,
        
                // Templates
                /*
                itemTemplate: undefined,
                navbarTemplate: undefined,
                dropdownTemplate: undefined
                dropdownItemTemplate: undefined,
                dropdownPlaceholderTemplate: undefined
                */
        
                // Color themes
                /*
                navbarTheme: undefined,
                formTheme: undefined,
                */
        
                // Callbacks
                /*
                onChange: function (a, value) - for not dropdown
                onOpen: function (a)
                onClose: function (a)
                */
            };
        
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined') {
                    params[def] = defaults[def];
                }
            }
            a.params = params;
        
            // Opener Link & View
            if (a.params.opener) {
                a.opener = $(a.params.opener);
            }
            var view = a.params.view;
            if (!a.params.view && a.opener && a.opener.length) {
                // Find related view
                view = a.opener.parents('.' + app.params.viewClass);
                if (view.length === 0) return;
                view = view[0].f7View;
            }
        
            // Input
            if (a.params.input) {
                a.input = $(a.params.input);
                if (a.input.length === 0 && a.params.openIn === 'dropdown') return;
            }
        
            // Array with selected items
            a.value = a.params.value || [];
        
            // ID & Inputs
            a.id = (new Date()).getTime();
            a.inputType = a.params.multiple ? 'checkbox' : 'radio';
            a.inputName = a.inputType + '-' + a.id;
        
            // Is Material
            var material = app.params.material;
        
            // Back On Select
            var backOnSelect = a.params.backOnSelect;
        
            if (a.params.openIn !== 'dropdown') {
                // Item Template
                a.itemTemplate = t7.compile(a.params.itemTemplate ||
                    '<li>' +
                        '<label class="label-{{inputType}} item-content">' +
                            '<input type="{{inputType}}" name="{{inputName}}" value="{{value}}" {{#if selected}}checked{{/if}}>' +
                            '{{#if material}}' +
                                '<div class="item-media">' +
                                    '<i class="icon icon-form-{{inputType}}"></i>' +
                                '</div>' +
                                '<div class="item-inner">' +
                                    '<div class="item-title">{{text}}</div>' +
                                '</div>' +
                            '{{else}}' +
                                '{{#if checkbox}}' +
                                '<div class="item-media">' +
                                    '<i class="icon icon-form-checkbox"></i>' +
                                '</div>' +
                                '{{/if}}' +
                                '<div class="item-inner">' +
                                    '<div class="item-title">{{text}}</div>' +
                                '</div>' +
                            '{{/if}}' +
                        '</label>' +
                    '</li>'
                );
                // Page Layout
                var pageTitle = a.params.pageTitle || '';
                if (!pageTitle && a.opener && a.opener.length) {
                    pageTitle = a.opener.find('.item-title').text();
                }
                var pageName = 'autocomplete-' + a.inputName;
        
                var navbarTheme = a.params.navbarTheme,
                    formTheme = a.params.formTheme;
        
                // Navbar HTML
                var navbarHTML;
                var noNavbar = '', noToolbar = '', navbarLayout;
        
                a.navbarTemplate = t7.compile(a.params.navbarTemplate ||
                    '<div class="navbar {{#if navbarTheme}}theme-{{navbarTheme}}{{/if}}">' +
                        '<div class="navbar-inner">' +
                            '<div class="left sliding">' +
                                '{{#if material}}' +
                                '<a href="#" class="link {{#if inPopup}}close-popup{{else}}back{{/if}} icon-only"><i class="icon icon-back"></i></a>' +
                                '{{else}}' +
                                '<a href="#" class="link {{#if inPopup}}close-popup{{else}}back{{/if}}">' +
                                    '<i class="icon icon-back"></i>' +
                                    '{{#if inPopup}}' +
                                    '<span>{{popupCloseText}}</span>' +
                                    '{{else}}' +
                                    '<span>{{backText}}</span>' +
                                    '{{/if}}' +
                                '</a>' +
                                '{{/if}}' +
                            '</div>' +
                            '<div class="center sliding">{{pageTitle}}</div>' +
                            '{{#if preloader}}' +
                            '<div class="right">' +
                                '<div class="autocomplete-preloader preloader {{#if preloaderColor}}preloader-{{preloaderColor}}{{/if}}"></div>' +
                            '</div>' +
                            '{{/if}}' +
                        '</div>' +
                    '</div>'
                );
                navbarHTML = a.navbarTemplate({
                    pageTitle: pageTitle,
                    backText: a.params.backText,
                    popupCloseText: a.params.popupCloseText,
                    openIn: a.params.openIn,
                    navbarTheme: navbarTheme,
                    inPopup: a.params.openIn === 'popup',
                    inPage: a.params.openIn === 'page',
                    material: material,
                    preloader: a.params.preloader,
                    preloaderColor: a.params.preloaderColor,
                });
        
                // Determine navbar layout type - static/fixed/through
                if (a.params.openIn === 'page') {
                    navbarLayout = 'static';
                    if (a.opener) {
                        if (a.opener.parents('.navbar-through').length > 0) navbarLayout = 'through';
                        if (a.opener.parents('.navbar-fixed').length > 0) navbarLayout = 'fixed';
                        noToolbar = a.opener.parents('.page').hasClass('no-toolbar') ? 'no-toolbar' : '';
                        noNavbar  = a.opener.parents('.page').hasClass('no-navbar')  ? 'no-navbar'  : 'navbar-' + navbarLayout;
                    }
                    else if (view.container) {
                        if ($(view.container).hasClass('navbar-through') || $(view.container).find('.navbar-through').length > 0) navbarLayout = 'through';
                        if ($(view.container).hasClass('navbar-fixed') || $(view.container).find('.navbar-fixed').length > 0) navbarLayout = 'fixed';
                        noToolbar = $(view.activePage.container).hasClass('no-toolbar') ? 'no-toolbar' : '';
                        noNavbar  = $(view.activePage.container).hasClass('no-navbar')  ? 'no-navbar'  : 'navbar-' + navbarLayout;
                    }
                }
                else {
                    navbarLayout = 'fixed';
                }
                var searchbarHTML =
                    '<form class="searchbar">' +
                        '<div class="searchbar-input">' +
                            '<input type="search" placeholder="' + a.params.searchbarPlaceholderText + '">' +
                            '<a href="#" class="searchbar-clear"></a>' +
                        '</div>' +
                        (material ? '' : '<a href="#" class="searchbar-cancel">' + a.params.searchbarCancelText + '</a>') +
                    '</form>' +
                    '<div class="searchbar-overlay"></div>';
                var pageHTML =
                    (navbarLayout === 'through' ? navbarHTML : '') +
                    '<div class="pages">' +
                        '<div data-page="' + pageName + '" class="page autocomplete-page ' + noNavbar + ' ' + noToolbar + '">' +
                            (navbarLayout === 'fixed' ? navbarHTML : '') +
                            searchbarHTML +
                            '<div class="page-content">' +
                                (navbarLayout === 'static' ? navbarHTML : '') +
                                '<div class="list-block autocomplete-found autocomplete-list-' + a.id + ' ' + (formTheme ? 'theme-' + formTheme : '') + '">' +
                                    '<ul></ul>' +
                                '</div>' +
                                '<div class="list-block autocomplete-not-found">' +
                                    '<ul><li class="item-content"><div class="item-inner"><div class="item-title">' + a.params.notFoundText + '</div></div></li></ul>' +
                                '</div>' +
                                '<div class="list-block autocomplete-values">' +
                                    '<ul></ul>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
            }
            else {
                a.dropdownItemTemplate = t7.compile(a.params.dropdownItemTemplate ||
                    '<li>' +
                        '<label class="{{#unless placeholder}}label-radio{{/unless}} item-content" data-value="{{value}}">' +
                            '<div class="item-inner">' +
                                '<div class="item-title">{{text}}</div>' +
                            '</div>' +
                        '</label>' +
                    '</li>'
                );
                a.dropdownPlaceholderTemplate = t7.compile(a.params.dropdownPlaceholderTemplate ||
                    '<li class="autocomplete-dropdown-placeholder">' +
                        '<div class="item-content">' +
                            '<div class="item-inner">' +
                                '<div class="item-title">{{text}}</div>' +
                            '</div>' +
                        '</label>' +
                    '</li>'
                );
                a.dropdownTemplate = t7.compile(a.params.dropdownTemplate ||
                    '<div class="autocomplete-dropdown">' +
                        '<div class="autocomplete-dropdown-inner">' +
                            '<div class="list-block">' +
                                '<ul></ul>' +
                            '</div>' +
                        '</div>' +
                        '{{#if preloader}}' +
                        '<div class="autocomplete-preloader preloader {{#if preloaderColor}}preloader-{{preloaderColor}}{{/if}}">{{#if material}}{{materialPreloaderHtml}}{{/if}}</div>' +
                        '{{/if}}' +
                    '</div>'
                );
            }
        
            // Define popup
            a.popup = undefined;
        
            // Define Dropdown
            a.dropdown = undefined;
        
            // Handle Input Value Change
            function handleInputValue (e) {
                var query = a.input.val();
                if (a.params.source) {
                    a.params.source(a, query, function (items) {
                        var itemsHTML = '';
                        var limit = a.params.limit ? Math.min(a.params.limit, items.length) : items.length;
                        a.items = items;
                        var i, j;
                        var regExp = new RegExp('('+query+')', 'i');
                        for (i = 0; i < limit; i++) {
                            var itemValue = typeof items[i] === 'object' ? items[i][a.params.valueProperty] : items[i];
                            itemsHTML += a.dropdownItemTemplate({
                                value: itemValue,
                                text: (typeof items[i] !== 'object' ? items[i] : items[i][a.params.textProperty]).replace(regExp, '<b>$1</b>')
                            });
                        }
                        if (itemsHTML === '' && query === '' && a.params.dropdownPlaceholderText) {
                            itemsHTML += a.dropdownPlaceholderTemplate({
                                text: a.params.dropdownPlaceholderText,
                            });
                        }
                        a.dropdown.find('ul').html(itemsHTML);
                    });
                }
            }
            // Handle Drop Down Click
            function handleDropdownClick (e) {
                /*jshint validthis:true */
                var clicked = $(this);
                var clickedItem;
                for (var i = 0; i < a.items.length; i++) {
                    var itemValue = typeof a.items[i] === 'object' ? a.items[i][a.params.valueProperty] : a.items[i];
                    var value = clicked.attr('data-value');
                    if (itemValue === value || itemValue * 1 === value * 1) {
                        clickedItem = a.items[i];
                    }
                }
                if (a.params.updateInputValueOnSelect) {
                    a.input.val(typeof clickedItem === 'object' ? clickedItem[a.params.textProperty] : clickedItem);
                    a.input.trigger('input change');
                }
        
                if (a.params.onChange) {
                    a.params.onChange(a, clickedItem);
                }
        
                a.close();
            }
        
            // Handle HTML Click to close Dropdown
            function closeOnHTMLClick (e) {
                var target = $(e.target);
                if (!(target.is(a.input[0]) || a.dropdown && target.parents(a.dropdown[0]).length > 0)) {
                    a.close();
                }
            }
        
            a.positionDropDown = function () {
                var listBlock = a.input.parents('.list-block'),
                    pageContent = a.input.parents('.page-content'),
                    paddingTop = parseInt(pageContent.css('padding-top'), 10),
                    paddingBottom = parseInt(pageContent.css('padding-top'), 10),
                    inputOffset = a.input.offset(),
                    listBlockOffset = listBlock.length > 0 ? listBlock.offset() : 0,
                    maxHeight = pageContent[0].scrollHeight - paddingBottom - (inputOffset.top + pageContent[0].scrollTop) - a.input[0].offsetHeight;
        
                a.dropdown.css({
                    left: (listBlock.length > 0 ? listBlockOffset.left : inputOffset.left) + 'px',
                    top: inputOffset.top + pageContent[0].scrollTop + a.input[0].offsetHeight + 'px',
                    width: (listBlock.length > 0 ? listBlock[0].offsetWidth : a.input[0].offsetWidth) + 'px'
                });
                a.dropdown.children('.autocomplete-dropdown-inner').css({
                    maxHeight: maxHeight + 'px',
                    paddingLeft: listBlock.length > 0 && !a.params.expandInput ? inputOffset.left - (material ? 16 : 15) + 'px' : ''
                });
            };
        
            // Event Listeners on new page
            a.pageInit = function (e) {
                var page = e.detail.page;
                a.page = $(page.container);
                a.pageData = page;
                if (page.name !== pageName) {
                    return;
                }
                var container = $(page.container);
                // Init Search Bar
                var searchbar = app.searchbar(container.find('.searchbar'), {
                    customSearch: true,
                    onSearch: function (searchbar, data) {
                        if (data.query.length === 0 && searchbar.active) {
                            searchbar.overlay.addClass('searchbar-overlay-active');
                        }
                        else {
                            searchbar.overlay.removeClass('searchbar-overlay-active');
                        }
        
                        var i, j, k;
        
                        if (a.params.source) {
                            a.params.source(a, data.query, function(items) {
                                var itemsHTML = '';
                                var limit = a.params.limit ? Math.min(a.params.limit, items.length) : items.length;
                                a.items = items;
                                for (i = 0; i < limit; i++) {
                                    var selected = false;
                                    var itemValue = typeof items[i] === 'object' ? items[i][a.params.valueProperty] : items[i];
                                    for (j = 0; j < a.value.length; j++) {
                                        var aValue = typeof a.value[j] === 'object' ? a.value[j][a.params.valueProperty] : a.value[j];
                                        if (aValue === itemValue || aValue * 1 === itemValue * 1) selected = true;
                                    }
                                    itemsHTML += a.itemTemplate({
                                        value: itemValue,
                                        text: typeof items[i] !== 'object' ? items[i] : items[i][a.params.textProperty],
                                        inputType: a.inputType,
                                        id: a.id,
                                        inputName: a.inputName,
                                        selected: selected,
                                        checkbox: a.inputType === 'checkbox',
                                        material: material
                                    });
                                }
                                container.find('.autocomplete-found ul').html(itemsHTML);
                                if (items.length === 0) {
                                    if (data.query.length !== 0) {
                                        container.find('.autocomplete-not-found').show();
                                        container.find('.autocomplete-found, .autocomplete-values').hide();
                                    }
                                    else {
                                        container.find('.autocomplete-values').show();
                                        container.find('.autocomplete-found, .autocomplete-not-found').hide();
                                    }
                                }
                                else {
                                    container.find('.autocomplete-found').show();
                                    container.find('.autocomplete-not-found, .autocomplete-values').hide();
                                }
                            });
                        }
                    }
                });
        
                // Save searchbar instance
                a.searchbar = searchbar;
        
                // Update values
                function updateValues() {
                    var valuesHTML = '';
                    var i;
                    for (i = 0; i < a.value.length; i++) {
        
                        valuesHTML += a.itemTemplate({
                            value: typeof a.value[i] === 'object' ? a.value[i][a.params.valueProperty] : a.value[i],
                            text: typeof a.value[i] === 'object' ? a.value[i][a.params.textProperty]: a.value[i],
                            inputType: a.inputType,
                            id: a.id,
                            inputName: a.inputName + '-checked',
                            checkbox: a.inputType === 'checkbox',
                            material: material,
                            selected: true
                        });
                    }
                    container.find('.autocomplete-values ul').html(valuesHTML);
                }
        
                // Handle Inputs
                container.on('change', 'input[type="radio"], input[type="checkbox"]', function () {
                    var i;
                    var input = this;
                    var value = input.value;
                    var text = $(input).parents('li').find('.item-title').text();
                    var isValues = $(input).parents('.autocomplete-values').length > 0;
                    var item, itemValue, aValue;
                    if (isValues) {
                        if (a.inputType === 'checkbox' && !input.checked) {
                            for (i = 0; i < a.value.length; i++) {
                                aValue = typeof a.value[i] === 'string' ? a.value[i] : a.value[i][a.params.valueProperty];
                                if (aValue === value || aValue * 1 === value * 1) {
                                    a.value.splice(i, 1);
                                }
                            }
                            updateValues();
                            if (a.params.onChange) a.params.onChange(a, a.value);
                        }
                        return;
                    }
        
                    // Find Related Item
                    for (i = 0; i < a.items.length; i++) {
                        itemValue = typeof a.items[i] === 'string' ? a.items[i] : a.items[i][a.params.valueProperty];
                        if (itemValue === value || itemValue * 1 === value * 1) item = a.items[i];
                    }
                    // Update Selected Value
                    if (a.inputType === 'radio') {
                        a.value = [item];
                    }
                    else {
                        if (input.checked) {
                            a.value.push(item);
                        }
                        else {
                            for (i = 0; i < a.value.length; i++) {
                                aValue = typeof a.value[i] === 'string' ? a.value[i] : a.value[i][a.params.valueProperty];
                                if (aValue === value || aValue * 1 === value * 1) {
                                    a.value.splice(i, 1);
                                }
                            }
                        }
                    }
        
                    // Update Values Block
                    updateValues();
        
                    // On Select Callback
                    if ((a.inputType === 'radio' && input.checked || a.inputType === 'checkbox') && a.params.onChange ) {
                        a.params.onChange(a, a.value);
                    }
                    if (backOnSelect && a.inputType === 'radio') {
                        if (a.params.openIn === 'popup') app.closeModal(a.popup);
                        else view.router.back();
                    }
                });
        
                // Update Values On Page Init
                updateValues();
        
                if (a.params.onOpen) a.params.onOpen(a);
            };
        
            // Show Hide Preloader
            a.showPreloader = function () {
                if (a.params.openIn === 'dropdown') {
                    if (a.dropdown) a.dropdown.find('.autocomplete-preloader').addClass('autocomplete-preloader-visible');
                }
                else $('.autocomplete-preloader').addClass('autocomplete-preloader-visible');
            };
        
            a.hidePreloader = function () {
                if (a.params.openIn === 'dropdown') {
                    if (a.dropdown) a.dropdown.find('.autocomplete-preloader').removeClass('autocomplete-preloader-visible');
                }
                else $('.autocomplete-preloader').removeClass('autocomplete-preloader-visible');
            };
        
            // Open Autocomplete Page/Popup
            a.open = function () {
                if (a.opened) return;
                a.opened = true;
                if (a.params.openIn === 'dropdown') {
                    if (!a.dropdown) {
                        a.dropdown = $(a.dropdownTemplate({
                            preloader: a.params.preloader,
                            preloaderColor: a.params.preloaderColor,
                            material: material,
                            materialPreloaderHtml: app.params.materialPreloaderHtml
                        }));
                        a.dropdown.on('click', 'label', handleDropdownClick);
        
                    }
                    var listBlock = a.input.parents('.list-block');
                    if (listBlock.length && a.input.parents('.item-content').length > 0 && a.params.expandInput) {
                        a.input.parents('.item-content').addClass('item-content-dropdown-expand');
                    }
                    a.positionDropDown();
                    a.input.parents('.page-content').append(a.dropdown);
                    a.dropdown.addClass('autocomplete-dropdown-in');
                    a.input.trigger('input');
                    $(window).on('resize', a.positionDropDown);
                    if (a.params.onOpen) a.params.onOpen(a);
                }
                else {
                    $(document).once('pageInit', '.autocomplete-page', a.pageInit);
                    if (a.params.openIn === 'popup') {
                        a.popup = app.popup(
                            '<div class="popup autocomplete-popup autocomplete-popup-' + a.inputName + '">' +
                                '<div class="view navbar-fixed">' +
                                    pageHTML +
                                '</div>' +
                            '</div>'
                            );
                        a.popup = $(a.popup);
                        a.popup.once('closed', function () {
                            a.popup = undefined;
                            a.opened = false;
                            if (a.params.onClose) a.params.onClose(a);
                        });
                    }
                    else {
                        view.router.load({
                            content: pageHTML
                        });
                        $(document).once('pageBack', '.autocomplete-page', function () {
                            a.opened = false;
                            if (a.params.onClose) a.params.onClose(a);
                        });
                    }
                }
            };
            a.close = function (e) {
                if (!a.opened) return;
                if (a.params.openIn === 'dropdown') {
                    if (e && e.type === 'blur' && a.dropdown.find('label.active-state').length > 0) return;
                    a.dropdown.removeClass('autocomplete-dropdown-in').remove();
                    a.input.parents('.item-content-dropdown-expand').removeClass('item-content-dropdown-expand');
                    a.opened = false;
                    $(window).off('resize', a.positionDropDown);
                    if (a.params.onClose) a.params.onClose(a);
                }
                if (a.params.openIn === 'popup') {
                    if (a.popup) app.closeModal(a.popup);
                }
            };
        
            // Init Events
            a.initEvents = function (detach) {
                var method = detach ? 'off' : 'on';
                if (a.params.openIn !== 'dropdown' && a.opener) {
                    a.opener[method]('click', a.open);
                }
                if (a.params.openIn === 'dropdown' && a.input) {
                    a.input[method]('focus', a.open);
                    a.input[method]('input', handleInputValue);
                    if (app.device.android) {
                        $('html')[method]('click', closeOnHTMLClick);
                    }
                    else {
                        a.input[method]('blur', a.close);
                    }
                }
                if (detach && a.dropdown) {
                    a.dropdown = null;
                }
            };
        
            // Init/Destroy Methods
            a.init = function () {
                a.initEvents();
            };
            a.destroy = function () {
                a.initEvents(true);
                a = null;
            };
        
            // Init
            a.init();
        
            return a;
        };
        app.autocomplete = function (params) {
            return new Autocomplete(params);
        };

        /*======================================================
        ************   Picker   ************
        ======================================================*/
        var Picker = function (params) {
            var p = this;
            var defaults = {
                updateValuesOnMomentum: false,
                updateValuesOnTouchmove: true,
                rotateEffect: false,
                momentumRatio: 7,
                freeMode: false,
                // Common settings
                closeByOutsideClick: true,
                scrollToInput: true,
                inputReadOnly: true,
                convertToPopover: true,
                onlyInPopover: false,
                toolbar: true,
                toolbarCloseText: 'Done',
                toolbarTemplate: 
                    '<div class="toolbar">' +
                        '<div class="toolbar-inner">' +
                            '<div class="left"></div>' +
                            '<div class="right">' +
                                '<a href="#" class="link close-picker">{{closeText}}</a>' +
                            '</div>' +
                        '</div>' +
                    '</div>'
            };
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined') {
                    params[def] = defaults[def];
                }
            }
            p.params = params;
            p.cols = [];
            p.initialized = false;
            
            // Inline flag
            p.inline = p.params.container ? true : false;
        
            // 3D Transforms origin bug, only on safari
            var originBug = app.device.ios || (navigator.userAgent.toLowerCase().indexOf('safari') >= 0 && navigator.userAgent.toLowerCase().indexOf('chrome') < 0) && !app.device.android;
        
            // Should be converted to popover
            function isPopover() {
                var toPopover = false;
                if (!p.params.convertToPopover && !p.params.onlyInPopover) return toPopover;
                if (!p.inline && p.params.input) {
                    if (p.params.onlyInPopover) toPopover = true;
                    else {
                        if (app.device.ios) {
                            toPopover = app.device.ipad ? true : false;
                        }
                        else {
                            if ($(window).width() >= 768) toPopover = true;
                        }
                    }
                } 
                return toPopover; 
            }
            function inPopover() {
                if (p.opened && p.container && p.container.length > 0 && p.container.parents('.popover').length > 0) return true;
                else return false;
            }
        
            // Value
            p.setValue = function (arrValues, transition) {
                var valueIndex = 0;
                if (p.cols.length === 0) {
                    p.value = arrValues;
                    p.updateValue(arrValues);
                    return;
                }
                for (var i = 0; i < p.cols.length; i++) {
                    if (p.cols[i] && !p.cols[i].divider) {
                        p.cols[i].setValue(arrValues[valueIndex], transition);
                        valueIndex++;
                    }
                }
            };
            p.updateValue = function (forceValues) {
                var newValue = forceValues || [];
                var newDisplayValue = [];
                for (var i = 0; i < p.cols.length; i++) {
                    if (!p.cols[i].divider) {
                        newValue.push(p.cols[i].value);
                        newDisplayValue.push(p.cols[i].displayValue);
                    }
                }
                if (newValue.indexOf(undefined) >= 0) {
                    return;
                }
                p.value = newValue;
                p.displayValue = newDisplayValue;
                if (p.params.onChange) {
                    p.params.onChange(p, p.value, p.displayValue);
                }
                if (p.input && p.input.length > 0) {
                    $(p.input).val(p.params.formatValue ? p.params.formatValue(p, p.value, p.displayValue) : p.value.join(' '));
                    $(p.input).trigger('change');
                }
            };
        
            // Columns Handlers
            p.initPickerCol = function (colElement, updateItems) {
                var colContainer = $(colElement);
                var colIndex = colContainer.index();
                var col = p.cols[colIndex];
                if (col.divider) return;
                col.container = colContainer;
                col.wrapper = col.container.find('.picker-items-col-wrapper');
                col.items = col.wrapper.find('.picker-item');
                
                var i, j;
                var wrapperHeight, itemHeight, itemsHeight, minTranslate, maxTranslate;
                col.replaceValues = function (values, displayValues) {
                    col.destroyEvents();
                    col.values = values;
                    col.displayValues = displayValues;
                    var newItemsHTML = p.columnHTML(col, true);
                    col.wrapper.html(newItemsHTML);
                    col.items = col.wrapper.find('.picker-item');
                    col.calcSize();
                    col.setValue(col.values[0], 0, true);
                    col.initEvents();
                };
                col.calcSize = function () {
                    if (p.params.rotateEffect) {
                        col.container.removeClass('picker-items-col-absolute');
                        if (!col.width) col.container.css({width:''});
                    }
                    var colWidth, colHeight;
                    colWidth = 0;
                    colHeight = col.container[0].offsetHeight;
                    wrapperHeight = col.wrapper[0].offsetHeight;
                    itemHeight = col.items[0].offsetHeight;
                    itemsHeight = itemHeight * col.items.length;
                    minTranslate = colHeight / 2 - itemsHeight + itemHeight / 2;
                    maxTranslate = colHeight / 2 - itemHeight / 2;    
                    if (col.width) {
                        colWidth = col.width;
                        if (parseInt(colWidth, 10) === colWidth) colWidth = colWidth + 'px';
                        col.container.css({width: colWidth});
                    }
                    if (p.params.rotateEffect) {
                        if (!col.width) {
                            col.items.each(function () {
                                var item = $(this);
                                item.css({width:'auto'});
                                colWidth = Math.max(colWidth, item[0].offsetWidth);
                                item.css({width:''});
                            });
                            col.container.css({width: (colWidth + 2) + 'px'});
                        }
                        col.container.addClass('picker-items-col-absolute');
                    }
                };
                col.calcSize();
                
                col.wrapper.transform('translate3d(0,' + maxTranslate + 'px,0)').transition(0);
        
        
                var activeIndex = 0;
                var animationFrameId;
        
                // Set Value Function
                col.setValue = function (newValue, transition, valueCallbacks) {
                    if (typeof transition === 'undefined') transition = '';
                    var newActiveIndex = col.wrapper.find('.picker-item[data-picker-value="' + newValue + '"]').index();
                    if(typeof newActiveIndex === 'undefined' || newActiveIndex === -1) {
                        return;
                    }
                    var newTranslate = -newActiveIndex * itemHeight + maxTranslate;
                    // Update wrapper
                    col.wrapper.transition(transition);
                    col.wrapper.transform('translate3d(0,' + (newTranslate) + 'px,0)');
                        
                    // Watch items
                    if (p.params.updateValuesOnMomentum && col.activeIndex && col.activeIndex !== newActiveIndex ) {
                        $.cancelAnimationFrame(animationFrameId);
                        col.wrapper.transitionEnd(function(){
                            $.cancelAnimationFrame(animationFrameId);
                        });
                        updateDuringScroll();
                    }
        
                    // Update items
                    col.updateItems(newActiveIndex, newTranslate, transition, valueCallbacks);
                };
        
                col.updateItems = function (activeIndex, translate, transition, valueCallbacks) {
                    if (typeof translate === 'undefined') {
                        translate = $.getTranslate(col.wrapper[0], 'y');
                    }
                    if(typeof activeIndex === 'undefined') activeIndex = -Math.round((translate - maxTranslate)/itemHeight);
                    if (activeIndex < 0) activeIndex = 0;
                    if (activeIndex >= col.items.length) activeIndex = col.items.length - 1;
                    var previousActiveIndex = col.activeIndex;
                    col.activeIndex = activeIndex;
                    col.wrapper.find('.picker-selected').removeClass('picker-selected');
        
                    col.items.transition(transition);
                    
                    var selectedItem = col.items.eq(activeIndex).addClass('picker-selected').transform('');
                        
                    // Set 3D rotate effect
                    if (p.params.rotateEffect) {
                        var percentage = (translate - (Math.floor((translate - maxTranslate)/itemHeight) * itemHeight + maxTranslate)) / itemHeight;
                        
                        col.items.each(function () {
                            var item = $(this);
                            var itemOffsetTop = item.index() * itemHeight;
                            var translateOffset = maxTranslate - translate;
                            var itemOffset = itemOffsetTop - translateOffset;
                            var percentage = itemOffset / itemHeight;
        
                            var itemsFit = Math.ceil(col.height / itemHeight / 2) + 1;
                            
                            var angle = (-18*percentage);
                            if (angle > 180) angle = 180;
                            if (angle < -180) angle = -180;
                            // Far class
                            if (Math.abs(percentage) > itemsFit) item.addClass('picker-item-far');
                            else item.removeClass('picker-item-far');
                            // Set transform
                            item.transform('translate3d(0, ' + (-translate + maxTranslate) + 'px, ' + (originBug ? -110 : 0) + 'px) rotateX(' + angle + 'deg)');
                        });
                    }
        
                    if (valueCallbacks || typeof valueCallbacks === 'undefined') {
                        // Update values
                        col.value = selectedItem.attr('data-picker-value');
                        col.displayValue = col.displayValues ? col.displayValues[activeIndex] : col.value;
                        // On change callback
                        if (previousActiveIndex !== activeIndex) {
                            if (col.onChange) {
                                col.onChange(p, col.value, col.displayValue);
                            }
                            p.updateValue();
                        }
                    }
                };
        
                function updateDuringScroll() {
                    animationFrameId = $.requestAnimationFrame(function () {
                        col.updateItems(undefined, undefined, 0);
                        updateDuringScroll();
                    });
                }
        
                // Update items on init
                if (updateItems) col.updateItems(0, maxTranslate, 0);
        
                var allowItemClick = true;
                var isTouched, isMoved, touchStartY, touchCurrentY, touchStartTime, touchEndTime, startTranslate, returnTo, currentTranslate, prevTranslate, velocityTranslate, velocityTime;
                function handleTouchStart (e) {
                    if (isMoved || isTouched) return;
                    e.preventDefault();
                    isTouched = true;
                    touchStartY = touchCurrentY = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                    touchStartTime = (new Date()).getTime();
                    
                    allowItemClick = true;
                    startTranslate = currentTranslate = $.getTranslate(col.wrapper[0], 'y');
                }
                function handleTouchMove (e) {
                    if (!isTouched) return;
                    e.preventDefault();
                    allowItemClick = false;
                    touchCurrentY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                    if (!isMoved) {
                        // First move
                        $.cancelAnimationFrame(animationFrameId);
                        isMoved = true;
                        startTranslate = currentTranslate = $.getTranslate(col.wrapper[0], 'y');
                        col.wrapper.transition(0);
                    }
                    e.preventDefault();
        
                    var diff = touchCurrentY - touchStartY;
                    currentTranslate = startTranslate + diff;
                    returnTo = undefined;
        
                    // Normalize translate
                    if (currentTranslate < minTranslate) {
                        currentTranslate = minTranslate - Math.pow(minTranslate - currentTranslate, 0.8);
                        returnTo = 'min';
                    }
                    if (currentTranslate > maxTranslate) {
                        currentTranslate = maxTranslate + Math.pow(currentTranslate - maxTranslate, 0.8);
                        returnTo = 'max';
                    }
                    // Transform wrapper
                    col.wrapper.transform('translate3d(0,' + currentTranslate + 'px,0)');
        
                    // Update items
                    col.updateItems(undefined, currentTranslate, 0, p.params.updateValuesOnTouchmove);
                    
                    // Calc velocity
                    velocityTranslate = currentTranslate - prevTranslate || currentTranslate;
                    velocityTime = (new Date()).getTime();
                    prevTranslate = currentTranslate;
                }
                function handleTouchEnd (e) {
                    if (!isTouched || !isMoved) {
                        isTouched = isMoved = false;
                        return;
                    }
                    isTouched = isMoved = false;
                    col.wrapper.transition('');
                    if (returnTo) {
                        if (returnTo === 'min') {
                            col.wrapper.transform('translate3d(0,' + minTranslate + 'px,0)');
                        }
                        else col.wrapper.transform('translate3d(0,' + maxTranslate + 'px,0)');
                    }
                    touchEndTime = new Date().getTime();
                    var velocity, newTranslate;
                    if (touchEndTime - touchStartTime > 300) {
                        newTranslate = currentTranslate;
                    }
                    else {
                        velocity = Math.abs(velocityTranslate / (touchEndTime - velocityTime));
                        newTranslate = currentTranslate + velocityTranslate * p.params.momentumRatio;
                    }
        
                    newTranslate = Math.max(Math.min(newTranslate, maxTranslate), minTranslate);
        
                    // Active Index
                    var activeIndex = -Math.floor((newTranslate - maxTranslate)/itemHeight);
        
                    // Normalize translate
                    if (!p.params.freeMode) newTranslate = -activeIndex * itemHeight + maxTranslate;
        
                    // Transform wrapper
                    col.wrapper.transform('translate3d(0,' + (parseInt(newTranslate,10)) + 'px,0)');
        
                    // Update items
                    col.updateItems(activeIndex, newTranslate, '', true);
        
                    // Watch items
                    if (p.params.updateValuesOnMomentum) {
                        updateDuringScroll();
                        col.wrapper.transitionEnd(function(){
                            $.cancelAnimationFrame(animationFrameId);
                        });
                    }
        
                    // Allow click
                    setTimeout(function () {
                        allowItemClick = true;
                    }, 100);
                }
        
                function handleClick(e) {
                    if (!allowItemClick) return;
                    $.cancelAnimationFrame(animationFrameId);
                    /*jshint validthis:true */
                    var value = $(this).attr('data-picker-value');
                    col.setValue(value);
                }
        
                col.initEvents = function (detach) {
                    var method = detach ? 'off' : 'on';
                    col.container[method](app.touchEvents.start, handleTouchStart);
                    col.container[method](app.touchEvents.move, handleTouchMove);
                    col.container[method](app.touchEvents.end, handleTouchEnd);
                    col.items[method]('click', handleClick);
                };
                col.destroyEvents = function () {
                    col.initEvents(true);
                };
        
                col.container[0].f7DestroyPickerCol = function () {
                    col.destroyEvents();
                };
        
                col.initEvents();
        
            };
            p.destroyPickerCol = function (colContainer) {
                colContainer = $(colContainer);
                if ('f7DestroyPickerCol' in colContainer[0]) colContainer[0].f7DestroyPickerCol();
            };
            // Resize cols
            function resizeCols() {
                if (!p.opened) return;
                for (var i = 0; i < p.cols.length; i++) {
                    if (!p.cols[i].divider) {
                        p.cols[i].calcSize();
                        p.cols[i].setValue(p.cols[i].value, 0, false);
                    }
                }
            }
            $(window).on('resize', resizeCols);
        
            // HTML Layout
            p.columnHTML = function (col, onlyItems) {
                var columnItemsHTML = '';
                var columnHTML = '';
                if (col.divider) {
                    columnHTML += '<div class="picker-items-col picker-items-col-divider ' + (col.textAlign ? 'picker-items-col-' + col.textAlign : '') + ' ' + (col.cssClass || '') + '">' + col.content + '</div>';
                }
                else {
                    for (var j = 0; j < col.values.length; j++) {
                        columnItemsHTML += '<div class="picker-item" data-picker-value="' + col.values[j] + '">' + (col.displayValues ? col.displayValues[j] : col.values[j]) + '</div>';
                    }
                    columnHTML += '<div class="picker-items-col ' + (col.textAlign ? 'picker-items-col-' + col.textAlign : '') + ' ' + (col.cssClass || '') + '"><div class="picker-items-col-wrapper">' + columnItemsHTML + '</div></div>';
                }
                return onlyItems ? columnItemsHTML : columnHTML;
            };
            p.layout = function () {
                var pickerHTML = '';
                var pickerClass = '';
                var i;
                p.cols = [];
                var colsHTML = '';
                for (i = 0; i < p.params.cols.length; i++) {
                    var col = p.params.cols[i];
                    colsHTML += p.columnHTML(p.params.cols[i]);
                    p.cols.push(col);
                }
                pickerClass = 'picker-modal picker-columns ' + (p.params.cssClass || '') + (p.params.rotateEffect ? ' picker-3d' : '');
                pickerHTML =
                    '<div class="' + (pickerClass) + '">' +
                        (p.params.toolbar ? p.params.toolbarTemplate.replace(/{{closeText}}/g, p.params.toolbarCloseText) : '') +
                        '<div class="picker-modal-inner picker-items">' +
                            colsHTML +
                            '<div class="picker-center-highlight"></div>' +
                        '</div>' +
                    '</div>';
                    
                p.pickerHTML = pickerHTML;    
            };
        
            // Input Events
            function openOnInput(e) {
                e.preventDefault();
                if (p.opened) return;
                p.open();
                if (p.params.scrollToInput && !isPopover()) {
                    var pageContent = p.input.parents('.page-content');
                    if (pageContent.length === 0) return;
        
                    var paddingTop = parseInt(pageContent.css('padding-top'), 10),
                        paddingBottom = parseInt(pageContent.css('padding-bottom'), 10),
                        pageHeight = pageContent[0].offsetHeight - paddingTop - p.container.height(),
                        pageScrollHeight = pageContent[0].scrollHeight - paddingTop - p.container.height(),
                        newPaddingBottom;
                    var inputTop = p.input.offset().top - paddingTop + p.input[0].offsetHeight;
                    if (inputTop > pageHeight) {
                        var scrollTop = pageContent.scrollTop() + inputTop - pageHeight;
                        if (scrollTop + pageHeight > pageScrollHeight) {
                            newPaddingBottom = scrollTop + pageHeight - pageScrollHeight + paddingBottom;
                            if (pageHeight === pageScrollHeight) {
                                newPaddingBottom = p.container.height();
                            }
                            pageContent.css({'padding-bottom': (newPaddingBottom) + 'px'});
                        }
                        pageContent.scrollTop(scrollTop, 300);
                    }
                }
            }
            function closeOnHTMLClick(e) {
                if (inPopover()) return;
                if (p.input && p.input.length > 0) {
                    if (e.target !== p.input[0] && $(e.target).parents('.picker-modal').length === 0) p.close();
                }
                else {
                    if ($(e.target).parents('.picker-modal').length === 0) p.close();   
                }
            }
        
            if (p.params.input) {
                p.input = $(p.params.input);
                if (p.input.length > 0) {
                    if (p.params.inputReadOnly) p.input.prop('readOnly', true);
                    if (!p.inline) {
                        p.input.on('click', openOnInput);    
                    }
                    if (p.params.inputReadOnly) {
                        p.input.on('focus mousedown', function (e) {
                            e.preventDefault();
                        });
                    }
                }
                    
            }
            
            if (!p.inline && p.params.closeByOutsideClick) $('html').on('click', closeOnHTMLClick);
        
            // Open
            function onPickerClose() {
                p.opened = false;
                if (p.input && p.input.length > 0) {
                    p.input.parents('.page-content').css({'padding-bottom': ''});
                    if (app.params.material) p.input.trigger('blur');
                }
                if (p.params.onClose) p.params.onClose(p);
        
                // Destroy events
                p.container.find('.picker-items-col').each(function () {
                    p.destroyPickerCol(this);
                });
            }
        
            p.opened = false;
            p.open = function () {
                var toPopover = isPopover();
        
                if (!p.opened) {
        
                    // Layout
                    p.layout();
        
                    // Append
                    if (toPopover) {
                        p.pickerHTML = '<div class="popover popover-picker-columns"><div class="popover-inner">' + p.pickerHTML + '</div></div>';
                        p.popover = app.popover(p.pickerHTML, p.params.input, true);
                        p.container = $(p.popover).find('.picker-modal');
                        $(p.popover).on('close', function () {
                            onPickerClose();
                        });
                    }
                    else if (p.inline) {
                        p.container = $(p.pickerHTML);
                        p.container.addClass('picker-modal-inline');
                        $(p.params.container).append(p.container);
                    }
                    else {
                        p.container = $(app.pickerModal(p.pickerHTML));
                        $(p.container)
                        .on('close', function () {
                            onPickerClose();
                        });
                    }
        
                    // Store picker instance
                    p.container[0].f7Picker = p;
        
                    // Init Events
                    p.container.find('.picker-items-col').each(function () {
                        var updateItems = true;
                        if ((!p.initialized && p.params.value) || (p.initialized && p.value)) updateItems = false;
                        p.initPickerCol(this, updateItems);
                    });
                    
                    // Set value
                    if (!p.initialized) {
                        if (p.value) p.setValue(p.value, 0);
                        else if (p.params.value) {
                            p.setValue(p.params.value, 0);
                        }
                    }
                    else {
                        if (p.value) p.setValue(p.value, 0);
                    }
        
                    // Material Focus
                    if (p.input && p.input.length > 0 && app.params.material) {
                        p.input.trigger('focus');
                    }
                }
        
                // Set flag
                p.opened = true;
                p.initialized = true;
        
                if (p.params.onOpen) p.params.onOpen(p);
            };
        
            // Close
            p.close = function () {
                if (!p.opened || p.inline) return;
                if (inPopover()) {
                    app.closeModal(p.popover);
                    return;
                }
                else {
                    app.closeModal(p.container);
                    return;
                }
            };
        
            // Destroy
            p.destroy = function () {
                p.close();
                if (p.params.input && p.input.length > 0) {
                    p.input.off('click focus', openOnInput);
                }
                $('html').off('click', closeOnHTMLClick);
                $(window).off('resize', resizeCols);
            };
        
            if (p.inline) {
                p.open();
            }
            else {
                if (!p.initialized && p.params.value) p.setValue(p.params.value);
            }
        
            return p;
        };
        app.picker = function (params) {
            return new Picker(params);
        };

        /*======================================================
        ************   Calendar   ************
        ======================================================*/
        var Calendar = function (params) {
            var p = this;
            var defaults = {
                monthNames: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August' , 'September' , 'October', 'November', 'December'],
                monthNamesShort: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                dayNames: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                dayNamesShort: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                firstDay: 1, // First day of the week, Monday
                weekendDays: [0, 6], // Sunday and Saturday
                multiple: false,
                rangePicker: false,
                dateFormat: 'yyyy-mm-dd',
                direction: 'horizontal', // or 'vertical'
                minDate: null,
                maxDate: null,
                disabled: null, // dates range of disabled days
                events: null, // dates range of days with events
                rangesClasses: null, //array with custom classes date ranges
                touchMove: true,
                animate: true,
                closeOnSelect: false,
                monthPicker: true,
                monthPickerTemplate:
                    '<div class="picker-calendar-month-picker">' +
                        '<a href="#" class="link icon-only picker-calendar-prev-month"><i class="icon icon-prev"></i></a>' +
                        '<span class="current-month-value"></span>' +
                        '<a href="#" class="link icon-only picker-calendar-next-month"><i class="icon icon-next"></i></a>' +
                    '</div>',
                yearPicker: true,
                yearPickerTemplate:
                    '<div class="picker-calendar-year-picker">' +
                        '<a href="#" class="link icon-only picker-calendar-prev-year"><i class="icon icon-prev"></i></a>' +
                        '<span class="current-year-value"></span>' +
                        '<a href="#" class="link icon-only picker-calendar-next-year"><i class="icon icon-next"></i></a>' +
                    '</div>',
                weekHeader: true,
                // Common settings
                closeByOutsideClick: true,
                scrollToInput: true,
                inputReadOnly: true,
                convertToPopover: true,
                onlyInPopover: false,
                toolbar: true,
                toolbarCloseText: 'Done',
                headerPlaceholder: 'Select date',
                header: app.params.material,
                footer: app.params.material,
                toolbarTemplate:
                    '<div class="toolbar">' +
                        '<div class="toolbar-inner">' +
                            '{{monthPicker}}' +
                            '{{yearPicker}}' +
                        '</div>' +
                    '</div>',
                headerTemplate:
                    '<div class="picker-header">' +
                        '<div class="picker-calendar-selected-date">{{placeholder}}</div>' +
                    '</div>',
                footerTemplate:
                    '<div class="picker-footer">' +
                        '<a href="#" class="button close-picker">{{closeText}}</a>' +
                    '</div>',
        
                /* Callbacks
                onMonthAdd
                onChange
                onOpen
                onClose
                onDayClick
                onMonthYearChangeStart
                onMonthYearChangeEnd
                */
            };
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined') {
                    params[def] = defaults[def];
                }
            }
            p.params = params;
            p.initialized = false;
        
            // Inline flag
            p.inline = p.params.container ? true : false;
        
            // Is horizontal
            p.isH = p.params.direction === 'horizontal';
        
            // RTL inverter
            var inverter = p.isH ? (app.rtl ? -1 : 1) : 1;
        
            // Animating flag
            p.animating = false;
        
            // Should be converted to popover
            function isPopover() {
                var toPopover = false;
                if (!p.params.convertToPopover && !p.params.onlyInPopover) return toPopover;
                if (!p.inline && p.params.input) {
                    if (p.params.onlyInPopover) toPopover = true;
                    else {
                        if (app.device.ios) {
                            toPopover = app.device.ipad ? true : false;
                        }
                        else {
                            if ($(window).width() >= 768) toPopover = true;
                        }
                    }
                }
                return toPopover;
            }
            function inPopover() {
                if (p.opened && p.container && p.container.length > 0 && p.container.parents('.popover').length > 0) return true;
                else return false;
            }
        
            // Format date
            function formatDate(date) {
                date = new Date(date);
                var year = date.getFullYear();
                var month = date.getMonth();
                var month1 = month + 1;
                var day = date.getDate();
                var weekDay = date.getDay();
        
                return p.params.dateFormat
                    .replace(/yyyy/g, year)
                    .replace(/yy/g, (year + '').substring(2))
                    .replace(/mm/g, month1 < 10 ? '0' + month1 : month1)
                    .replace(/m(\W+)/g, month1 + '$1')
                    .replace(/MM/g, p.params.monthNames[month])
                    .replace(/M(\W+)/g, p.params.monthNamesShort[month] + '$1')
                    .replace(/dd/g, day < 10 ? '0' + day : day)
                    .replace(/d(\W+)/g, day + '$1')
                    .replace(/DD/g, p.params.dayNames[weekDay])
                    .replace(/D(\W+)/g, p.params.dayNamesShort[weekDay] + '$1');
            }
        
        
            // Value
            p.addValue = function (value) {
                if (p.params.multiple) {
                    if (!p.value) p.value = [];
                    var inValuesIndex;
                    for (var i = 0; i < p.value.length; i++) {
                        if (new Date(value).getTime() === new Date(p.value[i]).getTime()) {
                            inValuesIndex = i;
                        }
                    }
                    if (typeof inValuesIndex === 'undefined') {
                        p.value.push(value);
                    }
                    else {
                        p.value.splice(inValuesIndex, 1);
                    }
                    p.updateValue();
                }
                else if (p.params.rangePicker) {
                    if (!p.value) p.value = [];
                    if (p.value.length === 2 || p.value.length === 0) {
                        p.value = [];
                    }
                    if (p.value[0] !== value) p.value.push(value);
                    else p.value = [];
                    p.value.sort(function (a,b) {
                        return a - b;
                    });
                    p.updateValue();
                }
                else {
                    p.value = [value];
                    p.updateValue();
                }
            };
            p.setValue = function (arrValues) {
                p.value = arrValues;
                p.updateValue();
            };
            p.updateValue = function (onlyHeader) {
                var i, inputValue;
                if (p.container && p.container.length > 0) {
                    p.wrapper.find('.picker-calendar-day-selected').removeClass('picker-calendar-day-selected');
                    var valueDate;
                    if (p.params.rangePicker && p.value.length === 2) {
                        for (i = p.value[0]; i <= p.value[1]; i += 24*60*60*1000) {
                            valueDate = new Date(i);
                            p.wrapper.find('.picker-calendar-day[data-date="' + valueDate.getFullYear() + '-' + valueDate.getMonth() + '-' + valueDate.getDate() + '"]').addClass('picker-calendar-day-selected');
                        }
                    }
                    else {
                        for (i = 0; i < p.value.length; i++) {
                            valueDate = new Date(p.value[i]);
                            p.wrapper.find('.picker-calendar-day[data-date="' + valueDate.getFullYear() + '-' + valueDate.getMonth() + '-' + valueDate.getDate() + '"]').addClass('picker-calendar-day-selected');
                        }
                    }
                }
        
                if (p.params.onChange) {
                    p.params.onChange(p, p.value);
                }
                if ((p.input && p.input.length > 0) || (app.params.material && p.params.header)) {
                    if (p.params.formatValue) inputValue = p.params.formatValue(p, p.value);
                    else {
                        inputValue = [];
                        for (i = 0; i < p.value.length; i++) {
                            inputValue.push(formatDate(p.value[i]));
                        }
                        inputValue = inputValue.join(p.params.rangePicker ? ' - ' : ', ');
                    }
                    if (app.params.material && p.params.header && p.container && p.container.length > 0) {
                        p.container.find('.picker-calendar-selected-date').text(inputValue);
                    }
                    if (p.input && p.input.length > 0 && !onlyHeader) {
                        $(p.input).val(inputValue);
                        $(p.input).trigger('change');
                    }
        
                }
            };
        
            // Columns Handlers
            p.initCalendarEvents = function () {
                var col;
                var allowItemClick = true;
                var isTouched, isMoved, touchStartX, touchStartY, touchCurrentX, touchCurrentY, touchStartTime, touchEndTime, startTranslate, currentTranslate, wrapperWidth, wrapperHeight, percentage, touchesDiff, isScrolling;
                function handleTouchStart (e) {
                    if (isMoved || isTouched) return;
                    // e.preventDefault();
                    isTouched = true;
                    touchStartX = touchCurrentY = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
                    touchStartY = touchCurrentY = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                    touchStartTime = (new Date()).getTime();
                    percentage = 0;
                    allowItemClick = true;
                    isScrolling = undefined;
                    startTranslate = currentTranslate = p.monthsTranslate;
                }
                function handleTouchMove (e) {
                    if (!isTouched) return;
        
                    touchCurrentX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                    touchCurrentY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                    if (typeof isScrolling === 'undefined') {
                        isScrolling = !!(isScrolling || Math.abs(touchCurrentY - touchStartY) > Math.abs(touchCurrentX - touchStartX));
                    }
                    if (p.isH && isScrolling) {
                        isTouched = false;
                        return;
                    }
                    e.preventDefault();
                    if (p.animating) {
                        isTouched = false;
                        return;
                    }
                    allowItemClick = false;
                    if (!isMoved) {
                        // First move
                        isMoved = true;
                        wrapperWidth = p.wrapper[0].offsetWidth;
                        wrapperHeight = p.wrapper[0].offsetHeight;
                        p.wrapper.transition(0);
                    }
                    e.preventDefault();
        
                    touchesDiff = p.isH ? touchCurrentX - touchStartX : touchCurrentY - touchStartY;
                    percentage = touchesDiff/(p.isH ? wrapperWidth : wrapperHeight);
                    currentTranslate = (p.monthsTranslate * inverter + percentage) * 100;
        
                    // Transform wrapper
                    p.wrapper.transform('translate3d(' + (p.isH ? currentTranslate : 0) + '%, ' + (p.isH ? 0 : currentTranslate) + '%, 0)');
        
                }
                function handleTouchEnd (e) {
                    if (!isTouched || !isMoved) {
                        isTouched = isMoved = false;
                        return;
                    }
                    isTouched = isMoved = false;
        
                    touchEndTime = new Date().getTime();
                    if (touchEndTime - touchStartTime < 300) {
                        if (Math.abs(touchesDiff) < 10) {
                            p.resetMonth();
                        }
                        else if (touchesDiff >= 10) {
                            if (app.rtl) p.nextMonth();
                            else p.prevMonth();
                        }
                        else {
                            if (app.rtl) p.prevMonth();
                            else p.nextMonth();
                        }
                    }
                    else {
                        if (percentage <= -0.5) {
                            if (app.rtl) p.prevMonth();
                            else p.nextMonth();
                        }
                        else if (percentage >= 0.5) {
                            if (app.rtl) p.nextMonth();
                            else p.prevMonth();
                        }
                        else {
                            p.resetMonth();
                        }
                    }
        
                    // Allow click
                    setTimeout(function () {
                        allowItemClick = true;
                    }, 100);
                }
        
                function handleDayClick(e) {
                    if (!allowItemClick) return;
                    var day = $(e.target).parents('.picker-calendar-day');
                    if (day.length === 0 && $(e.target).hasClass('picker-calendar-day')) {
                        day = $(e.target);
                    }
                    if (day.length === 0) return;
                    if (day.hasClass('picker-calendar-day-selected') && !(p.params.multiple || p.params.rangePicker)) return;
                    if (day.hasClass('picker-calendar-day-disabled')) return;
                    if (!p.params.rangePicker) {
                        if (day.hasClass('picker-calendar-day-next')) p.nextMonth();
                        if (day.hasClass('picker-calendar-day-prev')) p.prevMonth();
                    }
                    var dateYear = day.attr('data-year');
                    var dateMonth = day.attr('data-month');
                    var dateDay = day.attr('data-day');
                    if (p.params.onDayClick) {
                        p.params.onDayClick(p, day[0], dateYear, dateMonth, dateDay);
                    }
                    p.addValue(new Date(dateYear, dateMonth, dateDay).getTime());
                    if (p.params.closeOnSelect) {
                        if (p.params.rangePicker && p.value.length === 2 || !p.params.rangePicker) p.close();
                    }
                }
        
                p.container.find('.picker-calendar-prev-month').on('click', p.prevMonth);
                p.container.find('.picker-calendar-next-month').on('click', p.nextMonth);
                p.container.find('.picker-calendar-prev-year').on('click', p.prevYear);
                p.container.find('.picker-calendar-next-year').on('click', p.nextYear);
                p.wrapper.on('click', handleDayClick);
                if (p.params.touchMove) {
                    p.wrapper.on(app.touchEvents.start, handleTouchStart);
                    p.wrapper.on(app.touchEvents.move, handleTouchMove);
                    p.wrapper.on(app.touchEvents.end, handleTouchEnd);
                }
        
                p.container[0].f7DestroyCalendarEvents = function () {
                    p.container.find('.picker-calendar-prev-month').off('click', p.prevMonth);
                    p.container.find('.picker-calendar-next-month').off('click', p.nextMonth);
                    p.container.find('.picker-calendar-prev-year').off('click', p.prevYear);
                    p.container.find('.picker-calendar-next-year').off('click', p.nextYear);
                    p.wrapper.off('click', handleDayClick);
                    if (p.params.touchMove) {
                        p.wrapper.off(app.touchEvents.start, handleTouchStart);
                        p.wrapper.off(app.touchEvents.move, handleTouchMove);
                        p.wrapper.off(app.touchEvents.end, handleTouchEnd);
                    }
                };
        
        
            };
            p.destroyCalendarEvents = function (colContainer) {
                if ('f7DestroyCalendarEvents' in p.container[0]) p.container[0].f7DestroyCalendarEvents();
            };
        
            // Scan Dates Range
            p.dateInRange = function (dayDate, range) {
                var match = false;
                var i;
                if (!range) return false;
                if ($.isArray(range)) {
                    for (i = 0; i < range.length; i ++) {
                        if (range[i].from || range[i].to) {
                            if (range[i].from && range[i].to) {
                                if ((dayDate <= new Date(range[i].to).getTime()) && (dayDate >= new Date(range[i].from).getTime())) {
                                    match = true;
                                }
                            }
                            else if (range[i].from) {
                                if (dayDate >= new Date(range[i].from).getTime()) {
                                    match = true;
                                }
                            }
                            else if (range[i].to) {
                                if (dayDate <= new Date(range[i].to).getTime()) {
                                    match = true;
                                }
                            }
                        } else if (dayDate === new Date(range[i]).getTime()) {
                            match = true;
                        }
                    }
                }
                else if (range.from || range.to) {
                    if (range.from && range.to) {
                        if ((dayDate <= new Date(range.to).getTime()) && (dayDate >= new Date(range.from).getTime())) {
                            match = true;
                        }
                    }
                    else if (range.from) {
                        if (dayDate >= new Date(range.from).getTime()) {
                            match = true;
                        }
                    }
                    else if (range.to) {
                        if (dayDate <= new Date(range.to).getTime()) {
                            match = true;
                        }
                    }
                }
                else if (typeof range === 'function') {
                    match = range(new Date(dayDate));
                }
                return match;
            };
            // Calendar Methods
            p.daysInMonth = function (date) {
                var d = new Date(date);
                return new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
            };
            p.monthHTML = function (date, offset) {
                date = new Date(date);
                var year = date.getFullYear(),
                    month = date.getMonth(),
                    day = date.getDate();
                if (offset === 'next') {
                    if (month === 11) date = new Date(year + 1, 0);
                    else date = new Date(year, month + 1, 1);
                }
                if (offset === 'prev') {
                    if (month === 0) date = new Date(year - 1, 11);
                    else date = new Date(year, month - 1, 1);
                }
                if (offset === 'next' || offset === 'prev') {
                    month = date.getMonth();
                    year = date.getFullYear();
                }
                var daysInPrevMonth = p.daysInMonth(new Date(date.getFullYear(), date.getMonth()).getTime() - 10 * 24 * 60 * 60 * 1000),
                    daysInMonth = p.daysInMonth(date),
                    firstDayOfMonthIndex = new Date(date.getFullYear(), date.getMonth()).getDay();
                if (firstDayOfMonthIndex === 0) firstDayOfMonthIndex = 7;
        
                var dayDate, currentValues = [], i, j, k,
                    rows = 6, cols = 7,
                    monthHTML = '',
                    dayIndex = 0 + (p.params.firstDay - 1),
                    today = new Date().setHours(0,0,0,0),
                    minDate = p.params.minDate ? new Date(p.params.minDate).getTime() : null,
                    maxDate = p.params.maxDate ? new Date(p.params.maxDate).getTime() : null,
                    disabled,
                    hasEvent;
        
                if (p.value && p.value.length) {
                    for (i = 0; i < p.value.length; i++) {
                        currentValues.push(new Date(p.value[i]).setHours(0,0,0,0));
                    }
                }
        
                for (i = 1; i <= rows; i++) {
                    var rowHTML = '';
                    var row = i;
                    for (j = 1; j <= cols; j++) {
                        var col = j;
                        dayIndex ++;
                        var dayNumber = dayIndex - firstDayOfMonthIndex;
                        var weekDayIndex = (col - 1 + p.params.firstDay > 6) ? (col - 1 - 7 + p.params.firstDay) : (col - 1 + p.params.firstDay);
                        var addClass = '';
                        if (dayNumber < 0) {
                            dayNumber = daysInPrevMonth + dayNumber + 1;
                            addClass += ' picker-calendar-day-prev';
                            dayDate = new Date(month - 1 < 0 ? year - 1 : year, month - 1 < 0 ? 11 : month - 1, dayNumber).getTime();
                        }
                        else {
                            dayNumber = dayNumber + 1;
                            if (dayNumber > daysInMonth) {
                                dayNumber = dayNumber - daysInMonth;
                                addClass += ' picker-calendar-day-next';
                                dayDate = new Date(month + 1 > 11 ? year + 1 : year, month + 1 > 11 ? 0 : month + 1, dayNumber).getTime();
                            }
                            else {
                                dayDate = new Date(year, month, dayNumber).getTime();
                            }
                        }
                        // Today
                        if (dayDate === today) addClass += ' picker-calendar-day-today';
                        // Selected
                        if (p.params.rangePicker && currentValues.length === 2) {
                            if (dayDate >= currentValues[0] && dayDate <= currentValues[1]) addClass += ' picker-calendar-day-selected';
                        }
                        else {
                            if (currentValues.indexOf(dayDate) >= 0) addClass += ' picker-calendar-day-selected';
                        }
                        // Weekend
                        if (p.params.weekendDays.indexOf(weekDayIndex) >= 0) {
                            addClass += ' picker-calendar-day-weekend';
                        }
                        // Has Events
                        hasEvent = false;
                        if (p.params.events) {
                            if (p.dateInRange(dayDate, p.params.events)) {
                                hasEvent = true;
                            }
                        }
                        if (hasEvent) {
                            addClass += ' picker-calendar-day-has-events';
                        }
                        // Custom Ranges
                        if (p.params.rangesClasses) {
                            for (k = 0; k < p.params.rangesClasses.length; k++) {
                                if (p.dateInRange(dayDate, p.params.rangesClasses[k].range)) {
                                    addClass += ' ' + p.params.rangesClasses[k].cssClass;
                                }
                            }
                        }
                        // Disabled
                        disabled = false;
                        if ((minDate && dayDate < minDate) || (maxDate && dayDate > maxDate)) {
                            disabled = true;
                        }
                        if (p.params.disabled) {
                            if (p.dateInRange(dayDate, p.params.disabled)) {
                                disabled = true;
                            }
                        }
                        if (disabled) {
                            addClass += ' picker-calendar-day-disabled';
                        }
        
        
                        dayDate = new Date(dayDate);
                        var dayYear = dayDate.getFullYear();
                        var dayMonth = dayDate.getMonth();
                        rowHTML += '<div data-year="' + dayYear + '" data-month="' + dayMonth + '" data-day="' + dayNumber + '" class="picker-calendar-day' + (addClass) + '" data-date="' + (dayYear + '-' + dayMonth + '-' + dayNumber) + '"><span>'+dayNumber+'</span></div>';
                    }
                    monthHTML += '<div class="picker-calendar-row">' + rowHTML + '</div>';
                }
                monthHTML = '<div class="picker-calendar-month" data-year="' + year + '" data-month="' + month + '">' + monthHTML + '</div>';
                return monthHTML;
            };
            p.animating = false;
            p.updateCurrentMonthYear = function (dir) {
                if (typeof dir === 'undefined') {
                    p.currentMonth = parseInt(p.months.eq(1).attr('data-month'), 10);
                    p.currentYear = parseInt(p.months.eq(1).attr('data-year'), 10);
                }
                else {
                    p.currentMonth = parseInt(p.months.eq(dir === 'next' ? (p.months.length - 1) : 0).attr('data-month'), 10);
                    p.currentYear = parseInt(p.months.eq(dir === 'next' ? (p.months.length - 1) : 0).attr('data-year'), 10);
                }
                p.container.find('.current-month-value').text(p.params.monthNames[p.currentMonth]);
                p.container.find('.current-year-value').text(p.currentYear);
        
            };
            p.onMonthChangeStart = function (dir) {
                p.updateCurrentMonthYear(dir);
                p.months.removeClass('picker-calendar-month-current picker-calendar-month-prev picker-calendar-month-next');
                var currentIndex = dir === 'next' ? p.months.length - 1 : 0;
        
                p.months.eq(currentIndex).addClass('picker-calendar-month-current');
                p.months.eq(dir === 'next' ? currentIndex - 1 : currentIndex + 1).addClass(dir === 'next' ? 'picker-calendar-month-prev' : 'picker-calendar-month-next');
        
                if (p.params.onMonthYearChangeStart) {
                    p.params.onMonthYearChangeStart(p, p.currentYear, p.currentMonth);
                }
            };
            p.onMonthChangeEnd = function (dir, rebuildBoth) {
                p.animating = false;
                var nextMonthHTML, prevMonthHTML, newMonthHTML;
                p.wrapper.find('.picker-calendar-month:not(.picker-calendar-month-prev):not(.picker-calendar-month-current):not(.picker-calendar-month-next)').remove();
        
                if (typeof dir === 'undefined') {
                    dir = 'next';
                    rebuildBoth = true;
                }
                if (!rebuildBoth) {
                    newMonthHTML = p.monthHTML(new Date(p.currentYear, p.currentMonth), dir);
                }
                else {
                    p.wrapper.find('.picker-calendar-month-next, .picker-calendar-month-prev').remove();
                    prevMonthHTML = p.monthHTML(new Date(p.currentYear, p.currentMonth), 'prev');
                    nextMonthHTML = p.monthHTML(new Date(p.currentYear, p.currentMonth), 'next');
                }
                if (dir === 'next' || rebuildBoth) {
                    p.wrapper.append(newMonthHTML || nextMonthHTML);
                }
                if (dir === 'prev' || rebuildBoth) {
                    p.wrapper.prepend(newMonthHTML || prevMonthHTML);
                }
                p.months = p.wrapper.find('.picker-calendar-month');
                p.setMonthsTranslate(p.monthsTranslate);
                if (p.params.onMonthAdd) {
                    p.params.onMonthAdd(p, dir === 'next' ? p.months.eq(p.months.length - 1)[0] : p.months.eq(0)[0]);
                }
                if (p.params.onMonthYearChangeEnd) {
                    p.params.onMonthYearChangeEnd(p, p.currentYear, p.currentMonth);
                }
            };
            p.setMonthsTranslate = function (translate) {
                translate = translate || p.monthsTranslate || 0;
                if (typeof p.monthsTranslate === 'undefined') p.monthsTranslate = translate;
                p.months.removeClass('picker-calendar-month-current picker-calendar-month-prev picker-calendar-month-next');
                var prevMonthTranslate = -(translate + 1) * 100 * inverter;
                var currentMonthTranslate = -translate * 100 * inverter;
                var nextMonthTranslate = -(translate - 1) * 100 * inverter;
                p.months.eq(0).transform('translate3d(' + (p.isH ? prevMonthTranslate : 0) + '%, ' + (p.isH ? 0 : prevMonthTranslate) + '%, 0)').addClass('picker-calendar-month-prev');
                p.months.eq(1).transform('translate3d(' + (p.isH ? currentMonthTranslate : 0) + '%, ' + (p.isH ? 0 : currentMonthTranslate) + '%, 0)').addClass('picker-calendar-month-current');
                p.months.eq(2).transform('translate3d(' + (p.isH ? nextMonthTranslate : 0) + '%, ' + (p.isH ? 0 : nextMonthTranslate) + '%, 0)').addClass('picker-calendar-month-next');
            };
            p.nextMonth = function (transition) {
                if (typeof transition === 'undefined' || typeof transition === 'object') {
                    transition = '';
                    if (!p.params.animate) transition = 0;
                }
                var nextMonth = parseInt(p.months.eq(p.months.length - 1).attr('data-month'), 10);
                var nextYear = parseInt(p.months.eq(p.months.length - 1).attr('data-year'), 10);
                var nextDate = new Date(nextYear, nextMonth);
                var nextDateTime = nextDate.getTime();
                var transitionEndCallback = p.animating ? false : true;
                if (p.params.maxDate) {
                    if (nextDateTime > new Date(p.params.maxDate).getTime()) {
                        return p.resetMonth();
                    }
                }
                p.monthsTranslate --;
                if (nextMonth === p.currentMonth) {
                    var nextMonthTranslate = -(p.monthsTranslate) * 100 * inverter;
                    var nextMonthHTML = $(p.monthHTML(nextDateTime, 'next')).transform('translate3d(' + (p.isH ? nextMonthTranslate : 0) + '%, ' + (p.isH ? 0 : nextMonthTranslate) + '%, 0)').addClass('picker-calendar-month-next');
                    p.wrapper.append(nextMonthHTML[0]);
                    p.months = p.wrapper.find('.picker-calendar-month');
                    if (p.params.onMonthAdd) {
                        p.params.onMonthAdd(p, p.months.eq(p.months.length - 1)[0]);
                    }
                }
                p.animating = true;
                p.onMonthChangeStart('next');
                var translate = (p.monthsTranslate * 100) * inverter;
        
                p.wrapper.transition(transition).transform('translate3d(' + (p.isH ? translate : 0) + '%, ' + (p.isH ? 0 : translate) + '%, 0)');
                if (transitionEndCallback) {
                    p.wrapper.transitionEnd(function () {
                        p.onMonthChangeEnd('next');
                    });
                }
                if (!p.params.animate) {
                    p.onMonthChangeEnd('next');
                }
            };
            p.prevMonth = function (transition) {
                if (typeof transition === 'undefined' || typeof transition === 'object') {
                    transition = '';
                    if (!p.params.animate) transition = 0;
                }
                var prevMonth = parseInt(p.months.eq(0).attr('data-month'), 10);
                var prevYear = parseInt(p.months.eq(0).attr('data-year'), 10);
                var prevDate = new Date(prevYear, prevMonth + 1, -1);
                var prevDateTime = prevDate.getTime();
                var transitionEndCallback = p.animating ? false : true;
                if (p.params.minDate) {
                    if (prevDateTime < new Date(p.params.minDate).getTime()) {
                        return p.resetMonth();
                    }
                }
                p.monthsTranslate ++;
                if (prevMonth === p.currentMonth) {
                    var prevMonthTranslate = -(p.monthsTranslate) * 100 * inverter;
                    var prevMonthHTML = $(p.monthHTML(prevDateTime, 'prev')).transform('translate3d(' + (p.isH ? prevMonthTranslate : 0) + '%, ' + (p.isH ? 0 : prevMonthTranslate) + '%, 0)').addClass('picker-calendar-month-prev');
                    p.wrapper.prepend(prevMonthHTML[0]);
                    p.months = p.wrapper.find('.picker-calendar-month');
                    if (p.params.onMonthAdd) {
                        p.params.onMonthAdd(p, p.months.eq(0)[0]);
                    }
                }
                p.animating = true;
                p.onMonthChangeStart('prev');
                var translate = (p.monthsTranslate * 100) * inverter;
                p.wrapper.transition(transition).transform('translate3d(' + (p.isH ? translate : 0) + '%, ' + (p.isH ? 0 : translate) + '%, 0)');
                if (transitionEndCallback) {
                    p.wrapper.transitionEnd(function () {
                        p.onMonthChangeEnd('prev');
                    });
                }
                if (!p.params.animate) {
                    p.onMonthChangeEnd('prev');
                }
            };
            p.resetMonth = function (transition) {
                if (typeof transition === 'undefined') transition = '';
                var translate = (p.monthsTranslate * 100) * inverter;
                p.wrapper.transition(transition).transform('translate3d(' + (p.isH ? translate : 0) + '%, ' + (p.isH ? 0 : translate) + '%, 0)');
            };
            p.setYearMonth = function (year, month, transition) {
                if (typeof year === 'undefined') year = p.currentYear;
                if (typeof month === 'undefined') month = p.currentMonth;
                if (typeof transition === 'undefined' || typeof transition === 'object') {
                    transition = '';
                    if (!p.params.animate) transition = 0;
                }
                var targetDate;
                if (year < p.currentYear) {
                    targetDate = new Date(year, month + 1, -1).getTime();
                }
                else {
                    targetDate = new Date(year, month).getTime();
                }
                if (p.params.maxDate && targetDate > new Date(p.params.maxDate).getTime()) {
                    return false;
                }
                if (p.params.minDate && targetDate < new Date(p.params.minDate).getTime()) {
                    return false;
                }
                var currentDate = new Date(p.currentYear, p.currentMonth).getTime();
                var dir = targetDate > currentDate ? 'next' : 'prev';
                var newMonthHTML = p.monthHTML(new Date(year, month));
                p.monthsTranslate = p.monthsTranslate || 0;
                var prevTranslate = p.monthsTranslate;
                var monthTranslate, wrapperTranslate;
                var transitionEndCallback = p.animating ? false : true;
                if (targetDate > currentDate) {
                    // To next
                    p.monthsTranslate --;
                    if (!p.animating) p.months.eq(p.months.length - 1).remove();
                    p.wrapper.append(newMonthHTML);
                    p.months = p.wrapper.find('.picker-calendar-month');
                    monthTranslate = -(prevTranslate - 1) * 100 * inverter;
                    p.months.eq(p.months.length - 1).transform('translate3d(' + (p.isH ? monthTranslate : 0) + '%, ' + (p.isH ? 0 : monthTranslate) + '%, 0)').addClass('picker-calendar-month-next');
                }
                else {
                    // To prev
                    p.monthsTranslate ++;
                    if (!p.animating) p.months.eq(0).remove();
                    p.wrapper.prepend(newMonthHTML);
                    p.months = p.wrapper.find('.picker-calendar-month');
                    monthTranslate = -(prevTranslate + 1) * 100 * inverter;
                    p.months.eq(0).transform('translate3d(' + (p.isH ? monthTranslate : 0) + '%, ' + (p.isH ? 0 : monthTranslate) + '%, 0)').addClass('picker-calendar-month-prev');
                }
                if (p.params.onMonthAdd) {
                    p.params.onMonthAdd(p, dir === 'next' ? p.months.eq(p.months.length - 1)[0] : p.months.eq(0)[0]);
                }
                p.animating = true;
                p.onMonthChangeStart(dir);
                wrapperTranslate = (p.monthsTranslate * 100) * inverter;
                p.wrapper.transition(transition).transform('translate3d(' + (p.isH ? wrapperTranslate : 0) + '%, ' + (p.isH ? 0 : wrapperTranslate) + '%, 0)');
                if (transitionEndCallback) {
                   p.wrapper.transitionEnd(function () {
                        p.onMonthChangeEnd(dir, true);
                    });
                }
                if (!p.params.animate) {
                    p.onMonthChangeEnd(dir);
                }
            };
            p.nextYear = function () {
                p.setYearMonth(p.currentYear + 1);
            };
            p.prevYear = function () {
                p.setYearMonth(p.currentYear - 1);
            };
        
        
            // HTML Layout
            p.layout = function () {
                var pickerHTML = '';
                var pickerClass = '';
                var i;
        
                var layoutDate = p.value && p.value.length ? p.value[0] : new Date().setHours(0,0,0,0);
                var prevMonthHTML = p.monthHTML(layoutDate, 'prev');
                var currentMonthHTML = p.monthHTML(layoutDate);
                var nextMonthHTML = p.monthHTML(layoutDate, 'next');
                var monthsHTML = '<div class="picker-calendar-months"><div class="picker-calendar-months-wrapper">' + (prevMonthHTML + currentMonthHTML + nextMonthHTML) + '</div></div>';
                // Week days header
                var weekHeaderHTML = '';
                if (p.params.weekHeader) {
                    for (i = 0; i < 7; i++) {
                        var weekDayIndex = (i + p.params.firstDay > 6) ? (i - 7 + p.params.firstDay) : (i + p.params.firstDay);
                        var dayName = p.params.dayNamesShort[weekDayIndex];
                        weekHeaderHTML += '<div class="picker-calendar-week-day ' + ((p.params.weekendDays.indexOf(weekDayIndex) >= 0) ? 'picker-calendar-week-day-weekend' : '') + '"> ' + dayName + '</div>';
        
                    }
                    weekHeaderHTML = '<div class="picker-calendar-week-days">' + weekHeaderHTML + '</div>';
                }
                pickerClass = 'picker-modal picker-calendar' +
                            (p.params.rangePicker ? ' picker-calendar-range' : '') +
                            (p.params.cssClass ? ' ' + p.params.cssClass : '');
                var toolbarHTML = p.params.toolbar ? p.params.toolbarTemplate.replace(/{{closeText}}/g, p.params.toolbarCloseText) : '';
                if (p.params.toolbar) {
                    toolbarHTML = p.params.toolbarTemplate
                        .replace(/{{closeText}}/g, p.params.toolbarCloseText)
                        .replace(/{{monthPicker}}/g, (p.params.monthPicker ? p.params.monthPickerTemplate : ''))
                        .replace(/{{yearPicker}}/g, (p.params.yearPicker ? p.params.yearPickerTemplate : ''));
                }
                var headerHTML = p.params.header ? p.params.headerTemplate.replace(/{{closeText}}/g, p.params.toolbarCloseText).replace(/{{placeholder}}/g, p.params.headerPlaceholder) : '';
                var footerHTML = p.params.footer ? p.params.footerTemplate.replace(/{{closeText}}/g, p.params.toolbarCloseText) : '';
        
                pickerHTML =
                    '<div class="' + (pickerClass) + '">' +
                        headerHTML +
                        footerHTML +
                        toolbarHTML +
                        '<div class="picker-modal-inner">' +
                            weekHeaderHTML +
                            monthsHTML +
                        '</div>' +
                    '</div>';
        
        
                p.pickerHTML = pickerHTML;
            };
        
            // Input Events
            function openOnInput(e) {
                e.preventDefault();
                if (p.opened) return;
                p.open();
                if (p.params.scrollToInput && !isPopover() && !app.params.material) {
                    var pageContent = p.input.parents('.page-content');
                    if (pageContent.length === 0) return;
        
                    var paddingTop = parseInt(pageContent.css('padding-top'), 10),
                        paddingBottom = parseInt(pageContent.css('padding-bottom'), 10),
                        pageHeight = pageContent[0].offsetHeight - paddingTop - p.container.height(),
                        pageScrollHeight = pageContent[0].scrollHeight - paddingTop - p.container.height(),
                        newPaddingBottom;
        
                    var inputTop = p.input.offset().top - paddingTop + p.input[0].offsetHeight;
                    if (inputTop > pageHeight) {
                        var scrollTop = pageContent.scrollTop() + inputTop - pageHeight;
                        if (scrollTop + pageHeight > pageScrollHeight) {
                            newPaddingBottom = scrollTop + pageHeight - pageScrollHeight + paddingBottom;
                            if (pageHeight === pageScrollHeight) {
                                newPaddingBottom = p.container.height();
                            }
                            pageContent.css({'padding-bottom': (newPaddingBottom) + 'px'});
                        }
                        pageContent.scrollTop(scrollTop, 300);
                    }
                }
            }
            function closeOnHTMLClick(e) {
                if (inPopover()) return;
                if (p.input && p.input.length > 0) {
                    if (e.target !== p.input[0] && $(e.target).parents('.picker-modal').length === 0) p.close();
                }
                else {
                    if ($(e.target).parents('.picker-modal').length === 0) p.close();
                }
            }
        
            if (p.params.input) {
                p.input = $(p.params.input);
                if (p.input.length > 0) {
                    if (p.params.inputReadOnly) p.input.prop('readOnly', true);
                    if (!p.inline) {
                        p.input.on('click', openOnInput);
                    }
                    if (p.params.inputReadOnly) {
                        p.input.on('focus mousedown', function (e) {
                            e.preventDefault();
                        });
                    }
                }
        
            }
        
            if (!p.inline && p.params.closeByOutsideClick) $('html').on('click', closeOnHTMLClick);
        
            // Open
            function onPickerClose() {
                p.opened = false;
                if (p.input && p.input.length > 0) {
                    p.input.parents('.page-content').css({'padding-bottom': ''});
                    if (app.params.material) p.input.trigger('blur');
                }
                if (p.params.onClose) p.params.onClose(p);
        
                // Destroy events
                p.destroyCalendarEvents();
            }
        
            p.opened = false;
            p.open = function () {
                var toPopover = isPopover();
                var updateValue = false;
                if (!p.opened) {
                    // Set date value
                    if (!p.value) {
                        if (p.params.value) {
                            p.value = p.params.value;
                            updateValue = true;
                        }
                    }
        
                    // Layout
                    p.layout();
        
                    // Append
                    if (toPopover) {
                        p.pickerHTML = '<div class="popover popover-picker-calendar"><div class="popover-inner">' + p.pickerHTML + '</div></div>';
                        p.popover = app.popover(p.pickerHTML, p.params.input, true);
                        p.container = $(p.popover).find('.picker-modal');
                        $(p.popover).on('close', function () {
                            onPickerClose();
                        });
                    }
                    else if (p.inline) {
                        p.container = $(p.pickerHTML);
                        p.container.addClass('picker-modal-inline');
                        $(p.params.container).append(p.container);
                    }
                    else {
                        p.container = $(app.pickerModal(p.pickerHTML));
                        $(p.container)
                        .on('close', function () {
                            onPickerClose();
                        });
                    }
        
                    // Store calendar instance
                    p.container[0].f7Calendar = p;
                    p.wrapper = p.container.find('.picker-calendar-months-wrapper');
        
                    // Months
                    p.months = p.wrapper.find('.picker-calendar-month');
        
                    // Update current month and year
                    p.updateCurrentMonthYear();
        
                    // Set initial translate
                    p.monthsTranslate = 0;
                    p.setMonthsTranslate();
        
                    // Init events
                    p.initCalendarEvents();
        
                    // Update input value
                    if (updateValue) p.updateValue();
                    else if (app.params.material && p.value) p.updateValue(true);
        
                    // Material Focus
                    if (p.input && p.input.length > 0 && app.params.material) {
                        p.input.trigger('focus');
                    }
        
                }
        
                // Set flag
                p.opened = true;
                p.initialized = true;
                if (p.params.onMonthAdd) {
                    p.months.each(function () {
                        p.params.onMonthAdd(p, this);
                    });
                }
                if (p.params.onOpen) p.params.onOpen(p);
            };
        
            // Close
            p.close = function () {
                if (!p.opened || p.inline) return;
                if (inPopover()) {
                    app.closeModal(p.popover);
                    return;
                }
                else {
                    app.closeModal(p.container);
                    return;
                }
            };
        
            // Destroy
            p.destroy = function () {
                p.close();
                if (p.params.input && p.input.length > 0) {
                    p.input.off('click focus', openOnInput);
                }
                $('html').off('click', closeOnHTMLClick);
            };
        
            if (p.inline) {
                p.open();
            }
            else {
                if (!p.initialized && p.params.value) p.setValue(p.params.value);
            }
        
            return p;
        };
        app.calendar = function (params) {
            return new Calendar(params);
        };
        

        /*======================================================
        ************   Notifications   ************
        ======================================================*/
        var _tempNotificationElement;
        app.addNotification = function (params) {
            if (!params) return;
            
            if (typeof params.media === 'undefined') params.media = app.params.notificationMedia;
            if (typeof params.title === 'undefined') params.title = app.params.notificationTitle;
            if (typeof params.subtitle === 'undefined') params.subtitle = app.params.notificationSubtitle;
            if (typeof params.closeIcon === 'undefined') params.closeIcon = app.params.notificationCloseIcon;
            if (typeof params.hold === 'undefined') params.hold = app.params.notificationHold;
            if (typeof params.closeOnClick === 'undefined') params.closeOnClick = app.params.notificationCloseOnClick;
            if (typeof params.button === 'undefined') params.button = app.params.notificationCloseButtonText && {
                text: app.params.notificationCloseButtonText,
                close: true
            };
        
            if (!_tempNotificationElement) _tempNotificationElement = document.createElement('div');
        
            params.material = app.params.material;
        
            var container = $('.notifications');
            if (container.length === 0) {
                $('body').append('<div class="notifications list-block' + (params.material ? '' : ' media-list') + '"><ul></ul></div>');
                container = $('.notifications');
            }
            var list = container.children('ul');
            
            var notificationTemplate = app.params.notificationTemplate || 
                '{{#if custom}}' +
                '<li>{{custom}}</li>' +
                '{{else}}' +
                '<li class="notification-item notification-hidden">' +
                    '<div class="item-content">' +
                        '{{#if material}}' +
                            '<div class="item-inner">' +
                                '<div class="item-title">{{js "this.message || this.title || this.subtitle"}}</div>' +
                                '{{#if ../button}}{{#button}}' +
                                '<div class="item-after">' +
                                    '<a href="#" class="button {{#if color}}color-{{color}}{{/if}} {{#js_compare "this.close !== false"}}close-notification{{/js_compare}}">{{text}}</a>' +
                                '</div>' +
                                '{{/button}}{{/if}}' +
                            '</div>' +
                        '{{else}}' +
                            '{{#if media}}' +
                            '<div class="item-media">{{media}}</div>' +
                            '{{/if}}' +
                            '<div class="item-inner">' +
                                '<div class="item-title-row">' +
                                    '{{#if title}}' +
                                    '<div class="item-title">{{title}}</div>' +
                                    '{{/if}}' +
                                    '{{#if closeIcon}}' +
                                    '<div class="item-after"><a href="#" class="close-notification"><span></span></a></div>' +
                                    '{{/if}}' +
                                '</div>' +
                                '{{#if subtitle}}' +
                                '<div class="item-subtitle">{{subtitle}}</div>' +
                                '{{/if}}' +
                                '{{#if message}}' +
                                '<div class="item-text">{{message}}</div>' +
                                '</div>' +
                            '{{/if}}' +
                        '{{/if}}' +
                    '</div>' +
                '</li>' +
                '{{/if}}';
            if (!app._compiledTemplates.notification) {
                app._compiledTemplates.notification = t7.compile(notificationTemplate);
            }
            _tempNotificationElement.innerHTML = app._compiledTemplates.notification(params);
        
            var item = $(_tempNotificationElement).children();
        
            item.on('click', function (e) {
                var close = false;
                var target = $(e.target);
                if (params.material && target.hasClass('button')) {
                    if (params.button && params.button.onClick) params.button.onClick.call(target[0], e, item[0]);
                }
                if (target.is('.close-notification') || $(e.target).parents('.close-notification').length > 0) {
                    close = true;
                }
                else {
                    if (params.onClick) params.onClick(e, item[0]);
                    if (params.closeOnClick) close = true;
                }
                if (close) app.closeNotification(item[0]);
            });
            if (params.onClose) {
                item.data('f7NotificationOnClose', function () {
                    params.onClose(item[0]);
                });
            }
            if (params.additionalClass) {
                item.addClass(params.additionalClass);
            }
            if (params.hold) {
                setTimeout(function () {
                    if (item.length > 0) app.closeNotification(item[0]);
                }, params.hold);
            }
        
            list[params.material ? 'append' : 'prepend'](item[0]);
            container.show();
        
            var itemHeight = item.outerHeight(), clientLeft;
            if (params.material) {
                container.transform('translate3d(0, '+itemHeight+'px, 0)');
                container.transition(0);
        
                clientLeft = item[0].clientLeft;
        
                container.transform('translate3d(0, 0, 0)');
                container.transition('');
            }
            else {
                item.css('marginTop', -itemHeight + 'px');
                item.transition(0);
        
                clientLeft = item[0].clientLeft;
        
                item.transition('');
                item.css('marginTop', '0px');
            }
        
            container.transform('translate3d(0, 0,0)');
            item.removeClass('notification-hidden');
        
            return item[0];
        };
        app.closeNotification = function (item) {
            item = $(item);
            if (item.length === 0) return;
            if (item.hasClass('notification-item-removing')) return;
            var container = $('.notifications');
        
            var itemHeight = item.outerHeight();
            item.css('height', itemHeight + 'px').transition(0).addClass('notification-item-removing');
            var clientLeft = item[0].clientLeft;
        
            item.css('height', '0px').transition('');
            if (item.data('f7NotificationOnClose')) item.data('f7NotificationOnClose')();
        
            if (container.find('.notification-item:not(.notification-item-removing)').length === 0) {
                container.transform('');
            }
        
            item.addClass('notification-hidden').transitionEnd(function () {
                item.remove();
                if (container.find('.notification-item').length === 0) {
                    container.hide();
                }
            });
        };

        /*===========================
        Compile Template7 Templates On App Init
        ===========================*/
        app.initTemplate7Templates = function () {
            if (!window.Template7) return;
            Template7.templates = Template7.templates || app.params.templates || {};
            Template7.data = Template7.data || app.params.template7Data || {};
            Template7.cache = Template7.cache || {};
        
            app.templates = Template7.templates;
            app.template7Data = Template7.data;
            app.template7Cache = Template7.cache;
        
            // Precompile templates on app init
            if (!app.params.precompileTemplates) return;
            $('script[type="text/template7"]').each(function () {
                var id = $(this).attr('id');
                if (!id) return;
                Template7.templates[id] = Template7.compile($(this).html());
            });
        };
        

        /*=======================================
        ************   Plugins API   ************
        =======================================*/
        var _plugins = [];
        app.initPlugins = function () {
            // Initialize plugins
            for (var plugin in app.plugins) {
                var p = app.plugins[plugin](app, app.params[plugin]);
                if (p) _plugins.push(p);
            }
        };
        // Plugin Hooks
        app.pluginHook = function (hook) {
            for (var i = 0; i < _plugins.length; i++) {
                if (_plugins[i].hooks && hook in _plugins[i].hooks) {
                    _plugins[i].hooks[hook](arguments[1], arguments[2], arguments[3], arguments[4], arguments[5]);
                }
            }
        };
        // Prevented by plugin
        app.pluginPrevent = function (action) {
            var prevent = false;
            for (var i = 0; i < _plugins.length; i++) {
                if (_plugins[i].prevents && action in _plugins[i].prevents) {
                    if (_plugins[i].prevents[action](arguments[1], arguments[2], arguments[3], arguments[4], arguments[5])) prevent = true;
                }
            }
            return prevent;
        };
        // Preprocess content by plugin
        app.pluginProcess = function (process, data) {
            var processed = data;
            for (var i = 0; i < _plugins.length; i++) {
                if (_plugins[i].preprocess && process in _plugins[i].preprocess) {
                    processed = _plugins[i].preprocess[process](data, arguments[2], arguments[3], arguments[4], arguments[5], arguments[6]);
                }
            }
            return processed;
        };
        
        

        /*======================================================
        ************   App Init   ************
        ======================================================*/
        app.init = function () {
            // Compile Template7 templates on app load
            if (app.initTemplate7Templates) app.initTemplate7Templates();
            
            // Init Plugins
            if (app.initPlugins) app.initPlugins();
            
            // Init Device
            if (app.getDeviceInfo) app.getDeviceInfo();
            
            // Init Click events
            if (app.initFastClicks && app.params.fastClicks) app.initFastClicks();
            if (app.initClickEvents) app.initClickEvents();
        
            // Init each page callbacks
            $('.page:not(.cached)').each(function () {
                app.initPageWithCallback(this);
            });
        
            // Init each navbar callbacks
            $('.navbar:not(.cached)').each(function () {
                app.initNavbarWithCallback(this); 
            });
            
            // Init resize events
            if (app.initResize) app.initResize();
        
            // Init push state
            if (app.initPushState && app.params.pushState) app.initPushState();
        
            // Init Live Swipeouts events
            if (app.initSwipeout && app.params.swipeout) app.initSwipeout();
        
            // Init Live Sortable events
            if (app.initSortable && app.params.sortable) app.initSortable();
        
            // Init Live Swipe Panels
            if (app.initSwipePanels && (app.params.swipePanel || app.params.swipePanelOnlyClose)) app.initSwipePanels();
            
            // Init Material Inputs
            if (app.params.material && app.initMaterialWatchInputs) app.initMaterialWatchInputs();
            
            // App Init callback
            if (app.params.onAppInit) app.params.onAppInit();
        
            // Plugin app init hook
            app.pluginHook('appInit');
        };
        if (app.params.init) app.init();
        

        //Return instance        
        return app;
    };
    

    /*===========================
    Dom7 Library
    ===========================*/
    var Dom7 = (function () {
        var Dom7 = function (arr) {
            var _this = this, i = 0;
            // Create array-like object
            for (i = 0; i < arr.length; i++) {
                _this[i] = arr[i];
            }
            _this.length = arr.length;
            // Return collection with methods
            return this;
        };
        var $ = function (selector, context) {
            var arr = [], i = 0;
            if (selector && !context) {
                if (selector instanceof Dom7) {
                    return selector;
                }
            }
            if (selector) {
                // String
                if (typeof selector === 'string') {
                    var els, tempParent, html;
                    selector = html = selector.trim();
                    if (html.indexOf('<') >= 0 && html.indexOf('>') >= 0) {
                        var toCreate = 'div';
                        if (html.indexOf('<li') === 0) toCreate = 'ul';
                        if (html.indexOf('<tr') === 0) toCreate = 'tbody';
                        if (html.indexOf('<td') === 0 || html.indexOf('<th') === 0) toCreate = 'tr';
                        if (html.indexOf('<tbody') === 0) toCreate = 'table';
                        if (html.indexOf('<option') === 0) toCreate = 'select';
                        tempParent = document.createElement(toCreate);
                        tempParent.innerHTML = html;
                        for (i = 0; i < tempParent.childNodes.length; i++) {
                            arr.push(tempParent.childNodes[i]);
                        }
                    }
                    else {
                        if (!context && selector[0] === '#' && !selector.match(/[ .<>:~]/)) {
                            // Pure ID selector
                            els = [document.getElementById(selector.split('#')[1])];
                        }
                        else {
                            // Other selectors
                            els = (context || document).querySelectorAll(selector);
                        }
                        for (i = 0; i < els.length; i++) {
                            if (els[i]) arr.push(els[i]);
                        }
                    }
                }
                // Node/element
                else if (selector.nodeType || selector === window || selector === document) {
                    arr.push(selector);
                }
                //Array of elements or instance of Dom
                else if (selector.length > 0 && selector[0].nodeType) {
                    for (i = 0; i < selector.length; i++) {
                        arr.push(selector[i]);
                    }
                }
            }
            return new Dom7(arr);
        };

        Dom7.prototype = {
            // Classes and attriutes
            addClass: function (className) {
                if (typeof className === 'undefined') {
                    return this;
                }
                var classes = className.split(' ');
                for (var i = 0; i < classes.length; i++) {
                    for (var j = 0; j < this.length; j++) {
                        if (typeof this[j].classList !== 'undefined') this[j].classList.add(classes[i]);
                    }
                }
                return this;
            },
            removeClass: function (className) {
                var classes = className.split(' ');
                for (var i = 0; i < classes.length; i++) {
                    for (var j = 0; j < this.length; j++) {
                        if (typeof this[j].classList !== 'undefined') this[j].classList.remove(classes[i]);
                    }
                }
                return this;
            },
            hasClass: function (className) {
                if (!this[0]) return false;
                else return this[0].classList.contains(className);
            },
            toggleClass: function (className) {
                var classes = className.split(' ');
                for (var i = 0; i < classes.length; i++) {
                    for (var j = 0; j < this.length; j++) {
                        if (typeof this[j].classList !== 'undefined') this[j].classList.toggle(classes[i]);
                    }
                }
                return this;
            },
            attr: function (attrs, value) {
                if (arguments.length === 1 && typeof attrs === 'string') {
                    // Get attr
                    if (this[0]) return this[0].getAttribute(attrs);
                    else return undefined;
                }
                else {
                    // Set attrs
                    for (var i = 0; i < this.length; i++) {
                        if (arguments.length === 2) {
                            // String
                            this[i].setAttribute(attrs, value);
                        }
                        else {
                            // Object
                            for (var attrName in attrs) {
                                this[i][attrName] = attrs[attrName];
                                this[i].setAttribute(attrName, attrs[attrName]);
                            }
                        }
                    }
                    return this;
                }
            },
            removeAttr: function (attr) {
                for (var i = 0; i < this.length; i++) {
                    this[i].removeAttribute(attr);
                }
                return this;
            },
            prop: function (props, value) {
                if (arguments.length === 1 && typeof props === 'string') {
                    // Get prop
                    if (this[0]) return this[0][props];
                    else return undefined;
                }
                else {
                    // Set props
                    for (var i = 0; i < this.length; i++) {
                        if (arguments.length === 2) {
                            // String
                            this[i][props] = value;
                        }
                        else {
                            // Object
                            for (var propName in props) {
                                this[i][propName] = props[propName];
                            }
                        }
                    }
                    return this;
                }
            },
            data: function (key, value) {
                if (typeof value === 'undefined') {
                    // Get value
                    if (this[0]) {
                        if (this[0].dom7ElementDataStorage && (key in this[0].dom7ElementDataStorage)) {
                            return this[0].dom7ElementDataStorage[key];
                        }
                        else {
                            var dataKey = this[0].getAttribute('data-' + key);    
                            if (dataKey) {
                                return dataKey;
                            }
                            else return undefined;
                        }
                    }
                    else return undefined;
                }
                else {
                    // Set value
                    for (var i = 0; i < this.length; i++) {
                        var el = this[i];
                        if (!el.dom7ElementDataStorage) el.dom7ElementDataStorage = {};
                        el.dom7ElementDataStorage[key] = value;
                    }
                    return this;
                }
            },
            removeData: function(key) {
                for (var i = 0; i < this.length; i++) {
                    var el = this[i];
                    if (el.dom7ElementDataStorage && el.dom7ElementDataStorage[key]) {
                        el.dom7ElementDataStorage[key] = null;
                        delete el.dom7ElementDataStorage[key];
                    }
                }
            },
            dataset: function () {
                var el = this[0];
                if (el) {
                    var dataset = {};
                    if (el.dataset) {
                        for (var dataKey in el.dataset) {
                            dataset[dataKey] = el.dataset[dataKey];
                        }
                    }
                    else {
                        for (var i = 0; i < el.attributes.length; i++) {
                            var attr = el.attributes[i];
                            if (attr.name.indexOf('data-') >= 0) {
                                dataset[$.toCamelCase(attr.name.split('data-')[1])] = attr.value;
                            }
                        }
                    }
                    for (var key in dataset) {
                        if (dataset[key] === 'false') dataset[key] = false;
                        else if (dataset[key] === 'true') dataset[key] = true;
                        else if (parseFloat(dataset[key]) === dataset[key] * 1) dataset[key] = dataset[key] * 1;
                    }
                    return dataset;
                }
                else return undefined;
            },
            val: function (value) {
                if (typeof value === 'undefined') {
                    if (this[0]) return this[0].value;
                    else return undefined;
                }
                else {
                    for (var i = 0; i < this.length; i++) {
                        this[i].value = value;
                    }
                    return this;
                }
            },
            // Transforms
            transform : function (transform) {
                for (var i = 0; i < this.length; i++) {
                    var elStyle = this[i].style;
                    elStyle.webkitTransform = elStyle.MsTransform = elStyle.msTransform = elStyle.MozTransform = elStyle.OTransform = elStyle.transform = transform;
                }
                return this;
            },
            transition: function (duration) {
                if (typeof duration !== 'string') {
                    duration = duration + 'ms';
                }
                for (var i = 0; i < this.length; i++) {
                    var elStyle = this[i].style;
                    elStyle.webkitTransitionDuration = elStyle.MsTransitionDuration = elStyle.msTransitionDuration = elStyle.MozTransitionDuration = elStyle.OTransitionDuration = elStyle.transitionDuration = duration;
                }
                return this;
            },
            //Events
            on: function (eventName, targetSelector, listener, capture) {
                function handleLiveEvent(e) {
                    var target = e.target;
                    if ($(target).is(targetSelector)) listener.call(target, e);
                    else {
                        var parents = $(target).parents();
                        for (var k = 0; k < parents.length; k++) {
                            if ($(parents[k]).is(targetSelector)) listener.call(parents[k], e);
                        }
                    }
                }
                var events = eventName.split(' ');
                var i, j;
                for (i = 0; i < this.length; i++) {
                    if (typeof targetSelector === 'function' || targetSelector === false) {
                        // Usual events
                        if (typeof targetSelector === 'function') {
                            listener = arguments[1];
                            capture = arguments[2] || false;
                        }
                        for (j = 0; j < events.length; j++) {
                            this[i].addEventListener(events[j], listener, capture);
                        }
                    }
                    else {
                        //Live events
                        for (j = 0; j < events.length; j++) {
                            if (!this[i].dom7LiveListeners) this[i].dom7LiveListeners = [];
                            this[i].dom7LiveListeners.push({listener: listener, liveListener: handleLiveEvent});
                            this[i].addEventListener(events[j], handleLiveEvent, capture);
                        }
                    }
                }
        
                return this;
            },
            off: function (eventName, targetSelector, listener, capture) {
                var events = eventName.split(' ');
                for (var i = 0; i < events.length; i++) {
                    for (var j = 0; j < this.length; j++) {
                        if (typeof targetSelector === 'function' || targetSelector === false) {
                            // Usual events
                            if (typeof targetSelector === 'function') {
                                listener = arguments[1];
                                capture = arguments[2] || false;
                            }
                            this[j].removeEventListener(events[i], listener, capture);
                        }
                        else {
                            // Live event
                            if (this[j].dom7LiveListeners) {
                                for (var k = 0; k < this[j].dom7LiveListeners.length; k++) {
                                    if (this[j].dom7LiveListeners[k].listener === listener) {
                                        this[j].removeEventListener(events[i], this[j].dom7LiveListeners[k].liveListener, capture);
                                    }
                                }
                            }
                        }
                    }
                }
                return this;
            },
            once: function (eventName, targetSelector, listener, capture) {
                var dom = this;
                if (typeof targetSelector === 'function') {
                    listener = arguments[1];
                    capture = arguments[2];
                    targetSelector = false;
                }
                function proxy(e) {
                    listener.call(e.target, e);
                    dom.off(eventName, targetSelector, proxy, capture);
                }
                return dom.on(eventName, targetSelector, proxy, capture);
            },
            trigger: function (eventName, eventData) {
                var events = eventName.split(' ');
                for (var i = 0; i < events.length; i++) {
                    for (var j = 0; j < this.length; j++) {
                        var evt;
                        try {
                            evt = new CustomEvent(events[i], {detail: eventData, bubbles: true, cancelable: true});
                        }
                        catch (e) {
                            evt = document.createEvent('Event');
                            evt.initEvent(events[i], true, true);
                            evt.detail = eventData;
                        }
                        this[j].dispatchEvent(evt);
                    }
                }
                return this;
            },
            transitionEnd: function (callback) {
                var events = ['webkitTransitionEnd', 'transitionend', 'oTransitionEnd', 'MSTransitionEnd', 'msTransitionEnd'],
                    i, j, dom = this;
                function fireCallBack(e) {
                    /*jshint validthis:true */
                    if (e.target !== this) return;
                    callback.call(this, e);
                    for (i = 0; i < events.length; i++) {
                        dom.off(events[i], fireCallBack);
                    }
                }
                if (callback) {
                    for (i = 0; i < events.length; i++) {
                        dom.on(events[i], fireCallBack);
                    }
                }
                return this;
            },
            animationEnd: function (callback) {
                var events = ['webkitAnimationEnd', 'OAnimationEnd', 'MSAnimationEnd', 'animationend'],
                    i, j, dom = this;
                function fireCallBack(e) {
                    callback(e);
                    for (i = 0; i < events.length; i++) {
                        dom.off(events[i], fireCallBack);
                    }
                }
                if (callback) {
                    for (i = 0; i < events.length; i++) {
                        dom.on(events[i], fireCallBack);
                    }
                }
                return this;
            },
            // Sizing/Styles
            width: function () {
                if (this[0] === window) {
                    return window.innerWidth;
                }
                else {
                    if (this.length > 0) {
                        return parseFloat(this.css('width'));
                    }
                    else {
                        return null;
                    }
                }
            },
            outerWidth: function (includeMargins) {
                if (this.length > 0) {
                    if (includeMargins) {
                        var styles = this.styles();
                        return this[0].offsetWidth + parseFloat(styles.getPropertyValue('margin-right')) + parseFloat(styles.getPropertyValue('margin-left'));    
                    }
                    else
                        return this[0].offsetWidth;
                }
                else return null;
            },
            height: function () {
                if (this[0] === window) {
                    return window.innerHeight;
                }
                else {
                    if (this.length > 0) {
                        return parseFloat(this.css('height'));
                    }
                    else {
                        return null;
                    }
                }
            },
            outerHeight: function (includeMargins) {
                if (this.length > 0) {
                    if (includeMargins) {
                        var styles = this.styles();
                        return this[0].offsetHeight + parseFloat(styles.getPropertyValue('margin-top')) + parseFloat(styles.getPropertyValue('margin-bottom'));    
                    }
                    else
                        return this[0].offsetHeight;
                }
                else return null;
            },
            offset: function () {
                if (this.length > 0) {
                    var el = this[0];
                    var box = el.getBoundingClientRect();
                    var body = document.body;
                    var clientTop  = el.clientTop  || body.clientTop  || 0;
                    var clientLeft = el.clientLeft || body.clientLeft || 0;
                    var scrollTop  = window.pageYOffset || el.scrollTop;
                    var scrollLeft = window.pageXOffset || el.scrollLeft;
                    return {
                        top: box.top  + scrollTop  - clientTop,
                        left: box.left + scrollLeft - clientLeft
                    };
                }
                else {
                    return null;
                }
            },
            hide: function () {
                for (var i = 0; i < this.length; i++) {
                    this[i].style.display = 'none';
                }
                return this;
            },
            show: function () {
                for (var i = 0; i < this.length; i++) {
                    this[i].style.display = 'block';
                }
                return this;
            },
            styles: function () {
                var i, styles;
                if (this[0]) return window.getComputedStyle(this[0], null);
                else return undefined;
            },
            css: function (props, value) {
                var i;
                if (arguments.length === 1) {
                    if (typeof props === 'string') {
                        if (this[0]) return window.getComputedStyle(this[0], null).getPropertyValue(props);
                    }
                    else {
                        for (i = 0; i < this.length; i++) {
                            for (var prop in props) {
                                this[i].style[prop] = props[prop];
                            }
                        }
                        return this;
                    }
                }
                if (arguments.length === 2 && typeof props === 'string') {
                    for (i = 0; i < this.length; i++) {
                        this[i].style[props] = value;
                    }
                    return this;
                }
                return this;
            },
        
            //Dom manipulation
            each: function (callback) {
                for (var i = 0; i < this.length; i++) {
                    callback.call(this[i], i, this[i]);
                }
                return this;
            },
            filter: function (callback) {
                var matchedItems = [];
                var dom = this;
                for (var i = 0; i < dom.length; i++) {
                    if (callback.call(dom[i], i, dom[i])) matchedItems.push(dom[i]);
                }
                return new Dom7(matchedItems);
            },
            html: function (html) {
                if (typeof html === 'undefined') {
                    return this[0] ? this[0].innerHTML : undefined;
                }
                else {
                    for (var i = 0; i < this.length; i++) {
                        this[i].innerHTML = html;
                    }
                    return this;
                }
            },
            text: function (text) {
                if (typeof text === 'undefined') {
                    if (this[0]) {
                        return this[0].textContent.trim();
                    }
                    else return null;
                }
                else {
                    for (var i = 0; i < this.length; i++) {
                        this[i].textContent = text;
                    }
                    return this;
                }
            },
            is: function (selector) {
                if (!this[0] || typeof selector === 'undefined') return false;
                var compareWith, i;
                if (typeof selector === 'string') {
                    var el = this[0];
                    if (el === document) return selector === document;
                    if (el === window) return selector === window;
        
                    if (el.matches) return el.matches(selector);
                    else if (el.webkitMatchesSelector) return el.webkitMatchesSelector(selector);
                    else if (el.mozMatchesSelector) return el.mozMatchesSelector(selector);
                    else if (el.msMatchesSelector) return el.msMatchesSelector(selector);
                    else {
                        compareWith = $(selector);
                        for (i = 0; i < compareWith.length; i++) {
                            if (compareWith[i] === this[0]) return true;
                        }
                        return false;
                    }
                }
                else if (selector === document) return this[0] === document;
                else if (selector === window) return this[0] === window;
                else {
                    if (selector.nodeType || selector instanceof Dom7) {
                        compareWith = selector.nodeType ? [selector] : selector;
                        for (i = 0; i < compareWith.length; i++) {
                            if (compareWith[i] === this[0]) return true;
                        }
                        return false;
                    }
                    return false;
                }
        
            },
            indexOf: function (el) {
                for (var i = 0; i < this.length; i++) {
                    if (this[i] === el) return i;
                }
            },
            index: function () {
                if (this[0]) {
                    var child = this[0];
                    var i = 0;
                    while ((child = child.previousSibling) !== null) {
                        if (child.nodeType === 1) i++;
                    }
                    return i;
                }
                else return undefined;
            },
            eq: function (index) {
                if (typeof index === 'undefined') return this;
                var length = this.length;
                var returnIndex;
                if (index > length - 1) {
                    return new Dom7([]);
                }
                if (index < 0) {
                    returnIndex = length + index;
                    if (returnIndex < 0) return new Dom7([]);
                    else return new Dom7([this[returnIndex]]);
                }
                return new Dom7([this[index]]);
            },
            append: function (newChild) {
                var i, j;
                for (i = 0; i < this.length; i++) {
                    if (typeof newChild === 'string') {
                        var tempDiv = document.createElement('div');
                        tempDiv.innerHTML = newChild;
                        while (tempDiv.firstChild) {
                            this[i].appendChild(tempDiv.firstChild);
                        }
                    }
                    else if (newChild instanceof Dom7) {
                        for (j = 0; j < newChild.length; j++) {
                            this[i].appendChild(newChild[j]);
                        }
                    }
                    else {
                        this[i].appendChild(newChild);
                    }
                }
                return this;
            },
            appendTo: function (parent) {
                $(parent).append(this);
                return this;
            },
            prepend: function (newChild) {
                var i, j;
                for (i = 0; i < this.length; i++) {
                    if (typeof newChild === 'string') {
                        var tempDiv = document.createElement('div');
                        tempDiv.innerHTML = newChild;
                        for (j = tempDiv.childNodes.length - 1; j >= 0; j--) {
                            this[i].insertBefore(tempDiv.childNodes[j], this[i].childNodes[0]);
                        }
                        // this[i].insertAdjacentHTML('afterbegin', newChild);
                    }
                    else if (newChild instanceof Dom7) {
                        for (j = 0; j < newChild.length; j++) {
                            this[i].insertBefore(newChild[j], this[i].childNodes[0]);
                        }
                    }
                    else {
                        this[i].insertBefore(newChild, this[i].childNodes[0]);
                    }
                }
                return this;
            },
            prependTo: function (parent) {
                $(parent).prepend(this);
                return this;
            },
            insertBefore: function (selector) {
                var before = $(selector);
                for (var i = 0; i < this.length; i++) {
                    if (before.length === 1) {
                        before[0].parentNode.insertBefore(this[i], before[0]);
                    }
                    else if (before.length > 1) {
                        for (var j = 0; j < before.length; j++) {
                            before[j].parentNode.insertBefore(this[i].cloneNode(true), before[j]);
                        }
                    }
                }
            },
            insertAfter: function (selector) {
                var after = $(selector);
                for (var i = 0; i < this.length; i++) {
                    if (after.length === 1) {
                        after[0].parentNode.insertBefore(this[i], after[0].nextSibling);
                    }
                    else if (after.length > 1) {
                        for (var j = 0; j < after.length; j++) {
                            after[j].parentNode.insertBefore(this[i].cloneNode(true), after[j].nextSibling);
                        }
                    }
                }
            },
            next: function (selector) {
                if (this.length > 0) {
                    if (selector) {
                        if (this[0].nextElementSibling && $(this[0].nextElementSibling).is(selector)) return new Dom7([this[0].nextElementSibling]);
                        else return new Dom7([]);
                    }
                    else {
                        if (this[0].nextElementSibling) return new Dom7([this[0].nextElementSibling]);
                        else return new Dom7([]);
                    }
                }
                else return new Dom7([]);
            },
            nextAll: function (selector) {
                var nextEls = [];
                var el = this[0];
                if (!el) return new Dom7([]);
                while (el.nextElementSibling) {
                    var next = el.nextElementSibling;
                    if (selector) {
                        if($(next).is(selector)) nextEls.push(next);
                    }
                    else nextEls.push(next);
                    el = next;
                }
                return new Dom7(nextEls);
            },
            prev: function (selector) {
                if (this.length > 0) {
                    if (selector) {
                        if (this[0].previousElementSibling && $(this[0].previousElementSibling).is(selector)) return new Dom7([this[0].previousElementSibling]);
                        else return new Dom7([]);
                    }
                    else {
                        if (this[0].previousElementSibling) return new Dom7([this[0].previousElementSibling]);
                        else return new Dom7([]);
                    }
                }
                else return new Dom7([]);
            },
            prevAll: function (selector) {
                var prevEls = [];
                var el = this[0];
                if (!el) return new Dom7([]);
                while (el.previousElementSibling) {
                    var prev = el.previousElementSibling;
                    if (selector) {
                        if($(prev).is(selector)) prevEls.push(prev);
                    }
                    else prevEls.push(prev);
                    el = prev;
                }
                return new Dom7(prevEls);
            },
            parent: function (selector) {
                var parents = [];
                for (var i = 0; i < this.length; i++) {
                    if (this[i].parentNode !== null) {
                        if (selector) {
                            if ($(this[i].parentNode).is(selector)) parents.push(this[i].parentNode);
                        }
                        else {
                           parents.push(this[i].parentNode);
                        }
                    }
                }
                return $($.unique(parents));
            },
            parents: function (selector) {
                var parents = [];
                for (var i = 0; i < this.length; i++) {
                    var parent = this[i].parentNode;
                    while (parent) {
                        if (selector) {
                            if ($(parent).is(selector)) parents.push(parent);
                        }
                        else {
                            parents.push(parent);
                        }
                        parent = parent.parentNode;
                    }
                }
                return $($.unique(parents));
            },
            closest: function (selector) {
                var closest = this;
                if (typeof selector === 'undefined') {
                    return new Dom7([]);
                }
                if (!closest.is(selector)) {
                    closest = closest.parents(selector).eq(0);
                }
                return closest;
            },
            find : function (selector) {
                var foundElements = [];
                for (var i = 0; i < this.length; i++) {
                    var found = this[i].querySelectorAll(selector);
                    for (var j = 0; j < found.length; j++) {
                        foundElements.push(found[j]);
                    }
                }
                return new Dom7(foundElements);
            },
            children: function (selector) {
                var children = [];
                for (var i = 0; i < this.length; i++) {
                    var childNodes = this[i].childNodes;
        
                    for (var j = 0; j < childNodes.length; j++) {
                        if (!selector) {
                            if (childNodes[j].nodeType === 1) children.push(childNodes[j]);
                        }
                        else {
                            if (childNodes[j].nodeType === 1 && $(childNodes[j]).is(selector)) children.push(childNodes[j]);
                        }
                    }
                }
                return new Dom7($.unique(children));
            },
            remove: function () {
                for (var i = 0; i < this.length; i++) {
                    if (this[i].parentNode) this[i].parentNode.removeChild(this[i]);
                }
                return this;
            },
            detach: function () {
                return this.remove();
            },
            add: function () {
                var dom = this;
                var i, j;
                for (i = 0; i < arguments.length; i++) {
                    var toAdd = $(arguments[i]);
                    for (j = 0; j < toAdd.length; j++) {
                        dom[dom.length] = toAdd[j];
                        dom.length++;
                    }
                }
                return dom;
            }
        };
        
        // Shortcuts
        (function () {
            var shortcuts = ('click blur focus focusin focusout keyup keydown keypress submit change mousedown mousemove mouseup mouseenter mouseleave mouseout mouseover touchstart touchend touchmove resize scroll').split(' ');
            var notTrigger = ('resize scroll').split(' ');
            function createMethod(name) {
                Dom7.prototype[name] = function (targetSelector, listener, capture) {
                    var i;
                    if (typeof targetSelector === 'undefined') {
                        for (i = 0; i < this.length; i++) {
                            if (notTrigger.indexOf(name) < 0) {
                                if (name in this[i]) this[i][name]();
                                else {
                                    $(this[i]).trigger(name);
                                }
                            }
                        }
                        return this;
                    }
                    else {
                        return this.on(name, targetSelector, listener, capture);
                    }
                };
            }
            for (var i = 0; i < shortcuts.length; i++) {
                createMethod(shortcuts[i]);
            }
        })();
        

        // Global Ajax Setup
        var globalAjaxOptions = {};
        $.ajaxSetup = function (options) {
            if (options.type) options.method = options.type;
            $.each(options, function (optionName, optionValue) {
                globalAjaxOptions[optionName]  = optionValue;
            });
        };
        
        // Ajax
        var _jsonpRequests = 0;
        $.ajax = function (options) {
            var defaults = {
                method: 'GET',
                data: false,
                async: true,
                cache: true,
                user: '',
                password: '',
                headers: {},
                xhrFields: {},
                statusCode: {},
                processData: true,
                dataType: 'text',
                contentType: 'application/x-www-form-urlencoded',
                timeout: 0
            };
            var callbacks = ['beforeSend', 'error', 'complete', 'success', 'statusCode'];
        
        
            //For jQuery guys
            if (options.type) options.method = options.type;
        
            // Merge global and defaults
            $.each(globalAjaxOptions, function (globalOptionName, globalOptionValue) {
                if (callbacks.indexOf(globalOptionName) < 0) defaults[globalOptionName] = globalOptionValue;
            });
        
            // Function to run XHR callbacks and events
            function fireAjaxCallback (eventName, eventData, callbackName) {
                var a = arguments;
                if (eventName) $(document).trigger(eventName, eventData);
                if (callbackName) {
                    // Global callback
                    if (callbackName in globalAjaxOptions) globalAjaxOptions[callbackName](a[3], a[4], a[5], a[6]);
                    // Options callback
                    if (options[callbackName]) options[callbackName](a[3], a[4], a[5], a[6]);
                }
            }
        
            // Merge options and defaults
            $.each(defaults, function (prop, defaultValue) {
                if (!(prop in options)) options[prop] = defaultValue;
            });
        
            // Default URL
            if (!options.url) {
                options.url = window.location.toString();
            }
            // Parameters Prefix
            var paramsPrefix = options.url.indexOf('?') >= 0 ? '&' : '?';
        
            // UC method
            var _method = options.method.toUpperCase();
            // Data to modify GET URL
            if ((_method === 'GET' || _method === 'HEAD' || _method === 'OPTIONS' || _method === 'DELETE') && options.data) {
                var stringData;
                if (typeof options.data === 'string') {
                    // Should be key=value string
                    if (options.data.indexOf('?') >= 0) stringData = options.data.split('?')[1];
                    else stringData = options.data;
                }
                else {
                    // Should be key=value object
                    stringData = $.serializeObject(options.data);
                }
                if (stringData.length) {
                    options.url += paramsPrefix + stringData;
                    if (paramsPrefix === '?') paramsPrefix = '&';
                }
            }
            // JSONP
            if (options.dataType === 'json' && options.url.indexOf('callback=') >= 0) {
        
                var callbackName = 'f7jsonp_' + Date.now() + (_jsonpRequests++);
                var abortTimeout;
                var callbackSplit = options.url.split('callback=');
                var requestUrl = callbackSplit[0] + 'callback=' + callbackName;
                if (callbackSplit[1].indexOf('&') >= 0) {
                    var addVars = callbackSplit[1].split('&').filter(function (el) { return el.indexOf('=') > 0; }).join('&');
                    if (addVars.length > 0) requestUrl += '&' + addVars;
                }
        
                // Create script
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script.onerror = function() {
                    clearTimeout(abortTimeout);
                    fireAjaxCallback(undefined, undefined, 'error', null, 'scripterror');
                };
                script.src = requestUrl;
        
                // Handler
                window[callbackName] = function (data) {
                    clearTimeout(abortTimeout);
                    fireAjaxCallback(undefined, undefined, 'success', data);
                    script.parentNode.removeChild(script);
                    script = null;
                    delete window[callbackName];
                };
                document.querySelector('head').appendChild(script);
        
                if (options.timeout > 0) {
                    abortTimeout = setTimeout(function () {
                        script.parentNode.removeChild(script);
                        script = null;
                        fireAjaxCallback(undefined, undefined, 'error', null, 'timeout');
                    }, options.timeout);
                }
        
                return;
            }
        
            // Cache for GET/HEAD requests
            if (_method === 'GET' || _method === 'HEAD' || _method === 'OPTIONS' || _method === 'DELETE') {
                if (options.cache === false) {
                    options.url += (paramsPrefix + '_nocache=' + Date.now());
                }
            }
        
            // Create XHR
            var xhr = new XMLHttpRequest();
        
            // Save Request URL
            xhr.requestUrl = options.url;
            xhr.requestParameters = options;
        
            // Open XHR
            xhr.open(_method, options.url, options.async, options.user, options.password);
        
            // Create POST Data
            var postData = null;
        
            if ((_method === 'POST' || _method === 'PUT' || _method === 'PATCH') && options.data) {
                if (options.processData) {
                    var postDataInstances = [ArrayBuffer, Blob, Document, FormData];
                    // Post Data
                    if (postDataInstances.indexOf(options.data.constructor) >= 0) {
                        postData = options.data;
                    }
                    else {
                        // POST Headers
                        var boundary = '---------------------------' + Date.now().toString(16);
        
                        if (options.contentType === 'multipart\/form-data') {
                            xhr.setRequestHeader('Content-Type', 'multipart\/form-data; boundary=' + boundary);
                        }
                        else {
                            xhr.setRequestHeader('Content-Type', options.contentType);
                        }
                        postData = '';
                        var _data = $.serializeObject(options.data);
                        if (options.contentType === 'multipart\/form-data') {
                            boundary = '---------------------------' + Date.now().toString(16);
                            _data = _data.split('&');
                            var _newData = [];
                            for (var i = 0; i < _data.length; i++) {
                                _newData.push('Content-Disposition: form-data; name="' + _data[i].split('=')[0] + '"\r\n\r\n' + _data[i].split('=')[1] + '\r\n');
                            }
                            postData = '--' + boundary + '\r\n' + _newData.join('--' + boundary + '\r\n') + '--' + boundary + '--\r\n';
                        }
                        else {
                            postData = options.contentType === 'application/x-www-form-urlencoded' ? _data : _data.replace(/&/g, '\r\n');
                        }
                    }
                }
                else {
                    postData = options.data;
                }
        
            }
        
            // Additional headers
            if (options.headers) {
                $.each(options.headers, function (headerName, headerCallback) {
                    xhr.setRequestHeader(headerName, headerCallback);
                });
            }
        
            // Check for crossDomain
            if (typeof options.crossDomain === 'undefined') {
                options.crossDomain = /^([\w-]+:)?\/\/([^\/]+)/.test(options.url) && RegExp.$2 !== window.location.host;
            }
        
            if (!options.crossDomain) {
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            }
        
            if (options.xhrFields) {
                $.each(options.xhrFields, function (fieldName, fieldValue) {
                    xhr[fieldName] = fieldValue;
                });
            }
        
            var xhrTimeout;
            // Handle XHR
            xhr.onload = function (e) {
                if (xhrTimeout) clearTimeout(xhrTimeout);
                if ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 0) {
                    var responseData;
                    if (options.dataType === 'json') {
                        try {
                            responseData = JSON.parse(xhr.responseText);
                            fireAjaxCallback('ajaxSuccess', {xhr: xhr}, 'success', responseData, xhr.status, xhr);
                        }
                        catch (err) {
                            fireAjaxCallback('ajaxError', {xhr: xhr, parseerror: true}, 'error', xhr, 'parseerror');
                        }
                    }
                    else {
                        responseData = xhr.responseType === 'text' || xhr.responseType === '' ? xhr.responseText : xhr.response;
                        fireAjaxCallback('ajaxSuccess', {xhr: xhr}, 'success', responseData, xhr.status, xhr);
                    }
                }
                else {
                    fireAjaxCallback('ajaxError', {xhr: xhr}, 'error', xhr, xhr.status);
                }
                if (options.statusCode) {
                    if (globalAjaxOptions.statusCode && globalAjaxOptions.statusCode[xhr.status]) globalAjaxOptions.statusCode[xhr.status](xhr);
                    if (options.statusCode[xhr.status]) options.statusCode[xhr.status](xhr);
                }
                fireAjaxCallback('ajaxComplete', {xhr: xhr}, 'complete', xhr, xhr.status);
            };
        
            xhr.onerror = function (e) {
                if (xhrTimeout) clearTimeout(xhrTimeout);
                fireAjaxCallback('ajaxError', {xhr: xhr}, 'error', xhr, xhr.status);
            };
        
            // Ajax start callback
            fireAjaxCallback('ajaxStart', {xhr: xhr}, 'start', xhr);
            fireAjaxCallback(undefined, undefined, 'beforeSend', xhr);
        
        
            // Send XHR
            xhr.send(postData);
        
            // Timeout
            if (options.timeout > 0) {
                xhr.onabort = function () {
                    if (xhrTimeout) clearTimeout(xhrTimeout);
                };
                xhrTimeout = setTimeout(function () {
                    xhr.abort();
                    fireAjaxCallback('ajaxError', {xhr: xhr, timeout: true}, 'error', xhr, 'timeout');
                    fireAjaxCallback('ajaxComplete', {xhr: xhr, timeout: true}, 'complete', xhr, 'timeout');
                }, options.timeout);
            }
        
            // Return XHR object
            return xhr;
        };
        // Shrotcuts
        (function () {
            var methods = ('get post getJSON').split(' ');
            function createMethod(method) {
                $[method] = function (url, data, success) {
                    return $.ajax({
                        url: url,
                        method: method === 'post' ? 'POST' : 'GET',
                        data: typeof data === 'function' ? undefined : data,
                        success: typeof data === 'function' ? data : success,
                        dataType: method === 'getJSON' ? 'json' : undefined
                    });
                };
            }
            for (var i = 0; i < methods.length; i++) {
                createMethod(methods[i]);
            }
        })();
        

        // DOM Library Utilites
        $.parseUrlQuery = function (url) {
            var query = {}, i, params, param;
            if (url.indexOf('?') >= 0) url = url.split('?')[1];
            else return query;
            params = url.split('&');
            for (i = 0; i < params.length; i++) {
                param = params[i].split('=');
                query[param[0]] = param[1];
            }
            return query;
        };
        $.isArray = function (arr) {
            if (Object.prototype.toString.apply(arr) === '[object Array]') return true;
            else return false;
        };
        $.each = function (obj, callback) {
            if (typeof obj !== 'object') return;
            if (!callback) return;
            var i, prop;
            if ($.isArray(obj) || obj instanceof Dom7) {
                // Array
                for (i = 0; i < obj.length; i++) {
                    callback(i, obj[i]);
                }
            }
            else {
                // Object
                for (prop in obj) {
                    if (obj.hasOwnProperty(prop)) {
                        callback(prop, obj[prop]);
                    }
                }
            }
        };
        $.unique = function (arr) {
            var unique = [];
            for (var i = 0; i < arr.length; i++) {
                if (unique.indexOf(arr[i]) === -1) unique.push(arr[i]);
            }
            return unique;
        };
        $.serializeObject = $.param = function (obj, parents) {
            if (typeof obj === 'string') return obj;
            var resultArray = [];
            var separator = '&';
            parents = parents || [];
            var newParents;
            function var_name(name) {
                if (parents.length > 0) {
                    var _parents = '';
                    for (var j = 0; j < parents.length; j++) {
                        if (j === 0) _parents += parents[j];
                        else _parents += '[' + encodeURIComponent(parents[j]) + ']';
                    }
                    return _parents + '[' + encodeURIComponent(name) + ']';
                }
                else {
                    return encodeURIComponent(name);
                }
            }
            function var_value(value) {
                return encodeURIComponent(value);
            }
            for (var prop in obj) {
                if (obj.hasOwnProperty(prop)) {
                    var toPush;
                    if ($.isArray(obj[prop])) {
                        toPush = [];
                        for (var i = 0; i < obj[prop].length; i ++) {
                            if (!$.isArray(obj[prop][i]) && typeof obj[prop][i] === 'object') {
                                newParents = parents.slice();
                                newParents.push(prop);
                                newParents.push(i + '');
                                toPush.push($.serializeObject(obj[prop][i], newParents));
                            }
                            else {
                                toPush.push(var_name(prop) + '[]=' + var_value(obj[prop][i]));
                            }
                            
                        }
                        if (toPush.length > 0) resultArray.push(toPush.join(separator));
                    }
                    else if (typeof obj[prop] === 'object') {
                        // Object, convert to named array
                        newParents = parents.slice();
                        newParents.push(prop);
                        toPush = $.serializeObject(obj[prop], newParents);
                        if (toPush !== '') resultArray.push(toPush);
                    }
                    else if (typeof obj[prop] !== 'undefined' && obj[prop] !== '') {
                        // Should be string or plain value
                        resultArray.push(var_name(prop) + '=' + var_value(obj[prop]));
                    }
                }
            }
            return resultArray.join(separator);
        };
        $.toCamelCase = function (string) {
            return string.toLowerCase().replace(/-(.)/g, function(match, group1) {
                return group1.toUpperCase();
            });
        };
        $.dataset = function (el) {
            return $(el).dataset();
        };
        $.getTranslate = function (el, axis) {
            var matrix, curTransform, curStyle, transformMatrix;
        
            // automatic axis detection
            if (typeof axis === 'undefined') {
                axis = 'x';
            }
        
            curStyle = window.getComputedStyle(el, null);
            if (window.WebKitCSSMatrix) {
                curTransform = curStyle.transform || curStyle.webkitTransform;
                if (curTransform.split(',').length > 6) {
                    curTransform = curTransform.split(', ').map(function(a){
                        return a.replace(',','.');
                    }).join(', ');
                }
                // Some old versions of Webkit choke when 'none' is passed; pass
                // empty string instead in this case
                transformMatrix = new WebKitCSSMatrix(curTransform === 'none' ? '' : curTransform);
            }
            else {
                transformMatrix = curStyle.MozTransform || curStyle.OTransform || curStyle.MsTransform || curStyle.msTransform  || curStyle.transform || curStyle.getPropertyValue('transform').replace('translate(', 'matrix(1, 0, 0, 1,');
                matrix = transformMatrix.toString().split(',');
            }
        
            if (axis === 'x') {
                //Latest Chrome and webkits Fix
                if (window.WebKitCSSMatrix)
                    curTransform = transformMatrix.m41;
                //Crazy IE10 Matrix
                else if (matrix.length === 16)
                    curTransform = parseFloat(matrix[12]);
                //Normal Browsers
                else
                    curTransform = parseFloat(matrix[4]);
            }
            if (axis === 'y') {
                //Latest Chrome and webkits Fix
                if (window.WebKitCSSMatrix)
                    curTransform = transformMatrix.m42;
                //Crazy IE10 Matrix
                else if (matrix.length === 16)
                    curTransform = parseFloat(matrix[13]);
                //Normal Browsers
                else
                    curTransform = parseFloat(matrix[5]);
            }
            
            return curTransform || 0;
        };
        
        $.requestAnimationFrame = function (callback) {
            if (window.requestAnimationFrame) return window.requestAnimationFrame(callback);
            else if (window.webkitRequestAnimationFrame) return window.webkitRequestAnimationFrame(callback);
            else if (window.mozRequestAnimationFrame) return window.mozRequestAnimationFrame(callback);
            else {
                return window.setTimeout(callback, 1000 / 60);
            }
        };
        $.cancelAnimationFrame = function (id) {
            if (window.cancelAnimationFrame) return window.cancelAnimationFrame(id);
            else if (window.webkitCancelAnimationFrame) return window.webkitCancelAnimationFrame(id);
            else if (window.mozCancelAnimationFrame) return window.mozCancelAnimationFrame(id);
            else {
                return window.clearTimeout(id);
            }  
        };
        $.supportTouch = !!(('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch);
        
        // Link to prototype
        $.fn = Dom7.prototype;
        
        // Plugins
        $.fn.scrollTo = function (left, top, duration, easing, callback) {
            if (arguments.length === 4 && typeof easing === 'function') {
                callback = easing;
                easing = undefined;
            }
            return this.each(function () {
                var el = this;
                var currentTop, currentLeft, maxTop, maxLeft, newTop, newLeft, scrollTop, scrollLeft;
                var animateTop = top > 0 || top === 0;
                var animateLeft = left > 0 || left === 0;
                if (typeof easing === 'undefined') {
                    easing = 'swing';
                }
                if (animateTop) {
                    currentTop = el.scrollTop;
                    if (!duration) {
                        el.scrollTop = top;
                    }
                }
                if (animateLeft) {
                    currentLeft = el.scrollLeft;
                    if (!duration) {
                        el.scrollLeft = left;
                    }
                }
                if (!duration) return;
                if (animateTop) {
                    maxTop = el.scrollHeight - el.offsetHeight;
                    newTop = Math.max(Math.min(top, maxTop), 0);
                }
                if (animateLeft) {
                    maxLeft = el.scrollWidth - el.offsetWidth;
                    newLeft = Math.max(Math.min(left, maxLeft), 0);
                }
                var startTime = null;
                if (animateTop && newTop === currentTop) animateTop = false;
                if (animateLeft && newLeft === currentLeft) animateLeft = false;
                function render(time) {
                    if (time === undefined) {
                        time = new Date().getTime();
                    }
                    if (startTime === null) {
                        startTime = time;
                    }
                    var doneLeft, doneTop, done;
                    var progress = Math.max(Math.min((time - startTime) / duration, 1), 0);
                    var easeProgress = easing === 'linear' ? progress : (0.5 - Math.cos( progress * Math.PI ) / 2);
                    if (animateTop) scrollTop = currentTop + (easeProgress * (newTop - currentTop));
                    if (animateLeft) scrollLeft = currentLeft + (easeProgress * (newLeft - currentLeft));
                    if (animateTop && newTop > currentTop && scrollTop >= newTop)  {
                        el.scrollTop = newTop;
                        done = true;
                    }
                    if (animateTop && newTop < currentTop && scrollTop <= newTop)  {
                        el.scrollTop = newTop;
                        done = true;
                    }
        
                    if (animateLeft && newLeft > currentLeft && scrollLeft >= newLeft)  {
                        el.scrollLeft = newLeft;
                        done = true;
                    }
                    if (animateLeft && newLeft < currentLeft && scrollLeft <= newLeft)  {
                        el.scrollLeft = newLeft;
                        done = true;
                    }
        
                    if (done) {
                        if (callback) callback();
                        return;
                    }
                    if (animateTop) el.scrollTop = scrollTop;
                    if (animateLeft) el.scrollLeft = scrollLeft;
                    $.requestAnimationFrame(render);
                }
                $.requestAnimationFrame(render);
            });
        };
        $.fn.scrollTop = function (top, duration, easing, callback) {
            if (arguments.length === 3 && typeof easing === 'function') {
                callback = easing;
                easing = undefined;
            }
            var dom = this;
            if (typeof top === 'undefined') {
                if (dom.length > 0) return dom[0].scrollTop;
                else return null;
            }
            return dom.scrollTo(undefined, top, duration, easing, callback);
        };
        $.fn.scrollLeft = function (left, duration, easing, callback) {
            if (arguments.length === 3 && typeof easing === 'function') {
                callback = easing;
                easing = undefined;
            }
            var dom = this;
            if (typeof left === 'undefined') {
                if (dom.length > 0) return dom[0].scrollLeft;
                else return null;
            }
            return dom.scrollTo(left, undefined, duration, easing, callback);
        };

        return $;
    })();
    
    // Export Dom7 to Framework7
    Framework7.$ = Dom7;
    
    // Export to local scope
    var $ = Dom7;
    
    // Export to Window
    window.Dom7 = Dom7;
    

    /*===========================
    Features Support Detection
    ===========================*/
    Framework7.prototype.support = (function () {
        var support = {
            touch: !!(('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch)
        };
    
        // Export object
        return support;
    })();
    

    /*===========================
    Device/OS Detection
    ===========================*/
    Framework7.prototype.device = (function () {
        var device = {};
        var ua = navigator.userAgent;
        var $ = Dom7;
    
        var android = ua.match(/(Android);?[\s\/]+([\d.]+)?/);
        var ipad = ua.match(/(iPad).*OS\s([\d_]+)/);
        var ipod = ua.match(/(iPod)(.*OS\s([\d_]+))?/);
        var iphone = !ipad && ua.match(/(iPhone\sOS)\s([\d_]+)/);
    
        device.ios = device.android = device.iphone = device.ipad = device.androidChrome = false;
        
        // Android
        if (android) {
            device.os = 'android';
            device.osVersion = android[2];
            device.android = true;
            device.androidChrome = ua.toLowerCase().indexOf('chrome') >= 0;
        }
        if (ipad || iphone || ipod) {
            device.os = 'ios';
            device.ios = true;
        }
        // iOS
        if (iphone && !ipod) {
            device.osVersion = iphone[2].replace(/_/g, '.');
            device.iphone = true;
        }
        if (ipad) {
            device.osVersion = ipad[2].replace(/_/g, '.');
            device.ipad = true;
        }
        if (ipod) {
            device.osVersion = ipod[3] ? ipod[3].replace(/_/g, '.') : null;
            device.iphone = true;
        }
        // iOS 8+ changed UA
        if (device.ios && device.osVersion && ua.indexOf('Version/') >= 0) {
            if (device.osVersion.split('.')[0] === '10') {
                device.osVersion = ua.toLowerCase().split('version/')[1].split(' ')[0];
            }
        }
    
        // Webview
        device.webView = (iphone || ipad || ipod) && ua.match(/.*AppleWebKit(?!.*Safari)/i);
            
        // Minimal UI
        if (device.os && device.os === 'ios') {
            var osVersionArr = device.osVersion.split('.');
            device.minimalUi = !device.webView &&
                                (ipod || iphone) &&
                                (osVersionArr[0] * 1 === 7 ? osVersionArr[1] * 1 >= 1 : osVersionArr[0] * 1 > 7) &&
                                $('meta[name="viewport"]').length > 0 && $('meta[name="viewport"]').attr('content').indexOf('minimal-ui') >= 0;
        }
    
        // Check for status bar and fullscreen app mode
        var windowWidth = $(window).width();
        var windowHeight = $(window).height();
        device.statusBar = false;
        if (device.webView && (windowWidth * windowHeight === screen.width * screen.height)) {
            device.statusBar = true;
        }
        else {
            device.statusBar = false;
        }
    
        // Classes
        var classNames = [];
    
        // Pixel Ratio
        device.pixelRatio = window.devicePixelRatio || 1;
        classNames.push('pixel-ratio-' + Math.floor(device.pixelRatio));
        if (device.pixelRatio >= 2) {
            classNames.push('retina');
        }
    
        // OS classes
        if (device.os) {
            classNames.push(device.os, device.os + '-' + device.osVersion.split('.')[0], device.os + '-' + device.osVersion.replace(/\./g, '-'));
            if (device.os === 'ios') {
                var major = parseInt(device.osVersion.split('.')[0], 10);
                for (var i = major - 1; i >= 6; i--) {
                    classNames.push('ios-gt-' + i);
                }
            }
            
        }
        // Status bar classes
        if (device.statusBar) {
            classNames.push('with-statusbar-overlay');
        }
        else {
            $('html').removeClass('with-statusbar-overlay');
        }
    
        // Add html classes
        if (classNames.length > 0) $('html').addClass(classNames.join(' '));
    
        // Export object
        return device;
    })();
    

    /*===========================
    Plugins prototype
    ===========================*/
    Framework7.prototype.plugins = {};
    

    /*===========================
    Template7 Template engine
    ===========================*/
    window.Template7 = (function () {
        function isArray(arr) {
            return Object.prototype.toString.apply(arr) === '[object Array]';
        }
        function isObject(obj) {
            return obj instanceof Object;
        }
        function isFunction(func) {
            return typeof func === 'function';
        }
        var cache = {};
        function helperToSlices(string) {
            var helperParts = string.replace(/[{}#}]/g, '').split(' ');
            var slices = [];
            var shiftIndex, i, j;
            for (i = 0; i < helperParts.length; i++) {
                var part = helperParts[i];
                if (i === 0) slices.push(part);
                else {
                    if (part.indexOf('"') === 0) {
                        // Plain String
                        if (part.match(/"/g).length === 2) {
                            // One word string
                            slices.push(part);
                        }
                        else {
                            // Find closed Index
                            shiftIndex = 0;
                            for (j = i + 1; j < helperParts.length; j++) {
                                part += ' ' + helperParts[j];
                                if (helperParts[j].indexOf('"') >= 0) {
                                    shiftIndex = j;
                                    slices.push(part);
                                    break;
                                }
                            }
                            if (shiftIndex) i = shiftIndex;
                        }
                    }
                    else {
                        if (part.indexOf('=') > 0) {
                            // Hash
                            var hashParts = part.split('=');
                            var hashName = hashParts[0];
                            var hashContent = hashParts[1];
                            if (hashContent.match(/"/g).length !== 2) {
                                shiftIndex = 0;
                                for (j = i + 1; j < helperParts.length; j++) {
                                    hashContent += ' ' + helperParts[j];
                                    if (helperParts[j].indexOf('"') >= 0) {
                                        shiftIndex = j;
                                        break;
                                    }
                                }
                                if (shiftIndex) i = shiftIndex;
                            }
                            var hash = [hashName, hashContent.replace(/"/g,'')];
                            slices.push(hash);
                        }
                        else {
                            // Plain variable
                            slices.push(part);
                        }
                    }
                }
            }
            return slices;
        }
        function stringToBlocks(string) {
            var blocks = [], i, j, k;
            if (!string) return [];
            var _blocks = string.split(/({{[^{^}]*}})/);
            for (i = 0; i < _blocks.length; i++) {
                var block = _blocks[i];
                if (block === '') continue;
                if (block.indexOf('{{') < 0) {
                    blocks.push({
                        type: 'plain',
                        content: block
                    });
                }
                else {
                    if (block.indexOf('{/') >= 0) {
                        continue;
                    }
                    if (block.indexOf('{#') < 0 && block.indexOf(' ') < 0 && block.indexOf('else') < 0) {
                        // Simple variable
                        blocks.push({
                            type: 'variable',
                            contextName: block.replace(/[{}]/g, '')
                        });
                        continue;
                    }
                    // Helpers
                    var helperSlices = helperToSlices(block);
                    var helperName = helperSlices[0];
                    var isPartial = helperName === '>';
                    var helperContext = [];
                    var helperHash = {};
                    for (j = 1; j < helperSlices.length; j++) {
                        var slice = helperSlices[j];
                        if (isArray(slice)) {
                            // Hash
                            helperHash[slice[0]] = slice[1] === 'false' ? false : slice[1];
                        }
                        else {
                            helperContext.push(slice);
                        }
                    }
                    
                    if (block.indexOf('{#') >= 0) {
                        // Condition/Helper
                        var helperStartIndex = i;
                        var helperContent = '';
                        var elseContent = '';
                        var toSkip = 0;
                        var shiftIndex;
                        var foundClosed = false, foundElse = false, foundClosedElse = false, depth = 0;
                        for (j = i + 1; j < _blocks.length; j++) {
                            if (_blocks[j].indexOf('{{#') >= 0) {
                                depth ++;
                            }
                            if (_blocks[j].indexOf('{{/') >= 0) {
                                depth --;
                            }
                            if (_blocks[j].indexOf('{{#' + helperName) >= 0) {
                                helperContent += _blocks[j];
                                if (foundElse) elseContent += _blocks[j];
                                toSkip ++;
                            }
                            else if (_blocks[j].indexOf('{{/' + helperName) >= 0) {
                                if (toSkip > 0) {
                                    toSkip--;
                                    helperContent += _blocks[j];
                                    if (foundElse) elseContent += _blocks[j];
                                }
                                else {
                                    shiftIndex = j;
                                    foundClosed = true;
                                    break;
                                }
                            }
                            else if (_blocks[j].indexOf('else') >= 0 && depth === 0) {
                                foundElse = true;
                            }
                            else {
                                if (!foundElse) helperContent += _blocks[j];
                                if (foundElse) elseContent += _blocks[j];
                            }
    
                        }
                        if (foundClosed) {
                            if (shiftIndex) i = shiftIndex;
                            blocks.push({
                                type: 'helper',
                                helperName: helperName,
                                contextName: helperContext,
                                content: helperContent,
                                inverseContent: elseContent,
                                hash: helperHash
                            });
                        }
                    }
                    else if (block.indexOf(' ') > 0) {
                        if (isPartial) {
                            helperName = '_partial';
                            if (helperContext[0]) helperContext[0] = '"' + helperContext[0].replace(/"|'/g, '') + '"';
                        }
                        blocks.push({
                            type: 'helper',
                            helperName: helperName,
                            contextName: helperContext,
                            hash: helperHash
                        });
                    }
                }
            }
            return blocks;
        }
        var Template7 = function (template) {
            var t = this;
            t.template = template;
            
            function getCompileFn(block, depth) {
                if (block.content) return compile(block.content, depth);
                else return function () {return ''; };
            }
            function getCompileInverse(block, depth) {
                if (block.inverseContent) return compile(block.inverseContent, depth);
                else return function () {return ''; };
            }
            function getCompileVar(name, ctx) {
                var variable, parts, levelsUp = 0, initialCtx = ctx;
                if (name.indexOf('../') === 0) {
                    levelsUp = name.split('../').length - 1;
                    var newDepth = ctx.split('_')[1] - levelsUp;
                    ctx = 'ctx_' + (newDepth >= 1 ? newDepth : 1);
                    parts = name.split('../')[levelsUp].split('.');
                }
                else if (name.indexOf('@global') === 0) {
                    ctx = 'Template7.global';
                    parts = name.split('@global.')[1].split('.');
                }
                else if (name.indexOf('@root') === 0) {
                    ctx = 'root';
                    parts = name.split('@root.')[1].split('.');
                }
                else {
                    parts = name.split('.');
                }
                variable = ctx;
                for (var i = 0; i < parts.length; i++) {
                    var part = parts[i];
                    if (part.indexOf('@') === 0) {
                        if (i > 0) {
                            variable += '[(data && data.' + part.replace('@', '') + ')]';
                        }
                        else {
                            variable = '(data && data.' + name.replace('@', '') + ')';
                        }
                    }
                    else {
                        if (isFinite(part)) {
                            variable += '[' + part + ']';
                        }
                        else {
                            if (part.indexOf('this') === 0) {
                                variable = part.replace('this', ctx);
                            }
                            else {
                                variable += '.' + part;       
                            }
                        }
                    }
                }
    
                return variable;
            }
            function getCompiledArguments(contextArray, ctx) {
                var arr = [];
                for (var i = 0; i < contextArray.length; i++) {
                    if (contextArray[i].indexOf('"') === 0) arr.push(contextArray[i]);
                    else {
                        arr.push(getCompileVar(contextArray[i], ctx));
                    }
                }
    
                return arr.join(', ');
            }
            function compile(template, depth) {
                depth = depth || 1;
                template = template || t.template;
                if (typeof template !== 'string') {
                    throw new Error('Template7: Template must be a string');
                }
                var blocks = stringToBlocks(template);
                if (blocks.length === 0) {
                    return function () { return ''; };
                }
                var ctx = 'ctx_' + depth;
                var resultString = '';
                if (depth === 1) {
                    resultString += '(function (' + ctx + ', data, root) {\n';
                }
                else {
                    resultString += '(function (' + ctx + ', data) {\n';
                }
                if (depth === 1) {
                    resultString += 'function isArray(arr){return Object.prototype.toString.apply(arr) === \'[object Array]\';}\n';
                    resultString += 'function isFunction(func){return (typeof func === \'function\');}\n';
                    resultString += 'function c(val, ctx) {if (typeof val !== "undefined" && val !== null) {if (isFunction(val)) {return val.call(ctx);} else return val;} else return "";}\n';
                    resultString += 'root = root || ctx_1 || {};\n';
                }
                resultString += 'var r = \'\';\n';
                var i, j, context;
                for (i = 0; i < blocks.length; i++) {
                    var block = blocks[i];
                    // Plain block
                    if (block.type === 'plain') {
                        resultString += 'r +=\'' + (block.content).replace(/\r/g, '\\r').replace(/\n/g, '\\n').replace(/'/g, '\\' + '\'') + '\';';
                        continue;
                    }
                    var variable, compiledArguments;
                    // Variable block
                    if (block.type === 'variable') {
                        variable = getCompileVar(block.contextName, ctx);
                        resultString += 'r += c(' + variable + ', ' + ctx + ');';
                    }
                    // Helpers block
                    if (block.type === 'helper') {
                        if (block.helperName in t.helpers) {
                            compiledArguments = getCompiledArguments(block.contextName, ctx);
                            
                            resultString += 'r += (Template7.helpers.' + block.helperName + ').call(' + ctx + ', ' + (compiledArguments && (compiledArguments + ', ')) +'{hash:' + JSON.stringify(block.hash) + ', data: data || {}, fn: ' + getCompileFn(block, depth + 1) + ', inverse: ' + getCompileInverse(block, depth + 1) + ', root: root});';
                            
                        }
                        else {
                            if (block.contextName.length > 0) {
                                throw new Error('Template7: Missing helper: "' + block.helperName + '"');
                            }
                            else {
                                variable = getCompileVar(block.helperName, ctx);
                                resultString += 'if (' + variable + ') {';
                                resultString += 'if (isArray(' + variable + ')) {';
                                resultString += 'r += (Template7.helpers.each).call(' + ctx + ', ' + variable + ', {hash:' + JSON.stringify(block.hash) + ', data: data || {}, fn: ' + getCompileFn(block, depth+1) + ', inverse: ' + getCompileInverse(block, depth+1) + ', root: root});';
                                resultString += '}else {';
                                resultString += 'r += (Template7.helpers.with).call(' + ctx + ', ' + variable + ', {hash:' + JSON.stringify(block.hash) + ', data: data || {}, fn: ' + getCompileFn(block, depth+1) + ', inverse: ' + getCompileInverse(block, depth+1) + ', root: root});';
                                resultString += '}}';
                            }
                        }
                    }
                }
                resultString += '\nreturn r;})';
                return eval.call(window, resultString);
            }
            t.compile = function (template) {
                if (!t.compiled) {
                    t.compiled = compile(template);
                }
                return t.compiled;
            };
        };
        Template7.prototype = {
            options: {},
            partials: {},
            helpers: {
                '_partial' : function (partialName, options) {
                    var p = Template7.prototype.partials[partialName];
                    if (!p || (p && !p.template)) return '';
                    if (!p.compiled) {
                        p.compiled = t7.compile(p.template);
                    }
                    var ctx = this;
                    for (var hashName in options.hash) {
                        ctx[hashName] = options.hash[hashName];
                    }
                    return p.compiled(ctx, options.data, options.root);
                },
                'escape': function (context, options) {
                    if (typeof context !== 'string') {
                        throw new Error('Template7: Passed context to "escape" helper should be a string');
                    }
                    return context
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;');
                },
                'if': function (context, options) {
                    if (isFunction(context)) { context = context.call(this); }
                    if (context) {
                        return options.fn(this, options.data);
                    }
                    else {
                        return options.inverse(this, options.data);
                    }
                },
                'unless': function (context, options) {
                    if (isFunction(context)) { context = context.call(this); }
                    if (!context) {
                        return options.fn(this, options.data);
                    }
                    else {
                        return options.inverse(this, options.data);
                    }
                },
                'each': function (context, options) {
                    var ret = '', i = 0;
                    if (isFunction(context)) { context = context.call(this); }
                    if (isArray(context)) {
                        if (options.hash.reverse) {
                            context = context.reverse();
                        }
                        for (i = 0; i < context.length; i++) {
                            ret += options.fn(context[i], {first: i === 0, last: i === context.length - 1, index: i});
                        }
                        if (options.hash.reverse) {
                            context = context.reverse();
                        }
                    }
                    else {
                        for (var key in context) {
                            i++;
                            ret += options.fn(context[key], {key: key});
                        }
                    }
                    if (i > 0) return ret;
                    else return options.inverse(this);
                },
                'with': function (context, options) {
                    if (isFunction(context)) { context = context.call(this); }
                    return options.fn(context);
                },
                'join': function (context, options) {
                    if (isFunction(context)) { context = context.call(this); }
                    return context.join(options.hash.delimiter || options.hash.delimeter);
                },
                'js': function (expression, options) {
                    var func;
                    if (expression.indexOf('return')>=0) {
                        func = '(function(){'+expression+'})';
                    }
                    else {
                        func = '(function(){return ('+expression+')})';
                    }
                    return eval.call(this, func).call(this);
                },
                'js_compare': function (expression, options) {
                    var func;
                    if (expression.indexOf('return')>=0) {
                        func = '(function(){'+expression+'})';
                    }
                    else {
                        func = '(function(){return ('+expression+')})';
                    }
                    var condition = eval.call(this, func).call(this);
                    if (condition) {
                        return options.fn(this, options.data);
                    }
                    else {
                        return options.inverse(this, options.data);   
                    }
                }
            }
        };
        var t7 = function (template, data) {
            if (arguments.length === 2) {
                var instance = new Template7(template);
                var rendered = instance.compile()(data);
                instance = null;
                return (rendered);
            }
            else return new Template7(template);
        };
        t7.registerHelper = function (name, fn) {
            Template7.prototype.helpers[name] = fn;
        };
        t7.unregisterHelper = function (name) {
            Template7.prototype.helpers[name] = undefined;  
            delete Template7.prototype.helpers[name];
        };
        t7.registerPartial = function (name, template) {
            Template7.prototype.partials[name] = {template: template};
        };
        t7.unregisterPartial = function (name, template) {
            if (Template7.prototype.partials[name]) {
                Template7.prototype.partials[name] = undefined;
                delete Template7.prototype.partials[name];
            }
        };
        
        t7.compile = function (template, options) {
            var instance = new Template7(template, options);
            return instance.compile();
        };
        
        t7.options = Template7.prototype.options;
        t7.helpers = Template7.prototype.helpers;
        t7.partials = Template7.prototype.partials;
        return t7;
    })();

    /*===========================
    Swiper
    ===========================*/
    window.Swiper = function (container, params) {
        if (!(this instanceof Swiper)) return new Swiper(container, params);
        var defaults = {
            direction: 'horizontal',
            touchEventsTarget: 'container',
            initialSlide: 0,
            speed: 300,
            // autoplay
            autoplay: false,
            autoplayDisableOnInteraction: true,
            autoplayStopOnLast: false,
            // To support iOS's swipe-to-go-back gesture (when being used in-app, with UIWebView).
            iOSEdgeSwipeDetection: false,
            iOSEdgeSwipeThreshold: 20,
            // Free mode
            freeMode: false,
            freeModeMomentum: true,
            freeModeMomentumRatio: 1,
            freeModeMomentumBounce: true,
            freeModeMomentumBounceRatio: 1,
            freeModeSticky: false,
            freeModeMinimumVelocity: 0.02,
            // Autoheight
            autoHeight: false,
            // Set wrapper width
            setWrapperSize: false,
            // Virtual Translate
            virtualTranslate: false,
            // Effects
            effect: 'slide', // 'slide' or 'fade' or 'cube' or 'coverflow' or 'flip'
            coverflow: {
                rotate: 50,
                stretch: 0,
                depth: 100,
                modifier: 1,
                slideShadows : true
            },
            flip: {
                slideShadows : true,
                limitRotation: true
            },
            cube: {
                slideShadows: true,
                shadow: true,
                shadowOffset: 20,
                shadowScale: 0.94
            },
            fade: {
                crossFade: false
            },
            // Parallax
            parallax: false,
            // Scrollbar
            scrollbar: null,
            scrollbarHide: true,
            scrollbarDraggable: false,
            scrollbarSnapOnRelease: false,
            // Keyboard Mousewheel
            keyboardControl: false,
            mousewheelControl: false,
            mousewheelReleaseOnEdges: false,
            mousewheelInvert: false,
            mousewheelForceToAxis: false,
            mousewheelSensitivity: 1,
            // Hash Navigation
            hashnav: false,
            // Breakpoints
            breakpoints: undefined,
            // Slides grid
            spaceBetween: 0,
            slidesPerView: 1,
            slidesPerColumn: 1,
            slidesPerColumnFill: 'column',
            slidesPerGroup: 1,
            centeredSlides: false,
            slidesOffsetBefore: 0, // in px
            slidesOffsetAfter: 0, // in px
            // Round length
            roundLengths: false,
            // Touches
            touchRatio: 1,
            touchAngle: 45,
            simulateTouch: true,
            shortSwipes: true,
            longSwipes: true,
            longSwipesRatio: 0.5,
            longSwipesMs: 300,
            followFinger: true,
            onlyExternal: false,
            threshold: 0,
            touchMoveStopPropagation: true,
            // Unique Navigation Elements
            uniqueNavElements: true,
            // Pagination
            pagination: null,
            paginationElement: 'span',
            paginationClickable: false,
            paginationHide: false,
            paginationBulletRender: null,
            paginationProgressRender: null,
            paginationFractionRender: null,
            paginationCustomRender: null,
            paginationType: 'bullets', // 'bullets' or 'progress' or 'fraction' or 'custom'
            // Resistance
            resistance: true,
            resistanceRatio: 0.85,
            // Next/prev buttons
            nextButton: null,
            prevButton: null,
            // Progress
            watchSlidesProgress: false,
            watchSlidesVisibility: false,
            // Cursor
            grabCursor: false,
            // Clicks
            preventClicks: true,
            preventClicksPropagation: true,
            slideToClickedSlide: false,
            // Lazy Loading
            lazyLoading: false,
            lazyLoadingInPrevNext: false,
            lazyLoadingInPrevNextAmount: 1,
            lazyLoadingOnTransitionStart: false,
            // Images
            preloadImages: true,
            updateOnImagesReady: true,
            // loop
            loop: false,
            loopAdditionalSlides: 0,
            loopedSlides: null,
            // Control
            control: undefined,
            controlInverse: false,
            controlBy: 'slide', //or 'container'
            // Swiping/no swiping
            allowSwipeToPrev: true,
            allowSwipeToNext: true,
            swipeHandler: null, //'.swipe-handler',
            noSwiping: true,
            noSwipingClass: 'swiper-no-swiping',
            // NS
            slideClass: 'swiper-slide',
            slideActiveClass: 'swiper-slide-active',
            slideVisibleClass: 'swiper-slide-visible',
            slideDuplicateClass: 'swiper-slide-duplicate',
            slideNextClass: 'swiper-slide-next',
            slidePrevClass: 'swiper-slide-prev',
            wrapperClass: 'swiper-wrapper',
            bulletClass: 'swiper-pagination-bullet',
            bulletActiveClass: 'swiper-pagination-bullet-active',
            buttonDisabledClass: 'swiper-button-disabled',
            paginationCurrentClass: 'swiper-pagination-current',
            paginationTotalClass: 'swiper-pagination-total',
            paginationHiddenClass: 'swiper-pagination-hidden',
            paginationProgressbarClass: 'swiper-pagination-progressbar',
            // Observer
            observer: false,
            observeParents: false,
            // Accessibility
            a11y: false,
            prevSlideMessage: 'Previous slide',
            nextSlideMessage: 'Next slide',
            firstSlideMessage: 'This is the first slide',
            lastSlideMessage: 'This is the last slide',
            paginationBulletMessage: 'Go to slide {{index}}',
            // Callbacks
            runCallbacksOnInit: true
            /*
            Callbacks:
            onInit: function (swiper)
            onDestroy: function (swiper)
            onClick: function (swiper, e)
            onTap: function (swiper, e)
            onDoubleTap: function (swiper, e)
            onSliderMove: function (swiper, e)
            onSlideChangeStart: function (swiper)
            onSlideChangeEnd: function (swiper)
            onTransitionStart: function (swiper)
            onTransitionEnd: function (swiper)
            onImagesReady: function (swiper)
            onProgress: function (swiper, progress)
            onTouchStart: function (swiper, e)
            onTouchMove: function (swiper, e)
            onTouchMoveOpposite: function (swiper, e)
            onTouchEnd: function (swiper, e)
            onReachBeginning: function (swiper)
            onReachEnd: function (swiper)
            onSetTransition: function (swiper, duration)
            onSetTranslate: function (swiper, translate)
            onAutoplayStart: function (swiper)
            onAutoplayStop: function (swiper),
            onLazyImageLoad: function (swiper, slide, image)
            onLazyImageReady: function (swiper, slide, image)
            */
        
        };
        var initialVirtualTranslate = params && params.virtualTranslate;
        
        params = params || {};
        var originalParams = {};
        for (var param in params) {
            if (typeof params[param] === 'object' && params[param] !== null && !(params[param].nodeType || params[param] === window || params[param] === document || (typeof Dom7 !== 'undefined' && params[param] instanceof Dom7) || (typeof jQuery !== 'undefined' && params[param] instanceof jQuery))) {
                originalParams[param] = {};
                for (var deepParam in params[param]) {
                    originalParams[param][deepParam] = params[param][deepParam];
                }
            }
            else {
                originalParams[param] = params[param];
            }
        }
        for (var def in defaults) {
            if (typeof params[def] === 'undefined') {
                params[def] = defaults[def];
            }
            else if (typeof params[def] === 'object') {
                for (var deepDef in defaults[def]) {
                    if (typeof params[def][deepDef] === 'undefined') {
                        params[def][deepDef] = defaults[def][deepDef];
                    }
                }
            }
        }
        
        // Swiper
        var s = this;
        
        // Params
        s.params = params;
        s.originalParams = originalParams;
        
        // Classname
        s.classNames = [];
        /*=========================
          Dom Library and plugins
          ===========================*/
        if (typeof $ !== 'undefined' && typeof Dom7 !== 'undefined'){
            $ = Dom7;
        }
        if (typeof $ === 'undefined') {
            if (typeof Dom7 === 'undefined') {
                $ = window.Dom7 || window.Zepto || window.jQuery;
            }
            else {
                $ = Dom7;
            }
            if (!$) return;
        }
        // Export it to Swiper instance
        s.$ = $;
        
        /*=========================
          Breakpoints
          ===========================*/
        s.currentBreakpoint = undefined;
        s.getActiveBreakpoint = function () {
            //Get breakpoint for window width
            if (!s.params.breakpoints) return false;
            var breakpoint = false;
            var points = [], point;
            for ( point in s.params.breakpoints ) {
                if (s.params.breakpoints.hasOwnProperty(point)) {
                    points.push(point);
                }
            }
            points.sort(function (a, b) {
                return parseInt(a, 10) > parseInt(b, 10);
            });
            for (var i = 0; i < points.length; i++) {
                point = points[i];
                if (point >= window.innerWidth && !breakpoint) {
                    breakpoint = point;
                }
            }
            return breakpoint || 'max';
        };
        s.setBreakpoint = function () {
            //Set breakpoint for window width and update parameters
            var breakpoint = s.getActiveBreakpoint();
            if (breakpoint && s.currentBreakpoint !== breakpoint) {
                var breakPointsParams = breakpoint in s.params.breakpoints ? s.params.breakpoints[breakpoint] : s.originalParams;
                var needsReLoop = s.params.loop && (breakPointsParams.slidesPerView !== s.params.slidesPerView);
                for ( var param in breakPointsParams ) {
                    s.params[param] = breakPointsParams[param];
                }
                s.currentBreakpoint = breakpoint;
                if(needsReLoop && s.destroyLoop) {
                    s.reLoop(true);
                }
            }
        };
        // Set breakpoint on load
        if (s.params.breakpoints) {
            s.setBreakpoint();
        }
        
        /*=========================
          Preparation - Define Container, Wrapper and Pagination
          ===========================*/
        s.container = $(container);
        if (s.container.length === 0) return;
        if (s.container.length > 1) {
            var swipers = [];
            s.container.each(function () {
                var container = this;
                swipers.push(new Swiper(this, params));
            });
            return swipers;
        }
        
        // Save instance in container HTML Element and in data
        s.container[0].swiper = s;
        s.container.data('swiper', s);
        
        s.classNames.push('swiper-container-' + s.params.direction);
        
        if (s.params.freeMode) {
            s.classNames.push('swiper-container-free-mode');
        }
        if (!s.support.flexbox) {
            s.classNames.push('swiper-container-no-flexbox');
            s.params.slidesPerColumn = 1;
        }
        if (s.params.autoHeight) {
            s.classNames.push('swiper-container-autoheight');
        }
        // Enable slides progress when required
        if (s.params.parallax || s.params.watchSlidesVisibility) {
            s.params.watchSlidesProgress = true;
        }
        // Coverflow / 3D
        if (['cube', 'coverflow', 'flip'].indexOf(s.params.effect) >= 0) {
            if (s.support.transforms3d) {
                s.params.watchSlidesProgress = true;
                s.classNames.push('swiper-container-3d');
            }
            else {
                s.params.effect = 'slide';
            }
        }
        if (s.params.effect !== 'slide') {
            s.classNames.push('swiper-container-' + s.params.effect);
        }
        if (s.params.effect === 'cube') {
            s.params.resistanceRatio = 0;
            s.params.slidesPerView = 1;
            s.params.slidesPerColumn = 1;
            s.params.slidesPerGroup = 1;
            s.params.centeredSlides = false;
            s.params.spaceBetween = 0;
            s.params.virtualTranslate = true;
            s.params.setWrapperSize = false;
        }
        if (s.params.effect === 'fade' || s.params.effect === 'flip') {
            s.params.slidesPerView = 1;
            s.params.slidesPerColumn = 1;
            s.params.slidesPerGroup = 1;
            s.params.watchSlidesProgress = true;
            s.params.spaceBetween = 0;
            s.params.setWrapperSize = false;
            if (typeof initialVirtualTranslate === 'undefined') {
                s.params.virtualTranslate = true;
            }
        }
        
        // Grab Cursor
        if (s.params.grabCursor && s.support.touch) {
            s.params.grabCursor = false;
        }
        
        // Wrapper
        s.wrapper = s.container.children('.' + s.params.wrapperClass);
        
        // Pagination
        if (s.params.pagination) {
            s.paginationContainer = $(s.params.pagination);
            if (s.params.uniqueNavElements && typeof s.params.pagination === 'string' && s.paginationContainer.length > 1 && s.container.find(s.params.pagination).length === 1) {
                s.paginationContainer = s.container.find(s.params.pagination);
            }
        
            if (s.params.paginationType === 'bullets' && s.params.paginationClickable) {
                s.paginationContainer.addClass('swiper-pagination-clickable');
            }
            else {
                s.params.paginationClickable = false;
            }
            s.paginationContainer.addClass('swiper-pagination-' + s.params.paginationType);
        }
        // Next/Prev Buttons
        if (s.params.nextButton || s.params.prevButton) {
            if (s.params.nextButton) {
                s.nextButton = $(s.params.nextButton);
                if (s.params.uniqueNavElements && typeof s.params.nextButton === 'string' && s.nextButton.length > 1 && s.container.find(s.params.nextButton).length === 1) {
                    s.nextButton = s.container.find(s.params.nextButton);
                }
            }
            if (s.params.prevButton) {
                s.prevButton = $(s.params.prevButton);
                if (s.params.uniqueNavElements && typeof s.params.prevButton === 'string' && s.prevButton.length > 1 && s.container.find(s.params.prevButton).length === 1) {
                    s.prevButton = s.container.find(s.params.prevButton);
                }
            }
        }
        
        // Is Horizontal
        s.isHorizontal = function () {
            return s.params.direction === 'horizontal';
        };
        // s.isH = isH;
        
        // RTL
        s.rtl = s.isHorizontal() && (s.container[0].dir.toLowerCase() === 'rtl' || s.container.css('direction') === 'rtl');
        if (s.rtl) {
            s.classNames.push('swiper-container-rtl');
        }
        
        // Wrong RTL support
        if (s.rtl) {
            s.wrongRTL = s.wrapper.css('display') === '-webkit-box';
        }
        
        // Columns
        if (s.params.slidesPerColumn > 1) {
            s.classNames.push('swiper-container-multirow');
        }
        
        // Check for Android
        if (s.device.android) {
            s.classNames.push('swiper-container-android');
        }
        
        // Add classes
        s.container.addClass(s.classNames.join(' '));
        
        // Translate
        s.translate = 0;
        
        // Progress
        s.progress = 0;
        
        // Velocity
        s.velocity = 0;
        
        /*=========================
          Locks, unlocks
          ===========================*/
        s.lockSwipeToNext = function () {
            s.params.allowSwipeToNext = false;
        };
        s.lockSwipeToPrev = function () {
            s.params.allowSwipeToPrev = false;
        };
        s.lockSwipes = function () {
            s.params.allowSwipeToNext = s.params.allowSwipeToPrev = false;
        };
        s.unlockSwipeToNext = function () {
            s.params.allowSwipeToNext = true;
        };
        s.unlockSwipeToPrev = function () {
            s.params.allowSwipeToPrev = true;
        };
        s.unlockSwipes = function () {
            s.params.allowSwipeToNext = s.params.allowSwipeToPrev = true;
        };
        
        /*=========================
          Round helper
          ===========================*/
        function round(a) {
            return Math.floor(a);
        }
        /*=========================
          Set grab cursor
          ===========================*/
        if (s.params.grabCursor) {
            s.container[0].style.cursor = 'move';
            s.container[0].style.cursor = '-webkit-grab';
            s.container[0].style.cursor = '-moz-grab';
            s.container[0].style.cursor = 'grab';
        }
        /*=========================
          Update on Images Ready
          ===========================*/
        s.imagesToLoad = [];
        s.imagesLoaded = 0;
        
        s.loadImage = function (imgElement, src, srcset, checkForComplete, callback) {
            var image;
            function onReady () {
                if (callback) callback();
            }
            if (!imgElement.complete || !checkForComplete) {
                if (src) {
                    image = new window.Image();
                    image.onload = onReady;
                    image.onerror = onReady;
                    if (srcset) {
                        image.srcset = srcset;
                    }
                    if (src) {
                        image.src = src;
                    }
                } else {
                    onReady();
                }
        
            } else {//image already loaded...
                onReady();
            }
        };
        s.preloadImages = function () {
            s.imagesToLoad = s.container.find('img');
            function _onReady() {
                if (typeof s === 'undefined' || s === null) return;
                if (s.imagesLoaded !== undefined) s.imagesLoaded++;
                if (s.imagesLoaded === s.imagesToLoad.length) {
                    if (s.params.updateOnImagesReady) s.update();
                    s.emit('onImagesReady', s);
                }
            }
            for (var i = 0; i < s.imagesToLoad.length; i++) {
                s.loadImage(s.imagesToLoad[i], (s.imagesToLoad[i].currentSrc || s.imagesToLoad[i].getAttribute('src')), (s.imagesToLoad[i].srcset || s.imagesToLoad[i].getAttribute('srcset')), true, _onReady);
            }
        };
        
        /*=========================
          Autoplay
          ===========================*/
        s.autoplayTimeoutId = undefined;
        s.autoplaying = false;
        s.autoplayPaused = false;
        function autoplay() {
            s.autoplayTimeoutId = setTimeout(function () {
                if (s.params.loop) {
                    s.fixLoop();
                    s._slideNext();
                    s.emit('onAutoplay', s);
                }
                else {
                    if (!s.isEnd) {
                        s._slideNext();
                        s.emit('onAutoplay', s);
                    }
                    else {
                        if (!params.autoplayStopOnLast) {
                            s._slideTo(0);
                            s.emit('onAutoplay', s);
                        }
                        else {
                            s.stopAutoplay();
                        }
                    }
                }
            }, s.params.autoplay);
        }
        s.startAutoplay = function () {
            if (typeof s.autoplayTimeoutId !== 'undefined') return false;
            if (!s.params.autoplay) return false;
            if (s.autoplaying) return false;
            s.autoplaying = true;
            s.emit('onAutoplayStart', s);
            autoplay();
        };
        s.stopAutoplay = function (internal) {
            if (!s.autoplayTimeoutId) return;
            if (s.autoplayTimeoutId) clearTimeout(s.autoplayTimeoutId);
            s.autoplaying = false;
            s.autoplayTimeoutId = undefined;
            s.emit('onAutoplayStop', s);
        };
        s.pauseAutoplay = function (speed) {
            if (s.autoplayPaused) return;
            if (s.autoplayTimeoutId) clearTimeout(s.autoplayTimeoutId);
            s.autoplayPaused = true;
            if (speed === 0) {
                s.autoplayPaused = false;
                autoplay();
            }
            else {
                s.wrapper.transitionEnd(function () {
                    if (!s) return;
                    s.autoplayPaused = false;
                    if (!s.autoplaying) {
                        s.stopAutoplay();
                    }
                    else {
                        autoplay();
                    }
                });
            }
        };
        /*=========================
          Min/Max Translate
          ===========================*/
        s.minTranslate = function () {
            return (-s.snapGrid[0]);
        };
        s.maxTranslate = function () {
            return (-s.snapGrid[s.snapGrid.length - 1]);
        };
        /*=========================
          Slider/slides sizes
          ===========================*/
        s.updateAutoHeight = function () {
            // Update Height
            var slide = s.slides.eq(s.activeIndex)[0];
            if (typeof slide !== 'undefined') {
                var newHeight = slide.offsetHeight;
                if (newHeight) s.wrapper.css('height', newHeight + 'px');
            }
        };
        s.updateContainerSize = function () {
            var width, height;
            if (typeof s.params.width !== 'undefined') {
                width = s.params.width;
            }
            else {
                width = s.container[0].clientWidth;
            }
            if (typeof s.params.height !== 'undefined') {
                height = s.params.height;
            }
            else {
                height = s.container[0].clientHeight;
            }
            if (width === 0 && s.isHorizontal() || height === 0 && !s.isHorizontal()) {
                return;
            }
        
            //Subtract paddings
            width = width - parseInt(s.container.css('padding-left'), 10) - parseInt(s.container.css('padding-right'), 10);
            height = height - parseInt(s.container.css('padding-top'), 10) - parseInt(s.container.css('padding-bottom'), 10);
        
            // Store values
            s.width = width;
            s.height = height;
            s.size = s.isHorizontal() ? s.width : s.height;
        };
        
        s.updateSlidesSize = function () {
            s.slides = s.wrapper.children('.' + s.params.slideClass);
            s.snapGrid = [];
            s.slidesGrid = [];
            s.slidesSizesGrid = [];
        
            var spaceBetween = s.params.spaceBetween,
                slidePosition = -s.params.slidesOffsetBefore,
                i,
                prevSlideSize = 0,
                index = 0;
            if (typeof s.size === 'undefined') return;
            if (typeof spaceBetween === 'string' && spaceBetween.indexOf('%') >= 0) {
                spaceBetween = parseFloat(spaceBetween.replace('%', '')) / 100 * s.size;
            }
        
            s.virtualSize = -spaceBetween;
            // reset margins
            if (s.rtl) s.slides.css({marginLeft: '', marginTop: ''});
            else s.slides.css({marginRight: '', marginBottom: ''});
        
            var slidesNumberEvenToRows;
            if (s.params.slidesPerColumn > 1) {
                if (Math.floor(s.slides.length / s.params.slidesPerColumn) === s.slides.length / s.params.slidesPerColumn) {
                    slidesNumberEvenToRows = s.slides.length;
                }
                else {
                    slidesNumberEvenToRows = Math.ceil(s.slides.length / s.params.slidesPerColumn) * s.params.slidesPerColumn;
                }
                if (s.params.slidesPerView !== 'auto' && s.params.slidesPerColumnFill === 'row') {
                    slidesNumberEvenToRows = Math.max(slidesNumberEvenToRows, s.params.slidesPerView * s.params.slidesPerColumn);
                }
            }
        
            // Calc slides
            var slideSize;
            var slidesPerColumn = s.params.slidesPerColumn;
            var slidesPerRow = slidesNumberEvenToRows / slidesPerColumn;
            var numFullColumns = slidesPerRow - (s.params.slidesPerColumn * slidesPerRow - s.slides.length);
            for (i = 0; i < s.slides.length; i++) {
                slideSize = 0;
                var slide = s.slides.eq(i);
                if (s.params.slidesPerColumn > 1) {
                    // Set slides order
                    var newSlideOrderIndex;
                    var column, row;
                    if (s.params.slidesPerColumnFill === 'column') {
                        column = Math.floor(i / slidesPerColumn);
                        row = i - column * slidesPerColumn;
                        if (column > numFullColumns || (column === numFullColumns && row === slidesPerColumn-1)) {
                            if (++row >= slidesPerColumn) {
                                row = 0;
                                column++;
                            }
                        }
                        newSlideOrderIndex = column + row * slidesNumberEvenToRows / slidesPerColumn;
                        slide
                            .css({
                                '-webkit-box-ordinal-group': newSlideOrderIndex,
                                '-moz-box-ordinal-group': newSlideOrderIndex,
                                '-ms-flex-order': newSlideOrderIndex,
                                '-webkit-order': newSlideOrderIndex,
                                'order': newSlideOrderIndex
                            });
                    }
                    else {
                        row = Math.floor(i / slidesPerRow);
                        column = i - row * slidesPerRow;
                    }
                    slide
                        .css({
                            'margin-top': (row !== 0 && s.params.spaceBetween) && (s.params.spaceBetween + 'px')
                        })
                        .attr('data-swiper-column', column)
                        .attr('data-swiper-row', row);
        
                }
                if (slide.css('display') === 'none') continue;
                if (s.params.slidesPerView === 'auto') {
                    slideSize = s.isHorizontal() ? slide.outerWidth(true) : slide.outerHeight(true);
                    if (s.params.roundLengths) slideSize = round(slideSize);
                }
                else {
                    slideSize = (s.size - (s.params.slidesPerView - 1) * spaceBetween) / s.params.slidesPerView;
                    if (s.params.roundLengths) slideSize = round(slideSize);
        
                    if (s.isHorizontal()) {
                        s.slides[i].style.width = slideSize + 'px';
                    }
                    else {
                        s.slides[i].style.height = slideSize + 'px';
                    }
                }
                s.slides[i].swiperSlideSize = slideSize;
                s.slidesSizesGrid.push(slideSize);
        
        
                if (s.params.centeredSlides) {
                    slidePosition = slidePosition + slideSize / 2 + prevSlideSize / 2 + spaceBetween;
                    if (i === 0) slidePosition = slidePosition - s.size / 2 - spaceBetween;
                    if (Math.abs(slidePosition) < 1 / 1000) slidePosition = 0;
                    if ((index) % s.params.slidesPerGroup === 0) s.snapGrid.push(slidePosition);
                    s.slidesGrid.push(slidePosition);
                }
                else {
                    if ((index) % s.params.slidesPerGroup === 0) s.snapGrid.push(slidePosition);
                    s.slidesGrid.push(slidePosition);
                    slidePosition = slidePosition + slideSize + spaceBetween;
                }
        
                s.virtualSize += slideSize + spaceBetween;
        
                prevSlideSize = slideSize;
        
                index ++;
            }
            s.virtualSize = Math.max(s.virtualSize, s.size) + s.params.slidesOffsetAfter;
            var newSlidesGrid;
        
            if (
                s.rtl && s.wrongRTL && (s.params.effect === 'slide' || s.params.effect === 'coverflow')) {
                s.wrapper.css({width: s.virtualSize + s.params.spaceBetween + 'px'});
            }
            if (!s.support.flexbox || s.params.setWrapperSize) {
                if (s.isHorizontal()) s.wrapper.css({width: s.virtualSize + s.params.spaceBetween + 'px'});
                else s.wrapper.css({height: s.virtualSize + s.params.spaceBetween + 'px'});
            }
        
            if (s.params.slidesPerColumn > 1) {
                s.virtualSize = (slideSize + s.params.spaceBetween) * slidesNumberEvenToRows;
                s.virtualSize = Math.ceil(s.virtualSize / s.params.slidesPerColumn) - s.params.spaceBetween;
                s.wrapper.css({width: s.virtualSize + s.params.spaceBetween + 'px'});
                if (s.params.centeredSlides) {
                    newSlidesGrid = [];
                    for (i = 0; i < s.snapGrid.length; i++) {
                        if (s.snapGrid[i] < s.virtualSize + s.snapGrid[0]) newSlidesGrid.push(s.snapGrid[i]);
                    }
                    s.snapGrid = newSlidesGrid;
                }
            }
        
            // Remove last grid elements depending on width
            if (!s.params.centeredSlides) {
                newSlidesGrid = [];
                for (i = 0; i < s.snapGrid.length; i++) {
                    if (s.snapGrid[i] <= s.virtualSize - s.size) {
                        newSlidesGrid.push(s.snapGrid[i]);
                    }
                }
                s.snapGrid = newSlidesGrid;
                if (Math.floor(s.virtualSize - s.size) - Math.floor(s.snapGrid[s.snapGrid.length - 1]) > 1) {
                    s.snapGrid.push(s.virtualSize - s.size);
                }
            }
            if (s.snapGrid.length === 0) s.snapGrid = [0];
        
            if (s.params.spaceBetween !== 0) {
                if (s.isHorizontal()) {
                    if (s.rtl) s.slides.css({marginLeft: spaceBetween + 'px'});
                    else s.slides.css({marginRight: spaceBetween + 'px'});
                }
                else s.slides.css({marginBottom: spaceBetween + 'px'});
            }
            if (s.params.watchSlidesProgress) {
                s.updateSlidesOffset();
            }
        };
        s.updateSlidesOffset = function () {
            for (var i = 0; i < s.slides.length; i++) {
                s.slides[i].swiperSlideOffset = s.isHorizontal() ? s.slides[i].offsetLeft : s.slides[i].offsetTop;
            }
        };
        
        /*=========================
          Slider/slides progress
          ===========================*/
        s.updateSlidesProgress = function (translate) {
            if (typeof translate === 'undefined') {
                translate = s.translate || 0;
            }
            if (s.slides.length === 0) return;
            if (typeof s.slides[0].swiperSlideOffset === 'undefined') s.updateSlidesOffset();
        
            var offsetCenter = -translate;
            if (s.rtl) offsetCenter = translate;
        
            // Visible Slides
            s.slides.removeClass(s.params.slideVisibleClass);
            for (var i = 0; i < s.slides.length; i++) {
                var slide = s.slides[i];
                var slideProgress = (offsetCenter - slide.swiperSlideOffset) / (slide.swiperSlideSize + s.params.spaceBetween);
                if (s.params.watchSlidesVisibility) {
                    var slideBefore = -(offsetCenter - slide.swiperSlideOffset);
                    var slideAfter = slideBefore + s.slidesSizesGrid[i];
                    var isVisible =
                        (slideBefore >= 0 && slideBefore < s.size) ||
                        (slideAfter > 0 && slideAfter <= s.size) ||
                        (slideBefore <= 0 && slideAfter >= s.size);
                    if (isVisible) {
                        s.slides.eq(i).addClass(s.params.slideVisibleClass);
                    }
                }
                slide.progress = s.rtl ? -slideProgress : slideProgress;
            }
        };
        s.updateProgress = function (translate) {
            if (typeof translate === 'undefined') {
                translate = s.translate || 0;
            }
            var translatesDiff = s.maxTranslate() - s.minTranslate();
            var wasBeginning = s.isBeginning;
            var wasEnd = s.isEnd;
            if (translatesDiff === 0) {
                s.progress = 0;
                s.isBeginning = s.isEnd = true;
            }
            else {
                s.progress = (translate - s.minTranslate()) / (translatesDiff);
                s.isBeginning = s.progress <= 0;
                s.isEnd = s.progress >= 1;
            }
            if (s.isBeginning && !wasBeginning) s.emit('onReachBeginning', s);
            if (s.isEnd && !wasEnd) s.emit('onReachEnd', s);
        
            if (s.params.watchSlidesProgress) s.updateSlidesProgress(translate);
            s.emit('onProgress', s, s.progress);
        };
        s.updateActiveIndex = function () {
            var translate = s.rtl ? s.translate : -s.translate;
            var newActiveIndex, i, snapIndex;
            for (i = 0; i < s.slidesGrid.length; i ++) {
                if (typeof s.slidesGrid[i + 1] !== 'undefined') {
                    if (translate >= s.slidesGrid[i] && translate < s.slidesGrid[i + 1] - (s.slidesGrid[i + 1] - s.slidesGrid[i]) / 2) {
                        newActiveIndex = i;
                    }
                    else if (translate >= s.slidesGrid[i] && translate < s.slidesGrid[i + 1]) {
                        newActiveIndex = i + 1;
                    }
                }
                else {
                    if (translate >= s.slidesGrid[i]) {
                        newActiveIndex = i;
                    }
                }
            }
            // Normalize slideIndex
            if (newActiveIndex < 0 || typeof newActiveIndex === 'undefined') newActiveIndex = 0;
            // for (i = 0; i < s.slidesGrid.length; i++) {
                // if (- translate >= s.slidesGrid[i]) {
                    // newActiveIndex = i;
                // }
            // }
            snapIndex = Math.floor(newActiveIndex / s.params.slidesPerGroup);
            if (snapIndex >= s.snapGrid.length) snapIndex = s.snapGrid.length - 1;
        
            if (newActiveIndex === s.activeIndex) {
                return;
            }
            s.snapIndex = snapIndex;
            s.previousIndex = s.activeIndex;
            s.activeIndex = newActiveIndex;
            s.updateClasses();
        };
        
        /*=========================
          Classes
          ===========================*/
        s.updateClasses = function () {
            s.slides.removeClass(s.params.slideActiveClass + ' ' + s.params.slideNextClass + ' ' + s.params.slidePrevClass);
            var activeSlide = s.slides.eq(s.activeIndex);
            // Active classes
            activeSlide.addClass(s.params.slideActiveClass);
            // Next Slide
            var nextSlide = activeSlide.next('.' + s.params.slideClass).addClass(s.params.slideNextClass);
            if (s.params.loop && nextSlide.length === 0) {
                s.slides.eq(0).addClass(s.params.slideNextClass);
            }
            // Prev Slide
            var prevSlide = activeSlide.prev('.' + s.params.slideClass).addClass(s.params.slidePrevClass);
            if (s.params.loop && prevSlide.length === 0) {
                s.slides.eq(-1).addClass(s.params.slidePrevClass);
            }
        
            // Pagination
            if (s.paginationContainer && s.paginationContainer.length > 0) {
                // Current/Total
                var current,
                    total = s.params.loop ? Math.ceil((s.slides.length - s.loopedSlides * 2) / s.params.slidesPerGroup) : s.snapGrid.length;
                if (s.params.loop) {
                    current = Math.ceil((s.activeIndex - s.loopedSlides)/s.params.slidesPerGroup);
                    if (current > s.slides.length - 1 - s.loopedSlides * 2) {
                        current = current - (s.slides.length - s.loopedSlides * 2);
                    }
                    if (current > total - 1) current = current - total;
                    if (current < 0 && s.params.paginationType !== 'bullets') current = total + current;
                }
                else {
                    if (typeof s.snapIndex !== 'undefined') {
                        current = s.snapIndex;
                    }
                    else {
                        current = s.activeIndex || 0;
                    }
                }
                // Types
                if (s.params.paginationType === 'bullets' && s.bullets && s.bullets.length > 0) {
                    s.bullets.removeClass(s.params.bulletActiveClass);
                    if (s.paginationContainer.length > 1) {
                        s.bullets.each(function () {
                            if ($(this).index() === current) $(this).addClass(s.params.bulletActiveClass);
                        });
                    }
                    else {
                        s.bullets.eq(current).addClass(s.params.bulletActiveClass);
                    }
                }
                if (s.params.paginationType === 'fraction') {
                    s.paginationContainer.find('.' + s.params.paginationCurrentClass).text(current + 1);
                    s.paginationContainer.find('.' + s.params.paginationTotalClass).text(total);
                }
                if (s.params.paginationType === 'progress') {
                    var scale = (current + 1) / total,
                        scaleX = scale,
                        scaleY = 1;
                    if (!s.isHorizontal()) {
                        scaleY = scale;
                        scaleX = 1;
                    }
                    s.paginationContainer.find('.' + s.params.paginationProgressbarClass).transform('translate3d(0,0,0) scaleX(' + scaleX + ') scaleY(' + scaleY + ')').transition(s.params.speed);
                }
                if (s.params.paginationType === 'custom' && s.params.paginationCustomRender) {
                    s.paginationContainer.html(s.params.paginationCustomRender(s, current + 1, total));
                    s.emit('onPaginationRendered', s, s.paginationContainer[0]);
                }
            }
        
            // Next/active buttons
            if (!s.params.loop) {
                if (s.params.prevButton && s.prevButton && s.prevButton.length > 0) {
                    if (s.isBeginning) {
                        s.prevButton.addClass(s.params.buttonDisabledClass);
                        if (s.params.a11y && s.a11y) s.a11y.disable(s.prevButton);
                    }
                    else {
                        s.prevButton.removeClass(s.params.buttonDisabledClass);
                        if (s.params.a11y && s.a11y) s.a11y.enable(s.prevButton);
                    }
                }
                if (s.params.nextButton && s.nextButton && s.nextButton.length > 0) {
                    if (s.isEnd) {
                        s.nextButton.addClass(s.params.buttonDisabledClass);
                        if (s.params.a11y && s.a11y) s.a11y.disable(s.nextButton);
                    }
                    else {
                        s.nextButton.removeClass(s.params.buttonDisabledClass);
                        if (s.params.a11y && s.a11y) s.a11y.enable(s.nextButton);
                    }
                }
            }
        };
        
        /*=========================
          Pagination
          ===========================*/
        s.updatePagination = function () {
            if (!s.params.pagination) return;
            if (s.paginationContainer && s.paginationContainer.length > 0) {
                var paginationHTML = '';
                if (s.params.paginationType === 'bullets') {
                    var numberOfBullets = s.params.loop ? Math.ceil((s.slides.length - s.loopedSlides * 2) / s.params.slidesPerGroup) : s.snapGrid.length;
                    for (var i = 0; i < numberOfBullets; i++) {
                        if (s.params.paginationBulletRender) {
                            paginationHTML += s.params.paginationBulletRender(i, s.params.bulletClass);
                        }
                        else {
                            paginationHTML += '<' + s.params.paginationElement+' class="' + s.params.bulletClass + '"></' + s.params.paginationElement + '>';
                        }
                    }
                    s.paginationContainer.html(paginationHTML);
                    s.bullets = s.paginationContainer.find('.' + s.params.bulletClass);
                    if (s.params.paginationClickable && s.params.a11y && s.a11y) {
                        s.a11y.initPagination();
                    }
                }
                if (s.params.paginationType === 'fraction') {
                    if (s.params.paginationFractionRender) {
                        paginationHTML = s.params.paginationFractionRender(s, s.params.paginationCurrentClass, s.params.paginationTotalClass);
                    }
                    else {
                        paginationHTML =
                            '<span class="' + s.params.paginationCurrentClass + '"></span>' +
                            ' / ' +
                            '<span class="' + s.params.paginationTotalClass+'"></span>';
                    }
                    s.paginationContainer.html(paginationHTML);
                }
                if (s.params.paginationType === 'progress') {
                    if (s.params.paginationProgressRender) {
                        paginationHTML = s.params.paginationProgressRender(s, s.params.paginationProgressbarClass);
                    }
                    else {
                        paginationHTML = '<span class="' + s.params.paginationProgressbarClass + '"></span>';
                    }
                    s.paginationContainer.html(paginationHTML);
                }
                if (s.params.paginationType !== 'custom') {
                    s.emit('onPaginationRendered', s, s.paginationContainer[0]);
                }
            }
        };
        /*=========================
          Common update method
          ===========================*/
        s.update = function (updateTranslate) {
            s.updateContainerSize();
            s.updateSlidesSize();
            s.updateProgress();
            s.updatePagination();
            s.updateClasses();
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.set();
            }
            function forceSetTranslate() {
                newTranslate = Math.min(Math.max(s.translate, s.maxTranslate()), s.minTranslate());
                s.setWrapperTranslate(newTranslate);
                s.updateActiveIndex();
                s.updateClasses();
            }
            if (updateTranslate) {
                var translated, newTranslate;
                if (s.controller && s.controller.spline) {
                    s.controller.spline = undefined;
                }
                if (s.params.freeMode) {
                    forceSetTranslate();
                    if (s.params.autoHeight) {
                        s.updateAutoHeight();
                    }
                }
                else {
                    if ((s.params.slidesPerView === 'auto' || s.params.slidesPerView > 1) && s.isEnd && !s.params.centeredSlides) {
                        translated = s.slideTo(s.slides.length - 1, 0, false, true);
                    }
                    else {
                        translated = s.slideTo(s.activeIndex, 0, false, true);
                    }
                    if (!translated) {
                        forceSetTranslate();
                    }
                }
            }
            else if (s.params.autoHeight) {
                s.updateAutoHeight();
            }
        };
        
        /*=========================
          Resize Handler
          ===========================*/
        s.onResize = function (forceUpdatePagination) {
            //Breakpoints
            if (s.params.breakpoints) {
                s.setBreakpoint();
            }
        
            // Disable locks on resize
            var allowSwipeToPrev = s.params.allowSwipeToPrev;
            var allowSwipeToNext = s.params.allowSwipeToNext;
            s.params.allowSwipeToPrev = s.params.allowSwipeToNext = true;
        
            s.updateContainerSize();
            s.updateSlidesSize();
            if (s.params.slidesPerView === 'auto' || s.params.freeMode || forceUpdatePagination) s.updatePagination();
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.set();
            }
            if (s.controller && s.controller.spline) {
                s.controller.spline = undefined;
            }
            var slideChangedBySlideTo = false;
            if (s.params.freeMode) {
                var newTranslate = Math.min(Math.max(s.translate, s.maxTranslate()), s.minTranslate());
                s.setWrapperTranslate(newTranslate);
                s.updateActiveIndex();
                s.updateClasses();
        
                if (s.params.autoHeight) {
                    s.updateAutoHeight();
                }
            }
            else {
                s.updateClasses();
                if ((s.params.slidesPerView === 'auto' || s.params.slidesPerView > 1) && s.isEnd && !s.params.centeredSlides) {
                    slideChangedBySlideTo = s.slideTo(s.slides.length - 1, 0, false, true);
                }
                else {
                    slideChangedBySlideTo = s.slideTo(s.activeIndex, 0, false, true);
                }
            }
            if (s.params.lazyLoading && !slideChangedBySlideTo && s.lazy) {
                s.lazy.load();
            }
            // Return locks after resize
            s.params.allowSwipeToPrev = allowSwipeToPrev;
            s.params.allowSwipeToNext = allowSwipeToNext;
        };
        
        /*=========================
          Events
          ===========================*/
        
        //Define Touch Events
        var desktopEvents = ['mousedown', 'mousemove', 'mouseup'];
        if (window.navigator.pointerEnabled) desktopEvents = ['pointerdown', 'pointermove', 'pointerup'];
        else if (window.navigator.msPointerEnabled) desktopEvents = ['MSPointerDown', 'MSPointerMove', 'MSPointerUp'];
        s.touchEvents = {
            start : s.support.touch || !s.params.simulateTouch  ? 'touchstart' : desktopEvents[0],
            move : s.support.touch || !s.params.simulateTouch ? 'touchmove' : desktopEvents[1],
            end : s.support.touch || !s.params.simulateTouch ? 'touchend' : desktopEvents[2]
        };
        
        
        // WP8 Touch Events Fix
        if (window.navigator.pointerEnabled || window.navigator.msPointerEnabled) {
            (s.params.touchEventsTarget === 'container' ? s.container : s.wrapper).addClass('swiper-wp8-' + s.params.direction);
        }
        
        // Attach/detach events
        s.initEvents = function (detach) {
            var actionDom = detach ? 'off' : 'on';
            var action = detach ? 'removeEventListener' : 'addEventListener';
            var touchEventsTarget = s.params.touchEventsTarget === 'container' ? s.container[0] : s.wrapper[0];
            var target = s.support.touch ? touchEventsTarget : document;
        
            var moveCapture = s.params.nested ? true : false;
        
            //Touch Events
            if (s.browser.ie) {
                touchEventsTarget[action](s.touchEvents.start, s.onTouchStart, false);
                target[action](s.touchEvents.move, s.onTouchMove, moveCapture);
                target[action](s.touchEvents.end, s.onTouchEnd, false);
            }
            else {
                if (s.support.touch) {
                    touchEventsTarget[action](s.touchEvents.start, s.onTouchStart, false);
                    touchEventsTarget[action](s.touchEvents.move, s.onTouchMove, moveCapture);
                    touchEventsTarget[action](s.touchEvents.end, s.onTouchEnd, false);
                }
                if (params.simulateTouch && !s.device.ios && !s.device.android) {
                    touchEventsTarget[action]('mousedown', s.onTouchStart, false);
                    document[action]('mousemove', s.onTouchMove, moveCapture);
                    document[action]('mouseup', s.onTouchEnd, false);
                }
            }
            window[action]('resize', s.onResize);
        
            // Next, Prev, Index
            if (s.params.nextButton && s.nextButton && s.nextButton.length > 0) {
                s.nextButton[actionDom]('click', s.onClickNext);
                if (s.params.a11y && s.a11y) s.nextButton[actionDom]('keydown', s.a11y.onEnterKey);
            }
            if (s.params.prevButton && s.prevButton && s.prevButton.length > 0) {
                s.prevButton[actionDom]('click', s.onClickPrev);
                if (s.params.a11y && s.a11y) s.prevButton[actionDom]('keydown', s.a11y.onEnterKey);
            }
            if (s.params.pagination && s.params.paginationClickable) {
                s.paginationContainer[actionDom]('click', '.' + s.params.bulletClass, s.onClickIndex);
                if (s.params.a11y && s.a11y) s.paginationContainer[actionDom]('keydown', '.' + s.params.bulletClass, s.a11y.onEnterKey);
            }
        
            // Prevent Links Clicks
            if (s.params.preventClicks || s.params.preventClicksPropagation) touchEventsTarget[action]('click', s.preventClicks, true);
        };
        s.attachEvents = function () {
            s.initEvents();
        };
        s.detachEvents = function () {
            s.initEvents(true);
        };
        
        /*=========================
          Handle Clicks
          ===========================*/
        // Prevent Clicks
        s.allowClick = true;
        s.preventClicks = function (e) {
            if (!s.allowClick) {
                if (s.params.preventClicks) e.preventDefault();
                if (s.params.preventClicksPropagation && s.animating) {
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                }
            }
        };
        // Clicks
        s.onClickNext = function (e) {
            e.preventDefault();
            if (s.isEnd && !s.params.loop) return;
            s.slideNext();
        };
        s.onClickPrev = function (e) {
            e.preventDefault();
            if (s.isBeginning && !s.params.loop) return;
            s.slidePrev();
        };
        s.onClickIndex = function (e) {
            e.preventDefault();
            var index = $(this).index() * s.params.slidesPerGroup;
            if (s.params.loop) index = index + s.loopedSlides;
            s.slideTo(index);
        };
        
        /*=========================
          Handle Touches
          ===========================*/
        function findElementInEvent(e, selector) {
            var el = $(e.target);
            if (!el.is(selector)) {
                if (typeof selector === 'string') {
                    el = el.parents(selector);
                }
                else if (selector.nodeType) {
                    var found;
                    el.parents().each(function (index, _el) {
                        if (_el === selector) found = selector;
                    });
                    if (!found) return undefined;
                    else return selector;
                }
            }
            if (el.length === 0) {
                return undefined;
            }
            return el[0];
        }
        s.updateClickedSlide = function (e) {
            var slide = findElementInEvent(e, '.' + s.params.slideClass);
            var slideFound = false;
            if (slide) {
                for (var i = 0; i < s.slides.length; i++) {
                    if (s.slides[i] === slide) slideFound = true;
                }
            }
        
            if (slide && slideFound) {
                s.clickedSlide = slide;
                s.clickedIndex = $(slide).index();
            }
            else {
                s.clickedSlide = undefined;
                s.clickedIndex = undefined;
                return;
            }
            if (s.params.slideToClickedSlide && s.clickedIndex !== undefined && s.clickedIndex !== s.activeIndex) {
                var slideToIndex = s.clickedIndex,
                    realIndex,
                    duplicatedSlides;
                if (s.params.loop) {
                    if (s.animating) return;
                    realIndex = $(s.clickedSlide).attr('data-swiper-slide-index');
                    if (s.params.centeredSlides) {
                        if ((slideToIndex < s.loopedSlides - s.params.slidesPerView/2) || (slideToIndex > s.slides.length - s.loopedSlides + s.params.slidesPerView/2)) {
                            s.fixLoop();
                            slideToIndex = s.wrapper.children('.' + s.params.slideClass + '[data-swiper-slide-index="' + realIndex + '"]:not(.swiper-slide-duplicate)').eq(0).index();
                            setTimeout(function () {
                                s.slideTo(slideToIndex);
                            }, 0);
                        }
                        else {
                            s.slideTo(slideToIndex);
                        }
                    }
                    else {
                        if (slideToIndex > s.slides.length - s.params.slidesPerView) {
                            s.fixLoop();
                            slideToIndex = s.wrapper.children('.' + s.params.slideClass + '[data-swiper-slide-index="' + realIndex + '"]:not(.swiper-slide-duplicate)').eq(0).index();
                            setTimeout(function () {
                                s.slideTo(slideToIndex);
                            }, 0);
                        }
                        else {
                            s.slideTo(slideToIndex);
                        }
                    }
                }
                else {
                    s.slideTo(slideToIndex);
                }
            }
        };
        
        var isTouched,
            isMoved,
            allowTouchCallbacks,
            touchStartTime,
            isScrolling,
            currentTranslate,
            startTranslate,
            allowThresholdMove,
            // Form elements to match
            formElements = 'input, select, textarea, button',
            // Last click time
            lastClickTime = Date.now(), clickTimeout,
            //Velocities
            velocities = [],
            allowMomentumBounce;
        
        // Animating Flag
        s.animating = false;
        
        // Touches information
        s.touches = {
            startX: 0,
            startY: 0,
            currentX: 0,
            currentY: 0,
            diff: 0
        };
        
        // Touch handlers
        var isTouchEvent, startMoving;
        s.onTouchStart = function (e) {
            if (e.originalEvent) e = e.originalEvent;
            isTouchEvent = e.type === 'touchstart';
            if (!isTouchEvent && 'which' in e && e.which === 3) return;
            if (s.params.noSwiping && findElementInEvent(e, '.' + s.params.noSwipingClass)) {
                s.allowClick = true;
                return;
            }
            if (s.params.swipeHandler) {
                if (!findElementInEvent(e, s.params.swipeHandler)) return;
            }
        
            var startX = s.touches.currentX = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
            var startY = s.touches.currentY = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
        
            // Do NOT start if iOS edge swipe is detected. Otherwise iOS app (UIWebView) cannot swipe-to-go-back anymore
            if(s.device.ios && s.params.iOSEdgeSwipeDetection && startX <= s.params.iOSEdgeSwipeThreshold) {
                return;
            }
        
            isTouched = true;
            isMoved = false;
            allowTouchCallbacks = true;
            isScrolling = undefined;
            startMoving = undefined;
            s.touches.startX = startX;
            s.touches.startY = startY;
            touchStartTime = Date.now();
            s.allowClick = true;
            s.updateContainerSize();
            s.swipeDirection = undefined;
            if (s.params.threshold > 0) allowThresholdMove = false;
            if (e.type !== 'touchstart') {
                var preventDefault = true;
                if ($(e.target).is(formElements)) preventDefault = false;
                if (document.activeElement && $(document.activeElement).is(formElements)) {
                    document.activeElement.blur();
                }
                if (preventDefault) {
                    e.preventDefault();
                }
            }
            s.emit('onTouchStart', s, e);
        };
        
        s.onTouchMove = function (e) {
            if (e.originalEvent) e = e.originalEvent;
            if (isTouchEvent && e.type === 'mousemove') return;
            if (e.preventedByNestedSwiper) {
                s.touches.startX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                s.touches.startY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                return;
            }
            if (s.params.onlyExternal) {
                // isMoved = true;
                s.allowClick = false;
                if (isTouched) {
                    s.touches.startX = s.touches.currentX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                    s.touches.startY = s.touches.currentY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                    touchStartTime = Date.now();
                }
                return;
            }
            if (isTouchEvent && document.activeElement) {
                if (e.target === document.activeElement && $(e.target).is(formElements)) {
                    isMoved = true;
                    s.allowClick = false;
                    return;
                }
            }
            if (allowTouchCallbacks) {
                s.emit('onTouchMove', s, e);
            }
            if (e.targetTouches && e.targetTouches.length > 1) return;
        
            s.touches.currentX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
            s.touches.currentY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
        
            if (typeof isScrolling === 'undefined') {
                var touchAngle = Math.atan2(Math.abs(s.touches.currentY - s.touches.startY), Math.abs(s.touches.currentX - s.touches.startX)) * 180 / Math.PI;
                isScrolling = s.isHorizontal() ? touchAngle > s.params.touchAngle : (90 - touchAngle > s.params.touchAngle);
            }
            if (isScrolling) {
                s.emit('onTouchMoveOpposite', s, e);
            }
            if (typeof startMoving === 'undefined' && s.browser.ieTouch) {
                if (s.touches.currentX !== s.touches.startX || s.touches.currentY !== s.touches.startY) {
                    startMoving = true;
                }
            }
            if (!isTouched) return;
            if (isScrolling)  {
                isTouched = false;
                return;
            }
            if (!startMoving && s.browser.ieTouch) {
                return;
            }
            s.allowClick = false;
            s.emit('onSliderMove', s, e);
            e.preventDefault();
            if (s.params.touchMoveStopPropagation && !s.params.nested) {
                e.stopPropagation();
            }
        
            if (!isMoved) {
                if (params.loop) {
                    s.fixLoop();
                }
                startTranslate = s.getWrapperTranslate();
                s.setWrapperTransition(0);
                if (s.animating) {
                    s.wrapper.trigger('webkitTransitionEnd transitionend oTransitionEnd MSTransitionEnd msTransitionEnd');
                }
                if (s.params.autoplay && s.autoplaying) {
                    if (s.params.autoplayDisableOnInteraction) {
                        s.stopAutoplay();
                    }
                    else {
                        s.pauseAutoplay();
                    }
                }
                allowMomentumBounce = false;
                //Grab Cursor
                if (s.params.grabCursor) {
                    s.container[0].style.cursor = 'move';
                    s.container[0].style.cursor = '-webkit-grabbing';
                    s.container[0].style.cursor = '-moz-grabbin';
                    s.container[0].style.cursor = 'grabbing';
                }
            }
            isMoved = true;
        
            var diff = s.touches.diff = s.isHorizontal() ? s.touches.currentX - s.touches.startX : s.touches.currentY - s.touches.startY;
        
            diff = diff * s.params.touchRatio;
            if (s.rtl) diff = -diff;
        
            s.swipeDirection = diff > 0 ? 'prev' : 'next';
            currentTranslate = diff + startTranslate;
        
            var disableParentSwiper = true;
            if ((diff > 0 && currentTranslate > s.minTranslate())) {
                disableParentSwiper = false;
                if (s.params.resistance) currentTranslate = s.minTranslate() - 1 + Math.pow(-s.minTranslate() + startTranslate + diff, s.params.resistanceRatio);
            }
            else if (diff < 0 && currentTranslate < s.maxTranslate()) {
                disableParentSwiper = false;
                if (s.params.resistance) currentTranslate = s.maxTranslate() + 1 - Math.pow(s.maxTranslate() - startTranslate - diff, s.params.resistanceRatio);
            }
        
            if (disableParentSwiper) {
                e.preventedByNestedSwiper = true;
            }
        
            // Directions locks
            if (!s.params.allowSwipeToNext && s.swipeDirection === 'next' && currentTranslate < startTranslate) {
                currentTranslate = startTranslate;
            }
            if (!s.params.allowSwipeToPrev && s.swipeDirection === 'prev' && currentTranslate > startTranslate) {
                currentTranslate = startTranslate;
            }
        
            if (!s.params.followFinger) return;
        
            // Threshold
            if (s.params.threshold > 0) {
                if (Math.abs(diff) > s.params.threshold || allowThresholdMove) {
                    if (!allowThresholdMove) {
                        allowThresholdMove = true;
                        s.touches.startX = s.touches.currentX;
                        s.touches.startY = s.touches.currentY;
                        currentTranslate = startTranslate;
                        s.touches.diff = s.isHorizontal() ? s.touches.currentX - s.touches.startX : s.touches.currentY - s.touches.startY;
                        return;
                    }
                }
                else {
                    currentTranslate = startTranslate;
                    return;
                }
            }
            // Update active index in free mode
            if (s.params.freeMode || s.params.watchSlidesProgress) {
                s.updateActiveIndex();
            }
            if (s.params.freeMode) {
                //Velocity
                if (velocities.length === 0) {
                    velocities.push({
                        position: s.touches[s.isHorizontal() ? 'startX' : 'startY'],
                        time: touchStartTime
                    });
                }
                velocities.push({
                    position: s.touches[s.isHorizontal() ? 'currentX' : 'currentY'],
                    time: (new window.Date()).getTime()
                });
            }
            // Update progress
            s.updateProgress(currentTranslate);
            // Update translate
            s.setWrapperTranslate(currentTranslate);
        };
        s.onTouchEnd = function (e) {
            if (e.originalEvent) e = e.originalEvent;
            if (allowTouchCallbacks) {
                s.emit('onTouchEnd', s, e);
            }
            allowTouchCallbacks = false;
            if (!isTouched) return;
            //Return Grab Cursor
            if (s.params.grabCursor && isMoved && isTouched) {
                s.container[0].style.cursor = 'move';
                s.container[0].style.cursor = '-webkit-grab';
                s.container[0].style.cursor = '-moz-grab';
                s.container[0].style.cursor = 'grab';
            }
        
            // Time diff
            var touchEndTime = Date.now();
            var timeDiff = touchEndTime - touchStartTime;
        
            // Tap, doubleTap, Click
            if (s.allowClick) {
                s.updateClickedSlide(e);
                s.emit('onTap', s, e);
                if (timeDiff < 300 && (touchEndTime - lastClickTime) > 300) {
                    if (clickTimeout) clearTimeout(clickTimeout);
                    clickTimeout = setTimeout(function () {
                        if (!s) return;
                        if (s.params.paginationHide && s.paginationContainer.length > 0 && !$(e.target).hasClass(s.params.bulletClass)) {
                            s.paginationContainer.toggleClass(s.params.paginationHiddenClass);
                        }
                        s.emit('onClick', s, e);
                    }, 300);
        
                }
                if (timeDiff < 300 && (touchEndTime - lastClickTime) < 300) {
                    if (clickTimeout) clearTimeout(clickTimeout);
                    s.emit('onDoubleTap', s, e);
                }
            }
        
            lastClickTime = Date.now();
            setTimeout(function () {
                if (s) s.allowClick = true;
            }, 0);
        
            if (!isTouched || !isMoved || !s.swipeDirection || s.touches.diff === 0 || currentTranslate === startTranslate) {
                isTouched = isMoved = false;
                return;
            }
            isTouched = isMoved = false;
        
            var currentPos;
            if (s.params.followFinger) {
                currentPos = s.rtl ? s.translate : -s.translate;
            }
            else {
                currentPos = -currentTranslate;
            }
            if (s.params.freeMode) {
                if (currentPos < -s.minTranslate()) {
                    s.slideTo(s.activeIndex);
                    return;
                }
                else if (currentPos > -s.maxTranslate()) {
                    if (s.slides.length < s.snapGrid.length) {
                        s.slideTo(s.snapGrid.length - 1);
                    }
                    else {
                        s.slideTo(s.slides.length - 1);
                    }
                    return;
                }
        
                if (s.params.freeModeMomentum) {
                    if (velocities.length > 1) {
                        var lastMoveEvent = velocities.pop(), velocityEvent = velocities.pop();
        
                        var distance = lastMoveEvent.position - velocityEvent.position;
                        var time = lastMoveEvent.time - velocityEvent.time;
                        s.velocity = distance / time;
                        s.velocity = s.velocity / 2;
                        if (Math.abs(s.velocity) < s.params.freeModeMinimumVelocity) {
                            s.velocity = 0;
                        }
                        // this implies that the user stopped moving a finger then released.
                        // There would be no events with distance zero, so the last event is stale.
                        if (time > 150 || (new window.Date().getTime() - lastMoveEvent.time) > 300) {
                            s.velocity = 0;
                        }
                    } else {
                        s.velocity = 0;
                    }
        
                    velocities.length = 0;
                    var momentumDuration = 1000 * s.params.freeModeMomentumRatio;
                    var momentumDistance = s.velocity * momentumDuration;
        
                    var newPosition = s.translate + momentumDistance;
                    if (s.rtl) newPosition = - newPosition;
                    var doBounce = false;
                    var afterBouncePosition;
                    var bounceAmount = Math.abs(s.velocity) * 20 * s.params.freeModeMomentumBounceRatio;
                    if (newPosition < s.maxTranslate()) {
                        if (s.params.freeModeMomentumBounce) {
                            if (newPosition + s.maxTranslate() < -bounceAmount) {
                                newPosition = s.maxTranslate() - bounceAmount;
                            }
                            afterBouncePosition = s.maxTranslate();
                            doBounce = true;
                            allowMomentumBounce = true;
                        }
                        else {
                            newPosition = s.maxTranslate();
                        }
                    }
                    else if (newPosition > s.minTranslate()) {
                        if (s.params.freeModeMomentumBounce) {
                            if (newPosition - s.minTranslate() > bounceAmount) {
                                newPosition = s.minTranslate() + bounceAmount;
                            }
                            afterBouncePosition = s.minTranslate();
                            doBounce = true;
                            allowMomentumBounce = true;
                        }
                        else {
                            newPosition = s.minTranslate();
                        }
                    }
                    else if (s.params.freeModeSticky) {
                        var j = 0,
                            nextSlide;
                        for (j = 0; j < s.snapGrid.length; j += 1) {
                            if (s.snapGrid[j] > -newPosition) {
                                nextSlide = j;
                                break;
                            }
        
                        }
                        if (Math.abs(s.snapGrid[nextSlide] - newPosition) < Math.abs(s.snapGrid[nextSlide - 1] - newPosition) || s.swipeDirection === 'next') {
                            newPosition = s.snapGrid[nextSlide];
                        } else {
                            newPosition = s.snapGrid[nextSlide - 1];
                        }
                        if (!s.rtl) newPosition = - newPosition;
                    }
                    //Fix duration
                    if (s.velocity !== 0) {
                        if (s.rtl) {
                            momentumDuration = Math.abs((-newPosition - s.translate) / s.velocity);
                        }
                        else {
                            momentumDuration = Math.abs((newPosition - s.translate) / s.velocity);
                        }
                    }
                    else if (s.params.freeModeSticky) {
                        s.slideReset();
                        return;
                    }
        
                    if (s.params.freeModeMomentumBounce && doBounce) {
                        s.updateProgress(afterBouncePosition);
                        s.setWrapperTransition(momentumDuration);
                        s.setWrapperTranslate(newPosition);
                        s.onTransitionStart();
                        s.animating = true;
                        s.wrapper.transitionEnd(function () {
                            if (!s || !allowMomentumBounce) return;
                            s.emit('onMomentumBounce', s);
        
                            s.setWrapperTransition(s.params.speed);
                            s.setWrapperTranslate(afterBouncePosition);
                            s.wrapper.transitionEnd(function () {
                                if (!s) return;
                                s.onTransitionEnd();
                            });
                        });
                    } else if (s.velocity) {
                        s.updateProgress(newPosition);
                        s.setWrapperTransition(momentumDuration);
                        s.setWrapperTranslate(newPosition);
                        s.onTransitionStart();
                        if (!s.animating) {
                            s.animating = true;
                            s.wrapper.transitionEnd(function () {
                                if (!s) return;
                                s.onTransitionEnd();
                            });
                        }
        
                    } else {
                        s.updateProgress(newPosition);
                    }
        
                    s.updateActiveIndex();
                }
                if (!s.params.freeModeMomentum || timeDiff >= s.params.longSwipesMs) {
                    s.updateProgress();
                    s.updateActiveIndex();
                }
                return;
            }
        
            // Find current slide
            var i, stopIndex = 0, groupSize = s.slidesSizesGrid[0];
            for (i = 0; i < s.slidesGrid.length; i += s.params.slidesPerGroup) {
                if (typeof s.slidesGrid[i + s.params.slidesPerGroup] !== 'undefined') {
                    if (currentPos >= s.slidesGrid[i] && currentPos < s.slidesGrid[i + s.params.slidesPerGroup]) {
                        stopIndex = i;
                        groupSize = s.slidesGrid[i + s.params.slidesPerGroup] - s.slidesGrid[i];
                    }
                }
                else {
                    if (currentPos >= s.slidesGrid[i]) {
                        stopIndex = i;
                        groupSize = s.slidesGrid[s.slidesGrid.length - 1] - s.slidesGrid[s.slidesGrid.length - 2];
                    }
                }
            }
        
            // Find current slide size
            var ratio = (currentPos - s.slidesGrid[stopIndex]) / groupSize;
        
            if (timeDiff > s.params.longSwipesMs) {
                // Long touches
                if (!s.params.longSwipes) {
                    s.slideTo(s.activeIndex);
                    return;
                }
                if (s.swipeDirection === 'next') {
                    if (ratio >= s.params.longSwipesRatio) s.slideTo(stopIndex + s.params.slidesPerGroup);
                    else s.slideTo(stopIndex);
        
                }
                if (s.swipeDirection === 'prev') {
                    if (ratio > (1 - s.params.longSwipesRatio)) s.slideTo(stopIndex + s.params.slidesPerGroup);
                    else s.slideTo(stopIndex);
                }
            }
            else {
                // Short swipes
                if (!s.params.shortSwipes) {
                    s.slideTo(s.activeIndex);
                    return;
                }
                if (s.swipeDirection === 'next') {
                    s.slideTo(stopIndex + s.params.slidesPerGroup);
        
                }
                if (s.swipeDirection === 'prev') {
                    s.slideTo(stopIndex);
                }
            }
        };
        /*=========================
          Transitions
          ===========================*/
        s._slideTo = function (slideIndex, speed) {
            return s.slideTo(slideIndex, speed, true, true);
        };
        s.slideTo = function (slideIndex, speed, runCallbacks, internal) {
            if (typeof runCallbacks === 'undefined') runCallbacks = true;
            if (typeof slideIndex === 'undefined') slideIndex = 0;
            if (slideIndex < 0) slideIndex = 0;
            s.snapIndex = Math.floor(slideIndex / s.params.slidesPerGroup);
            if (s.snapIndex >= s.snapGrid.length) s.snapIndex = s.snapGrid.length - 1;
        
            var translate = - s.snapGrid[s.snapIndex];
            // Stop autoplay
            if (s.params.autoplay && s.autoplaying) {
                if (internal || !s.params.autoplayDisableOnInteraction) {
                    s.pauseAutoplay(speed);
                }
                else {
                    s.stopAutoplay();
                }
            }
            // Update progress
            s.updateProgress(translate);
        
            // Normalize slideIndex
            for (var i = 0; i < s.slidesGrid.length; i++) {
                if (- Math.floor(translate * 100) >= Math.floor(s.slidesGrid[i] * 100)) {
                    slideIndex = i;
                }
            }
        
            // Directions locks
            if (!s.params.allowSwipeToNext && translate < s.translate && translate < s.minTranslate()) {
                return false;
            }
            if (!s.params.allowSwipeToPrev && translate > s.translate && translate > s.maxTranslate()) {
                if ((s.activeIndex || 0) !== slideIndex ) return false;
            }
        
            // Update Index
            if (typeof speed === 'undefined') speed = s.params.speed;
            s.previousIndex = s.activeIndex || 0;
            s.activeIndex = slideIndex;
        
            if ((s.rtl && -translate === s.translate) || (!s.rtl && translate === s.translate)) {
                // Update Height
                if (s.params.autoHeight) {
                    s.updateAutoHeight();
                }
                s.updateClasses();
                if (s.params.effect !== 'slide') {
                    s.setWrapperTranslate(translate);
                }
                return false;
            }
            s.updateClasses();
            s.onTransitionStart(runCallbacks);
        
            if (speed === 0) {
                s.setWrapperTranslate(translate);
                s.setWrapperTransition(0);
                s.onTransitionEnd(runCallbacks);
            }
            else {
                s.setWrapperTranslate(translate);
                s.setWrapperTransition(speed);
                if (!s.animating) {
                    s.animating = true;
                    s.wrapper.transitionEnd(function () {
                        if (!s) return;
                        s.onTransitionEnd(runCallbacks);
                    });
                }
        
            }
        
            return true;
        };
        
        s.onTransitionStart = function (runCallbacks) {
            if (typeof runCallbacks === 'undefined') runCallbacks = true;
            if (s.params.autoHeight) {
                s.updateAutoHeight();
            }
            if (s.lazy) s.lazy.onTransitionStart();
            if (runCallbacks) {
                s.emit('onTransitionStart', s);
                if (s.activeIndex !== s.previousIndex) {
                    s.emit('onSlideChangeStart', s);
                    if (s.activeIndex > s.previousIndex) {
                        s.emit('onSlideNextStart', s);
                    }
                    else {
                        s.emit('onSlidePrevStart', s);
                    }
                }
        
            }
        };
        s.onTransitionEnd = function (runCallbacks) {
            s.animating = false;
            s.setWrapperTransition(0);
            if (typeof runCallbacks === 'undefined') runCallbacks = true;
            if (s.lazy) s.lazy.onTransitionEnd();
            if (runCallbacks) {
                s.emit('onTransitionEnd', s);
                if (s.activeIndex !== s.previousIndex) {
                    s.emit('onSlideChangeEnd', s);
                    if (s.activeIndex > s.previousIndex) {
                        s.emit('onSlideNextEnd', s);
                    }
                    else {
                        s.emit('onSlidePrevEnd', s);
                    }
                }
            }
            if (s.params.hashnav && s.hashnav) {
                s.hashnav.setHash();
            }
        
        };
        s.slideNext = function (runCallbacks, speed, internal) {
            if (s.params.loop) {
                if (s.animating) return false;
                s.fixLoop();
                var clientLeft = s.container[0].clientLeft;
                return s.slideTo(s.activeIndex + s.params.slidesPerGroup, speed, runCallbacks, internal);
            }
            else return s.slideTo(s.activeIndex + s.params.slidesPerGroup, speed, runCallbacks, internal);
        };
        s._slideNext = function (speed) {
            return s.slideNext(true, speed, true);
        };
        s.slidePrev = function (runCallbacks, speed, internal) {
            if (s.params.loop) {
                if (s.animating) return false;
                s.fixLoop();
                var clientLeft = s.container[0].clientLeft;
                return s.slideTo(s.activeIndex - 1, speed, runCallbacks, internal);
            }
            else return s.slideTo(s.activeIndex - 1, speed, runCallbacks, internal);
        };
        s._slidePrev = function (speed) {
            return s.slidePrev(true, speed, true);
        };
        s.slideReset = function (runCallbacks, speed, internal) {
            return s.slideTo(s.activeIndex, speed, runCallbacks);
        };
        
        /*=========================
          Translate/transition helpers
          ===========================*/
        s.setWrapperTransition = function (duration, byController) {
            s.wrapper.transition(duration);
            if (s.params.effect !== 'slide' && s.effects[s.params.effect]) {
                s.effects[s.params.effect].setTransition(duration);
            }
            if (s.params.parallax && s.parallax) {
                s.parallax.setTransition(duration);
            }
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.setTransition(duration);
            }
            if (s.params.control && s.controller) {
                s.controller.setTransition(duration, byController);
            }
            s.emit('onSetTransition', s, duration);
        };
        s.setWrapperTranslate = function (translate, updateActiveIndex, byController) {
            var x = 0, y = 0, z = 0;
            if (s.isHorizontal()) {
                x = s.rtl ? -translate : translate;
            }
            else {
                y = translate;
            }
        
            if (s.params.roundLengths) {
                x = round(x);
                y = round(y);
            }
        
            if (!s.params.virtualTranslate) {
                if (s.support.transforms3d) s.wrapper.transform('translate3d(' + x + 'px, ' + y + 'px, ' + z + 'px)');
                else s.wrapper.transform('translate(' + x + 'px, ' + y + 'px)');
            }
        
            s.translate = s.isHorizontal() ? x : y;
        
            // Check if we need to update progress
            var progress;
            var translatesDiff = s.maxTranslate() - s.minTranslate();
            if (translatesDiff === 0) {
                progress = 0;
            }
            else {
                progress = (translate - s.minTranslate()) / (translatesDiff);
            }
            if (progress !== s.progress) {
                s.updateProgress(translate);
            }
        
            if (updateActiveIndex) s.updateActiveIndex();
            if (s.params.effect !== 'slide' && s.effects[s.params.effect]) {
                s.effects[s.params.effect].setTranslate(s.translate);
            }
            if (s.params.parallax && s.parallax) {
                s.parallax.setTranslate(s.translate);
            }
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.setTranslate(s.translate);
            }
            if (s.params.control && s.controller) {
                s.controller.setTranslate(s.translate, byController);
            }
            s.emit('onSetTranslate', s, s.translate);
        };
        
        s.getTranslate = function (el, axis) {
            var matrix, curTransform, curStyle, transformMatrix;
        
            // automatic axis detection
            if (typeof axis === 'undefined') {
                axis = 'x';
            }
        
            if (s.params.virtualTranslate) {
                return s.rtl ? -s.translate : s.translate;
            }
        
            curStyle = window.getComputedStyle(el, null);
            if (window.WebKitCSSMatrix) {
                curTransform = curStyle.transform || curStyle.webkitTransform;
                if (curTransform.split(',').length > 6) {
                    curTransform = curTransform.split(', ').map(function(a){
                        return a.replace(',','.');
                    }).join(', ');
                }
                // Some old versions of Webkit choke when 'none' is passed; pass
                // empty string instead in this case
                transformMatrix = new window.WebKitCSSMatrix(curTransform === 'none' ? '' : curTransform);
            }
            else {
                transformMatrix = curStyle.MozTransform || curStyle.OTransform || curStyle.MsTransform || curStyle.msTransform  || curStyle.transform || curStyle.getPropertyValue('transform').replace('translate(', 'matrix(1, 0, 0, 1,');
                matrix = transformMatrix.toString().split(',');
            }
        
            if (axis === 'x') {
                //Latest Chrome and webkits Fix
                if (window.WebKitCSSMatrix)
                    curTransform = transformMatrix.m41;
                //Crazy IE10 Matrix
                else if (matrix.length === 16)
                    curTransform = parseFloat(matrix[12]);
                //Normal Browsers
                else
                    curTransform = parseFloat(matrix[4]);
            }
            if (axis === 'y') {
                //Latest Chrome and webkits Fix
                if (window.WebKitCSSMatrix)
                    curTransform = transformMatrix.m42;
                //Crazy IE10 Matrix
                else if (matrix.length === 16)
                    curTransform = parseFloat(matrix[13]);
                //Normal Browsers
                else
                    curTransform = parseFloat(matrix[5]);
            }
            if (s.rtl && curTransform) curTransform = -curTransform;
            return curTransform || 0;
        };
        s.getWrapperTranslate = function (axis) {
            if (typeof axis === 'undefined') {
                axis = s.isHorizontal() ? 'x' : 'y';
            }
            return s.getTranslate(s.wrapper[0], axis);
        };
        
        /*=========================
          Observer
          ===========================*/
        s.observers = [];
        function initObserver(target, options) {
            options = options || {};
            // create an observer instance
            var ObserverFunc = window.MutationObserver || window.WebkitMutationObserver;
            var observer = new ObserverFunc(function (mutations) {
                mutations.forEach(function (mutation) {
                    s.onResize(true);
                    s.emit('onObserverUpdate', s, mutation);
                });
            });
        
            observer.observe(target, {
                attributes: typeof options.attributes === 'undefined' ? true : options.attributes,
                childList: typeof options.childList === 'undefined' ? true : options.childList,
                characterData: typeof options.characterData === 'undefined' ? true : options.characterData
            });
        
            s.observers.push(observer);
        }
        s.initObservers = function () {
            if (s.params.observeParents) {
                var containerParents = s.container.parents();
                for (var i = 0; i < containerParents.length; i++) {
                    initObserver(containerParents[i]);
                }
            }
        
            // Observe container
            initObserver(s.container[0], {childList: false});
        
            // Observe wrapper
            initObserver(s.wrapper[0], {attributes: false});
        };
        s.disconnectObservers = function () {
            for (var i = 0; i < s.observers.length; i++) {
                s.observers[i].disconnect();
            }
            s.observers = [];
        };
        /*=========================
          Loop
          ===========================*/
        // Create looped slides
        s.createLoop = function () {
            // Remove duplicated slides
            s.wrapper.children('.' + s.params.slideClass + '.' + s.params.slideDuplicateClass).remove();
        
            var slides = s.wrapper.children('.' + s.params.slideClass);
        
            if(s.params.slidesPerView === 'auto' && !s.params.loopedSlides) s.params.loopedSlides = slides.length;
        
            s.loopedSlides = parseInt(s.params.loopedSlides || s.params.slidesPerView, 10);
            s.loopedSlides = s.loopedSlides + s.params.loopAdditionalSlides;
            if (s.loopedSlides > slides.length) {
                s.loopedSlides = slides.length;
            }
        
            var prependSlides = [], appendSlides = [], i;
            slides.each(function (index, el) {
                var slide = $(this);
                if (index < s.loopedSlides) appendSlides.push(el);
                if (index < slides.length && index >= slides.length - s.loopedSlides) prependSlides.push(el);
                slide.attr('data-swiper-slide-index', index);
            });
            for (i = 0; i < appendSlides.length; i++) {
                s.wrapper.append($(appendSlides[i].cloneNode(true)).addClass(s.params.slideDuplicateClass));
            }
            for (i = prependSlides.length - 1; i >= 0; i--) {
                s.wrapper.prepend($(prependSlides[i].cloneNode(true)).addClass(s.params.slideDuplicateClass));
            }
        };
        s.destroyLoop = function () {
            s.wrapper.children('.' + s.params.slideClass + '.' + s.params.slideDuplicateClass).remove();
            s.slides.removeAttr('data-swiper-slide-index');
        };
        s.reLoop = function (updatePosition) {
            var oldIndex = s.activeIndex - s.loopedSlides;
            s.destroyLoop();
            s.createLoop();
            s.updateSlidesSize();
            if (updatePosition) {
                s.slideTo(oldIndex + s.loopedSlides, 0, false);
            }
        
        };
        s.fixLoop = function () {
            var newIndex;
            //Fix For Negative Oversliding
            if (s.activeIndex < s.loopedSlides) {
                newIndex = s.slides.length - s.loopedSlides * 3 + s.activeIndex;
                newIndex = newIndex + s.loopedSlides;
                s.slideTo(newIndex, 0, false, true);
            }
            //Fix For Positive Oversliding
            else if ((s.params.slidesPerView === 'auto' && s.activeIndex >= s.loopedSlides * 2) || (s.activeIndex > s.slides.length - s.params.slidesPerView * 2)) {
                newIndex = -s.slides.length + s.activeIndex + s.loopedSlides;
                newIndex = newIndex + s.loopedSlides;
                s.slideTo(newIndex, 0, false, true);
            }
        };
        /*=========================
          Append/Prepend/Remove Slides
          ===========================*/
        s.appendSlide = function (slides) {
            if (s.params.loop) {
                s.destroyLoop();
            }
            if (typeof slides === 'object' && slides.length) {
                for (var i = 0; i < slides.length; i++) {
                    if (slides[i]) s.wrapper.append(slides[i]);
                }
            }
            else {
                s.wrapper.append(slides);
            }
            if (s.params.loop) {
                s.createLoop();
            }
            if (!(s.params.observer && s.support.observer)) {
                s.update(true);
            }
        };
        s.prependSlide = function (slides) {
            if (s.params.loop) {
                s.destroyLoop();
            }
            var newActiveIndex = s.activeIndex + 1;
            if (typeof slides === 'object' && slides.length) {
                for (var i = 0; i < slides.length; i++) {
                    if (slides[i]) s.wrapper.prepend(slides[i]);
                }
                newActiveIndex = s.activeIndex + slides.length;
            }
            else {
                s.wrapper.prepend(slides);
            }
            if (s.params.loop) {
                s.createLoop();
            }
            if (!(s.params.observer && s.support.observer)) {
                s.update(true);
            }
            s.slideTo(newActiveIndex, 0, false);
        };
        s.removeSlide = function (slidesIndexes) {
            if (s.params.loop) {
                s.destroyLoop();
                s.slides = s.wrapper.children('.' + s.params.slideClass);
            }
            var newActiveIndex = s.activeIndex,
                indexToRemove;
            if (typeof slidesIndexes === 'object' && slidesIndexes.length) {
                for (var i = 0; i < slidesIndexes.length; i++) {
                    indexToRemove = slidesIndexes[i];
                    if (s.slides[indexToRemove]) s.slides.eq(indexToRemove).remove();
                    if (indexToRemove < newActiveIndex) newActiveIndex--;
                }
                newActiveIndex = Math.max(newActiveIndex, 0);
            }
            else {
                indexToRemove = slidesIndexes;
                if (s.slides[indexToRemove]) s.slides.eq(indexToRemove).remove();
                if (indexToRemove < newActiveIndex) newActiveIndex--;
                newActiveIndex = Math.max(newActiveIndex, 0);
            }
        
            if (s.params.loop) {
                s.createLoop();
            }
        
            if (!(s.params.observer && s.support.observer)) {
                s.update(true);
            }
            if (s.params.loop) {
                s.slideTo(newActiveIndex + s.loopedSlides, 0, false);
            }
            else {
                s.slideTo(newActiveIndex, 0, false);
            }
        
        };
        s.removeAllSlides = function () {
            var slidesIndexes = [];
            for (var i = 0; i < s.slides.length; i++) {
                slidesIndexes.push(i);
            }
            s.removeSlide(slidesIndexes);
        };
        
    
        /*=========================
          Effects
          ===========================*/
        s.effects = {
            fade: {
                setTranslate: function () {
                    for (var i = 0; i < s.slides.length; i++) {
                        var slide = s.slides.eq(i);
                        var offset = slide[0].swiperSlideOffset;
                        var tx = -offset;
                        if (!s.params.virtualTranslate) tx = tx - s.translate;
                        var ty = 0;
                        if (!s.isHorizontal()) {
                            ty = tx;
                            tx = 0;
                        }
                        var slideOpacity = s.params.fade.crossFade ?
                                Math.max(1 - Math.abs(slide[0].progress), 0) :
                                1 + Math.min(Math.max(slide[0].progress, -1), 0);
                        slide
                            .css({
                                opacity: slideOpacity
                            })
                            .transform('translate3d(' + tx + 'px, ' + ty + 'px, 0px)');
        
                    }
        
                },
                setTransition: function (duration) {
                    s.slides.transition(duration);
                    if (s.params.virtualTranslate && duration !== 0) {
                        var eventTriggered = false;
                        s.slides.transitionEnd(function () {
                            if (eventTriggered) return;
                            if (!s) return;
                            eventTriggered = true;
                            s.animating = false;
                            var triggerEvents = ['webkitTransitionEnd', 'transitionend', 'oTransitionEnd', 'MSTransitionEnd', 'msTransitionEnd'];
                            for (var i = 0; i < triggerEvents.length; i++) {
                                s.wrapper.trigger(triggerEvents[i]);
                            }
                        });
                    }
                }
            },
            flip: {
                setTranslate: function () {
                    for (var i = 0; i < s.slides.length; i++) {
                        var slide = s.slides.eq(i);
                        var progress = slide[0].progress;
                        if (s.params.flip.limitRotation) {
                            progress = Math.max(Math.min(slide[0].progress, 1), -1);
                        }
                        var offset = slide[0].swiperSlideOffset;
                        var rotate = -180 * progress,
                            rotateY = rotate,
                            rotateX = 0,
                            tx = -offset,
                            ty = 0;
                        if (!s.isHorizontal()) {
                            ty = tx;
                            tx = 0;
                            rotateX = -rotateY;
                            rotateY = 0;
                        }
                        else if (s.rtl) {
                            rotateY = -rotateY;
                        }
        
                        slide[0].style.zIndex = -Math.abs(Math.round(progress)) + s.slides.length;
        
                        if (s.params.flip.slideShadows) {
                            //Set shadows
                            var shadowBefore = s.isHorizontal() ? slide.find('.swiper-slide-shadow-left') : slide.find('.swiper-slide-shadow-top');
                            var shadowAfter = s.isHorizontal() ? slide.find('.swiper-slide-shadow-right') : slide.find('.swiper-slide-shadow-bottom');
                            if (shadowBefore.length === 0) {
                                shadowBefore = $('<div class="swiper-slide-shadow-' + (s.isHorizontal() ? 'left' : 'top') + '"></div>');
                                slide.append(shadowBefore);
                            }
                            if (shadowAfter.length === 0) {
                                shadowAfter = $('<div class="swiper-slide-shadow-' + (s.isHorizontal() ? 'right' : 'bottom') + '"></div>');
                                slide.append(shadowAfter);
                            }
                            if (shadowBefore.length) shadowBefore[0].style.opacity = Math.max(-progress, 0);
                            if (shadowAfter.length) shadowAfter[0].style.opacity = Math.max(progress, 0);
                        }
        
                        slide
                            .transform('translate3d(' + tx + 'px, ' + ty + 'px, 0px) rotateX(' + rotateX + 'deg) rotateY(' + rotateY + 'deg)');
                    }
                },
                setTransition: function (duration) {
                    s.slides.transition(duration).find('.swiper-slide-shadow-top, .swiper-slide-shadow-right, .swiper-slide-shadow-bottom, .swiper-slide-shadow-left').transition(duration);
                    if (s.params.virtualTranslate && duration !== 0) {
                        var eventTriggered = false;
                        s.slides.eq(s.activeIndex).transitionEnd(function () {
                            if (eventTriggered) return;
                            if (!s) return;
                            if (!$(this).hasClass(s.params.slideActiveClass)) return;
                            eventTriggered = true;
                            s.animating = false;
                            var triggerEvents = ['webkitTransitionEnd', 'transitionend', 'oTransitionEnd', 'MSTransitionEnd', 'msTransitionEnd'];
                            for (var i = 0; i < triggerEvents.length; i++) {
                                s.wrapper.trigger(triggerEvents[i]);
                            }
                        });
                    }
                }
            },
            cube: {
                setTranslate: function () {
                    var wrapperRotate = 0, cubeShadow;
                    if (s.params.cube.shadow) {
                        if (s.isHorizontal()) {
                            cubeShadow = s.wrapper.find('.swiper-cube-shadow');
                            if (cubeShadow.length === 0) {
                                cubeShadow = $('<div class="swiper-cube-shadow"></div>');
                                s.wrapper.append(cubeShadow);
                            }
                            cubeShadow.css({height: s.width + 'px'});
                        }
                        else {
                            cubeShadow = s.container.find('.swiper-cube-shadow');
                            if (cubeShadow.length === 0) {
                                cubeShadow = $('<div class="swiper-cube-shadow"></div>');
                                s.container.append(cubeShadow);
                            }
                        }
                    }
                    for (var i = 0; i < s.slides.length; i++) {
                        var slide = s.slides.eq(i);
                        var slideAngle = i * 90;
                        var round = Math.floor(slideAngle / 360);
                        if (s.rtl) {
                            slideAngle = -slideAngle;
                            round = Math.floor(-slideAngle / 360);
                        }
                        var progress = Math.max(Math.min(slide[0].progress, 1), -1);
                        var tx = 0, ty = 0, tz = 0;
                        if (i % 4 === 0) {
                            tx = - round * 4 * s.size;
                            tz = 0;
                        }
                        else if ((i - 1) % 4 === 0) {
                            tx = 0;
                            tz = - round * 4 * s.size;
                        }
                        else if ((i - 2) % 4 === 0) {
                            tx = s.size + round * 4 * s.size;
                            tz = s.size;
                        }
                        else if ((i - 3) % 4 === 0) {
                            tx = - s.size;
                            tz = 3 * s.size + s.size * 4 * round;
                        }
                        if (s.rtl) {
                            tx = -tx;
                        }
        
                        if (!s.isHorizontal()) {
                            ty = tx;
                            tx = 0;
                        }
        
                        var transform = 'rotateX(' + (s.isHorizontal() ? 0 : -slideAngle) + 'deg) rotateY(' + (s.isHorizontal() ? slideAngle : 0) + 'deg) translate3d(' + tx + 'px, ' + ty + 'px, ' + tz + 'px)';
                        if (progress <= 1 && progress > -1) {
                            wrapperRotate = i * 90 + progress * 90;
                            if (s.rtl) wrapperRotate = -i * 90 - progress * 90;
                        }
                        slide.transform(transform);
                        if (s.params.cube.slideShadows) {
                            //Set shadows
                            var shadowBefore = s.isHorizontal() ? slide.find('.swiper-slide-shadow-left') : slide.find('.swiper-slide-shadow-top');
                            var shadowAfter = s.isHorizontal() ? slide.find('.swiper-slide-shadow-right') : slide.find('.swiper-slide-shadow-bottom');
                            if (shadowBefore.length === 0) {
                                shadowBefore = $('<div class="swiper-slide-shadow-' + (s.isHorizontal() ? 'left' : 'top') + '"></div>');
                                slide.append(shadowBefore);
                            }
                            if (shadowAfter.length === 0) {
                                shadowAfter = $('<div class="swiper-slide-shadow-' + (s.isHorizontal() ? 'right' : 'bottom') + '"></div>');
                                slide.append(shadowAfter);
                            }
                            if (shadowBefore.length) shadowBefore[0].style.opacity = Math.max(-progress, 0);
                            if (shadowAfter.length) shadowAfter[0].style.opacity = Math.max(progress, 0);
                        }
                    }
                    s.wrapper.css({
                        '-webkit-transform-origin': '50% 50% -' + (s.size / 2) + 'px',
                        '-moz-transform-origin': '50% 50% -' + (s.size / 2) + 'px',
                        '-ms-transform-origin': '50% 50% -' + (s.size / 2) + 'px',
                        'transform-origin': '50% 50% -' + (s.size / 2) + 'px'
                    });
        
                    if (s.params.cube.shadow) {
                        if (s.isHorizontal()) {
                            cubeShadow.transform('translate3d(0px, ' + (s.width / 2 + s.params.cube.shadowOffset) + 'px, ' + (-s.width / 2) + 'px) rotateX(90deg) rotateZ(0deg) scale(' + (s.params.cube.shadowScale) + ')');
                        }
                        else {
                            var shadowAngle = Math.abs(wrapperRotate) - Math.floor(Math.abs(wrapperRotate) / 90) * 90;
                            var multiplier = 1.5 - (Math.sin(shadowAngle * 2 * Math.PI / 360) / 2 + Math.cos(shadowAngle * 2 * Math.PI / 360) / 2);
                            var scale1 = s.params.cube.shadowScale,
                                scale2 = s.params.cube.shadowScale / multiplier,
                                offset = s.params.cube.shadowOffset;
                            cubeShadow.transform('scale3d(' + scale1 + ', 1, ' + scale2 + ') translate3d(0px, ' + (s.height / 2 + offset) + 'px, ' + (-s.height / 2 / scale2) + 'px) rotateX(-90deg)');
                        }
                    }
                    var zFactor = (s.isSafari || s.isUiWebView) ? (-s.size / 2) : 0;
                    s.wrapper.transform('translate3d(0px,0,' + zFactor + 'px) rotateX(' + (s.isHorizontal() ? 0 : wrapperRotate) + 'deg) rotateY(' + (s.isHorizontal() ? -wrapperRotate : 0) + 'deg)');
                },
                setTransition: function (duration) {
                    s.slides.transition(duration).find('.swiper-slide-shadow-top, .swiper-slide-shadow-right, .swiper-slide-shadow-bottom, .swiper-slide-shadow-left').transition(duration);
                    if (s.params.cube.shadow && !s.isHorizontal()) {
                        s.container.find('.swiper-cube-shadow').transition(duration);
                    }
                }
            },
            coverflow: {
                setTranslate: function () {
                    var transform = s.translate;
                    var center = s.isHorizontal() ? -transform + s.width / 2 : -transform + s.height / 2;
                    var rotate = s.isHorizontal() ? s.params.coverflow.rotate: -s.params.coverflow.rotate;
                    var translate = s.params.coverflow.depth;
                    //Each slide offset from center
                    for (var i = 0, length = s.slides.length; i < length; i++) {
                        var slide = s.slides.eq(i);
                        var slideSize = s.slidesSizesGrid[i];
                        var slideOffset = slide[0].swiperSlideOffset;
                        var offsetMultiplier = (center - slideOffset - slideSize / 2) / slideSize * s.params.coverflow.modifier;
        
                        var rotateY = s.isHorizontal() ? rotate * offsetMultiplier : 0;
                        var rotateX = s.isHorizontal() ? 0 : rotate * offsetMultiplier;
                        // var rotateZ = 0
                        var translateZ = -translate * Math.abs(offsetMultiplier);
        
                        var translateY = s.isHorizontal() ? 0 : s.params.coverflow.stretch * (offsetMultiplier);
                        var translateX = s.isHorizontal() ? s.params.coverflow.stretch * (offsetMultiplier) : 0;
        
                        //Fix for ultra small values
                        if (Math.abs(translateX) < 0.001) translateX = 0;
                        if (Math.abs(translateY) < 0.001) translateY = 0;
                        if (Math.abs(translateZ) < 0.001) translateZ = 0;
                        if (Math.abs(rotateY) < 0.001) rotateY = 0;
                        if (Math.abs(rotateX) < 0.001) rotateX = 0;
        
                        var slideTransform = 'translate3d(' + translateX + 'px,' + translateY + 'px,' + translateZ + 'px)  rotateX(' + rotateX + 'deg) rotateY(' + rotateY + 'deg)';
        
                        slide.transform(slideTransform);
                        slide[0].style.zIndex = -Math.abs(Math.round(offsetMultiplier)) + 1;
                        if (s.params.coverflow.slideShadows) {
                            //Set shadows
                            var shadowBefore = s.isHorizontal() ? slide.find('.swiper-slide-shadow-left') : slide.find('.swiper-slide-shadow-top');
                            var shadowAfter = s.isHorizontal() ? slide.find('.swiper-slide-shadow-right') : slide.find('.swiper-slide-shadow-bottom');
                            if (shadowBefore.length === 0) {
                                shadowBefore = $('<div class="swiper-slide-shadow-' + (s.isHorizontal() ? 'left' : 'top') + '"></div>');
                                slide.append(shadowBefore);
                            }
                            if (shadowAfter.length === 0) {
                                shadowAfter = $('<div class="swiper-slide-shadow-' + (s.isHorizontal() ? 'right' : 'bottom') + '"></div>');
                                slide.append(shadowAfter);
                            }
                            if (shadowBefore.length) shadowBefore[0].style.opacity = offsetMultiplier > 0 ? offsetMultiplier : 0;
                            if (shadowAfter.length) shadowAfter[0].style.opacity = (-offsetMultiplier) > 0 ? -offsetMultiplier : 0;
                        }
                    }
        
                    //Set correct perspective for IE10
                    if (s.browser.ie) {
                        var ws = s.wrapper[0].style;
                        ws.perspectiveOrigin = center + 'px 50%';
                    }
                },
                setTransition: function (duration) {
                    s.slides.transition(duration).find('.swiper-slide-shadow-top, .swiper-slide-shadow-right, .swiper-slide-shadow-bottom, .swiper-slide-shadow-left').transition(duration);
                }
            }
        };
    
        /*=========================
          Images Lazy Loading
          ===========================*/
        s.lazy = {
            initialImageLoaded: false,
            loadImageInSlide: function (index, loadInDuplicate) {
                if (typeof index === 'undefined') return;
                if (typeof loadInDuplicate === 'undefined') loadInDuplicate = true;
                if (s.slides.length === 0) return;
        
                var slide = s.slides.eq(index);
                var img = slide.find('.swiper-lazy:not(.swiper-lazy-loaded):not(.swiper-lazy-loading)');
                if (slide.hasClass('swiper-lazy') && !slide.hasClass('swiper-lazy-loaded') && !slide.hasClass('swiper-lazy-loading')) {
                    img = img.add(slide[0]);
                }
                if (img.length === 0) return;
        
                img.each(function () {
                    var _img = $(this);
                    _img.addClass('swiper-lazy-loading');
                    var background = _img.attr('data-background');
                    var src = _img.attr('data-src'),
                        srcset = _img.attr('data-srcset');
                    s.loadImage(_img[0], (src || background), srcset, false, function () {
                        if (background) {
                            _img.css('background-image', 'url("' + background + '")');
                            _img.removeAttr('data-background');
                        }
                        else {
                            if (srcset) {
                                _img.attr('srcset', srcset);
                                _img.removeAttr('data-srcset');
                            }
                            if (src) {
                                _img.attr('src', src);
                                _img.removeAttr('data-src');
                            }
        
                        }
        
                        _img.addClass('swiper-lazy-loaded').removeClass('swiper-lazy-loading');
                        slide.find('.swiper-lazy-preloader, .preloader').remove();
                        if (s.params.loop && loadInDuplicate) {
                            var slideOriginalIndex = slide.attr('data-swiper-slide-index');
                            if (slide.hasClass(s.params.slideDuplicateClass)) {
                                var originalSlide = s.wrapper.children('[data-swiper-slide-index="' + slideOriginalIndex + '"]:not(.' + s.params.slideDuplicateClass + ')');
                                s.lazy.loadImageInSlide(originalSlide.index(), false);
                            }
                            else {
                                var duplicatedSlide = s.wrapper.children('.' + s.params.slideDuplicateClass + '[data-swiper-slide-index="' + slideOriginalIndex + '"]');
                                s.lazy.loadImageInSlide(duplicatedSlide.index(), false);
                            }
                        }
                        s.emit('onLazyImageReady', s, slide[0], _img[0]);
                    });
        
                    s.emit('onLazyImageLoad', s, slide[0], _img[0]);
                });
        
            },
            load: function () {
                var i;
                if (s.params.watchSlidesVisibility) {
                    s.wrapper.children('.' + s.params.slideVisibleClass).each(function () {
                        s.lazy.loadImageInSlide($(this).index());
                    });
                }
                else {
                    if (s.params.slidesPerView > 1) {
                        for (i = s.activeIndex; i < s.activeIndex + s.params.slidesPerView ; i++) {
                            if (s.slides[i]) s.lazy.loadImageInSlide(i);
                        }
                    }
                    else {
                        s.lazy.loadImageInSlide(s.activeIndex);
                    }
                }
                if (s.params.lazyLoadingInPrevNext) {
                    if (s.params.slidesPerView > 1 || (s.params.lazyLoadingInPrevNextAmount && s.params.lazyLoadingInPrevNextAmount > 1)) {
                        var amount = s.params.lazyLoadingInPrevNextAmount;
                        var spv = s.params.slidesPerView;
                        var maxIndex = Math.min(s.activeIndex + spv + Math.max(amount, spv), s.slides.length);
                        var minIndex = Math.max(s.activeIndex - Math.max(spv, amount), 0);
                        // Next Slides
                        for (i = s.activeIndex + s.params.slidesPerView; i < maxIndex; i++) {
                            if (s.slides[i]) s.lazy.loadImageInSlide(i);
                        }
                        // Prev Slides
                        for (i = minIndex; i < s.activeIndex ; i++) {
                            if (s.slides[i]) s.lazy.loadImageInSlide(i);
                        }
                    }
                    else {
                        var nextSlide = s.wrapper.children('.' + s.params.slideNextClass);
                        if (nextSlide.length > 0) s.lazy.loadImageInSlide(nextSlide.index());
        
                        var prevSlide = s.wrapper.children('.' + s.params.slidePrevClass);
                        if (prevSlide.length > 0) s.lazy.loadImageInSlide(prevSlide.index());
                    }
                }
            },
            onTransitionStart: function () {
                if (s.params.lazyLoading) {
                    if (s.params.lazyLoadingOnTransitionStart || (!s.params.lazyLoadingOnTransitionStart && !s.lazy.initialImageLoaded)) {
                        s.lazy.load();
                    }
                }
            },
            onTransitionEnd: function () {
                if (s.params.lazyLoading && !s.params.lazyLoadingOnTransitionStart) {
                    s.lazy.load();
                }
            }
        };
        
    
        /*=========================
          Scrollbar
          ===========================*/
        s.scrollbar = {
            isTouched: false,
            setDragPosition: function (e) {
                var sb = s.scrollbar;
                var x = 0, y = 0;
                var translate;
                var pointerPosition = s.isHorizontal() ?
                    ((e.type === 'touchstart' || e.type === 'touchmove') ? e.targetTouches[0].pageX : e.pageX || e.clientX) :
                    ((e.type === 'touchstart' || e.type === 'touchmove') ? e.targetTouches[0].pageY : e.pageY || e.clientY) ;
                var position = (pointerPosition) - sb.track.offset()[s.isHorizontal() ? 'left' : 'top'] - sb.dragSize / 2;
                var positionMin = -s.minTranslate() * sb.moveDivider;
                var positionMax = -s.maxTranslate() * sb.moveDivider;
                if (position < positionMin) {
                    position = positionMin;
                }
                else if (position > positionMax) {
                    position = positionMax;
                }
                position = -position / sb.moveDivider;
                s.updateProgress(position);
                s.setWrapperTranslate(position, true);
            },
            dragStart: function (e) {
                var sb = s.scrollbar;
                sb.isTouched = true;
                e.preventDefault();
                e.stopPropagation();
        
                sb.setDragPosition(e);
                clearTimeout(sb.dragTimeout);
        
                sb.track.transition(0);
                if (s.params.scrollbarHide) {
                    sb.track.css('opacity', 1);
                }
                s.wrapper.transition(100);
                sb.drag.transition(100);
                s.emit('onScrollbarDragStart', s);
            },
            dragMove: function (e) {
                var sb = s.scrollbar;
                if (!sb.isTouched) return;
                if (e.preventDefault) e.preventDefault();
                else e.returnValue = false;
                sb.setDragPosition(e);
                s.wrapper.transition(0);
                sb.track.transition(0);
                sb.drag.transition(0);
                s.emit('onScrollbarDragMove', s);
            },
            dragEnd: function (e) {
                var sb = s.scrollbar;
                if (!sb.isTouched) return;
                sb.isTouched = false;
                if (s.params.scrollbarHide) {
                    clearTimeout(sb.dragTimeout);
                    sb.dragTimeout = setTimeout(function () {
                        sb.track.css('opacity', 0);
                        sb.track.transition(400);
                    }, 1000);
        
                }
                s.emit('onScrollbarDragEnd', s);
                if (s.params.scrollbarSnapOnRelease) {
                    s.slideReset();
                }
            },
            enableDraggable: function () {
                var sb = s.scrollbar;
                var target = s.support.touch ? sb.track : document;
                $(sb.track).on(s.touchEvents.start, sb.dragStart);
                $(target).on(s.touchEvents.move, sb.dragMove);
                $(target).on(s.touchEvents.end, sb.dragEnd);
            },
            disableDraggable: function () {
                var sb = s.scrollbar;
                var target = s.support.touch ? sb.track : document;
                $(sb.track).off(s.touchEvents.start, sb.dragStart);
                $(target).off(s.touchEvents.move, sb.dragMove);
                $(target).off(s.touchEvents.end, sb.dragEnd);
            },
            set: function () {
                if (!s.params.scrollbar) return;
                var sb = s.scrollbar;
                sb.track = $(s.params.scrollbar);
                if (s.params.uniqueNavElements && typeof s.params.scrollbar === 'string' && sb.track.length > 1 && s.container.find(s.params.scrollbar).length === 1) {
                    sb.track = s.container.find(s.params.scrollbar);
                }
                sb.drag = sb.track.find('.swiper-scrollbar-drag');
                if (sb.drag.length === 0) {
                    sb.drag = $('<div class="swiper-scrollbar-drag"></div>');
                    sb.track.append(sb.drag);
                }
                sb.drag[0].style.width = '';
                sb.drag[0].style.height = '';
                sb.trackSize = s.isHorizontal() ? sb.track[0].offsetWidth : sb.track[0].offsetHeight;
        
                sb.divider = s.size / s.virtualSize;
                sb.moveDivider = sb.divider * (sb.trackSize / s.size);
                sb.dragSize = sb.trackSize * sb.divider;
        
                if (s.isHorizontal()) {
                    sb.drag[0].style.width = sb.dragSize + 'px';
                }
                else {
                    sb.drag[0].style.height = sb.dragSize + 'px';
                }
        
                if (sb.divider >= 1) {
                    sb.track[0].style.display = 'none';
                }
                else {
                    sb.track[0].style.display = '';
                }
                if (s.params.scrollbarHide) {
                    sb.track[0].style.opacity = 0;
                }
            },
            setTranslate: function () {
                if (!s.params.scrollbar) return;
                var diff;
                var sb = s.scrollbar;
                var translate = s.translate || 0;
                var newPos;
        
                var newSize = sb.dragSize;
                newPos = (sb.trackSize - sb.dragSize) * s.progress;
                if (s.rtl && s.isHorizontal()) {
                    newPos = -newPos;
                    if (newPos > 0) {
                        newSize = sb.dragSize - newPos;
                        newPos = 0;
                    }
                    else if (-newPos + sb.dragSize > sb.trackSize) {
                        newSize = sb.trackSize + newPos;
                    }
                }
                else {
                    if (newPos < 0) {
                        newSize = sb.dragSize + newPos;
                        newPos = 0;
                    }
                    else if (newPos + sb.dragSize > sb.trackSize) {
                        newSize = sb.trackSize - newPos;
                    }
                }
                if (s.isHorizontal()) {
                    if (s.support.transforms3d) {
                        sb.drag.transform('translate3d(' + (newPos) + 'px, 0, 0)');
                    }
                    else {
                        sb.drag.transform('translateX(' + (newPos) + 'px)');
                    }
                    sb.drag[0].style.width = newSize + 'px';
                }
                else {
                    if (s.support.transforms3d) {
                        sb.drag.transform('translate3d(0px, ' + (newPos) + 'px, 0)');
                    }
                    else {
                        sb.drag.transform('translateY(' + (newPos) + 'px)');
                    }
                    sb.drag[0].style.height = newSize + 'px';
                }
                if (s.params.scrollbarHide) {
                    clearTimeout(sb.timeout);
                    sb.track[0].style.opacity = 1;
                    sb.timeout = setTimeout(function () {
                        sb.track[0].style.opacity = 0;
                        sb.track.transition(400);
                    }, 1000);
                }
            },
            setTransition: function (duration) {
                if (!s.params.scrollbar) return;
                s.scrollbar.drag.transition(duration);
            }
        };
    
        /*=========================
          Controller
          ===========================*/
        s.controller = {
            LinearSpline: function (x, y) {
                this.x = x;
                this.y = y;
                this.lastIndex = x.length - 1;
                // Given an x value (x2), return the expected y2 value:
                // (x1,y1) is the known point before given value,
                // (x3,y3) is the known point after given value.
                var i1, i3;
                var l = this.x.length;
        
                this.interpolate = function (x2) {
                    if (!x2) return 0;
        
                    // Get the indexes of x1 and x3 (the array indexes before and after given x2):
                    i3 = binarySearch(this.x, x2);
                    i1 = i3 - 1;
        
                    // We have our indexes i1 & i3, so we can calculate already:
                    // y2 := ((x2−x1) × (y3−y1)) ÷ (x3−x1) + y1
                    return ((x2 - this.x[i1]) * (this.y[i3] - this.y[i1])) / (this.x[i3] - this.x[i1]) + this.y[i1];
                };
        
                var binarySearch = (function() {
                    var maxIndex, minIndex, guess;
                    return function(array, val) {
                        minIndex = -1;
                        maxIndex = array.length;
                        while (maxIndex - minIndex > 1)
                            if (array[guess = maxIndex + minIndex >> 1] <= val) {
                                minIndex = guess;
                            } else {
                                maxIndex = guess;
                            }
                        return maxIndex;
                    };
                })();
            },
            //xxx: for now i will just save one spline function to to
            getInterpolateFunction: function(c){
                if(!s.controller.spline) s.controller.spline = s.params.loop ?
                    new s.controller.LinearSpline(s.slidesGrid, c.slidesGrid) :
                    new s.controller.LinearSpline(s.snapGrid, c.snapGrid);
            },
            setTranslate: function (translate, byController) {
               var controlled = s.params.control;
               var multiplier, controlledTranslate;
               function setControlledTranslate(c) {
                    // this will create an Interpolate function based on the snapGrids
                    // x is the Grid of the scrolled scroller and y will be the controlled scroller
                    // it makes sense to create this only once and recall it for the interpolation
                    // the function does a lot of value caching for performance
                    translate = c.rtl && c.params.direction === 'horizontal' ? -s.translate : s.translate;
                    if (s.params.controlBy === 'slide') {
                        s.controller.getInterpolateFunction(c);
                        // i am not sure why the values have to be multiplicated this way, tried to invert the snapGrid
                        // but it did not work out
                        controlledTranslate = -s.controller.spline.interpolate(-translate);
                    }
        
                    if(!controlledTranslate || s.params.controlBy === 'container'){
                        multiplier = (c.maxTranslate() - c.minTranslate()) / (s.maxTranslate() - s.minTranslate());
                        controlledTranslate = (translate - s.minTranslate()) * multiplier + c.minTranslate();
                    }
        
                    if (s.params.controlInverse) {
                        controlledTranslate = c.maxTranslate() - controlledTranslate;
                    }
                    c.updateProgress(controlledTranslate);
                    c.setWrapperTranslate(controlledTranslate, false, s);
                    c.updateActiveIndex();
               }
               if (s.isArray(controlled)) {
                   for (var i = 0; i < controlled.length; i++) {
                       if (controlled[i] !== byController && controlled[i] instanceof Swiper) {
                           setControlledTranslate(controlled[i]);
                       }
                   }
               }
               else if (controlled instanceof Swiper && byController !== controlled) {
        
                   setControlledTranslate(controlled);
               }
            },
            setTransition: function (duration, byController) {
                var controlled = s.params.control;
                var i;
                function setControlledTransition(c) {
                    c.setWrapperTransition(duration, s);
                    if (duration !== 0) {
                        c.onTransitionStart();
                        c.wrapper.transitionEnd(function(){
                            if (!controlled) return;
                            if (c.params.loop && s.params.controlBy === 'slide') {
                                c.fixLoop();
                            }
                            c.onTransitionEnd();
        
                        });
                    }
                }
                if (s.isArray(controlled)) {
                    for (i = 0; i < controlled.length; i++) {
                        if (controlled[i] !== byController && controlled[i] instanceof Swiper) {
                            setControlledTransition(controlled[i]);
                        }
                    }
                }
                else if (controlled instanceof Swiper && byController !== controlled) {
                    setControlledTransition(controlled);
                }
            }
        };
    
        /*=========================
          Parallax
          ===========================*/
        function setParallaxTransform(el, progress) {
            el = $(el);
            var p, pX, pY;
            var rtlFactor = s.rtl ? -1 : 1;
        
            p = el.attr('data-swiper-parallax') || '0';
            pX = el.attr('data-swiper-parallax-x');
            pY = el.attr('data-swiper-parallax-y');
            if (pX || pY) {
                pX = pX || '0';
                pY = pY || '0';
            }
            else {
                if (s.isHorizontal()) {
                    pX = p;
                    pY = '0';
                }
                else {
                    pY = p;
                    pX = '0';
                }
            }
        
            if ((pX).indexOf('%') >= 0) {
                pX = parseInt(pX, 10) * progress * rtlFactor + '%';
            }
            else {
                pX = pX * progress * rtlFactor + 'px' ;
            }
            if ((pY).indexOf('%') >= 0) {
                pY = parseInt(pY, 10) * progress + '%';
            }
            else {
                pY = pY * progress + 'px' ;
            }
        
            el.transform('translate3d(' + pX + ', ' + pY + ',0px)');
        }
        s.parallax = {
            setTranslate: function () {
                s.container.children('[data-swiper-parallax], [data-swiper-parallax-x], [data-swiper-parallax-y]').each(function(){
                    setParallaxTransform(this, s.progress);
        
                });
                s.slides.each(function () {
                    var slide = $(this);
                    slide.find('[data-swiper-parallax], [data-swiper-parallax-x], [data-swiper-parallax-y]').each(function () {
                        var progress = Math.min(Math.max(slide[0].progress, -1), 1);
                        setParallaxTransform(this, progress);
                    });
                });
            },
            setTransition: function (duration) {
                if (typeof duration === 'undefined') duration = s.params.speed;
                s.container.find('[data-swiper-parallax], [data-swiper-parallax-x], [data-swiper-parallax-y]').each(function(){
                    var el = $(this);
                    var parallaxDuration = parseInt(el.attr('data-swiper-parallax-duration'), 10) || duration;
                    if (duration === 0) parallaxDuration = 0;
                    el.transition(parallaxDuration);
                });
            }
        };
        
    
        /*=========================
          Plugins API. Collect all and init all plugins
          ===========================*/
        s._plugins = [];
        for (var plugin in s.plugins) {
            var p = s.plugins[plugin](s, s.params[plugin]);
            if (p) s._plugins.push(p);
        }
        // Method to call all plugins event/method
        s.callPlugins = function (eventName) {
            for (var i = 0; i < s._plugins.length; i++) {
                if (eventName in s._plugins[i]) {
                    s._plugins[i][eventName](arguments[1], arguments[2], arguments[3], arguments[4], arguments[5]);
                }
            }
        };
    
        /*=========================
          Events/Callbacks/Plugins Emitter
          ===========================*/
        function normalizeEventName (eventName) {
            if (eventName.indexOf('on') !== 0) {
                if (eventName[0] !== eventName[0].toUpperCase()) {
                    eventName = 'on' + eventName[0].toUpperCase() + eventName.substring(1);
                }
                else {
                    eventName = 'on' + eventName;
                }
            }
            return eventName;
        }
        s.emitterEventListeners = {
        
        };
        s.emit = function (eventName) {
            // Trigger callbacks
            if (s.params[eventName]) {
                s.params[eventName](arguments[1], arguments[2], arguments[3], arguments[4], arguments[5]);
            }
            var i;
            // Trigger events
            if (s.emitterEventListeners[eventName]) {
                for (i = 0; i < s.emitterEventListeners[eventName].length; i++) {
                    s.emitterEventListeners[eventName][i](arguments[1], arguments[2], arguments[3], arguments[4], arguments[5]);
                }
            }
            // Trigger plugins
            if (s.callPlugins) s.callPlugins(eventName, arguments[1], arguments[2], arguments[3], arguments[4], arguments[5]);
        };
        s.on = function (eventName, handler) {
            eventName = normalizeEventName(eventName);
            if (!s.emitterEventListeners[eventName]) s.emitterEventListeners[eventName] = [];
            s.emitterEventListeners[eventName].push(handler);
            return s;
        };
        s.off = function (eventName, handler) {
            var i;
            eventName = normalizeEventName(eventName);
            if (typeof handler === 'undefined') {
                // Remove all handlers for such event
                s.emitterEventListeners[eventName] = [];
                return s;
            }
            if (!s.emitterEventListeners[eventName] || s.emitterEventListeners[eventName].length === 0) return;
            for (i = 0; i < s.emitterEventListeners[eventName].length; i++) {
                if(s.emitterEventListeners[eventName][i] === handler) s.emitterEventListeners[eventName].splice(i, 1);
            }
            return s;
        };
        s.once = function (eventName, handler) {
            eventName = normalizeEventName(eventName);
            var _handler = function () {
                handler(arguments[0], arguments[1], arguments[2], arguments[3], arguments[4]);
                s.off(eventName, _handler);
            };
            s.on(eventName, _handler);
            return s;
        };
    
        // Accessibility tools
        s.a11y = {
            makeFocusable: function ($el) {
                $el.attr('tabIndex', '0');
                return $el;
            },
            addRole: function ($el, role) {
                $el.attr('role', role);
                return $el;
            },
        
            addLabel: function ($el, label) {
                $el.attr('aria-label', label);
                return $el;
            },
        
            disable: function ($el) {
                $el.attr('aria-disabled', true);
                return $el;
            },
        
            enable: function ($el) {
                $el.attr('aria-disabled', false);
                return $el;
            },
        
            onEnterKey: function (event) {
                if (event.keyCode !== 13) return;
                if ($(event.target).is(s.params.nextButton)) {
                    s.onClickNext(event);
                    if (s.isEnd) {
                        s.a11y.notify(s.params.lastSlideMessage);
                    }
                    else {
                        s.a11y.notify(s.params.nextSlideMessage);
                    }
                }
                else if ($(event.target).is(s.params.prevButton)) {
                    s.onClickPrev(event);
                    if (s.isBeginning) {
                        s.a11y.notify(s.params.firstSlideMessage);
                    }
                    else {
                        s.a11y.notify(s.params.prevSlideMessage);
                    }
                }
                if ($(event.target).is('.' + s.params.bulletClass)) {
                    $(event.target)[0].click();
                }
            },
        
            liveRegion: $('<span class="swiper-notification" aria-live="assertive" aria-atomic="true"></span>'),
        
            notify: function (message) {
                var notification = s.a11y.liveRegion;
                if (notification.length === 0) return;
                notification.html('');
                notification.html(message);
            },
            init: function () {
                // Setup accessibility
                if (s.params.nextButton && s.nextButton && s.nextButton.length > 0) {
                    s.a11y.makeFocusable(s.nextButton);
                    s.a11y.addRole(s.nextButton, 'button');
                    s.a11y.addLabel(s.nextButton, s.params.nextSlideMessage);
                }
                if (s.params.prevButton && s.prevButton && s.prevButton.length > 0) {
                    s.a11y.makeFocusable(s.prevButton);
                    s.a11y.addRole(s.prevButton, 'button');
                    s.a11y.addLabel(s.prevButton, s.params.prevSlideMessage);
                }
        
                $(s.container).append(s.a11y.liveRegion);
            },
            initPagination: function () {
                if (s.params.pagination && s.params.paginationClickable && s.bullets && s.bullets.length) {
                    s.bullets.each(function () {
                        var bullet = $(this);
                        s.a11y.makeFocusable(bullet);
                        s.a11y.addRole(bullet, 'button');
                        s.a11y.addLabel(bullet, s.params.paginationBulletMessage.replace(/{{index}}/, bullet.index() + 1));
                    });
                }
            },
            destroy: function () {
                if (s.a11y.liveRegion && s.a11y.liveRegion.length > 0) s.a11y.liveRegion.remove();
            }
        };
        
    
        /*=========================
          Init/Destroy
          ===========================*/
        s.init = function () {
            if (s.params.loop) s.createLoop();
            s.updateContainerSize();
            s.updateSlidesSize();
            s.updatePagination();
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.set();
                if (s.params.scrollbarDraggable) {
                    s.scrollbar.enableDraggable();
                }
            }
            if (s.params.effect !== 'slide' && s.effects[s.params.effect]) {
                if (!s.params.loop) s.updateProgress();
                s.effects[s.params.effect].setTranslate();
            }
            if (s.params.loop) {
                s.slideTo(s.params.initialSlide + s.loopedSlides, 0, s.params.runCallbacksOnInit);
            }
            else {
                s.slideTo(s.params.initialSlide, 0, s.params.runCallbacksOnInit);
                if (s.params.initialSlide === 0) {
                    if (s.parallax && s.params.parallax) s.parallax.setTranslate();
                    if (s.lazy && s.params.lazyLoading) {
                        s.lazy.load();
                        s.lazy.initialImageLoaded = true;
                    }
                }
            }
            s.attachEvents();
            if (s.params.observer && s.support.observer) {
                s.initObservers();
            }
            if (s.params.preloadImages && !s.params.lazyLoading) {
                s.preloadImages();
            }
            if (s.params.autoplay) {
                s.startAutoplay();
            }
            if (s.params.keyboardControl) {
                if (s.enableKeyboardControl) s.enableKeyboardControl();
            }
            if (s.params.mousewheelControl) {
                if (s.enableMousewheelControl) s.enableMousewheelControl();
            }
            if (s.params.hashnav) {
                if (s.hashnav) s.hashnav.init();
            }
            if (s.params.a11y && s.a11y) s.a11y.init();
            s.emit('onInit', s);
        };
        
        // Cleanup dynamic styles
        s.cleanupStyles = function () {
            // Container
            s.container.removeClass(s.classNames.join(' ')).removeAttr('style');
        
            // Wrapper
            s.wrapper.removeAttr('style');
        
            // Slides
            if (s.slides && s.slides.length) {
                s.slides
                    .removeClass([
                      s.params.slideVisibleClass,
                      s.params.slideActiveClass,
                      s.params.slideNextClass,
                      s.params.slidePrevClass
                    ].join(' '))
                    .removeAttr('style')
                    .removeAttr('data-swiper-column')
                    .removeAttr('data-swiper-row');
            }
        
            // Pagination/Bullets
            if (s.paginationContainer && s.paginationContainer.length) {
                s.paginationContainer.removeClass(s.params.paginationHiddenClass);
            }
            if (s.bullets && s.bullets.length) {
                s.bullets.removeClass(s.params.bulletActiveClass);
            }
        
            // Buttons
            if (s.params.prevButton) $(s.params.prevButton).removeClass(s.params.buttonDisabledClass);
            if (s.params.nextButton) $(s.params.nextButton).removeClass(s.params.buttonDisabledClass);
        
            // Scrollbar
            if (s.params.scrollbar && s.scrollbar) {
                if (s.scrollbar.track && s.scrollbar.track.length) s.scrollbar.track.removeAttr('style');
                if (s.scrollbar.drag && s.scrollbar.drag.length) s.scrollbar.drag.removeAttr('style');
            }
        };
        
        // Destroy
        s.destroy = function (deleteInstance, cleanupStyles) {
            // Detach evebts
            s.detachEvents();
            // Stop autoplay
            s.stopAutoplay();
            // Disable draggable
            if (s.params.scrollbar && s.scrollbar) {
                if (s.params.scrollbarDraggable) {
                    s.scrollbar.disableDraggable();
                }
            }
            // Destroy loop
            if (s.params.loop) {
                s.destroyLoop();
            }
            // Cleanup styles
            if (cleanupStyles) {
                s.cleanupStyles();
            }
            // Disconnect observer
            s.disconnectObservers();
            // Disable keyboard/mousewheel
            if (s.params.keyboardControl) {
                if (s.disableKeyboardControl) s.disableKeyboardControl();
            }
            if (s.params.mousewheelControl) {
                if (s.disableMousewheelControl) s.disableMousewheelControl();
            }
            // Disable a11y
            if (s.params.a11y && s.a11y) s.a11y.destroy();
            // Destroy callback
            s.emit('onDestroy');
            // Delete instance
            if (deleteInstance !== false) s = null;
        };
        
        s.init();
        
    
    
        // Return swiper instance
        return s;
    };
    
    /*==================================================
        Prototype
    ====================================================*/
    Swiper.prototype = {
        isSafari: (function () {
            var ua = navigator.userAgent.toLowerCase();
            return (ua.indexOf('safari') >= 0 && ua.indexOf('chrome') < 0 && ua.indexOf('android') < 0);
        })(),
        isUiWebView: /(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)/i.test(navigator.userAgent),
        isArray: function (arr) {
            return Object.prototype.toString.apply(arr) === '[object Array]';
        },
        /*==================================================
        Browser
        ====================================================*/
        browser: {
            ie: window.navigator.pointerEnabled || window.navigator.msPointerEnabled,
            ieTouch: (window.navigator.msPointerEnabled && window.navigator.msMaxTouchPoints > 1) || (window.navigator.pointerEnabled && window.navigator.maxTouchPoints > 1)
        },
        /*==================================================
        Devices
        ====================================================*/
        device: (function () {
            var ua = navigator.userAgent;
            var android = ua.match(/(Android);?[\s\/]+([\d.]+)?/);
            var ipad = ua.match(/(iPad).*OS\s([\d_]+)/);
            var ipod = ua.match(/(iPod)(.*OS\s([\d_]+))?/);
            var iphone = !ipad && ua.match(/(iPhone\sOS)\s([\d_]+)/);
            return {
                ios: ipad || iphone || ipod,
                android: android
            };
        })(),
        /*==================================================
        Feature Detection
        ====================================================*/
        support: {
            touch : (window.Modernizr && Modernizr.touch === true) || (function () {
                return !!(('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch);
            })(),
    
            transforms3d : (window.Modernizr && Modernizr.csstransforms3d === true) || (function () {
                var div = document.createElement('div').style;
                return ('webkitPerspective' in div || 'MozPerspective' in div || 'OPerspective' in div || 'MsPerspective' in div || 'perspective' in div);
            })(),
    
            flexbox: (function () {
                var div = document.createElement('div').style;
                var styles = ('alignItems webkitAlignItems webkitBoxAlign msFlexAlign mozBoxAlign webkitFlexDirection msFlexDirection mozBoxDirection mozBoxOrient webkitBoxDirection webkitBoxOrient').split(' ');
                for (var i = 0; i < styles.length; i++) {
                    if (styles[i] in div) return true;
                }
            })(),
    
            observer: (function () {
                return ('MutationObserver' in window || 'WebkitMutationObserver' in window);
            })()
        },
        /*==================================================
        Plugins
        ====================================================*/
        plugins: {}
    };

})();



},{}]},{},[])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJmcmFtZXdvcms3Il0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FDQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJnZW5lcmF0ZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlc0NvbnRlbnQiOlsiKGZ1bmN0aW9uIGUodCxuLHIpe2Z1bmN0aW9uIHMobyx1KXtpZighbltvXSl7aWYoIXRbb10pe3ZhciBhPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7aWYoIXUmJmEpcmV0dXJuIGEobywhMCk7aWYoaSlyZXR1cm4gaShvLCEwKTt2YXIgZj1uZXcgRXJyb3IoXCJDYW5ub3QgZmluZCBtb2R1bGUgJ1wiK28rXCInXCIpO3Rocm93IGYuY29kZT1cIk1PRFVMRV9OT1RfRk9VTkRcIixmfXZhciBsPW5bb109e2V4cG9ydHM6e319O3Rbb11bMF0uY2FsbChsLmV4cG9ydHMsZnVuY3Rpb24oZSl7dmFyIG49dFtvXVsxXVtlXTtyZXR1cm4gcyhuP246ZSl9LGwsbC5leHBvcnRzLGUsdCxuLHIpfXJldHVybiBuW29dLmV4cG9ydHN9dmFyIGk9dHlwZW9mIHJlcXVpcmU9PVwiZnVuY3Rpb25cIiYmcmVxdWlyZTtmb3IodmFyIG89MDtvPHIubGVuZ3RoO28rKylzKHJbb10pO3JldHVybiBzfSkiLCIvKipcbiAqIEZyYW1ld29yazcgMS40LjJcbiAqIEZ1bGwgRmVhdHVyZWQgTW9iaWxlIEhUTUwgRnJhbWV3b3JrIEZvciBCdWlsZGluZyBpT1MgJiBBbmRyb2lkIEFwcHNcbiAqIFxuICogaHR0cDovL3d3dy5pZGFuZ2Vyby51cy9mcmFtZXdvcms3XG4gKiBcbiAqIENvcHlyaWdodCAyMDE2LCBWbGFkaW1pciBLaGFybGFtcGlkaVxuICogVGhlIGlEYW5nZXJvLnVzXG4gKiBodHRwOi8vd3d3LmlkYW5nZXJvLnVzL1xuICogXG4gKiBMaWNlbnNlZCB1bmRlciBNSVRcbiAqIFxuICogUmVsZWFzZWQgb246IEZlYnJ1YXJ5IDI3LCAyMDE2XG4gKi9cbihmdW5jdGlvbiAoKSB7XG5cbiAgICAndXNlIHN0cmljdCc7XG4gICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICBGcmFtZXdvcmsgN1xuICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgd2luZG93LkZyYW1ld29yazcgPSBmdW5jdGlvbiAocGFyYW1zKSB7XG4gICAgICAgIC8vIEFwcFxuICAgICAgICB2YXIgYXBwID0gdGhpcztcbiAgICBcbiAgICAgICAgLy8gVmVyc2lvblxuICAgICAgICBhcHAudmVyc2lvbiA9ICcxLjQuMic7XG4gICAgXG4gICAgICAgIC8vIERlZmF1bHQgUGFyYW1ldGVyc1xuICAgICAgICBhcHAucGFyYW1zID0ge1xuICAgICAgICAgICAgY2FjaGU6IHRydWUsXG4gICAgICAgICAgICBjYWNoZUlnbm9yZTogW10sXG4gICAgICAgICAgICBjYWNoZUlnbm9yZUdldFBhcmFtZXRlcnM6IGZhbHNlLFxuICAgICAgICAgICAgY2FjaGVEdXJhdGlvbjogMTAwMCAqIDYwICogMTAsIC8vIFRlbiBtaW51dGVzXG4gICAgICAgICAgICBwcmVsb2FkUHJldmlvdXNQYWdlOiB0cnVlLFxuICAgICAgICAgICAgdW5pcXVlSGlzdG9yeTogZmFsc2UsXG4gICAgICAgICAgICB1bmlxdWVIaXN0b3J5SWdub3JlR2V0UGFyYW1ldGVyczogZmFsc2UsXG4gICAgICAgICAgICBkeW5hbWljUGFnZVVybDogJ2NvbnRlbnQte3tpbmRleH19JyxcbiAgICAgICAgICAgIGFsbG93RHVwbGljYXRlVXJsczogZmFsc2UsXG4gICAgICAgICAgICByb3V0ZXI6IHRydWUsXG4gICAgICAgICAgICAvLyBQdXNoIFN0YXRlXG4gICAgICAgICAgICBwdXNoU3RhdGU6IGZhbHNlLFxuICAgICAgICAgICAgcHVzaFN0YXRlUm9vdDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgcHVzaFN0YXRlTm9BbmltYXRpb246IGZhbHNlLFxuICAgICAgICAgICAgcHVzaFN0YXRlU2VwYXJhdG9yOiAnIyEvJyxcbiAgICAgICAgICAgIHB1c2hTdGF0ZU9uTG9hZDogdHJ1ZSxcbiAgICAgICAgICAgIC8vIEZhc3QgY2xpY2tzXG4gICAgICAgICAgICBmYXN0Q2xpY2tzOiB0cnVlLFxuICAgICAgICAgICAgZmFzdENsaWNrc0Rpc3RhbmNlVGhyZXNob2xkOiAxMCxcbiAgICAgICAgICAgIGZhc3RDbGlja3NEZWxheUJldHdlZW5DbGlja3M6IDUwLFxuICAgICAgICAgICAgLy8gVGFwIEhvbGRcbiAgICAgICAgICAgIHRhcEhvbGQ6IGZhbHNlLFxuICAgICAgICAgICAgdGFwSG9sZERlbGF5OiA3NTAsXG4gICAgICAgICAgICB0YXBIb2xkUHJldmVudENsaWNrczogdHJ1ZSxcbiAgICAgICAgICAgIC8vIEFjdGl2ZSBTdGF0ZVxuICAgICAgICAgICAgYWN0aXZlU3RhdGU6IHRydWUsXG4gICAgICAgICAgICBhY3RpdmVTdGF0ZUVsZW1lbnRzOiAnYSwgYnV0dG9uLCBsYWJlbCwgc3BhbicsXG4gICAgICAgICAgICAvLyBBbmltYXRlIE5hdiBCYWNrIEljb25cbiAgICAgICAgICAgIGFuaW1hdGVOYXZCYWNrSWNvbjogZmFsc2UsXG4gICAgICAgICAgICAvLyBTd2lwZSBCYWNrXG4gICAgICAgICAgICBzd2lwZUJhY2tQYWdlOiB0cnVlLFxuICAgICAgICAgICAgc3dpcGVCYWNrUGFnZVRocmVzaG9sZDogMCxcbiAgICAgICAgICAgIHN3aXBlQmFja1BhZ2VBY3RpdmVBcmVhOiAzMCxcbiAgICAgICAgICAgIHN3aXBlQmFja1BhZ2VBbmltYXRlU2hhZG93OiB0cnVlLFxuICAgICAgICAgICAgc3dpcGVCYWNrUGFnZUFuaW1hdGVPcGFjaXR5OiB0cnVlLFxuICAgICAgICAgICAgLy8gQWpheFxuICAgICAgICAgICAgYWpheExpbmtzOiB1bmRlZmluZWQsIC8vIG9yIENTUyBzZWxlY3RvclxuICAgICAgICAgICAgLy8gRXh0ZXJuYWwgTGlua3NcbiAgICAgICAgICAgIGV4dGVybmFsTGlua3M6ICcuZXh0ZXJuYWwnLCAvLyBDU1Mgc2VsZWN0b3JcbiAgICAgICAgICAgIC8vIFNvcnRhYmxlXG4gICAgICAgICAgICBzb3J0YWJsZTogdHJ1ZSxcbiAgICAgICAgICAgIC8vIFNjcm9sbCB0b29sYmFyc1xuICAgICAgICAgICAgaGlkZU5hdmJhck9uUGFnZVNjcm9sbDogZmFsc2UsXG4gICAgICAgICAgICBoaWRlVG9vbGJhck9uUGFnZVNjcm9sbDogZmFsc2UsXG4gICAgICAgICAgICBoaWRlVGFiYmFyT25QYWdlU2Nyb2xsOiBmYWxzZSxcbiAgICAgICAgICAgIHNob3dCYXJzT25QYWdlU2Nyb2xsRW5kOiB0cnVlLFxuICAgICAgICAgICAgc2hvd0JhcnNPblBhZ2VTY3JvbGxUb3A6IHRydWUsXG4gICAgICAgICAgICAvLyBTd2lwZW91dFxuICAgICAgICAgICAgc3dpcGVvdXQ6IHRydWUsXG4gICAgICAgICAgICBzd2lwZW91dEFjdGlvbnNOb0ZvbGQ6IGZhbHNlLFxuICAgICAgICAgICAgc3dpcGVvdXROb0ZvbGxvdzogZmFsc2UsXG4gICAgICAgICAgICAvLyBTbWFydCBTZWxlY3QgQmFjayBsaW5rIHRlbXBsYXRlXG4gICAgICAgICAgICBzbWFydFNlbGVjdE9wZW5JbjogJ3BhZ2UnLCAvLyBvciAncG9wdXAnIG9yICdwaWNrZXInXG4gICAgICAgICAgICBzbWFydFNlbGVjdEJhY2tUZXh0OiAnQmFjaycsXG4gICAgICAgICAgICBzbWFydFNlbGVjdFBvcHVwQ2xvc2VUZXh0OiAnQ2xvc2UnLFxuICAgICAgICAgICAgc21hcnRTZWxlY3RQaWNrZXJDbG9zZVRleHQ6ICdEb25lJyxcbiAgICAgICAgICAgIHNtYXJ0U2VsZWN0U2VhcmNoYmFyOiBmYWxzZSxcbiAgICAgICAgICAgIHNtYXJ0U2VsZWN0QmFja09uU2VsZWN0OiBmYWxzZSxcbiAgICAgICAgICAgIC8vIFRhcCBOYXZiYXIgb3IgU3RhdHVzYmFyIHRvIHNjcm9sbCB0byB0b3BcbiAgICAgICAgICAgIHNjcm9sbFRvcE9uTmF2YmFyQ2xpY2s6IGZhbHNlLFxuICAgICAgICAgICAgc2Nyb2xsVG9wT25TdGF0dXNiYXJDbGljazogZmFsc2UsXG4gICAgICAgICAgICAvLyBQYW5lbHNcbiAgICAgICAgICAgIHN3aXBlUGFuZWw6IGZhbHNlLCAvLyBvciAnbGVmdCcgb3IgJ3JpZ2h0J1xuICAgICAgICAgICAgc3dpcGVQYW5lbEFjdGl2ZUFyZWE6IDAsXG4gICAgICAgICAgICBzd2lwZVBhbmVsQ2xvc2VPcHBvc2l0ZTogdHJ1ZSxcbiAgICAgICAgICAgIHN3aXBlUGFuZWxPbmx5Q2xvc2U6IGZhbHNlLFxuICAgICAgICAgICAgc3dpcGVQYW5lbE5vRm9sbG93OiBmYWxzZSxcbiAgICAgICAgICAgIHN3aXBlUGFuZWxUaHJlc2hvbGQ6IDAsXG4gICAgICAgICAgICBwYW5lbHNDbG9zZUJ5T3V0c2lkZTogdHJ1ZSxcbiAgICAgICAgICAgIC8vIE1vZGFsc1xuICAgICAgICAgICAgbW9kYWxCdXR0b25PazogJ09LJyxcbiAgICAgICAgICAgIG1vZGFsQnV0dG9uQ2FuY2VsOiAnQ2FuY2VsJyxcbiAgICAgICAgICAgIG1vZGFsVXNlcm5hbWVQbGFjZWhvbGRlcjogJ1VzZXJuYW1lJyxcbiAgICAgICAgICAgIG1vZGFsUGFzc3dvcmRQbGFjZWhvbGRlcjogJ1Bhc3N3b3JkJyxcbiAgICAgICAgICAgIG1vZGFsVGl0bGU6ICdGcmFtZXdvcms3JyxcbiAgICAgICAgICAgIG1vZGFsQ2xvc2VCeU91dHNpZGU6IGZhbHNlLFxuICAgICAgICAgICAgYWN0aW9uc0Nsb3NlQnlPdXRzaWRlOiB0cnVlLFxuICAgICAgICAgICAgcG9wdXBDbG9zZUJ5T3V0c2lkZTogdHJ1ZSxcbiAgICAgICAgICAgIG1vZGFsUHJlbG9hZGVyVGl0bGU6ICdMb2FkaW5nLi4uICcsXG4gICAgICAgICAgICBtb2RhbFN0YWNrOiB0cnVlLFxuICAgICAgICAgICAgLy8gTGF6eSBMb2FkXG4gICAgICAgICAgICBpbWFnZXNMYXp5TG9hZFRocmVzaG9sZDogMCxcbiAgICAgICAgICAgIGltYWdlc0xhenlMb2FkU2VxdWVudGlhbDogdHJ1ZSxcbiAgICAgICAgICAgIC8vIE5hbWUgc3BhY2VcbiAgICAgICAgICAgIHZpZXdDbGFzczogJ3ZpZXcnLFxuICAgICAgICAgICAgdmlld01haW5DbGFzczogJ3ZpZXctbWFpbicsXG4gICAgICAgICAgICB2aWV3c0NsYXNzOiAndmlld3MnLFxuICAgICAgICAgICAgLy8gTm90aWZpY2F0aW9ucyBkZWZhdWx0c1xuICAgICAgICAgICAgbm90aWZpY2F0aW9uQ2xvc2VPbkNsaWNrOiBmYWxzZSxcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNsb3NlSWNvbjogdHJ1ZSxcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNsb3NlQnV0dG9uVGV4dDogJ0Nsb3NlJyxcbiAgICAgICAgICAgIC8vIEFuaW1hdGUgUGFnZXNcbiAgICAgICAgICAgIGFuaW1hdGVQYWdlczogdHJ1ZSxcbiAgICAgICAgICAgIC8vIFRlbXBsYXRlN1xuICAgICAgICAgICAgdGVtcGxhdGVzOiB7fSxcbiAgICAgICAgICAgIHRlbXBsYXRlN0RhdGE6IHt9LFxuICAgICAgICAgICAgdGVtcGxhdGU3UGFnZXM6IGZhbHNlLFxuICAgICAgICAgICAgcHJlY29tcGlsZVRlbXBsYXRlczogZmFsc2UsXG4gICAgICAgICAgICAvLyBNYXRlcmlhbFxuICAgICAgICAgICAgbWF0ZXJpYWw6IGZhbHNlLFxuICAgICAgICAgICAgbWF0ZXJpYWxQYWdlTG9hZERlbGF5OiAwLFxuICAgICAgICAgICAgbWF0ZXJpYWxQcmVsb2FkZXJTdmc6ICc8c3ZnIHhtbG5zPVwiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmdcIiBoZWlnaHQ9XCI3NVwiIHdpZHRoPVwiNzVcIiB2aWV3Ym94PVwiMCAwIDc1IDc1XCI+PGNpcmNsZSBjeD1cIjM3LjVcIiBjeT1cIjM3LjVcIiByPVwiMzMuNVwiIHN0cm9rZS13aWR0aD1cIjhcIi8+PC9zdmc+JyxcbiAgICAgICAgICAgIG1hdGVyaWFsUHJlbG9hZGVySHRtbDpcbiAgICAgICAgICAgICAgICAnPHNwYW4gY2xhc3M9XCJwcmVsb2FkZXItaW5uZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPVwicHJlbG9hZGVyLWlubmVyLWdhcFwiPjwvc3Bhbj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPVwicHJlbG9hZGVyLWlubmVyLWxlZnRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz1cInByZWxvYWRlci1pbm5lci1oYWxmLWNpcmNsZVwiPjwvc3Bhbj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvc3Bhbj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPVwicHJlbG9hZGVyLWlubmVyLXJpZ2h0XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPHNwYW4gY2xhc3M9XCJwcmVsb2FkZXItaW5uZXItaGFsZi1jaXJjbGVcIj48L3NwYW4+JyArXG4gICAgICAgICAgICAgICAgICAgICc8L3NwYW4+JyArXG4gICAgICAgICAgICAgICAgJzwvc3Bhbj4nLFxuICAgICAgICAgICAgbWF0ZXJpYWxSaXBwbGU6IHRydWUsXG4gICAgICAgICAgICBtYXRlcmlhbFJpcHBsZUVsZW1lbnRzOiAnLnJpcHBsZSwgYS5saW5rLCBhLml0ZW0tbGluaywgLmJ1dHRvbiwgLm1vZGFsLWJ1dHRvbiwgLnRhYi1saW5rLCAubGFiZWwtcmFkaW8sIC5sYWJlbC1jaGVja2JveCwgLmFjdGlvbnMtbW9kYWwtYnV0dG9uLCBhLnNlYXJjaGJhci1jbGVhciwgYS5mbG9hdGluZy1idXR0b24sIC5mbG9hdGluZy1idXR0b24gPiBhLCAuc3BlZWQtZGlhbC1idXR0b25zIGEnLFxuICAgICAgICAgICAgLy8gQXV0byBpbml0XG4gICAgICAgICAgICBpbml0OiB0cnVlLFxuICAgICAgICB9O1xuICAgIFxuICAgICAgICAvLyBFeHRlbmQgZGVmYXVsdHMgd2l0aCBwYXJhbWV0ZXJzXG4gICAgICAgIGZvciAodmFyIHBhcmFtIGluIHBhcmFtcykge1xuICAgICAgICAgICAgYXBwLnBhcmFtc1twYXJhbV0gPSBwYXJhbXNbcGFyYW1dO1xuICAgICAgICB9XG4gICAgXG4gICAgICAgIC8vIERPTSBsaWJcbiAgICAgICAgdmFyICQgPSBEb203O1xuICAgIFxuICAgICAgICAvLyBUZW1wbGF0ZTcgbGliXG4gICAgICAgIHZhciB0NyA9IFRlbXBsYXRlNztcbiAgICAgICAgYXBwLl9jb21waWxlZFRlbXBsYXRlcyA9IHt9O1xuICAgIFxuICAgICAgICAvLyBUb3VjaCBldmVudHNcbiAgICAgICAgYXBwLnRvdWNoRXZlbnRzID0ge1xuICAgICAgICAgICAgc3RhcnQ6IGFwcC5zdXBwb3J0LnRvdWNoID8gJ3RvdWNoc3RhcnQnIDogJ21vdXNlZG93bicsXG4gICAgICAgICAgICBtb3ZlOiBhcHAuc3VwcG9ydC50b3VjaCA/ICd0b3VjaG1vdmUnIDogJ21vdXNlbW92ZScsXG4gICAgICAgICAgICBlbmQ6IGFwcC5zdXBwb3J0LnRvdWNoID8gJ3RvdWNoZW5kJyA6ICdtb3VzZXVwJ1xuICAgICAgICB9O1xuICAgIFxuICAgICAgICAvLyBMaW5rIHRvIGxvY2FsIHN0b3JhZ2VcbiAgICAgICAgYXBwLmxzID0gd2luZG93LmxvY2FsU3RvcmFnZTtcbiAgICBcbiAgICAgICAgLy8gUlRMXG4gICAgICAgIGFwcC5ydGwgPSAkKCdib2R5JykuY3NzKCdkaXJlY3Rpb24nKSA9PT0gJ3J0bCc7XG4gICAgICAgIGlmIChhcHAucnRsKSAkKCdodG1sJykuYXR0cignZGlyJywgJ3J0bCcpO1xuICAgIFxuICAgICAgICAvLyBPdmVyd3JpdGUgc3RhdHVzYmFyIG92ZXJsYXlcbiAgICAgICAgaWYgKHR5cGVvZiBhcHAucGFyYW1zLnN0YXR1c2Jhck92ZXJsYXkgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5zdGF0dXNiYXJPdmVybGF5KSAkKCdodG1sJykuYWRkQ2xhc3MoJ3dpdGgtc3RhdHVzYmFyLW92ZXJsYXknKTtcbiAgICAgICAgICAgIGVsc2UgJCgnaHRtbCcpLnJlbW92ZUNsYXNzKCd3aXRoLXN0YXR1c2Jhci1vdmVybGF5Jyk7XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgXG4gICAgXG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgVmlld3MgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLnZpZXdzID0gW107XG4gICAgICAgIHZhciBWaWV3ID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBwYXJhbXMpIHtcbiAgICAgICAgICAgIHZhciBkZWZhdWx0cyA9IHtcbiAgICAgICAgICAgICAgICBkeW5hbWljTmF2YmFyOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBkb21DYWNoZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgbGlua3NWaWV3OiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgcmVsb2FkUGFnZXM6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHVuaXF1ZUhpc3Rvcnk6IGFwcC5wYXJhbXMudW5pcXVlSGlzdG9yeSxcbiAgICAgICAgICAgICAgICB1bmlxdWVIaXN0b3J5SWdub3JlR2V0UGFyYW1ldGVyczogYXBwLnBhcmFtcy51bmlxdWVIaXN0b3J5SWdub3JlR2V0UGFyYW1ldGVycyxcbiAgICAgICAgICAgICAgICBhbGxvd0R1cGxpY2F0ZVVybHM6IGFwcC5wYXJhbXMuYWxsb3dEdXBsaWNhdGVVcmxzLFxuICAgICAgICAgICAgICAgIHN3aXBlQmFja1BhZ2U6IGFwcC5wYXJhbXMuc3dpcGVCYWNrUGFnZSxcbiAgICAgICAgICAgICAgICBzd2lwZUJhY2tQYWdlQW5pbWF0ZVNoYWRvdzogYXBwLnBhcmFtcy5zd2lwZUJhY2tQYWdlQW5pbWF0ZVNoYWRvdyxcbiAgICAgICAgICAgICAgICBzd2lwZUJhY2tQYWdlQW5pbWF0ZU9wYWNpdHk6IGFwcC5wYXJhbXMuc3dpcGVCYWNrUGFnZUFuaW1hdGVPcGFjaXR5LFxuICAgICAgICAgICAgICAgIHN3aXBlQmFja1BhZ2VBY3RpdmVBcmVhOiBhcHAucGFyYW1zLnN3aXBlQmFja1BhZ2VBY3RpdmVBcmVhLFxuICAgICAgICAgICAgICAgIHN3aXBlQmFja1BhZ2VUaHJlc2hvbGQ6IGFwcC5wYXJhbXMuc3dpcGVCYWNrUGFnZVRocmVzaG9sZCxcbiAgICAgICAgICAgICAgICBhbmltYXRlUGFnZXM6IGFwcC5wYXJhbXMuYW5pbWF0ZVBhZ2VzLFxuICAgICAgICAgICAgICAgIHByZWxvYWRQcmV2aW91c1BhZ2U6IGFwcC5wYXJhbXMucHJlbG9hZFByZXZpb3VzUGFnZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZhciBpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBhcmFtc1xuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIERpc2FibGUgZHluYW1pYyBuYXZiYXIgZm9yIG1hdGVyaWFsIHRoZW1lXG4gICAgICAgICAgICBpZiAocGFyYW1zLmR5bmFtaWNOYXZiYXIgJiYgYXBwLnBhcmFtcy5tYXRlcmlhbCkgcGFyYW1zLmR5bmFtaWNOYXZiYXIgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBFeHRlbmQgcGFyYW1zIHdpdGggZGVmYXVsdHNcbiAgICAgICAgICAgIGZvciAodmFyIGRlZiBpbiBkZWZhdWx0cykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW2RlZl0gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtc1tkZWZdID0gZGVmYXVsdHNbZGVmXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBWaWV3XG4gICAgICAgICAgICB2YXIgdmlldyA9IHRoaXM7XG4gICAgICAgICAgICB2aWV3LnBhcmFtcyA9IHBhcmFtcztcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTZWxlY3RvclxuICAgICAgICAgICAgdmlldy5zZWxlY3RvciA9IHNlbGVjdG9yO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIENvbnRhaW5lclxuICAgICAgICAgICAgdmFyIGNvbnRhaW5lciA9ICQoc2VsZWN0b3IpO1xuICAgICAgICAgICAgdmlldy5jb250YWluZXIgPSBjb250YWluZXJbMF07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRml4IFNlbGVjdG9yXG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAvLyBTdXBwb3NlZCB0byBiZSBIVE1MRWxlbWVudCBvciBEb203XG4gICAgICAgICAgICAgICAgc2VsZWN0b3IgPSAoY29udGFpbmVyLmF0dHIoJ2lkJykgPyAnIycgKyBjb250YWluZXIuYXR0cignaWQnKSA6ICcnKSArIChjb250YWluZXIuYXR0cignY2xhc3MnKSA/ICcuJyArIGNvbnRhaW5lci5hdHRyKCdjbGFzcycpLnJlcGxhY2UoLyAvZywgJy4nKS5yZXBsYWNlKCcuYWN0aXZlJywgJycpIDogJycpO1xuICAgICAgICAgICAgICAgIHZpZXcuc2VsZWN0b3IgPSBzZWxlY3RvcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJcyBtYWluXG4gICAgICAgICAgICB2aWV3Lm1haW4gPSBjb250YWluZXIuaGFzQ2xhc3MoYXBwLnBhcmFtcy52aWV3TWFpbkNsYXNzKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDb250ZW50IGNhY2hlXG4gICAgICAgICAgICB2aWV3LmNvbnRlbnRDYWNoZSA9IHt9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBhZ2VzIGNhY2hlXG4gICAgICAgICAgICB2aWV3LnBhZ2VzQ2FjaGUgPSB7fTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTdG9yZSBWaWV3IGluIGVsZW1lbnQgZm9yIGVhc3kgYWNjZXNzXG4gICAgICAgICAgICBjb250YWluZXJbMF0uZjdWaWV3ID0gdmlldztcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQYWdlc1xuICAgICAgICAgICAgdmlldy5wYWdlc0NvbnRhaW5lciA9IGNvbnRhaW5lci5maW5kKCcucGFnZXMnKVswXTtcbiAgICAgICAgICAgIHZpZXcuaW5pdGlhbFBhZ2VzID0gW107XG4gICAgICAgICAgICB2aWV3LmluaXRpYWxQYWdlc1VybCA9IFtdO1xuICAgICAgICAgICAgdmlldy5pbml0aWFsTmF2YmFycyA9IFtdO1xuICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgdmFyIGluaXRpYWxQYWdlcyA9IGNvbnRhaW5lci5maW5kKCcucGFnZScpO1xuICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBpbml0aWFsUGFnZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5pbml0aWFsUGFnZXMucHVzaChpbml0aWFsUGFnZXNbaV0pO1xuICAgICAgICAgICAgICAgICAgICB2aWV3LmluaXRpYWxQYWdlc1VybC5wdXNoKCcjJyArIGluaXRpYWxQYWdlcy5lcShpKS5hdHRyKCdkYXRhLXBhZ2UnKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5keW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpbml0aWFsTmF2YmFycyA9IGNvbnRhaW5lci5maW5kKCcubmF2YmFyLWlubmVyJyk7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBpbml0aWFsTmF2YmFycy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmlldy5pbml0aWFsTmF2YmFycy5wdXNoKGluaXRpYWxOYXZiYXJzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIExvY2F0aW9uXG4gICAgICAgICAgICB2YXIgZG9jTG9jYXRpb24gPSBkb2N1bWVudC5sb2NhdGlvbi5ocmVmO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEhpc3RvcnlcbiAgICAgICAgICAgIHZpZXcuaGlzdG9yeSA9IFtdO1xuICAgICAgICAgICAgdmFyIHZpZXdVUkwgPSBkb2NMb2NhdGlvbjtcbiAgICAgICAgICAgIHZhciBwdXNoU3RhdGVTZXBhcmF0b3IgPSBhcHAucGFyYW1zLnB1c2hTdGF0ZVNlcGFyYXRvcjtcbiAgICAgICAgICAgIHZhciBwdXNoU3RhdGVSb290ID0gYXBwLnBhcmFtcy5wdXNoU3RhdGVSb290O1xuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMucHVzaFN0YXRlICYmIHZpZXcubWFpbikge1xuICAgICAgICAgICAgICAgIGlmIChwdXNoU3RhdGVSb290KSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXdVUkwgPSBwdXNoU3RhdGVSb290O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXdVUkwuaW5kZXhPZihwdXNoU3RhdGVTZXBhcmF0b3IpID49IDAgJiYgdmlld1VSTC5pbmRleE9mKHB1c2hTdGF0ZVNlcGFyYXRvciArICcjJykgPCAwKSB2aWV3VVJMID0gdmlld1VSTC5zcGxpdChwdXNoU3RhdGVTZXBhcmF0b3IpWzBdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQWN0aXZlIFBhZ2VcbiAgICAgICAgICAgIHZhciBjdXJyZW50UGFnZSwgY3VycmVudFBhZ2VEYXRhO1xuICAgICAgICAgICAgaWYgKCF2aWV3LmFjdGl2ZVBhZ2UpIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50UGFnZSA9ICQodmlldy5wYWdlc0NvbnRhaW5lcikuZmluZCgnLnBhZ2Utb24tY2VudGVyJyk7XG4gICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRQYWdlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGFnZSA9ICQodmlldy5wYWdlc0NvbnRhaW5lcikuZmluZCgnLnBhZ2U6bm90KC5jYWNoZWQpJyk7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQYWdlID0gY3VycmVudFBhZ2UuZXEoY3VycmVudFBhZ2UubGVuZ3RoIC0gMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjdXJyZW50UGFnZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQYWdlRGF0YSA9IGN1cnJlbnRQYWdlWzBdLmY3UGFnZURhdGE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFZpZXcgc3RhcnR1cCBVUkxcbiAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5kb21DYWNoZSAmJiBjdXJyZW50UGFnZSkge1xuICAgICAgICAgICAgICAgIHZpZXcudXJsID0gY29udGFpbmVyLmF0dHIoJ2RhdGEtdXJsJykgfHwgdmlldy5wYXJhbXMudXJsIHx8ICcjJyArIGN1cnJlbnRQYWdlLmF0dHIoJ2RhdGEtcGFnZScpOyAgIFxuICAgICAgICAgICAgICAgIHZpZXcucGFnZXNDYWNoZVt2aWV3LnVybF0gPSBjdXJyZW50UGFnZS5hdHRyKCdkYXRhLXBhZ2UnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Ugdmlldy51cmwgPSBjb250YWluZXIuYXR0cignZGF0YS11cmwnKSB8fCB2aWV3LnBhcmFtcy51cmwgfHwgdmlld1VSTDtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBVcGRhdGUgY3VycmVudCBwYWdlIERhdGFcbiAgICAgICAgICAgIGlmIChjdXJyZW50UGFnZURhdGEpIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50UGFnZURhdGEudmlldyA9IHZpZXc7XG4gICAgICAgICAgICAgICAgY3VycmVudFBhZ2VEYXRhLnVybCA9IHZpZXcudXJsO1xuICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5kb21DYWNoZSAmJiB2aWV3LnBhcmFtcy5keW5hbWljTmF2YmFyICYmICFjdXJyZW50UGFnZURhdGEubmF2YmFySW5uZXJDb250YWluZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBhZ2VEYXRhLm5hdmJhcklubmVyQ29udGFpbmVyID0gdmlldy5pbml0aWFsTmF2YmFyc1t2aWV3LmluaXRpYWxQYWdlcy5pbmRleE9mKGN1cnJlbnRQYWdlRGF0YS5jb250YWluZXIpXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmlldy5hY3RpdmVQYWdlID0gY3VycmVudFBhZ2VEYXRhO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRQYWdlWzBdLmY3UGFnZURhdGEgPSBjdXJyZW50UGFnZURhdGE7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU3RvcmUgdG8gaGlzdG9yeSBtYWluIHZpZXcncyB1cmxcbiAgICAgICAgICAgIGlmICh2aWV3LnVybCkge1xuICAgICAgICAgICAgICAgIHZpZXcuaGlzdG9yeS5wdXNoKHZpZXcudXJsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBUb3VjaCBldmVudHNcbiAgICAgICAgICAgIHZhciBpc1RvdWNoZWQgPSBmYWxzZSxcbiAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2UsXG4gICAgICAgICAgICAgICAgdG91Y2hlc1N0YXJ0ID0ge30sXG4gICAgICAgICAgICAgICAgaXNTY3JvbGxpbmcsXG4gICAgICAgICAgICAgICAgYWN0aXZlUGFnZSA9IFtdLFxuICAgICAgICAgICAgICAgIHByZXZpb3VzUGFnZSA9IFtdLFxuICAgICAgICAgICAgICAgIHZpZXdDb250YWluZXJXaWR0aCxcbiAgICAgICAgICAgICAgICB0b3VjaGVzRGlmZixcbiAgICAgICAgICAgICAgICBhbGxvd1ZpZXdUb3VjaE1vdmUgPSB0cnVlLFxuICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRUaW1lLFxuICAgICAgICAgICAgICAgIGFjdGl2ZU5hdmJhciA9IFtdLFxuICAgICAgICAgICAgICAgIHByZXZpb3VzTmF2YmFyID0gW10sXG4gICAgICAgICAgICAgICAgYWN0aXZlTmF2RWxlbWVudHMsXG4gICAgICAgICAgICAgICAgcHJldmlvdXNOYXZFbGVtZW50cyxcbiAgICAgICAgICAgICAgICBhY3RpdmVOYXZCYWNrSWNvbixcbiAgICAgICAgICAgICAgICBwcmV2aW91c05hdkJhY2tJY29uLFxuICAgICAgICAgICAgICAgIGR5bmFtaWNOYXZiYXIsXG4gICAgICAgICAgICAgICAgcGFnZVNoYWRvdyxcbiAgICAgICAgICAgICAgICBlbDtcbiAgICAgICAgXG4gICAgICAgICAgICB2aWV3LmhhbmRsZVRvdWNoU3RhcnQgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGlmICghYWxsb3dWaWV3VG91Y2hNb3ZlIHx8ICF2aWV3LnBhcmFtcy5zd2lwZUJhY2tQYWdlIHx8IGlzVG91Y2hlZCB8fCBhcHAuc3dpcGVvdXRPcGVuZWRFbCB8fCAhdmlldy5hbGxvd1BhZ2VDaGFuZ2UpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpc1Njcm9sbGluZyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB0b3VjaGVzU3RhcnQueCA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZS5wYWdlWDtcbiAgICAgICAgICAgICAgICB0b3VjaGVzU3RhcnQueSA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICB0b3VjaFN0YXJ0VGltZSA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgZHluYW1pY05hdmJhciA9IHZpZXcucGFyYW1zLmR5bmFtaWNOYXZiYXIgJiYgY29udGFpbmVyLmZpbmQoJy5uYXZiYXItaW5uZXInKS5sZW5ndGggPiAxO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICB2aWV3LmhhbmRsZVRvdWNoTW92ZSA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFpc1RvdWNoZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgcGFnZVggPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZS5wYWdlWDtcbiAgICAgICAgICAgICAgICB2YXIgcGFnZVkgPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGlzU2Nyb2xsaW5nID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBpc1Njcm9sbGluZyA9ICEhKGlzU2Nyb2xsaW5nIHx8IE1hdGguYWJzKHBhZ2VZIC0gdG91Y2hlc1N0YXJ0LnkpID4gTWF0aC5hYnMocGFnZVggLSB0b3VjaGVzU3RhcnQueCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaXNTY3JvbGxpbmcgfHwgZS5mN1ByZXZlbnRTd2lwZUJhY2sgfHwgYXBwLnByZXZlbnRTd2lwZUJhY2spIHtcbiAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjYW5jZWwgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsYyB2YWx1ZXMgZHVyaW5nIGZpcnN0IG1vdmUgZmlyZWRcbiAgICAgICAgICAgICAgICAgICAgdmlld0NvbnRhaW5lcldpZHRoID0gY29udGFpbmVyLndpZHRoKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSAkKGUudGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN3aXBlb3V0ID0gdGFyZ2V0Lmhhc0NsYXNzKCdzd2lwZW91dCcpID8gdGFyZ2V0IDogdGFyZ2V0LnBhcmVudHMoJy5zd2lwZW91dCcpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3dpcGVvdXQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFhcHAucnRsICYmIHN3aXBlb3V0LmZpbmQoJy5zd2lwZW91dC1hY3Rpb25zLWxlZnQnKS5sZW5ndGggPiAwKSBjYW5jZWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5ydGwgJiYgc3dpcGVvdXQuZmluZCgnLnN3aXBlb3V0LWFjdGlvbnMtcmlnaHQnKS5sZW5ndGggPiAwKSBjYW5jZWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGFjdGl2ZVBhZ2UgPSB0YXJnZXQuaXMoJy5wYWdlJykgPyB0YXJnZXQgOiB0YXJnZXQucGFyZW50cygnLnBhZ2UnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGl2ZVBhZ2UuaGFzQ2xhc3MoJ25vLXN3aXBlYmFjaycpKSBjYW5jZWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1BhZ2UgPSBjb250YWluZXIuZmluZCgnLnBhZ2Utb24tbGVmdDpub3QoLmNhY2hlZCknKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5vdEZyb21Cb3JkZXIgPSB0b3VjaGVzU3RhcnQueCAtIGNvbnRhaW5lci5vZmZzZXQoKS5sZWZ0ID4gdmlldy5wYXJhbXMuc3dpcGVCYWNrUGFnZUFjdGl2ZUFyZWE7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHAucnRsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBub3RGcm9tQm9yZGVyID0gdG91Y2hlc1N0YXJ0LnggPCBjb250YWluZXIub2Zmc2V0KCkubGVmdCAtIGNvbnRhaW5lclswXS5zY3JvbGxMZWZ0ICsgdmlld0NvbnRhaW5lcldpZHRoIC0gdmlldy5wYXJhbXMuc3dpcGVCYWNrUGFnZUFjdGl2ZUFyZWE7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBub3RGcm9tQm9yZGVyID0gdG91Y2hlc1N0YXJ0LnggLSBjb250YWluZXIub2Zmc2V0KCkubGVmdCA+IHZpZXcucGFyYW1zLnN3aXBlQmFja1BhZ2VBY3RpdmVBcmVhO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChub3RGcm9tQm9yZGVyKSBjYW5jZWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNQYWdlLmxlbmd0aCA9PT0gMCB8fCBhY3RpdmVQYWdlLmxlbmd0aCA9PT0gMCkgY2FuY2VsID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbmNlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5zd2lwZUJhY2tQYWdlQW5pbWF0ZVNoYWRvdyAmJiAhYXBwLmRldmljZS5hbmRyb2lkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlU2hhZG93ID0gYWN0aXZlUGFnZS5maW5kKCcuc3dpcGViYWNrLXBhZ2Utc2hhZG93Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFnZVNoYWRvdy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlU2hhZG93ID0gJCgnPGRpdiBjbGFzcz1cInN3aXBlYmFjay1wYWdlLXNoYWRvd1wiPjwvZGl2PicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZVBhZ2UuYXBwZW5kKHBhZ2VTaGFkb3cpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlTmF2YmFyID0gY29udGFpbmVyLmZpbmQoJy5uYXZiYXItb24tY2VudGVyOm5vdCguY2FjaGVkKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNOYXZiYXIgPSBjb250YWluZXIuZmluZCgnLm5hdmJhci1vbi1sZWZ0Om5vdCguY2FjaGVkKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlTmF2RWxlbWVudHMgPSBhY3RpdmVOYXZiYXIuZmluZCgnLmxlZnQsIC5jZW50ZXIsIC5yaWdodCwgLnN1Ym5hdmJhciwgLmZhZGluZycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNOYXZFbGVtZW50cyA9IHByZXZpb3VzTmF2YmFyLmZpbmQoJy5sZWZ0LCAuY2VudGVyLCAucmlnaHQsIC5zdWJuYXZiYXIsIC5mYWRpbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmFuaW1hdGVOYXZCYWNrSWNvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZU5hdkJhY2tJY29uID0gYWN0aXZlTmF2YmFyLmZpbmQoJy5sZWZ0LnNsaWRpbmcgLmJhY2sgLmljb24nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05hdkJhY2tJY29uID0gcHJldmlvdXNOYXZiYXIuZmluZCgnLmxlZnQuc2xpZGluZyAuYmFjayAuaWNvbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBDbG9zZS9IaWRlIEFueSBQaWNrZXJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQoJy5waWNrZXItbW9kYWwubW9kYWwtaW4nKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbCgkKCcucGlja2VyLW1vZGFsLm1vZGFsLWluJykpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGUuZjdQcmV2ZW50UGFuZWxTd2lwZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgaXNNb3ZlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBSVEwgaW52ZXJ0ZXJcbiAgICAgICAgICAgICAgICB2YXIgaW52ZXJ0ZXIgPSBhcHAucnRsID8gLTEgOiAxO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBUb3VjaGVzIGRpZmZcbiAgICAgICAgICAgICAgICB0b3VjaGVzRGlmZiA9IChwYWdlWCAtIHRvdWNoZXNTdGFydC54IC0gdmlldy5wYXJhbXMuc3dpcGVCYWNrUGFnZVRocmVzaG9sZCkgKiBpbnZlcnRlcjtcbiAgICAgICAgICAgICAgICBpZiAodG91Y2hlc0RpZmYgPCAwKSB0b3VjaGVzRGlmZiA9IDA7XG4gICAgICAgICAgICAgICAgdmFyIHBlcmNlbnRhZ2UgPSB0b3VjaGVzRGlmZiAvIHZpZXdDb250YWluZXJXaWR0aDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gU3dpcGUgQmFjayBDYWxsYmFja1xuICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja0RhdGEgPSB7XG4gICAgICAgICAgICAgICAgICAgIHBlcmNlbnRhZ2U6IHBlcmNlbnRhZ2UsXG4gICAgICAgICAgICAgICAgICAgIGFjdGl2ZVBhZ2U6IGFjdGl2ZVBhZ2VbMF0sXG4gICAgICAgICAgICAgICAgICAgIHByZXZpb3VzUGFnZTogcHJldmlvdXNQYWdlWzBdLFxuICAgICAgICAgICAgICAgICAgICBhY3RpdmVOYXZiYXI6IGFjdGl2ZU5hdmJhclswXSxcbiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNOYXZiYXI6IHByZXZpb3VzTmF2YmFyWzBdXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMub25Td2lwZUJhY2tNb3ZlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcucGFyYW1zLm9uU3dpcGVCYWNrTW92ZShjYWxsYmFja0RhdGEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb250YWluZXIudHJpZ2dlcignc3dpcGVCYWNrTW92ZScsIGNhbGxiYWNrRGF0YSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFRyYW5zZm9ybSBwYWdlc1xuICAgICAgICAgICAgICAgIHZhciBhY3RpdmVQYWdlVHJhbnNsYXRlID0gdG91Y2hlc0RpZmYgKiBpbnZlcnRlcjtcbiAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNQYWdlVHJhbnNsYXRlID0gKHRvdWNoZXNEaWZmIC8gNSAtIHZpZXdDb250YWluZXJXaWR0aCAvIDUpICogaW52ZXJ0ZXI7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UucGl4ZWxSYXRpbyA9PT0gMSkge1xuICAgICAgICAgICAgICAgICAgICBhY3RpdmVQYWdlVHJhbnNsYXRlID0gTWF0aC5yb3VuZChhY3RpdmVQYWdlVHJhbnNsYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNQYWdlVHJhbnNsYXRlID0gTWF0aC5yb3VuZChwcmV2aW91c1BhZ2VUcmFuc2xhdGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgYWN0aXZlUGFnZS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyBhY3RpdmVQYWdlVHJhbnNsYXRlICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuc3dpcGVCYWNrUGFnZUFuaW1hdGVTaGFkb3cgJiYgIWFwcC5kZXZpY2UuYW5kcm9pZCkgcGFnZVNoYWRvd1swXS5zdHlsZS5vcGFjaXR5ID0gMSAtIDEgKiBwZXJjZW50YWdlO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBwcmV2aW91c1BhZ2UudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgcHJldmlvdXNQYWdlVHJhbnNsYXRlICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuc3dpcGVCYWNrUGFnZUFuaW1hdGVPcGFjaXR5KSBwcmV2aW91c1BhZ2VbMF0uc3R5bGUub3BhY2l0eSA9IDAuOSArIDAuMSAqIHBlcmNlbnRhZ2U7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgTmF2YmFycyBBbmltYXRpb25cbiAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaTtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGFjdGl2ZU5hdkVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbCA9ICQoYWN0aXZlTmF2RWxlbWVudHNbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlbC5pcygnLnN1Ym5hdmJhci5zbGlkaW5nJykpIGVsWzBdLnN0eWxlLm9wYWNpdHkgPSAoMSAtIHBlcmNlbnRhZ2UgKiAxLjMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCdzbGlkaW5nJykgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhY3RpdmVOYXZUcmFuc2xhdGUgPSBwZXJjZW50YWdlICogZWxbMF0uZjdOYXZiYXJSaWdodE9mZnNldDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5waXhlbFJhdGlvID09PSAxKSBhY3RpdmVOYXZUcmFuc2xhdGUgPSBNYXRoLnJvdW5kKGFjdGl2ZU5hdlRyYW5zbGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgYWN0aXZlTmF2VHJhbnNsYXRlICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hbmltYXRlTmF2QmFja0ljb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCdsZWZ0JykgPj0gMCAmJiBhY3RpdmVOYXZCYWNrSWNvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVOYXZCYWNrSWNvbi50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAtYWN0aXZlTmF2VHJhbnNsYXRlICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHJldmlvdXNOYXZFbGVtZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWwgPSAkKHByZXZpb3VzTmF2RWxlbWVudHNbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFlbC5pcygnLnN1Ym5hdmJhci5zbGlkaW5nJykpIGVsWzBdLnN0eWxlLm9wYWNpdHkgPSBwZXJjZW50YWdlICogMS4zIC0gMC4zO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCdzbGlkaW5nJykgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c05hdlRyYW5zbGF0ZSA9IGVsWzBdLmY3TmF2YmFyTGVmdE9mZnNldCAqICgxIC0gcGVyY2VudGFnZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UucGl4ZWxSYXRpbyA9PT0gMSkgcHJldmlvdXNOYXZUcmFuc2xhdGUgPSBNYXRoLnJvdW5kKHByZXZpb3VzTmF2VHJhbnNsYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyBwcmV2aW91c05hdlRyYW5zbGF0ZSArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuYW5pbWF0ZU5hdkJhY2tJY29uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbFswXS5jbGFzc05hbWUuaW5kZXhPZignbGVmdCcpID49IDAgJiYgcHJldmlvdXNOYXZCYWNrSWNvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05hdkJhY2tJY29uLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIC1wcmV2aW91c05hdlRyYW5zbGF0ZSArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIHZpZXcuaGFuZGxlVG91Y2hFbmQgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGlmICghaXNUb3VjaGVkIHx8ICFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmICh0b3VjaGVzRGlmZiA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAkKFthY3RpdmVQYWdlWzBdLCBwcmV2aW91c1BhZ2VbMF1dKS50cmFuc2Zvcm0oJycpLmNzcyh7b3BhY2l0eTogJycsIGJveFNoYWRvdzogJyd9KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZU5hdkVsZW1lbnRzLnRyYW5zZm9ybSgnJykuY3NzKHtvcGFjaXR5OiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNOYXZFbGVtZW50cy50cmFuc2Zvcm0oJycpLmNzcyh7b3BhY2l0eTogJyd9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhY3RpdmVOYXZCYWNrSWNvbiAmJiBhY3RpdmVOYXZCYWNrSWNvbi5sZW5ndGggPiAwKSBhY3RpdmVOYXZCYWNrSWNvbi50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmF2QmFja0ljb24gJiYgYWN0aXZlTmF2QmFja0ljb24ubGVuZ3RoID4gMCkgcHJldmlvdXNOYXZCYWNrSWNvbi50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHRpbWVEaWZmID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKSAtIHRvdWNoU3RhcnRUaW1lO1xuICAgICAgICAgICAgICAgIHZhciBwYWdlQ2hhbmdlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIC8vIFN3aXBlIGJhY2sgdG8gcHJldmlvdXMgcGFnZVxuICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVEaWZmIDwgMzAwICYmIHRvdWNoZXNEaWZmID4gMTAgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVEaWZmID49IDMwMCAmJiB0b3VjaGVzRGlmZiA+IHZpZXdDb250YWluZXJXaWR0aCAvIDJcbiAgICAgICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgIGFjdGl2ZVBhZ2UucmVtb3ZlQ2xhc3MoJ3BhZ2Utb24tY2VudGVyJykuYWRkQ2xhc3MoJ3BhZ2Utb24tcmlnaHQnKTtcbiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNQYWdlLnJlbW92ZUNsYXNzKCdwYWdlLW9uLWxlZnQnKS5hZGRDbGFzcygncGFnZS1vbi1jZW50ZXInKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZU5hdmJhci5yZW1vdmVDbGFzcygnbmF2YmFyLW9uLWNlbnRlcicpLmFkZENsYXNzKCduYXZiYXItb24tcmlnaHQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmF2YmFyLnJlbW92ZUNsYXNzKCduYXZiYXItb24tbGVmdCcpLmFkZENsYXNzKCduYXZiYXItb24tY2VudGVyJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcGFnZUNoYW5nZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBSZXNldCBjdXN0b20gc3R5bGVzXG4gICAgICAgICAgICAgICAgLy8gQWRkIHRyYW5zaXRpb25pbmcgY2xhc3MgZm9yIHRyYW5zaXRpb24tZHVyYXRpb25cbiAgICAgICAgICAgICAgICAkKFthY3RpdmVQYWdlWzBdLCBwcmV2aW91c1BhZ2VbMF1dKS50cmFuc2Zvcm0oJycpLmNzcyh7b3BhY2l0eTogJycsIGJveFNoYWRvdzogJyd9KS5hZGRDbGFzcygncGFnZS10cmFuc2l0aW9uaW5nJyk7XG4gICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZlTmF2RWxlbWVudHMuY3NzKHtvcGFjaXR5OiAnJ30pXG4gICAgICAgICAgICAgICAgICAgIC5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2xhdGUgPSBwYWdlQ2hhbmdlZCA/IHRoaXMuZjdOYXZiYXJSaWdodE9mZnNldCA6IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGluZyA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzbGlkaW5nLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHRyYW5zbGF0ZSArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hbmltYXRlTmF2QmFja0ljb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2xpZGluZy5oYXNDbGFzcygnbGVmdCcpICYmIGFjdGl2ZU5hdkJhY2tJY29uLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlTmF2QmFja0ljb24uYWRkQ2xhc3MoJ3BhZ2UtdHJhbnNpdGlvbmluZycpLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIC10cmFuc2xhdGUgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH0pLmFkZENsYXNzKCdwYWdlLXRyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmF2RWxlbWVudHMudHJhbnNmb3JtKCcnKS5jc3Moe29wYWNpdHk6ICcnfSkuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHJhbnNsYXRlID0gcGFnZUNoYW5nZWQgPyAwIDogdGhpcy5mN05hdmJhckxlZnRPZmZzZXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGluZyA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzbGlkaW5nLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHRyYW5zbGF0ZSArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hbmltYXRlTmF2QmFja0ljb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2xpZGluZy5oYXNDbGFzcygnbGVmdCcpICYmIHByZXZpb3VzTmF2QmFja0ljb24ubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05hdkJhY2tJY29uLmFkZENsYXNzKCdwYWdlLXRyYW5zaXRpb25pbmcnKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAtdHJhbnNsYXRlICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pLmFkZENsYXNzKCdwYWdlLXRyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYWxsb3dWaWV3VG91Y2hNb3ZlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAvLyBTd2lwZSBCYWNrIENhbGxiYWNrXG4gICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrRGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZlUGFnZTogYWN0aXZlUGFnZVswXSxcbiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNQYWdlOiBwcmV2aW91c1BhZ2VbMF0sXG4gICAgICAgICAgICAgICAgICAgIGFjdGl2ZU5hdmJhcjogYWN0aXZlTmF2YmFyWzBdLFxuICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05hdmJhcjogcHJldmlvdXNOYXZiYXJbMF1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGlmIChwYWdlQ2hhbmdlZCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVmlldydzIFVSTFxuICAgICAgICAgICAgICAgICAgICB2YXIgdXJsID0gdmlldy5oaXN0b3J5W3ZpZXcuaGlzdG9yeS5sZW5ndGggLSAyXTtcbiAgICAgICAgICAgICAgICAgICAgdmlldy51cmwgPSB1cmw7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBQYWdlIGJlZm9yZSBhbmltYXRpb24gY2FsbGJhY2tcbiAgICAgICAgICAgICAgICAgICAgYXBwLnBhZ2VCYWNrQ2FsbGJhY2soJ2JlZm9yZScsIHZpZXcsIHtwYWdlQ29udGFpbmVyOiBhY3RpdmVQYWdlWzBdLCB1cmw6IHVybCwgcG9zaXRpb246ICdjZW50ZXInLCBuZXdQYWdlOiBwcmV2aW91c1BhZ2UsIG9sZFBhZ2U6IGFjdGl2ZVBhZ2UsIHN3aXBlQmFjazogdHJ1ZX0pO1xuICAgICAgICAgICAgICAgICAgICBhcHAucGFnZUFuaW1DYWxsYmFjaygnYmVmb3JlJywgdmlldywge3BhZ2VDb250YWluZXI6IHByZXZpb3VzUGFnZVswXSwgdXJsOiB1cmwsIHBvc2l0aW9uOiAnbGVmdCcsIG5ld1BhZ2U6IHByZXZpb3VzUGFnZSwgb2xkUGFnZTogYWN0aXZlUGFnZSwgc3dpcGVCYWNrOiB0cnVlfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMub25Td2lwZUJhY2tCZWZvcmVDaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZpZXcucGFyYW1zLm9uU3dpcGVCYWNrQmVmb3JlQ2hhbmdlKGNhbGxiYWNrRGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnRyaWdnZXIoJ3N3aXBlQmFja0JlZm9yZUNoYW5nZScsIGNhbGxiYWNrRGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMub25Td2lwZUJhY2tCZWZvcmVSZXNldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmlldy5wYXJhbXMub25Td2lwZUJhY2tCZWZvcmVSZXNldChjYWxsYmFja0RhdGEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci50cmlnZ2VyKCdzd2lwZUJhY2tCZWZvcmVSZXNldCcsIGNhbGxiYWNrRGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBhY3RpdmVQYWdlLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAkKFthY3RpdmVQYWdlWzBdLCBwcmV2aW91c1BhZ2VbMF1dKS5yZW1vdmVDbGFzcygncGFnZS10cmFuc2l0aW9uaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVOYXZFbGVtZW50cy5yZW1vdmVDbGFzcygncGFnZS10cmFuc2l0aW9uaW5nJykuY3NzKHtvcGFjaXR5OiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNOYXZFbGVtZW50cy5yZW1vdmVDbGFzcygncGFnZS10cmFuc2l0aW9uaW5nJykuY3NzKHtvcGFjaXR5OiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGl2ZU5hdkJhY2tJY29uICYmIGFjdGl2ZU5hdkJhY2tJY29uLmxlbmd0aCA+IDApIGFjdGl2ZU5hdkJhY2tJY29uLnJlbW92ZUNsYXNzKCdwYWdlLXRyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05hdkJhY2tJY29uICYmIHByZXZpb3VzTmF2QmFja0ljb24ubGVuZ3RoID4gMCkgcHJldmlvdXNOYXZCYWNrSWNvbi5yZW1vdmVDbGFzcygncGFnZS10cmFuc2l0aW9uaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYWxsb3dWaWV3VG91Y2hNb3ZlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFnZUNoYW5nZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnB1c2hTdGF0ZSAmJiB2aWV3Lm1haW4pIGhpc3RvcnkuYmFjaygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUGFnZSBhZnRlciBhbmltYXRpb24gY2FsbGJhY2tcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5wYWdlQmFja0NhbGxiYWNrKCdhZnRlcicsIHZpZXcsIHtwYWdlQ29udGFpbmVyOiBhY3RpdmVQYWdlWzBdLCB1cmw6IHVybCwgcG9zaXRpb246ICdjZW50ZXInLCBuZXdQYWdlOiBwcmV2aW91c1BhZ2UsIG9sZFBhZ2U6IGFjdGl2ZVBhZ2UsIHN3aXBlQmFjazogdHJ1ZX0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnBhZ2VBbmltQ2FsbGJhY2soJ2FmdGVyJywgdmlldywge3BhZ2VDb250YWluZXI6IHByZXZpb3VzUGFnZVswXSwgdXJsOiB1cmwsIHBvc2l0aW9uOiAnbGVmdCcsIG5ld1BhZ2U6IHByZXZpb3VzUGFnZSwgb2xkUGFnZTogYWN0aXZlUGFnZSwgc3dpcGVCYWNrOiB0cnVlfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLmFmdGVyQmFjayh2aWV3LCBhY3RpdmVQYWdlLCBwcmV2aW91c1BhZ2UpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5vblN3aXBlQmFja0FmdGVyQ2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlldy5wYXJhbXMub25Td2lwZUJhY2tBZnRlckNoYW5nZShjYWxsYmFja0RhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnRyaWdnZXIoJ3N3aXBlQmFja0FmdGVyQ2hhbmdlJywgY2FsbGJhY2tEYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5vblN3aXBlQmFja0FmdGVyUmVzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWV3LnBhcmFtcy5vblN3aXBlQmFja0FmdGVyUmVzZXQoY2FsbGJhY2tEYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci50cmlnZ2VyKCdzd2lwZUJhY2tBZnRlclJlc2V0JywgY2FsbGJhY2tEYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAocGFnZVNoYWRvdyAmJiBwYWdlU2hhZG93Lmxlbmd0aCA+IDApIHBhZ2VTaGFkb3cucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdmlldy5hdHRhY2hFdmVudHMgPSBmdW5jdGlvbiAoZGV0YWNoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IGRldGFjaCA/ICdvZmYnIDogJ29uJztcbiAgICAgICAgICAgICAgICBjb250YWluZXJbYWN0aW9uXShhcHAudG91Y2hFdmVudHMuc3RhcnQsIHZpZXcuaGFuZGxlVG91Y2hTdGFydCk7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyW2FjdGlvbl0oYXBwLnRvdWNoRXZlbnRzLm1vdmUsIHZpZXcuaGFuZGxlVG91Y2hNb3ZlKTtcbiAgICAgICAgICAgICAgICBjb250YWluZXJbYWN0aW9uXShhcHAudG91Y2hFdmVudHMuZW5kLCB2aWV3LmhhbmRsZVRvdWNoRW5kKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB2aWV3LmRldGFjaEV2ZW50cyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2aWV3LmF0dGFjaEV2ZW50cyh0cnVlKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdFxuICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLnN3aXBlQmFja1BhZ2UgJiYgIWFwcC5wYXJhbXMubWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgICB2aWV3LmF0dGFjaEV2ZW50cygpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIEFkZCB2aWV3IHRvIGFwcFxuICAgICAgICAgICAgYXBwLnZpZXdzLnB1c2godmlldyk7XG4gICAgICAgICAgICBpZiAodmlldy5tYWluKSBhcHAubWFpblZpZXcgPSB2aWV3O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFJvdXRlciBcbiAgICAgICAgICAgIHZpZXcucm91dGVyID0ge1xuICAgICAgICAgICAgICAgIGxvYWQ6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhcHAucm91dGVyLmxvYWQodmlldywgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBiYWNrOiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXBwLnJvdXRlci5iYWNrKHZpZXcsIG9wdGlvbnMpOyAgXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAvLyBTaG9ydGN1dHNcbiAgICAgICAgICAgICAgICBsb2FkUGFnZTogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1cmwgPSBvcHRpb25zO1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucyA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVybCAmJiB1cmwuaW5kZXhPZignIycpID09PSAwICYmIHZpZXcucGFyYW1zLmRvbUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5wYWdlTmFtZSA9IHVybC5zcGxpdCgnIycpWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBvcHRpb25zLnVybCA9IHVybDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXBwLnJvdXRlci5sb2FkKHZpZXcsIG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgbG9hZENvbnRlbnQ6IGZ1bmN0aW9uIChjb250ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhcHAucm91dGVyLmxvYWQodmlldywge2NvbnRlbnQ6IGNvbnRlbnR9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHJlbG9hZFBhZ2U6IGZ1bmN0aW9uICh1cmwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFwcC5yb3V0ZXIubG9hZCh2aWV3LCB7dXJsOiB1cmwsIHJlbG9hZDogdHJ1ZX0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcmVsb2FkQ29udGVudDogZnVuY3Rpb24gKGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFwcC5yb3V0ZXIubG9hZCh2aWV3LCB7Y29udGVudDogY29udGVudCwgcmVsb2FkOiB0cnVlfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICByZWxvYWRQcmV2aW91c1BhZ2U6IGZ1bmN0aW9uICh1cmwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFwcC5yb3V0ZXIubG9hZCh2aWV3LCB7dXJsOiB1cmwsIHJlbG9hZFByZXZpb3VzOiB0cnVlLCByZWxvYWQ6IHRydWV9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHJlbG9hZFByZXZpb3VzQ29udGVudDogZnVuY3Rpb24gKGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFwcC5yb3V0ZXIubG9hZCh2aWV3LCB7Y29udGVudDogY29udGVudCwgcmVsb2FkUHJldmlvdXM6IHRydWUsIHJlbG9hZDogdHJ1ZX0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcmVmcmVzaFBhZ2U6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHZpZXcudXJsLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVsb2FkOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWdub3JlQ2FjaGU6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMudXJsICYmIG9wdGlvbnMudXJsLmluZGV4T2YoJyMnKSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlICYmIHZpZXcucGFnZXNDYWNoZVtvcHRpb25zLnVybF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnBhZ2VOYW1lID0gdmlldy5wYWdlc0NhY2hlW29wdGlvbnMudXJsXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnVybCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy51cmw7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh2aWV3LmNvbnRlbnRDYWNoZVtvcHRpb25zLnVybF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmNvbnRlbnQgPSB2aWV3LmNvbnRlbnRDYWNoZVtvcHRpb25zLnVybF07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy51cmwgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMudXJsO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhcHAucm91dGVyLmxvYWQodmlldywgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICByZWZyZXNoUHJldmlvdXNQYWdlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25zID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB2aWV3Lmhpc3Rvcnlbdmlldy5oaXN0b3J5Lmxlbmd0aCAtIDJdLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVsb2FkOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVsb2FkUHJldmlvdXM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBpZ25vcmVDYWNoZTogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy51cmwgJiYgb3B0aW9ucy51cmwuaW5kZXhPZignIycpID09PSAwICYmIHZpZXcucGFyYW1zLmRvbUNhY2hlICYmIHZpZXcucGFnZXNDYWNoZVtvcHRpb25zLnVybF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMucGFnZU5hbWUgPSB2aWV3LnBhZ2VzQ2FjaGVbb3B0aW9ucy51cmxdO1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy51cmwgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy51cmw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFwcC5yb3V0ZXIubG9hZCh2aWV3LCBvcHRpb25zKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEFsaWFzZXMgZm9yIHRlbXBvcmFyeSBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XG4gICAgICAgICAgICB2aWV3LmxvYWRQYWdlID0gdmlldy5yb3V0ZXIubG9hZFBhZ2U7XG4gICAgICAgICAgICB2aWV3LmxvYWRDb250ZW50ID0gdmlldy5yb3V0ZXIubG9hZENvbnRlbnQ7XG4gICAgICAgICAgICB2aWV3LnJlbG9hZFBhZ2UgPSB2aWV3LnJvdXRlci5yZWxvYWRQYWdlO1xuICAgICAgICAgICAgdmlldy5yZWxvYWRDb250ZW50ID0gdmlldy5yb3V0ZXIucmVsb2FkQ29udGVudDtcbiAgICAgICAgICAgIHZpZXcucmVsb2FkUHJldmlvdXNQYWdlID0gdmlldy5yb3V0ZXIucmVsb2FkUHJldmlvdXNQYWdlO1xuICAgICAgICAgICAgdmlldy5yZWxvYWRQcmV2aW91c0NvbnRlbnQgPSB2aWV3LnJvdXRlci5yZWxvYWRQcmV2aW91c0NvbnRlbnQ7XG4gICAgICAgICAgICB2aWV3LnJlZnJlc2hQYWdlID0gdmlldy5yb3V0ZXIucmVmcmVzaFBhZ2U7XG4gICAgICAgICAgICB2aWV3LnJlZnJlc2hQcmV2aW91c1BhZ2UgPSB2aWV3LnJvdXRlci5yZWZyZXNoUHJldmlvdXNQYWdlO1xuICAgICAgICAgICAgdmlldy5iYWNrID0gdmlldy5yb3V0ZXIuYmFjaztcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBCYXJzIG1ldGhvZHNcbiAgICAgICAgICAgIHZpZXcuaGlkZU5hdmJhciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXBwLmhpZGVOYXZiYXIoY29udGFpbmVyLmZpbmQoJy5uYXZiYXInKSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdmlldy5zaG93TmF2YmFyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBhcHAuc2hvd05hdmJhcihjb250YWluZXIuZmluZCgnLm5hdmJhcicpKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB2aWV3LmhpZGVUb29sYmFyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBhcHAuaGlkZVRvb2xiYXIoY29udGFpbmVyLmZpbmQoJy50b29sYmFyJykpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZpZXcuc2hvd1Rvb2xiYXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFwcC5zaG93VG9vbGJhcihjb250YWluZXIuZmluZCgnLnRvb2xiYXInKSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFB1c2ggU3RhdGUgb24gbG9hZFxuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMucHVzaFN0YXRlICYmIGFwcC5wYXJhbXMucHVzaFN0YXRlT25Mb2FkICYmIHZpZXcubWFpbikge1xuICAgICAgICAgICAgICAgIHZhciBwdXNoU3RhdGVVcmw7XG4gICAgICAgICAgICAgICAgdmFyIHB1c2hTdGF0ZVVybFNwbGl0ID0gZG9jTG9jYXRpb24uc3BsaXQocHVzaFN0YXRlU2VwYXJhdG9yKVsxXTtcbiAgICAgICAgICAgICAgICBpZiAocHVzaFN0YXRlUm9vdCkge1xuICAgICAgICAgICAgICAgICAgICBwdXNoU3RhdGVVcmwgPSBkb2NMb2NhdGlvbi5zcGxpdChhcHAucGFyYW1zLnB1c2hTdGF0ZVJvb3QgKyBwdXNoU3RhdGVTZXBhcmF0b3IpWzFdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChwdXNoU3RhdGVTZXBhcmF0b3IgJiYgZG9jTG9jYXRpb24uaW5kZXhPZihwdXNoU3RhdGVTZXBhcmF0b3IpID49IDAgJiYgZG9jTG9jYXRpb24uaW5kZXhPZihwdXNoU3RhdGVTZXBhcmF0b3IgKyAnIycpIDwgMCkge1xuICAgICAgICAgICAgICAgICAgICBwdXNoU3RhdGVVcmwgPSBwdXNoU3RhdGVVcmxTcGxpdDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHB1c2hTdGF0ZUFuaW1hdGVQYWdlcyA9IGFwcC5wYXJhbXMucHVzaFN0YXRlTm9BbmltYXRpb24gPyBmYWxzZSA6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB2YXIgaGlzdG9yeVN0YXRlID0gaGlzdG9yeS5zdGF0ZTtcbiAgICAgICAgICAgICAgICBpZiAocHVzaFN0YXRlVXJsKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwdXNoU3RhdGVVcmwuaW5kZXhPZignIycpID49IDAgJiYgdmlldy5wYXJhbXMuZG9tQ2FjaGUgJiYgaGlzdG9yeVN0YXRlICYmIGhpc3RvcnlTdGF0ZS5wYWdlTmFtZSAmJiAndmlld0luZGV4JyBpbiBoaXN0b3J5U3RhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIubG9hZCh2aWV3LCB7cGFnZU5hbWU6IGhpc3RvcnlTdGF0ZS5wYWdlTmFtZSwgdXJsOiBoaXN0b3J5U3RhdGUudXJsLCBhbmltYXRlUGFnZXM6IHB1c2hTdGF0ZUFuaW1hdGVQYWdlcywgcHVzaFN0YXRlOiBmYWxzZX0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHB1c2hTdGF0ZVVybC5pbmRleE9mKCcjJykgPj0gMCAmJiB2aWV3LnBhcmFtcy5kb21DYWNoZSAmJiB2aWV3LmluaXRpYWxQYWdlc1VybC5pbmRleE9mKHB1c2hTdGF0ZVVybCkgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci5sb2FkKHZpZXcsIHtwYWdlTmFtZTogcHVzaFN0YXRlVXJsLnJlcGxhY2UoJyMnLCcnKSwgYW5pbWF0ZVBhZ2VzOiBwdXNoU3RhdGVBbmltYXRlUGFnZXMsIHB1c2hTdGF0ZTogZmFsc2V9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGFwcC5yb3V0ZXIubG9hZCh2aWV3LCB7dXJsOiBwdXNoU3RhdGVVcmwsIGFuaW1hdGVQYWdlczogcHVzaFN0YXRlQW5pbWF0ZVBhZ2VzLCBwdXNoU3RhdGU6IGZhbHNlfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlICYmIGRvY0xvY2F0aW9uLmluZGV4T2YocHVzaFN0YXRlU2VwYXJhdG9yICsgJyMnKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChoaXN0b3J5U3RhdGUgJiYgaGlzdG9yeVN0YXRlLnBhZ2VOYW1lICYmICd2aWV3SW5kZXgnIGluIGhpc3RvcnlTdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci5sb2FkKHZpZXcsIHtwYWdlTmFtZTogaGlzdG9yeVN0YXRlLnBhZ2VOYW1lLCB1cmw6IGhpc3RvcnlTdGF0ZS51cmwsIGFuaW1hdGVQYWdlczogcHVzaFN0YXRlQW5pbWF0ZVBhZ2VzLCBwdXNoU3RhdGU6IGZhbHNlfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocHVzaFN0YXRlU2VwYXJhdG9yICYmIHB1c2hTdGF0ZVVybFNwbGl0LmluZGV4T2YoJyMnKSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcuaW5pdGlhbFBhZ2VzVXJsLmluZGV4T2YocHVzaFN0YXRlVXJsU3BsaXQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci5sb2FkKHZpZXcsIHtwYWdlTmFtZTogcHVzaFN0YXRlVXJsU3BsaXQucmVwbGFjZSgnIycsICcnKSwgYW5pbWF0ZVBhZ2VzOiBwdXNoU3RhdGVBbmltYXRlUGFnZXMsIHB1c2hTdGF0ZTogZmFsc2V9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBEZXN0cm95XG4gICAgICAgICAgICB2aWV3LmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmlldy5kZXRhY2hFdmVudHMoKTtcbiAgICAgICAgICAgICAgICB2aWV3ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQbHVnaW4gaG9va1xuICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ2FkZFZpZXcnLCB2aWV3KTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBSZXR1cm4gdmlld1xuICAgICAgICAgICAgcmV0dXJuIHZpZXc7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBhcHAuYWRkVmlldyA9IGZ1bmN0aW9uIChzZWxlY3RvciwgcGFyYW1zKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFZpZXcoc2VsZWN0b3IsIHBhcmFtcyk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBhcHAuZ2V0Q3VycmVudFZpZXcgPSBmdW5jdGlvbiAoaW5kZXgpIHtcbiAgICAgICAgICAgIHZhciBwb3BvdmVyVmlldyA9ICQoJy5wb3BvdmVyLm1vZGFsLWluIC52aWV3Jyk7XG4gICAgICAgICAgICB2YXIgcG9wdXBWaWV3ID0gJCgnLnBvcHVwLm1vZGFsLWluIC52aWV3Jyk7XG4gICAgICAgICAgICB2YXIgcGFuZWxWaWV3ID0gJCgnLnBhbmVsLmFjdGl2ZSAudmlldycpO1xuICAgICAgICAgICAgdmFyIGFwcFZpZXdzID0gJCgnLnZpZXdzJyk7XG4gICAgICAgICAgICAvLyBGaW5kIGFjdGl2ZSB2aWV3IGFzIHRhYlxuICAgICAgICAgICAgdmFyIGFwcFZpZXcgPSBhcHBWaWV3cy5jaGlsZHJlbignLnZpZXcnKTtcbiAgICAgICAgICAgIC8vIFByb3BhYmx5IGluIHRhYnMgb3Igc3BsaXQgdmlld1xuICAgICAgICAgICAgaWYgKGFwcFZpZXcubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgIGlmIChhcHBWaWV3Lmhhc0NsYXNzKCd0YWInKSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBUYWJzXG4gICAgICAgICAgICAgICAgICAgIGFwcFZpZXcgPSBhcHBWaWV3cy5jaGlsZHJlbignLnZpZXcuYWN0aXZlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBTcGxpdCBWaWV3LCBsZWF2ZSBhcHBWaWV3IGludGFjdFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwb3BvdmVyVmlldy5sZW5ndGggPiAwICYmIHBvcG92ZXJWaWV3WzBdLmY3VmlldykgcmV0dXJuIHBvcG92ZXJWaWV3WzBdLmY3VmlldztcbiAgICAgICAgICAgIGlmIChwb3B1cFZpZXcubGVuZ3RoID4gMCAmJiBwb3B1cFZpZXdbMF0uZjdWaWV3KSByZXR1cm4gcG9wdXBWaWV3WzBdLmY3VmlldztcbiAgICAgICAgICAgIGlmIChwYW5lbFZpZXcubGVuZ3RoID4gMCAmJiBwYW5lbFZpZXdbMF0uZjdWaWV3KSByZXR1cm4gcGFuZWxWaWV3WzBdLmY3VmlldztcbiAgICAgICAgICAgIGlmIChhcHBWaWV3Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBpZiAoYXBwVmlldy5sZW5ndGggPT09IDEgJiYgYXBwVmlld1swXS5mN1ZpZXcpIHJldHVybiBhcHBWaWV3WzBdLmY3VmlldztcbiAgICAgICAgICAgICAgICBpZiAoYXBwVmlldy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50Vmlld3MgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcHBWaWV3Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwVmlld1tpXS5mN1ZpZXcpIGN1cnJlbnRWaWV3cy5wdXNoKGFwcFZpZXdbaV0uZjdWaWV3KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFZpZXdzLmxlbmd0aCA+IDAgJiYgdHlwZW9mIGluZGV4ICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIGN1cnJlbnRWaWV3c1tpbmRleF07XG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Vmlld3MubGVuZ3RoID4gMSkgcmV0dXJuIGN1cnJlbnRWaWV3cztcbiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRWaWV3cy5sZW5ndGggPT09IDEpIHJldHVybiBjdXJyZW50Vmlld3NbMF07XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgfTtcbiAgICAgICAgXG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgTmF2YmFycyAmJiBUb29sYmFycyAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICAvLyBPbiBOYXZiYXIgSW5pdCBDYWxsYmFja1xuICAgICAgICBhcHAubmF2YmFySW5pdENhbGxiYWNrID0gZnVuY3Rpb24gKHZpZXcsIHBhZ2VDb250YWluZXIsIG5hdmJhckNvbnRhaW5lciwgbmF2YmFySW5uZXJDb250YWluZXIpIHtcbiAgICAgICAgICAgIGlmICghbmF2YmFyQ29udGFpbmVyICYmIG5hdmJhcklubmVyQ29udGFpbmVyKSBuYXZiYXJDb250YWluZXIgPSAkKG5hdmJhcklubmVyQ29udGFpbmVyKS5wYXJlbnQoJy5uYXZiYXInKVswXTtcbiAgICAgICAgICAgIGlmIChuYXZiYXJJbm5lckNvbnRhaW5lci5mN05hdmJhckluaXRpYWxpemVkICYmIHZpZXcgJiYgIXZpZXcucGFyYW1zLmRvbUNhY2hlKSByZXR1cm47XG4gICAgICAgICAgICB2YXIgbmF2YmFyRGF0YSA9IHtcbiAgICAgICAgICAgICAgICBjb250YWluZXI6IG5hdmJhckNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICBpbm5lckNvbnRhaW5lcjogbmF2YmFySW5uZXJDb250YWluZXJcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB2YXIgcGFnZURhdGEgPSBwYWdlQ29udGFpbmVyICYmIHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgZXZlbnREYXRhID0ge1xuICAgICAgICAgICAgICAgIHBhZ2U6IHBhZ2VEYXRhLFxuICAgICAgICAgICAgICAgIG5hdmJhcjogbmF2YmFyRGF0YVxuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAobmF2YmFySW5uZXJDb250YWluZXIuZjdOYXZiYXJJbml0aWFsaXplZCAmJiAoKHZpZXcgJiYgdmlldy5wYXJhbXMuZG9tQ2FjaGUpIHx8ICghdmlldyAmJiAkKG5hdmJhckNvbnRhaW5lcikucGFyZW50cygnLnBvcHVwLCAucG9wb3ZlciwgLmxvZ2luLXNjcmVlbiwgLm1vZGFsLCAuYWN0aW9ucy1tb2RhbCwgLnBpY2tlci1tb2RhbCcpLmxlbmd0aCA+IDApKSkge1xuICAgICAgICAgICAgICAgIC8vIFJlaW5pdCBOYXZiYXJcbiAgICAgICAgICAgICAgICBhcHAucmVpbml0TmF2YmFyKG5hdmJhckNvbnRhaW5lciwgbmF2YmFySW5uZXJDb250YWluZXIpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBQbHVnaW4gaG9va1xuICAgICAgICAgICAgICAgIGFwcC5wbHVnaW5Ib29rKCduYXZiYXJSZWluaXQnLCBldmVudERhdGEpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBFdmVudFxuICAgICAgICAgICAgICAgICQobmF2YmFySW5uZXJDb250YWluZXIpLnRyaWdnZXIoJ25hdmJhclJlaW5pdCcsIGV2ZW50RGF0YSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbmF2YmFySW5uZXJDb250YWluZXIuZjdOYXZiYXJJbml0aWFsaXplZCA9IHRydWU7XG4gICAgICAgICAgICAvLyBCZWZvcmUgSW5pdFxuICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ25hdmJhckJlZm9yZUluaXQnLCBuYXZiYXJEYXRhLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAkKG5hdmJhcklubmVyQ29udGFpbmVyKS50cmlnZ2VyKCduYXZiYXJCZWZvcmVJbml0JywgZXZlbnREYXRhKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0aWFsaXplIE5hdmJhclxuICAgICAgICAgICAgYXBwLmluaXROYXZiYXIobmF2YmFyQ29udGFpbmVyLCBuYXZiYXJJbm5lckNvbnRhaW5lcik7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gT24gaW5pdFxuICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ25hdmJhckluaXQnLCBuYXZiYXJEYXRhLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAkKG5hdmJhcklubmVyQ29udGFpbmVyKS50cmlnZ2VyKCduYXZiYXJJbml0JywgZXZlbnREYXRhKTtcbiAgICAgICAgfTtcbiAgICAgICAgLy8gTmF2YmFyIFJlbW92ZSBDYWxsYmFja1xuICAgICAgICBhcHAubmF2YmFyUmVtb3ZlQ2FsbGJhY2sgPSBmdW5jdGlvbiAodmlldywgcGFnZUNvbnRhaW5lciwgbmF2YmFyQ29udGFpbmVyLCBuYXZiYXJJbm5lckNvbnRhaW5lcikge1xuICAgICAgICAgICAgaWYgKCFuYXZiYXJDb250YWluZXIgJiYgbmF2YmFySW5uZXJDb250YWluZXIpIG5hdmJhckNvbnRhaW5lciA9ICQobmF2YmFySW5uZXJDb250YWluZXIpLnBhcmVudCgnLm5hdmJhcicpWzBdO1xuICAgICAgICAgICAgdmFyIG5hdmJhckRhdGEgPSB7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyOiBuYXZiYXJDb250YWluZXIsXG4gICAgICAgICAgICAgICAgaW5uZXJDb250YWluZXI6IG5hdmJhcklubmVyQ29udGFpbmVyXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdmFyIHBhZ2VEYXRhID0gcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBldmVudERhdGEgPSB7XG4gICAgICAgICAgICAgICAgcGFnZTogcGFnZURhdGEsXG4gICAgICAgICAgICAgICAgbmF2YmFyOiBuYXZiYXJEYXRhXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ25hdmJhckJlZm9yZVJlbW92ZScsIG5hdmJhckRhdGEsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICQobmF2YmFySW5uZXJDb250YWluZXIpLnRyaWdnZXIoJ25hdmJhckJlZm9yZVJlbW92ZScsIGV2ZW50RGF0YSk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5pbml0TmF2YmFyID0gZnVuY3Rpb24gKG5hdmJhckNvbnRhaW5lciwgbmF2YmFySW5uZXJDb250YWluZXIpIHtcbiAgICAgICAgICAgIC8vIEluaXQgU3VibmF2YmFyIFNlYXJjaGJhclxuICAgICAgICAgICAgaWYgKGFwcC5pbml0U2VhcmNoYmFyKSBhcHAuaW5pdFNlYXJjaGJhcihuYXZiYXJJbm5lckNvbnRhaW5lcik7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5yZWluaXROYXZiYXIgPSBmdW5jdGlvbiAobmF2YmFyQ29udGFpbmVyLCBuYXZiYXJJbm5lckNvbnRhaW5lcikge1xuICAgICAgICAgICAgLy8gUmUgaW5pdCBuYXZiYXIgbWV0aG9kc1xuICAgICAgICB9O1xuICAgICAgICBhcHAuaW5pdE5hdmJhcldpdGhDYWxsYmFjayA9IGZ1bmN0aW9uIChuYXZiYXJDb250YWluZXIpIHtcbiAgICAgICAgICAgIG5hdmJhckNvbnRhaW5lciA9ICQobmF2YmFyQ29udGFpbmVyKTtcbiAgICAgICAgICAgIHZhciB2aWV3Q29udGFpbmVyID0gbmF2YmFyQ29udGFpbmVyLnBhcmVudHMoJy4nICsgYXBwLnBhcmFtcy52aWV3Q2xhc3MpO1xuICAgICAgICAgICAgdmFyIHZpZXc7XG4gICAgICAgICAgICBpZiAodmlld0NvbnRhaW5lci5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIGlmIChuYXZiYXJDb250YWluZXIucGFyZW50cygnLm5hdmJhci10aHJvdWdoJykubGVuZ3RoID09PSAwICYmIHZpZXdDb250YWluZXIuZmluZCgnLm5hdmJhci10aHJvdWdoJykubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICB2aWV3ID0gdmlld0NvbnRhaW5lclswXS5mN1ZpZXcgfHwgdW5kZWZpbmVkO1xuICAgICAgICBcbiAgICAgICAgICAgIG5hdmJhckNvbnRhaW5lci5maW5kKCcubmF2YmFyLWlubmVyJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5hdmJhcklubmVyQ29udGFpbmVyID0gdGhpcztcbiAgICAgICAgICAgICAgICB2YXIgcGFnZUNvbnRhaW5lcjtcbiAgICAgICAgICAgICAgICBpZiAoJChuYXZiYXJJbm5lckNvbnRhaW5lcikuYXR0cignZGF0YS1wYWdlJykpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gRm9yIGRvbSBjYWNoZVxuICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gdmlld0NvbnRhaW5lci5maW5kKCcucGFnZVtkYXRhLXBhZ2U9XCInICsgJChuYXZiYXJJbm5lckNvbnRhaW5lcikuYXR0cignZGF0YS1wYWdlJykgKyAnXCJdJylbMF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghcGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcGFnZXMgPSB2aWV3Q29udGFpbmVyLmZpbmQoJy5wYWdlJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYWdlcy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSBwYWdlc1swXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZpZXdDb250YWluZXIuZmluZCgnLnBhZ2UnKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mN1BhZ2VEYXRhICYmIHRoaXMuZjdQYWdlRGF0YS5uYXZiYXJJbm5lckNvbnRhaW5lciA9PT0gbmF2YmFySW5uZXJDb250YWluZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9IHRoaXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYXBwLm5hdmJhckluaXRDYWxsYmFjayh2aWV3LCBwYWdlQ29udGFpbmVyLCBuYXZiYXJDb250YWluZXJbMF0sIG5hdmJhcklubmVyQ29udGFpbmVyKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLy8gU2l6ZSBOYXZiYXJzXG4gICAgICAgIGFwcC5zaXplTmF2YmFycyA9IGZ1bmN0aW9uICh2aWV3Q29udGFpbmVyKSB7XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCkgcmV0dXJuO1xuICAgICAgICAgICAgdmFyIG5hdmJhcklubmVyID0gdmlld0NvbnRhaW5lciA/ICQodmlld0NvbnRhaW5lcikuZmluZCgnLm5hdmJhciAubmF2YmFyLWlubmVyOm5vdCguY2FjaGVkKScpIDogJCgnLm5hdmJhciAubmF2YmFyLWlubmVyOm5vdCguY2FjaGVkKScpO1xuICAgICAgICAgICAgbmF2YmFySW5uZXIuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIG4gPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgIGlmIChuLmhhc0NsYXNzKCdjYWNoZWQnKSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHZhciBsZWZ0ID0gYXBwLnJ0bCA/IG4uZmluZCgnLnJpZ2h0JykgOiBuLmZpbmQoJy5sZWZ0JyksXG4gICAgICAgICAgICAgICAgICAgIHJpZ2h0ID0gYXBwLnJ0bCA/IG4uZmluZCgnLmxlZnQnKSA6IG4uZmluZCgnLnJpZ2h0JyksXG4gICAgICAgICAgICAgICAgICAgIGNlbnRlciA9IG4uZmluZCgnLmNlbnRlcicpLFxuICAgICAgICAgICAgICAgICAgICBzdWJuYXZiYXIgPSBuLmZpbmQoJy5zdWJuYXZiYXInKSxcbiAgICAgICAgICAgICAgICAgICAgbm9MZWZ0ID0gbGVmdC5sZW5ndGggPT09IDAsXG4gICAgICAgICAgICAgICAgICAgIG5vUmlnaHQgPSByaWdodC5sZW5ndGggPT09IDAsXG4gICAgICAgICAgICAgICAgICAgIGxlZnRXaWR0aCA9IG5vTGVmdCA/IDAgOiBsZWZ0Lm91dGVyV2lkdGgodHJ1ZSksXG4gICAgICAgICAgICAgICAgICAgIHJpZ2h0V2lkdGggPSBub1JpZ2h0ID8gMCA6IHJpZ2h0Lm91dGVyV2lkdGgodHJ1ZSksXG4gICAgICAgICAgICAgICAgICAgIGNlbnRlcldpZHRoID0gY2VudGVyLm91dGVyV2lkdGgodHJ1ZSksXG4gICAgICAgICAgICAgICAgICAgIG5hdmJhclN0eWxlcyA9IG4uc3R5bGVzKCksXG4gICAgICAgICAgICAgICAgICAgIG5hdmJhcldpZHRoID0gblswXS5vZmZzZXRXaWR0aCAtIHBhcnNlSW50KG5hdmJhclN0eWxlcy5wYWRkaW5nTGVmdCwgMTApIC0gcGFyc2VJbnQobmF2YmFyU3R5bGVzLnBhZGRpbmdSaWdodCwgMTApLFxuICAgICAgICAgICAgICAgICAgICBvbkxlZnQgPSBuLmhhc0NsYXNzKCduYXZiYXItb24tbGVmdCcpLFxuICAgICAgICAgICAgICAgICAgICBjdXJyTGVmdCwgZGlmZjtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKG5vUmlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgY3VyckxlZnQgPSBuYXZiYXJXaWR0aCAtIGNlbnRlcldpZHRoO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobm9MZWZ0KSB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJMZWZ0ID0gMDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFub0xlZnQgJiYgIW5vUmlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgY3VyckxlZnQgPSAobmF2YmFyV2lkdGggLSByaWdodFdpZHRoIC0gY2VudGVyV2lkdGggKyBsZWZ0V2lkdGgpIC8gMjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHJlcXVpcmVkTGVmdCA9IChuYXZiYXJXaWR0aCAtIGNlbnRlcldpZHRoKSAvIDI7XG4gICAgICAgICAgICAgICAgaWYgKG5hdmJhcldpZHRoIC0gbGVmdFdpZHRoIC0gcmlnaHRXaWR0aCA+IGNlbnRlcldpZHRoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXF1aXJlZExlZnQgPCBsZWZ0V2lkdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVkTGVmdCA9IGxlZnRXaWR0aDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAocmVxdWlyZWRMZWZ0ICsgY2VudGVyV2lkdGggPiBuYXZiYXJXaWR0aCAtIHJpZ2h0V2lkdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVpcmVkTGVmdCA9IG5hdmJhcldpZHRoIC0gcmlnaHRXaWR0aCAtIGNlbnRlcldpZHRoO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGRpZmYgPSByZXF1aXJlZExlZnQgLSBjdXJyTGVmdDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGRpZmYgPSAwO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBSVEwgaW52ZXJ0ZXJcbiAgICAgICAgICAgICAgICB2YXIgaW52ZXJ0ZXIgPSBhcHAucnRsID8gLTEgOiAxO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoY2VudGVyLmhhc0NsYXNzKCdzbGlkaW5nJykpIHtcbiAgICAgICAgICAgICAgICAgICAgY2VudGVyWzBdLmY3TmF2YmFyTGVmdE9mZnNldCA9IC0oY3VyckxlZnQgKyBkaWZmKSAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgICAgICBjZW50ZXJbMF0uZjdOYXZiYXJSaWdodE9mZnNldCA9IChuYXZiYXJXaWR0aCAtIGN1cnJMZWZ0IC0gZGlmZiAtIGNlbnRlcldpZHRoKSAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgICAgICBpZiAob25MZWZ0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hbmltYXRlTmF2QmFja0ljb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWN0aXZlTmF2YmFyQmFja0xpbmsgPSBuLnBhcmVudCgpLmZpbmQoJy5uYXZiYXItb24tY2VudGVyJykuZmluZCgnLmxlZnQuc2xpZGluZyAuYmFjayAuaWNvbiB+IHNwYW4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aXZlTmF2YmFyQmFja0xpbmsubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZW50ZXJbMF0uZjdOYXZiYXJMZWZ0T2Zmc2V0ICs9IGFjdGl2ZU5hdmJhckJhY2tMaW5rWzBdLm9mZnNldExlZnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgY2VudGVyLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIGNlbnRlclswXS5mN05hdmJhckxlZnRPZmZzZXQgKyAncHgsIDAsIDApJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFub0xlZnQgJiYgbGVmdC5oYXNDbGFzcygnc2xpZGluZycpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHAucnRsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZWZ0WzBdLmY3TmF2YmFyTGVmdE9mZnNldCA9IC0obmF2YmFyV2lkdGggLSBsZWZ0WzBdLm9mZnNldFdpZHRoKSAvIDIgKiBpbnZlcnRlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnRbMF0uZjdOYXZiYXJSaWdodE9mZnNldCA9IGxlZnRXaWR0aCAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGVmdFswXS5mN05hdmJhckxlZnRPZmZzZXQgPSAtbGVmdFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGVmdFswXS5mN05hdmJhclJpZ2h0T2Zmc2V0ID0gKG5hdmJhcldpZHRoIC0gbGVmdFswXS5vZmZzZXRXaWR0aCkgLyAyO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuYW5pbWF0ZU5hdkJhY2tJY29uICYmIGxlZnQuZmluZCgnLmJhY2sgLmljb24nKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVmdFswXS5mN05hdmJhclJpZ2h0T2Zmc2V0IC09IGxlZnQuZmluZCgnLmJhY2sgLmljb24nKVswXS5vZmZzZXRXaWR0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAob25MZWZ0KSBsZWZ0LnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIGxlZnRbMF0uZjdOYXZiYXJMZWZ0T2Zmc2V0ICsgJ3B4LCAwLCAwKScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIW5vUmlnaHQgJiYgcmlnaHQuaGFzQ2xhc3MoJ3NsaWRpbmcnKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnJ0bCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRbMF0uZjdOYXZiYXJMZWZ0T2Zmc2V0ID0gLXJpZ2h0V2lkdGggKiBpbnZlcnRlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0WzBdLmY3TmF2YmFyUmlnaHRPZmZzZXQgPSAobmF2YmFyV2lkdGggLSByaWdodFswXS5vZmZzZXRXaWR0aCkgLyAyICogaW52ZXJ0ZXI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodFswXS5mN05hdmJhckxlZnRPZmZzZXQgPSAtKG5hdmJhcldpZHRoIC0gcmlnaHRbMF0ub2Zmc2V0V2lkdGgpIC8gMjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0WzBdLmY3TmF2YmFyUmlnaHRPZmZzZXQgPSByaWdodFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChvbkxlZnQpIHJpZ2h0LnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHJpZ2h0WzBdLmY3TmF2YmFyTGVmdE9mZnNldCArICdweCwgMCwgMCknKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHN1Ym5hdmJhci5sZW5ndGggJiYgc3VibmF2YmFyLmhhc0NsYXNzKCdzbGlkaW5nJykpIHtcbiAgICAgICAgICAgICAgICAgICAgc3VibmF2YmFyWzBdLmY3TmF2YmFyTGVmdE9mZnNldCA9IGFwcC5ydGwgPyBzdWJuYXZiYXJbMF0ub2Zmc2V0V2lkdGggOiAtc3VibmF2YmFyWzBdLm9mZnNldFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICBzdWJuYXZiYXJbMF0uZjdOYXZiYXJSaWdodE9mZnNldCA9IC1zdWJuYXZiYXJbMF0uZjdOYXZiYXJMZWZ0T2Zmc2V0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gQ2VudGVyIGxlZnRcbiAgICAgICAgICAgICAgICB2YXIgY2VudGVyTGVmdCA9IGRpZmY7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5ydGwgJiYgbm9MZWZ0ICYmIG5vUmlnaHQgJiYgY2VudGVyLmxlbmd0aCA+IDApIGNlbnRlckxlZnQgPSAtY2VudGVyTGVmdDtcbiAgICAgICAgICAgICAgICBjZW50ZXIuY3NzKHtsZWZ0OiBjZW50ZXJMZWZ0ICsgJ3B4J30pO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvLyBIaWRlL1Nob3cgTmF2YmFycy9Ub29sYmFyc1xuICAgICAgICBhcHAuaGlkZU5hdmJhciA9IGZ1bmN0aW9uIChuYXZiYXJDb250YWluZXIpIHtcbiAgICAgICAgICAgICQobmF2YmFyQ29udGFpbmVyKS5hZGRDbGFzcygnbmF2YmFyLWhpZGRlbicpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5zaG93TmF2YmFyID0gZnVuY3Rpb24gKG5hdmJhckNvbnRhaW5lcikge1xuICAgICAgICAgICAgdmFyIG5hdmJhciA9ICQobmF2YmFyQ29udGFpbmVyKTtcbiAgICAgICAgICAgIG5hdmJhci5hZGRDbGFzcygnbmF2YmFyLWhpZGluZycpLnJlbW92ZUNsYXNzKCduYXZiYXItaGlkZGVuJykudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgbmF2YmFyLnJlbW92ZUNsYXNzKCduYXZiYXItaGlkaW5nJyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuaGlkZVRvb2xiYXIgPSBmdW5jdGlvbiAodG9vbGJhckNvbnRhaW5lcikge1xuICAgICAgICAgICAgJCh0b29sYmFyQ29udGFpbmVyKS5hZGRDbGFzcygndG9vbGJhci1oaWRkZW4nKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuc2hvd1Rvb2xiYXIgPSBmdW5jdGlvbiAodG9vbGJhckNvbnRhaW5lcikge1xuICAgICAgICAgICAgdmFyIHRvb2xiYXIgPSAkKHRvb2xiYXJDb250YWluZXIpO1xuICAgICAgICAgICAgdG9vbGJhci5hZGRDbGFzcygndG9vbGJhci1oaWRpbmcnKS5yZW1vdmVDbGFzcygndG9vbGJhci1oaWRkZW4nKS50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB0b29sYmFyLnJlbW92ZUNsYXNzKCd0b29sYmFyLWhpZGluZycpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIFNlYXJjaGJhciAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICB2YXIgU2VhcmNoYmFyID0gZnVuY3Rpb24gKGNvbnRhaW5lciwgcGFyYW1zKSB7XG4gICAgICAgICAgICB2YXIgZGVmYXVsdHMgPSB7XG4gICAgICAgICAgICAgICAgaW5wdXQ6IG51bGwsXG4gICAgICAgICAgICAgICAgY2xlYXJCdXR0b246IG51bGwsXG4gICAgICAgICAgICAgICAgY2FuY2VsQnV0dG9uOiBudWxsLFxuICAgICAgICAgICAgICAgIHNlYXJjaExpc3Q6IG51bGwsXG4gICAgICAgICAgICAgICAgc2VhcmNoSW46ICcuaXRlbS10aXRsZScsXG4gICAgICAgICAgICAgICAgc2VhcmNoQnk6ICcnLFxuICAgICAgICAgICAgICAgIGZvdW5kOiBudWxsLFxuICAgICAgICAgICAgICAgIG5vdEZvdW5kOiBudWxsLFxuICAgICAgICAgICAgICAgIG92ZXJsYXk6IG51bGwsXG4gICAgICAgICAgICAgICAgaWdub3JlOiAnLnNlYXJjaGJhci1pZ25vcmUnLFxuICAgICAgICAgICAgICAgIGN1c3RvbVNlYXJjaDogZmFsc2UsXG4gICAgICAgICAgICAgICAgcmVtb3ZlRGlhY3JpdGljczogZmFsc2UsXG4gICAgICAgICAgICAgICAgaGlkZURpdmlkZXJzOiB0cnVlLFxuICAgICAgICAgICAgICAgIGhpZGVHcm91cHM6IHRydWUsXG4gICAgICAgICAgICAgICAgLyogQ2FsbGJhY2tzXG4gICAgICAgICAgICAgICAgb25TZWFyY2hcbiAgICAgICAgICAgICAgICBvbkVuYWJsZVxuICAgICAgICAgICAgICAgIG9uRGlzYWJsZVxuICAgICAgICAgICAgICAgIG9uQ2xlYXJcbiAgICAgICAgICAgICAgICAqL1xuICAgICAgICBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307XG4gICAgICAgICAgICBmb3IgKHZhciBkZWYgaW4gZGVmYXVsdHMpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtc1tkZWZdID09PSAndW5kZWZpbmVkJyB8fCBwYXJhbXNbZGVmXSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBwYXJhbXNbZGVmXSA9IGRlZmF1bHRzW2RlZl07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBJbnN0YW5jZVxuICAgICAgICAgICAgdmFyIHMgPSB0aGlzO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIE1hdGVyaWFsXG4gICAgICAgICAgICBzLm1hdGVyaWFsID0gYXBwLnBhcmFtcy5tYXRlcmlhbDtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQYXJhbXNcbiAgICAgICAgICAgIHMucGFyYW1zID0gcGFyYW1zO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIENvbnRhaW5lclxuICAgICAgICAgICAgY29udGFpbmVyID0gJChjb250YWluZXIpO1xuICAgICAgICAgICAgcy5jb250YWluZXIgPSBjb250YWluZXI7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQWN0aXZlXG4gICAgICAgICAgICBzLmFjdGl2ZSA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIElucHV0XG4gICAgICAgICAgICBzLmlucHV0ID0gcy5wYXJhbXMuaW5wdXQgPyAkKHMucGFyYW1zLmlucHV0KSA6IHMuY29udGFpbmVyLmZpbmQoJ2lucHV0W3R5cGU9XCJzZWFyY2hcIl0nKTtcbiAgICAgICAgICAgIHMuY2xlYXJCdXR0b24gPSBzLnBhcmFtcy5jbGVhckJ1dHRvbiA/ICQocy5wYXJhbXMuY2xlYXJCdXR0b24pIDogcy5jb250YWluZXIuZmluZCgnLnNlYXJjaGJhci1jbGVhcicpO1xuICAgICAgICAgICAgcy5jYW5jZWxCdXR0b24gPSBzLnBhcmFtcy5jYW5jZWxCdXR0b24gPyAkKHMucGFyYW1zLmNhbmNlbEJ1dHRvbikgOiBzLmNvbnRhaW5lci5maW5kKCcuc2VhcmNoYmFyLWNhbmNlbCcpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNlYXJjaCBMaXN0XG4gICAgICAgICAgICBzLnNlYXJjaExpc3QgPSAkKHMucGFyYW1zLnNlYXJjaExpc3QpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIElzIFZpcnR1YWwgTGlzdFxuICAgICAgICAgICAgcy5pc1ZpcnR1YWxMaXN0ID0gcy5zZWFyY2hMaXN0Lmhhc0NsYXNzKCd2aXJ0dWFsLWxpc3QnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJcyBJbiBQYWdlXG4gICAgICAgICAgICBzLnBhZ2VDb250YWluZXIgPSBzLmNvbnRhaW5lci5wYXJlbnRzKCcucGFnZScpLmVxKDApO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIE92ZXJsYXlcbiAgICAgICAgICAgIGlmICghcy5wYXJhbXMub3ZlcmxheSkge1xuICAgICAgICAgICAgICAgIHMub3ZlcmxheSA9IHMucGFnZUNvbnRhaW5lci5sZW5ndGggPiAwID8gcy5wYWdlQ29udGFpbmVyLmZpbmQoJy5zZWFyY2hiYXItb3ZlcmxheScpIDogJCgnLnNlYXJjaGJhci1vdmVybGF5Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzLm92ZXJsYXkgPSAkKHMucGFyYW1zLm92ZXJsYXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gRm91bmQgYW5kIG5vdCBmb3VuZFxuICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5mb3VuZCkge1xuICAgICAgICAgICAgICAgIHMuZm91bmQgPSBzLnBhZ2VDb250YWluZXIubGVuZ3RoID4gMCA/IHMucGFnZUNvbnRhaW5lci5maW5kKCcuc2VhcmNoYmFyLWZvdW5kJykgOiAkKCcuc2VhcmNoYmFyLWZvdW5kJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzLmZvdW5kID0gJChzLnBhcmFtcy5mb3VuZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXMucGFyYW1zLm5vdEZvdW5kKSB7XG4gICAgICAgICAgICAgICAgcy5ub3RGb3VuZCA9IHMucGFnZUNvbnRhaW5lci5sZW5ndGggPiAwID8gcy5wYWdlQ29udGFpbmVyLmZpbmQoJy5zZWFyY2hiYXItbm90LWZvdW5kJykgOiAkKCcuc2VhcmNoYmFyLW5vdC1mb3VuZCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcy5ub3RGb3VuZCA9ICQocy5wYXJhbXMubm90Rm91bmQpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgIC8vIERpYWNyaXRpY3NcbiAgICAgICAgICAgIHZhciBkZWZhdWx0RGlhY3JpdGljc1JlbW92YWxhcCA9IFtcbiAgICAgICAgICAgICAgICB7YmFzZTonQScsIGxldHRlcnM6J1xcdTAwNDFcXHUyNEI2XFx1RkYyMVxcdTAwQzBcXHUwMEMxXFx1MDBDMlxcdTFFQTZcXHUxRUE0XFx1MUVBQVxcdTFFQThcXHUwMEMzXFx1MDEwMFxcdTAxMDJcXHUxRUIwXFx1MUVBRVxcdTFFQjRcXHUxRUIyXFx1MDIyNlxcdTAxRTBcXHUwMEM0XFx1MDFERVxcdTFFQTJcXHUwMEM1XFx1MDFGQVxcdTAxQ0RcXHUwMjAwXFx1MDIwMlxcdTFFQTBcXHUxRUFDXFx1MUVCNlxcdTFFMDBcXHUwMTA0XFx1MDIzQVxcdTJDNkYnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonQUEnLGxldHRlcnM6J1xcdUE3MzInfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonQUUnLGxldHRlcnM6J1xcdTAwQzZcXHUwMUZDXFx1MDFFMid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidBTycsbGV0dGVyczonXFx1QTczNCd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidBVScsbGV0dGVyczonXFx1QTczNid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidBVicsbGV0dGVyczonXFx1QTczOFxcdUE3M0EnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonQVknLGxldHRlcnM6J1xcdUE3M0MnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonQicsIGxldHRlcnM6J1xcdTAwNDJcXHUyNEI3XFx1RkYyMlxcdTFFMDJcXHUxRTA0XFx1MUUwNlxcdTAyNDNcXHUwMTgyXFx1MDE4MSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidDJywgbGV0dGVyczonXFx1MDA0M1xcdTI0QjhcXHVGRjIzXFx1MDEwNlxcdTAxMDhcXHUwMTBBXFx1MDEwQ1xcdTAwQzdcXHUxRTA4XFx1MDE4N1xcdTAyM0JcXHVBNzNFJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0QnLCBsZXR0ZXJzOidcXHUwMDQ0XFx1MjRCOVxcdUZGMjRcXHUxRTBBXFx1MDEwRVxcdTFFMENcXHUxRTEwXFx1MUUxMlxcdTFFMEVcXHUwMTEwXFx1MDE4QlxcdTAxOEFcXHUwMTg5XFx1QTc3OSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidEWicsbGV0dGVyczonXFx1MDFGMVxcdTAxQzQnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonRHonLGxldHRlcnM6J1xcdTAxRjJcXHUwMUM1J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0UnLCBsZXR0ZXJzOidcXHUwMDQ1XFx1MjRCQVxcdUZGMjVcXHUwMEM4XFx1MDBDOVxcdTAwQ0FcXHUxRUMwXFx1MUVCRVxcdTFFQzRcXHUxRUMyXFx1MUVCQ1xcdTAxMTJcXHUxRTE0XFx1MUUxNlxcdTAxMTRcXHUwMTE2XFx1MDBDQlxcdTFFQkFcXHUwMTFBXFx1MDIwNFxcdTAyMDZcXHUxRUI4XFx1MUVDNlxcdTAyMjhcXHUxRTFDXFx1MDExOFxcdTFFMThcXHUxRTFBXFx1MDE5MFxcdTAxOEUnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonRicsIGxldHRlcnM6J1xcdTAwNDZcXHUyNEJCXFx1RkYyNlxcdTFFMUVcXHUwMTkxXFx1QTc3Qid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidHJywgbGV0dGVyczonXFx1MDA0N1xcdTI0QkNcXHVGRjI3XFx1MDFGNFxcdTAxMUNcXHUxRTIwXFx1MDExRVxcdTAxMjBcXHUwMUU2XFx1MDEyMlxcdTAxRTRcXHUwMTkzXFx1QTdBMFxcdUE3N0RcXHVBNzdFJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0gnLCBsZXR0ZXJzOidcXHUwMDQ4XFx1MjRCRFxcdUZGMjhcXHUwMTI0XFx1MUUyMlxcdTFFMjZcXHUwMjFFXFx1MUUyNFxcdTFFMjhcXHUxRTJBXFx1MDEyNlxcdTJDNjdcXHUyQzc1XFx1QTc4RCd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidJJywgbGV0dGVyczonXFx1MDA0OVxcdTI0QkVcXHVGRjI5XFx1MDBDQ1xcdTAwQ0RcXHUwMENFXFx1MDEyOFxcdTAxMkFcXHUwMTJDXFx1MDEzMFxcdTAwQ0ZcXHUxRTJFXFx1MUVDOFxcdTAxQ0ZcXHUwMjA4XFx1MDIwQVxcdTFFQ0FcXHUwMTJFXFx1MUUyQ1xcdTAxOTcnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonSicsIGxldHRlcnM6J1xcdTAwNEFcXHUyNEJGXFx1RkYyQVxcdTAxMzRcXHUwMjQ4J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0snLCBsZXR0ZXJzOidcXHUwMDRCXFx1MjRDMFxcdUZGMkJcXHUxRTMwXFx1MDFFOFxcdTFFMzJcXHUwMTM2XFx1MUUzNFxcdTAxOThcXHUyQzY5XFx1QTc0MFxcdUE3NDJcXHVBNzQ0XFx1QTdBMid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidMJywgbGV0dGVyczonXFx1MDA0Q1xcdTI0QzFcXHVGRjJDXFx1MDEzRlxcdTAxMzlcXHUwMTNEXFx1MUUzNlxcdTFFMzhcXHUwMTNCXFx1MUUzQ1xcdTFFM0FcXHUwMTQxXFx1MDIzRFxcdTJDNjJcXHUyQzYwXFx1QTc0OFxcdUE3NDZcXHVBNzgwJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0xKJyxsZXR0ZXJzOidcXHUwMUM3J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0xqJyxsZXR0ZXJzOidcXHUwMUM4J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J00nLCBsZXR0ZXJzOidcXHUwMDREXFx1MjRDMlxcdUZGMkRcXHUxRTNFXFx1MUU0MFxcdTFFNDJcXHUyQzZFXFx1MDE5Qyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidOJywgbGV0dGVyczonXFx1MDA0RVxcdTI0QzNcXHVGRjJFXFx1MDFGOFxcdTAxNDNcXHUwMEQxXFx1MUU0NFxcdTAxNDdcXHUxRTQ2XFx1MDE0NVxcdTFFNEFcXHUxRTQ4XFx1MDIyMFxcdTAxOURcXHVBNzkwXFx1QTdBNCd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidOSicsbGV0dGVyczonXFx1MDFDQSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidOaicsbGV0dGVyczonXFx1MDFDQid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidPJywgbGV0dGVyczonXFx1MDA0RlxcdTI0QzRcXHVGRjJGXFx1MDBEMlxcdTAwRDNcXHUwMEQ0XFx1MUVEMlxcdTFFRDBcXHUxRUQ2XFx1MUVENFxcdTAwRDVcXHUxRTRDXFx1MDIyQ1xcdTFFNEVcXHUwMTRDXFx1MUU1MFxcdTFFNTJcXHUwMTRFXFx1MDIyRVxcdTAyMzBcXHUwMEQ2XFx1MDIyQVxcdTFFQ0VcXHUwMTUwXFx1MDFEMVxcdTAyMENcXHUwMjBFXFx1MDFBMFxcdTFFRENcXHUxRURBXFx1MUVFMFxcdTFFREVcXHUxRUUyXFx1MUVDQ1xcdTFFRDhcXHUwMUVBXFx1MDFFQ1xcdTAwRDhcXHUwMUZFXFx1MDE4NlxcdTAxOUZcXHVBNzRBXFx1QTc0Qyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidPSScsbGV0dGVyczonXFx1MDFBMid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidPTycsbGV0dGVyczonXFx1QTc0RSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidPVScsbGV0dGVyczonXFx1MDIyMid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidPRScsbGV0dGVyczonXFx1MDA4Q1xcdTAxNTInfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonb2UnLGxldHRlcnM6J1xcdTAwOUNcXHUwMTUzJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J1AnLCBsZXR0ZXJzOidcXHUwMDUwXFx1MjRDNVxcdUZGMzBcXHUxRTU0XFx1MUU1NlxcdTAxQTRcXHUyQzYzXFx1QTc1MFxcdUE3NTJcXHVBNzU0J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J1EnLCBsZXR0ZXJzOidcXHUwMDUxXFx1MjRDNlxcdUZGMzFcXHVBNzU2XFx1QTc1OFxcdTAyNEEnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonUicsIGxldHRlcnM6J1xcdTAwNTJcXHUyNEM3XFx1RkYzMlxcdTAxNTRcXHUxRTU4XFx1MDE1OFxcdTAyMTBcXHUwMjEyXFx1MUU1QVxcdTFFNUNcXHUwMTU2XFx1MUU1RVxcdTAyNENcXHUyQzY0XFx1QTc1QVxcdUE3QTZcXHVBNzgyJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J1MnLCBsZXR0ZXJzOidcXHUwMDUzXFx1MjRDOFxcdUZGMzNcXHUxRTlFXFx1MDE1QVxcdTFFNjRcXHUwMTVDXFx1MUU2MFxcdTAxNjBcXHUxRTY2XFx1MUU2MlxcdTFFNjhcXHUwMjE4XFx1MDE1RVxcdTJDN0VcXHVBN0E4XFx1QTc4NCd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidUJywgbGV0dGVyczonXFx1MDA1NFxcdTI0QzlcXHVGRjM0XFx1MUU2QVxcdTAxNjRcXHUxRTZDXFx1MDIxQVxcdTAxNjJcXHUxRTcwXFx1MUU2RVxcdTAxNjZcXHUwMUFDXFx1MDFBRVxcdTAyM0VcXHVBNzg2J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J1RaJyxsZXR0ZXJzOidcXHVBNzI4J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J1UnLCBsZXR0ZXJzOidcXHUwMDU1XFx1MjRDQVxcdUZGMzVcXHUwMEQ5XFx1MDBEQVxcdTAwREJcXHUwMTY4XFx1MUU3OFxcdTAxNkFcXHUxRTdBXFx1MDE2Q1xcdTAwRENcXHUwMURCXFx1MDFEN1xcdTAxRDVcXHUwMUQ5XFx1MUVFNlxcdTAxNkVcXHUwMTcwXFx1MDFEM1xcdTAyMTRcXHUwMjE2XFx1MDFBRlxcdTFFRUFcXHUxRUU4XFx1MUVFRVxcdTFFRUNcXHUxRUYwXFx1MUVFNFxcdTFFNzJcXHUwMTcyXFx1MUU3NlxcdTFFNzRcXHUwMjQ0J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J1YnLCBsZXR0ZXJzOidcXHUwMDU2XFx1MjRDQlxcdUZGMzZcXHUxRTdDXFx1MUU3RVxcdTAxQjJcXHVBNzVFXFx1MDI0NSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidWWScsbGV0dGVyczonXFx1QTc2MCd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidXJywgbGV0dGVyczonXFx1MDA1N1xcdTI0Q0NcXHVGRjM3XFx1MUU4MFxcdTFFODJcXHUwMTc0XFx1MUU4NlxcdTFFODRcXHUxRTg4XFx1MkM3Mid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidYJywgbGV0dGVyczonXFx1MDA1OFxcdTI0Q0RcXHVGRjM4XFx1MUU4QVxcdTFFOEMnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonWScsIGxldHRlcnM6J1xcdTAwNTlcXHUyNENFXFx1RkYzOVxcdTFFRjJcXHUwMEREXFx1MDE3NlxcdTFFRjhcXHUwMjMyXFx1MUU4RVxcdTAxNzhcXHUxRUY2XFx1MUVGNFxcdTAxQjNcXHUwMjRFXFx1MUVGRSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidaJywgbGV0dGVyczonXFx1MDA1QVxcdTI0Q0ZcXHVGRjNBXFx1MDE3OVxcdTFFOTBcXHUwMTdCXFx1MDE3RFxcdTFFOTJcXHUxRTk0XFx1MDFCNVxcdTAyMjRcXHUyQzdGXFx1MkM2QlxcdUE3NjInfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonYScsIGxldHRlcnM6J1xcdTAwNjFcXHUyNEQwXFx1RkY0MVxcdTFFOUFcXHUwMEUwXFx1MDBFMVxcdTAwRTJcXHUxRUE3XFx1MUVBNVxcdTFFQUJcXHUxRUE5XFx1MDBFM1xcdTAxMDFcXHUwMTAzXFx1MUVCMVxcdTFFQUZcXHUxRUI1XFx1MUVCM1xcdTAyMjdcXHUwMUUxXFx1MDBFNFxcdTAxREZcXHUxRUEzXFx1MDBFNVxcdTAxRkJcXHUwMUNFXFx1MDIwMVxcdTAyMDNcXHUxRUExXFx1MUVBRFxcdTFFQjdcXHUxRTAxXFx1MDEwNVxcdTJDNjVcXHUwMjUwJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J2FhJyxsZXR0ZXJzOidcXHVBNzMzJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J2FlJyxsZXR0ZXJzOidcXHUwMEU2XFx1MDFGRFxcdTAxRTMnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonYW8nLGxldHRlcnM6J1xcdUE3MzUnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonYXUnLGxldHRlcnM6J1xcdUE3MzcnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonYXYnLGxldHRlcnM6J1xcdUE3MzlcXHVBNzNCJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J2F5JyxsZXR0ZXJzOidcXHVBNzNEJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J2InLCBsZXR0ZXJzOidcXHUwMDYyXFx1MjREMVxcdUZGNDJcXHUxRTAzXFx1MUUwNVxcdTFFMDdcXHUwMTgwXFx1MDE4M1xcdTAyNTMnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonYycsIGxldHRlcnM6J1xcdTAwNjNcXHUyNEQyXFx1RkY0M1xcdTAxMDdcXHUwMTA5XFx1MDEwQlxcdTAxMERcXHUwMEU3XFx1MUUwOVxcdTAxODhcXHUwMjNDXFx1QTczRlxcdTIxODQnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonZCcsIGxldHRlcnM6J1xcdTAwNjRcXHUyNEQzXFx1RkY0NFxcdTFFMEJcXHUwMTBGXFx1MUUwRFxcdTFFMTFcXHUxRTEzXFx1MUUwRlxcdTAxMTFcXHUwMThDXFx1MDI1NlxcdTAyNTdcXHVBNzdBJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J2R6JyxsZXR0ZXJzOidcXHUwMUYzXFx1MDFDNid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidlJywgbGV0dGVyczonXFx1MDA2NVxcdTI0RDRcXHVGRjQ1XFx1MDBFOFxcdTAwRTlcXHUwMEVBXFx1MUVDMVxcdTFFQkZcXHUxRUM1XFx1MUVDM1xcdTFFQkRcXHUwMTEzXFx1MUUxNVxcdTFFMTdcXHUwMTE1XFx1MDExN1xcdTAwRUJcXHUxRUJCXFx1MDExQlxcdTAyMDVcXHUwMjA3XFx1MUVCOVxcdTFFQzdcXHUwMjI5XFx1MUUxRFxcdTAxMTlcXHUxRTE5XFx1MUUxQlxcdTAyNDdcXHUwMjVCXFx1MDFERCd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidmJywgbGV0dGVyczonXFx1MDA2NlxcdTI0RDVcXHVGRjQ2XFx1MUUxRlxcdTAxOTJcXHVBNzdDJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J2cnLCBsZXR0ZXJzOidcXHUwMDY3XFx1MjRENlxcdUZGNDdcXHUwMUY1XFx1MDExRFxcdTFFMjFcXHUwMTFGXFx1MDEyMVxcdTAxRTdcXHUwMTIzXFx1MDFFNVxcdTAyNjBcXHVBN0ExXFx1MUQ3OVxcdUE3N0YnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonaCcsIGxldHRlcnM6J1xcdTAwNjhcXHUyNEQ3XFx1RkY0OFxcdTAxMjVcXHUxRTIzXFx1MUUyN1xcdTAyMUZcXHUxRTI1XFx1MUUyOVxcdTFFMkJcXHUxRTk2XFx1MDEyN1xcdTJDNjhcXHUyQzc2XFx1MDI2NSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidodicsbGV0dGVyczonXFx1MDE5NSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidpJywgbGV0dGVyczonXFx1MDA2OVxcdTI0RDhcXHVGRjQ5XFx1MDBFQ1xcdTAwRURcXHUwMEVFXFx1MDEyOVxcdTAxMkJcXHUwMTJEXFx1MDBFRlxcdTFFMkZcXHUxRUM5XFx1MDFEMFxcdTAyMDlcXHUwMjBCXFx1MUVDQlxcdTAxMkZcXHUxRTJEXFx1MDI2OFxcdTAxMzEnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonaicsIGxldHRlcnM6J1xcdTAwNkFcXHUyNEQ5XFx1RkY0QVxcdTAxMzVcXHUwMUYwXFx1MDI0OSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidrJywgbGV0dGVyczonXFx1MDA2QlxcdTI0REFcXHVGRjRCXFx1MUUzMVxcdTAxRTlcXHUxRTMzXFx1MDEzN1xcdTFFMzVcXHUwMTk5XFx1MkM2QVxcdUE3NDFcXHVBNzQzXFx1QTc0NVxcdUE3QTMnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonbCcsIGxldHRlcnM6J1xcdTAwNkNcXHUyNERCXFx1RkY0Q1xcdTAxNDBcXHUwMTNBXFx1MDEzRVxcdTFFMzdcXHUxRTM5XFx1MDEzQ1xcdTFFM0RcXHUxRTNCXFx1MDE3RlxcdTAxNDJcXHUwMTlBXFx1MDI2QlxcdTJDNjFcXHVBNzQ5XFx1QTc4MVxcdUE3NDcnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonbGonLGxldHRlcnM6J1xcdTAxQzknfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonbScsIGxldHRlcnM6J1xcdTAwNkRcXHUyNERDXFx1RkY0RFxcdTFFM0ZcXHUxRTQxXFx1MUU0M1xcdTAyNzFcXHUwMjZGJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J24nLCBsZXR0ZXJzOidcXHUwMDZFXFx1MjRERFxcdUZGNEVcXHUwMUY5XFx1MDE0NFxcdTAwRjFcXHUxRTQ1XFx1MDE0OFxcdTFFNDdcXHUwMTQ2XFx1MUU0QlxcdTFFNDlcXHUwMTlFXFx1MDI3MlxcdTAxNDlcXHVBNzkxXFx1QTdBNSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOiduaicsbGV0dGVyczonXFx1MDFDQyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidvJywgbGV0dGVyczonXFx1MDA2RlxcdTI0REVcXHVGRjRGXFx1MDBGMlxcdTAwRjNcXHUwMEY0XFx1MUVEM1xcdTFFRDFcXHUxRUQ3XFx1MUVENVxcdTAwRjVcXHUxRTREXFx1MDIyRFxcdTFFNEZcXHUwMTREXFx1MUU1MVxcdTFFNTNcXHUwMTRGXFx1MDIyRlxcdTAyMzFcXHUwMEY2XFx1MDIyQlxcdTFFQ0ZcXHUwMTUxXFx1MDFEMlxcdTAyMERcXHUwMjBGXFx1MDFBMVxcdTFFRERcXHUxRURCXFx1MUVFMVxcdTFFREZcXHUxRUUzXFx1MUVDRFxcdTFFRDlcXHUwMUVCXFx1MDFFRFxcdTAwRjhcXHUwMUZGXFx1MDI1NFxcdUE3NEJcXHVBNzREXFx1MDI3NSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidvaScsbGV0dGVyczonXFx1MDFBMyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidvdScsbGV0dGVyczonXFx1MDIyMyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidvbycsbGV0dGVyczonXFx1QTc0Rid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidwJyxsZXR0ZXJzOidcXHUwMDcwXFx1MjRERlxcdUZGNTBcXHUxRTU1XFx1MUU1N1xcdTAxQTVcXHUxRDdEXFx1QTc1MVxcdUE3NTNcXHVBNzU1J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J3EnLGxldHRlcnM6J1xcdTAwNzFcXHUyNEUwXFx1RkY1MVxcdTAyNEJcXHVBNzU3XFx1QTc1OSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidyJyxsZXR0ZXJzOidcXHUwMDcyXFx1MjRFMVxcdUZGNTJcXHUwMTU1XFx1MUU1OVxcdTAxNTlcXHUwMjExXFx1MDIxM1xcdTFFNUJcXHUxRTVEXFx1MDE1N1xcdTFFNUZcXHUwMjREXFx1MDI3RFxcdUE3NUJcXHVBN0E3XFx1QTc4Myd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidzJyxsZXR0ZXJzOidcXHUwMDczXFx1MjRFMlxcdUZGNTNcXHUwMERGXFx1MDE1QlxcdTFFNjVcXHUwMTVEXFx1MUU2MVxcdTAxNjFcXHUxRTY3XFx1MUU2M1xcdTFFNjlcXHUwMjE5XFx1MDE1RlxcdTAyM0ZcXHVBN0E5XFx1QTc4NVxcdTFFOUInfSxcbiAgICAgICAgICAgICAgICB7YmFzZTondCcsbGV0dGVyczonXFx1MDA3NFxcdTI0RTNcXHVGRjU0XFx1MUU2QlxcdTFFOTdcXHUwMTY1XFx1MUU2RFxcdTAyMUJcXHUwMTYzXFx1MUU3MVxcdTFFNkZcXHUwMTY3XFx1MDFBRFxcdTAyODhcXHUyQzY2XFx1QTc4Nyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOid0eicsbGV0dGVyczonXFx1QTcyOSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOid1JyxsZXR0ZXJzOiAnXFx1MDA3NVxcdTI0RTRcXHVGRjU1XFx1MDBGOVxcdTAwRkFcXHUwMEZCXFx1MDE2OVxcdTFFNzlcXHUwMTZCXFx1MUU3QlxcdTAxNkRcXHUwMEZDXFx1MDFEQ1xcdTAxRDhcXHUwMUQ2XFx1MDFEQVxcdTFFRTdcXHUwMTZGXFx1MDE3MVxcdTAxRDRcXHUwMjE1XFx1MDIxN1xcdTAxQjBcXHUxRUVCXFx1MUVFOVxcdTFFRUZcXHUxRUVEXFx1MUVGMVxcdTFFRTVcXHUxRTczXFx1MDE3M1xcdTFFNzdcXHUxRTc1XFx1MDI4OSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOid2JyxsZXR0ZXJzOidcXHUwMDc2XFx1MjRFNVxcdUZGNTZcXHUxRTdEXFx1MUU3RlxcdTAyOEJcXHVBNzVGXFx1MDI4Qyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOid2eScsbGV0dGVyczonXFx1QTc2MSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOid3JyxsZXR0ZXJzOidcXHUwMDc3XFx1MjRFNlxcdUZGNTdcXHUxRTgxXFx1MUU4M1xcdTAxNzVcXHUxRTg3XFx1MUU4NVxcdTFFOThcXHUxRTg5XFx1MkM3Myd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOid4JyxsZXR0ZXJzOidcXHUwMDc4XFx1MjRFN1xcdUZGNThcXHUxRThCXFx1MUU4RCd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOid5JyxsZXR0ZXJzOidcXHUwMDc5XFx1MjRFOFxcdUZGNTlcXHUxRUYzXFx1MDBGRFxcdTAxNzdcXHUxRUY5XFx1MDIzM1xcdTFFOEZcXHUwMEZGXFx1MUVGN1xcdTFFOTlcXHUxRUY1XFx1MDFCNFxcdTAyNEZcXHUxRUZGJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J3onLGxldHRlcnM6J1xcdTAwN0FcXHUyNEU5XFx1RkY1QVxcdTAxN0FcXHUxRTkxXFx1MDE3Q1xcdTAxN0VcXHUxRTkzXFx1MUU5NVxcdTAxQjZcXHUwMjI1XFx1MDI0MFxcdTJDNkNcXHVBNzYzJ31cbiAgICAgICAgICAgIF07XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIGRpYWNyaXRpY3NNYXAgPSB7fTtcbiAgICAgICAgICAgIGZvciAodmFyIGk9MDsgaSA8IGRlZmF1bHREaWFjcml0aWNzUmVtb3ZhbGFwLmxlbmd0aDsgaSsrKXtcbiAgICAgICAgICAgICAgICB2YXIgbGV0dGVycyA9IGRlZmF1bHREaWFjcml0aWNzUmVtb3ZhbGFwW2ldLmxldHRlcnM7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaj0wOyBqIDwgbGV0dGVycy5sZW5ndGggOyBqKyspe1xuICAgICAgICAgICAgICAgICAgICBkaWFjcml0aWNzTWFwW2xldHRlcnNbal1dID0gZGVmYXVsdERpYWNyaXRpY3NSZW1vdmFsYXBbaV0uYmFzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgZnVuY3Rpb24gcmVtb3ZlRGlhY3JpdGljcyAoc3RyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKC9bXlxcdTAwMDAtXFx1MDA3RV0vZywgZnVuY3Rpb24oYSl7IFxuICAgICAgICAgICAgICAgICAgIHJldHVybiBkaWFjcml0aWNzTWFwW2FdIHx8IGE7IFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNldCBDYW5jZWwgYnV0dG9uXG4gICAgICAgICAgICB2YXIgY2FuY2VsTWFyZ2luUHJvcCA9IGFwcC5ydGwgPyAnbWFyZ2luLWxlZnQnIDogJ21hcmdpbi1yaWdodCc7XG4gICAgICAgICAgICB2YXIgY2FuY2VsQnV0dG9uSGFzTWFyZ2luID0gZmFsc2U7XG4gICAgICAgICAgICBzLnNldENhbmNlbEJ1dHRvbk1hcmdpbiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBzLmNhbmNlbEJ1dHRvbi50cmFuc2l0aW9uKDApLnNob3coKTtcbiAgICAgICAgICAgICAgICBzLmNhbmNlbEJ1dHRvbi5jc3MoY2FuY2VsTWFyZ2luUHJvcCwgLXMuY2FuY2VsQnV0dG9uWzBdLm9mZnNldFdpZHRoICsgJ3B4Jyk7XG4gICAgICAgICAgICAgICAgdmFyIGNsaWVudExlZnQgPSBzLmNhbmNlbEJ1dHRvblswXS5jbGllbnRMZWZ0O1xuICAgICAgICAgICAgICAgIHMuY2FuY2VsQnV0dG9uLnRyYW5zaXRpb24oJycpO1xuICAgICAgICAgICAgICAgIGNhbmNlbEJ1dHRvbkhhc01hcmdpbiA9IHRydWU7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFRyaWdnZXJcbiAgICAgICAgICAgIHMudHJpZ2dlckV2ZW50ID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgY2FsbGJhY2tOYW1lLCBldmVudERhdGEpIHtcbiAgICAgICAgICAgICAgICBzLmNvbnRhaW5lci50cmlnZ2VyKGV2ZW50TmFtZSwgZXZlbnREYXRhKTtcbiAgICAgICAgICAgICAgICBpZiAocy5zZWFyY2hMaXN0Lmxlbmd0aCA+IDApIHMuc2VhcmNoTGlzdC50cmlnZ2VyKGV2ZW50TmFtZSwgZXZlbnREYXRhKTtcbiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tOYW1lICYmIHMucGFyYW1zW2NhbGxiYWNrTmFtZV0pIHMucGFyYW1zW2NhbGxiYWNrTmFtZV0ocywgZXZlbnREYXRhKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRW5hYmxlL2Rpc2FsYmVcbiAgICAgICAgICAgIHMuZW5hYmxlID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBfZW5hYmxlKCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoKHMuc2VhcmNoTGlzdC5sZW5ndGggfHwgcy5wYXJhbXMuY3VzdG9tU2VhcmNoKSAmJiAhcy5jb250YWluZXIuaGFzQ2xhc3MoJ3NlYXJjaGJhci1hY3RpdmUnKSAmJiAhcy5xdWVyeSkgcy5vdmVybGF5LmFkZENsYXNzKCdzZWFyY2hiYXItb3ZlcmxheS1hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICAgICAgcy5jb250YWluZXIuYWRkQ2xhc3MoJ3NlYXJjaGJhci1hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuY2FuY2VsQnV0dG9uLmxlbmd0aCA+IDAgJiYgIXMubWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY2FuY2VsQnV0dG9uSGFzTWFyZ2luKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5zZXRDYW5jZWxCdXR0b25NYXJnaW4oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHMuY2FuY2VsQnV0dG9uLmNzcyhjYW5jZWxNYXJnaW5Qcm9wLCAnMHB4Jyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcy50cmlnZ2VyRXZlbnQoJ2VuYWJsZVNlYXJjaCcsICdvbkVuYWJsZScpO1xuICAgICAgICAgICAgICAgICAgICBzLmFjdGl2ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLmlvcyAmJiAhYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBlICYmIGUudHlwZSA9PT0gJ2ZvY3VzJykge1xuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF9lbmFibGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgNDAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIF9lbmFibGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIHMuZGlzYWJsZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBzLmlucHV0LnZhbCgnJykudHJpZ2dlcignY2hhbmdlJyk7XG4gICAgICAgICAgICAgICAgcy5jb250YWluZXIucmVtb3ZlQ2xhc3MoJ3NlYXJjaGJhci1hY3RpdmUgc2VhcmNoYmFyLW5vdC1lbXB0eScpO1xuICAgICAgICAgICAgICAgIGlmIChzLmNhbmNlbEJ1dHRvbi5sZW5ndGggPiAwICYmICFzLm1hdGVyaWFsKSBzLmNhbmNlbEJ1dHRvbi5jc3MoY2FuY2VsTWFyZ2luUHJvcCwgLXMuY2FuY2VsQnV0dG9uWzBdLm9mZnNldFdpZHRoICsgJ3B4Jyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChzLnNlYXJjaExpc3QubGVuZ3RoIHx8IHMucGFyYW1zLmN1c3RvbVNlYXJjaCkgcy5vdmVybGF5LnJlbW92ZUNsYXNzKCdzZWFyY2hiYXItb3ZlcmxheS1hY3RpdmUnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcy5hY3RpdmUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBfZGlzYWJsZSgpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5pbnB1dC5ibHVyKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLmlvcykge1xuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIF9kaXNhYmxlKCk7XG4gICAgICAgICAgICAgICAgICAgIH0sIDQwMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBfZGlzYWJsZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzLnRyaWdnZXJFdmVudCgnZGlzYWJsZVNlYXJjaCcsICdvbkRpc2FibGUnKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ2xlYXJcbiAgICAgICAgICAgIHMuY2xlYXIgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGlmICghcy5xdWVyeSAmJiBlICYmICQoZS50YXJnZXQpLmhhc0NsYXNzKCdzZWFyY2hiYXItY2xlYXInKSkge1xuICAgICAgICAgICAgICAgICAgICBzLmRpc2FibGUoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzLmlucHV0LnZhbCgnJykudHJpZ2dlcignY2hhbmdlJykuZm9jdXMoKTtcbiAgICAgICAgICAgICAgICBzLnRyaWdnZXJFdmVudCgnY2xlYXJTZWFyY2gnLCAnb25DbGVhcicpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTZWFyY2hcbiAgICAgICAgICAgIHMuaGFuZGxlSW5wdXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHMuaW5wdXQudmFsKCkudHJpbSgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoKHMuc2VhcmNoTGlzdC5sZW5ndGggPiAwIHx8IHMucGFyYW1zLmN1c3RvbVNlYXJjaCkgJiYgKHMucGFyYW1zLnNlYXJjaEluIHx8IHMuaXNWaXJ0dWFsTGlzdCkpIHMuc2VhcmNoKHZhbHVlLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHByZXZpb3VzUXVlcnkgPSAnJztcbiAgICAgICAgICAgIHZhciB2aXJ0dWFsTGlzdDtcbiAgICAgICAgICAgIHMuc2VhcmNoID0gZnVuY3Rpb24gKHF1ZXJ5LCBpbnRlcm5hbCkge1xuICAgICAgICAgICAgICAgIGlmIChxdWVyeS50cmltKCkgPT09IHByZXZpb3VzUXVlcnkpIHJldHVybjtcbiAgICAgICAgICAgICAgICBwcmV2aW91c1F1ZXJ5ID0gcXVlcnkudHJpbSgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIWludGVybmFsKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcy5hY3RpdmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuZW5hYmxlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcy5pbnB1dC52YWwocXVlcnkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzLnF1ZXJ5ID0gcy52YWx1ZSA9IHF1ZXJ5O1xuICAgICAgICAgICAgICAgIC8vIEFkZCBhY3RpdmUvaW5hY3RpdmUgY2xhc3NlcyBvbiBvdmVybGF5XG4gICAgICAgICAgICAgICAgaWYgKHF1ZXJ5Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBzLmNvbnRhaW5lci5yZW1vdmVDbGFzcygnc2VhcmNoYmFyLW5vdC1lbXB0eScpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5zZWFyY2hMaXN0Lmxlbmd0aCAmJiBzLmNvbnRhaW5lci5oYXNDbGFzcygnc2VhcmNoYmFyLWFjdGl2ZScpKSBzLm92ZXJsYXkuYWRkQ2xhc3MoJ3NlYXJjaGJhci1vdmVybGF5LWFjdGl2ZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcy5jb250YWluZXIuYWRkQ2xhc3MoJ3NlYXJjaGJhci1ub3QtZW1wdHknKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuc2VhcmNoTGlzdC5sZW5ndGggJiYgcy5jb250YWluZXIuaGFzQ2xhc3MoJ3NlYXJjaGJhci1hY3RpdmUnKSkgcy5vdmVybGF5LnJlbW92ZUNsYXNzKCdzZWFyY2hiYXItb3ZlcmxheS1hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5jdXN0b21TZWFyY2gpIHtcbiAgICAgICAgICAgICAgICAgICAgcy50cmlnZ2VyRXZlbnQoJ3NlYXJjaCcsICdvblNlYXJjaCcsIHtxdWVyeTogcXVlcnl9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgZm91bmRJdGVtcyA9IFtdO1xuICAgICAgICAgICAgICAgIGlmIChzLmlzVmlydHVhbExpc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlydHVhbExpc3QgPSBzLnNlYXJjaExpc3RbMF0uZjdWaXJ0dWFsTGlzdDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHF1ZXJ5LnRyaW0oKSA9PT0gJycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZpcnR1YWxMaXN0LnJlc2V0RmlsdGVyKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLm5vdEZvdW5kLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuZm91bmQuc2hvdygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICh2aXJ0dWFsTGlzdC5wYXJhbXMuc2VhcmNoQWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3VuZEl0ZW1zID0gdmlydHVhbExpc3QucGFyYW1zLnNlYXJjaEFsbChxdWVyeSwgdmlydHVhbExpc3QuaXRlbXMpIHx8IFtdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHZpcnR1YWxMaXN0LnBhcmFtcy5zZWFyY2hCeUl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmlydHVhbExpc3QuaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih2aXJ0dWFsTGlzdC5wYXJhbXMuc2VhcmNoQnlJdGVtKHF1ZXJ5LCBpLCB2aXJ0dWFsTGlzdC5wYXJhbXMuaXRlbXNbaV0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kSXRlbXMucHVzaChpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZXM7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5yZW1vdmVEaWFjcml0aWNzKSB2YWx1ZXMgPSByZW1vdmVEaWFjcml0aWNzKHF1ZXJ5LnRyaW0oKS50b0xvd2VyQ2FzZSgpKS5zcGxpdCgnICcpO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcyA9IHF1ZXJ5LnRyaW0oKS50b0xvd2VyQ2FzZSgpLnNwbGl0KCcgJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcy5zZWFyY2hMaXN0LmZpbmQoJ2xpJykucmVtb3ZlQ2xhc3MoJ2hpZGRlbi1ieS1zZWFyY2hiYXInKS5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsID0gJChlbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29tcGFyZVdpdGhUZXh0ID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICBlbC5maW5kKHMucGFyYW1zLnNlYXJjaEluKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbVRleHQgPSAkKHRoaXMpLnRleHQoKS50cmltKCkudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucmVtb3ZlRGlhY3JpdGljcykgaXRlbVRleHQgPSByZW1vdmVEaWFjcml0aWNzKGl0ZW1UZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21wYXJlV2l0aFRleHQucHVzaChpdGVtVGV4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBhcmVXaXRoVGV4dCA9IGNvbXBhcmVXaXRoVGV4dC5qb2luKCcgJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgd29yZHNNYXRjaCA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21wYXJlV2l0aFRleHQuaW5kZXhPZih2YWx1ZXNbaV0pID49IDApIHdvcmRzTWF0Y2grKztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh3b3Jkc01hdGNoICE9PSB2YWx1ZXMubGVuZ3RoICYmICEocy5wYXJhbXMuaWdub3JlICYmIGVsLmlzKHMucGFyYW1zLmlnbm9yZSkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwuYWRkQ2xhc3MoJ2hpZGRlbi1ieS1zZWFyY2hiYXInKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kSXRlbXMucHVzaChlbFswXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmhpZGVEaXZpZGVycykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5zZWFyY2hMaXN0LmZpbmQoJy5pdGVtLWRpdmlkZXIsIC5saXN0LWdyb3VwLXRpdGxlJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRpdGxlID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dEVsZW1lbnRzID0gdGl0bGUubmV4dEFsbCgnbGknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGlkZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBuZXh0RWxlbWVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5leHRFbCA9ICQobmV4dEVsZW1lbnRzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRFbC5oYXNDbGFzcygnbGlzdC1ncm91cC10aXRsZScpIHx8IG5leHRFbC5oYXNDbGFzcygnaXRlbS1kaXZpZGVyJykpIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5leHRFbC5oYXNDbGFzcygnaGlkZGVuLWJ5LXNlYXJjaGJhcicpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoaWRlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlnbm9yZSA9IHMucGFyYW1zLmlnbm9yZSAmJiB0aXRsZS5pcyhzLnBhcmFtcy5pZ25vcmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoaWRlICYmICFpZ25vcmUpIHRpdGxlLmFkZENsYXNzKCdoaWRkZW4tYnktc2VhcmNoYmFyJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB0aXRsZS5yZW1vdmVDbGFzcygnaGlkZGVuLWJ5LXNlYXJjaGJhcicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmhpZGVHcm91cHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuc2VhcmNoTGlzdC5maW5kKCcubGlzdC1ncm91cCcpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBncm91cCA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlnbm9yZSA9IHMucGFyYW1zLmlnbm9yZSAmJiBncm91cC5pcyhzLnBhcmFtcy5pZ25vcmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBub3RIaWRkZW4gPSBncm91cC5maW5kKCdsaTpub3QoLmhpZGRlbi1ieS1zZWFyY2hiYXIpJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vdEhpZGRlbi5sZW5ndGggPT09IDAgJiYgIWlnbm9yZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cC5hZGRDbGFzcygnaGlkZGVuLWJ5LXNlYXJjaGJhcicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXAucmVtb3ZlQ2xhc3MoJ2hpZGRlbi1ieS1zZWFyY2hiYXInKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzLnRyaWdnZXJFdmVudCgnc2VhcmNoJywgJ29uU2VhcmNoJywge3F1ZXJ5OiBxdWVyeSwgZm91bmRJdGVtczogZm91bmRJdGVtc30pO1xuICAgICAgICAgICAgICAgIGlmIChmb3VuZEl0ZW1zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBzLm5vdEZvdW5kLnNob3coKTtcbiAgICAgICAgICAgICAgICAgICAgcy5mb3VuZC5oaWRlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzLm5vdEZvdW5kLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgcy5mb3VuZC5zaG93KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzLmlzVmlydHVhbExpc3QpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlydHVhbExpc3QuZmlsdGVySXRlbXMoZm91bmRJdGVtcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBFdmVudHNcbiAgICAgICAgICAgIGZ1bmN0aW9uIHByZXZlbnRTdWJtaXQoZSkge1xuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBzLmF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uIChkZXN0cm95KSB7XG4gICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGRlc3Ryb3kgPyAnb2ZmJyA6ICdvbic7XG4gICAgICAgICAgICAgICAgcy5jb250YWluZXJbbWV0aG9kXSgnc3VibWl0JywgcHJldmVudFN1Ym1pdCk7XG4gICAgICAgICAgICAgICAgaWYgKCFzLm1hdGVyaWFsKSBzLmNhbmNlbEJ1dHRvblttZXRob2RdKCdjbGljaycsIHMuZGlzYWJsZSk7XG4gICAgICAgICAgICAgICAgcy5vdmVybGF5W21ldGhvZF0oJ2NsaWNrJywgcy5kaXNhYmxlKTtcbiAgICAgICAgICAgICAgICBzLmlucHV0W21ldGhvZF0oJ2ZvY3VzJywgcy5lbmFibGUpO1xuICAgICAgICAgICAgICAgIHMuaW5wdXRbbWV0aG9kXSgnY2hhbmdlIGtleWRvd24ga2V5cHJlc3Mga2V5dXAnLCBzLmhhbmRsZUlucHV0KTtcbiAgICAgICAgICAgICAgICBzLmNsZWFyQnV0dG9uW21ldGhvZF0oJ2NsaWNrJywgcy5jbGVhcik7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHMuZGV0YWNoRXZlbnRzID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgcy5hdHRhY2hFdmVudHModHJ1ZSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgRGVzdHJveVxuICAgICAgICAgICAgcy5pbml0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHMuYXR0YWNoRXZlbnRzKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcy5kZXN0cm95ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmICghcykgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHMuZGV0YWNoRXZlbnRzKCk7XG4gICAgICAgICAgICAgICAgcyA9IG51bGw7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXRcbiAgICAgICAgICAgIHMuaW5pdCgpO1xuICAgICAgICBcbiAgICAgICAgICAgIHMuY29udGFpbmVyWzBdLmY3U2VhcmNoYmFyID0gcztcbiAgICAgICAgICAgIHJldHVybiBzO1xuICAgICAgICBcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnNlYXJjaGJhciA9IGZ1bmN0aW9uIChjb250YWluZXIsIHBhcmFtcykge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBTZWFyY2hiYXIoY29udGFpbmVyLCBwYXJhbXMpO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuaW5pdFNlYXJjaGJhciA9IGZ1bmN0aW9uIChjb250YWluZXIpIHtcbiAgICAgICAgICAgIGNvbnRhaW5lciA9ICQoY29udGFpbmVyKTtcbiAgICAgICAgICAgIHZhciBzZWFyY2hiYXIgPSBjb250YWluZXIuaGFzQ2xhc3MoJ3NlYXJjaGJhcicpID8gY29udGFpbmVyIDogY29udGFpbmVyLmZpbmQoJy5zZWFyY2hiYXInKTtcbiAgICAgICAgICAgIGlmIChzZWFyY2hiYXIubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoIXNlYXJjaGJhci5oYXNDbGFzcygnc2VhcmNoYmFyLWluaXQnKSkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBzYiA9IGFwcC5zZWFyY2hiYXIoc2VhcmNoYmFyLCBzZWFyY2hiYXIuZGF0YXNldCgpKTtcbiAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiBvbkJlZm9yZVJlbW92ZSgpIHtcbiAgICAgICAgICAgICAgICBpZiAoc2IpIHNiLmRlc3Ryb3koKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjb250YWluZXIuaGFzQ2xhc3MoJ3BhZ2UnKSkge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5vbmNlKCdwYWdlQmVmb3JlUmVtb3ZlJywgb25CZWZvcmVSZW1vdmUpOyAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoY29udGFpbmVyLmhhc0NsYXNzKCduYXZiYXItaW5uZXInKSkge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5vbmNlKCduYXZiYXJCZWZvcmVSZW1vdmUnLCBvbkJlZm9yZVJlbW92ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgTWVzc2FnZWJhciAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICB2YXIgTWVzc2FnZWJhciA9IGZ1bmN0aW9uIChjb250YWluZXIsIHBhcmFtcykge1xuICAgICAgICAgICAgdmFyIGRlZmF1bHRzID0ge1xuICAgICAgICAgICAgICAgIHRleHRhcmVhOiBudWxsLFxuICAgICAgICAgICAgICAgIG1heEhlaWdodDogbnVsbCxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307XG4gICAgICAgICAgICBmb3IgKHZhciBkZWYgaW4gZGVmYXVsdHMpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtc1tkZWZdID09PSAndW5kZWZpbmVkJyB8fCBwYXJhbXNbZGVmXSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBwYXJhbXNbZGVmXSA9IGRlZmF1bHRzW2RlZl07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBJbnN0YW5jZVxuICAgICAgICAgICAgdmFyIG0gPSB0aGlzO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBhcmFtc1xuICAgICAgICAgICAgbS5wYXJhbXMgPSBwYXJhbXM7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ29udGFpbmVyXG4gICAgICAgICAgICBtLmNvbnRhaW5lciA9ICQoY29udGFpbmVyKTtcbiAgICAgICAgICAgIGlmIChtLmNvbnRhaW5lci5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBUZXh0YXJlYVxuICAgICAgICAgICAgbS50ZXh0YXJlYSA9IG0ucGFyYW1zLnRleHRhcmVhID8gJChtLnBhcmFtcy50ZXh0YXJlYSkgOiBtLmNvbnRhaW5lci5maW5kKCd0ZXh0YXJlYScpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIElzIEluIFBhZ2VcbiAgICAgICAgICAgIG0ucGFnZUNvbnRhaW5lciA9IG0uY29udGFpbmVyLnBhcmVudHMoJy5wYWdlJykuZXEoMCk7XG4gICAgICAgICAgICBtLnBhZ2VDb250ZW50ID0gbS5wYWdlQ29udGFpbmVyLmZpbmQoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0aWFsIFNpemVzXG4gICAgICAgICAgICBtLnBhZ2VDb250ZW50UGFkZGluZyA9IHBhcnNlSW50KG0ucGFnZUNvbnRlbnQuY3NzKCdwYWRkaW5nLWJvdHRvbScpKTtcbiAgICAgICAgICAgIG0uaW5pdGlhbEJhckhlaWdodCA9IG0uY29udGFpbmVyWzBdLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgIG0uaW5pdGlhbEFyZWFIZWlnaHQgPSBtLnRleHRhcmVhWzBdLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFJlc2l6ZSB0ZXh0YXJlYVxuICAgICAgICAgICAgbS5zaXplVGV4dGFyZWEgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgLy8gUmVzZXRcbiAgICAgICAgICAgICAgICBtLnRleHRhcmVhLmNzcyh7J2hlaWdodCc6ICcnfSk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIGhlaWdodCA9IG0udGV4dGFyZWFbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgIHZhciBkaWZmID0gaGVpZ2h0IC0gbS50ZXh0YXJlYVswXS5jbGllbnRIZWlnaHQ7XG4gICAgICAgICAgICAgICAgdmFyIHNjcm9sbEhlaWdodCA9IG0udGV4dGFyZWFbMF0uc2Nyb2xsSGVpZ2h0O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBVcGRhdGVcbiAgICAgICAgICAgICAgICBpZiAoc2Nyb2xsSGVpZ2h0ICsgZGlmZiA+IGhlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3QXJlYUhlaWdodCA9IHNjcm9sbEhlaWdodCArIGRpZmY7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdCYXJIZWlnaHQgPSBtLmluaXRpYWxCYXJIZWlnaHQgKyAobmV3QXJlYUhlaWdodCAtIG0uaW5pdGlhbEFyZWFIZWlnaHQpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbWF4QmFySGVpZ2h0ID0gbS5wYXJhbXMubWF4SGVpZ2h0IHx8IG0uY29udGFpbmVyLnBhcmVudHMoJy52aWV3JylbMF0ub2Zmc2V0SGVpZ2h0IC0gODg7XG4gICAgICAgICAgICAgICAgICAgIGlmIChuZXdCYXJIZWlnaHQgPiBtYXhCYXJIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0JhckhlaWdodCA9IHBhcnNlSW50KG1heEJhckhlaWdodCwgMTApO1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3QXJlYUhlaWdodCA9IG5ld0JhckhlaWdodCAtIG0uaW5pdGlhbEJhckhlaWdodCArIG0uaW5pdGlhbEFyZWFIZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgbS50ZXh0YXJlYS5jc3MoJ2hlaWdodCcsIG5ld0FyZWFIZWlnaHQgKyAncHgnKTtcbiAgICAgICAgICAgICAgICAgICAgbS5jb250YWluZXIuY3NzKCdoZWlnaHQnLCBuZXdCYXJIZWlnaHQgKyAncHgnKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG9uQm90dG9tID0gKG0ucGFnZUNvbnRlbnRbMF0uc2Nyb2xsVG9wID09PSBtLnBhZ2VDb250ZW50WzBdLnNjcm9sbEhlaWdodCAtIG0ucGFnZUNvbnRlbnRbMF0ub2Zmc2V0SGVpZ2h0KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG0ucGFnZUNvbnRlbnQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbS5wYWdlQ29udGVudC5jc3MoJ3BhZGRpbmctYm90dG9tJywgbmV3QmFySGVpZ2h0ICsgJ3B4Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobS5wYWdlQ29udGVudC5maW5kKCcubWVzc2FnZXMtbmV3LWZpcnN0JykubGVuZ3RoID09PSAwICYmIG9uQm90dG9tKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbS5wYWdlQ29udGVudC5zY3JvbGxUb3AobS5wYWdlQ29udGVudFswXS5zY3JvbGxIZWlnaHQgLSBtLnBhZ2VDb250ZW50WzBdLm9mZnNldEhlaWdodCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtLnBhZ2VDb250ZW50Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG0uY29udGFpbmVyLmNzcyh7J2hlaWdodCc6ICcnLCAnYm90dG9tJzogJyd9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG0ucGFnZUNvbnRlbnQuY3NzKHsncGFkZGluZy1ib3R0b20nOiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gQ2xlYXJcbiAgICAgICAgICAgIG0uY2xlYXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgbS50ZXh0YXJlYS52YWwoJycpLnRyaWdnZXIoJ2NoYW5nZScpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG0udmFsdWUgPSBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG0udGV4dGFyZWEudmFsKCk7XG4gICAgICAgICAgICAgICAgZWxzZSBtLnRleHRhcmVhLnZhbCh2YWx1ZSkudHJpZ2dlcignY2hhbmdlJyk7ICBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEhhbmRsZSB0ZXh0YXJlYVxuICAgICAgICAgICAgbS50ZXh0YXJlYVRpbWVvdXQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICBtLmhhbmRsZVRleHRhcmVhID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQobS50ZXh0YXJlYVRpbWVvdXQpO1xuICAgICAgICAgICAgICAgIG0udGV4dGFyZWFUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIG0uc2l6ZVRleHRhcmVhKCk7XG4gICAgICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vRXZlbnRzXG4gICAgICAgICAgICBmdW5jdGlvbiBwcmV2ZW50U3VibWl0KGUpIHtcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgbS5hdHRhY2hFdmVudHMgPSBmdW5jdGlvbiAoZGVzdHJveSkge1xuICAgICAgICAgICAgICAgIHZhciBtZXRob2QgPSBkZXN0cm95ID8gJ29mZicgOiAnb24nO1xuICAgICAgICAgICAgICAgIG0uY29udGFpbmVyW21ldGhvZF0oJ3N1Ym1pdCcsIHByZXZlbnRTdWJtaXQpO1xuICAgICAgICAgICAgICAgIG0udGV4dGFyZWFbbWV0aG9kXSgnY2hhbmdlIGtleWRvd24ga2V5cHJlc3Mga2V5dXAgcGFzdGUgY3V0JywgbS5oYW5kbGVUZXh0YXJlYSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbS5kZXRhY2hFdmVudHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgbS5hdHRhY2hFdmVudHModHJ1ZSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0IERlc3Ryb3lcbiAgICAgICAgICAgIG0uaW5pdCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBtLmF0dGFjaEV2ZW50cygpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG0uZGVzdHJveSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBtLmRldGFjaEV2ZW50cygpO1xuICAgICAgICAgICAgICAgIG0gPSBudWxsO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0XG4gICAgICAgICAgICBtLmluaXQoKTtcbiAgICAgICAgXG4gICAgICAgICAgICBtLmNvbnRhaW5lclswXS5mN01lc3NhZ2ViYXIgPSBtO1xuICAgICAgICAgICAgcmV0dXJuIG07XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5tZXNzYWdlYmFyID0gZnVuY3Rpb24gKGNvbnRhaW5lciwgcGFyYW1zKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IE1lc3NhZ2ViYXIoY29udGFpbmVyLCBwYXJhbXMpO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuaW5pdFBhZ2VNZXNzYWdlYmFyID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgdmFyIG1lc3NhZ2ViYXIgPSBwYWdlQ29udGFpbmVyLmhhc0NsYXNzKCdtZXNzYWdlYmFyJykgPyBwYWdlQ29udGFpbmVyIDogcGFnZUNvbnRhaW5lci5maW5kKCcubWVzc2FnZWJhcicpO1xuICAgICAgICAgICAgaWYgKG1lc3NhZ2ViYXIubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoIW1lc3NhZ2ViYXIuaGFzQ2xhc3MoJ21lc3NhZ2ViYXItaW5pdCcpKSByZXR1cm47XG4gICAgICAgICAgICB2YXIgbWIgPSBhcHAubWVzc2FnZWJhcihtZXNzYWdlYmFyLCBtZXNzYWdlYmFyLmRhdGFzZXQoKSk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGVzdHJveSBvbiBwYWdlIHJlbW92ZVxuICAgICAgICAgICAgZnVuY3Rpb24gcGFnZUJlZm9yZVJlbW92ZSgpIHtcbiAgICAgICAgICAgICAgICBtYi5kZXN0cm95KCk7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5vZmYoJ3BhZ2VCZWZvcmVSZW1vdmUnLCBwYWdlQmVmb3JlUmVtb3ZlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmhhc0NsYXNzKCdwYWdlJykpIHtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyLm9uKCdwYWdlQmVmb3JlUmVtb3ZlJywgcGFnZUJlZm9yZVJlbW92ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgWEhSICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIC8vIFhIUiBDYWNoaW5nXG4gICAgICAgIGFwcC5jYWNoZSA9IFtdO1xuICAgICAgICBhcHAucmVtb3ZlRnJvbUNhY2hlID0gZnVuY3Rpb24gKHVybCkge1xuICAgICAgICAgICAgdmFyIGluZGV4ID0gZmFsc2U7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFwcC5jYWNoZS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmIChhcHAuY2FjaGVbaV0udXJsID09PSB1cmwpIGluZGV4ID0gaTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpbmRleCAhPT0gZmFsc2UpIGFwcC5jYWNoZS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLy8gWEhSXG4gICAgICAgIGFwcC54aHIgPSBmYWxzZTtcbiAgICAgICAgYXBwLmdldCA9IGZ1bmN0aW9uICh1cmwsIHZpZXcsIGlnbm9yZUNhY2hlLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgLy8gc2hvdWxkIHdlIGlnbm9yZSBnZXQgcGFyYW1zIG9yIG5vdFxuICAgICAgICAgICAgdmFyIF91cmwgPSB1cmw7XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5jYWNoZUlnbm9yZUdldFBhcmFtZXRlcnMgJiYgdXJsLmluZGV4T2YoJz8nKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgX3VybCA9IHVybC5zcGxpdCgnPycpWzBdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuY2FjaGUgJiYgIWlnbm9yZUNhY2hlICYmIHVybC5pbmRleE9mKCdub2NhY2hlJykgPCAwICYmIGFwcC5wYXJhbXMuY2FjaGVJZ25vcmUuaW5kZXhPZihfdXJsKSA8IDApIHtcbiAgICAgICAgICAgICAgICAvLyBDaGVjayBpcyB0aGUgdXJsIGNhY2hlZFxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXBwLmNhY2hlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHAuY2FjaGVbaV0udXJsID09PSBfdXJsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBleHBpcmF0aW9uXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoKG5ldyBEYXRlKCkpLmdldFRpbWUoKSAtIGFwcC5jYWNoZVtpXS50aW1lIDwgYXBwLnBhcmFtcy5jYWNoZUR1cmF0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCBmcm9tIGNhY2hlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soYXBwLmNhY2hlW2ldLmNvbnRlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBhcHAueGhyID0gJC5hamF4KHtcbiAgICAgICAgICAgICAgICB1cmw6IHVybCxcbiAgICAgICAgICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICAgICAgICAgIGJlZm9yZVNlbmQ6IGFwcC5wYXJhbXMub25BamF4U3RhcnQsXG4gICAgICAgICAgICAgICAgY29tcGxldGU6IGZ1bmN0aW9uICh4aHIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwKSB8fCB4aHIuc3RhdHVzID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5jYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5yZW1vdmVGcm9tQ2FjaGUoX3VybCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmNhY2hlLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IF91cmwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWU6IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IHhoci5yZXNwb25zZVRleHRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHhoci5yZXNwb25zZVRleHQsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHhoci5yZXNwb25zZVRleHQsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm9uQWpheENvbXBsZXRlKSBhcHAucGFyYW1zLm9uQWpheENvbXBsZXRlKHhocik7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24gKHhocikge1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayh4aHIucmVzcG9uc2VUZXh0LCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMub25BamF4RXJyb3IpIGFwcC5wYXJhbXMub25BamF4RXJyb3IoeGhyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmICh2aWV3KSB2aWV3LnhociA9IGFwcC54aHI7XG4gICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGFwcC54aHI7XG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIFBhZ2VzICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIC8vIFBhZ2UgQ2FsbGJhY2tzIEFQSVxuICAgICAgICBhcHAucGFnZUNhbGxiYWNrcyA9IHt9O1xuICAgICAgICBcbiAgICAgICAgYXBwLm9uUGFnZSA9IGZ1bmN0aW9uIChjYWxsYmFja05hbWUsIHBhZ2VOYW1lLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgaWYgKHBhZ2VOYW1lICYmIHBhZ2VOYW1lLnNwbGl0KCcgJykubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgIHZhciBwYWdlTmFtZXMgPSBwYWdlTmFtZS5zcGxpdCgnICcpO1xuICAgICAgICAgICAgICAgIHZhciByZXR1cm5DYWxsYmFja3MgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhZ2VOYW1lcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm5DYWxsYmFja3MucHVzaChhcHAub25QYWdlKGNhbGxiYWNrTmFtZSwgcGFnZU5hbWVzW2ldLCBjYWxsYmFjaykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm5DYWxsYmFja3MucmVtb3ZlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJldHVybkNhbGxiYWNrcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuQ2FsbGJhY2tzW2ldLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICByZXR1cm5DYWxsYmFja3MudHJpZ2dlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZXR1cm5DYWxsYmFja3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybkNhbGxiYWNrc1tpXS50cmlnZ2VyKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHJldHVybiByZXR1cm5DYWxsYmFja3M7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgY2FsbGJhY2tzID0gYXBwLnBhZ2VDYWxsYmFja3NbY2FsbGJhY2tOYW1lXVtwYWdlTmFtZV07XG4gICAgICAgICAgICBpZiAoIWNhbGxiYWNrcykge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrcyA9IGFwcC5wYWdlQ2FsbGJhY2tzW2NhbGxiYWNrTmFtZV1bcGFnZU5hbWVdID0gW107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhcHAucGFnZUNhbGxiYWNrc1tjYWxsYmFja05hbWVdW3BhZ2VOYW1lXS5wdXNoKGNhbGxiYWNrKTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciByZW1vdmVJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjYWxsYmFja3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja3NbaV0udG9TdHJpbmcoKSA9PT0gY2FsbGJhY2sudG9TdHJpbmcoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZUluZGV4ID0gaTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlbW92ZUluZGV4ICE9PSAndW5kZWZpbmVkJykgY2FsbGJhY2tzLnNwbGljZShyZW1vdmVJbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB0cmlnZ2VyOiBjYWxsYmFja1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8vQ3JlYXRlIGNhbGxiYWNrcyBtZXRob2RzIGR5bmFtaWNhbGx5XG4gICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVBhZ2VDYWxsYmFjayhjYWxsYmFja05hbWUpIHtcbiAgICAgICAgICAgIHZhciBjYXBpdGFsaXplZCA9IGNhbGxiYWNrTmFtZS5yZXBsYWNlKC9eLi8sIGZ1bmN0aW9uIChtYXRjaCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaC50b1VwcGVyQ2FzZSgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBhcHBbJ29uUGFnZScgKyBjYXBpdGFsaXplZF0gPSBmdW5jdGlvbiAocGFnZU5hbWUsIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFwcC5vblBhZ2UoY2FsbGJhY2tOYW1lLCBwYWdlTmFtZSwgY2FsbGJhY2spO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgdmFyIHBhZ2VDYWxsYmFja3NOYW1lcyA9ICgnYmVmb3JlSW5pdCBpbml0IHJlaW5pdCBiZWZvcmVBbmltYXRpb24gYWZ0ZXJBbmltYXRpb24gYmFjayBhZnRlckJhY2sgYmVmb3JlUmVtb3ZlJykuc3BsaXQoJyAnKTtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYWdlQ2FsbGJhY2tzTmFtZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGFwcC5wYWdlQ2FsbGJhY2tzW3BhZ2VDYWxsYmFja3NOYW1lc1tpXV0gPSB7fTtcbiAgICAgICAgICAgIGNyZWF0ZVBhZ2VDYWxsYmFjayhwYWdlQ2FsbGJhY2tzTmFtZXNbaV0pO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBhcHAudHJpZ2dlclBhZ2VDYWxsYmFja3MgPSBmdW5jdGlvbiAoY2FsbGJhY2tOYW1lLCBwYWdlTmFtZSwgcGFnZURhdGEpIHtcbiAgICAgICAgICAgIHZhciBhbGxQYWdlc0NhbGxiYWNrcyA9IGFwcC5wYWdlQ2FsbGJhY2tzW2NhbGxiYWNrTmFtZV1bJyonXTtcbiAgICAgICAgICAgIGlmIChhbGxQYWdlc0NhbGxiYWNrcykge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYWxsUGFnZXNDYWxsYmFja3MubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgYWxsUGFnZXNDYWxsYmFja3Nbal0ocGFnZURhdGEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBhcHAucGFnZUNhbGxiYWNrc1tjYWxsYmFja05hbWVdW3BhZ2VOYW1lXTtcbiAgICAgICAgICAgIGlmICghY2FsbGJhY2tzIHx8IGNhbGxiYWNrcy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2FsbGJhY2tzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tzW2ldKHBhZ2VEYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8vIE9uIFBhZ2UgSW5pdCBDYWxsYmFja1xuICAgICAgICBhcHAucGFnZUluaXRDYWxsYmFjayA9IGZ1bmN0aW9uICh2aWV3LCBwYXJhbXMpIHtcbiAgICAgICAgICAgIHZhciBwYWdlQ29udGFpbmVyID0gcGFyYW1zLnBhZ2VDb250YWluZXI7XG4gICAgICAgICAgICBpZiAocGFnZUNvbnRhaW5lci5mN1BhZ2VJbml0aWFsaXplZCAmJiB2aWV3ICYmICF2aWV3LnBhcmFtcy5kb21DYWNoZSkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBwYWdlUXVlcnkgPSBwYXJhbXMucXVlcnk7XG4gICAgICAgICAgICBpZiAoIXBhZ2VRdWVyeSkge1xuICAgICAgICAgICAgICAgIGlmIChwYXJhbXMudXJsICYmIHBhcmFtcy51cmwuaW5kZXhPZignPycpID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBwYWdlUXVlcnkgPSAkLnBhcnNlVXJsUXVlcnkocGFyYW1zLnVybCB8fCAnJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YSAmJiBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEucXVlcnkpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZVF1ZXJ5ID0gcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhLnF1ZXJ5O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZVF1ZXJ5ID0ge307XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBhZ2UgRGF0YVxuICAgICAgICAgICAgdmFyIHBhZ2VEYXRhID0ge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lcjogcGFnZUNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICB1cmw6IHBhcmFtcy51cmwsXG4gICAgICAgICAgICAgICAgcXVlcnk6IHBhZ2VRdWVyeSxcbiAgICAgICAgICAgICAgICBuYW1lOiAkKHBhZ2VDb250YWluZXIpLmF0dHIoJ2RhdGEtcGFnZScpLFxuICAgICAgICAgICAgICAgIHZpZXc6IHZpZXcsXG4gICAgICAgICAgICAgICAgZnJvbTogcGFyYW1zLnBvc2l0aW9uLFxuICAgICAgICAgICAgICAgIGNvbnRleHQ6IHBhcmFtcy5jb250ZXh0LFxuICAgICAgICAgICAgICAgIG5hdmJhcklubmVyQ29udGFpbmVyOiBwYXJhbXMubmF2YmFySW5uZXJDb250YWluZXIsXG4gICAgICAgICAgICAgICAgZnJvbVBhZ2U6IHBhcmFtcy5mcm9tUGFnZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGlmIChwYXJhbXMuZnJvbVBhZ2UgJiYgIXBhcmFtcy5mcm9tUGFnZS5uYXZiYXJJbm5lckNvbnRhaW5lciAmJiBwYXJhbXMub2xkTmF2YmFySW5uZXJDb250YWluZXIpIHtcbiAgICAgICAgICAgICAgICBwYXJhbXMuZnJvbVBhZ2UubmF2YmFySW5uZXJDb250YWluZXIgPSBwYXJhbXMub2xkTmF2YmFySW5uZXJDb250YWluZXI7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHBhZ2VDb250YWluZXIuZjdQYWdlSW5pdGlhbGl6ZWQgJiYgKCh2aWV3ICYmIHZpZXcucGFyYW1zLmRvbUNhY2hlKSB8fCAoIXZpZXcgJiYgJChwYWdlQ29udGFpbmVyKS5wYXJlbnRzKCcucG9wdXAsIC5wb3BvdmVyLCAubG9naW4tc2NyZWVuLCAubW9kYWwsIC5hY3Rpb25zLW1vZGFsLCAucGlja2VyLW1vZGFsJykubGVuZ3RoID4gMCkpKSB7XG4gICAgICAgICAgICAgICAgLy8gUmVpbml0IFBhZ2VcbiAgICAgICAgICAgICAgICBhcHAucmVpbml0UGFnZShwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gQ2FsbGJhY2tzXG4gICAgICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ3BhZ2VSZWluaXQnLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMub25QYWdlUmVpbml0KSBhcHAucGFyYW1zLm9uUGFnZVJlaW5pdChhcHAsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICAgICBhcHAudHJpZ2dlclBhZ2VDYWxsYmFja3MoJ3JlaW5pdCcsIHBhZ2VEYXRhLm5hbWUsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICAgICAkKHBhZ2VEYXRhLmNvbnRhaW5lcikudHJpZ2dlcigncGFnZVJlaW5pdCcsIHtwYWdlOiBwYWdlRGF0YX0pO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIuZjdQYWdlSW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFN0b3JlIHBhZ2VkYXRhIGluIHBhZ2VcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YSA9IHBhZ2VEYXRhO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFVwZGF0ZSBWaWV3J3MgYWN0aXZlUGFnZVxuICAgICAgICAgICAgaWYgKHZpZXcgJiYgIXBhcmFtcy5wcmVsb2FkT25seSAmJiAhcGFyYW1zLnJlbG9hZFByZXZpb3VzKSB7XG4gICAgICAgICAgICAgICAgLy8gQWRkIGRhdGEtcGFnZSBvbiB2aWV3XG4gICAgICAgICAgICAgICAgJCh2aWV3LmNvbnRhaW5lcikuYXR0cignZGF0YS1wYWdlJywgcGFnZURhdGEubmFtZSk7XG4gICAgICAgICAgICAgICAgLy8gVXBkYXRlIFZpZXcgYWN0aXZlIHBhZ2UgZGF0YVxuICAgICAgICAgICAgICAgIHZpZXcuYWN0aXZlUGFnZSA9IHBhZ2VEYXRhO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIEJlZm9yZSBJbml0IENhbGxiYWNrc1xuICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ3BhZ2VCZWZvcmVJbml0JywgcGFnZURhdGEpO1xuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMub25QYWdlQmVmb3JlSW5pdCkgYXBwLnBhcmFtcy5vblBhZ2VCZWZvcmVJbml0KGFwcCwgcGFnZURhdGEpO1xuICAgICAgICAgICAgYXBwLnRyaWdnZXJQYWdlQ2FsbGJhY2tzKCdiZWZvcmVJbml0JywgcGFnZURhdGEubmFtZSwgcGFnZURhdGEpO1xuICAgICAgICAgICAgJChwYWdlRGF0YS5jb250YWluZXIpLnRyaWdnZXIoJ3BhZ2VCZWZvcmVJbml0Jywge3BhZ2U6IHBhZ2VEYXRhfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBwYWdlXG4gICAgICAgICAgICBhcHAuaW5pdFBhZ2UocGFnZUNvbnRhaW5lcik7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBDYWxsYmFja1xuICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ3BhZ2VJbml0JywgcGFnZURhdGEpO1xuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMub25QYWdlSW5pdCkgYXBwLnBhcmFtcy5vblBhZ2VJbml0KGFwcCwgcGFnZURhdGEpO1xuICAgICAgICAgICAgYXBwLnRyaWdnZXJQYWdlQ2FsbGJhY2tzKCdpbml0JywgcGFnZURhdGEubmFtZSwgcGFnZURhdGEpO1xuICAgICAgICAgICAgJChwYWdlRGF0YS5jb250YWluZXIpLnRyaWdnZXIoJ3BhZ2VJbml0Jywge3BhZ2U6IHBhZ2VEYXRhfSk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5wYWdlUmVtb3ZlQ2FsbGJhY2sgPSBmdW5jdGlvbiAodmlldywgcGFnZUNvbnRhaW5lciwgcG9zaXRpb24pIHtcbiAgICAgICAgICAgIHZhciBwYWdlQ29udGV4dDtcbiAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEpIHBhZ2VDb250ZXh0ID0gcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhLmNvbnRleHQ7XG4gICAgICAgICAgICAvLyBQYWdlIERhdGFcbiAgICAgICAgICAgIHZhciBwYWdlRGF0YSA9IHtcbiAgICAgICAgICAgICAgICBjb250YWluZXI6IHBhZ2VDb250YWluZXIsXG4gICAgICAgICAgICAgICAgbmFtZTogJChwYWdlQ29udGFpbmVyKS5hdHRyKCdkYXRhLXBhZ2UnKSxcbiAgICAgICAgICAgICAgICB2aWV3OiB2aWV3LFxuICAgICAgICAgICAgICAgIHVybDogcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhICYmIHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YS51cmwsXG4gICAgICAgICAgICAgICAgcXVlcnk6IHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YSAmJiBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEucXVlcnksXG4gICAgICAgICAgICAgICAgbmF2YmFySW5uZXJDb250YWluZXI6IHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YSAmJiBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEubmF2YmFySW5uZXJDb250YWluZXIsXG4gICAgICAgICAgICAgICAgZnJvbTogcG9zaXRpb24sXG4gICAgICAgICAgICAgICAgY29udGV4dDogcGFnZUNvbnRleHRcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICAvLyBCZWZvcmUgSW5pdCBDYWxsYmFja1xuICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ3BhZ2VCZWZvcmVSZW1vdmUnLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5vblBhZ2VCZWZvcmVSZW1vdmUpIGFwcC5wYXJhbXMub25QYWdlQmVmb3JlUmVtb3ZlKGFwcCwgcGFnZURhdGEpO1xuICAgICAgICAgICAgYXBwLnRyaWdnZXJQYWdlQ2FsbGJhY2tzKCdiZWZvcmVSZW1vdmUnLCBwYWdlRGF0YS5uYW1lLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAkKHBhZ2VEYXRhLmNvbnRhaW5lcikudHJpZ2dlcigncGFnZUJlZm9yZVJlbW92ZScsIHtwYWdlOiBwYWdlRGF0YX0pO1xuICAgICAgICB9O1xuICAgICAgICBhcHAucGFnZUJhY2tDYWxsYmFjayA9IGZ1bmN0aW9uIChjYWxsYmFjaywgdmlldywgcGFyYW1zKSB7XG4gICAgICAgICAgICAvLyBQYWdlIERhdGFcbiAgICAgICAgICAgIHZhciBwYWdlQ29udGFpbmVyID0gcGFyYW1zLnBhZ2VDb250YWluZXI7XG4gICAgICAgICAgICB2YXIgcGFnZUNvbnRleHQ7XG4gICAgICAgICAgICBpZiAocGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhKSBwYWdlQ29udGV4dCA9IHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YS5jb250ZXh0O1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBwYWdlRGF0YSA9IHtcbiAgICAgICAgICAgICAgICBjb250YWluZXI6IHBhZ2VDb250YWluZXIsXG4gICAgICAgICAgICAgICAgbmFtZTogJChwYWdlQ29udGFpbmVyKS5hdHRyKCdkYXRhLXBhZ2UnKSxcbiAgICAgICAgICAgICAgICB1cmw6IHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YSAmJiBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEudXJsLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEgJiYgcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhLnF1ZXJ5LFxuICAgICAgICAgICAgICAgIHZpZXc6IHZpZXcsXG4gICAgICAgICAgICAgICAgZnJvbTogcGFyYW1zLnBvc2l0aW9uLFxuICAgICAgICAgICAgICAgIGNvbnRleHQ6IHBhZ2VDb250ZXh0LFxuICAgICAgICAgICAgICAgIG5hdmJhcklubmVyQ29udGFpbmVyOiBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEgJiYgcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhLm5hdmJhcklubmVyQ29udGFpbmVyLFxuICAgICAgICAgICAgICAgIHN3aXBlQmFjazogcGFyYW1zLnN3aXBlQmFja1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoY2FsbGJhY2sgPT09ICdhZnRlcicpIHtcbiAgICAgICAgICAgICAgICBhcHAucGx1Z2luSG9vaygncGFnZUFmdGVyQmFjaycsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5vblBhZ2VBZnRlckJhY2spIGFwcC5wYXJhbXMub25QYWdlQWZ0ZXJCYWNrKGFwcCwgcGFnZURhdGEpO1xuICAgICAgICAgICAgICAgIGFwcC50cmlnZ2VyUGFnZUNhbGxiYWNrcygnYWZ0ZXJCYWNrJywgcGFnZURhdGEubmFtZSwgcGFnZURhdGEpO1xuICAgICAgICAgICAgICAgICQocGFnZUNvbnRhaW5lcikudHJpZ2dlcigncGFnZUFmdGVyQmFjaycsIHtwYWdlOiBwYWdlRGF0YX0pO1xuICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gJ2JlZm9yZScpIHtcbiAgICAgICAgICAgICAgICBhcHAucGx1Z2luSG9vaygncGFnZUJhY2snLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMub25QYWdlQmFjaykgYXBwLnBhcmFtcy5vblBhZ2VCYWNrKGFwcCwgcGFnZURhdGEpO1xuICAgICAgICAgICAgICAgIGFwcC50cmlnZ2VyUGFnZUNhbGxiYWNrcygnYmFjaycsIHBhZ2VEYXRhLm5hbWUsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICAgICAkKHBhZ2VEYXRhLmNvbnRhaW5lcikudHJpZ2dlcigncGFnZUJhY2snLCB7cGFnZTogcGFnZURhdGF9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnBhZ2VBbmltQ2FsbGJhY2sgPSBmdW5jdGlvbiAoY2FsbGJhY2ssIHZpZXcsIHBhcmFtcykge1xuICAgICAgICAgICAgdmFyIHBhZ2VDb250YWluZXIgPSBwYXJhbXMucGFnZUNvbnRhaW5lcjtcbiAgICAgICAgICAgIHZhciBwYWdlQ29udGV4dDtcbiAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEpIHBhZ2VDb250ZXh0ID0gcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhLmNvbnRleHQ7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHBhZ2VRdWVyeSA9IHBhcmFtcy5xdWVyeTtcbiAgICAgICAgICAgIGlmICghcGFnZVF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhcmFtcy51cmwgJiYgcGFyYW1zLnVybC5pbmRleE9mKCc/JykgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VRdWVyeSA9ICQucGFyc2VVcmxRdWVyeShwYXJhbXMudXJsIHx8ICcnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAocGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhICYmIHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YS5xdWVyeSkge1xuICAgICAgICAgICAgICAgICAgICBwYWdlUXVlcnkgPSBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEucXVlcnk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwYWdlUXVlcnkgPSB7fTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBQYWdlIERhdGFcbiAgICAgICAgICAgIHZhciBwYWdlRGF0YSA9IHtcbiAgICAgICAgICAgICAgICBjb250YWluZXI6IHBhZ2VDb250YWluZXIsXG4gICAgICAgICAgICAgICAgdXJsOiBwYXJhbXMudXJsLFxuICAgICAgICAgICAgICAgIHF1ZXJ5OiBwYWdlUXVlcnksXG4gICAgICAgICAgICAgICAgbmFtZTogJChwYWdlQ29udGFpbmVyKS5hdHRyKCdkYXRhLXBhZ2UnKSxcbiAgICAgICAgICAgICAgICB2aWV3OiB2aWV3LFxuICAgICAgICAgICAgICAgIGZyb206IHBhcmFtcy5wb3NpdGlvbixcbiAgICAgICAgICAgICAgICBjb250ZXh0OiBwYWdlQ29udGV4dCxcbiAgICAgICAgICAgICAgICBzd2lwZUJhY2s6IHBhcmFtcy5zd2lwZUJhY2ssXG4gICAgICAgICAgICAgICAgbmF2YmFySW5uZXJDb250YWluZXI6IHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YSAmJiBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEubmF2YmFySW5uZXJDb250YWluZXIsXG4gICAgICAgICAgICAgICAgZnJvbVBhZ2U6IHBhcmFtcy5mcm9tUGFnZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZhciBvbGRQYWdlID0gcGFyYW1zLm9sZFBhZ2UsXG4gICAgICAgICAgICAgICAgbmV3UGFnZSA9IHBhcmFtcy5uZXdQYWdlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFVwZGF0ZSBwYWdlIGRhdGVcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YSA9IHBhZ2VEYXRhO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gJ2FmdGVyJykge1xuICAgICAgICAgICAgICAgIGFwcC5wbHVnaW5Ib29rKCdwYWdlQWZ0ZXJBbmltYXRpb24nLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMub25QYWdlQWZ0ZXJBbmltYXRpb24pIGFwcC5wYXJhbXMub25QYWdlQWZ0ZXJBbmltYXRpb24oYXBwLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAgICAgYXBwLnRyaWdnZXJQYWdlQ2FsbGJhY2tzKCdhZnRlckFuaW1hdGlvbicsIHBhZ2VEYXRhLm5hbWUsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICAgICAkKHBhZ2VEYXRhLmNvbnRhaW5lcikudHJpZ2dlcigncGFnZUFmdGVyQW5pbWF0aW9uJywge3BhZ2U6IHBhZ2VEYXRhfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNhbGxiYWNrID09PSAnYmVmb3JlJykge1xuICAgICAgICAgICAgICAgIC8vIEFkZCBkYXRhLXBhZ2Ugb24gdmlld1xuICAgICAgICAgICAgICAgICQodmlldy5jb250YWluZXIpLmF0dHIoJ2RhdGEtcGFnZScsIHBhZ2VEYXRhLm5hbWUpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVmlldydzIGFjdGl2ZVBhZ2VcbiAgICAgICAgICAgICAgICBpZiAodmlldykgdmlldy5hY3RpdmVQYWdlID0gcGFnZURhdGE7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIEhpZGUvc2hvdyBuYXZiYXIgZHluYW1pY2FsbHlcbiAgICAgICAgICAgICAgICBpZiAobmV3UGFnZS5oYXNDbGFzcygnbm8tbmF2YmFyJykgJiYgIW9sZFBhZ2UuaGFzQ2xhc3MoJ25vLW5hdmJhcicpKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuaGlkZU5hdmJhcigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIW5ld1BhZ2UuaGFzQ2xhc3MoJ25vLW5hdmJhcicpICYmIChvbGRQYWdlLmhhc0NsYXNzKCduby1uYXZiYXInKSB8fCBvbGRQYWdlLmhhc0NsYXNzKCduby1uYXZiYXItYnktc2Nyb2xsJykpKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuc2hvd05hdmJhcigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBIaWRlL3Nob3cgbmF2YmFyIHRvb2xiYXJcbiAgICAgICAgICAgICAgICBpZiAobmV3UGFnZS5oYXNDbGFzcygnbm8tdG9vbGJhcicpICYmICFvbGRQYWdlLmhhc0NsYXNzKCduby10b29sYmFyJykpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5oaWRlVG9vbGJhcigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIW5ld1BhZ2UuaGFzQ2xhc3MoJ25vLXRvb2xiYXInKSAmJiAob2xkUGFnZS5oYXNDbGFzcygnbm8tdG9vbGJhcicpIHx8IG9sZFBhZ2UuaGFzQ2xhc3MoJ25vLXRvb2xiYXItYnktc2Nyb2xsJykpKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuc2hvd1Rvb2xiYXIoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gSGlkZS9zaG93IHRhYmJhclxuICAgICAgICAgICAgICAgIHZhciB0YWJCYXI7XG4gICAgICAgICAgICAgICAgaWYgKG5ld1BhZ2UuaGFzQ2xhc3MoJ25vLXRhYmJhcicpICYmICFvbGRQYWdlLmhhc0NsYXNzKCduby10YWJiYXInKSkge1xuICAgICAgICAgICAgICAgICAgICB0YWJCYXIgPSAkKHZpZXcuY29udGFpbmVyKS5maW5kKCcudGFiYmFyJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0YWJCYXIubGVuZ3RoID09PSAwKSB0YWJCYXIgPSAkKHZpZXcuY29udGFpbmVyKS5wYXJlbnRzKCcuJyArIGFwcC5wYXJhbXMudmlld3NDbGFzcykuZmluZCgnLnRhYmJhcicpO1xuICAgICAgICAgICAgICAgICAgICBhcHAuaGlkZVRvb2xiYXIodGFiQmFyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFuZXdQYWdlLmhhc0NsYXNzKCduby10YWJiYXInKSAmJiAob2xkUGFnZS5oYXNDbGFzcygnbm8tdGFiYmFyJykgfHwgb2xkUGFnZS5oYXNDbGFzcygnbm8tdGFiYmFyLWJ5LXNjcm9sbCcpKSkge1xuICAgICAgICAgICAgICAgICAgICB0YWJCYXIgPSAkKHZpZXcuY29udGFpbmVyKS5maW5kKCcudGFiYmFyJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0YWJCYXIubGVuZ3RoID09PSAwKSB0YWJCYXIgPSAkKHZpZXcuY29udGFpbmVyKS5wYXJlbnRzKCcuJyArIGFwcC5wYXJhbXMudmlld3NDbGFzcykuZmluZCgnLnRhYmJhcicpO1xuICAgICAgICAgICAgICAgICAgICBhcHAuc2hvd1Rvb2xiYXIodGFiQmFyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIG9sZFBhZ2UucmVtb3ZlQ2xhc3MoJ25vLW5hdmJhci1ieS1zY3JvbGwgbm8tdG9vbGJhci1ieS1zY3JvbGwnKTtcbiAgICAgICAgICAgICAgICAvLyBDYWxsYmFja3NcbiAgICAgICAgICAgICAgICBhcHAucGx1Z2luSG9vaygncGFnZUJlZm9yZUFuaW1hdGlvbicsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5vblBhZ2VCZWZvcmVBbmltYXRpb24pIGFwcC5wYXJhbXMub25QYWdlQmVmb3JlQW5pbWF0aW9uKGFwcCwgcGFnZURhdGEpO1xuICAgICAgICAgICAgICAgIGFwcC50cmlnZ2VyUGFnZUNhbGxiYWNrcygnYmVmb3JlQW5pbWF0aW9uJywgcGFnZURhdGEubmFtZSwgcGFnZURhdGEpO1xuICAgICAgICAgICAgICAgICQocGFnZURhdGEuY29udGFpbmVyKS50cmlnZ2VyKCdwYWdlQmVmb3JlQW5pbWF0aW9uJywge3BhZ2U6IHBhZ2VEYXRhfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvLyBJbml0IFBhZ2UgRXZlbnRzIGFuZCBNYW5pcHVsYXRpb25zXG4gICAgICAgIGFwcC5pbml0UGFnZSA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgLy8gU2l6ZSBuYXZiYXJzIG9uIHBhZ2UgbG9hZFxuICAgICAgICAgICAgaWYgKGFwcC5zaXplTmF2YmFycykgYXBwLnNpemVOYXZiYXJzKHBhZ2VDb250YWluZXIucGFyZW50cygnLicgKyBhcHAucGFyYW1zLnZpZXdDbGFzcylbMF0pO1xuICAgICAgICAgICAgLy8gSW5pdCBtZXNzYWdlc1xuICAgICAgICAgICAgaWYgKGFwcC5pbml0UGFnZU1lc3NhZ2VzKSBhcHAuaW5pdFBhZ2VNZXNzYWdlcyhwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIC8vIEluaXQgZm9ybXMgc3RvcmFnZVxuICAgICAgICAgICAgaWYgKGFwcC5pbml0Rm9ybXNTdG9yYWdlKSBhcHAuaW5pdEZvcm1zU3RvcmFnZShwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIC8vIEluaXQgc21hcnQgc2VsZWN0XG4gICAgICAgICAgICBpZiAoYXBwLmluaXRTbWFydFNlbGVjdHMpIGFwcC5pbml0U21hcnRTZWxlY3RzKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgLy8gSW5pdCBzbGlkZXJcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdFBhZ2VTd2lwZXIpIGFwcC5pbml0UGFnZVN3aXBlcihwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIC8vIEluaXQgcHVsbCB0byByZWZyZXNcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdFB1bGxUb1JlZnJlc2gpIGFwcC5pbml0UHVsbFRvUmVmcmVzaChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIC8vIEluaXQgaW5maW5pdGUgc2Nyb2xsXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRQYWdlSW5maW5pdGVTY3JvbGwpIGFwcC5pbml0UGFnZUluZmluaXRlU2Nyb2xsKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgLy8gSW5pdCBzZWFyY2hiYXJcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdFNlYXJjaGJhcikgYXBwLmluaXRTZWFyY2hiYXIocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICAvLyBJbml0IG1lc3NhZ2UgYmFyXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRQYWdlTWVzc2FnZWJhcikgYXBwLmluaXRQYWdlTWVzc2FnZWJhcihwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIC8vIEluaXQgc2Nyb2xsIHRvb2xiYXJzXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRQYWdlU2Nyb2xsVG9vbGJhcnMpIGFwcC5pbml0UGFnZVNjcm9sbFRvb2xiYXJzKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgLy8gSW5pdCBsYXp5IGltYWdlc1xuICAgICAgICAgICAgaWYgKGFwcC5pbml0SW1hZ2VzTGF6eUxvYWQpIGFwcC5pbml0SW1hZ2VzTGF6eUxvYWQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICAvLyBJbml0IHByb2dyZXNzIGJhcnNcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdFBhZ2VQcm9ncmVzc2JhcikgYXBwLmluaXRQYWdlUHJvZ3Jlc3NiYXIocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICAvLyBJbml0IHJlc2l6ZWFibGUgdGV4dGFyZWFzXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRQYWdlUmVzaXphYmxlVGV4dGFyZWEpIGFwcC5pbml0UGFnZVJlc2l6YWJsZVRleHRhcmVhKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgLy8gSW5pdCBNYXRlcmlhbCBQcmVsb2FkZXJcbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsICYmIGFwcC5pbml0UGFnZU1hdGVyaWFsUHJlbG9hZGVyKSBhcHAuaW5pdFBhZ2VNYXRlcmlhbFByZWxvYWRlcihwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIC8vIEluaXQgTWF0ZXJpYWwgSW5wdXRzXG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBhcHAuaW5pdFBhZ2VNYXRlcmlhbElucHV0cykgYXBwLmluaXRQYWdlTWF0ZXJpYWxJbnB1dHMocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICAvLyBJbml0IE1hdGVyaWFsIFRhYmJhclxuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwgJiYgYXBwLmluaXRQYWdlTWF0ZXJpYWxUYWJiYXIpIGFwcC5pbml0UGFnZU1hdGVyaWFsVGFiYmFyKHBhZ2VDb250YWluZXIpO1xuICAgICAgICB9O1xuICAgICAgICBhcHAucmVpbml0UGFnZSA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgLy8gU2l6ZSBuYXZiYXJzIG9uIHBhZ2UgcmVpbml0XG4gICAgICAgICAgICBpZiAoYXBwLnNpemVOYXZiYXJzKSBhcHAuc2l6ZU5hdmJhcnMocGFnZUNvbnRhaW5lci5wYXJlbnRzKCcuJyArIGFwcC5wYXJhbXMudmlld0NsYXNzKVswXSk7XG4gICAgICAgICAgICAvLyBSZWluaXQgc2xpZGVyXG4gICAgICAgICAgICBpZiAoYXBwLnJlaW5pdFBhZ2VTd2lwZXIpIGFwcC5yZWluaXRQYWdlU3dpcGVyKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgLy8gUmVpbml0IGxhenkgbG9hZFxuICAgICAgICAgICAgaWYgKGFwcC5yZWluaXRMYXp5TG9hZCkgYXBwLnJlaW5pdExhenlMb2FkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuaW5pdFBhZ2VXaXRoQ2FsbGJhY2sgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICB2YXIgdmlld0NvbnRhaW5lciA9IHBhZ2VDb250YWluZXIucGFyZW50cygnLicgKyBhcHAucGFyYW1zLnZpZXdDbGFzcyk7XG4gICAgICAgICAgICBpZiAodmlld0NvbnRhaW5lci5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIHZhciB2aWV3ID0gdmlld0NvbnRhaW5lclswXS5mN1ZpZXcgfHwgdW5kZWZpbmVkO1xuICAgICAgICAgICAgdmFyIHVybCA9IHZpZXcgJiYgdmlldy51cmwgPyB2aWV3LnVybCA6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIGlmICh2aWV3Q29udGFpbmVyICYmIHBhZ2VDb250YWluZXIuYXR0cignZGF0YS1wYWdlJykpIHtcbiAgICAgICAgICAgICAgICB2aWV3Q29udGFpbmVyLmF0dHIoJ2RhdGEtcGFnZScsIHBhZ2VDb250YWluZXIuYXR0cignZGF0YS1wYWdlJykpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXBwLnBhZ2VJbml0Q2FsbGJhY2sodmlldywge3BhZ2VDb250YWluZXI6IHBhZ2VDb250YWluZXJbMF0sIHVybDogdXJsLCBwb3NpdGlvbjogJ2NlbnRlcid9KTtcbiAgICAgICAgfTtcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBOYXZpZ2F0aW9uIC8gUm91dGVyICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5yb3V0ZXIgPSB7XG4gICAgICAgICAgICAvLyBUZW1wb3JhcnkgRE9NIEVsZW1lbnRcbiAgICAgICAgICAgIHRlbXBvcmFyeURvbTogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksXG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRmluZCBwYWdlIG9yIG5hdmJhciBpbiBwYXNzZWQgY29udGFpbmVyIHdoaWNoIGFyZSByZWxhdGVkIHRvIFZpZXdcbiAgICAgICAgICAgIGZpbmRFbGVtZW50OiBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRhaW5lciwgdmlldywgbm90Q2FjaGVkKSB7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyID0gJChjb250YWluZXIpO1xuICAgICAgICAgICAgICAgIGlmIChub3RDYWNoZWQpIHNlbGVjdG9yID0gc2VsZWN0b3IgKyAnOm5vdCguY2FjaGVkKSc7XG4gICAgICAgICAgICAgICAgdmFyIGZvdW5kID0gY29udGFpbmVyLmZpbmQoc2VsZWN0b3IpO1xuICAgICAgICAgICAgICAgIGlmIChmb3VuZC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygdmlldy5zZWxlY3RvciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNlYXJjaCBpbiByZWxhdGVkIHZpZXdcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kID0gY29udGFpbmVyLmZpbmQodmlldy5zZWxlY3RvciArICcgJyArIHNlbGVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoZm91bmQubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2VhcmNoIGluIG1haW4gdmlld1xuICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBjb250YWluZXIuZmluZCgnLicgKyBhcHAucGFyYW1zLnZpZXdNYWluQ2xhc3MgKyAnICcgKyBzZWxlY3Rvcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGZvdW5kLmxlbmd0aCA9PT0gMSkgcmV0dXJuIGZvdW5kO1xuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBUcnkgdG8gZmluZCBub24gY2FjaGVkXG4gICAgICAgICAgICAgICAgICAgIGlmICghbm90Q2FjaGVkKSBmb3VuZCA9IGFwcC5yb3V0ZXIuZmluZEVsZW1lbnQoc2VsZWN0b3IsIGNvbnRhaW5lciwgdmlldywgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmb3VuZCAmJiBmb3VuZC5sZW5ndGggPT09IDEpIHJldHVybiBmb3VuZDtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2V0IHBhZ2VzIGNsYXNzZXNzIGZvciBhbmltYXRpb25FbmRcbiAgICAgICAgICAgIGFuaW1hdGVQYWdlczogZnVuY3Rpb24gKGxlZnRQYWdlLCByaWdodFBhZ2UsIGRpcmVjdGlvbiwgdmlldykge1xuICAgICAgICAgICAgICAgIC8vIExvYWRpbmcgbmV3IHBhZ2VcbiAgICAgICAgICAgICAgICB2YXIgcmVtb3ZlQ2xhc3NlcyA9ICdwYWdlLW9uLWNlbnRlciBwYWdlLW9uLXJpZ2h0IHBhZ2Utb24tbGVmdCc7XG4gICAgICAgICAgICAgICAgaWYgKGRpcmVjdGlvbiA9PT0gJ3RvLWxlZnQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGxlZnRQYWdlLnJlbW92ZUNsYXNzKHJlbW92ZUNsYXNzZXMpLmFkZENsYXNzKCdwYWdlLWZyb20tY2VudGVyLXRvLWxlZnQnKTtcbiAgICAgICAgICAgICAgICAgICAgcmlnaHRQYWdlLnJlbW92ZUNsYXNzKHJlbW92ZUNsYXNzZXMpLmFkZENsYXNzKCdwYWdlLWZyb20tcmlnaHQtdG8tY2VudGVyJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIEdvIGJhY2tcbiAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAndG8tcmlnaHQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGxlZnRQYWdlLnJlbW92ZUNsYXNzKHJlbW92ZUNsYXNzZXMpLmFkZENsYXNzKCdwYWdlLWZyb20tbGVmdC10by1jZW50ZXInKTtcbiAgICAgICAgICAgICAgICAgICAgcmlnaHRQYWdlLnJlbW92ZUNsYXNzKHJlbW92ZUNsYXNzZXMpLmFkZENsYXNzKCdwYWdlLWZyb20tY2VudGVyLXRvLXJpZ2h0Jyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUHJlcGFyZSBuYXZiYXIgYmVmb3JlIGFuaW1hcmlvblxuICAgICAgICAgICAgcHJlcGFyZU5hdmJhcjogZnVuY3Rpb24gKG5ld05hdmJhcklubmVyLCBvbGROYXZiYXJJbm5lciwgbmV3TmF2YmFyUG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICAkKG5ld05hdmJhcklubmVyKS5maW5kKCcuc2xpZGluZycpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGluZyA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzbGlkaW5nT2Zmc2V0ID0gbmV3TmF2YmFyUG9zaXRpb24gPT09ICdyaWdodCcgPyB0aGlzLmY3TmF2YmFyUmlnaHRPZmZzZXQgOiB0aGlzLmY3TmF2YmFyTGVmdE9mZnNldDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmFuaW1hdGVOYXZCYWNrSWNvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNsaWRpbmcuaGFzQ2xhc3MoJ2xlZnQnKSAmJiBzbGlkaW5nLmZpbmQoJy5iYWNrIC5pY29uJykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRpbmcuZmluZCgnLmJhY2sgLmljb24nKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAoLXNsaWRpbmdPZmZzZXQpICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzbGlkaW5nLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHNsaWRpbmdPZmZzZXQgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTZXQgbmF2YmFycyBjbGFzc2VzcyBmb3IgYW5pbWF0aW9uXG4gICAgICAgICAgICBhbmltYXRlTmF2YmFyczogZnVuY3Rpb24gKGxlZnROYXZiYXJJbm5lciwgcmlnaHROYXZiYXJJbm5lciwgZGlyZWN0aW9uLCB2aWV3KSB7XG4gICAgICAgICAgICAgICAgLy8gTG9hZGluZyBuZXcgcGFnZVxuICAgICAgICAgICAgICAgIHZhciByZW1vdmVDbGFzc2VzID0gJ25hdmJhci1vbi1yaWdodCBuYXZiYXItb24tY2VudGVyIG5hdmJhci1vbi1sZWZ0JztcbiAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAndG8tbGVmdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcmlnaHROYXZiYXJJbm5lci5yZW1vdmVDbGFzcyhyZW1vdmVDbGFzc2VzKS5hZGRDbGFzcygnbmF2YmFyLWZyb20tcmlnaHQtdG8tY2VudGVyJyk7XG4gICAgICAgICAgICAgICAgICAgIHJpZ2h0TmF2YmFySW5uZXIuZmluZCgnLnNsaWRpbmcnKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGlkaW5nID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRpbmcudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwcHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuYW5pbWF0ZU5hdkJhY2tJY29uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNsaWRpbmcuaGFzQ2xhc3MoJ2xlZnQnKSAmJiBzbGlkaW5nLmZpbmQoJy5iYWNrIC5pY29uJykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGlkaW5nLmZpbmQoJy5iYWNrIC5pY29uJykudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwcHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBsZWZ0TmF2YmFySW5uZXIucmVtb3ZlQ2xhc3MocmVtb3ZlQ2xhc3NlcykuYWRkQ2xhc3MoJ25hdmJhci1mcm9tLWNlbnRlci10by1sZWZ0Jyk7XG4gICAgICAgICAgICAgICAgICAgIGxlZnROYXZiYXJJbm5lci5maW5kKCcuc2xpZGluZycpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRpbmcgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJpZ2h0VGV4dDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmFuaW1hdGVOYXZCYWNrSWNvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzbGlkaW5nLmhhc0NsYXNzKCdjZW50ZXInKSAmJiByaWdodE5hdmJhcklubmVyLmZpbmQoJy5zbGlkaW5nLmxlZnQgLmJhY2sgLmljb24nKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0VGV4dCA9IHJpZ2h0TmF2YmFySW5uZXIuZmluZCgnLnNsaWRpbmcubGVmdCAuYmFjayBzcGFuJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyaWdodFRleHQubGVuZ3RoID4gMCkgdGhpcy5mN05hdmJhckxlZnRPZmZzZXQgKz0gcmlnaHRUZXh0WzBdLm9mZnNldExlZnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzbGlkaW5nLmhhc0NsYXNzKCdsZWZ0JykgJiYgc2xpZGluZy5maW5kKCcuYmFjayAuaWNvbicpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGluZy5maW5kKCcuYmFjayAuaWNvbicpLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArICgtdGhpcy5mN05hdmJhckxlZnRPZmZzZXQpICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBzbGlkaW5nLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArICh0aGlzLmY3TmF2YmFyTGVmdE9mZnNldCkgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gR28gYmFja1xuICAgICAgICAgICAgICAgIGlmIChkaXJlY3Rpb24gPT09ICd0by1yaWdodCcpIHtcbiAgICAgICAgICAgICAgICAgICAgbGVmdE5hdmJhcklubmVyLnJlbW92ZUNsYXNzKHJlbW92ZUNsYXNzZXMpLmFkZENsYXNzKCduYXZiYXItZnJvbS1sZWZ0LXRvLWNlbnRlcicpO1xuICAgICAgICAgICAgICAgICAgICBsZWZ0TmF2YmFySW5uZXIuZmluZCgnLnNsaWRpbmcnKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGlkaW5nID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRpbmcudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwcHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuYW5pbWF0ZU5hdkJhY2tJY29uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNsaWRpbmcuaGFzQ2xhc3MoJ2xlZnQnKSAmJiBzbGlkaW5nLmZpbmQoJy5iYWNrIC5pY29uJykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGlkaW5nLmZpbmQoJy5iYWNrIC5pY29uJykudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwcHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICByaWdodE5hdmJhcklubmVyLnJlbW92ZUNsYXNzKHJlbW92ZUNsYXNzZXMpLmFkZENsYXNzKCduYXZiYXItZnJvbS1jZW50ZXItdG8tcmlnaHQnKTtcbiAgICAgICAgICAgICAgICAgICAgcmlnaHROYXZiYXJJbm5lci5maW5kKCcuc2xpZGluZycpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRpbmcgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuYW5pbWF0ZU5hdkJhY2tJY29uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNsaWRpbmcuaGFzQ2xhc3MoJ2xlZnQnKSAmJiBzbGlkaW5nLmZpbmQoJy5iYWNrIC5pY29uJykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGlkaW5nLmZpbmQoJy5iYWNrIC5pY29uJykudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKC10aGlzLmY3TmF2YmFyUmlnaHRPZmZzZXQpICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBzbGlkaW5nLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArICh0aGlzLmY3TmF2YmFyUmlnaHRPZmZzZXQpICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgXG4gICAgICAgICAgICBwcmVwcm9jZXNzOiBmdW5jdGlvbih2aWV3LCBjb250ZW50LCB1cmwsIG5leHQpIHtcbiAgICAgICAgICAgICAgICAvLyBQbHVnaW4gaG9va1xuICAgICAgICAgICAgICAgIGFwcC5wbHVnaW5Ib29rKCdyb3V0ZXJQcmVwcm9jZXNzJywgdmlldywgY29udGVudCwgdXJsLCBuZXh0KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gUHJlcHJvY2VzcyBieSBwbHVnaW5cbiAgICAgICAgICAgICAgICBjb250ZW50ID0gYXBwLnBsdWdpblByb2Nlc3MoJ3ByZXByb2Nlc3MnLCBjb250ZW50KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHZpZXcgJiYgdmlldy5wYXJhbXMgJiYgdmlldy5wYXJhbXMucHJlcHJvY2Vzcykge1xuICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gdmlldy5wYXJhbXMucHJlcHJvY2Vzcyhjb250ZW50LCB1cmwsIG5leHQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRlbnQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXh0KGNvbnRlbnQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKGFwcC5wYXJhbXMucHJlcHJvY2Vzcykge1xuICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gYXBwLnBhcmFtcy5wcmVwcm9jZXNzKGNvbnRlbnQsIHVybCwgbmV4dCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGVudCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQoY29udGVudCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG5leHQoY29udGVudCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHByZXJvdXRlOiBmdW5jdGlvbih2aWV3LCBvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ3JvdXRlclByZXJvdXRlJywgdmlldywgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgaWYgKChhcHAucGFyYW1zLnByZXJvdXRlICYmIGFwcC5wYXJhbXMucHJlcm91dGUodmlldywgb3B0aW9ucykgPT09IGZhbHNlKSB8fCAodmlldyAmJiB2aWV3LnBhcmFtcy5wcmVyb3V0ZSAmJiB2aWV3LnBhcmFtcy5wcmVyb3V0ZSh2aWV3LCBvcHRpb25zKSA9PT0gZmFsc2UpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgIFxuICAgICAgICAgICAgdGVtcGxhdGU3UmVuZGVyOiBmdW5jdGlvbiAodmlldywgb3B0aW9ucykge1xuICAgICAgICAgICAgICAgIHZhciB1cmwgPSBvcHRpb25zLnVybCxcbiAgICAgICAgICAgICAgICAgICAgY29udGVudCA9IG9wdGlvbnMuY29udGVudCwgLy9pbml0aWFsIGNvbnRlbnRcbiAgICAgICAgICAgICAgICAgICAgdDdfcmVuZGVyZWRfY29udGVudCA9IG9wdGlvbnMuY29udGVudCwgLy8gd2lsbCBiZSByZW5kZXJlZCB1c2luZyBUZW1wbGF0ZTdcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IG9wdGlvbnMuY29udGV4dCwgLy8gQ29udGV4dCBkYXRhIGZvciBUZW1wbGF0ZTdcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dE5hbWUgPSBvcHRpb25zLmNvbnRleHROYW1lLFxuICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IG9wdGlvbnMudGVtcGxhdGUsIC8vIFRlbXBsYXRlIDcgY29tcGlsZWQgdGVtcGxhdGVcbiAgICAgICAgICAgICAgICAgICAgcGFnZU5hbWUgPSBvcHRpb25zLnBhZ2VOYW1lO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgdDdfY3R4LCB0N190ZW1wbGF0ZTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRlbnQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh1cmwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAudGVtcGxhdGU3Q2FjaGVbdXJsXSAmJiAhb3B0aW9ucy5pZ25vcmVDYWNoZSkgdDdfdGVtcGxhdGUgPSB0Ny5jYWNoZVt1cmxdO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdDdfdGVtcGxhdGUgPSB0Ny5jb21waWxlKGNvbnRlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQ3LmNhY2hlW3VybF0gPSB0N190ZW1wbGF0ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHQ3X3RlbXBsYXRlID0gdDcuY29tcGlsZShjb250ZW50KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodGVtcGxhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdDdfdGVtcGxhdGUgPSB0ZW1wbGF0ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChjb250ZXh0KSB0N19jdHggPSBjb250ZXh0O1xuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY29udGV4dE5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0TmFtZS5pbmRleE9mKCcuJykgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfY3R4X3BhdGggPSBjb250ZXh0TmFtZS5zcGxpdCgnLicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfY3R4ID0gdDcuZGF0YVtfY3R4X3BhdGhbMF1dO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgX2N0eF9wYXRoLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfY3R4X3BhdGhbaV0pIF9jdHggPSBfY3R4W19jdHhfcGF0aFtpXV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQ3X2N0eCA9IF9jdHg7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHQ3X2N0eCA9IHQ3LmRhdGFbY29udGV4dE5hbWVdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghdDdfY3R4ICYmIHVybCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdDdfY3R4ID0gdDcuZGF0YVsndXJsOicgKyB1cmxdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghdDdfY3R4ICYmIHR5cGVvZiBjb250ZW50ID09PSAnc3RyaW5nJyAmJiAhdGVtcGxhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vdHJ5IHRvIGZpbmQgYnkgcGFnZSBuYW1lIGluIGNvbnRlbnRcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYWdlTmFtZU1hdGNoID0gY29udGVudC5tYXRjaCgvKGRhdGEtcGFnZT1bXCInXVteXCJeJ10qW1wiJ10pLyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFnZU5hbWVNYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYWdlID0gcGFnZU5hbWVNYXRjaFswXS5zcGxpdCgnZGF0YS1wYWdlPScpWzFdLnJlcGxhY2UoL1snXCJdL2csICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFnZSkgdDdfY3R4ID0gdDcuZGF0YVsncGFnZTonICsgcGFnZV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0N19jdHggJiYgdGVtcGxhdGUgJiYgdDcudGVtcGxhdGVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBUcnkgdG8gZmluZCBtYXRjaGVkIHRlbXBsYXRlIG5hbWUgaW4gdDcudGVtcGxhdGVzXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciB0ZW1wbGF0ZU5hbWUgaW4gdDcudGVtcGxhdGVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHQ3LnRlbXBsYXRlc1t0ZW1wbGF0ZU5hbWVdID09PSB0ZW1wbGF0ZSkgdDdfY3R4ID0gdDcuZGF0YVt0ZW1wbGF0ZU5hbWVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghdDdfY3R4KSB0N19jdHggPSB7fTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICh0N190ZW1wbGF0ZSAmJiB0N19jdHgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0N19jdHggPT09ICdmdW5jdGlvbicpIHQ3X2N0eCA9IHQ3X2N0eCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodXJsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBFeHRlbmQgZGF0YSB3aXRoIFVSTCBxdWVyeVxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHF1ZXJ5ID0gJC5wYXJzZVVybFF1ZXJ5KHVybCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0N19jdHgudXJsX3F1ZXJ5ID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcXVlcnkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0N19jdHgudXJsX3F1ZXJ5W2tleV0gPSBxdWVyeVtrZXldO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHQ3X3JlbmRlcmVkX2NvbnRlbnQgPSB0N190ZW1wbGF0ZSh0N19jdHgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtjb250ZW50OiB0N19yZW5kZXJlZF9jb250ZW50LCBjb250ZXh0OiB0N19jdHh9O1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGFwcC5yb3V0ZXIuX2xvYWQgPSBmdW5jdGlvbiAodmlldywgb3B0aW9ucykge1xuICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHVybCA9IG9wdGlvbnMudXJsLFxuICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBvcHRpb25zLmNvbnRlbnQsIC8vaW5pdGlhbCBjb250ZW50XG4gICAgICAgICAgICAgICAgdDdfcmVuZGVyZWQgPSB7Y29udGVudDogb3B0aW9ucy5jb250ZW50fSxcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IG9wdGlvbnMudGVtcGxhdGUsIC8vIFRlbXBsYXRlIDcgY29tcGlsZWQgdGVtcGxhdGVcbiAgICAgICAgICAgICAgICBwYWdlTmFtZSA9IG9wdGlvbnMucGFnZU5hbWUsXG4gICAgICAgICAgICAgICAgdmlld0NvbnRhaW5lciA9ICQodmlldy5jb250YWluZXIpLFxuICAgICAgICAgICAgICAgIHBhZ2VzQ29udGFpbmVyID0gJCh2aWV3LnBhZ2VzQ29udGFpbmVyKSxcbiAgICAgICAgICAgICAgICBhbmltYXRlUGFnZXMgPSBvcHRpb25zLmFuaW1hdGVQYWdlcyxcbiAgICAgICAgICAgICAgICBuZXdQYWdlLCBvbGRQYWdlLCBwYWdlc0luVmlldywgaSwgb2xkTmF2YmFySW5uZXIsIG5ld05hdmJhcklubmVyLCBuYXZiYXIsIGR5bmFtaWNOYXZiYXIsIHJlbG9hZFBvc2l0aW9uLFxuICAgICAgICAgICAgICAgIGlzRHluYW1pY1BhZ2UgPSB0eXBlb2YgdXJsID09PSAndW5kZWZpbmVkJyAmJiBjb250ZW50IHx8IHRlbXBsYXRlLFxuICAgICAgICAgICAgICAgIHB1c2hTdGF0ZSA9IG9wdGlvbnMucHVzaFN0YXRlO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmICh0eXBlb2YgYW5pbWF0ZVBhZ2VzID09PSAndW5kZWZpbmVkJykgYW5pbWF0ZVBhZ2VzID0gdmlldy5wYXJhbXMuYW5pbWF0ZVBhZ2VzO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBsdWdpbiBob29rXG4gICAgICAgICAgICBhcHAucGx1Z2luSG9vaygncm91dGVyTG9hZCcsIHZpZXcsIG9wdGlvbnMpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFJlbmRlciB3aXRoIFRlbXBsYXRlN1xuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMudGVtcGxhdGU3UGFnZXMgJiYgdHlwZW9mIGNvbnRlbnQgPT09ICdzdHJpbmcnIHx8IHRlbXBsYXRlKSB7XG4gICAgICAgICAgICAgICAgdDdfcmVuZGVyZWQgPSBhcHAucm91dGVyLnRlbXBsYXRlN1JlbmRlcih2aWV3LCBvcHRpb25zKTtcbiAgICAgICAgICAgICAgICBpZiAodDdfcmVuZGVyZWQuY29udGVudCAmJiAhY29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gdDdfcmVuZGVyZWQuY29udGVudDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgYXBwLnJvdXRlci50ZW1wb3JhcnlEb20uaW5uZXJIVE1MID0gJyc7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUGFyc2UgRE9NXG4gICAgICAgICAgICBpZiAoIXBhZ2VOYW1lKSB7XG4gICAgICAgICAgICAgICAgaWYgKCh0eXBlb2YgY29udGVudCA9PT0gJ3N0cmluZycpIHx8ICh1cmwgJiYgKHR5cGVvZiBjb250ZW50ID09PSAnc3RyaW5nJykpKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIudGVtcG9yYXJ5RG9tLmlubmVySFRNTCA9IHQ3X3JlbmRlcmVkLmNvbnRlbnQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCdsZW5ndGgnIGluIGNvbnRlbnQgJiYgY29udGVudC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBjaSA9IDA7IGNpIDwgY29udGVudC5sZW5ndGg7IGNpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKGFwcC5yb3V0ZXIudGVtcG9yYXJ5RG9tKS5hcHBlbmQoY29udGVudFtjaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgJChhcHAucm91dGVyLnRlbXBvcmFyeURvbSkuYXBwZW5kKGNvbnRlbnQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFJlbG9hZCBwb3NpdGlvblxuICAgICAgICAgICAgcmVsb2FkUG9zaXRpb24gPSBvcHRpb25zLnJlbG9hZCAmJiAob3B0aW9ucy5yZWxvYWRQcmV2aW91cyA/ICdsZWZ0JyA6ICdjZW50ZXInKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBGaW5kIG5ldyBwYWdlXG4gICAgICAgICAgICBpZiAocGFnZU5hbWUpIG5ld1BhZ2UgPSBwYWdlc0NvbnRhaW5lci5maW5kKCcucGFnZVtkYXRhLXBhZ2U9XCInICsgcGFnZU5hbWUgKyAnXCJdJyk7XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBuZXdQYWdlID0gYXBwLnJvdXRlci5maW5kRWxlbWVudCgnLnBhZ2UnLCBhcHAucm91dGVyLnRlbXBvcmFyeURvbSwgdmlldyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSWYgcGFnZSBub3QgZm91bmQgZXhpdFxuICAgICAgICAgICAgaWYgKCFuZXdQYWdlIHx8IG5ld1BhZ2UubGVuZ3RoID09PSAwIHx8IChwYWdlTmFtZSAmJiB2aWV3LmFjdGl2ZVBhZ2UgJiYgdmlldy5hY3RpdmVQYWdlLm5hbWUgPT09IHBhZ2VOYW1lKSkge1xuICAgICAgICAgICAgICAgIHZpZXcuYWxsb3dQYWdlQ2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgbmV3UGFnZS5hZGRDbGFzcyhvcHRpb25zLnJlbG9hZCA/ICdwYWdlLW9uLScgKyByZWxvYWRQb3NpdGlvbiA6ICdwYWdlLW9uLXJpZ2h0Jyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRmluZCBvbGQgcGFnZSAoc2hvdWxkIGJlIHRoZSBsYXN0IG9uZSkgYW5kIHJlbW92ZSBvbGRlciBwYWdlc1xuICAgICAgICAgICAgcGFnZXNJblZpZXcgPSBwYWdlc0NvbnRhaW5lci5jaGlsZHJlbignLnBhZ2U6bm90KC5jYWNoZWQpJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKG9wdGlvbnMucmVsb2FkICYmIG9wdGlvbnMucmVsb2FkUHJldmlvdXMgJiYgcGFnZXNJblZpZXcubGVuZ3RoID09PSAxKSAge1xuICAgICAgICAgICAgICAgIHZpZXcuYWxsb3dQYWdlQ2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKG9wdGlvbnMucmVsb2FkKSB7XG4gICAgICAgICAgICAgICAgb2xkUGFnZSA9IHBhZ2VzSW5WaWV3LmVxKHBhZ2VzSW5WaWV3Lmxlbmd0aCAtIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhZ2VzSW5WaWV3Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBhZ2VzSW5WaWV3Lmxlbmd0aCAtIDI7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2aWV3LnBhcmFtcy5kb21DYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5wYWdlUmVtb3ZlQ2FsbGJhY2sodmlldywgcGFnZXNJblZpZXdbaV0sICdsZWZ0Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJChwYWdlc0luVmlld1tpXSkucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKHBhZ2VzSW5WaWV3W2ldKS5hZGRDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCF2aWV3LnBhcmFtcy5kb21DYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnBhZ2VSZW1vdmVDYWxsYmFjayh2aWV3LCBwYWdlc0luVmlld1tpXSwgJ2xlZnQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQocGFnZXNJblZpZXdbaV0pLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgJChwYWdlc0luVmlld1tpXSkuYWRkQ2xhc3MoJ2NhY2hlZCcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG9sZFBhZ2UgPSBwYWdlc0NvbnRhaW5lci5jaGlsZHJlbignLnBhZ2U6bm90KC5jYWNoZWQpJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZih2aWV3LnBhcmFtcy5kb21DYWNoZSkgbmV3UGFnZS5yZW1vdmVDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRHluYW1pYyBuYXZiYXJcbiAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5keW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgZHluYW1pY05hdmJhciA9IHRydWU7XG4gICAgICAgICAgICAgICAgLy8gRmluZCBuYXZiYXJcbiAgICAgICAgICAgICAgICBpZiAocGFnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgbmV3TmF2YmFySW5uZXIgPSB2aWV3Q29udGFpbmVyLmZpbmQoJy5uYXZiYXItaW5uZXJbZGF0YS1wYWdlPVwiJyArIHBhZ2VOYW1lICsgJ1wiXScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmV3TmF2YmFySW5uZXIgPSBhcHAucm91dGVyLmZpbmRFbGVtZW50KCcubmF2YmFyLWlubmVyJywgYXBwLnJvdXRlci50ZW1wb3JhcnlEb20sIHZpZXcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIW5ld05hdmJhcklubmVyIHx8IG5ld05hdmJhcklubmVyLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBkeW5hbWljTmF2YmFyID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG5hdmJhciA9IHZpZXdDb250YWluZXIuZmluZCgnLm5hdmJhcicpO1xuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnJlbG9hZCkge1xuICAgICAgICAgICAgICAgICAgICBvbGROYXZiYXJJbm5lciA9IG5hdmJhci5maW5kKCcubmF2YmFyLWlubmVyOm5vdCguY2FjaGVkKTpsYXN0LWNoaWxkJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBvbGROYXZiYXJJbm5lciA9IG5hdmJhci5maW5kKCcubmF2YmFyLWlubmVyOm5vdCguY2FjaGVkKScpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9sZE5hdmJhcklubmVyLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBvbGROYXZiYXJJbm5lci5sZW5ndGggLSAxOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZpZXcucGFyYW1zLmRvbUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5uYXZiYXJSZW1vdmVDYWxsYmFjayh2aWV3LCBwYWdlc0luVmlld1tpXSwgbmF2YmFyWzBdLCBvbGROYXZiYXJJbm5lcltpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQob2xkTmF2YmFySW5uZXJbaV0pLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQob2xkTmF2YmFySW5uZXJbaV0pLmFkZENsYXNzKCdjYWNoZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbmV3TmF2YmFySW5uZXIgJiYgb2xkTmF2YmFySW5uZXIubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2aWV3LnBhcmFtcy5kb21DYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAubmF2YmFyUmVtb3ZlQ2FsbGJhY2sodmlldywgcGFnZXNJblZpZXdbMF0sIG5hdmJhclswXSwgb2xkTmF2YmFySW5uZXJbMF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKG9sZE5hdmJhcklubmVyWzBdKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKG9sZE5hdmJhcklubmVyWzBdKS5hZGRDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBvbGROYXZiYXJJbm5lciA9IG5hdmJhci5maW5kKCcubmF2YmFyLWlubmVyOm5vdCguY2FjaGVkKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICBuZXdOYXZiYXJJbm5lci5hZGRDbGFzcyhvcHRpb25zLnJlbG9hZCA/ICduYXZiYXItb24tJyArIHJlbG9hZFBvc2l0aW9uIDogJ25hdmJhci1vbi1yaWdodCcpO1xuICAgICAgICAgICAgICAgIGlmKHZpZXcucGFyYW1zLmRvbUNhY2hlKSBuZXdOYXZiYXJJbm5lci5yZW1vdmVDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgbmV3UGFnZVswXS5mN1JlbGF0ZWROYXZiYXIgPSBuZXdOYXZiYXJJbm5lclswXTtcbiAgICAgICAgICAgICAgICBuZXdOYXZiYXJJbm5lclswXS5mN1JlbGF0ZWRQYWdlID0gbmV3UGFnZVswXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBzYXZlIGNvbnRlbnQgYXJlYXMgaW50byB2aWV3J3MgY2FjaGVcbiAgICAgICAgICAgIGlmICghdXJsKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5ld1BhZ2VOYW1lID0gcGFnZU5hbWUgfHwgbmV3UGFnZS5hdHRyKCdkYXRhLXBhZ2UnKTtcbiAgICAgICAgICAgICAgICBpZiAoaXNEeW5hbWljUGFnZSkgdXJsID0gJyMnICsgYXBwLnBhcmFtcy5keW5hbWljUGFnZVVybC5yZXBsYWNlKC97e25hbWV9fS9nLCBuZXdQYWdlTmFtZSkucmVwbGFjZSgve3tpbmRleH19L2csIHZpZXcuaGlzdG9yeS5sZW5ndGggLSAob3B0aW9ucy5yZWxvYWQgPyAxIDogMCkpO1xuICAgICAgICAgICAgICAgIGVsc2UgdXJsID0gJyMnICsgbmV3UGFnZU5hbWU7XG4gICAgICAgICAgICAgICAgaWYgKCF2aWV3LnBhcmFtcy5kb21DYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICB2aWV3LmNvbnRlbnRDYWNoZVt1cmxdID0gY29udGVudDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlICYmIHBhZ2VOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcucGFnZXNDYWNoZVt1cmxdID0gcGFnZU5hbWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFB1c2ggU3RhdGVcbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnB1c2hTdGF0ZSAmJiAhb3B0aW9ucy5yZWxvYWRQcmV2aW91cyAmJiB2aWV3Lm1haW4pICB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwdXNoU3RhdGUgPT09ICd1bmRlZmluZWQnKSBwdXNoU3RhdGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHZhciBwdXNoU3RhdGVSb290ID0gYXBwLnBhcmFtcy5wdXNoU3RhdGVSb290IHx8ICcnO1xuICAgICAgICAgICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnJlbG9hZCA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSc7XG4gICAgICAgICAgICAgICAgaWYgKHB1c2hTdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzRHluYW1pY1BhZ2UgJiYgIXBhZ2VOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBoaXN0b3J5W21ldGhvZF0oe3VybDogdXJsLCB2aWV3SW5kZXg6IGFwcC52aWV3cy5pbmRleE9mKHZpZXcpfSwgJycsIHB1c2hTdGF0ZVJvb3QgKyBhcHAucGFyYW1zLnB1c2hTdGF0ZVNlcGFyYXRvciArIHVybCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoaXNEeW5hbWljUGFnZSAmJiBjb250ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBoaXN0b3J5W21ldGhvZF0oe2NvbnRlbnQ6IHR5cGVvZiBjb250ZW50ID09PSAnc3RyaW5nJyA/IGNvbnRlbnQgOiAnJywgdXJsOiB1cmwsIHZpZXdJbmRleDogYXBwLnZpZXdzLmluZGV4T2Yodmlldyl9LCAnJywgcHVzaFN0YXRlUm9vdCArIGFwcC5wYXJhbXMucHVzaFN0YXRlU2VwYXJhdG9yICsgdXJsKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChwYWdlTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaGlzdG9yeVttZXRob2RdKHtwYWdlTmFtZTogcGFnZU5hbWUsIHVybDogdXJsLCB2aWV3SW5kZXg6IGFwcC52aWV3cy5pbmRleE9mKHZpZXcpfSwgJycsIHB1c2hTdGF0ZVJvb3QgKyBhcHAucGFyYW1zLnB1c2hTdGF0ZVNlcGFyYXRvciArIHVybCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVXBkYXRlIFZpZXcgaGlzdG9yeVxuICAgICAgICAgICAgdmlldy51cmwgPSB1cmw7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5yZWxvYWQpIHtcbiAgICAgICAgICAgICAgICB2YXIgbGFzdFVybCA9IHZpZXcuaGlzdG9yeVt2aWV3Lmhpc3RvcnkubGVuZ3RoIC0gKG9wdGlvbnMucmVsb2FkUHJldmlvdXMgPyAyIDogMSldO1xuICAgICAgICAgICAgICAgIGlmIChsYXN0VXJsICYmXG4gICAgICAgICAgICAgICAgICAgIGxhc3RVcmwuaW5kZXhPZignIycpID09PSAwICYmXG4gICAgICAgICAgICAgICAgICAgIGxhc3RVcmwgaW4gdmlldy5jb250ZW50Q2FjaGUgJiZcbiAgICAgICAgICAgICAgICAgICAgbGFzdFVybCAhPT0gdXJsICYmXG4gICAgICAgICAgICAgICAgICAgIHZpZXcuaGlzdG9yeS5pbmRleE9mKGxhc3RVcmwpID09PSAtMSkge1xuICAgICAgICAgICAgICAgICAgICB2aWV3LmNvbnRlbnRDYWNoZVtsYXN0VXJsXSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB2aWV3LmNvbnRlbnRDYWNoZVtsYXN0VXJsXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmlldy5oaXN0b3J5W3ZpZXcuaGlzdG9yeS5sZW5ndGggLSAob3B0aW9ucy5yZWxvYWRQcmV2aW91cyA/IDIgOiAxKV0gPSB1cmw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB2aWV3Lmhpc3RvcnkucHVzaCh1cmwpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFVuaXF1ZSBoaXN0b3J5XG4gICAgICAgICAgICB2YXIgaGlzdG9yeUJlY2FtZVVuaXF1ZSA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLnVuaXF1ZUhpc3RvcnkpIHtcbiAgICAgICAgICAgICAgICB2YXIgX2hpc3RvcnkgPSB2aWV3Lmhpc3Rvcnk7XG4gICAgICAgICAgICAgICAgdmFyIF91cmwgPSB1cmw7XG4gICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLnVuaXF1ZUhpc3RvcnlJZ25vcmVHZXRQYXJhbWV0ZXJzKSB7XG4gICAgICAgICAgICAgICAgICAgIF9oaXN0b3J5ID0gW107XG4gICAgICAgICAgICAgICAgICAgIF91cmwgPSB1cmwuc3BsaXQoJz8nKVswXTtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHZpZXcuaGlzdG9yeS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgX2hpc3RvcnkucHVzaCh2aWV3Lmhpc3RvcnlbaV0uc3BsaXQoJz8nKVswXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChfaGlzdG9yeS5pbmRleE9mKF91cmwpICE9PSBfaGlzdG9yeS5sYXN0SW5kZXhPZihfdXJsKSkge1xuICAgICAgICAgICAgICAgICAgICB2aWV3Lmhpc3RvcnkgPSB2aWV3Lmhpc3Rvcnkuc2xpY2UoMCwgX2hpc3RvcnkuaW5kZXhPZihfdXJsKSk7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuaGlzdG9yeS5wdXNoKHVybCk7XG4gICAgICAgICAgICAgICAgICAgIGhpc3RvcnlCZWNhbWVVbmlxdWUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIERvbSBtYW5pcHVsYXRpb25zXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5yZWxvYWRQcmV2aW91cykge1xuICAgICAgICAgICAgICAgIG9sZFBhZ2UgPSBvbGRQYWdlLnByZXYoJy5wYWdlJyk7XG4gICAgICAgICAgICAgICAgbmV3UGFnZS5pbnNlcnRCZWZvcmUob2xkUGFnZSk7XG4gICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgb2xkTmF2YmFySW5uZXIgPSBvbGROYXZiYXJJbm5lci5wcmV2KCcubmF2YmFyLWlubmVyJyk7XG4gICAgICAgICAgICAgICAgICAgIG5ld05hdmJhcklubmVyLmluc2VydEFmdGVyKG9sZE5hdmJhcklubmVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBwYWdlc0NvbnRhaW5lci5hcHBlbmQobmV3UGFnZVswXSk7XG4gICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIG5hdmJhci5hcHBlbmQobmV3TmF2YmFySW5uZXJbMF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gUmVtb3ZlIE9sZCBQYWdlIEFuZCBOYXZiYXJcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnJlbG9hZCkge1xuICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5kb21DYWNoZSAmJiB2aWV3LmluaXRpYWxQYWdlcy5pbmRleE9mKG9sZFBhZ2VbMF0pID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgb2xkUGFnZS5hZGRDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyKSBvbGROYXZiYXJJbm5lci5hZGRDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhcHAucGFnZVJlbW92ZUNhbGxiYWNrKHZpZXcsIG9sZFBhZ2VbMF0sIHJlbG9hZFBvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIGFwcC5uYXZiYXJSZW1vdmVDYWxsYmFjayh2aWV3LCBvbGRQYWdlWzBdLCBuYXZiYXJbMF0sIG9sZE5hdmJhcklubmVyWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgb2xkUGFnZS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIG9sZE5hdmJhcklubmVyLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQYWdlIEluaXQgRXZlbnRzXG4gICAgICAgICAgICBhcHAucGFnZUluaXRDYWxsYmFjayh2aWV3LCB7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lcjogbmV3UGFnZVswXSxcbiAgICAgICAgICAgICAgICB1cmw6IHVybCxcbiAgICAgICAgICAgICAgICBwb3NpdGlvbjogb3B0aW9ucy5yZWxvYWQgPyByZWxvYWRQb3NpdGlvbiA6ICdyaWdodCcsXG4gICAgICAgICAgICAgICAgbmF2YmFySW5uZXJDb250YWluZXI6IGR5bmFtaWNOYXZiYXIgPyBuZXdOYXZiYXJJbm5lciAmJiBuZXdOYXZiYXJJbm5lclswXSA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBvbGROYXZiYXJJbm5lckNvbnRhaW5lcjogZHluYW1pY05hdmJhciA/IG9sZE5hdmJhcklubmVyICYmIG9sZE5hdmJhcklubmVyWzBdIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgIGNvbnRleHQ6IHQ3X3JlbmRlcmVkLmNvbnRleHQsXG4gICAgICAgICAgICAgICAgcXVlcnk6IG9wdGlvbnMucXVlcnksXG4gICAgICAgICAgICAgICAgZnJvbVBhZ2U6IG9sZFBhZ2UgJiYgb2xkUGFnZS5sZW5ndGggJiYgb2xkUGFnZVswXS5mN1BhZ2VEYXRhLFxuICAgICAgICAgICAgICAgIHJlbG9hZDogb3B0aW9ucy5yZWxvYWQsXG4gICAgICAgICAgICAgICAgcmVsb2FkUHJldmlvdXM6IG9wdGlvbnMucmVsb2FkUHJldmlvdXNcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIE5hdmJhciBpbml0IGV2ZW50XG4gICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgIGFwcC5uYXZiYXJJbml0Q2FsbGJhY2sodmlldywgbmV3UGFnZVswXSwgbmF2YmFyWzBdLCBuZXdOYXZiYXJJbm5lclswXSwgdXJsLCBvcHRpb25zLnJlbG9hZCA/IHJlbG9hZFBvc2l0aW9uIDogJ3JpZ2h0Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKG9wdGlvbnMucmVsb2FkKSB7XG4gICAgICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmIChoaXN0b3J5QmVjYW1lVW5pcXVlKSB2aWV3LnJlZnJlc2hQcmV2aW91c1BhZ2UoKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIgJiYgYW5pbWF0ZVBhZ2VzKSB7XG4gICAgICAgICAgICAgICAgYXBwLnJvdXRlci5wcmVwYXJlTmF2YmFyKG5ld05hdmJhcklubmVyLCBvbGROYXZiYXJJbm5lciwgJ3JpZ2h0Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBGb3JjZSByZUxheW91dFxuICAgICAgICAgICAgdmFyIGNsaWVudExlZnQgPSBuZXdQYWdlWzBdLmNsaWVudExlZnQ7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQmVmb3JlIEFuaW0gQ2FsbGJhY2tcbiAgICAgICAgICAgIGFwcC5wYWdlQW5pbUNhbGxiYWNrKCdiZWZvcmUnLCB2aWV3LCB7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lcjogbmV3UGFnZVswXSxcbiAgICAgICAgICAgICAgICB1cmw6IHVybCxcbiAgICAgICAgICAgICAgICBwb3NpdGlvbjogJ3JpZ2h0JyxcbiAgICAgICAgICAgICAgICBvbGRQYWdlOiBvbGRQYWdlLFxuICAgICAgICAgICAgICAgIG5ld1BhZ2U6IG5ld1BhZ2UsXG4gICAgICAgICAgICAgICAgcXVlcnk6IG9wdGlvbnMucXVlcnksXG4gICAgICAgICAgICAgICAgZnJvbVBhZ2U6IG9sZFBhZ2UgJiYgb2xkUGFnZS5sZW5ndGggJiYgb2xkUGFnZVswXS5mN1BhZ2VEYXRhXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiBhZnRlckFuaW1hdGlvbigpIHtcbiAgICAgICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgbmV3UGFnZS5yZW1vdmVDbGFzcygncGFnZS1mcm9tLXJpZ2h0LXRvLWNlbnRlciBwYWdlLW9uLXJpZ2h0IHBhZ2Utb24tbGVmdCcpLmFkZENsYXNzKCdwYWdlLW9uLWNlbnRlcicpO1xuICAgICAgICAgICAgICAgIG9sZFBhZ2UucmVtb3ZlQ2xhc3MoJ3BhZ2UtZnJvbS1jZW50ZXItdG8tbGVmdCBwYWdlLW9uLWNlbnRlciBwYWdlLW9uLXJpZ2h0JykuYWRkQ2xhc3MoJ3BhZ2Utb24tbGVmdCcpO1xuICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgIG5ld05hdmJhcklubmVyLnJlbW92ZUNsYXNzKCduYXZiYXItZnJvbS1yaWdodC10by1jZW50ZXIgbmF2YmFyLW9uLWxlZnQgbmF2YmFyLW9uLXJpZ2h0JykuYWRkQ2xhc3MoJ25hdmJhci1vbi1jZW50ZXInKTtcbiAgICAgICAgICAgICAgICAgICAgb2xkTmF2YmFySW5uZXIucmVtb3ZlQ2xhc3MoJ25hdmJhci1mcm9tLWNlbnRlci10by1sZWZ0IG5hdmJhci1vbi1jZW50ZXIgbmF2YmFyLW9uLXJpZ2h0JykuYWRkQ2xhc3MoJ25hdmJhci1vbi1sZWZ0Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGFwcC5wYWdlQW5pbUNhbGxiYWNrKCdhZnRlcicsIHZpZXcsIHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lcjogbmV3UGFnZVswXSxcbiAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmwsXG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAncmlnaHQnLFxuICAgICAgICAgICAgICAgICAgICBvbGRQYWdlOiBvbGRQYWdlLFxuICAgICAgICAgICAgICAgICAgICBuZXdQYWdlOiBuZXdQYWdlLFxuICAgICAgICAgICAgICAgICAgICBxdWVyeTogb3B0aW9ucy5xdWVyeSxcbiAgICAgICAgICAgICAgICAgICAgZnJvbVBhZ2U6IG9sZFBhZ2UgJiYgb2xkUGFnZS5sZW5ndGggJiYgb2xkUGFnZVswXS5mN1BhZ2VEYXRhXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMucHVzaFN0YXRlICYmIHZpZXcubWFpbikgYXBwLnB1c2hTdGF0ZUNsZWFyUXVldWUoKTtcbiAgICAgICAgICAgICAgICBpZiAoISh2aWV3LnBhcmFtcy5zd2lwZUJhY2tQYWdlIHx8IHZpZXcucGFyYW1zLnByZWxvYWRQcmV2aW91c1BhZ2UpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5kb21DYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2xkUGFnZS5hZGRDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikgb2xkTmF2YmFySW5uZXIuYWRkQ2xhc3MoJ2NhY2hlZCcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEodXJsLmluZGV4T2YoJyMnKSA9PT0gMCAmJiBuZXdQYWdlLmF0dHIoJ2RhdGEtcGFnZScpLmluZGV4T2YoJ3NtYXJ0LXNlbGVjdC0nKSA9PT0gMCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAucGFnZVJlbW92ZUNhbGxiYWNrKHZpZXcsIG9sZFBhZ2VbMF0sICdsZWZ0Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIGFwcC5uYXZiYXJSZW1vdmVDYWxsYmFjayh2aWV3LCBvbGRQYWdlWzBdLCBuYXZiYXJbMF0sIG9sZE5hdmJhcklubmVyWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGRQYWdlLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyKSBvbGROYXZiYXJJbm5lci5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMudW5pcXVlSGlzdG9yeSAmJiBoaXN0b3J5QmVjYW1lVW5pcXVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcucmVmcmVzaFByZXZpb3VzUGFnZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhbmltYXRlUGFnZXMpIHtcbiAgICAgICAgICAgICAgICAvLyBTZXQgcGFnZXMgYmVmb3JlIGFuaW1hdGlvblxuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsICYmIGFwcC5wYXJhbXMubWF0ZXJpYWxQYWdlTG9hZERlbGF5KSB7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci5hbmltYXRlUGFnZXMob2xkUGFnZSwgbmV3UGFnZSwgJ3RvLWxlZnQnLCB2aWV3KTtcbiAgICAgICAgICAgICAgICAgICAgfSwgYXBwLnBhcmFtcy5tYXRlcmlhbFBhZ2VMb2FkRGVsYXkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci5hbmltYXRlUGFnZXMob2xkUGFnZSwgbmV3UGFnZSwgJ3RvLWxlZnQnLCB2aWV3KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgbmF2YmFyIGFuaW1hdGlvblxuICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLmFuaW1hdGVOYXZiYXJzKG9sZE5hdmJhcklubmVyLCBuZXdOYXZiYXJJbm5lciwgJ3RvLWxlZnQnLCB2aWV3KTtcbiAgICAgICAgICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG5ld1BhZ2UuYW5pbWF0aW9uRW5kKGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGFmdGVyQW5pbWF0aW9uKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikgbmV3TmF2YmFySW5uZXIuZmluZCgnLnNsaWRpbmcsIC5zbGlkaW5nIC5iYWNrIC5pY29uJykudHJhbnNmb3JtKCcnKTtcbiAgICAgICAgICAgICAgICBhZnRlckFuaW1hdGlvbigpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGFwcC5yb3V0ZXIubG9hZCA9IGZ1bmN0aW9uICh2aWV3LCBvcHRpb25zKSB7XG4gICAgICAgICAgICBpZiAoYXBwLnJvdXRlci5wcmVyb3V0ZSh2aWV3LCBvcHRpb25zKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgICAgICAgICAgdmFyIHVybCA9IG9wdGlvbnMudXJsO1xuICAgICAgICAgICAgdmFyIGNvbnRlbnQgPSBvcHRpb25zLmNvbnRlbnQ7XG4gICAgICAgICAgICB2YXIgcGFnZU5hbWUgPSBvcHRpb25zLnBhZ2VOYW1lO1xuICAgICAgICAgICAgaWYgKHBhZ2VOYW1lKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhZ2VOYW1lLmluZGV4T2YoJz8nKSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5xdWVyeSA9ICQucGFyc2VVcmxRdWVyeShwYWdlTmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMucGFnZU5hbWUgPSBwYWdlTmFtZSA9IHBhZ2VOYW1lLnNwbGl0KCc/JylbMF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHRlbXBsYXRlID0gb3B0aW9ucy50ZW1wbGF0ZTtcbiAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5yZWxvYWRQYWdlcyA9PT0gdHJ1ZSkgb3B0aW9ucy5yZWxvYWQgPSB0cnVlO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmICghdmlldy5hbGxvd1BhZ2VDaGFuZ2UpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIGlmICh1cmwgJiYgdmlldy51cmwgPT09IHVybCAmJiAhb3B0aW9ucy5yZWxvYWQgJiYgIXZpZXcucGFyYW1zLmFsbG93RHVwbGljYXRlVXJscykgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmIChhcHAueGhyICYmIHZpZXcueGhyICYmIHZpZXcueGhyID09PSBhcHAueGhyKSB7XG4gICAgICAgICAgICAgICAgYXBwLnhoci5hYm9ydCgpO1xuICAgICAgICAgICAgICAgIGFwcC54aHIgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIHByb2NlZWQoY29udGVudCkge1xuICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIucHJlcHJvY2Vzcyh2aWV3LCBjb250ZW50LCB1cmwsIGZ1bmN0aW9uIChjb250ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuY29udGVudCA9IGNvbnRlbnQ7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIuX2xvYWQodmlldywgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY29udGVudCB8fCBwYWdlTmFtZSkge1xuICAgICAgICAgICAgICAgIHByb2NlZWQoY29udGVudCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAodGVtcGxhdGUpIHtcbiAgICAgICAgICAgICAgICBhcHAucm91dGVyLl9sb2FkKHZpZXcsIG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoIW9wdGlvbnMudXJsIHx8IG9wdGlvbnMudXJsID09PSAnIycpIHtcbiAgICAgICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXBwLmdldChvcHRpb25zLnVybCwgdmlldywgb3B0aW9ucy5pZ25vcmVDYWNoZSwgZnVuY3Rpb24gKGNvbnRlbnQsIGVycm9yKSB7XG4gICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuYWxsb3dQYWdlQ2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwcm9jZWVkKGNvbnRlbnQpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBhcHAucm91dGVyLl9iYWNrID0gZnVuY3Rpb24gKHZpZXcsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgICAgICAgICAgdmFyIHVybCA9IG9wdGlvbnMudXJsLFxuICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBvcHRpb25zLmNvbnRlbnQsXG4gICAgICAgICAgICAgICAgdDdfcmVuZGVyZWQgPSB7Y29udGVudDogb3B0aW9ucy5jb250ZW50fSwgLy8gd2lsbCBiZSByZW5kZXJlZCB1c2luZyBUZW1wbGF0ZTdcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IG9wdGlvbnMudGVtcGxhdGUsIC8vIFRlbXBsYXRlIDcgY29tcGlsZWQgdGVtcGxhdGVcbiAgICAgICAgICAgICAgICBhbmltYXRlUGFnZXMgPSBvcHRpb25zLmFuaW1hdGVQYWdlcyxcbiAgICAgICAgICAgICAgICBwcmVsb2FkT25seSA9IG9wdGlvbnMucHJlbG9hZE9ubHksXG4gICAgICAgICAgICAgICAgcHVzaFN0YXRlID0gb3B0aW9ucy5wdXNoU3RhdGUsXG4gICAgICAgICAgICAgICAgaWdub3JlQ2FjaGUgPSBvcHRpb25zLmlnbm9yZUNhY2hlLFxuICAgICAgICAgICAgICAgIGZvcmNlID0gb3B0aW9ucy5mb3JjZSxcbiAgICAgICAgICAgICAgICBwYWdlTmFtZSA9IG9wdGlvbnMucGFnZU5hbWU7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHZpZXdDb250YWluZXIgPSAkKHZpZXcuY29udGFpbmVyKSxcbiAgICAgICAgICAgICAgICBwYWdlc0NvbnRhaW5lciA9ICQodmlldy5wYWdlc0NvbnRhaW5lciksXG4gICAgICAgICAgICAgICAgcGFnZXNJblZpZXcgPSBwYWdlc0NvbnRhaW5lci5jaGlsZHJlbignLnBhZ2U6bm90KC5jYWNoZWQpJyksXG4gICAgICAgICAgICAgICAgb2xkUGFnZSwgbmV3UGFnZSwgb2xkTmF2YmFySW5uZXIsIG5ld05hdmJhcklubmVyLCBuYXZiYXIsIG5hdmJhcklubmVycywgZHluYW1pY05hdmJhciwgbWFuaXB1bGF0ZURvbSA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHR5cGVvZiBhbmltYXRlUGFnZXMgPT09ICd1bmRlZmluZWQnKSBhbmltYXRlUGFnZXMgPSB2aWV3LnBhcmFtcy5hbmltYXRlUGFnZXM7XG4gICAgICAgIFxuICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ3JvdXRlckJhY2snLCB2aWV3LCBvcHRpb25zKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBSZW5kZXIgd2l0aCBUZW1wbGF0ZTdcbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnRlbXBsYXRlN1BhZ2VzICYmIHR5cGVvZiBjb250ZW50ID09PSAnc3RyaW5nJyB8fCB0ZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgIHQ3X3JlbmRlcmVkID0gYXBwLnJvdXRlci50ZW1wbGF0ZTdSZW5kZXIodmlldywgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgaWYgKHQ3X3JlbmRlcmVkLmNvbnRlbnQgJiYgIWNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudCA9IHQ3X3JlbmRlcmVkLmNvbnRlbnQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIEFuaW1hdGlvblxuICAgICAgICAgICAgZnVuY3Rpb24gYWZ0ZXJBbmltYXRpb24oKSB7XG4gICAgICAgICAgICAgICAgYXBwLnBhZ2VCYWNrQ2FsbGJhY2soJ2FmdGVyJywgdmlldywge1xuICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyOiBvbGRQYWdlWzBdLFxuICAgICAgICAgICAgICAgICAgICB1cmw6IHVybCxcbiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICdjZW50ZXInLFxuICAgICAgICAgICAgICAgICAgICBvbGRQYWdlOiBvbGRQYWdlLFxuICAgICAgICAgICAgICAgICAgICBuZXdQYWdlOiBuZXdQYWdlLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGFwcC5wYWdlQW5pbUNhbGxiYWNrKCdhZnRlcicsIHZpZXcsIHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lcjogbmV3UGFnZVswXSxcbiAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmwsXG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnbGVmdCcsXG4gICAgICAgICAgICAgICAgICAgIG9sZFBhZ2U6IG9sZFBhZ2UsXG4gICAgICAgICAgICAgICAgICAgIG5ld1BhZ2U6IG5ld1BhZ2UsXG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5OiBvcHRpb25zLnF1ZXJ5LFxuICAgICAgICAgICAgICAgICAgICBmcm9tUGFnZTogb2xkUGFnZSAmJiBvbGRQYWdlLmxlbmd0aCAmJiBvbGRQYWdlWzBdLmY3UGFnZURhdGFcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBhcHAucm91dGVyLmFmdGVyQmFjayh2aWV3LCBvbGRQYWdlWzBdLCBuZXdQYWdlWzBdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGFuaW1hdGVCYWNrKCkge1xuICAgICAgICAgICAgICAgIC8vIFBhZ2UgYmVmb3JlIGFuaW1hdGlvbiBjYWxsYmFja1xuICAgICAgICAgICAgICAgIGFwcC5wYWdlQmFja0NhbGxiYWNrKCdiZWZvcmUnLCB2aWV3LCB7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXI6IG9sZFBhZ2VbMF0sXG4gICAgICAgICAgICAgICAgICAgIHVybDogdXJsLFxuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogJ2NlbnRlcicsXG4gICAgICAgICAgICAgICAgICAgIG9sZFBhZ2U6IG9sZFBhZ2UsXG4gICAgICAgICAgICAgICAgICAgIG5ld1BhZ2U6IG5ld1BhZ2UsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgYXBwLnBhZ2VBbmltQ2FsbGJhY2soJ2JlZm9yZScsIHZpZXcsIHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lcjogbmV3UGFnZVswXSxcbiAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmwsXG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnbGVmdCcsXG4gICAgICAgICAgICAgICAgICAgIG9sZFBhZ2U6IG9sZFBhZ2UsXG4gICAgICAgICAgICAgICAgICAgIG5ld1BhZ2U6IG5ld1BhZ2UsXG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5OiBvcHRpb25zLnF1ZXJ5LFxuICAgICAgICAgICAgICAgICAgICBmcm9tUGFnZTogb2xkUGFnZSAmJiBvbGRQYWdlLmxlbmd0aCAmJiBvbGRQYWdlWzBdLmY3UGFnZURhdGFcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGFuaW1hdGVQYWdlcykge1xuICAgICAgICAgICAgICAgICAgICAvLyBTZXQgcGFnZXMgYmVmb3JlIGFuaW1hdGlvblxuICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLmFuaW1hdGVQYWdlcyhuZXdQYWdlLCBvbGRQYWdlLCAndG8tcmlnaHQnLCB2aWV3KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgbmF2YmFyIGFuaW1hdGlvblxuICAgICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci5hbmltYXRlTmF2YmFycyhuZXdOYXZiYXJJbm5lciwgb2xkTmF2YmFySW5uZXIsICd0by1yaWdodCcsIHZpZXcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIG5ld1BhZ2UuYW5pbWF0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyQW5pbWF0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIG5ld05hdmJhcklubmVyLmZpbmQoJy5zbGlkaW5nLCAuc2xpZGluZyAuYmFjayAuaWNvbicpLnRyYW5zZm9ybSgnJyk7XG4gICAgICAgICAgICAgICAgICAgIGFmdGVyQW5pbWF0aW9uKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIHBhcnNlTmV3UGFnZSgpIHtcbiAgICAgICAgICAgICAgICBhcHAucm91dGVyLnRlbXBvcmFyeURvbS5pbm5lckhUTUwgPSAnJztcbiAgICAgICAgICAgICAgICAvLyBQYXJzZSBET01cbiAgICAgICAgICAgICAgICBpZiAoKHR5cGVvZiBjb250ZW50ID09PSAnc3RyaW5nJykgfHwgKHVybCAmJiAodHlwZW9mIGNvbnRlbnQgPT09ICdzdHJpbmcnKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci50ZW1wb3JhcnlEb20uaW5uZXJIVE1MID0gdDdfcmVuZGVyZWQuY29udGVudDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoJ2xlbmd0aCcgaW4gY29udGVudCAmJiBjb250ZW50Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGNpID0gMDsgY2kgPCBjb250ZW50Lmxlbmd0aDsgY2krKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoYXBwLnJvdXRlci50ZW1wb3JhcnlEb20pLmFwcGVuZChjb250ZW50W2NpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKGFwcC5yb3V0ZXIudGVtcG9yYXJ5RG9tKS5hcHBlbmQoY29udGVudCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbmV3UGFnZSA9IGFwcC5yb3V0ZXIuZmluZEVsZW1lbnQoJy5wYWdlJywgYXBwLnJvdXRlci50ZW1wb3JhcnlEb20sIHZpZXcpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICAvLyBGaW5kIG5hdmJhclxuICAgICAgICAgICAgICAgICAgICBuZXdOYXZiYXJJbm5lciA9IGFwcC5yb3V0ZXIuZmluZEVsZW1lbnQoJy5uYXZiYXItaW5uZXInLCBhcHAucm91dGVyLnRlbXBvcmFyeURvbSwgdmlldyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gc2V0UGFnZXMoKSB7XG4gICAgICAgICAgICAgICAgLy8gSWYgcGFnZXMgbm90IGZvdW5kIG9yIHRoZXJlIGFyZSBzdGlsbCBtb3JlIHRoYW4gb25lLCBleGl0XG4gICAgICAgICAgICAgICAgaWYgKCFuZXdQYWdlIHx8IG5ld1BhZ2UubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuYWxsb3dQYWdlQ2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuZHluYW1pY05hdmJhciAmJiB0eXBlb2YgZHluYW1pY05hdmJhciA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFuZXdOYXZiYXJJbm5lciB8fCBuZXdOYXZiYXJJbm5lci5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGR5bmFtaWNOYXZiYXIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGR5bmFtaWNOYXZiYXIgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBuZXdQYWdlLmFkZENsYXNzKCdwYWdlLW9uLWxlZnQnKS5yZW1vdmVDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgbmF2YmFyID0gdmlld0NvbnRhaW5lci5maW5kKCcubmF2YmFyJyk7XG4gICAgICAgICAgICAgICAgICAgIG5hdmJhcklubmVycyA9IHZpZXdDb250YWluZXIuZmluZCgnLm5hdmJhci1pbm5lcjpub3QoLmNhY2hlZCknKTtcbiAgICAgICAgICAgICAgICAgICAgbmV3TmF2YmFySW5uZXIuYWRkQ2xhc3MoJ25hdmJhci1vbi1sZWZ0JykucmVtb3ZlQ2xhc3MoJ2NhY2hlZCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBSZW1vdmUvaGlkZSBwcmV2aW91cyBwYWdlIGluIGZvcmNlIG1vZGVcbiAgICAgICAgICAgICAgICBpZiAoZm9yY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhZ2VUb1JlbW92ZSwgbmF2YmFyVG9SZW1vdmU7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VUb1JlbW92ZSA9ICQocGFnZXNJblZpZXdbcGFnZXNJblZpZXcubGVuZ3RoIC0gMl0pO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIG5hdmJhclRvUmVtb3ZlID0gJChwYWdlVG9SZW1vdmVbMF0gJiYgcGFnZVRvUmVtb3ZlWzBdLmY3UmVsYXRlZE5hdmJhciB8fCBuYXZiYXJJbm5lcnNbbmF2YmFySW5uZXJzLmxlbmd0aCAtIDJdKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlICYmIHZpZXcuaW5pdGlhbFBhZ2VzLmluZGV4T2YocGFnZVRvUmVtb3ZlWzBdKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFnZVRvUmVtb3ZlLmxlbmd0aCAmJiBwYWdlVG9SZW1vdmVbMF0gIT09IG5ld1BhZ2VbMF0pIHBhZ2VUb1JlbW92ZS5hZGRDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhciAmJiBuYXZiYXJUb1JlbW92ZS5sZW5ndGggJiYgbmF2YmFyVG9SZW1vdmVbMF0gIT09IG5ld05hdmJhcklubmVyWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmF2YmFyVG9SZW1vdmUuYWRkQ2xhc3MoJ2NhY2hlZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlbW92ZU5hdmJhciA9IGR5bmFtaWNOYXZiYXIgJiYgbmF2YmFyVG9SZW1vdmUubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2VUb1JlbW92ZS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAucGFnZVJlbW92ZUNhbGxiYWNrKHZpZXcsIHBhZ2VUb1JlbW92ZVswXSwgJ3JpZ2h0Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlbW92ZU5hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAubmF2YmFyUmVtb3ZlQ2FsbGJhY2sodmlldywgcGFnZVRvUmVtb3ZlWzBdLCBuYXZiYXJbMF0sIG5hdmJhclRvUmVtb3ZlWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZVRvUmVtb3ZlLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZW1vdmVOYXZiYXIpIG5hdmJhclRvUmVtb3ZlLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmVtb3ZlTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLm5hdmJhclJlbW92ZUNhbGxiYWNrKHZpZXcsIHBhZ2VUb1JlbW92ZVswXSwgbmF2YmFyWzBdLCBuYXZiYXJUb1JlbW92ZVswXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmF2YmFyVG9SZW1vdmUucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcGFnZXNJblZpZXcgPSBwYWdlc0NvbnRhaW5lci5jaGlsZHJlbignLnBhZ2U6bm90KC5jYWNoZWQpJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuYXZiYXJJbm5lcnMgPSB2aWV3Q29udGFpbmVyLmZpbmQoJy5uYXZiYXItaW5uZXI6bm90KC5jYWNoZWQpJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcuaGlzdG9yeS5pbmRleE9mKHVybCkgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmlldy5oaXN0b3J5ID0gdmlldy5oaXN0b3J5LnNsaWNlKDAsIHZpZXcuaGlzdG9yeS5pbmRleE9mKHVybCkgKyAyKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aWV3Lmhpc3RvcnlbW3ZpZXcuaGlzdG9yeS5sZW5ndGggLSAyXV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWV3Lmhpc3Rvcnlbdmlldy5oaXN0b3J5Lmxlbmd0aCAtIDJdID0gdXJsO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlldy5oaXN0b3J5LnVuc2hpZnQodXJsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgb2xkUGFnZSA9ICQocGFnZXNJblZpZXdbcGFnZXNJblZpZXcubGVuZ3RoIC0gMV0pO1xuICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5kb21DYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAob2xkUGFnZVswXSA9PT0gbmV3UGFnZVswXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2xkUGFnZSA9IHBhZ2VzQ29udGFpbmVyLmNoaWxkcmVuKCcucGFnZS5wYWdlLW9uLWNlbnRlcicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZFBhZ2UubGVuZ3RoID09PSAwICYmIHZpZXcuYWN0aXZlUGFnZSkgb2xkUGFnZSA9ICQodmlldy5hY3RpdmVQYWdlLmNvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyICYmICFvbGROYXZiYXJJbm5lcikge1xuICAgICAgICAgICAgICAgICAgICBvbGROYXZiYXJJbm5lciA9ICQobmF2YmFySW5uZXJzW25hdmJhcklubmVycy5sZW5ndGggLSAxXSk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5kb21DYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9sZE5hdmJhcklubmVyWzBdID09PSBuZXdOYXZiYXJJbm5lclswXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZE5hdmJhcklubmVyID0gbmF2YmFyLmNoaWxkcmVuKCcubmF2YmFyLWlubmVyLm5hdmJhci1vbi1jZW50ZXI6bm90KC5jYWNoZWQpJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob2xkTmF2YmFySW5uZXIubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkTmF2YmFySW5uZXIgPSBuYXZiYXIuY2hpbGRyZW4oJy5uYXZiYXItaW5uZXJbZGF0YS1wYWdlPVwiJytvbGRQYWdlLmF0dHIoJ2RhdGEtcGFnZScpKydcIl0nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAob2xkTmF2YmFySW5uZXIubGVuZ3RoID09PSAwIHx8IG5ld05hdmJhcklubmVyWzBdID09PSBvbGROYXZiYXJJbm5lclswXSkgZHluYW1pY05hdmJhciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1hbmlwdWxhdGVEb20pIG5ld05hdmJhcklubmVyLmluc2VydEJlZm9yZShvbGROYXZiYXJJbm5lcik7XG4gICAgICAgICAgICAgICAgICAgIG5ld05hdmJhcklubmVyWzBdLmY3UmVsYXRlZFBhZ2UgPSBuZXdQYWdlWzBdO1xuICAgICAgICAgICAgICAgICAgICBuZXdQYWdlWzBdLmY3UmVsYXRlZE5hdmJhciA9IG5ld05hdmJhcklubmVyWzBdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobWFuaXB1bGF0ZURvbSkgbmV3UGFnZS5pbnNlcnRCZWZvcmUob2xkUGFnZSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFBhZ2UgSW5pdCBFdmVudHNcbiAgICAgICAgICAgICAgICBhcHAucGFnZUluaXRDYWxsYmFjayh2aWV3LCB7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXI6IG5ld1BhZ2VbMF0sXG4gICAgICAgICAgICAgICAgICAgIHVybDogdXJsLFxuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogJ2xlZnQnLFxuICAgICAgICAgICAgICAgICAgICBuYXZiYXJJbm5lckNvbnRhaW5lcjogZHluYW1pY05hdmJhciA/IG5ld05hdmJhcklubmVyWzBdIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICBvbGROYXZiYXJJbm5lckNvbnRhaW5lcjogZHluYW1pY05hdmJhciA/IG9sZE5hdmJhcklubmVyICYmIG9sZE5hdmJhcklubmVyWzBdIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICBjb250ZXh0OiB0N19yZW5kZXJlZC5jb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICBxdWVyeTogb3B0aW9ucy5xdWVyeSxcbiAgICAgICAgICAgICAgICAgICAgZnJvbVBhZ2U6IG9sZFBhZ2UgJiYgb2xkUGFnZS5sZW5ndGggJiYgb2xkUGFnZVswXS5mN1BhZ2VEYXRhLFxuICAgICAgICAgICAgICAgICAgICBwcmVsb2FkT25seTogcHJlbG9hZE9ubHlcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICBhcHAubmF2YmFySW5pdENhbGxiYWNrKHZpZXcsIG5ld1BhZ2VbMF0sIG5hdmJhclswXSwgbmV3TmF2YmFySW5uZXJbMF0sIHVybCwgJ3JpZ2h0Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhciAmJiBuZXdOYXZiYXJJbm5lci5oYXNDbGFzcygnbmF2YmFyLW9uLWxlZnQnKSAmJiBhbmltYXRlUGFnZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci5wcmVwYXJlTmF2YmFyKG5ld05hdmJhcklubmVyLCAgb2xkTmF2YmFySW5uZXIsICdsZWZ0Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocHJlbG9hZE9ubHkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVmlldydzIFVSTFxuICAgICAgICAgICAgICAgIHZpZXcudXJsID0gdXJsO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBGb3JjZSByZUxheW91dFxuICAgICAgICAgICAgICAgIHZhciBjbGllbnRMZWZ0ID0gbmV3UGFnZVswXS5jbGllbnRMZWZ0O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBhbmltYXRlQmFjaygpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBQdXNoIHN0YXRlXG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMucHVzaFN0YXRlICYmIHZpZXcubWFpbikgIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwdXNoU3RhdGUgPT09ICd1bmRlZmluZWQnKSBwdXNoU3RhdGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXByZWxvYWRPbmx5ICYmIGhpc3Rvcnkuc3RhdGUgJiYgcHVzaFN0YXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBoaXN0b3J5LmJhY2soKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2ltcGxlIGdvIGJhY2sgd2hlbiB3ZSBoYXZlIHBhZ2VzIG9uIGxlZnRcbiAgICAgICAgICAgIGlmIChwYWdlc0luVmlldy5sZW5ndGggPiAxICYmICFmb3JjZSkge1xuICAgICAgICAgICAgICAgIC8vIEV4aXQgaWYgb25seSBwcmVsb2FkT25seVxuICAgICAgICAgICAgICAgIGlmIChwcmVsb2FkT25seSkge1xuICAgICAgICAgICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gVXBkYXRlIFZpZXcncyBVUkxcbiAgICAgICAgICAgICAgICB2aWV3LnVybCA9IHZpZXcuaGlzdG9yeVt2aWV3Lmhpc3RvcnkubGVuZ3RoIC0gMl07XG4gICAgICAgICAgICAgICAgdXJsID0gdmlldy51cmw7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIERlZmluZSBvbGQgYW5kIG5ldyBwYWdlc1xuICAgICAgICAgICAgICAgIG5ld1BhZ2UgPSAkKHBhZ2VzSW5WaWV3W3BhZ2VzSW5WaWV3Lmxlbmd0aCAtIDJdKTtcbiAgICAgICAgICAgICAgICBvbGRQYWdlID0gJChwYWdlc0luVmlld1twYWdlc0luVmlldy5sZW5ndGggLSAxXSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIER5bmFtaWMgbmF2YmFyXG4gICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgZHluYW1pY05hdmJhciA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIC8vIEZpbmQgbmF2YmFyXG4gICAgICAgICAgICAgICAgICAgIG5hdmJhcklubmVycyA9IHZpZXdDb250YWluZXIuZmluZCgnLm5hdmJhci1pbm5lcjpub3QoLmNhY2hlZCknKTtcbiAgICAgICAgICAgICAgICAgICAgbmV3TmF2YmFySW5uZXIgPSAkKG5hdmJhcklubmVyc1swXSk7XG4gICAgICAgICAgICAgICAgICAgIG9sZE5hdmJhcklubmVyID0gJChuYXZiYXJJbm5lcnNbMV0pO1xuICAgICAgICAgICAgICAgICAgICBpZiAobmV3TmF2YmFySW5uZXIubGVuZ3RoID09PSAwIHx8IG9sZE5hdmJhcklubmVyLmxlbmd0aCA9PT0gMCB8fCBvbGROYXZiYXJJbm5lclswXSA9PT0gbmV3TmF2YmFySW5uZXJbMF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGR5bmFtaWNOYXZiYXIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBtYW5pcHVsYXRlRG9tID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgc2V0UGFnZXMoKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKCFmb3JjZSkge1xuICAgICAgICAgICAgICAgIC8vIEdvIGJhY2sgd2hlbiB0aGVyZSBpcyBubyBwYWdlcyBvbiBsZWZ0XG4gICAgICAgICAgICAgICAgaWYgKCFwcmVsb2FkT25seSkge1xuICAgICAgICAgICAgICAgICAgICB2aWV3LnVybCA9IHZpZXcuaGlzdG9yeVt2aWV3Lmhpc3RvcnkubGVuZ3RoIC0gMl07XG4gICAgICAgICAgICAgICAgICAgIHVybCA9IHZpZXcudXJsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyc2VOZXdQYWdlKCk7XG4gICAgICAgICAgICAgICAgICAgIHNldFBhZ2VzKCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAocGFnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IGRvbSBjYWNoZWQgcGFnZXNcbiAgICAgICAgICAgICAgICAgICAgbmV3UGFnZSA9ICQodmlld0NvbnRhaW5lcikuZmluZCgnLnBhZ2VbZGF0YS1wYWdlPVwiJyArIHBhZ2VOYW1lICsgJ1wiXScpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3TmF2YmFySW5uZXIgPSAkKHZpZXdDb250YWluZXIpLmZpbmQoJy5uYXZiYXItaW5uZXJbZGF0YS1wYWdlPVwiJyArIHBhZ2VOYW1lICsgJ1wiXScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld05hdmJhcklubmVyLmxlbmd0aCA9PT0gMCAmJiBuZXdQYWdlWzBdLmY3UmVsYXRlZE5hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld05hdmJhcklubmVyID0gJChuZXdQYWdlWzBdLmY3UmVsYXRlZE5hdmJhcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3TmF2YmFySW5uZXIubGVuZ3RoID09PSAwICYmIG5ld1BhZ2VbMF0uZjdQYWdlRGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld05hdmJhcklubmVyID0gJChuZXdQYWdlWzBdLmY3UGFnZURhdGEubmF2YmFySW5uZXJDb250YWluZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHNldFBhZ2VzKCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuYWxsb3dQYWdlQ2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmICh1cmwgJiYgdXJsID09PSB2aWV3LnVybCB8fCBwYWdlTmFtZSAmJiB2aWV3LmFjdGl2ZVBhZ2UgJiYgdmlldy5hY3RpdmVQYWdlLm5hbWUgPT09IHBhZ2VOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuYWxsb3dQYWdlQ2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBHbyBiYWNrIHdpdGggZm9yY2UgdXJsXG4gICAgICAgICAgICAgICAgaWYgKGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyc2VOZXdQYWdlKCk7XG4gICAgICAgICAgICAgICAgICAgIHNldFBhZ2VzKCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAocGFnZU5hbWUgJiYgdmlldy5wYXJhbXMuZG9tQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2VOYW1lKSB1cmwgPSAnIycgKyBwYWdlTmFtZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIG5ld1BhZ2UgPSAkKHZpZXdDb250YWluZXIpLmZpbmQoJy5wYWdlW2RhdGEtcGFnZT1cIicgKyBwYWdlTmFtZSArICdcIl0nKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1BhZ2VbMF0uZjdQYWdlRGF0YSAmJiBuZXdQYWdlWzBdLmY3UGFnZURhdGEudXJsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cmwgPSBuZXdQYWdlWzBdLmY3UGFnZURhdGEudXJsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5keW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdOYXZiYXJJbm5lciA9ICQodmlld0NvbnRhaW5lcikuZmluZCgnLm5hdmJhci1pbm5lcltkYXRhLXBhZ2U9XCInICsgcGFnZU5hbWUgKyAnXCJdJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3TmF2YmFySW5uZXIubGVuZ3RoID09PSAwICYmIG5ld1BhZ2VbMF0uZjdSZWxhdGVkTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3TmF2YmFySW5uZXIgPSAkKG5ld1BhZ2VbMF0uZjdSZWxhdGVkTmF2YmFyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdOYXZiYXJJbm5lci5sZW5ndGggPT09IDAgJiYgbmV3UGFnZVswXS5mN1BhZ2VEYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3TmF2YmFySW5uZXIgPSAkKG5ld1BhZ2VbMF0uZjdQYWdlRGF0YS5uYXZiYXJJbm5lckNvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgc2V0UGFnZXMoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnJvdXRlci5iYWNrID0gZnVuY3Rpb24gKHZpZXcsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgIGlmIChhcHAucm91dGVyLnByZXJvdXRlKHZpZXcsIG9wdGlvbnMpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgICAgICAgICB2YXIgdXJsID0gb3B0aW9ucy51cmw7XG4gICAgICAgICAgICB2YXIgY29udGVudCA9IG9wdGlvbnMuY29udGVudDtcbiAgICAgICAgICAgIHZhciBwYWdlTmFtZSA9IG9wdGlvbnMucGFnZU5hbWU7XG4gICAgICAgICAgICBpZiAocGFnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICBpZiAocGFnZU5hbWUuaW5kZXhPZignPycpID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnF1ZXJ5ID0gJC5wYXJzZVVybFF1ZXJ5KHBhZ2VOYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5wYWdlTmFtZSA9IHBhZ2VOYW1lID0gcGFnZU5hbWUuc3BsaXQoJz8nKVswXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgZm9yY2UgPSBvcHRpb25zLmZvcmNlO1xuICAgICAgICAgICAgaWYgKCF2aWV3LmFsbG93UGFnZUNoYW5nZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmIChhcHAueGhyICYmIHZpZXcueGhyICYmIHZpZXcueGhyID09PSBhcHAueGhyKSB7XG4gICAgICAgICAgICAgICAgYXBwLnhoci5hYm9ydCgpO1xuICAgICAgICAgICAgICAgIGFwcC54aHIgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBwYWdlc0luVmlldyA9ICQodmlldy5wYWdlc0NvbnRhaW5lcikuZmluZCgnLnBhZ2U6bm90KC5jYWNoZWQpJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgZnVuY3Rpb24gcHJvY2VlZChjb250ZW50KSB7XG4gICAgICAgICAgICAgICAgYXBwLnJvdXRlci5wcmVwcm9jZXNzKHZpZXcsIGNvbnRlbnQsIHVybCwgZnVuY3Rpb24gKGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5jb250ZW50ID0gY29udGVudDtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci5fYmFjayh2aWV3LCBvcHRpb25zKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwYWdlc0luVmlldy5sZW5ndGggPiAxICYmICFmb3JjZSkge1xuICAgICAgICAgICAgICAgIC8vIFNpbXBsZSBnbyBiYWNrIHRvIHByZXZpb3MgcGFnZSBpbiB2aWV3XG4gICAgICAgICAgICAgICAgYXBwLnJvdXRlci5fYmFjayh2aWV3LCBvcHRpb25zKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIWZvcmNlKSB7XG4gICAgICAgICAgICAgICAgdXJsID0gb3B0aW9ucy51cmwgPSB2aWV3Lmhpc3Rvcnlbdmlldy5oaXN0b3J5Lmxlbmd0aCAtIDJdO1xuICAgICAgICAgICAgICAgIGlmICghdXJsKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuYWxsb3dQYWdlQ2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodXJsLmluZGV4T2YoJyMnKSA9PT0gMCAmJiB2aWV3LmNvbnRlbnRDYWNoZVt1cmxdKSB7XG4gICAgICAgICAgICAgICAgICAgIHByb2NlZWQodmlldy5jb250ZW50Q2FjaGVbdXJsXSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodXJsLmluZGV4T2YoJyMnKSA9PT0gMCAmJiB2aWV3LnBhcmFtcy5kb21DYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXBhZ2VOYW1lKSBvcHRpb25zLnBhZ2VOYW1lID0gdXJsLnNwbGl0KCcjJylbMV07XG4gICAgICAgICAgICAgICAgICAgIHByb2NlZWQoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmICh1cmwuaW5kZXhPZignIycpICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIExvYWQgYWpheCBwYWdlXG4gICAgICAgICAgICAgICAgICAgIGFwcC5nZXQob3B0aW9ucy51cmwsIHZpZXcsIG9wdGlvbnMuaWdub3JlQ2FjaGUsIGZ1bmN0aW9uIChjb250ZW50LCBlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2NlZWQoY29udGVudCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gR28gYmFjayB3aXRoIGZvcmNlIHVybFxuICAgICAgICAgICAgICAgIGlmICghdXJsICYmIGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvY2VlZChjb250ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmICghdXJsICYmIHBhZ2VOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYWdlTmFtZSkgdXJsID0gJyMnICsgcGFnZU5hbWU7XG4gICAgICAgICAgICAgICAgICAgIHByb2NlZWQoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmICh1cmwpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLmdldChvcHRpb25zLnVybCwgdmlldywgb3B0aW9ucy5pZ25vcmVDYWNoZSwgZnVuY3Rpb24gKGNvbnRlbnQsIGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2VlZChjb250ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IHRydWU7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBhcHAucm91dGVyLmFmdGVyQmFjayA9IGZ1bmN0aW9uICh2aWV3LCBvbGRQYWdlLCBuZXdQYWdlKSB7XG4gICAgICAgICAgICAvLyBSZW1vdmUgb2xkIHBhZ2UgYW5kIHNldCBjbGFzc2VzIG9uIG5ldyBvbmVcbiAgICAgICAgICAgIG9sZFBhZ2UgPSAkKG9sZFBhZ2UpO1xuICAgICAgICAgICAgbmV3UGFnZSA9ICQobmV3UGFnZSk7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlICYmIHZpZXcuaW5pdGlhbFBhZ2VzLmluZGV4T2Yob2xkUGFnZVswXSkgPj0gMCkge1xuICAgICAgICAgICAgICAgIG9sZFBhZ2UucmVtb3ZlQ2xhc3MoJ3BhZ2UtZnJvbS1jZW50ZXItdG8tcmlnaHQnKS5hZGRDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBhcHAucGFnZVJlbW92ZUNhbGxiYWNrKHZpZXcsIG9sZFBhZ2VbMF0sICdyaWdodCcpO1xuICAgICAgICAgICAgICAgIG9sZFBhZ2UucmVtb3ZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgbmV3UGFnZS5yZW1vdmVDbGFzcygncGFnZS1mcm9tLWxlZnQtdG8tY2VudGVyIHBhZ2Utb24tbGVmdCcpLmFkZENsYXNzKCdwYWdlLW9uLWNlbnRlcicpO1xuICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFVwZGF0ZSBWaWV3J3MgSGlzdG9yeVxuICAgICAgICAgICAgdmFyIHByZXZpb3VzVVJMID0gdmlldy5oaXN0b3J5LnBvcCgpO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBuZXdOYXZiYXI7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVXBkYXRlZCBkeW5hbWljIG5hdmJhclxuICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICB2YXIgaW5uZXJzID0gJCh2aWV3LmNvbnRhaW5lcikuZmluZCgnLm5hdmJhci1pbm5lcjpub3QoLmNhY2hlZCknKTtcbiAgICAgICAgICAgICAgICB2YXIgb2xkTmF2YmFyID0gJChvbGRQYWdlWzBdLmY3UmVsYXRlZE5hdmJhciB8fCBpbm5lcnNbMV0pO1xuICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5kb21DYWNoZSAmJiB2aWV3LmluaXRpYWxOYXZiYXJzLmluZGV4T2Yob2xkTmF2YmFyWzBdKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG9sZE5hdmJhci5yZW1vdmVDbGFzcygnbmF2YmFyLWZyb20tY2VudGVyLXRvLXJpZ2h0JykuYWRkQ2xhc3MoJ2NhY2hlZCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLm5hdmJhclJlbW92ZUNhbGxiYWNrKHZpZXcsIG9sZFBhZ2VbMF0sIHVuZGVmaW5lZCwgb2xkTmF2YmFyWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgb2xkTmF2YmFyLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBuZXdOYXZiYXIgPSAkKGlubmVyc1swXSkucmVtb3ZlQ2xhc3MoJ25hdmJhci1vbi1sZWZ0IG5hdmJhci1mcm9tLWxlZnQtdG8tY2VudGVyJykuYWRkQ2xhc3MoJ25hdmJhci1vbi1jZW50ZXInKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBSZW1vdmUgcGFnZXMgaW4gZG9tIGNhY2hlXG4gICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuZG9tQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICAkKHZpZXcuY29udGFpbmVyKS5maW5kKCcucGFnZS5jYWNoZWQnKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhZ2UgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSBwYWdlLmluZGV4KCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwYWdlVXJsID0gcGFnZVswXS5mN1BhZ2VEYXRhICYmIHBhZ2VbMF0uZjdQYWdlRGF0YS51cmw7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYWdlVXJsICYmIHZpZXcuaGlzdG9yeS5pbmRleE9mKHBhZ2VVcmwpIDwgMCAmJiB2aWV3LmluaXRpYWxQYWdlcy5pbmRleE9mKHRoaXMpIDwgMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnBhZ2VSZW1vdmVDYWxsYmFjayh2aWV3LCBwYWdlWzBdLCAncmlnaHQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYWdlWzBdLmY3UmVsYXRlZE5hdmJhciAmJiB2aWV3LnBhcmFtcy5keW5hbWljTmF2YmFyKSBhcHAubmF2YmFyUmVtb3ZlQ2FsbGJhY2sodmlldywgcGFnZVswXSwgdW5kZWZpbmVkLCBwYWdlWzBdLmY3UmVsYXRlZE5hdmJhcik7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2VbMF0uZjdSZWxhdGVkTmF2YmFyICYmIHZpZXcucGFyYW1zLmR5bmFtaWNOYXZiYXIpICQocGFnZVswXS5mN1JlbGF0ZWROYXZiYXIpLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ2hlY2sgcHJldmlvdXMgcGFnZSBpcyBjb250ZW50IGJhc2VkIG9ubHkgYW5kIHJlbW92ZSBpdCBmcm9tIGNvbnRlbnQgY2FjaGVcbiAgICAgICAgICAgIGlmICghdmlldy5wYXJhbXMuZG9tQ2FjaGUgJiZcbiAgICAgICAgICAgICAgICBwcmV2aW91c1VSTCAmJlxuICAgICAgICAgICAgICAgIHByZXZpb3VzVVJMLmluZGV4T2YoJyMnKSA+IC0xICYmXG4gICAgICAgICAgICAgICAgKHByZXZpb3VzVVJMIGluIHZpZXcuY29udGVudENhY2hlKSAmJlxuICAgICAgICAgICAgICAgIC8vIElmIHRoZSBzYW1lIHBhZ2UgaXMgaW4gdGhlIGhpc3RvcnkgbXVsdGlwbGUgdGltZXMsIGRvbid0IHJlbW92ZSBpdC5cbiAgICAgICAgICAgICAgICB2aWV3Lmhpc3RvcnkuaW5kZXhPZihwcmV2aW91c1VSTCkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgdmlldy5jb250ZW50Q2FjaGVbcHJldmlvdXNVUkxdID0gbnVsbDtcbiAgICAgICAgICAgICAgICBkZWxldGUgdmlldy5jb250ZW50Q2FjaGVbcHJldmlvdXNVUkxdO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnB1c2hTdGF0ZSAmJiB2aWV3Lm1haW4pIGFwcC5wdXNoU3RhdGVDbGVhclF1ZXVlKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUHJlbG9hZCBwcmV2aW91cyBwYWdlXG4gICAgICAgICAgICBpZiAodmlldy5wYXJhbXMucHJlbG9hZFByZXZpb3VzUGFnZSkge1xuICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5kb21DYWNoZSAmJiB2aWV3Lmhpc3RvcnkubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcHJlbG9hZFVybCA9IHZpZXcuaGlzdG9yeVt2aWV3Lmhpc3RvcnkubGVuZ3RoIC0gMl07XG4gICAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c1BhZ2U7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c05hdmJhcjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByZWxvYWRVcmwgJiYgdmlldy5wYWdlc0NhY2hlW3ByZWxvYWRVcmxdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBMb2FkIGJ5IHBhZ2UgbmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNQYWdlID0gJCh2aWV3LmNvbnRhaW5lcikuZmluZCgnLnBhZ2VbZGF0YS1wYWdlPVwiJyArIHZpZXcucGFnZXNDYWNoZVtwcmVsb2FkVXJsXSArICdcIl0nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c1BhZ2UubmV4dCgnLnBhZ2UnKVswXSAhPT0gbmV3UGFnZVswXSkgcHJldmlvdXNQYWdlLmluc2VydEJlZm9yZShuZXdQYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05hdmJhciA9ICQodmlldy5jb250YWluZXIpLmZpbmQoJy5uYXZiYXItaW5uZXJbZGF0YS1wYWdlPVwiJyArIHZpZXcucGFnZXNDYWNoZVtwcmVsb2FkVXJsXSArICdcIl0nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZighcHJldmlvdXNOYXZiYXIgfHwgcHJldmlvdXNOYXZiYXIubGVuZ3RoID09PSAwKSBwcmV2aW91c05hdmJhciA9IG5ld05hdmJhci5wcmV2KCcubmF2YmFyLWlubmVyLmNhY2hlZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c05hdmJhci5uZXh0KCcubmF2YmFyLWlubmVyJylbMF0gIT09IG5ld05hdmJhclswXSkgcHJldmlvdXNOYXZiYXIuaW5zZXJ0QmVmb3JlKG5ld05hdmJhcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBKdXN0IGxvYWQgcHJldmlvdXMgcGFnZVxuICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNQYWdlID0gbmV3UGFnZS5wcmV2KCcucGFnZS5jYWNoZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdOYXZiYXIpIHByZXZpb3VzTmF2YmFyID0gbmV3TmF2YmFyLnByZXYoJy5uYXZiYXItaW5uZXIuY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzUGFnZSAmJiBwcmV2aW91c1BhZ2UubGVuZ3RoID4gMCkgcHJldmlvdXNQYWdlLnJlbW92ZUNsYXNzKCdjYWNoZWQgcGFnZS1vbi1yaWdodCBwYWdlLW9uLWNlbnRlcicpLmFkZENsYXNzKCdwYWdlLW9uLWxlZnQnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmF2YmFyICYmIHByZXZpb3VzTmF2YmFyLmxlbmd0aCA+IDApIHByZXZpb3VzTmF2YmFyLnJlbW92ZUNsYXNzKCdjYWNoZWQgbmF2YmFyLW9uLXJpZ2h0IG5hdmJhci1vbi1jZW50ZXInKS5hZGRDbGFzcygnbmF2YmFyLW9uLWxlZnQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIuYmFjayh2aWV3LCB7cHJlbG9hZE9ubHk6IHRydWV9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIE1vZGFscyAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICB2YXIgX21vZGFsVGVtcGxhdGVUZW1wRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgIGFwcC5tb2RhbFN0YWNrID0gW107XG4gICAgICAgIGFwcC5tb2RhbFN0YWNrQ2xlYXJRdWV1ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmIChhcHAubW9kYWxTdGFjay5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAoYXBwLm1vZGFsU3RhY2suc2hpZnQoKSkoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgYXBwLm1vZGFsID0gZnVuY3Rpb24gKHBhcmFtcykge1xuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xuICAgICAgICAgICAgdmFyIG1vZGFsSFRNTCA9ICcnO1xuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubW9kYWxUZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgIGlmICghYXBwLl9jb21waWxlZFRlbXBsYXRlcy5tb2RhbCkgYXBwLl9jb21waWxlZFRlbXBsYXRlcy5tb2RhbCA9IHQ3LmNvbXBpbGUoYXBwLnBhcmFtcy5tb2RhbFRlbXBsYXRlKTtcbiAgICAgICAgICAgICAgICBtb2RhbEhUTUwgPSBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLm1vZGFsKHBhcmFtcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgYnV0dG9uc0hUTUwgPSAnJztcbiAgICAgICAgICAgICAgICBpZiAocGFyYW1zLmJ1dHRvbnMgJiYgcGFyYW1zLmJ1dHRvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcmFtcy5idXR0b25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBidXR0b25zSFRNTCArPSAnPHNwYW4gY2xhc3M9XCJtb2RhbC1idXR0b24nICsgKHBhcmFtcy5idXR0b25zW2ldLmJvbGQgPyAnIG1vZGFsLWJ1dHRvbi1ib2xkJyA6ICcnKSArICdcIj4nICsgcGFyYW1zLmJ1dHRvbnNbaV0udGV4dCArICc8L3NwYW4+JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgdGl0bGVIVE1MID0gcGFyYW1zLnRpdGxlID8gJzxkaXYgY2xhc3M9XCJtb2RhbC10aXRsZVwiPicgKyBwYXJhbXMudGl0bGUgKyAnPC9kaXY+JyA6ICcnO1xuICAgICAgICAgICAgICAgIHZhciB0ZXh0SFRNTCA9IHBhcmFtcy50ZXh0ID8gJzxkaXYgY2xhc3M9XCJtb2RhbC10ZXh0XCI+JyArIHBhcmFtcy50ZXh0ICsgJzwvZGl2PicgOiAnJztcbiAgICAgICAgICAgICAgICB2YXIgYWZ0ZXJUZXh0SFRNTCA9IHBhcmFtcy5hZnRlclRleHQgPyBwYXJhbXMuYWZ0ZXJUZXh0IDogJyc7XG4gICAgICAgICAgICAgICAgdmFyIG5vQnV0dG9ucyA9ICFwYXJhbXMuYnV0dG9ucyB8fCBwYXJhbXMuYnV0dG9ucy5sZW5ndGggPT09IDAgPyAnbW9kYWwtbm8tYnV0dG9ucycgOiAnJztcbiAgICAgICAgICAgICAgICB2YXIgdmVydGljYWxCdXR0b25zID0gcGFyYW1zLnZlcnRpY2FsQnV0dG9ucyA/ICdtb2RhbC1idXR0b25zLXZlcnRpY2FsJzogJyc7XG4gICAgICAgICAgICAgICAgdmFyIG1vZGFsQnV0dG9uc0hUTUwgPSBwYXJhbXMuYnV0dG9ucyAmJiBwYXJhbXMuYnV0dG9ucy5sZW5ndGggPiAwID8gJzxkaXYgY2xhc3M9XCJtb2RhbC1idXR0b25zIG1vZGFsLWJ1dHRvbnMtJyArIHBhcmFtcy5idXR0b25zLmxlbmd0aCArICcgJyArIHZlcnRpY2FsQnV0dG9ucyArICdcIj4nICsgYnV0dG9uc0hUTUwgKyAnPC9kaXY+JyA6ICcnO1xuICAgICAgICAgICAgICAgIG1vZGFsSFRNTCA9ICc8ZGl2IGNsYXNzPVwibW9kYWwgJyArIG5vQnV0dG9ucyArICcgJyArIChwYXJhbXMuY3NzQ2xhc3MgfHwgJycpICsgJ1wiPjxkaXYgY2xhc3M9XCJtb2RhbC1pbm5lclwiPicgKyAodGl0bGVIVE1MICsgdGV4dEhUTUwgKyBhZnRlclRleHRIVE1MKSArICc8L2Rpdj4nICsgbW9kYWxCdXR0b25zSFRNTCArICc8L2Rpdj4nO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIF9tb2RhbFRlbXBsYXRlVGVtcERpdi5pbm5lckhUTUwgPSBtb2RhbEhUTUw7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIG1vZGFsID0gJChfbW9kYWxUZW1wbGF0ZVRlbXBEaXYpLmNoaWxkcmVuKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgJCgnYm9keScpLmFwcGVuZChtb2RhbFswXSk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQWRkIGV2ZW50cyBvbiBidXR0b25zXG4gICAgICAgICAgICBtb2RhbC5maW5kKCcubW9kYWwtYnV0dG9uJykuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGVsKSB7XG4gICAgICAgICAgICAgICAgJChlbCkub24oJ2NsaWNrJywgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5idXR0b25zW2luZGV4XS5jbG9zZSAhPT0gZmFsc2UpIGFwcC5jbG9zZU1vZGFsKG1vZGFsKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5idXR0b25zW2luZGV4XS5vbkNsaWNrKSBwYXJhbXMuYnV0dG9uc1tpbmRleF0ub25DbGljayhtb2RhbCwgZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbXMub25DbGljaykgcGFyYW1zLm9uQ2xpY2sobW9kYWwsIGluZGV4KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgYXBwLm9wZW5Nb2RhbChtb2RhbCk7XG4gICAgICAgICAgICByZXR1cm4gbW9kYWxbMF07XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5hbGVydCA9IGZ1bmN0aW9uICh0ZXh0LCB0aXRsZSwgY2FsbGJhY2tPaykge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB0aXRsZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrT2sgPSBhcmd1bWVudHNbMV07XG4gICAgICAgICAgICAgICAgdGl0bGUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYXBwLm1vZGFsKHtcbiAgICAgICAgICAgICAgICB0ZXh0OiB0ZXh0IHx8ICcnLFxuICAgICAgICAgICAgICAgIHRpdGxlOiB0eXBlb2YgdGl0bGUgPT09ICd1bmRlZmluZWQnID8gYXBwLnBhcmFtcy5tb2RhbFRpdGxlIDogdGl0bGUsXG4gICAgICAgICAgICAgICAgYnV0dG9uczogWyB7dGV4dDogYXBwLnBhcmFtcy5tb2RhbEJ1dHRvbk9rLCBib2xkOiB0cnVlLCBvbkNsaWNrOiBjYWxsYmFja09rfSBdXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmNvbmZpcm0gPSBmdW5jdGlvbiAodGV4dCwgdGl0bGUsIGNhbGxiYWNrT2ssIGNhbGxiYWNrQ2FuY2VsKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHRpdGxlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tDYW5jZWwgPSBhcmd1bWVudHNbMl07XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tPayA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgICAgICAgICB0aXRsZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBhcHAubW9kYWwoe1xuICAgICAgICAgICAgICAgIHRleHQ6IHRleHQgfHwgJycsXG4gICAgICAgICAgICAgICAgdGl0bGU6IHR5cGVvZiB0aXRsZSA9PT0gJ3VuZGVmaW5lZCcgPyBhcHAucGFyYW1zLm1vZGFsVGl0bGUgOiB0aXRsZSxcbiAgICAgICAgICAgICAgICBidXR0b25zOiBbXG4gICAgICAgICAgICAgICAgICAgIHt0ZXh0OiBhcHAucGFyYW1zLm1vZGFsQnV0dG9uQ2FuY2VsLCBvbkNsaWNrOiBjYWxsYmFja0NhbmNlbH0sXG4gICAgICAgICAgICAgICAgICAgIHt0ZXh0OiBhcHAucGFyYW1zLm1vZGFsQnV0dG9uT2ssIGJvbGQ6IHRydWUsIG9uQ2xpY2s6IGNhbGxiYWNrT2t9XG4gICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5wcm9tcHQgPSBmdW5jdGlvbiAodGV4dCwgdGl0bGUsIGNhbGxiYWNrT2ssIGNhbGxiYWNrQ2FuY2VsKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHRpdGxlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tDYW5jZWwgPSBhcmd1bWVudHNbMl07XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tPayA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgICAgICAgICB0aXRsZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBhcHAubW9kYWwoe1xuICAgICAgICAgICAgICAgIHRleHQ6IHRleHQgfHwgJycsXG4gICAgICAgICAgICAgICAgdGl0bGU6IHR5cGVvZiB0aXRsZSA9PT0gJ3VuZGVmaW5lZCcgPyBhcHAucGFyYW1zLm1vZGFsVGl0bGUgOiB0aXRsZSxcbiAgICAgICAgICAgICAgICBhZnRlclRleHQ6ICc8ZGl2IGNsYXNzPVwiaW5wdXQtZmllbGRcIj48aW5wdXQgdHlwZT1cInRleHRcIiBjbGFzcz1cIm1vZGFsLXRleHQtaW5wdXRcIj48L2Rpdj4nLFxuICAgICAgICAgICAgICAgIGJ1dHRvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogYXBwLnBhcmFtcy5tb2RhbEJ1dHRvbkNhbmNlbFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBhcHAucGFyYW1zLm1vZGFsQnV0dG9uT2ssXG4gICAgICAgICAgICAgICAgICAgICAgICBib2xkOiB0cnVlXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIG9uQ2xpY2s6IGZ1bmN0aW9uIChtb2RhbCwgaW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSAwICYmIGNhbGxiYWNrQ2FuY2VsKSBjYWxsYmFja0NhbmNlbCgkKG1vZGFsKS5maW5kKCcubW9kYWwtdGV4dC1pbnB1dCcpLnZhbCgpKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSAxICYmIGNhbGxiYWNrT2spIGNhbGxiYWNrT2soJChtb2RhbCkuZmluZCgnLm1vZGFsLXRleHQtaW5wdXQnKS52YWwoKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5tb2RhbExvZ2luID0gZnVuY3Rpb24gKHRleHQsIHRpdGxlLCBjYWxsYmFja09rLCBjYWxsYmFja0NhbmNlbCkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB0aXRsZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrQ2FuY2VsID0gYXJndW1lbnRzWzJdO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrT2sgPSBhcmd1bWVudHNbMV07XG4gICAgICAgICAgICAgICAgdGl0bGUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYXBwLm1vZGFsKHtcbiAgICAgICAgICAgICAgICB0ZXh0OiB0ZXh0IHx8ICcnLFxuICAgICAgICAgICAgICAgIHRpdGxlOiB0eXBlb2YgdGl0bGUgPT09ICd1bmRlZmluZWQnID8gYXBwLnBhcmFtcy5tb2RhbFRpdGxlIDogdGl0bGUsXG4gICAgICAgICAgICAgICAgYWZ0ZXJUZXh0OiAnPGRpdiBjbGFzcz1cImlucHV0LWZpZWxkIG1vZGFsLWlucHV0LWRvdWJsZVwiPjxpbnB1dCB0eXBlPVwidGV4dFwiIG5hbWU9XCJtb2RhbC11c2VybmFtZVwiIHBsYWNlaG9sZGVyPVwiJyArIGFwcC5wYXJhbXMubW9kYWxVc2VybmFtZVBsYWNlaG9sZGVyICsgJ1wiIGNsYXNzPVwibW9kYWwtdGV4dC1pbnB1dFwiPjwvZGl2PjxkaXYgY2xhc3M9XCJpbnB1dC1maWVsZCBtb2RhbC1pbnB1dC1kb3VibGVcIj48aW5wdXQgdHlwZT1cInBhc3N3b3JkXCIgbmFtZT1cIm1vZGFsLXBhc3N3b3JkXCIgcGxhY2Vob2xkZXI9XCInICsgYXBwLnBhcmFtcy5tb2RhbFBhc3N3b3JkUGxhY2Vob2xkZXIgKyAnXCIgY2xhc3M9XCJtb2RhbC10ZXh0LWlucHV0XCI+PC9kaXY+JyxcbiAgICAgICAgICAgICAgICBidXR0b25zOiBbXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IGFwcC5wYXJhbXMubW9kYWxCdXR0b25DYW5jZWxcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogYXBwLnBhcmFtcy5tb2RhbEJ1dHRvbk9rLFxuICAgICAgICAgICAgICAgICAgICAgICAgYm9sZDogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXSxcbiAgICAgICAgICAgICAgICBvbkNsaWNrOiBmdW5jdGlvbiAobW9kYWwsIGluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB1c2VybmFtZSA9ICQobW9kYWwpLmZpbmQoJy5tb2RhbC10ZXh0LWlucHV0W25hbWU9XCJtb2RhbC11c2VybmFtZVwiXScpLnZhbCgpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgcGFzc3dvcmQgPSAkKG1vZGFsKS5maW5kKCcubW9kYWwtdGV4dC1pbnB1dFtuYW1lPVwibW9kYWwtcGFzc3dvcmRcIl0nKS52YWwoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSAwICYmIGNhbGxiYWNrQ2FuY2VsKSBjYWxsYmFja0NhbmNlbCh1c2VybmFtZSwgcGFzc3dvcmQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IDEgJiYgY2FsbGJhY2tPaykgY2FsbGJhY2tPayh1c2VybmFtZSwgcGFzc3dvcmQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICBhcHAubW9kYWxQYXNzd29yZCA9IGZ1bmN0aW9uICh0ZXh0LCB0aXRsZSwgY2FsbGJhY2tPaywgY2FsbGJhY2tDYW5jZWwpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdGl0bGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFja0NhbmNlbCA9IGFyZ3VtZW50c1syXTtcbiAgICAgICAgICAgICAgICBjYWxsYmFja09rID0gYXJndW1lbnRzWzFdO1xuICAgICAgICAgICAgICAgIHRpdGxlID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGFwcC5tb2RhbCh7XG4gICAgICAgICAgICAgICAgdGV4dDogdGV4dCB8fCAnJyxcbiAgICAgICAgICAgICAgICB0aXRsZTogdHlwZW9mIHRpdGxlID09PSAndW5kZWZpbmVkJyA/IGFwcC5wYXJhbXMubW9kYWxUaXRsZSA6IHRpdGxlLFxuICAgICAgICAgICAgICAgIGFmdGVyVGV4dDogJzxkaXYgY2xhc3M9XCJpbnB1dC1maWVsZFwiPjxpbnB1dCB0eXBlPVwicGFzc3dvcmRcIiBuYW1lPVwibW9kYWwtcGFzc3dvcmRcIiBwbGFjZWhvbGRlcj1cIicgKyBhcHAucGFyYW1zLm1vZGFsUGFzc3dvcmRQbGFjZWhvbGRlciArICdcIiBjbGFzcz1cIm1vZGFsLXRleHQtaW5wdXRcIj48L2Rpdj4nLFxuICAgICAgICAgICAgICAgIGJ1dHRvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogYXBwLnBhcmFtcy5tb2RhbEJ1dHRvbkNhbmNlbFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBhcHAucGFyYW1zLm1vZGFsQnV0dG9uT2ssXG4gICAgICAgICAgICAgICAgICAgICAgICBib2xkOiB0cnVlXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIG9uQ2xpY2s6IGZ1bmN0aW9uIChtb2RhbCwgaW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhc3N3b3JkID0gJChtb2RhbCkuZmluZCgnLm1vZGFsLXRleHQtaW5wdXRbbmFtZT1cIm1vZGFsLXBhc3N3b3JkXCJdJykudmFsKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gMCAmJiBjYWxsYmFja0NhbmNlbCkgY2FsbGJhY2tDYW5jZWwocGFzc3dvcmQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IDEgJiYgY2FsbGJhY2tPaykgY2FsbGJhY2tPayhwYXNzd29yZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5zaG93UHJlbG9hZGVyID0gZnVuY3Rpb24gKHRpdGxlKSB7XG4gICAgICAgICAgICByZXR1cm4gYXBwLm1vZGFsKHtcbiAgICAgICAgICAgICAgICB0aXRsZTogdGl0bGUgfHwgYXBwLnBhcmFtcy5tb2RhbFByZWxvYWRlclRpdGxlLFxuICAgICAgICAgICAgICAgIHRleHQ6ICc8ZGl2IGNsYXNzPVwicHJlbG9hZGVyXCI+JyArIChhcHAucGFyYW1zLm1hdGVyaWFsID8gYXBwLnBhcmFtcy5tYXRlcmlhbFByZWxvYWRlckh0bWwgOiAnJykgKyAnPC9kaXY+JyxcbiAgICAgICAgICAgICAgICBjc3NDbGFzczogJ21vZGFsLXByZWxvYWRlcidcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuaGlkZVByZWxvYWRlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKCcubW9kYWwubW9kYWwtaW4nKTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnNob3dJbmRpY2F0b3IgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKCc8ZGl2IGNsYXNzPVwicHJlbG9hZGVyLWluZGljYXRvci1vdmVybGF5XCI+PC9kaXY+PGRpdiBjbGFzcz1cInByZWxvYWRlci1pbmRpY2F0b3ItbW9kYWxcIj48c3BhbiBjbGFzcz1cInByZWxvYWRlciBwcmVsb2FkZXItd2hpdGVcIj4nICsgKGFwcC5wYXJhbXMubWF0ZXJpYWwgPyBhcHAucGFyYW1zLm1hdGVyaWFsUHJlbG9hZGVySHRtbCA6ICcnKSArICc8L3NwYW4+PC9kaXY+Jyk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5oaWRlSW5kaWNhdG9yID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgJCgnLnByZWxvYWRlci1pbmRpY2F0b3Itb3ZlcmxheSwgLnByZWxvYWRlci1pbmRpY2F0b3ItbW9kYWwnKS5yZW1vdmUoKTtcbiAgICAgICAgfTtcbiAgICAgICAgLy8gQWN0aW9uIFNoZWV0XG4gICAgICAgIGFwcC5hY3Rpb25zID0gZnVuY3Rpb24gKHRhcmdldCwgcGFyYW1zKSB7XG4gICAgICAgICAgICB2YXIgdG9Qb3BvdmVyID0gZmFsc2UsIG1vZGFsLCBncm91cFNlbGVjdG9yLCBidXR0b25TZWxlY3RvcjtcbiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgLy8gQWN0aW9uc1xuICAgICAgICAgICAgICAgIHBhcmFtcyA9IHRhcmdldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIFBvcG92ZXJcbiAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5pb3MpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UuaXBhZCkgdG9Qb3BvdmVyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgkKHdpbmRvdykud2lkdGgoKSA+PSA3NjgpIHRvUG9wb3ZlciA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IFtdO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChwYXJhbXMubGVuZ3RoID4gMCAmJiAhJC5pc0FycmF5KHBhcmFtc1swXSkpIHtcbiAgICAgICAgICAgICAgICBwYXJhbXMgPSBbcGFyYW1zXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBtb2RhbEhUTUw7XG4gICAgICAgICAgICBpZiAodG9Qb3BvdmVyKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFjdGlvbnNUb1BvcG92ZXJUZW1wbGF0ZSA9IGFwcC5wYXJhbXMubW9kYWxBY3Rpb25zVG9Qb3BvdmVyVGVtcGxhdGUgfHxcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwb3BvdmVyIGFjdGlvbnMtcG9wb3ZlclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicG9wb3Zlci1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2VhY2ggdGhpc319JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImxpc3QtYmxvY2tcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgJzx1bD4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjZWFjaCB0aGlzfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgbGFiZWx9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8bGkgY2xhc3M9XCJhY3Rpb25zLXBvcG92ZXItbGFiZWwge3sjaWYgY29sb3J9fWNvbG9yLXt7Y29sb3J9fXt7L2lmfX0ge3sjaWYgYm9sZH19YWN0aW9ucy1wb3BvdmVyLWJvbGR7ey9pZn19XCI+e3t0ZXh0fX08L2xpPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7e2Vsc2V9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8bGk+PGEgaHJlZj1cIiNcIiBjbGFzcz1cIml0ZW0tbGluayBsaXN0LWJ1dHRvbiB7eyNpZiBjb2xvcn19Y29sb3Ite3tjb2xvcn19e3svaWZ9fSB7eyNpZiBiZ319Ymcte3tiZ319e3svaWZ9fSB7eyNpZiBib2xkfX1hY3Rpb25zLXBvcG92ZXItYm9sZHt7L2lmfX0ge3sjaWYgZGlzYWJsZWR9fWRpc2FibGVke3svaWZ9fVwiPnt7dGV4dH19PC9hPjwvbGk+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svZWFjaH19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICc8L3VsPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2VhY2h9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2Pic7XG4gICAgICAgICAgICAgICAgaWYgKCFhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLmFjdGlvbnNUb1BvcG92ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLl9jb21waWxlZFRlbXBsYXRlcy5hY3Rpb25zVG9Qb3BvdmVyID0gdDcuY29tcGlsZShhY3Rpb25zVG9Qb3BvdmVyVGVtcGxhdGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgcG9wb3ZlckhUTUwgPSBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLmFjdGlvbnNUb1BvcG92ZXIocGFyYW1zKTtcbiAgICAgICAgICAgICAgICBtb2RhbCA9ICQoYXBwLnBvcG92ZXIocG9wb3ZlckhUTUwsIHRhcmdldCwgdHJ1ZSkpO1xuICAgICAgICAgICAgICAgIGdyb3VwU2VsZWN0b3IgPSAnLmxpc3QtYmxvY2sgdWwnO1xuICAgICAgICAgICAgICAgIGJ1dHRvblNlbGVjdG9yID0gJy5saXN0LWJ1dHRvbic7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tb2RhbEFjdGlvbnNUZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWFwcC5fY29tcGlsZWRUZW1wbGF0ZXMuYWN0aW9ucykgYXBwLl9jb21waWxlZFRlbXBsYXRlcy5hY3Rpb25zID0gdDcuY29tcGlsZShhcHAucGFyYW1zLm1vZGFsQWN0aW9uc1RlbXBsYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgbW9kYWxIVE1MID0gYXBwLl9jb21waWxlZFRlbXBsYXRlcy5hY3Rpb25zKHBhcmFtcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB2YXIgYnV0dG9uc0hUTUwgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYXJhbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcGFyYW1zW2ldLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGogPT09IDApIGJ1dHRvbnNIVE1MICs9ICc8ZGl2IGNsYXNzPVwiYWN0aW9ucy1tb2RhbC1ncm91cFwiPic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvbiA9IHBhcmFtc1tpXVtqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYnV0dG9uQ2xhc3MgPSBidXR0b24ubGFiZWwgPyAnYWN0aW9ucy1tb2RhbC1sYWJlbCcgOiAnYWN0aW9ucy1tb2RhbC1idXR0b24nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChidXR0b24uYm9sZCkgYnV0dG9uQ2xhc3MgKz0gJyBhY3Rpb25zLW1vZGFsLWJ1dHRvbi1ib2xkJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnV0dG9uLmNvbG9yKSBidXR0b25DbGFzcyArPSAnIGNvbG9yLScgKyBidXR0b24uY29sb3I7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1dHRvbi5iZykgYnV0dG9uQ2xhc3MgKz0gJyBiZy0nICsgYnV0dG9uLmJnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChidXR0b24uZGlzYWJsZWQpIGJ1dHRvbkNsYXNzICs9ICcgZGlzYWJsZWQnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbnNIVE1MICs9ICc8ZGl2IGNsYXNzPVwiJyArIGJ1dHRvbkNsYXNzICsgJ1wiPicgKyBidXR0b24udGV4dCArICc8L2Rpdj4nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqID09PSBwYXJhbXNbaV0ubGVuZ3RoIC0gMSkgYnV0dG9uc0hUTUwgKz0gJzwvZGl2Pic7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgbW9kYWxIVE1MID0gJzxkaXYgY2xhc3M9XCJhY3Rpb25zLW1vZGFsXCI+JyArIGJ1dHRvbnNIVE1MICsgJzwvZGl2Pic7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIF9tb2RhbFRlbXBsYXRlVGVtcERpdi5pbm5lckhUTUwgPSBtb2RhbEhUTUw7XG4gICAgICAgICAgICAgICAgbW9kYWwgPSAkKF9tb2RhbFRlbXBsYXRlVGVtcERpdikuY2hpbGRyZW4oKTtcbiAgICAgICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKG1vZGFsWzBdKTtcbiAgICAgICAgICAgICAgICBncm91cFNlbGVjdG9yID0gJy5hY3Rpb25zLW1vZGFsLWdyb3VwJztcbiAgICAgICAgICAgICAgICBidXR0b25TZWxlY3RvciA9ICcuYWN0aW9ucy1tb2RhbC1idXR0b24nO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIHZhciBncm91cHMgPSBtb2RhbC5maW5kKGdyb3VwU2VsZWN0b3IpO1xuICAgICAgICAgICAgZ3JvdXBzLmVhY2goZnVuY3Rpb24gKGluZGV4LCBlbCkge1xuICAgICAgICAgICAgICAgIHZhciBncm91cEluZGV4ID0gaW5kZXg7XG4gICAgICAgICAgICAgICAgJChlbCkuY2hpbGRyZW4oKS5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvbkluZGV4ID0gaW5kZXg7XG4gICAgICAgICAgICAgICAgICAgIHZhciBidXR0b25QYXJhbXMgPSBwYXJhbXNbZ3JvdXBJbmRleF1bYnV0dG9uSW5kZXhdO1xuICAgICAgICAgICAgICAgICAgICB2YXIgY2xpY2tUYXJnZXQ7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdG9Qb3BvdmVyICYmICQoZWwpLmlzKGJ1dHRvblNlbGVjdG9yKSkgY2xpY2tUYXJnZXQgPSAkKGVsKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRvUG9wb3ZlciAmJiAkKGVsKS5maW5kKGJ1dHRvblNlbGVjdG9yKS5sZW5ndGggPiAwKSBjbGlja1RhcmdldCA9ICQoZWwpLmZpbmQoYnV0dG9uU2VsZWN0b3IpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNsaWNrVGFyZ2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGlja1RhcmdldC5vbignY2xpY2snLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChidXR0b25QYXJhbXMuY2xvc2UgIT09IGZhbHNlKSBhcHAuY2xvc2VNb2RhbChtb2RhbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1dHRvblBhcmFtcy5vbkNsaWNrKSBidXR0b25QYXJhbXMub25DbGljayhtb2RhbCwgZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoIXRvUG9wb3ZlcikgYXBwLm9wZW5Nb2RhbChtb2RhbCk7XG4gICAgICAgICAgICByZXR1cm4gbW9kYWxbMF07XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5wb3BvdmVyID0gZnVuY3Rpb24gKG1vZGFsLCB0YXJnZXQsIHJlbW92ZU9uQ2xvc2UpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVtb3ZlT25DbG9zZSA9PT0gJ3VuZGVmaW5lZCcpIHJlbW92ZU9uQ2xvc2UgPSB0cnVlO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBtb2RhbCA9PT0gJ3N0cmluZycgJiYgbW9kYWwuaW5kZXhPZignPCcpID49IDApIHtcbiAgICAgICAgICAgICAgICB2YXIgX21vZGFsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgICAgICAgICAgX21vZGFsLmlubmVySFRNTCA9IG1vZGFsLnRyaW0oKTtcbiAgICAgICAgICAgICAgICBpZiAoX21vZGFsLmNoaWxkTm9kZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBtb2RhbCA9IF9tb2RhbC5jaGlsZE5vZGVzWzBdO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVtb3ZlT25DbG9zZSkgbW9kYWwuY2xhc3NMaXN0LmFkZCgncmVtb3ZlLW9uLWNsb3NlJyk7XG4gICAgICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hcHBlbmQobW9kYWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBmYWxzZTsgLy9ub3RoaW5nIGZvdW5kXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtb2RhbCA9ICQobW9kYWwpO1xuICAgICAgICAgICAgdGFyZ2V0ID0gJCh0YXJnZXQpO1xuICAgICAgICAgICAgaWYgKG1vZGFsLmxlbmd0aCA9PT0gMCB8fCB0YXJnZXQubGVuZ3RoID09PSAwKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICBpZiAobW9kYWwucGFyZW50cygnYm9keScpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGlmIChyZW1vdmVPbkNsb3NlKSBtb2RhbC5hZGRDbGFzcygncmVtb3ZlLW9uLWNsb3NlJyk7XG4gICAgICAgICAgICAgICAgJCgnYm9keScpLmFwcGVuZChtb2RhbFswXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobW9kYWwuZmluZCgnLnBvcG92ZXItYW5nbGUnKS5sZW5ndGggPT09IDAgJiYgIWFwcC5wYXJhbXMubWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgICBtb2RhbC5hcHBlbmQoJzxkaXYgY2xhc3M9XCJwb3BvdmVyLWFuZ2xlXCI+PC9kaXY+Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtb2RhbC5zaG93KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIG1hdGVyaWFsID0gYXBwLnBhcmFtcy5tYXRlcmlhbDtcbiAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiBzaXplUG9wb3ZlcigpIHtcbiAgICAgICAgICAgICAgICBtb2RhbC5jc3Moe2xlZnQ6ICcnLCB0b3A6ICcnfSk7XG4gICAgICAgICAgICAgICAgdmFyIG1vZGFsV2lkdGggPSAgbW9kYWwud2lkdGgoKTtcbiAgICAgICAgICAgICAgICB2YXIgbW9kYWxIZWlnaHQgPSAgbW9kYWwuaGVpZ2h0KCk7IC8vIDEzIC0gaGVpZ2h0IG9mIGFuZ2xlXG4gICAgICAgICAgICAgICAgdmFyIG1vZGFsQW5nbGUsIG1vZGFsQW5nbGVTaXplID0gMCwgbW9kYWxBbmdsZUxlZnQsIG1vZGFsQW5nbGVUb3A7XG4gICAgICAgICAgICAgICAgaWYgKCFtYXRlcmlhbCkge1xuICAgICAgICAgICAgICAgICAgICBtb2RhbEFuZ2xlID0gbW9kYWwuZmluZCgnLnBvcG92ZXItYW5nbGUnKTtcbiAgICAgICAgICAgICAgICAgICAgbW9kYWxBbmdsZVNpemUgPSBtb2RhbEFuZ2xlLndpZHRoKCkgLyAyO1xuICAgICAgICAgICAgICAgICAgICBtb2RhbEFuZ2xlLnJlbW92ZUNsYXNzKCdvbi1sZWZ0IG9uLXJpZ2h0IG9uLXRvcCBvbi1ib3R0b20nKS5jc3Moe2xlZnQ6ICcnLCB0b3A6ICcnfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBtb2RhbC5yZW1vdmVDbGFzcygncG9wb3Zlci1vbi1sZWZ0IHBvcG92ZXItb24tcmlnaHQgcG9wb3Zlci1vbi10b3AgcG9wb3Zlci1vbi1ib3R0b20nKS5jc3Moe2xlZnQ6ICcnLCB0b3A6ICcnfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0V2lkdGggPSB0YXJnZXQub3V0ZXJXaWR0aCgpO1xuICAgICAgICAgICAgICAgIHZhciB0YXJnZXRIZWlnaHQgPSB0YXJnZXQub3V0ZXJIZWlnaHQoKTtcbiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0T2Zmc2V0ID0gdGFyZ2V0Lm9mZnNldCgpO1xuICAgICAgICAgICAgICAgIHZhciB0YXJnZXRQYXJlbnRQYWdlID0gdGFyZ2V0LnBhcmVudHMoJy5wYWdlJyk7XG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldFBhcmVudFBhZ2UubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXRPZmZzZXQudG9wID0gdGFyZ2V0T2Zmc2V0LnRvcCAtIHRhcmdldFBhcmVudFBhZ2VbMF0uc2Nyb2xsVG9wO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIHdpbmRvd0hlaWdodCA9ICQod2luZG93KS5oZWlnaHQoKTtcbiAgICAgICAgICAgICAgICB2YXIgd2luZG93V2lkdGggPSAkKHdpbmRvdykud2lkdGgoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIG1vZGFsVG9wID0gMDtcbiAgICAgICAgICAgICAgICB2YXIgbW9kYWxMZWZ0ID0gMDtcbiAgICAgICAgICAgICAgICB2YXIgZGlmZiA9IDA7XG4gICAgICAgICAgICAgICAgLy8gVG9wIFBvc2l0aW9uXG4gICAgICAgICAgICAgICAgdmFyIG1vZGFsUG9zaXRpb24gPSBtYXRlcmlhbCA/ICdib3R0b20nIDogJ3RvcCc7XG4gICAgICAgICAgICAgICAgaWYgKG1hdGVyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtb2RhbEhlaWdodCA8IHdpbmRvd0hlaWdodCAtIHRhcmdldE9mZnNldC50b3AgLSB0YXJnZXRIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9uIGJvdHRvbVxuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxQb3NpdGlvbiA9ICdib3R0b20nO1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxUb3AgPSB0YXJnZXRPZmZzZXQudG9wO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1vZGFsSGVpZ2h0IDwgdGFyZ2V0T2Zmc2V0LnRvcCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gT24gdG9wXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbFRvcCA9IHRhcmdldE9mZnNldC50b3AgLSBtb2RhbEhlaWdodCArIHRhcmdldEhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsUG9zaXRpb24gPSAndG9wJztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9uIG1pZGRsZVxuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxQb3NpdGlvbiA9ICdib3R0b20nO1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxUb3AgPSB0YXJnZXRPZmZzZXQudG9wO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxUb3AgPD0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxUb3AgPSA4O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1vZGFsVG9wICsgbW9kYWxIZWlnaHQgPj0gd2luZG93SGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbFRvcCA9IHdpbmRvd0hlaWdodCAtIG1vZGFsSGVpZ2h0IC0gODtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCBQb3NpdGlvblxuICAgICAgICAgICAgICAgICAgICBtb2RhbExlZnQgPSB0YXJnZXRPZmZzZXQubGVmdDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGFsTGVmdCArIG1vZGFsV2lkdGggPj0gd2luZG93V2lkdGggLSA4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbExlZnQgPSB0YXJnZXRPZmZzZXQubGVmdCArIHRhcmdldFdpZHRoIC0gbW9kYWxXaWR0aCAtIDg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGFsTGVmdCA8IDgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsTGVmdCA9IDg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGFsUG9zaXRpb24gPT09ICd0b3AnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbC5hZGRDbGFzcygncG9wb3Zlci1vbi10b3AnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxQb3NpdGlvbiA9PT0gJ2JvdHRvbScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsLmFkZENsYXNzKCdwb3BvdmVyLW9uLWJvdHRvbScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXQuaGFzQ2xhc3MoJ2Zsb2F0aW5nLWJ1dHRvbi10by1wb3BvdmVyJykgJiYgIW1vZGFsLmhhc0NsYXNzKCdtb2RhbC1pbicpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbC5hZGRDbGFzcygncG9wb3Zlci1mbG9hdGluZy1idXR0b24nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaWZmWCA9IChtb2RhbExlZnQgKyBtb2RhbFdpZHRoIC8gMikgLSAodGFyZ2V0T2Zmc2V0LmxlZnQgKyB0YXJnZXRXaWR0aCAvIDIpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZZID0gKG1vZGFsVG9wICsgbW9kYWxIZWlnaHQgLyAyKSAtICh0YXJnZXRPZmZzZXQudG9wICsgdGFyZ2V0SGVpZ2h0IC8gMik7XG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ2Zsb2F0aW5nLWJ1dHRvbi10by1wb3BvdmVyLWluJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgZGlmZlggKyAncHgsICcgKyBkaWZmWSArICdweCwwKScpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0YXJnZXQuaGFzQ2xhc3MoJ2Zsb2F0aW5nLWJ1dHRvbi10by1wb3BvdmVyLWluJykpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ2Zsb2F0aW5nLWJ1dHRvbi10by1wb3BvdmVyLXNjYWxlJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyBkaWZmWCArICdweCwgJyArIGRpZmZZICsgJ3B4LDApIHNjYWxlKCcgKyAobW9kYWxXaWR0aC90YXJnZXRXaWR0aCkgKyAnLCAnICsgKG1vZGFsSGVpZ2h0L3RhcmdldEhlaWdodCkgKyAnKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsLm9uY2UoJ2Nsb3NlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVtb3ZlQ2xhc3MoJ2Zsb2F0aW5nLWJ1dHRvbi10by1wb3BvdmVyLWluIGZsb2F0aW5nLWJ1dHRvbi10by1wb3BvdmVyLXNjYWxlJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKCdmbG9hdGluZy1idXR0b24tdG8tcG9wb3Zlci1vdXQnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudHJhbnNmb3JtKCcnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnJlbW92ZUNsYXNzKCdmbG9hdGluZy1idXR0b24tdG8tcG9wb3Zlci1vdXQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsLm9uY2UoJ2Nsb3NlZCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RhbC5yZW1vdmVDbGFzcygncG9wb3Zlci1mbG9hdGluZy1idXR0b24nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKChtb2RhbEhlaWdodCArIG1vZGFsQW5nbGVTaXplKSA8IHRhcmdldE9mZnNldC50b3ApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9uIHRvcFxuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxUb3AgPSB0YXJnZXRPZmZzZXQudG9wIC0gbW9kYWxIZWlnaHQgLSBtb2RhbEFuZ2xlU2l6ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICgobW9kYWxIZWlnaHQgKyBtb2RhbEFuZ2xlU2l6ZSkgPCB3aW5kb3dIZWlnaHQgLSB0YXJnZXRPZmZzZXQudG9wIC0gdGFyZ2V0SGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBPbiBib3R0b21cbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsUG9zaXRpb24gPSAnYm90dG9tJztcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsVG9wID0gdGFyZ2V0T2Zmc2V0LnRvcCArIHRhcmdldEhlaWdodCArIG1vZGFsQW5nbGVTaXplO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gT24gbWlkZGxlXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbFBvc2l0aW9uID0gJ21pZGRsZSc7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbFRvcCA9IHRhcmdldEhlaWdodCAvIDIgKyB0YXJnZXRPZmZzZXQudG9wIC0gbW9kYWxIZWlnaHQgLyAyO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGlmZiA9IG1vZGFsVG9wO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGFsVG9wIDw9IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RhbFRvcCA9IDU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtb2RhbFRvcCArIG1vZGFsSGVpZ2h0ID49IHdpbmRvd0hlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsVG9wID0gd2luZG93SGVpZ2h0IC0gbW9kYWxIZWlnaHQgLSA1O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZGlmZiA9IGRpZmYgLSBtb2RhbFRvcDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gSG9yaXpvbnRhbCBQb3NpdGlvblxuICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxQb3NpdGlvbiA9PT0gJ3RvcCcgfHwgbW9kYWxQb3NpdGlvbiA9PT0gJ2JvdHRvbScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsTGVmdCA9IHRhcmdldFdpZHRoIC8gMiArIHRhcmdldE9mZnNldC5sZWZ0IC0gbW9kYWxXaWR0aCAvIDI7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaWZmID0gbW9kYWxMZWZ0O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGFsTGVmdCA8IDUpIG1vZGFsTGVmdCA9IDU7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxMZWZ0ICsgbW9kYWxXaWR0aCA+IHdpbmRvd1dpZHRoKSBtb2RhbExlZnQgPSB3aW5kb3dXaWR0aCAtIG1vZGFsV2lkdGggLSA1O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGFsUG9zaXRpb24gPT09ICd0b3AnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxBbmdsZS5hZGRDbGFzcygnb24tYm90dG9tJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxQb3NpdGlvbiA9PT0gJ2JvdHRvbScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RhbEFuZ2xlLmFkZENsYXNzKCdvbi10b3AnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmYgPSBkaWZmIC0gbW9kYWxMZWZ0O1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxBbmdsZUxlZnQgPSAobW9kYWxXaWR0aCAvIDIgLSBtb2RhbEFuZ2xlU2l6ZSArIGRpZmYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxBbmdsZUxlZnQgPSBNYXRoLm1heChNYXRoLm1pbihtb2RhbEFuZ2xlTGVmdCwgbW9kYWxXaWR0aCAtIG1vZGFsQW5nbGVTaXplICogMiAtIDEzKSwgMTMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxBbmdsZS5jc3Moe2xlZnQ6IG1vZGFsQW5nbGVMZWZ0ICsgJ3B4J30pO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChtb2RhbFBvc2l0aW9uID09PSAnbWlkZGxlJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxMZWZ0ID0gdGFyZ2V0T2Zmc2V0LmxlZnQgLSBtb2RhbFdpZHRoIC0gbW9kYWxBbmdsZVNpemU7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbEFuZ2xlLmFkZENsYXNzKCdvbi1yaWdodCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGFsTGVmdCA8IDUgfHwgKG1vZGFsTGVmdCArIG1vZGFsV2lkdGggPiB3aW5kb3dXaWR0aCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxMZWZ0IDwgNSkgbW9kYWxMZWZ0ID0gdGFyZ2V0T2Zmc2V0LmxlZnQgKyB0YXJnZXRXaWR0aCArIG1vZGFsQW5nbGVTaXplO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2RhbExlZnQgKyBtb2RhbFdpZHRoID4gd2luZG93V2lkdGgpIG1vZGFsTGVmdCA9IHdpbmRvd1dpZHRoIC0gbW9kYWxXaWR0aCAtIDU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxBbmdsZS5yZW1vdmVDbGFzcygnb24tcmlnaHQnKS5hZGRDbGFzcygnb24tbGVmdCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxBbmdsZVRvcCA9IChtb2RhbEhlaWdodCAvIDIgLSBtb2RhbEFuZ2xlU2l6ZSArIGRpZmYpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxBbmdsZVRvcCA9IE1hdGgubWF4KE1hdGgubWluKG1vZGFsQW5nbGVUb3AsIG1vZGFsSGVpZ2h0IC0gbW9kYWxBbmdsZVNpemUgKiAyIC0gMTMpLCAxMyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbEFuZ2xlLmNzcyh7dG9wOiBtb2RhbEFuZ2xlVG9wICsgJ3B4J30pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gQXBwbHkgU3R5bGVzXG4gICAgICAgICAgICAgICAgbW9kYWwuY3NzKHt0b3A6IG1vZGFsVG9wICsgJ3B4JywgbGVmdDogbW9kYWxMZWZ0ICsgJ3B4J30pO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIHNpemVQb3BvdmVyKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgJCh3aW5kb3cpLm9uKCdyZXNpemUnLCBzaXplUG9wb3Zlcik7XG4gICAgICAgIFxuICAgICAgICAgICAgbW9kYWwub24oJ2Nsb3NlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICQod2luZG93KS5vZmYoJ3Jlc2l6ZScsIHNpemVQb3BvdmVyKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgIGFwcC5vcGVuTW9kYWwobW9kYWwpO1xuICAgICAgICAgICAgcmV0dXJuIG1vZGFsWzBdO1xuICAgICAgICB9O1xuICAgICAgICBhcHAucG9wdXAgPSBmdW5jdGlvbiAobW9kYWwsIHJlbW92ZU9uQ2xvc2UpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVtb3ZlT25DbG9zZSA9PT0gJ3VuZGVmaW5lZCcpIHJlbW92ZU9uQ2xvc2UgPSB0cnVlO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBtb2RhbCA9PT0gJ3N0cmluZycgJiYgbW9kYWwuaW5kZXhPZignPCcpID49IDApIHtcbiAgICAgICAgICAgICAgICB2YXIgX21vZGFsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgICAgICAgICAgX21vZGFsLmlubmVySFRNTCA9IG1vZGFsLnRyaW0oKTtcbiAgICAgICAgICAgICAgICBpZiAoX21vZGFsLmNoaWxkTm9kZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBtb2RhbCA9IF9tb2RhbC5jaGlsZE5vZGVzWzBdO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVtb3ZlT25DbG9zZSkgbW9kYWwuY2xhc3NMaXN0LmFkZCgncmVtb3ZlLW9uLWNsb3NlJyk7XG4gICAgICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hcHBlbmQobW9kYWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBmYWxzZTsgLy9ub3RoaW5nIGZvdW5kXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtb2RhbCA9ICQobW9kYWwpO1xuICAgICAgICAgICAgaWYgKG1vZGFsLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgaWYgKG1vZGFsLnBhcmVudHMoJ2JvZHknKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBpZiAocmVtb3ZlT25DbG9zZSkgbW9kYWwuYWRkQ2xhc3MoJ3JlbW92ZS1vbi1jbG9zZScpO1xuICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hcHBlbmQobW9kYWxbMF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbW9kYWwuc2hvdygpO1xuICAgICAgICBcbiAgICAgICAgICAgIGFwcC5vcGVuTW9kYWwobW9kYWwpO1xuICAgICAgICAgICAgcmV0dXJuIG1vZGFsWzBdO1xuICAgICAgICB9O1xuICAgICAgICBhcHAucGlja2VyTW9kYWwgPSBmdW5jdGlvbiAobW9kYWwsIHJlbW92ZU9uQ2xvc2UpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVtb3ZlT25DbG9zZSA9PT0gJ3VuZGVmaW5lZCcpIHJlbW92ZU9uQ2xvc2UgPSB0cnVlO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBtb2RhbCA9PT0gJ3N0cmluZycgJiYgbW9kYWwuaW5kZXhPZignPCcpID49IDApIHtcbiAgICAgICAgICAgICAgICBtb2RhbCA9ICQobW9kYWwpO1xuICAgICAgICAgICAgICAgIGlmIChtb2RhbC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZW1vdmVPbkNsb3NlKSBtb2RhbC5hZGRDbGFzcygncmVtb3ZlLW9uLWNsb3NlJyk7XG4gICAgICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hcHBlbmQobW9kYWxbMF0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBmYWxzZTsgLy9ub3RoaW5nIGZvdW5kXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtb2RhbCA9ICQobW9kYWwpO1xuICAgICAgICAgICAgaWYgKG1vZGFsLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgaWYgKG1vZGFsLnBhcmVudHMoJ2JvZHknKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBpZiAocmVtb3ZlT25DbG9zZSkgbW9kYWwuYWRkQ2xhc3MoJ3JlbW92ZS1vbi1jbG9zZScpO1xuICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hcHBlbmQobW9kYWxbMF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCQoJy5waWNrZXItbW9kYWwubW9kYWwtaW46bm90KC5tb2RhbC1vdXQpJykubGVuZ3RoID4gMCAmJiAhbW9kYWwuaGFzQ2xhc3MoJ21vZGFsLWluJykpIHtcbiAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbCgnLnBpY2tlci1tb2RhbC5tb2RhbC1pbjpub3QoLm1vZGFsLW91dCknKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1vZGFsLnNob3coKTtcbiAgICAgICAgICAgIGFwcC5vcGVuTW9kYWwobW9kYWwpO1xuICAgICAgICAgICAgcmV0dXJuIG1vZGFsWzBdO1xuICAgICAgICB9O1xuICAgICAgICBhcHAubG9naW5TY3JlZW4gPSBmdW5jdGlvbiAobW9kYWwpIHtcbiAgICAgICAgICAgIGlmICghbW9kYWwpIG1vZGFsID0gJy5sb2dpbi1zY3JlZW4nO1xuICAgICAgICAgICAgbW9kYWwgPSAkKG1vZGFsKTtcbiAgICAgICAgICAgIGlmIChtb2RhbC5sZW5ndGggPT09IDApIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIGlmICgkKCcubG9naW4tc2NyZWVuLm1vZGFsLWluOm5vdCgubW9kYWwtb3V0KScpLmxlbmd0aCA+IDAgJiYgIW1vZGFsLmhhc0NsYXNzKCdtb2RhbC1pbicpKSB7XG4gICAgICAgICAgICAgICAgYXBwLmNsb3NlTW9kYWwoJy5sb2dpbi1zY3JlZW4ubW9kYWwtaW46bm90KC5tb2RhbC1vdXQpJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtb2RhbC5zaG93KCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGFwcC5vcGVuTW9kYWwobW9kYWwpO1xuICAgICAgICAgICAgcmV0dXJuIG1vZGFsWzBdO1xuICAgICAgICB9O1xuICAgICAgICBhcHAub3Blbk1vZGFsID0gZnVuY3Rpb24gKG1vZGFsKSB7XG4gICAgICAgICAgICBtb2RhbCA9ICQobW9kYWwpO1xuICAgICAgICAgICAgdmFyIGlzTW9kYWwgPSBtb2RhbC5oYXNDbGFzcygnbW9kYWwnKTtcbiAgICAgICAgICAgIGlmICgkKCcubW9kYWwubW9kYWwtaW46bm90KC5tb2RhbC1vdXQpJykubGVuZ3RoICYmIGFwcC5wYXJhbXMubW9kYWxTdGFjayAmJiBpc01vZGFsKSB7XG4gICAgICAgICAgICAgICAgYXBwLm1vZGFsU3RhY2sucHVzaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5vcGVuTW9kYWwobW9kYWwpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIGRvIG5vdGhpbmcgaWYgdGhpcyBtb2RhbCBhbHJlYWR5IHNob3duXG4gICAgICAgICAgICBpZiAodHJ1ZSA9PT0gbW9kYWwuZGF0YSgnZjctbW9kYWwtc2hvd24nKSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1vZGFsLmRhdGEoJ2Y3LW1vZGFsLXNob3duJywgdHJ1ZSk7XG4gICAgICAgICAgICBtb2RhbC5vbmNlKCdjbG9zZScsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgbW9kYWwucmVtb3ZlRGF0YSgnZjctbW9kYWwtc2hvd24nKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdmFyIGlzUG9wb3ZlciA9IG1vZGFsLmhhc0NsYXNzKCdwb3BvdmVyJyk7XG4gICAgICAgICAgICB2YXIgaXNQb3B1cCA9IG1vZGFsLmhhc0NsYXNzKCdwb3B1cCcpO1xuICAgICAgICAgICAgdmFyIGlzTG9naW5TY3JlZW4gPSBtb2RhbC5oYXNDbGFzcygnbG9naW4tc2NyZWVuJyk7XG4gICAgICAgICAgICB2YXIgaXNQaWNrZXJNb2RhbCA9IG1vZGFsLmhhc0NsYXNzKCdwaWNrZXItbW9kYWwnKTtcbiAgICAgICAgICAgIGlmIChpc01vZGFsKSB7XG4gICAgICAgICAgICAgICAgbW9kYWwuc2hvdygpO1xuICAgICAgICAgICAgICAgIG1vZGFsLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgIG1hcmdpblRvcDogLSBNYXRoLnJvdW5kKG1vZGFsLm91dGVySGVpZ2h0KCkgLyAyKSArICdweCdcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgb3ZlcmxheTtcbiAgICAgICAgICAgIGlmICghaXNMb2dpblNjcmVlbiAmJiAhaXNQaWNrZXJNb2RhbCkge1xuICAgICAgICAgICAgICAgIGlmICgkKCcubW9kYWwtb3ZlcmxheScpLmxlbmd0aCA9PT0gMCAmJiAhaXNQb3B1cCkge1xuICAgICAgICAgICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKCc8ZGl2IGNsYXNzPVwibW9kYWwtb3ZlcmxheVwiPjwvZGl2PicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoJCgnLnBvcHVwLW92ZXJsYXknKS5sZW5ndGggPT09IDAgJiYgaXNQb3B1cCkge1xuICAgICAgICAgICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKCc8ZGl2IGNsYXNzPVwicG9wdXAtb3ZlcmxheVwiPjwvZGl2PicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBvdmVybGF5ID0gaXNQb3B1cCA/ICQoJy5wb3B1cC1vdmVybGF5JykgOiAkKCcubW9kYWwtb3ZlcmxheScpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwgJiYgaXNQaWNrZXJNb2RhbCkge1xuICAgICAgICAgICAgICAgIGlmIChtb2RhbC5oYXNDbGFzcygncGlja2VyLWNhbGVuZGFyJykpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQoJy5waWNrZXItbW9kYWwtb3ZlcmxheScpLmxlbmd0aCA9PT0gMCAmJiAhaXNQb3B1cCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJCgnYm9keScpLmFwcGVuZCgnPGRpdiBjbGFzcz1cInBpY2tlci1tb2RhbC1vdmVybGF5XCI+PC9kaXY+Jyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgb3ZlcmxheSA9ICQoJy5waWNrZXItbW9kYWwtb3ZlcmxheScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvL01ha2Ugc3VyZSB0aGF0IHN0eWxlcyBhcmUgYXBwbGllZCwgdHJpZ2dlciByZWxheW91dDtcbiAgICAgICAgICAgIHZhciBjbGllbnRMZWZ0ID0gbW9kYWxbMF0uY2xpZW50TGVmdDtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBUcnVnZ2VyIG9wZW4gZXZlbnRcbiAgICAgICAgICAgIG1vZGFsLnRyaWdnZXIoJ29wZW4nKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQaWNrZXIgbW9kYWwgYm9keSBjbGFzc1xuICAgICAgICAgICAgaWYgKGlzUGlja2VyTW9kYWwpIHtcbiAgICAgICAgICAgICAgICAkKCdib2R5JykuYWRkQ2xhc3MoJ3dpdGgtcGlja2VyLW1vZGFsJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBQYWdlcyBhbmQgTmF2YmFycyBpbiBtb2RhbFxuICAgICAgICAgICAgaWYgKG1vZGFsLmZpbmQoJy4nICsgYXBwLnBhcmFtcy52aWV3Q2xhc3MpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBtb2RhbC5maW5kKCcucGFnZScpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBhcHAuaW5pdFBhZ2VXaXRoQ2FsbGJhY2sodGhpcyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgbW9kYWwuZmluZCgnLm5hdmJhcicpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBhcHAuaW5pdE5hdmJhcldpdGhDYWxsYmFjayh0aGlzKTsgXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ2xhc3NlcyBmb3IgdHJhbnNpdGlvbiBpblxuICAgICAgICAgICAgaWYgKCFpc0xvZ2luU2NyZWVuICYmICFpc1BpY2tlck1vZGFsKSBvdmVybGF5LmFkZENsYXNzKCdtb2RhbC1vdmVybGF5LXZpc2libGUnKTtcbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsICYmIGlzUGlja2VyTW9kYWwgJiYgb3ZlcmxheSkgb3ZlcmxheS5hZGRDbGFzcygnbW9kYWwtb3ZlcmxheS12aXNpYmxlJyk7XG4gICAgICAgICAgICBtb2RhbC5yZW1vdmVDbGFzcygnbW9kYWwtb3V0JykuYWRkQ2xhc3MoJ21vZGFsLWluJykudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGlmIChtb2RhbC5oYXNDbGFzcygnbW9kYWwtb3V0JykpIG1vZGFsLnRyaWdnZXIoJ2Nsb3NlZCcpO1xuICAgICAgICAgICAgICAgIGVsc2UgbW9kYWwudHJpZ2dlcignb3BlbmVkJyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuY2xvc2VNb2RhbCA9IGZ1bmN0aW9uIChtb2RhbCkge1xuICAgICAgICAgICAgbW9kYWwgPSAkKG1vZGFsIHx8ICcubW9kYWwtaW4nKTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgbW9kYWwgIT09ICd1bmRlZmluZWQnICYmIG1vZGFsLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBpc01vZGFsID0gbW9kYWwuaGFzQ2xhc3MoJ21vZGFsJyk7XG4gICAgICAgICAgICB2YXIgaXNQb3BvdmVyID0gbW9kYWwuaGFzQ2xhc3MoJ3BvcG92ZXInKTtcbiAgICAgICAgICAgIHZhciBpc1BvcHVwID0gbW9kYWwuaGFzQ2xhc3MoJ3BvcHVwJyk7XG4gICAgICAgICAgICB2YXIgaXNMb2dpblNjcmVlbiA9IG1vZGFsLmhhc0NsYXNzKCdsb2dpbi1zY3JlZW4nKTtcbiAgICAgICAgICAgIHZhciBpc1BpY2tlck1vZGFsID0gbW9kYWwuaGFzQ2xhc3MoJ3BpY2tlci1tb2RhbCcpO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciByZW1vdmVPbkNsb3NlID0gbW9kYWwuaGFzQ2xhc3MoJ3JlbW92ZS1vbi1jbG9zZScpO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBvdmVybGF5O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoaXNQb3B1cCkgb3ZlcmxheSA9ICQoJy5wb3B1cC1vdmVybGF5Jyk7XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoaXNQaWNrZXJNb2RhbCAmJiBhcHAucGFyYW1zLm1hdGVyaWFsKSBvdmVybGF5ID0gJCgnLnBpY2tlci1tb2RhbC1vdmVybGF5Jyk7XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoIWlzUGlja2VyTW9kYWwpIG92ZXJsYXkgPSAkKCcubW9kYWwtb3ZlcmxheScpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmIChpc1BvcHVwKXtcbiAgICAgICAgICAgICAgICBpZiAobW9kYWwubGVuZ3RoID09PSAkKCcucG9wdXAubW9kYWwtaW4nKS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgb3ZlcmxheS5yZW1vdmVDbGFzcygnbW9kYWwtb3ZlcmxheS12aXNpYmxlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAob3ZlcmxheSAmJiBvdmVybGF5Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBvdmVybGF5LnJlbW92ZUNsYXNzKCdtb2RhbC1vdmVybGF5LXZpc2libGUnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBtb2RhbC50cmlnZ2VyKCdjbG9zZScpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBpY2tlciBtb2RhbCBib2R5IGNsYXNzXG4gICAgICAgICAgICBpZiAoaXNQaWNrZXJNb2RhbCkge1xuICAgICAgICAgICAgICAgICQoJ2JvZHknKS5yZW1vdmVDbGFzcygnd2l0aC1waWNrZXItbW9kYWwnKTtcbiAgICAgICAgICAgICAgICAkKCdib2R5JykuYWRkQ2xhc3MoJ3BpY2tlci1tb2RhbC1jbG9zaW5nJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKCEoaXNQb3BvdmVyICYmICFhcHAucGFyYW1zLm1hdGVyaWFsKSkge1xuICAgICAgICAgICAgICAgIG1vZGFsLnJlbW92ZUNsYXNzKCdtb2RhbC1pbicpLmFkZENsYXNzKCdtb2RhbC1vdXQnKS50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtb2RhbC5oYXNDbGFzcygnbW9kYWwtb3V0JykpIG1vZGFsLnRyaWdnZXIoJ2Nsb3NlZCcpO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsLnRyaWdnZXIoJ29wZW5lZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzUG9wb3ZlcikgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNQaWNrZXJNb2RhbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJCgnYm9keScpLnJlbW92ZUNsYXNzKCdwaWNrZXItbW9kYWwtY2xvc2luZycpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChpc1BvcHVwIHx8IGlzTG9naW5TY3JlZW4gfHwgaXNQaWNrZXJNb2RhbCB8fCBpc1BvcG92ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsLnJlbW92ZUNsYXNzKCdtb2RhbC1vdXQnKS5oaWRlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVtb3ZlT25DbG9zZSAmJiBtb2RhbC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWwucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbC5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGlmIChpc01vZGFsICYmIGFwcC5wYXJhbXMubW9kYWxTdGFjaykge1xuICAgICAgICAgICAgICAgICAgICBhcHAubW9kYWxTdGFja0NsZWFyUXVldWUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBtb2RhbC5yZW1vdmVDbGFzcygnbW9kYWwtaW4gbW9kYWwtb3V0JykudHJpZ2dlcignY2xvc2VkJykuaGlkZSgpO1xuICAgICAgICAgICAgICAgIGlmIChyZW1vdmVPbkNsb3NlKSB7XG4gICAgICAgICAgICAgICAgICAgIG1vZGFsLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9O1xuICAgICAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgUHJvZ3Jlc3MgQmFyICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAuc2V0UHJvZ3Jlc3NiYXIgPSBmdW5jdGlvbiAoY29udGFpbmVyLCBwcm9ncmVzcywgc3BlZWQpIHtcbiAgICAgICAgICAgIGNvbnRhaW5lciA9ICQoY29udGFpbmVyIHx8ICdib2R5Jyk7XG4gICAgICAgICAgICBpZiAoY29udGFpbmVyLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKHByb2dyZXNzKSBwcm9ncmVzcyA9IE1hdGgubWluKE1hdGgubWF4KHByb2dyZXNzLCAwKSwgMTAwKTtcbiAgICAgICAgICAgIHZhciBwcm9ncmVzc2JhcjtcbiAgICAgICAgICAgIGlmIChjb250YWluZXIuaGFzQ2xhc3MoJ3Byb2dyZXNzYmFyJykpIHByb2dyZXNzYmFyID0gY29udGFpbmVyO1xuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcHJvZ3Jlc3NiYXIgPSBjb250YWluZXIuY2hpbGRyZW4oJy5wcm9ncmVzc2JhcicpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHByb2dyZXNzYmFyLmxlbmd0aCA9PT0gMCB8fCBwcm9ncmVzc2Jhci5oYXNDbGFzcygncHJvZ3Jlc3NiYXItaW5maW5pdGUnKSkgcmV0dXJuO1xuICAgICAgICAgICAgdmFyIGNsaWVudExlZnQgPSBwcm9ncmVzc2JhclswXS5jbGllbnRMZWZ0O1xuICAgICAgICAgICAgcHJvZ3Jlc3NiYXIuY2hpbGRyZW4oJ3NwYW4nKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAoLTEwMCArIHByb2dyZXNzKSArICclLDAsMCknKTtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgcHJvZ3Jlc3NiYXIuY2hpbGRyZW4oJ3NwYW4nKS50cmFuc2l0aW9uKHNwZWVkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHByb2dyZXNzYmFyLmNoaWxkcmVuKCdzcGFuJykudHJhbnNpdGlvbignJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcHJvZ3Jlc3NiYXJbMF07XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5zaG93UHJvZ3Jlc3NiYXIgPSBmdW5jdGlvbiAoY29udGFpbmVyLCBwcm9ncmVzcywgY29sb3IpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGFpbmVyID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lciA9ICdib2R5JztcbiAgICAgICAgICAgICAgICBwcm9ncmVzcyA9IGFyZ3VtZW50c1swXTtcbiAgICAgICAgICAgICAgICBjb2xvciA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwcm9ncmVzcyAmJiB0eXBlb2YgcHJvZ3Jlc3MgPT09ICdzdHJpbmcnICYmIHBhcnNlRmxvYXQocHJvZ3Jlc3MpICE9PSBwcm9ncmVzcyAqIDEpIHtcbiAgICAgICAgICAgICAgICBjb2xvciA9IHByb2dyZXNzO1xuICAgICAgICAgICAgICAgIHByb2dyZXNzID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29udGFpbmVyID0gJChjb250YWluZXIgfHwgJ2JvZHknKTtcbiAgICAgICAgICAgIGlmIChjb250YWluZXIubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICB2YXIgcHJvZ3Jlc3NiYXI7XG4gICAgICAgICAgICBpZiAoY29udGFpbmVyLmhhc0NsYXNzKCdwcm9ncmVzc2JhcicpKSBwcm9ncmVzc2JhciA9IGNvbnRhaW5lcjtcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHByb2dyZXNzYmFyID0gY29udGFpbmVyLmNoaWxkcmVuKCcucHJvZ3Jlc3NiYXI6bm90KC5wcm9ncmVzc2Jhci1vdXQpLCAucHJvZ3Jlc3NiYXItaW5maW5pdGU6bm90KC5wcm9ncmVzc2Jhci1vdXQpJyk7XG4gICAgICAgICAgICAgICAgaWYgKHByb2dyZXNzYmFyLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBDcmVhdGUgb25lXG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvZ3Jlc3MgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmVkXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzc2JhciA9ICQoJzxzcGFuIGNsYXNzPVwicHJvZ3Jlc3NiYXIgcHJvZ3Jlc3NiYXItaW4nICsgKGNvbG9yID8gJyBjb2xvci0nICsgY29sb3IgOiAnJykgKyAnXCI+PHNwYW4+PC9zcGFuPjwvc3Bhbj4nKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluZmluaXRlXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzc2JhciA9ICQoJzxzcGFuIGNsYXNzPVwicHJvZ3Jlc3NiYXItaW5maW5pdGUgcHJvZ3Jlc3NiYXItaW4nICsgKGNvbG9yID8gJyBjb2xvci0nICsgY29sb3IgOiAnJykgKyAnXCI+PC9zcGFuPicpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5hcHBlbmQocHJvZ3Jlc3NiYXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwcm9ncmVzcykgYXBwLnNldFByb2dyZXNzYmFyKGNvbnRhaW5lciwgcHJvZ3Jlc3MpO1xuICAgICAgICAgICAgcmV0dXJuIHByb2dyZXNzYmFyWzBdO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuaGlkZVByb2dyZXNzYmFyID0gZnVuY3Rpb24gKGNvbnRhaW5lcikge1xuICAgICAgICAgICAgY29udGFpbmVyID0gJChjb250YWluZXIgfHwgJ2JvZHknKTtcbiAgICAgICAgICAgIGlmIChjb250YWluZXIubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICB2YXIgcHJvZ3Jlc3NiYXI7XG4gICAgICAgICAgICBpZiAoY29udGFpbmVyLmhhc0NsYXNzKCdwcm9ncmVzc2JhcicpKSBwcm9ncmVzc2JhciA9IGNvbnRhaW5lcjtcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHByb2dyZXNzYmFyID0gY29udGFpbmVyLmNoaWxkcmVuKCcucHJvZ3Jlc3NiYXIsIC5wcm9ncmVzc2Jhci1pbmZpbml0ZScpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHByb2dyZXNzYmFyLmxlbmd0aCA9PT0gMCB8fCAhcHJvZ3Jlc3NiYXIuaGFzQ2xhc3MoJ3Byb2dyZXNzYmFyLWluJykgfHwgcHJvZ3Jlc3NiYXIuaGFzQ2xhc3MoJ3Byb2dyZXNzYmFyLW91dCcpKSByZXR1cm47XG4gICAgICAgICAgICBwcm9ncmVzc2Jhci5yZW1vdmVDbGFzcygncHJvZ3Jlc3NiYXItaW4nKS5hZGRDbGFzcygncHJvZ3Jlc3NiYXItb3V0JykuYW5pbWF0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBwcm9ncmVzc2Jhci5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICBwcm9ncmVzc2JhciA9IG51bGw7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmluaXRQYWdlUHJvZ3Jlc3NiYXIgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyLmZpbmQoJy5wcm9ncmVzc2JhcicpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBwID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICBpZiAocC5jaGlsZHJlbignc3BhbicpLmxlbmd0aCA9PT0gMCkgcC5hcHBlbmQoJzxzcGFuPjwvc3Bhbj4nKTtcbiAgICAgICAgICAgICAgICBpZiAocC5hdHRyKCdkYXRhLXByb2dyZXNzJykpIGFwcC5zZXRQcm9ncmVzc2JhcihwLCBwLmF0dHIoJ2RhdGEtcHJvZ3Jlc3MnKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBQYW5lbHMgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLmFsbG93UGFuZWxPcGVuID0gdHJ1ZTtcbiAgICAgICAgYXBwLm9wZW5QYW5lbCA9IGZ1bmN0aW9uIChwYW5lbFBvc2l0aW9uKSB7XG4gICAgICAgICAgICBpZiAoIWFwcC5hbGxvd1BhbmVsT3BlbikgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgdmFyIHBhbmVsID0gJCgnLnBhbmVsLScgKyBwYW5lbFBvc2l0aW9uKTtcbiAgICAgICAgICAgIGlmIChwYW5lbC5sZW5ndGggPT09IDAgfHwgcGFuZWwuaGFzQ2xhc3MoJ2FjdGl2ZScpKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICBhcHAuY2xvc2VQYW5lbCgpOyAvLyBDbG9zZSBpZiBzb21lIHBhbmVsIGlzIG9wZW5lZFxuICAgICAgICAgICAgYXBwLmFsbG93UGFuZWxPcGVuID0gZmFsc2U7XG4gICAgICAgICAgICB2YXIgZWZmZWN0ID0gcGFuZWwuaGFzQ2xhc3MoJ3BhbmVsLXJldmVhbCcpID8gJ3JldmVhbCcgOiAnY292ZXInO1xuICAgICAgICAgICAgcGFuZWwuY3NzKHtkaXNwbGF5OiAnYmxvY2snfSkuYWRkQ2xhc3MoJ2FjdGl2ZScpO1xuICAgICAgICAgICAgcGFuZWwudHJpZ2dlcignb3BlbicpO1xuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAkKCcucGFuZWwtb3ZlcmxheScpLnNob3coKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwYW5lbC5maW5kKCcuJyArIGFwcC5wYXJhbXMudmlld0NsYXNzKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5zaXplTmF2YmFycykgYXBwLnNpemVOYXZiYXJzKHBhbmVsLmZpbmQoJy4nICsgYXBwLnBhcmFtcy52aWV3Q2xhc3MpWzBdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBUcmlnZ2VyIHJlTGF5b3V0XG4gICAgICAgICAgICB2YXIgY2xpZW50TGVmdCA9IHBhbmVsWzBdLmNsaWVudExlZnQ7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIFRyYW5zaXRpb24gRW5kO1xuICAgICAgICAgICAgdmFyIHRyYW5zaXRpb25FbmRUYXJnZXQgPSBlZmZlY3QgPT09ICdyZXZlYWwnID8gJCgnLicgKyBhcHAucGFyYW1zLnZpZXdzQ2xhc3MpIDogcGFuZWw7XG4gICAgICAgICAgICB2YXIgb3BlbmVkVHJpZ2dlcmVkID0gZmFsc2U7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIHBhbmVsVHJhbnNpdGlvbkVuZCgpIHtcbiAgICAgICAgICAgICAgICB0cmFuc2l0aW9uRW5kVGFyZ2V0LnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQoZS50YXJnZXQpLmlzKHRyYW5zaXRpb25FbmRUYXJnZXQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFuZWwuaGFzQ2xhc3MoJ2FjdGl2ZScpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFuZWwudHJpZ2dlcignb3BlbmVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYW5lbC50cmlnZ2VyKCdjbG9zZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsKSAkKCcucGFuZWwtb3ZlcmxheScpLmNzcyh7ZGlzcGxheTogJyd9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5hbGxvd1BhbmVsT3BlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBwYW5lbFRyYW5zaXRpb25FbmQoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBhbmVsVHJhbnNpdGlvbkVuZCgpO1xuICAgICAgICBcbiAgICAgICAgICAgICQoJ2JvZHknKS5hZGRDbGFzcygnd2l0aC1wYW5lbC0nICsgcGFuZWxQb3NpdGlvbiArICctJyArIGVmZmVjdCk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmNsb3NlUGFuZWwgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgYWN0aXZlUGFuZWwgPSAkKCcucGFuZWwuYWN0aXZlJyk7XG4gICAgICAgICAgICBpZiAoYWN0aXZlUGFuZWwubGVuZ3RoID09PSAwKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB2YXIgZWZmZWN0ID0gYWN0aXZlUGFuZWwuaGFzQ2xhc3MoJ3BhbmVsLXJldmVhbCcpID8gJ3JldmVhbCcgOiAnY292ZXInO1xuICAgICAgICAgICAgdmFyIHBhbmVsUG9zaXRpb24gPSBhY3RpdmVQYW5lbC5oYXNDbGFzcygncGFuZWwtbGVmdCcpID8gJ2xlZnQnIDogJ3JpZ2h0JztcbiAgICAgICAgICAgIGFjdGl2ZVBhbmVsLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTtcbiAgICAgICAgICAgIHZhciB0cmFuc2l0aW9uRW5kVGFyZ2V0ID0gZWZmZWN0ID09PSAncmV2ZWFsJyA/ICQoJy4nICsgYXBwLnBhcmFtcy52aWV3c0NsYXNzKSA6IGFjdGl2ZVBhbmVsO1xuICAgICAgICAgICAgYWN0aXZlUGFuZWwudHJpZ2dlcignY2xvc2UnKTtcbiAgICAgICAgICAgIGFwcC5hbGxvd1BhbmVsT3BlbiA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgICAgIHRyYW5zaXRpb25FbmRUYXJnZXQudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKGFjdGl2ZVBhbmVsLmhhc0NsYXNzKCdhY3RpdmUnKSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGFjdGl2ZVBhbmVsLmNzcyh7ZGlzcGxheTogJyd9KTtcbiAgICAgICAgICAgICAgICBhY3RpdmVQYW5lbC50cmlnZ2VyKCdjbG9zZWQnKTtcbiAgICAgICAgICAgICAgICAkKCdib2R5JykucmVtb3ZlQ2xhc3MoJ3BhbmVsLWNsb3NpbmcnKTtcbiAgICAgICAgICAgICAgICBhcHAuYWxsb3dQYW5lbE9wZW4gPSB0cnVlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgJCgnYm9keScpLmFkZENsYXNzKCdwYW5lbC1jbG9zaW5nJykucmVtb3ZlQ2xhc3MoJ3dpdGgtcGFuZWwtJyArIHBhbmVsUG9zaXRpb24gKyAnLScgKyBlZmZlY3QpO1xuICAgICAgICB9O1xuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBTd2lwZSBwYW5lbHMgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLmluaXRTd2lwZVBhbmVscyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBwYW5lbCwgc2lkZTtcbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnN3aXBlUGFuZWwpIHtcbiAgICAgICAgICAgICAgICBwYW5lbCA9ICQoJy5wYW5lbC5wYW5lbC0nICsgYXBwLnBhcmFtcy5zd2lwZVBhbmVsKTtcbiAgICAgICAgICAgICAgICBzaWRlID0gYXBwLnBhcmFtcy5zd2lwZVBhbmVsO1xuICAgICAgICAgICAgICAgIGlmIChwYW5lbC5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnN3aXBlUGFuZWxPbmx5Q2xvc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQoJy5wYW5lbCcpLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdmFyIHBhbmVsT3ZlcmxheSA9ICQoJy5wYW5lbC1vdmVybGF5Jyk7XG4gICAgICAgICAgICB2YXIgaXNUb3VjaGVkLCBpc01vdmVkLCBpc1Njcm9sbGluZywgdG91Y2hlc1N0YXJ0ID0ge30sIHRvdWNoU3RhcnRUaW1lLCB0b3VjaGVzRGlmZiwgdHJhbnNsYXRlLCBvdmVybGF5T3BhY2l0eSwgb3BlbmVkLCBwYW5lbFdpZHRoLCBlZmZlY3QsIGRpcmVjdGlvbjtcbiAgICAgICAgICAgIHZhciB2aWV3cyA9ICQoJy4nICsgYXBwLnBhcmFtcy52aWV3c0NsYXNzKTtcbiAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWFwcC5hbGxvd1BhbmVsT3BlbiB8fCAoIWFwcC5wYXJhbXMuc3dpcGVQYW5lbCAmJiAhYXBwLnBhcmFtcy5zd2lwZVBhbmVsT25seUNsb3NlKSB8fCBpc1RvdWNoZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAoJCgnLm1vZGFsLWluLCAucGhvdG8tYnJvd3Nlci1pbicpLmxlbmd0aCA+IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAoIShhcHAucGFyYW1zLnN3aXBlUGFuZWxDbG9zZU9wcG9zaXRlIHx8IGFwcC5wYXJhbXMuc3dpcGVQYW5lbE9ubHlDbG9zZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQoJy5wYW5lbC5hY3RpdmUnKS5sZW5ndGggPiAwICYmICFwYW5lbC5oYXNDbGFzcygnYWN0aXZlJykpIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdG91Y2hlc1N0YXJ0LnggPSBlLnR5cGUgPT09ICd0b3VjaHN0YXJ0JyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGUucGFnZVg7XG4gICAgICAgICAgICAgICAgdG91Y2hlc1N0YXJ0LnkgPSBlLnR5cGUgPT09ICd0b3VjaHN0YXJ0JyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuc3dpcGVQYW5lbENsb3NlT3Bwb3NpdGUgfHwgYXBwLnBhcmFtcy5zd2lwZVBhbmVsT25seUNsb3NlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgkKCcucGFuZWwuYWN0aXZlJykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2lkZSA9ICQoJy5wYW5lbC5hY3RpdmUnKS5oYXNDbGFzcygncGFuZWwtbGVmdCcpID8gJ2xlZnQnIDogJ3JpZ2h0JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnN3aXBlUGFuZWxPbmx5Q2xvc2UpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpZGUgPSBhcHAucGFyYW1zLnN3aXBlUGFuZWw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFzaWRlKSByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHBhbmVsID0gJCgnLnBhbmVsLnBhbmVsLScgKyBzaWRlKTtcbiAgICAgICAgICAgICAgICBvcGVuZWQgPSBwYW5lbC5oYXNDbGFzcygnYWN0aXZlJyk7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuc3dpcGVQYW5lbEFjdGl2ZUFyZWEgJiYgIW9wZW5lZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2lkZSA9PT0gJ2xlZnQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodG91Y2hlc1N0YXJ0LnggPiBhcHAucGFyYW1zLnN3aXBlUGFuZWxBY3RpdmVBcmVhKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHNpZGUgPT09ICdyaWdodCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b3VjaGVzU3RhcnQueCA8IHdpbmRvdy5pbm5lcldpZHRoIC0gYXBwLnBhcmFtcy5zd2lwZVBhbmVsQWN0aXZlQXJlYSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlzU2Nyb2xsaW5nID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRUaW1lID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICBkaXJlY3Rpb24gPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoZSkge1xuICAgICAgICAgICAgICAgIGlmICghaXNUb3VjaGVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKGUuZjdQcmV2ZW50UGFuZWxTd2lwZSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHZhciBwYWdlWCA9IGUudHlwZSA9PT0gJ3RvdWNobW92ZScgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBlLnBhZ2VYO1xuICAgICAgICAgICAgICAgIHZhciBwYWdlWSA9IGUudHlwZSA9PT0gJ3RvdWNobW92ZScgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgOiBlLnBhZ2VZO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaXNTY3JvbGxpbmcgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzU2Nyb2xsaW5nID0gISEoaXNTY3JvbGxpbmcgfHwgTWF0aC5hYnMocGFnZVkgLSB0b3VjaGVzU3RhcnQueSkgPiBNYXRoLmFicyhwYWdlWCAtIHRvdWNoZXNTdGFydC54KSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChpc1Njcm9sbGluZykge1xuICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWRpcmVjdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFnZVggPiB0b3VjaGVzU3RhcnQueCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aW9uID0gJ3RvLXJpZ2h0JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGlvbiA9ICd0by1sZWZ0JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICAgICAgc2lkZSA9PT0gJ2xlZnQnICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aW9uID09PSAndG8tbGVmdCcgJiYgIXBhbmVsLmhhc0NsYXNzKCdhY3RpdmUnKVxuICAgICAgICAgICAgICAgICAgICAgICAgKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgc2lkZSA9PT0gJ3JpZ2h0JyAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpcmVjdGlvbiA9PT0gJ3RvLXJpZ2h0JyAmJiAhcGFuZWwuaGFzQ2xhc3MoJ2FjdGl2ZScpXG4gICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnN3aXBlUGFuZWxOb0ZvbGxvdykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdGltZURpZmYgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpIC0gdG91Y2hTdGFydFRpbWU7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aW1lRGlmZiA8IDMwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGlvbiA9PT0gJ3RvLWxlZnQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNpZGUgPT09ICdyaWdodCcpIGFwcC5vcGVuUGFuZWwoc2lkZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNpZGUgPT09ICdsZWZ0JyAmJiBwYW5lbC5oYXNDbGFzcygnYWN0aXZlJykpIGFwcC5jbG9zZVBhbmVsKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAndG8tcmlnaHQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNpZGUgPT09ICdsZWZ0JykgYXBwLm9wZW5QYW5lbChzaWRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2lkZSA9PT0gJ3JpZ2h0JyAmJiBwYW5lbC5oYXNDbGFzcygnYWN0aXZlJykpIGFwcC5jbG9zZVBhbmVsKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGVmZmVjdCA9IHBhbmVsLmhhc0NsYXNzKCdwYW5lbC1jb3ZlcicpID8gJ2NvdmVyJyA6ICdyZXZlYWwnO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIW9wZW5lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFuZWwuc2hvdygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFuZWxPdmVybGF5LnNob3coKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBwYW5lbFdpZHRoID0gcGFuZWxbMF0ub2Zmc2V0V2lkdGg7XG4gICAgICAgICAgICAgICAgICAgIHBhbmVsLnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYW5lbC5maW5kKCcuJyArIGFwcC5wYXJhbXMudmlld0NsYXNzKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnNpemVOYXZiYXJzKSBhcHAuc2l6ZU5hdmJhcnMocGFuZWwuZmluZCgnLicgKyBhcHAucGFyYW1zLnZpZXdDbGFzcylbMF0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpc01vdmVkID0gdHJ1ZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIHZhciB0aHJlc2hvbGQgPSBvcGVuZWQgPyAwIDogLWFwcC5wYXJhbXMuc3dpcGVQYW5lbFRocmVzaG9sZDtcbiAgICAgICAgICAgICAgICBpZiAoc2lkZSA9PT0gJ3JpZ2h0JykgdGhyZXNob2xkID0gLXRocmVzaG9sZDtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB0b3VjaGVzRGlmZiA9IHBhZ2VYIC0gdG91Y2hlc1N0YXJ0LnggKyB0aHJlc2hvbGQ7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChzaWRlID09PSAncmlnaHQnKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZSA9IHRvdWNoZXNEaWZmICAtIChvcGVuZWQgPyBwYW5lbFdpZHRoIDogMCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGUgPiAwKSB0cmFuc2xhdGUgPSAwO1xuICAgICAgICAgICAgICAgICAgICBpZiAodHJhbnNsYXRlIDwgLXBhbmVsV2lkdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZSA9IC1wYW5lbFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGUgPSB0b3VjaGVzRGlmZiAgKyAob3BlbmVkID8gcGFuZWxXaWR0aCA6IDApO1xuICAgICAgICAgICAgICAgICAgICBpZiAodHJhbnNsYXRlIDwgMCkgdHJhbnNsYXRlID0gMDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZSA+IHBhbmVsV2lkdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZSA9IHBhbmVsV2lkdGg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGVmZmVjdCA9PT0gJ3JldmVhbCcpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlld3MudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgdHJhbnNsYXRlICsgJ3B4LDAsMCknKS50cmFuc2l0aW9uKDApO1xuICAgICAgICAgICAgICAgICAgICBwYW5lbE92ZXJsYXkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgdHJhbnNsYXRlICsgJ3B4LDAsMCknKS50cmFuc2l0aW9uKDApO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ3N3aXBlUGFuZWxTZXRUcmFuc2Zvcm0nLCB2aWV3c1swXSwgcGFuZWxbMF0sIE1hdGguYWJzKHRyYW5zbGF0ZSAvIHBhbmVsV2lkdGgpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBhbmVsLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHRyYW5zbGF0ZSArICdweCwwLDApJykudHJhbnNpdGlvbigwKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhbmVsT3ZlcmxheS50cmFuc2l0aW9uKDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcmxheU9wYWNpdHkgPSBNYXRoLmFicyh0cmFuc2xhdGUvcGFuZWxXaWR0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYW5lbE92ZXJsYXkuY3NzKHtvcGFjaXR5OiBvdmVybGF5T3BhY2l0eX0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGFwcC5wbHVnaW5Ib29rKCdzd2lwZVBhbmVsU2V0VHJhbnNmb3JtJywgdmlld3NbMF0sIHBhbmVsWzBdLCBNYXRoLmFicyh0cmFuc2xhdGUgLyBwYW5lbFdpZHRoKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoZSkge1xuICAgICAgICAgICAgICAgIGlmICghaXNUb3VjaGVkIHx8ICFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZhciB0aW1lRGlmZiA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCkgLSB0b3VjaFN0YXJ0VGltZTtcbiAgICAgICAgICAgICAgICB2YXIgYWN0aW9uO1xuICAgICAgICAgICAgICAgIHZhciBlZGdlID0gKHRyYW5zbGF0ZSA9PT0gMCB8fCBNYXRoLmFicyh0cmFuc2xhdGUpID09PSBwYW5lbFdpZHRoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCFvcGVuZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gJ3Jlc2V0JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVEaWZmIDwgMzAwICYmIE1hdGguYWJzKHRyYW5zbGF0ZSkgPiAwIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lRGlmZiA+PSAzMDAgJiYgKE1hdGguYWJzKHRyYW5zbGF0ZSkgPj0gcGFuZWxXaWR0aCAvIDIpXG4gICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gJ3N3YXAnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gJ3Jlc2V0JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZSA9PT0gLXBhbmVsV2lkdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbiA9ICdyZXNldCc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoXG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lRGlmZiA8IDMwMCAmJiBNYXRoLmFicyh0cmFuc2xhdGUpID49IDAgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVEaWZmID49IDMwMCAmJiAoTWF0aC5hYnModHJhbnNsYXRlKSA8PSBwYW5lbFdpZHRoIC8gMilcbiAgICAgICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2lkZSA9PT0gJ2xlZnQnICYmIHRyYW5zbGF0ZSA9PT0gcGFuZWxXaWR0aCkgYWN0aW9uID0gJ3Jlc2V0JztcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgYWN0aW9uID0gJ3N3YXAnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gJ3Jlc2V0JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uID09PSAnc3dhcCcpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLmFsbG93UGFuZWxPcGVuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wZW5lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmNsb3NlUGFuZWwoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlZGdlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFuZWwuY3NzKHtkaXNwbGF5OiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJ2JvZHknKS5yZW1vdmVDbGFzcygncGFuZWwtY2xvc2luZycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLm9wZW5QYW5lbChzaWRlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoZWRnZSkgYXBwLmFsbG93UGFuZWxPcGVuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ3Jlc2V0Jykge1xuICAgICAgICAgICAgICAgICAgICBpZiAob3BlbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuYWxsb3dQYW5lbE9wZW4gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLm9wZW5QYW5lbChzaWRlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZVBhbmVsKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWRnZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5hbGxvd1BhbmVsT3BlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFuZWwuY3NzKHtkaXNwbGF5OiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IGVmZmVjdCA9PT0gJ3JldmVhbCcgPyB2aWV3cyA6IHBhbmVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhbmVsLnRyaWdnZXIoJ2Nsb3NlJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnYm9keScpLmFkZENsYXNzKCdwYW5lbC1jbG9zaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYW5lbC50cmlnZ2VyKCdjbG9zZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFuZWwuY3NzKHtkaXNwbGF5OiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCdib2R5JykucmVtb3ZlQ2xhc3MoJ3BhbmVsLWNsb3NpbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmFsbG93UGFuZWxPcGVuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZWZmZWN0ID09PSAncmV2ZWFsJykge1xuICAgICAgICAgICAgICAgICAgICB2aWV3cy50cmFuc2l0aW9uKCcnKTtcbiAgICAgICAgICAgICAgICAgICAgdmlld3MudHJhbnNmb3JtKCcnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcGFuZWwudHJhbnNpdGlvbignJykudHJhbnNmb3JtKCcnKTtcbiAgICAgICAgICAgICAgICBwYW5lbE92ZXJsYXkuY3NzKHtkaXNwbGF5OiAnJ30pLnRyYW5zZm9ybSgnJykudHJhbnNpdGlvbignJykuY3NzKCdvcGFjaXR5JywgJycpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgJChkb2N1bWVudCkub24oYXBwLnRvdWNoRXZlbnRzLnN0YXJ0LCBoYW5kbGVUb3VjaFN0YXJ0KTtcbiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKGFwcC50b3VjaEV2ZW50cy5tb3ZlLCBoYW5kbGVUb3VjaE1vdmUpO1xuICAgICAgICAgICAgJChkb2N1bWVudCkub24oYXBwLnRvdWNoRXZlbnRzLmVuZCwgaGFuZGxlVG91Y2hFbmQpO1xuICAgICAgICB9O1xuICAgICAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBJbWFnZSBMYXp5IExvYWRpbmcgICAqKioqKioqKioqKipcbiAgICAgICAgKioqKioqKioqKioqICAgQmFzZWQgb24gc29sdXRpb24gYnkgTWFyYyBHb2RhcmQsIGh0dHBzOi8vZ2l0aHViLmNvbS9NYXJjR29kYXJkICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5pbml0SW1hZ2VzTGF6eUxvYWQgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gTGF6eSBpbWFnZXNcbiAgICAgICAgICAgIHZhciBsYXp5TG9hZEltYWdlcztcbiAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmhhc0NsYXNzKCdsYXp5JykpIHtcbiAgICAgICAgICAgICAgICBsYXp5TG9hZEltYWdlcyA9IHBhZ2VDb250YWluZXI7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9IGxhenlMb2FkSW1hZ2VzLnBhcmVudHMoJy5wYWdlJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBsYXp5TG9hZEltYWdlcyA9IHBhZ2VDb250YWluZXIuZmluZCgnLmxhenknKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChsYXp5TG9hZEltYWdlcy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTY3JvbGxhYmxlIHBhZ2UgY29udGVudFxuICAgICAgICAgICAgdmFyIHBhZ2VDb250ZW50O1xuICAgICAgICAgICAgaWYgKHBhZ2VDb250YWluZXIuaGFzQ2xhc3MoJ3BhZ2UtY29udGVudCcpKSAge1xuICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50ID0gcGFnZUNvbnRhaW5lcjtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gcGFnZUNvbnRhaW5lci5wYXJlbnRzKCcucGFnZScpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSAge1xuICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50ID0gcGFnZUNvbnRhaW5lci5maW5kKCcucGFnZS1jb250ZW50Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocGFnZUNvbnRlbnQubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUGxhY2Vob2xkZXJcbiAgICAgICAgICAgIHZhciBwbGFjZWhvbGRlclNyYyA9ICdkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZCT1J3MEtHZ29BQUFBTlNVaEVVZ0FBQUFFQUFBQUJBUU1BQUFBbDIxYktBQUFBQTFCTVZFWEN3c0s1OTJta0FBQUFDa2xFUVZRSTEyTmdBQUFBQWdBQjRpRzhNd0FBQUFCSlJVNUVya0pnZ2c9PSc7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGFwcC5wYXJhbXMuaW1hZ2VzTGF6eUxvYWRQbGFjZWhvbGRlciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlclNyYyA9IGFwcC5wYXJhbXMuaW1hZ2VzTGF6eUxvYWRQbGFjZWhvbGRlcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmltYWdlc0xhenlMb2FkUGxhY2Vob2xkZXIgIT09IGZhbHNlKSBsYXp5TG9hZEltYWdlcy5lYWNoKGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgaWYgKCQodGhpcykuYXR0cignZGF0YS1zcmMnKSkgJCh0aGlzKS5hdHRyKCdzcmMnLCBwbGFjZWhvbGRlclNyYyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBsb2FkIGltYWdlXG4gICAgICAgICAgICB2YXIgaW1hZ2VzU2VxdWVuY2UgPSBbXTtcbiAgICAgICAgICAgIHZhciBpbWFnZUlzTG9hZGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgZnVuY3Rpb24gbG9hZEltYWdlKGVsKSB7XG4gICAgICAgICAgICAgICAgZWwgPSAkKGVsKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIGJnID0gZWwuYXR0cignZGF0YS1iYWNrZ3JvdW5kJyk7XG4gICAgICAgICAgICAgICAgdmFyIHNyYyA9IGJnID8gYmcgOiBlbC5hdHRyKCdkYXRhLXNyYycpO1xuICAgICAgICAgICAgICAgIGlmICghc3JjKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIG9uTG9hZCgpIHtcbiAgICAgICAgICAgICAgICAgICAgZWwucmVtb3ZlQ2xhc3MoJ2xhenknKS5hZGRDbGFzcygnbGF6eS1sb2FkZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbC5jc3MoJ2JhY2tncm91bmQtaW1hZ2UnLCAndXJsKCcgKyBzcmMgKyAnKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWwuYXR0cignc3JjJywgc3JjKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuaW1hZ2VzTGF6eUxvYWRTZXF1ZW50aWFsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbWFnZUlzTG9hZGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGltYWdlc1NlcXVlbmNlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkSW1hZ2UoaW1hZ2VzU2VxdWVuY2Uuc2hpZnQoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmltYWdlc0xhenlMb2FkU2VxdWVudGlhbCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW1hZ2VJc0xvYWRpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbWFnZXNTZXF1ZW5jZS5pbmRleE9mKGVsWzBdKSA8IDApIGltYWdlc1NlcXVlbmNlLnB1c2goZWxbMF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBMb2FkaW5nIGZsYWdcbiAgICAgICAgICAgICAgICBpbWFnZUlzTG9hZGluZyA9IHRydWU7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIGltYWdlID0gbmV3IEltYWdlKCk7XG4gICAgICAgICAgICAgICAgaW1hZ2Uub25sb2FkID0gb25Mb2FkO1xuICAgICAgICAgICAgICAgIGltYWdlLm9uZXJyb3IgPSBvbkxvYWQ7XG4gICAgICAgICAgICAgICAgaW1hZ2Uuc3JjID1zcmM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBsYXp5SGFuZGxlcigpIHtcbiAgICAgICAgICAgICAgICBsYXp5TG9hZEltYWdlcyA9IHBhZ2VDb250YWluZXIuZmluZCgnLmxhenknKTtcbiAgICAgICAgICAgICAgICBsYXp5TG9hZEltYWdlcy5lYWNoKGZ1bmN0aW9uKGluZGV4LCBlbCkge1xuICAgICAgICAgICAgICAgICAgICBlbCA9ICQoZWwpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZWwucGFyZW50cygnLnRhYjpub3QoLmFjdGl2ZSknKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRWxlbWVudEluVmlld3BvcnQoZWxbMF0pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsb2FkSW1hZ2UoZWwpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgZnVuY3Rpb24gaXNFbGVtZW50SW5WaWV3cG9ydCAoZWwpIHtcbiAgICAgICAgICAgICAgICB2YXIgcmVjdCA9IGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgICAgICAgICAgIHZhciB0aHJlc2hvbGQgPSBhcHAucGFyYW1zLmltYWdlc0xhenlMb2FkVGhyZXNob2xkIHx8IDA7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgICAgICAgICAgcmVjdC50b3AgPj0gKDAgLSB0aHJlc2hvbGQpICYmXG4gICAgICAgICAgICAgICAgICAgIHJlY3QubGVmdCA+PSAoMCAtIHRocmVzaG9sZCkgJiZcbiAgICAgICAgICAgICAgICAgICAgcmVjdC50b3AgPD0gKHdpbmRvdy5pbm5lckhlaWdodCArIHRocmVzaG9sZCkgJiZcbiAgICAgICAgICAgICAgICAgICAgcmVjdC5sZWZ0IDw9ICh3aW5kb3cuaW5uZXJXaWR0aCArIHRocmVzaG9sZClcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIGF0dGFjaEV2ZW50cyhkZXN0cm95KSB7XG4gICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGRlc3Ryb3kgPyAnb2ZmJyA6ICdvbic7XG4gICAgICAgICAgICAgICAgbGF6eUxvYWRJbWFnZXNbbWV0aG9kXSgnbGF6eScsIGxhenlIYW5kbGVyKTtcbiAgICAgICAgICAgICAgICBsYXp5TG9hZEltYWdlcy5wYXJlbnRzKCcudGFiJylbbWV0aG9kXSgnc2hvdycsIGxhenlIYW5kbGVyKTtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyW21ldGhvZF0oJ2xhenknLCBsYXp5SGFuZGxlcik7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRlbnRbbWV0aG9kXSgnbGF6eScsIGxhenlIYW5kbGVyKTtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGVudFttZXRob2RdKCdzY3JvbGwnLCBsYXp5SGFuZGxlcik7XG4gICAgICAgICAgICAgICAgJCh3aW5kb3cpW21ldGhvZF0oJ3Jlc2l6ZScsIGxhenlIYW5kbGVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGRldGFjaEV2ZW50cygpIHtcbiAgICAgICAgICAgICAgICBhdHRhY2hFdmVudHModHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU3RvcmUgZGV0YWNoIGZ1bmN0aW9uXG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyWzBdLmY3RGVzdHJveUltYWdlc0xhenlMb2FkID0gZGV0YWNoRXZlbnRzO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEF0dGFjaCBldmVudHNcbiAgICAgICAgICAgIGF0dGFjaEV2ZW50cygpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIERlc3Ryb3kgb24gcGFnZSByZW1vdmVcbiAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmhhc0NsYXNzKCdwYWdlJykpIHtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyLm9uY2UoJ3BhZ2VCZWZvcmVSZW1vdmUnLCBkZXRhY2hFdmVudHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFJ1biBsb2FkZXIgb24gcGFnZSBsb2FkL2luaXRcbiAgICAgICAgICAgIGxhenlIYW5kbGVyKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUnVuIGFmdGVyIHBhZ2UgYW5pbWF0aW9uXG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyLm9uY2UoJ3BhZ2VBZnRlckFuaW1hdGlvbicsIGxhenlIYW5kbGVyKTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmRlc3Ryb3lJbWFnZXNMYXp5TG9hZCA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmxlbmd0aCA+IDAgJiYgcGFnZUNvbnRhaW5lclswXS5mN0Rlc3Ryb3lJbWFnZXNMYXp5TG9hZCkge1xuICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXJbMF0uZjdEZXN0cm95SW1hZ2VzTGF6eUxvYWQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnJlaW5pdEltYWdlc0xhenlMb2FkID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgaWYgKHBhZ2VDb250YWluZXIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIudHJpZ2dlcignbGF6eScpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIE1hdGVyaWFsIFByZWxvYWRlciAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAuaW5pdFBhZ2VNYXRlcmlhbFByZWxvYWRlciA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICAkKHBhZ2VDb250YWluZXIpLmZpbmQoJy5wcmVsb2FkZXInKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS5jaGlsZHJlbigpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLmh0bWwoYXBwLnBhcmFtcy5tYXRlcmlhbFByZWxvYWRlckh0bWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIE1lc3NhZ2VzICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHZhciBNZXNzYWdlcyA9IGZ1bmN0aW9uIChjb250YWluZXIsIHBhcmFtcykge1xuICAgICAgICAgICAgdmFyIGRlZmF1bHRzID0ge1xuICAgICAgICAgICAgICAgIGF1dG9MYXlvdXQ6IHRydWUsXG4gICAgICAgICAgICAgICAgbmV3TWVzc2FnZXNGaXJzdDogZmFsc2UsXG4gICAgICAgICAgICAgICAgbWVzc2FnZVRlbXBsYXRlOiBcbiAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIGRheX19JyArXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibWVzc2FnZXMtZGF0ZVwiPnt7ZGF5fX0ge3sjaWYgdGltZX19LCA8c3Bhbj57e3RpbWV9fTwvc3Bhbj57ey9pZn19PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibWVzc2FnZSBtZXNzYWdlLXt7dHlwZX19IHt7I2lmIGhhc0ltYWdlfX1tZXNzYWdlLXBpY3t7L2lmfX0ge3sjaWYgYXZhdGFyfX1tZXNzYWdlLXdpdGgtYXZhdGFye3svaWZ9fSB7eyNpZiBwb3NpdGlvbn19bWVzc2FnZS1hcHBlYXItZnJvbS17e3Bvc2l0aW9ufX17ey9pZn19XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgbmFtZX19PGRpdiBjbGFzcz1cIm1lc3NhZ2UtbmFtZVwiPnt7bmFtZX19PC9kaXY+e3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJtZXNzYWdlLXRleHRcIj57e3RleHR9fXt7I2lmIGRhdGV9fTxkaXYgY2xhc3M9XCJtZXNzYWdlLWRhdGVcIj57e2RhdGV9fTwvZGl2Pnt7L2lmfX08L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBhdmF0YXJ9fTxkaXYgY2xhc3M9XCJtZXNzYWdlLWF2YXRhclwiIHN0eWxlPVwiYmFja2dyb3VuZC1pbWFnZTp1cmwoe3thdmF0YXJ9fSlcIj48L2Rpdj57ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgbGFiZWx9fTxkaXYgY2xhc3M9XCJtZXNzYWdlLWxhYmVsXCI+e3tsYWJlbH19PC9kaXY+e3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+J1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcbiAgICAgICAgICAgIGZvciAodmFyIGRlZiBpbiBkZWZhdWx0cykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW2RlZl0gPT09ICd1bmRlZmluZWQnIHx8IHBhcmFtc1tkZWZdID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtc1tkZWZdID0gZGVmYXVsdHNbZGVmXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5zdGFuY2VcbiAgICAgICAgICAgIHZhciBtID0gdGhpcztcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQYXJhbXNcbiAgICAgICAgICAgIG0ucGFyYW1zID0gcGFyYW1zO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIENvbnRhaW5lclxuICAgICAgICAgICAgbS5jb250YWluZXIgPSAkKGNvbnRhaW5lcik7XG4gICAgICAgICAgICBpZiAobS5jb250YWluZXIubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQXV0b2xheW91dFxuICAgICAgICAgICAgaWYgKG0ucGFyYW1zLmF1dG9MYXlvdXQpIG0uY29udGFpbmVyLmFkZENsYXNzKCdtZXNzYWdlcy1hdXRvLWxheW91dCcpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIE5ldyBtZXNzYWdlcyBmaXJzdFxuICAgICAgICAgICAgaWYgKG0ucGFyYW1zLm5ld01lc3NhZ2VzRmlyc3QpIG0uY29udGFpbmVyLmFkZENsYXNzKCdtZXNzYWdlcy1uZXctZmlyc3QnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJcyBJbiBQYWdlXG4gICAgICAgICAgICBtLnBhZ2VDb250YWluZXIgPSBtLmNvbnRhaW5lci5wYXJlbnRzKCcucGFnZScpLmVxKDApO1xuICAgICAgICAgICAgbS5wYWdlQ29udGVudCA9IG0ucGFnZUNvbnRhaW5lci5maW5kKCcucGFnZS1jb250ZW50Jyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ29tcGlsZWQgdGVtcGxhdGVcbiAgICAgICAgICAgIG0udGVtcGxhdGUgPSBUZW1wbGF0ZTcuY29tcGlsZShtLnBhcmFtcy5tZXNzYWdlVGVtcGxhdGUpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEF1dG8gTGF5b3V0XG4gICAgICAgICAgICBtLmxheW91dCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoIW0uY29udGFpbmVyLmhhc0NsYXNzKCdtZXNzYWdlcy1hdXRvLWxheW91dCcpKSBtLmNvbnRhaW5lci5hZGRDbGFzcygnbWVzc2FnZXMtYXV0by1sYXlvdXQnKTtcbiAgICAgICAgICAgICAgICBtLmNvbnRhaW5lci5maW5kKCcubWVzc2FnZScpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLmZpbmQoJy5tZXNzYWdlLXRleHQgaW1nJykubGVuZ3RoID4gMCkgbWVzc2FnZS5hZGRDbGFzcygnbWVzc2FnZS1waWMnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZmluZCgnLm1lc3NhZ2UtYXZhdGFyJykubGVuZ3RoID4gMCkgbWVzc2FnZS5hZGRDbGFzcygnbWVzc2FnZS13aXRoLWF2YXRhcicpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIG0uY29udGFpbmVyLmZpbmQoJy5tZXNzYWdlJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlzU2VudCA9IG1lc3NhZ2UuaGFzQ2xhc3MoJ21lc3NhZ2Utc2VudCcpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IG1lc3NhZ2UubmV4dCgnLm1lc3NhZ2UtJyArIChpc1NlbnQgPyAnc2VudCcgOiAncmVjZWl2ZWQnKSk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwcmV2ID0gbWVzc2FnZS5wcmV2KCcubWVzc2FnZS0nICsgKGlzU2VudCA/ICdzZW50JyA6ICdyZWNlaXZlZCcpKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmFkZENsYXNzKCdtZXNzYWdlLWxhc3QgbWVzc2FnZS13aXRoLXRhaWwnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIG1lc3NhZ2UucmVtb3ZlQ2xhc3MoJ21lc3NhZ2UtbGFzdCBtZXNzYWdlLXdpdGgtdGFpbCcpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXYubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmFkZENsYXNzKCdtZXNzYWdlLWZpcnN0Jyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBtZXNzYWdlLnJlbW92ZUNsYXNzKCdtZXNzYWdlLWZpcnN0Jyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAocHJldi5sZW5ndGggPiAwICYmIHByZXYuZmluZCgnLm1lc3NhZ2UtbmFtZScpLmxlbmd0aCA+IDAgJiYgbWVzc2FnZS5maW5kKCcubWVzc2FnZS1uYW1lJykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXYuZmluZCgnLm1lc3NhZ2UtbmFtZScpLnRleHQoKSAhPT0gbWVzc2FnZS5maW5kKCcubWVzc2FnZS1uYW1lJykudGV4dCgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJldi5hZGRDbGFzcygnbWVzc2FnZS1sYXN0IG1lc3NhZ2Utd2l0aC10YWlsJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5hZGRDbGFzcygnbWVzc2FnZS1maXJzdCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEFkZCBNZXNzYWdlXG4gICAgICAgICAgICBtLmFwcGVuZE1lc3NhZ2UgPSBmdW5jdGlvbiAocHJvcHMsIGFuaW1hdGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbS5hZGRNZXNzYWdlKHByb3BzLCAnYXBwZW5kJywgYW5pbWF0ZSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbS5wcmVwZW5kTWVzc2FnZSA9IGZ1bmN0aW9uIChwcm9wcywgYW5pbWF0ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBtLmFkZE1lc3NhZ2UocHJvcHMsICdwcmVwZW5kJywgYW5pbWF0ZSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbS5hZGRNZXNzYWdlID0gZnVuY3Rpb24gKHByb3BzLCBtZXRob2QsIGFuaW1hdGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbS5hZGRNZXNzYWdlcyhbcHJvcHNdLCBtZXRob2QsIGFuaW1hdGUpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG0uYWRkTWVzc2FnZXMgPSBmdW5jdGlvbiAobmV3TWVzc2FnZXMsIG1ldGhvZCwgYW5pbWF0ZSkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYW5pbWF0ZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgYW5pbWF0ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbWV0aG9kID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBtZXRob2QgPSBtLnBhcmFtcy5uZXdNZXNzYWdlc0ZpcnN0ID8gJ3ByZXBlbmQnIDogJ2FwcGVuZCc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBuZXdNZXNzYWdlc0hUTUwgPSAnJywgaTtcbiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbmV3TWVzc2FnZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByb3BzID0gbmV3TWVzc2FnZXNbaV0gfHwge307XG4gICAgICAgICAgICAgICAgICAgIHByb3BzLnR5cGUgPSBwcm9wcy50eXBlIHx8ICdzZW50JztcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwcm9wcy50ZXh0KSBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgcHJvcHMuaGFzSW1hZ2UgPSBwcm9wcy50ZXh0LmluZGV4T2YoJzxpbWcnKSA+PSAwO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYW5pbWF0ZSkgcHJvcHMucG9zaXRpb24gPSBtZXRob2QgPT09ICdhcHBlbmQnID8gJ2JvdHRvbScgOiAndG9wJztcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIG5ld01lc3NhZ2VzSFRNTCArPSBtLnRlbXBsYXRlKHByb3BzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIGhlaWdodEJlZm9yZSwgc2Nyb2xsQmVmb3JlO1xuICAgICAgICAgICAgICAgIGlmIChtZXRob2QgPT09ICdwcmVwZW5kJykge1xuICAgICAgICAgICAgICAgICAgICBoZWlnaHRCZWZvcmUgPSBtLnBhZ2VDb250ZW50WzBdLnNjcm9sbEhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsQmVmb3JlID0gbS5wYWdlQ29udGVudFswXS5zY3JvbGxUb3A7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG0uY29udGFpbmVyW21ldGhvZF0obmV3TWVzc2FnZXNIVE1MKTtcbiAgICAgICAgICAgICAgICBpZiAobS5wYXJhbXMuYXV0b0xheW91dCkgbS5sYXlvdXQoKTtcbiAgICAgICAgICAgICAgICBpZiAobWV0aG9kID09PSAncHJlcGVuZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgbS5wYWdlQ29udGVudFswXS5zY3JvbGxUb3AgPSBzY3JvbGxCZWZvcmUgKyAobS5wYWdlQ29udGVudFswXS5zY3JvbGxIZWlnaHQgLSBoZWlnaHRCZWZvcmUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoKG1ldGhvZCA9PT0gJ2FwcGVuZCcgJiYgIW0ucGFyYW1zLm5ld01lc3NhZ2VzRmlyc3QpIHx8IChtZXRob2QgPT09ICdwcmVwZW5kJyAmJiBtLnBhcmFtcy5uZXdNZXNzYWdlc0ZpcnN0KSkge1xuICAgICAgICAgICAgICAgICAgICBtLnNjcm9sbE1lc3NhZ2VzKGFuaW1hdGUgPyB1bmRlZmluZWQgOiAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2VzID0gbS5jb250YWluZXIuZmluZCgnLm1lc3NhZ2UnKTtcbiAgICAgICAgICAgICAgICBpZiAobmV3TWVzc2FnZXMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBtZXRob2QgPT09ICdhcHBlbmQnID8gbWVzc2FnZXNbbWVzc2FnZXMubGVuZ3RoIC0gMV0gOiBtZXNzYWdlc1swXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlc1RvUmV0dXJuID0gW107XG4gICAgICAgICAgICAgICAgICAgIGlmIChtZXRob2QgPT09ICdhcHBlbmQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSBtZXNzYWdlcy5sZW5ndGggLSBuZXdNZXNzYWdlcy5sZW5ndGg7IGkgPCBtZXNzYWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VzVG9SZXR1cm4ucHVzaChtZXNzYWdlc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbmV3TWVzc2FnZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlc1RvUmV0dXJuLnB1c2gobWVzc2FnZXNbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSAgIFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBtZXNzYWdlc1RvUmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBtLnJlbW92ZU1lc3NhZ2UgPSBmdW5jdGlvbiAobWVzc2FnZSkge1xuICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSAkKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAobS5wYXJhbXMuYXV0b0xheW91dCkgbS5sYXlvdXQoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG0ucmVtb3ZlTWVzc2FnZXMgPSBmdW5jdGlvbiAobWVzc2FnZXMpIHtcbiAgICAgICAgICAgICAgICBtLnJlbW92ZU1lc3NhZ2UobWVzc2FnZXMpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG0uY2xlYW4gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgbS5jb250YWluZXIuaHRtbCgnJyk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNjcm9sbFxuICAgICAgICAgICAgbS5zY3JvbGxNZXNzYWdlcyA9IGZ1bmN0aW9uIChkdXJhdGlvbiwgc2Nyb2xsVG9wKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkdXJhdGlvbiA9PT0gJ3VuZGVmaW5lZCcpIGR1cmF0aW9uID0gNDAwO1xuICAgICAgICAgICAgICAgIHZhciBjdXJyZW50U2Nyb2xsID0gbS5wYWdlQ29udGVudFswXS5zY3JvbGxUb3A7XG4gICAgICAgICAgICAgICAgdmFyIG5ld1Njcm9sbDtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNjcm9sbFRvcCAhPT0gJ3VuZGVmaW5lZCcpIG5ld1Njcm9sbCA9IHNjcm9sbFRvcDtcbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmV3U2Nyb2xsID0gbS5wYXJhbXMubmV3TWVzc2FnZXNGaXJzdCA/IDAgOiBtLnBhZ2VDb250ZW50WzBdLnNjcm9sbEhlaWdodCAtIG0ucGFnZUNvbnRlbnRbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICBpZiAobmV3U2Nyb2xsID09PSBjdXJyZW50U2Nyb2xsKSByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG0ucGFnZUNvbnRlbnQuc2Nyb2xsVG9wKG5ld1Njcm9sbCwgZHVyYXRpb24pO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0IERlc3Ryb3lcbiAgICAgICAgICAgIG0uaW5pdCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAobS5wYXJhbXMubWVzc2FnZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgbS5hZGRNZXNzYWdlcyhtLnBhcmFtcy5tZXNzYWdlcywgdW5kZWZpbmVkLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAobS5wYXJhbXMuYXV0b0xheW91dCkgbS5sYXlvdXQoKTsgICAgXG4gICAgICAgICAgICAgICAgICAgIG0uc2Nyb2xsTWVzc2FnZXMoMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG0uZGVzdHJveSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBtID0gbnVsbDtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdFxuICAgICAgICAgICAgbS5pbml0KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgbS5jb250YWluZXJbMF0uZjdNZXNzYWdlcyA9IG07XG4gICAgICAgICAgICByZXR1cm4gbTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLm1lc3NhZ2VzID0gZnVuY3Rpb24gKGNvbnRhaW5lciwgcGFyYW1zKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IE1lc3NhZ2VzIChjb250YWluZXIsIHBhcmFtcyk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5pbml0UGFnZU1lc3NhZ2VzID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgdmFyIG1lc3NhZ2VzID0gcGFnZUNvbnRhaW5lci5maW5kKCcubWVzc2FnZXMnKTtcbiAgICAgICAgICAgIGlmIChtZXNzYWdlcy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIGlmICghbWVzc2FnZXMuaGFzQ2xhc3MoJ21lc3NhZ2VzLWluaXQnKSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBtID0gYXBwLm1lc3NhZ2VzKG1lc3NhZ2VzLCBtZXNzYWdlcy5kYXRhc2V0KCkpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIERlc3Ryb3kgb24gcGFnZSByZW1vdmVcbiAgICAgICAgICAgIGZ1bmN0aW9uIHBhZ2VCZWZvcmVSZW1vdmUoKSB7XG4gICAgICAgICAgICAgICAgbS5kZXN0cm95KCk7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5vZmYoJ3BhZ2VCZWZvcmVSZW1vdmUnLCBwYWdlQmVmb3JlUmVtb3ZlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmhhc0NsYXNzKCdwYWdlJykpIHtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyLm9uKCdwYWdlQmVmb3JlUmVtb3ZlJywgcGFnZUJlZm9yZVJlbW92ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBTd2lwZW91dCBBY3Rpb25zIChTd2lwZSB0byBkZWxldGUpICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAuc3dpcGVvdXRPcGVuZWRFbCA9IHVuZGVmaW5lZDtcbiAgICAgICAgYXBwLmFsbG93U3dpcGVvdXQgPSB0cnVlO1xuICAgICAgICBhcHAuaW5pdFN3aXBlb3V0ID0gZnVuY3Rpb24gKHN3aXBlb3V0RWwpIHtcbiAgICAgICAgICAgIHZhciBpc1RvdWNoZWQsIGlzTW92ZWQsIGlzU2Nyb2xsaW5nLCB0b3VjaGVzU3RhcnQgPSB7fSwgdG91Y2hTdGFydFRpbWUsIHRvdWNoZXNEaWZmLCBzd2lwZU91dEVsLCBzd2lwZU91dENvbnRlbnQsIGFjdGlvbnNSaWdodCwgYWN0aW9uc0xlZnQsIGFjdGlvbnNMZWZ0V2lkdGgsIGFjdGlvbnNSaWdodFdpZHRoLCB0cmFuc2xhdGUsIG9wZW5lZCwgb3BlbmVkQWN0aW9ucywgYnV0dG9uc0xlZnQsIGJ1dHRvbnNSaWdodCwgZGlyZWN0aW9uLCBvdmVyc3dpcGVMZWZ0QnV0dG9uLCBvdmVyc3dpcGVSaWdodEJ1dHRvbiwgb3ZlcnN3aXBlTGVmdCwgb3ZlcnN3aXBlUmlnaHQsIG5vRm9sZExlZnQsIG5vRm9sZFJpZ2h0O1xuICAgICAgICAgICAgJChkb2N1bWVudCkub24oYXBwLnRvdWNoRXZlbnRzLnN0YXJ0LCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGlmIChhcHAuc3dpcGVvdXRPcGVuZWRFbCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gJChlLnRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghKFxuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnN3aXBlb3V0T3BlbmVkRWwuaXModGFyZ2V0WzBdKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnBhcmVudHMoJy5zd2lwZW91dCcpLmlzKGFwcC5zd2lwZW91dE9wZW5lZEVsKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Lmhhc0NsYXNzKCdtb2RhbC1pbicpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQuaGFzQ2xhc3MoJ21vZGFsLW92ZXJsYXknKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Lmhhc0NsYXNzKCdhY3Rpb25zLW1vZGFsJykgfHwgXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQucGFyZW50cygnLmFjdGlvbnMtbW9kYWwubW9kYWwtaW4sIC5tb2RhbC5tb2RhbC1pbicpLmxlbmd0aCA+IDBcbiAgICAgICAgICAgICAgICAgICAgICAgICkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5zd2lwZW91dENsb3NlKGFwcC5zd2lwZW91dE9wZW5lZEVsKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoZSkge1xuICAgICAgICAgICAgICAgIGlmICghYXBwLmFsbG93U3dpcGVvdXQpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpc1Njcm9sbGluZyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB0b3VjaGVzU3RhcnQueCA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZS5wYWdlWDtcbiAgICAgICAgICAgICAgICB0b3VjaGVzU3RhcnQueSA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICB0b3VjaFN0YXJ0VGltZSA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoZSkge1xuICAgICAgICAgICAgICAgIGlmICghaXNUb3VjaGVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2VYID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGUucGFnZVg7XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2VZID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpc1Njcm9sbGluZyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNTY3JvbGxpbmcgPSAhIShpc1Njcm9sbGluZyB8fCBNYXRoLmFicyhwYWdlWSAtIHRvdWNoZXNTdGFydC55KSA+IE1hdGguYWJzKHBhZ2VYIC0gdG91Y2hlc1N0YXJ0LngpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGlzU2Nyb2xsaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIWlzTW92ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQoJy5saXN0LWJsb2NrLnNvcnRhYmxlLW9wZW5lZCcpLmxlbmd0aCA+IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi9cbiAgICAgICAgICAgICAgICAgICAgc3dpcGVPdXRFbCA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIHN3aXBlT3V0Q29udGVudCA9IHN3aXBlT3V0RWwuZmluZCgnLnN3aXBlb3V0LWNvbnRlbnQnKTtcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uc1JpZ2h0ID0gc3dpcGVPdXRFbC5maW5kKCcuc3dpcGVvdXQtYWN0aW9ucy1yaWdodCcpO1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb25zTGVmdCA9IHN3aXBlT3V0RWwuZmluZCgnLnN3aXBlb3V0LWFjdGlvbnMtbGVmdCcpO1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb25zTGVmdFdpZHRoID0gYWN0aW9uc1JpZ2h0V2lkdGggPSBidXR0b25zTGVmdCA9IGJ1dHRvbnNSaWdodCA9IG92ZXJzd2lwZVJpZ2h0QnV0dG9uID0gb3ZlcnN3aXBlTGVmdEJ1dHRvbiA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIG5vRm9sZExlZnQgPSBhY3Rpb25zTGVmdC5oYXNDbGFzcygnc3dpcGVvdXQtYWN0aW9ucy1uby1mb2xkJykgfHwgYXBwLnBhcmFtcy5zd2lwZW91dEFjdGlvbnNOb0ZvbGQ7XG4gICAgICAgICAgICAgICAgICAgIG5vRm9sZFJpZ2h0ID0gYWN0aW9uc1JpZ2h0Lmhhc0NsYXNzKCdzd2lwZW91dC1hY3Rpb25zLW5vLWZvbGQnKSB8fCBhcHAucGFyYW1zLnN3aXBlb3V0QWN0aW9uc05vRm9sZDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbnNMZWZ0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbnNMZWZ0V2lkdGggPSBhY3Rpb25zTGVmdC5vdXRlcldpZHRoKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBidXR0b25zTGVmdCA9IGFjdGlvbnNMZWZ0LmNoaWxkcmVuKCdhJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBvdmVyc3dpcGVMZWZ0QnV0dG9uID0gYWN0aW9uc0xlZnQuZmluZCgnLnN3aXBlb3V0LW92ZXJzd2lwZScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb25zUmlnaHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uc1JpZ2h0V2lkdGggPSBhY3Rpb25zUmlnaHQub3V0ZXJXaWR0aCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uc1JpZ2h0ID0gYWN0aW9uc1JpZ2h0LmNoaWxkcmVuKCdhJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBvdmVyc3dpcGVSaWdodEJ1dHRvbiA9IGFjdGlvbnNSaWdodC5maW5kKCcuc3dpcGVvdXQtb3ZlcnN3aXBlJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgb3BlbmVkID0gc3dpcGVPdXRFbC5oYXNDbGFzcygnc3dpcGVvdXQtb3BlbmVkJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcGVuZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wZW5lZEFjdGlvbnMgPSBzd2lwZU91dEVsLmZpbmQoJy5zd2lwZW91dC1hY3Rpb25zLWxlZnQuc3dpcGVvdXQtYWN0aW9ucy1vcGVuZWQnKS5sZW5ndGggPiAwID8gJ2xlZnQnIDogJ3JpZ2h0JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzd2lwZU91dEVsLnJlbW92ZUNsYXNzKCd0cmFuc2l0aW9uaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYXBwLnBhcmFtcy5zd2lwZW91dE5vRm9sbG93KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzd2lwZU91dEVsLmZpbmQoJy5zd2lwZW91dC1hY3Rpb25zLW9wZW5lZCcpLnJlbW92ZUNsYXNzKCdzd2lwZW91dC1hY3Rpb25zLW9wZW5lZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3dpcGVPdXRFbC5yZW1vdmVDbGFzcygnc3dpcGVvdXQtb3BlbmVkJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaXNNb3ZlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRvdWNoZXNEaWZmID0gcGFnZVggLSB0b3VjaGVzU3RhcnQueDtcbiAgICAgICAgICAgICAgICB0cmFuc2xhdGUgPSB0b3VjaGVzRGlmZjtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKG9wZW5lZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAob3BlbmVkQWN0aW9ucyA9PT0gJ3JpZ2h0JykgdHJhbnNsYXRlID0gdHJhbnNsYXRlIC0gYWN0aW9uc1JpZ2h0V2lkdGg7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgdHJhbnNsYXRlID0gdHJhbnNsYXRlICsgYWN0aW9uc0xlZnRXaWR0aDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGUgPiAwICYmIGFjdGlvbnNMZWZ0Lmxlbmd0aCA9PT0gMCB8fCB0cmFuc2xhdGUgPCAwICYmIGFjdGlvbnNSaWdodC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFvcGVuZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXBlT3V0Q29udGVudC50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1dHRvbnNSaWdodCAmJiBidXR0b25zUmlnaHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbnNSaWdodC50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1dHRvbnNMZWZ0ICYmIGJ1dHRvbnNMZWZ0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25zTGVmdC50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZSA9IDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAodHJhbnNsYXRlIDwgMCkgZGlyZWN0aW9uID0gJ3RvLWxlZnQnO1xuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRyYW5zbGF0ZSA+IDApIGRpcmVjdGlvbiA9ICd0by1yaWdodCc7XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3Rpb24pIGRpcmVjdGlvbiA9IGRpcmVjdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBkaXJlY3Rpb24gPSAndG8tbGVmdCc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBpLCBidXR0b25PZmZzZXQsIHByb2dyZXNzO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGUuZjdQcmV2ZW50UGFuZWxTd2lwZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuc3dpcGVvdXROb0ZvbGxvdykge1xuICAgICAgICAgICAgICAgICAgICBpZiAob3BlbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob3BlbmVkQWN0aW9ucyA9PT0gJ3JpZ2h0JyAmJiB0b3VjaGVzRGlmZiA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAuc3dpcGVvdXRDbG9zZShzd2lwZU91dEVsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcGVuZWRBY3Rpb25zID09PSAnbGVmdCcgJiYgdG91Y2hlc0RpZmYgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnN3aXBlb3V0Q2xvc2Uoc3dpcGVPdXRFbCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodG91Y2hlc0RpZmYgPCAwICYmIGFjdGlvbnNSaWdodC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnN3aXBlb3V0T3Blbihzd2lwZU91dEVsLCAncmlnaHQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b3VjaGVzRGlmZiA+IDAgJiYgYWN0aW9uc0xlZnQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5zd2lwZW91dE9wZW4oc3dpcGVPdXRFbCwgJ2xlZnQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG92ZXJzd2lwZUxlZnQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBvdmVyc3dpcGVSaWdodCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZhciAkYnV0dG9uO1xuICAgICAgICAgICAgICAgIGlmIChhY3Rpb25zUmlnaHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBTaG93IHJpZ2h0IGFjdGlvbnNcbiAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MgPSB0cmFuc2xhdGUgLyBhY3Rpb25zUmlnaHRXaWR0aDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZSA8IC1hY3Rpb25zUmlnaHRXaWR0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlID0gLWFjdGlvbnNSaWdodFdpZHRoIC0gTWF0aC5wb3coLXRyYW5zbGF0ZSAtIGFjdGlvbnNSaWdodFdpZHRoLCAwLjgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG92ZXJzd2lwZVJpZ2h0QnV0dG9uLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdmVyc3dpcGVSaWdodCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJ1dHRvbnNSaWdodC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBidXR0b25zUmlnaHRbaV0uX2J1dHRvbk9mZnNldCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25zUmlnaHRbaV0uX2J1dHRvbk9mZnNldCA9IGJ1dHRvbnNSaWdodFtpXS5vZmZzZXRMZWZ0O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uT2Zmc2V0ID0gYnV0dG9uc1JpZ2h0W2ldLl9idXR0b25PZmZzZXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAkYnV0dG9uID0gJChidXR0b25zUmlnaHRbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG92ZXJzd2lwZVJpZ2h0QnV0dG9uLmxlbmd0aCA+IDAgJiYgJGJ1dHRvbi5oYXNDbGFzcygnc3dpcGVvdXQtb3ZlcnN3aXBlJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYnV0dG9uLmNzcyh7bGVmdDogKG92ZXJzd2lwZVJpZ2h0ID8gLWJ1dHRvbk9mZnNldCA6IDApICsgJ3B4J30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvdmVyc3dpcGVSaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYnV0dG9uLmFkZENsYXNzKCdzd2lwZW91dC1vdmVyc3dpcGUtYWN0aXZlJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYnV0dG9uLnJlbW92ZUNsYXNzKCdzd2lwZW91dC1vdmVyc3dpcGUtYWN0aXZlJyk7ICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgJGJ1dHRvbi50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAodHJhbnNsYXRlIC0gYnV0dG9uT2Zmc2V0ICogKDEgKyBNYXRoLm1heChwcm9ncmVzcywgLTEpKSkgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhY3Rpb25zTGVmdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFNob3cgbGVmdCBhY3Rpb25zXG4gICAgICAgICAgICAgICAgICAgIHByb2dyZXNzID0gdHJhbnNsYXRlIC8gYWN0aW9uc0xlZnRXaWR0aDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZSA+IGFjdGlvbnNMZWZ0V2lkdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZSA9IGFjdGlvbnNMZWZ0V2lkdGggKyBNYXRoLnBvdyh0cmFuc2xhdGUgLSBhY3Rpb25zTGVmdFdpZHRoLCAwLjgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG92ZXJzd2lwZUxlZnRCdXR0b24ubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJzd2lwZUxlZnQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBidXR0b25zTGVmdC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBidXR0b25zTGVmdFtpXS5fYnV0dG9uT2Zmc2V0ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbnNMZWZ0W2ldLl9idXR0b25PZmZzZXQgPSBhY3Rpb25zTGVmdFdpZHRoIC0gYnV0dG9uc0xlZnRbaV0ub2Zmc2V0TGVmdCAtIGJ1dHRvbnNMZWZ0W2ldLm9mZnNldFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uT2Zmc2V0ID0gYnV0dG9uc0xlZnRbaV0uX2J1dHRvbk9mZnNldDtcbiAgICAgICAgICAgICAgICAgICAgICAgICRidXR0b24gPSAkKGJ1dHRvbnNMZWZ0W2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvdmVyc3dpcGVMZWZ0QnV0dG9uLmxlbmd0aCA+IDAgJiYgJGJ1dHRvbi5oYXNDbGFzcygnc3dpcGVvdXQtb3ZlcnN3aXBlJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYnV0dG9uLmNzcyh7bGVmdDogKG92ZXJzd2lwZUxlZnQgPyBidXR0b25PZmZzZXQgOiAwKSArICdweCd9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3ZlcnN3aXBlTGVmdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYnV0dG9uLmFkZENsYXNzKCdzd2lwZW91dC1vdmVyc3dpcGUtYWN0aXZlJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYnV0dG9uLnJlbW92ZUNsYXNzKCdzd2lwZW91dC1vdmVyc3dpcGUtYWN0aXZlJyk7ICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1dHRvbnNMZWZ0Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYnV0dG9uLmNzcygnei1pbmRleCcsIGJ1dHRvbnNMZWZ0Lmxlbmd0aCAtIGkpOyBcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICRidXR0b24udHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHRyYW5zbGF0ZSArIGJ1dHRvbk9mZnNldCAqICgxIC0gTWF0aC5taW4ocHJvZ3Jlc3MsIDEpKSkgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN3aXBlT3V0Q29udGVudC50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyB0cmFuc2xhdGUgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoZSkge1xuICAgICAgICAgICAgICAgIGlmICghaXNUb3VjaGVkIHx8ICFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB2YXIgdGltZURpZmYgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpIC0gdG91Y2hTdGFydFRpbWU7XG4gICAgICAgICAgICAgICAgdmFyIGFjdGlvbiwgYWN0aW9uc1dpZHRoLCBhY3Rpb25zLCBidXR0b25zLCBpLCBub0ZvbGQ7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgbm9Gb2xkID0gZGlyZWN0aW9uID09PSAndG8tbGVmdCcgPyBub0ZvbGRSaWdodCA6IG5vRm9sZExlZnQ7XG4gICAgICAgICAgICAgICAgYWN0aW9ucyA9IGRpcmVjdGlvbiA9PT0gJ3RvLWxlZnQnID8gYWN0aW9uc1JpZ2h0IDogYWN0aW9uc0xlZnQ7XG4gICAgICAgICAgICAgICAgYWN0aW9uc1dpZHRoID0gZGlyZWN0aW9uID09PSAndG8tbGVmdCcgPyBhY3Rpb25zUmlnaHRXaWR0aCA6IGFjdGlvbnNMZWZ0V2lkdGg7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgdGltZURpZmYgPCAzMDAgJiYgKHRvdWNoZXNEaWZmIDwgLTEwICYmIGRpcmVjdGlvbiA9PT0gJ3RvLWxlZnQnIHx8IHRvdWNoZXNEaWZmID4gMTAgJiYgZGlyZWN0aW9uID09PSAndG8tcmlnaHQnKSB8fFxuICAgICAgICAgICAgICAgICAgICB0aW1lRGlmZiA+PSAzMDAgJiYgTWF0aC5hYnModHJhbnNsYXRlKSA+IGFjdGlvbnNXaWR0aCAvIDJcbiAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gJ29wZW4nO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gJ2Nsb3NlJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRpbWVEaWZmIDwgMzAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh0cmFuc2xhdGUpID09PSAwKSBhY3Rpb24gPSAnY2xvc2UnO1xuICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModHJhbnNsYXRlKSA9PT0gYWN0aW9uc1dpZHRoKSBhY3Rpb24gPSAnb3Blbic7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChhY3Rpb24gPT09ICdvcGVuJykge1xuICAgICAgICAgICAgICAgICAgICBhcHAuc3dpcGVvdXRPcGVuZWRFbCA9IHN3aXBlT3V0RWw7XG4gICAgICAgICAgICAgICAgICAgIHN3aXBlT3V0RWwudHJpZ2dlcignb3BlbicpO1xuICAgICAgICAgICAgICAgICAgICBzd2lwZU91dEVsLmFkZENsYXNzKCdzd2lwZW91dC1vcGVuZWQgdHJhbnNpdGlvbmluZycpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VHJhbnNsYXRlID0gZGlyZWN0aW9uID09PSAndG8tbGVmdCcgPyAtYWN0aW9uc1dpZHRoIDogYWN0aW9uc1dpZHRoO1xuICAgICAgICAgICAgICAgICAgICBzd2lwZU91dENvbnRlbnQudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgbmV3VHJhbnNsYXRlICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgYWN0aW9ucy5hZGRDbGFzcygnc3dpcGVvdXQtYWN0aW9ucy1vcGVuZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgYnV0dG9ucyA9IGRpcmVjdGlvbiA9PT0gJ3RvLWxlZnQnID8gYnV0dG9uc1JpZ2h0IDogYnV0dG9uc0xlZnQ7XG4gICAgICAgICAgICAgICAgICAgIGlmIChidXR0b25zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYnV0dG9ucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoYnV0dG9uc1tpXSkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgbmV3VHJhbnNsYXRlICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAob3ZlcnN3aXBlUmlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbnNSaWdodC5maW5kKCcuc3dpcGVvdXQtb3ZlcnN3aXBlJylbMF0uY2xpY2soKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAob3ZlcnN3aXBlTGVmdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uc0xlZnQuZmluZCgnLnN3aXBlb3V0LW92ZXJzd2lwZScpWzBdLmNsaWNrKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHN3aXBlT3V0RWwudHJpZ2dlcignY2xvc2UnKTtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnN3aXBlb3V0T3BlbmVkRWwgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgIHN3aXBlT3V0RWwuYWRkQ2xhc3MoJ3RyYW5zaXRpb25pbmcnKS5yZW1vdmVDbGFzcygnc3dpcGVvdXQtb3BlbmVkJyk7XG4gICAgICAgICAgICAgICAgICAgIHN3aXBlT3V0Q29udGVudC50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb25zLnJlbW92ZUNsYXNzKCdzd2lwZW91dC1hY3Rpb25zLW9wZW5lZCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgYnV0dG9uT2Zmc2V0O1xuICAgICAgICAgICAgICAgIGlmIChidXR0b25zTGVmdCAmJiBidXR0b25zTGVmdC5sZW5ndGggPiAwICYmIGJ1dHRvbnNMZWZ0ICE9PSBidXR0b25zKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBidXR0b25zTGVmdC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uT2Zmc2V0ID0gYnV0dG9uc0xlZnRbaV0uX2J1dHRvbk9mZnNldDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYnV0dG9uT2Zmc2V0ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbnNMZWZ0W2ldLl9idXR0b25PZmZzZXQgPSBhY3Rpb25zTGVmdFdpZHRoIC0gYnV0dG9uc0xlZnRbaV0ub2Zmc2V0TGVmdCAtIGJ1dHRvbnNMZWZ0W2ldLm9mZnNldFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgJChidXR0b25zTGVmdFtpXSkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKGJ1dHRvbk9mZnNldCkgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChidXR0b25zUmlnaHQgJiYgYnV0dG9uc1JpZ2h0Lmxlbmd0aCA+IDAgJiYgYnV0dG9uc1JpZ2h0ICE9PSBidXR0b25zKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBidXR0b25zUmlnaHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbk9mZnNldCA9IGJ1dHRvbnNSaWdodFtpXS5fYnV0dG9uT2Zmc2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBidXR0b25PZmZzZXQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uc1JpZ2h0W2ldLl9idXR0b25PZmZzZXQgPSBidXR0b25zUmlnaHRbaV0ub2Zmc2V0TGVmdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICQoYnV0dG9uc1JpZ2h0W2ldKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAoLWJ1dHRvbk9mZnNldCkgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN3aXBlT3V0Q29udGVudC50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcGVuZWQgJiYgYWN0aW9uID09PSAnb3BlbicgfHwgY2xvc2VkICYmIGFjdGlvbiA9PT0gJ2Nsb3NlJykgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICBzd2lwZU91dEVsLnRyaWdnZXIoYWN0aW9uID09PSAnb3BlbicgPyAnb3BlbmVkJyA6ICdjbG9zZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wZW5lZCAmJiBhY3Rpb24gPT09ICdjbG9zZScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhY3Rpb25zUmlnaHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbnNSaWdodC50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbnNMZWZ0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25zTGVmdC50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoc3dpcGVvdXRFbCkge1xuICAgICAgICAgICAgICAgICQoc3dpcGVvdXRFbCkub24oYXBwLnRvdWNoRXZlbnRzLnN0YXJ0LCBoYW5kbGVUb3VjaFN0YXJ0KTtcbiAgICAgICAgICAgICAgICAkKHN3aXBlb3V0RWwpLm9uKGFwcC50b3VjaEV2ZW50cy5tb3ZlLCBoYW5kbGVUb3VjaE1vdmUpO1xuICAgICAgICAgICAgICAgICQoc3dpcGVvdXRFbCkub24oYXBwLnRvdWNoRXZlbnRzLmVuZCwgaGFuZGxlVG91Y2hFbmQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgJChkb2N1bWVudCkub24oYXBwLnRvdWNoRXZlbnRzLnN0YXJ0LCAnLmxpc3QtYmxvY2sgbGkuc3dpcGVvdXQnLCBoYW5kbGVUb3VjaFN0YXJ0KTtcbiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vbihhcHAudG91Y2hFdmVudHMubW92ZSwgJy5saXN0LWJsb2NrIGxpLnN3aXBlb3V0JywgaGFuZGxlVG91Y2hNb3ZlKTtcbiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vbihhcHAudG91Y2hFdmVudHMuZW5kLCAnLmxpc3QtYmxvY2sgbGkuc3dpcGVvdXQnLCBoYW5kbGVUb3VjaEVuZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgIH07XG4gICAgICAgIGFwcC5zd2lwZW91dE9wZW4gPSBmdW5jdGlvbiAoZWwsIGRpciwgY2FsbGJhY2spIHtcbiAgICAgICAgICAgIGVsID0gJChlbCk7XG4gICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzFdID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZGlyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoZWwubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoZWwubGVuZ3RoID4gMSkgZWwgPSAkKGVsWzBdKTtcbiAgICAgICAgICAgIGlmICghZWwuaGFzQ2xhc3MoJ3N3aXBlb3V0JykgfHwgZWwuaGFzQ2xhc3MoJ3N3aXBlb3V0LW9wZW5lZCcpKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoIWRpcikge1xuICAgICAgICAgICAgICAgIGlmIChlbC5maW5kKCcuc3dpcGVvdXQtYWN0aW9ucy1yaWdodCcpLmxlbmd0aCA+IDApIGRpciA9ICdyaWdodCc7XG4gICAgICAgICAgICAgICAgZWxzZSBkaXIgPSAnbGVmdCc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgc3dpcGVPdXRBY3Rpb25zID0gZWwuZmluZCgnLnN3aXBlb3V0LWFjdGlvbnMtJyArIGRpcik7XG4gICAgICAgICAgICBpZiAoc3dpcGVPdXRBY3Rpb25zLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgdmFyIG5vRm9sZCA9IHN3aXBlT3V0QWN0aW9ucy5oYXNDbGFzcygnc3dpcGVvdXQtYWN0aW9ucy1uby1mb2xkJykgfHwgYXBwLnBhcmFtcy5zd2lwZW91dEFjdGlvbnNOb0ZvbGQ7XG4gICAgICAgICAgICBlbC50cmlnZ2VyKCdvcGVuJykuYWRkQ2xhc3MoJ3N3aXBlb3V0LW9wZW5lZCcpLnJlbW92ZUNsYXNzKCd0cmFuc2l0aW9uaW5nJyk7XG4gICAgICAgICAgICBzd2lwZU91dEFjdGlvbnMuYWRkQ2xhc3MoJ3N3aXBlb3V0LWFjdGlvbnMtb3BlbmVkJyk7XG4gICAgICAgICAgICB2YXIgYnV0dG9ucyA9IHN3aXBlT3V0QWN0aW9ucy5jaGlsZHJlbignYScpO1xuICAgICAgICAgICAgdmFyIHN3aXBlT3V0QWN0aW9uc1dpZHRoID0gc3dpcGVPdXRBY3Rpb25zLm91dGVyV2lkdGgoKTtcbiAgICAgICAgICAgIHZhciB0cmFuc2xhdGUgPSBkaXIgPT09ICdyaWdodCcgPyAtc3dpcGVPdXRBY3Rpb25zV2lkdGggOiBzd2lwZU91dEFjdGlvbnNXaWR0aDtcbiAgICAgICAgICAgIHZhciBpO1xuICAgICAgICAgICAgaWYgKGJ1dHRvbnMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBidXR0b25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkaXIgPT09ICdyaWdodCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoYnV0dG9uc1tpXSkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKC0gYnV0dG9uc1tpXS5vZmZzZXRMZWZ0KSArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKGJ1dHRvbnNbaV0pLmNzcygnei1pbmRleCcsIGJ1dHRvbnMubGVuZ3RoIC0gaSkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHN3aXBlT3V0QWN0aW9uc1dpZHRoIC0gYnV0dG9uc1tpXS5vZmZzZXRXaWR0aCAtIGJ1dHRvbnNbaV0ub2Zmc2V0TGVmdCkgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBjbGllbnRMZWZ0ID0gYnV0dG9uc1sxXS5jbGllbnRMZWZ0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWwuYWRkQ2xhc3MoJ3RyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBidXR0b25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgJChidXR0b25zW2ldKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAodHJhbnNsYXRlKSArICdweCwwLDApJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbC5maW5kKCcuc3dpcGVvdXQtY29udGVudCcpLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHRyYW5zbGF0ZSArICdweCwwLDApJykudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgZWwudHJpZ2dlcignb3BlbmVkJyk7XG4gICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjay5jYWxsKGVsWzBdKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgYXBwLnN3aXBlb3V0T3BlbmVkRWwgPSBlbDtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnN3aXBlb3V0Q2xvc2UgPSBmdW5jdGlvbiAoZWwsIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICBlbCA9ICQoZWwpO1xuICAgICAgICAgICAgaWYgKGVsLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKCFlbC5oYXNDbGFzcygnc3dpcGVvdXQtb3BlbmVkJykpIHJldHVybjtcbiAgICAgICAgICAgIHZhciBkaXIgPSBlbC5maW5kKCcuc3dpcGVvdXQtYWN0aW9ucy1vcGVuZWQnKS5oYXNDbGFzcygnc3dpcGVvdXQtYWN0aW9ucy1yaWdodCcpID8gJ3JpZ2h0JyA6ICdsZWZ0JztcbiAgICAgICAgICAgIHZhciBzd2lwZU91dEFjdGlvbnMgPSBlbC5maW5kKCcuc3dpcGVvdXQtYWN0aW9ucy1vcGVuZWQnKS5yZW1vdmVDbGFzcygnc3dpcGVvdXQtYWN0aW9ucy1vcGVuZWQnKTtcbiAgICAgICAgICAgIHZhciBub0ZvbGQgPSBzd2lwZU91dEFjdGlvbnMuaGFzQ2xhc3MoJ3N3aXBlb3V0LWFjdGlvbnMtbm8tZm9sZCcpIHx8IGFwcC5wYXJhbXMuc3dpcGVvdXRBY3Rpb25zTm9Gb2xkO1xuICAgICAgICAgICAgdmFyIGJ1dHRvbnMgPSBzd2lwZU91dEFjdGlvbnMuY2hpbGRyZW4oJ2EnKTtcbiAgICAgICAgICAgIHZhciBzd2lwZU91dEFjdGlvbnNXaWR0aCA9IHN3aXBlT3V0QWN0aW9ucy5vdXRlcldpZHRoKCk7XG4gICAgICAgICAgICBhcHAuYWxsb3dTd2lwZW91dCA9IGZhbHNlO1xuICAgICAgICAgICAgZWwudHJpZ2dlcignY2xvc2UnKTtcbiAgICAgICAgICAgIGVsLnJlbW92ZUNsYXNzKCdzd2lwZW91dC1vcGVuZWQnKS5hZGRDbGFzcygndHJhbnNpdGlvbmluZycpO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBjbG9zZVRPO1xuICAgICAgICAgICAgZnVuY3Rpb24gb25Td2lwZW91dENsb3NlKCkge1xuICAgICAgICAgICAgICAgIGFwcC5hbGxvd1N3aXBlb3V0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAoZWwuaGFzQ2xhc3MoJ3N3aXBlb3V0LW9wZW5lZCcpKSByZXR1cm47XG4gICAgICAgICAgICAgICAgZWwucmVtb3ZlQ2xhc3MoJ3RyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgICAgICAgICBidXR0b25zLnRyYW5zZm9ybSgnJyk7XG4gICAgICAgICAgICAgICAgZWwudHJpZ2dlcignY2xvc2VkJyk7XG4gICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjay5jYWxsKGVsWzBdKTtcbiAgICAgICAgICAgICAgICBpZiAoY2xvc2VUTykgY2xlYXJUaW1lb3V0KGNsb3NlVE8pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWwuZmluZCgnLnN3aXBlb3V0LWNvbnRlbnQnKS50cmFuc2Zvcm0oJycpLnRyYW5zaXRpb25FbmQob25Td2lwZW91dENsb3NlKTtcbiAgICAgICAgICAgIGNsb3NlVE8gPSBzZXRUaW1lb3V0KG9uU3dpcGVvdXRDbG9zZSwgNTAwKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBidXR0b25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKGRpciA9PT0gJ3JpZ2h0Jykge1xuICAgICAgICAgICAgICAgICAgICAkKGJ1dHRvbnNbaV0pLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArICgtYnV0dG9uc1tpXS5vZmZzZXRMZWZ0KSArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAkKGJ1dHRvbnNbaV0pLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIChzd2lwZU91dEFjdGlvbnNXaWR0aCAtIGJ1dHRvbnNbaV0ub2Zmc2V0V2lkdGggLSBidXR0b25zW2ldLm9mZnNldExlZnQpICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgJChidXR0b25zW2ldKS5jc3Moe2xlZnQ6MCArICdweCd9KS5yZW1vdmVDbGFzcygnc3dpcGVvdXQtb3ZlcnN3aXBlLWFjdGl2ZScpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFwcC5zd2lwZW91dE9wZW5lZEVsICYmIGFwcC5zd2lwZW91dE9wZW5lZEVsWzBdID09PSBlbFswXSkgYXBwLnN3aXBlb3V0T3BlbmVkRWwgPSB1bmRlZmluZWQ7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5zd2lwZW91dERlbGV0ZSA9IGZ1bmN0aW9uIChlbCwgY2FsbGJhY2spIHtcbiAgICAgICAgICAgIGVsID0gJChlbCk7XG4gICAgICAgICAgICBpZiAoZWwubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoZWwubGVuZ3RoID4gMSkgZWwgPSAkKGVsWzBdKTtcbiAgICAgICAgICAgIGFwcC5zd2lwZW91dE9wZW5lZEVsID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgZWwudHJpZ2dlcignZGVsZXRlJyk7XG4gICAgICAgICAgICBlbC5jc3Moe2hlaWdodDogZWwub3V0ZXJIZWlnaHQoKSArICdweCd9KTtcbiAgICAgICAgICAgIHZhciBjbGllbnRMZWZ0ID0gZWxbMF0uY2xpZW50TGVmdDtcbiAgICAgICAgICAgIGVsLmNzcyh7aGVpZ2h0OiAwICsgJ3B4J30pLmFkZENsYXNzKCdkZWxldGluZyB0cmFuc2l0aW9uaW5nJykudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgZWwudHJpZ2dlcignZGVsZXRlZCcpO1xuICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2suY2FsbChlbFswXSk7XG4gICAgICAgICAgICAgICAgaWYgKGVsLnBhcmVudHMoJy52aXJ0dWFsLWxpc3QnKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2aXJ0dWFsTGlzdCA9IGVsLnBhcmVudHMoJy52aXJ0dWFsLWxpc3QnKVswXS5mN1ZpcnR1YWxMaXN0O1xuICAgICAgICAgICAgICAgICAgICB2YXIgdmlydHVhbEluZGV4ID0gZWxbMF0uZjdWaXJ0dWFsTGlzdEluZGV4O1xuICAgICAgICAgICAgICAgICAgICBpZiAodmlydHVhbExpc3QgJiYgdHlwZW9mIHZpcnR1YWxJbmRleCAhPT0gJ3VuZGVmaW5lZCcpIHZpcnR1YWxMaXN0LmRlbGV0ZUl0ZW0odmlydHVhbEluZGV4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGVsLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZSA9ICctMTAwJSc7XG4gICAgICAgICAgICBlbC5maW5kKCcuc3dpcGVvdXQtY29udGVudCcpLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHRyYW5zbGF0ZSArICcsMCwwKScpO1xuICAgICAgICB9O1xuICAgICAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgU29ydGFibGUgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5zb3J0YWJsZVRvZ2dsZSA9IGZ1bmN0aW9uIChzb3J0YWJsZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgc29ydGFibGVDb250YWluZXIgPSAkKHNvcnRhYmxlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIGlmIChzb3J0YWJsZUNvbnRhaW5lci5sZW5ndGggPT09IDApIHNvcnRhYmxlQ29udGFpbmVyID0gJCgnLmxpc3QtYmxvY2suc29ydGFibGUnKTtcbiAgICAgICAgICAgIHNvcnRhYmxlQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCdzb3J0YWJsZS1vcGVuZWQnKTtcbiAgICAgICAgICAgIGlmIChzb3J0YWJsZUNvbnRhaW5lci5oYXNDbGFzcygnc29ydGFibGUtb3BlbmVkJykpIHtcbiAgICAgICAgICAgICAgICBzb3J0YWJsZUNvbnRhaW5lci50cmlnZ2VyKCdvcGVuJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzb3J0YWJsZUNvbnRhaW5lci50cmlnZ2VyKCdjbG9zZScpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHNvcnRhYmxlQ29udGFpbmVyO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuc29ydGFibGVPcGVuID0gZnVuY3Rpb24gKHNvcnRhYmxlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBzb3J0YWJsZUNvbnRhaW5lciA9ICQoc29ydGFibGVDb250YWluZXIpO1xuICAgICAgICAgICAgaWYgKHNvcnRhYmxlQ29udGFpbmVyLmxlbmd0aCA9PT0gMCkgc29ydGFibGVDb250YWluZXIgPSAkKCcubGlzdC1ibG9jay5zb3J0YWJsZScpO1xuICAgICAgICAgICAgc29ydGFibGVDb250YWluZXIuYWRkQ2xhc3MoJ3NvcnRhYmxlLW9wZW5lZCcpO1xuICAgICAgICAgICAgc29ydGFibGVDb250YWluZXIudHJpZ2dlcignb3BlbicpO1xuICAgICAgICAgICAgcmV0dXJuIHNvcnRhYmxlQ29udGFpbmVyO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuc29ydGFibGVDbG9zZSA9IGZ1bmN0aW9uIChzb3J0YWJsZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgc29ydGFibGVDb250YWluZXIgPSAkKHNvcnRhYmxlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIGlmIChzb3J0YWJsZUNvbnRhaW5lci5sZW5ndGggPT09IDApIHNvcnRhYmxlQ29udGFpbmVyID0gJCgnLmxpc3QtYmxvY2suc29ydGFibGUnKTtcbiAgICAgICAgICAgIHNvcnRhYmxlQ29udGFpbmVyLnJlbW92ZUNsYXNzKCdzb3J0YWJsZS1vcGVuZWQnKTtcbiAgICAgICAgICAgIHNvcnRhYmxlQ29udGFpbmVyLnRyaWdnZXIoJ2Nsb3NlJyk7XG4gICAgICAgICAgICByZXR1cm4gc29ydGFibGVDb250YWluZXI7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5pbml0U29ydGFibGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgaXNUb3VjaGVkLCBpc01vdmVkLCB0b3VjaFN0YXJ0WSwgdG91Y2hlc0RpZmYsIHNvcnRpbmdFbCwgc29ydGluZ0VsSGVpZ2h0LCBzb3J0aW5nSXRlbXMsIG1pblRvcCwgbWF4VG9wLCBpbnNlcnRBZnRlciwgaW5zZXJ0QmVmb3JlLCBzb3J0YWJsZUNvbnRhaW5lcjtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydChlKSB7XG4gICAgICAgICAgICAgICAgaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgdG91Y2hTdGFydFkgPSBlLnR5cGUgPT09ICd0b3VjaHN0YXJ0JyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgICAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi9cbiAgICAgICAgICAgICAgICBzb3J0aW5nRWwgPSAkKHRoaXMpLnBhcmVudCgpO1xuICAgICAgICAgICAgICAgIHNvcnRpbmdJdGVtcyA9IHNvcnRpbmdFbC5wYXJlbnQoKS5maW5kKCdsaScpO1xuICAgICAgICAgICAgICAgIHNvcnRhYmxlQ29udGFpbmVyID0gc29ydGluZ0VsLnBhcmVudHMoJy5zb3J0YWJsZScpO1xuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICBhcHAuYWxsb3dQYW5lbE9wZW4gPSBhcHAuYWxsb3dTd2lwZW91dCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWlzVG91Y2hlZCB8fCAhc29ydGluZ0VsKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2VYID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGUucGFnZVg7XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2VZID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgICAgICAgICAgaWYgKCFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHNvcnRpbmdFbC5hZGRDbGFzcygnc29ydGluZycpO1xuICAgICAgICAgICAgICAgICAgICBzb3J0YWJsZUNvbnRhaW5lci5hZGRDbGFzcygnc29ydGFibGUtc29ydGluZycpO1xuICAgICAgICAgICAgICAgICAgICBtaW5Ub3AgPSBzb3J0aW5nRWxbMF0ub2Zmc2V0VG9wO1xuICAgICAgICAgICAgICAgICAgICBtYXhUb3AgPSBzb3J0aW5nRWwucGFyZW50KCkuaGVpZ2h0KCkgLSBzb3J0aW5nRWxbMF0ub2Zmc2V0VG9wIC0gc29ydGluZ0VsLmhlaWdodCgpO1xuICAgICAgICAgICAgICAgICAgICBzb3J0aW5nRWxIZWlnaHQgPSBzb3J0aW5nRWxbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpc01vdmVkID0gdHJ1ZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGUuZjdQcmV2ZW50UGFuZWxTd2lwZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgdG91Y2hlc0RpZmYgPSBwYWdlWSAtIHRvdWNoU3RhcnRZO1xuICAgICAgICAgICAgICAgIHZhciB0cmFuc2xhdGUgPSB0b3VjaGVzRGlmZjtcbiAgICAgICAgICAgICAgICBpZiAodHJhbnNsYXRlIDwgLW1pblRvcCkgdHJhbnNsYXRlID0gLW1pblRvcDtcbiAgICAgICAgICAgICAgICBpZiAodHJhbnNsYXRlID4gbWF4VG9wKSB0cmFuc2xhdGUgPSBtYXhUb3A7XG4gICAgICAgICAgICAgICAgc29ydGluZ0VsLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwnICsgdHJhbnNsYXRlICsgJ3B4LDApJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGluc2VydEJlZm9yZSA9IGluc2VydEFmdGVyID0gdW5kZWZpbmVkO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBzb3J0aW5nSXRlbXMuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50RWwgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudEVsWzBdID09PSBzb3J0aW5nRWxbMF0pIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRFbE9mZnNldCA9IGN1cnJlbnRFbFswXS5vZmZzZXRUb3A7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjdXJyZW50RWxIZWlnaHQgPSBjdXJyZW50RWwuaGVpZ2h0KCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzb3J0aW5nRWxPZmZzZXQgPSBzb3J0aW5nRWxbMF0ub2Zmc2V0VG9wICsgdHJhbnNsYXRlO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKChzb3J0aW5nRWxPZmZzZXQgPj0gY3VycmVudEVsT2Zmc2V0IC0gY3VycmVudEVsSGVpZ2h0IC8gMikgJiYgc29ydGluZ0VsLmluZGV4KCkgPCBjdXJyZW50RWwuaW5kZXgoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEVsLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwgJysoLXNvcnRpbmdFbEhlaWdodCkrJ3B4LDApJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbnNlcnRBZnRlciA9IGN1cnJlbnRFbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydEJlZm9yZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICgoc29ydGluZ0VsT2Zmc2V0IDw9IGN1cnJlbnRFbE9mZnNldCArIGN1cnJlbnRFbEhlaWdodCAvIDIpICYmIHNvcnRpbmdFbC5pbmRleCgpID4gY3VycmVudEVsLmluZGV4KCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRFbC50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDAsICcrKHNvcnRpbmdFbEhlaWdodCkrJ3B4LDApJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbnNlcnRBZnRlciA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaW5zZXJ0QmVmb3JlKSBpbnNlcnRCZWZvcmUgPSBjdXJyZW50RWw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwgMCUsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoZSkge1xuICAgICAgICAgICAgICAgIGFwcC5hbGxvd1BhbmVsT3BlbiA9IGFwcC5hbGxvd1N3aXBlb3V0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAoIWlzVG91Y2hlZCB8fCAhaXNNb3ZlZCkge1xuICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICBzb3J0aW5nSXRlbXMudHJhbnNmb3JtKCcnKTtcbiAgICAgICAgICAgICAgICBzb3J0aW5nRWwucmVtb3ZlQ2xhc3MoJ3NvcnRpbmcnKTtcbiAgICAgICAgICAgICAgICBzb3J0YWJsZUNvbnRhaW5lci5yZW1vdmVDbGFzcygnc29ydGFibGUtc29ydGluZycpO1xuICAgICAgICAgICAgICAgIHZhciB2aXJ0dWFsTGlzdCwgb2xkSW5kZXgsIG5ld0luZGV4O1xuICAgICAgICAgICAgICAgIGlmIChpbnNlcnRBZnRlcikge1xuICAgICAgICAgICAgICAgICAgICBzb3J0aW5nRWwuaW5zZXJ0QWZ0ZXIoaW5zZXJ0QWZ0ZXIpO1xuICAgICAgICAgICAgICAgICAgICBzb3J0aW5nRWwudHJpZ2dlcignc29ydCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaW5zZXJ0QmVmb3JlKSB7XG4gICAgICAgICAgICAgICAgICAgIHNvcnRpbmdFbC5pbnNlcnRCZWZvcmUoaW5zZXJ0QmVmb3JlKTtcbiAgICAgICAgICAgICAgICAgICAgc29ydGluZ0VsLnRyaWdnZXIoJ3NvcnQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKChpbnNlcnRBZnRlciB8fCBpbnNlcnRCZWZvcmUpICYmIHNvcnRhYmxlQ29udGFpbmVyLmhhc0NsYXNzKCd2aXJ0dWFsLWxpc3QnKSkge1xuICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsTGlzdCA9IHNvcnRhYmxlQ29udGFpbmVyWzBdLmY3VmlydHVhbExpc3Q7XG4gICAgICAgICAgICAgICAgICAgIG9sZEluZGV4ID0gc29ydGluZ0VsWzBdLmY3VmlydHVhbExpc3RJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgbmV3SW5kZXggPSBpbnNlcnRCZWZvcmUgPyBpbnNlcnRCZWZvcmVbMF0uZjdWaXJ0dWFsTGlzdEluZGV4IDogaW5zZXJ0QWZ0ZXJbMF0uZjdWaXJ0dWFsTGlzdEluZGV4O1xuICAgICAgICAgICAgICAgICAgICBpZiAodmlydHVhbExpc3QpIHZpcnR1YWxMaXN0Lm1vdmVJdGVtKG9sZEluZGV4LCBuZXdJbmRleCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGluc2VydEFmdGVyID0gaW5zZXJ0QmVmb3JlID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKGFwcC50b3VjaEV2ZW50cy5zdGFydCwgJy5saXN0LWJsb2NrLnNvcnRhYmxlIC5zb3J0YWJsZS1oYW5kbGVyJywgaGFuZGxlVG91Y2hTdGFydCk7XG4gICAgICAgICAgICBpZiAoYXBwLnN1cHBvcnQudG91Y2gpIHtcbiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vbihhcHAudG91Y2hFdmVudHMubW92ZSwgJy5saXN0LWJsb2NrLnNvcnRhYmxlIC5zb3J0YWJsZS1oYW5kbGVyJywgaGFuZGxlVG91Y2hNb3ZlKTtcbiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vbihhcHAudG91Y2hFdmVudHMuZW5kLCAnLmxpc3QtYmxvY2suc29ydGFibGUgLnNvcnRhYmxlLWhhbmRsZXInLCBoYW5kbGVUb3VjaEVuZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vbihhcHAudG91Y2hFdmVudHMubW92ZSwgaGFuZGxlVG91Y2hNb3ZlKTtcbiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vbihhcHAudG91Y2hFdmVudHMuZW5kLCBoYW5kbGVUb3VjaEVuZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBTbWFydCBTZWxlY3QgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5pbml0U21hcnRTZWxlY3RzID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgdmFyIHNlbGVjdHM7XG4gICAgICAgICAgICBpZiAocGFnZUNvbnRhaW5lci5pcygnLnNtYXJ0LXNlbGVjdCcpKSB7XG4gICAgICAgICAgICAgICAgc2VsZWN0cyA9IHBhZ2VDb250YWluZXI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzZWxlY3RzID0gcGFnZUNvbnRhaW5lci5maW5kKCcuc21hcnQtc2VsZWN0Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoc2VsZWN0cy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICBzZWxlY3RzLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBzbWFydFNlbGVjdCA9ICQodGhpcyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciAkc2VsZWN0ID0gc21hcnRTZWxlY3QuZmluZCgnc2VsZWN0Jyk7XG4gICAgICAgICAgICAgICAgaWYgKCRzZWxlY3QubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBzZWxlY3QgPSAkc2VsZWN0WzBdO1xuICAgICAgICAgICAgICAgIGlmIChzZWxlY3QubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciB2YWx1ZVRleHQgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNlbGVjdC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0W2ldLnNlbGVjdGVkKSB2YWx1ZVRleHQucHVzaChzZWxlY3RbaV0udGV4dENvbnRlbnQudHJpbSgpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBpdGVtQWZ0ZXIgPSBzbWFydFNlbGVjdC5maW5kKCcuaXRlbS1hZnRlcicpO1xuICAgICAgICAgICAgICAgIGlmIChpdGVtQWZ0ZXIubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHNtYXJ0U2VsZWN0LmZpbmQoJy5pdGVtLWlubmVyJykuYXBwZW5kKCc8ZGl2IGNsYXNzPVwiaXRlbS1hZnRlclwiPicgKyB2YWx1ZVRleHQuam9pbignLCAnKSArICc8L2Rpdj4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzZWxlY3RlZFRleHQgPSBpdGVtQWZ0ZXIudGV4dCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbUFmdGVyLmhhc0NsYXNzKCdzbWFydC1zZWxlY3QtdmFsdWUnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlbGVjdC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdFtpXS5zZWxlY3RlZCA9IHNlbGVjdFtpXS50ZXh0Q29udGVudC50cmltKCkgPT09IHNlbGVjdGVkVGV4dC50cmltKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtQWZ0ZXIudGV4dCh2YWx1ZVRleHQuam9pbignLCAnKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICB9O1xuICAgICAgICBhcHAuc21hcnRTZWxlY3RBZGRPcHRpb24gPSBmdW5jdGlvbiAoc2VsZWN0LCBvcHRpb24sIGluZGV4KSB7XG4gICAgICAgICAgICBzZWxlY3QgPSAkKHNlbGVjdCk7XG4gICAgICAgICAgICB2YXIgc21hcnRTZWxlY3QgPSBzZWxlY3QucGFyZW50cygnLnNtYXJ0LXNlbGVjdCcpO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBzZWxlY3QuYXBwZW5kKG9wdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAkKG9wdGlvbikuaW5zZXJ0QmVmb3JlKHNlbGVjdC5maW5kKCdvcHRpb24nKS5lcShpbmRleCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXBwLmluaXRTbWFydFNlbGVjdHMoc21hcnRTZWxlY3QpO1xuICAgICAgICAgICAgdmFyIHNlbGVjdE5hbWUgPSBzbWFydFNlbGVjdC5maW5kKCdzZWxlY3QnKS5hdHRyKCduYW1lJyk7XG4gICAgICAgICAgICB2YXIgb3BlbmVkID0gJCgnLnBhZ2Uuc21hcnQtc2VsZWN0LXBhZ2VbZGF0YS1zZWxlY3QtbmFtZT1cIicgKyBzZWxlY3ROYW1lICsgJ1wiXScpLmxlbmd0aCA+IDA7XG4gICAgICAgICAgICBpZiAob3BlbmVkKSB7XG4gICAgICAgICAgICAgICAgYXBwLnNtYXJ0U2VsZWN0T3BlbihzbWFydFNlbGVjdCwgdHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5zbWFydFNlbGVjdE9wZW4gPSBmdW5jdGlvbiAoc21hcnRTZWxlY3QsIHJlTGF5b3V0KSB7XG4gICAgICAgICAgICBzbWFydFNlbGVjdCA9ICQoc21hcnRTZWxlY3QpO1xuICAgICAgICAgICAgaWYgKHNtYXJ0U2VsZWN0Lmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEZpbmQgcmVsYXRlZCB2aWV3XG4gICAgICAgICAgICB2YXIgdmlldyA9IHNtYXJ0U2VsZWN0LnBhcmVudHMoJy4nICsgYXBwLnBhcmFtcy52aWV3Q2xhc3MpO1xuICAgICAgICAgICAgaWYgKHZpZXcubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICB2aWV3ID0gdmlld1swXS5mN1ZpZXc7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUGFyYW1ldGVyc1xuICAgICAgICAgICAgdmFyIG9wZW5JbiA9IHNtYXJ0U2VsZWN0LmF0dHIoJ2RhdGEtb3Blbi1pbicpIHx8IGFwcC5wYXJhbXMuc21hcnRTZWxlY3RPcGVuSW47XG4gICAgICAgICAgICBpZiAob3BlbkluID09PSAncG9wdXAnKSB7XG4gICAgICAgICAgICAgICAgaWYgKCQoJy5wb3B1cC5zbWFydC1zZWxlY3QtcG9wdXAnKS5sZW5ndGggPiAwKSByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChvcGVuSW4gPT09ICdwaWNrZXInKSB7XG4gICAgICAgICAgICAgICAgaWYgKCQoJy5waWNrZXItbW9kYWwubW9kYWwtaW4nKS5sZW5ndGggPiAwICYmICFyZUxheW91dCl7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzbWFydFNlbGVjdFswXS5mN1NtYXJ0U2VsZWN0UGlja2VyICE9PSAkKCcucGlja2VyLW1vZGFsLm1vZGFsLWluOm5vdCgubW9kYWwtb3V0KScpWzBdKSBhcHAuY2xvc2VNb2RhbCgkKCcucGlja2VyLW1vZGFsLm1vZGFsLWluOm5vdCgubW9kYWwtb3V0KScpKTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKCF2aWV3KSByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHNtYXJ0U2VsZWN0RGF0YSA9IHNtYXJ0U2VsZWN0LmRhdGFzZXQoKTtcbiAgICAgICAgICAgIHZhciBwYWdlVGl0bGUgPSBzbWFydFNlbGVjdERhdGEucGFnZVRpdGxlIHx8IHNtYXJ0U2VsZWN0LmZpbmQoJy5pdGVtLXRpdGxlJykudGV4dCgpO1xuICAgICAgICAgICAgdmFyIGJhY2tUZXh0ID0gc21hcnRTZWxlY3REYXRhLmJhY2tUZXh0IHx8IGFwcC5wYXJhbXMuc21hcnRTZWxlY3RCYWNrVGV4dDtcbiAgICAgICAgICAgIHZhciBjbG9zZVRleHQ7XG4gICAgICAgICAgICBpZiAob3BlbkluID09PSAncGlja2VyJykge1xuICAgICAgICAgICAgICAgIGNsb3NlVGV4dCA9IHNtYXJ0U2VsZWN0RGF0YS5waWNrZXJDbG9zZVRleHQgfHwgc21hcnRTZWxlY3REYXRhLmJhY2tUZXh0IHx8IGFwcC5wYXJhbXMuc21hcnRTZWxlY3RQaWNrZXJDbG9zZVRleHQgOyAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY2xvc2VUZXh0ID0gc21hcnRTZWxlY3REYXRhLnBvcHVwQ2xvc2VUZXh0IHx8IHNtYXJ0U2VsZWN0RGF0YS5iYWNrVGV4dCB8fCBhcHAucGFyYW1zLnNtYXJ0U2VsZWN0UG9wdXBDbG9zZVRleHQgOyAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIGJhY2tPblNlbGVjdCA9IHNtYXJ0U2VsZWN0RGF0YS5iYWNrT25TZWxlY3QgIT09IHVuZGVmaW5lZCA/IHNtYXJ0U2VsZWN0RGF0YS5iYWNrT25TZWxlY3QgOiBhcHAucGFyYW1zLnNtYXJ0U2VsZWN0QmFja09uU2VsZWN0O1xuICAgICAgICAgICAgdmFyIGZvcm1UaGVtZSA9IHNtYXJ0U2VsZWN0RGF0YS5mb3JtVGhlbWUgfHwgYXBwLnBhcmFtcy5zbWFydFNlbGVjdEZvcm1UaGVtZTtcbiAgICAgICAgICAgIHZhciBuYXZiYXJUaGVtZSA9IHNtYXJ0U2VsZWN0RGF0YS5uYXZiYXJUaGVtZSB8fCBhcHAucGFyYW1zLnNtYXJ0U2VsZWN0TmF2YmFyVGhlbWU7XG4gICAgICAgICAgICB2YXIgdG9vbGJhclRoZW1lID0gc21hcnRTZWxlY3REYXRhLnRvb2xiYXJUaGVtZSB8fCBhcHAucGFyYW1zLnNtYXJ0U2VsZWN0VG9vbGJhclRoZW1lO1xuICAgICAgICAgICAgdmFyIHZpcnR1YWxMaXN0ID0gc21hcnRTZWxlY3REYXRhLnZpcnR1YWxMaXN0O1xuICAgICAgICAgICAgdmFyIHZpcnR1YWxMaXN0SGVpZ2h0ID0gc21hcnRTZWxlY3REYXRhLnZpcnR1YWxMaXN0SGVpZ2h0O1xuICAgICAgICAgICAgdmFyIG1hdGVyaWFsID0gYXBwLnBhcmFtcy5tYXRlcmlhbDtcbiAgICAgICAgICAgIHZhciBwaWNrZXJIZWlnaHQgPSBzbWFydFNlbGVjdERhdGEucGlja2VySGVpZ2h0IHx8IGFwcC5wYXJhbXMuc21hcnRTZWxlY3RQaWNrZXJIZWlnaHQ7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ29sbGVjdCBhbGwgb3B0aW9ucy92YWx1ZXNcbiAgICAgICAgICAgIHZhciBzZWxlY3QgPSBzbWFydFNlbGVjdC5maW5kKCdzZWxlY3QnKVswXTtcbiAgICAgICAgICAgIHZhciAkc2VsZWN0ID0gJChzZWxlY3QpO1xuICAgICAgICAgICAgdmFyICRzZWxlY3REYXRhID0gJHNlbGVjdC5kYXRhc2V0KCk7XG4gICAgICAgICAgICBpZiAoc2VsZWN0LmRpc2FibGVkIHx8IHNtYXJ0U2VsZWN0Lmhhc0NsYXNzKCdkaXNhYmxlZCcpIHx8ICRzZWxlY3QuaGFzQ2xhc3MoJ2Rpc2FibGVkJykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgdmFsdWVzID0gW107XG4gICAgICAgICAgICB2YXIgaWQgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgdmFyIGlucHV0VHlwZSA9IHNlbGVjdC5tdWx0aXBsZSA/ICdjaGVja2JveCcgOiAncmFkaW8nO1xuICAgICAgICAgICAgdmFyIGlucHV0TmFtZSA9IGlucHV0VHlwZSArICctJyArIGlkO1xuICAgICAgICAgICAgdmFyIG1heExlbmd0aCA9ICRzZWxlY3QuYXR0cignbWF4bGVuZ3RoJyk7XG4gICAgICAgICAgICB2YXIgc2VsZWN0TmFtZSA9IHNlbGVjdC5uYW1lO1xuICAgICAgICAgICAgdmFyIG9wdGlvbiwgb3B0aW9uSGFzTWVkaWEsIG9wdGlvbkltYWdlLCBvcHRpb25JY29uLCBvcHRpb25Hcm91cCwgb3B0aW9uR3JvdXBMYWJlbCwgb3B0aW9uUHJldmlvdXNHcm91cCwgb3B0aW9uSXNMYWJlbCwgcHJldmlvdXNHcm91cCwgb3B0aW9uQ29sb3IsIG9wdGlvbkNsYXNzTmFtZSwgb3B0aW9uRGF0YTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VsZWN0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgb3B0aW9uID0gJChzZWxlY3RbaV0pO1xuICAgICAgICAgICAgICAgIG9wdGlvbkRhdGEgPSBvcHRpb24uZGF0YXNldCgpO1xuICAgICAgICAgICAgICAgIG9wdGlvbkltYWdlID0gb3B0aW9uRGF0YS5vcHRpb25JbWFnZSB8fCAkc2VsZWN0RGF0YS5vcHRpb25JbWFnZSB8fCBzbWFydFNlbGVjdERhdGEub3B0aW9uSW1hZ2U7XG4gICAgICAgICAgICAgICAgb3B0aW9uSWNvbiA9IG9wdGlvbkRhdGEub3B0aW9uSWNvbiB8fCAkc2VsZWN0RGF0YS5vcHRpb25JY29uIHx8IHNtYXJ0U2VsZWN0RGF0YS5vcHRpb25JY29uO1xuICAgICAgICAgICAgICAgIG9wdGlvbkhhc01lZGlhID0gb3B0aW9uSW1hZ2UgfHwgb3B0aW9uSWNvbiB8fCBpbnB1dFR5cGUgPT09ICdjaGVja2JveCc7XG4gICAgICAgICAgICAgICAgaWYgKG1hdGVyaWFsKSBvcHRpb25IYXNNZWRpYSA9IG9wdGlvbkltYWdlIHx8IG9wdGlvbkljb247XG4gICAgICAgICAgICAgICAgb3B0aW9uQ29sb3IgPSBvcHRpb25EYXRhLm9wdGlvbkNvbG9yO1xuICAgICAgICAgICAgICAgIG9wdGlvbkNsYXNzTmFtZSA9IG9wdGlvbkRhdGEub3B0aW9uQ2xhc3M7XG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvblswXS5kaXNhYmxlZCkgb3B0aW9uQ2xhc3NOYW1lICs9ICcgZGlzYWJsZWQnO1xuICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwID0gb3B0aW9uLnBhcmVudCgnb3B0Z3JvdXAnKVswXTtcbiAgICAgICAgICAgICAgICBvcHRpb25Hcm91cExhYmVsID0gb3B0aW9uR3JvdXAgJiYgb3B0aW9uR3JvdXAubGFiZWw7XG4gICAgICAgICAgICAgICAgb3B0aW9uSXNMYWJlbCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChvcHRpb25Hcm91cCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uR3JvdXAgIT09IHByZXZpb3VzR3JvdXApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbklzTGFiZWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNHcm91cCA9IG9wdGlvbkdyb3VwO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwTGFiZWw6IG9wdGlvbkdyb3VwTGFiZWwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNMYWJlbDogb3B0aW9uSXNMYWJlbFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFsdWVzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogb3B0aW9uWzBdLnZhbHVlLFxuICAgICAgICAgICAgICAgICAgICB0ZXh0OiBvcHRpb25bMF0udGV4dENvbnRlbnQudHJpbSgpLFxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZDogb3B0aW9uWzBdLnNlbGVjdGVkLFxuICAgICAgICAgICAgICAgICAgICBncm91cDogb3B0aW9uR3JvdXAsXG4gICAgICAgICAgICAgICAgICAgIGdyb3VwTGFiZWw6IG9wdGlvbkdyb3VwTGFiZWwsXG4gICAgICAgICAgICAgICAgICAgIGltYWdlOiBvcHRpb25JbWFnZSxcbiAgICAgICAgICAgICAgICAgICAgaWNvbjogb3B0aW9uSWNvbixcbiAgICAgICAgICAgICAgICAgICAgY29sb3I6IG9wdGlvbkNvbG9yLFxuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6IG9wdGlvbkNsYXNzTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ6IG9wdGlvblswXS5kaXNhYmxlZCxcbiAgICAgICAgICAgICAgICAgICAgaW5wdXRUeXBlOiBpbnB1dFR5cGUsXG4gICAgICAgICAgICAgICAgICAgIGlkOiBpZCxcbiAgICAgICAgICAgICAgICAgICAgaGFzTWVkaWE6IG9wdGlvbkhhc01lZGlhLFxuICAgICAgICAgICAgICAgICAgICBjaGVja2JveDogaW5wdXRUeXBlID09PSAnY2hlY2tib3gnLFxuICAgICAgICAgICAgICAgICAgICBpbnB1dE5hbWU6IGlucHV0TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgbWF0ZXJpYWw6IGFwcC5wYXJhbXMubWF0ZXJpYWxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSXRlbSB0ZW1wbGF0ZS9IVE1MXG4gICAgICAgICAgICBpZiAoIWFwcC5fY29tcGlsZWRUZW1wbGF0ZXMuc21hcnRTZWxlY3RJdGVtKSB7XG4gICAgICAgICAgICAgICAgYXBwLl9jb21waWxlZFRlbXBsYXRlcy5zbWFydFNlbGVjdEl0ZW0gPSB0Ny5jb21waWxlKGFwcC5wYXJhbXMuc21hcnRTZWxlY3RJdGVtVGVtcGxhdGUgfHwgXG4gICAgICAgICAgICAgICAgICAgICd7eyNpZiBpc0xhYmVsfX0nICtcbiAgICAgICAgICAgICAgICAgICAgJzxsaSBjbGFzcz1cIml0ZW0tZGl2aWRlclwiPnt7Z3JvdXBMYWJlbH19PC9saT4nICtcbiAgICAgICAgICAgICAgICAgICAgJ3t7ZWxzZX19JyArXG4gICAgICAgICAgICAgICAgICAgICc8bGl7eyNpZiBjbGFzc05hbWV9fSBjbGFzcz1cInt7Y2xhc3NOYW1lfX1cInt7L2lmfX0+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGxhYmVsIGNsYXNzPVwibGFiZWwte3tpbnB1dFR5cGV9fSBpdGVtLWNvbnRlbnRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGlucHV0IHR5cGU9XCJ7e2lucHV0VHlwZX19XCIgbmFtZT1cInt7aW5wdXROYW1lfX1cIiB2YWx1ZT1cInt7dmFsdWV9fVwiIHt7I2lmIHNlbGVjdGVkfX1jaGVja2Vke3svaWZ9fT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgbWF0ZXJpYWx9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgaGFzTWVkaWF9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tbWVkaWFcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBpY29ufX08aSBjbGFzcz1cImljb24ge3tpY29ufX1cIj48L2k+e3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIGltYWdlfX08aW1nIHNyYz1cInt7aW1hZ2V9fVwiPnt7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0taW5uZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS10aXRsZXt7I2lmIGNvbG9yfX0gY29sb3Ite3tjb2xvcn19e3svaWZ9fVwiPnt7dGV4dH19PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLWFmdGVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGkgY2xhc3M9XCJpY29uIGljb24tZm9ybS17e2lucHV0VHlwZX19XCI+PC9pPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7e2Vsc2V9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tbWVkaWFcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8aSBjbGFzcz1cImljb24gaWNvbi1mb3JtLXt7aW5wdXRUeXBlfX1cIj48L2k+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tdGl0bGV7eyNpZiBjb2xvcn19IGNvbG9yLXt7Y29sb3J9fXt7L2lmfX1cIj57e3RleHR9fTwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7ZWxzZX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBoYXNNZWRpYX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1tZWRpYVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIGNoZWNrYm94fX08aSBjbGFzcz1cImljb24gaWNvbi1mb3JtLWNoZWNrYm94XCI+PC9pPnt7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBpY29ufX08aSBjbGFzcz1cImljb24ge3tpY29ufX1cIj48L2k+e3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIGltYWdlfX08aW1nIHNyYz1cInt7aW1hZ2V9fVwiPnt7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0taW5uZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS10aXRsZXt7I2lmIGNvbG9yfX0gY29sb3Ite3tjb2xvcn19e3svaWZ9fVwiPnt7dGV4dH19PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvbGFiZWw+JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2xpPicgK1xuICAgICAgICAgICAgICAgICAgICAne3svaWZ9fSdcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHNtYXJ0U2VsZWN0SXRlbVRlbXBsYXRlID0gYXBwLl9jb21waWxlZFRlbXBsYXRlcy5zbWFydFNlbGVjdEl0ZW07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHZhciBpbnB1dHNIVE1MID0gJyc7XG4gICAgICAgICAgICBpZiAoIXZpcnR1YWxMaXN0KSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB2YWx1ZXMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaW5wdXRzSFRNTCArPSBzbWFydFNlbGVjdEl0ZW1UZW1wbGF0ZSh2YWx1ZXNbal0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBUb29sYmFyIC8gTmF2YmFyXG4gICAgICAgICAgICB2YXIgdG9vbGJhckhUTUwgPSAnJywgbmF2YmFySFRNTDtcbiAgICAgICAgICAgIHZhciBub05hdmJhciA9ICcnLCBub1Rvb2xiYXIgPSAnJywgbm9UYWJiYXIgPSAnJywgbmF2YmFyTGF5b3V0O1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChvcGVuSW4gPT09ICdwaWNrZXInKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLnNtYXJ0U2VsZWN0VG9vbGJhcikge1xuICAgICAgICAgICAgICAgICAgICBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLnNtYXJ0U2VsZWN0VG9vbGJhciA9IHQ3LmNvbXBpbGUoYXBwLnBhcmFtcy5zbWFydFNlbGVjdFRvb2xiYXJUZW1wbGF0ZSB8fCBcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwidG9vbGJhciB7eyNpZiB0b29sYmFyVGhlbWV9fXRoZW1lLXt7dG9vbGJhclRoZW1lfX17ey9pZn19XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwidG9vbGJhci1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibGVmdFwiPjwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicmlnaHRcIj48YSBocmVmPVwiI1wiIGNsYXNzPVwibGluayBjbG9zZS1waWNrZXJcIj48c3Bhbj57e2Nsb3NlVGV4dH19PC9zcGFuPjwvYT48L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+J1xuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdG9vbGJhckhUTUwgPSBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLnNtYXJ0U2VsZWN0VG9vbGJhcih7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VUaXRsZTogcGFnZVRpdGxlLFxuICAgICAgICAgICAgICAgICAgICBjbG9zZVRleHQ6IGNsb3NlVGV4dCxcbiAgICAgICAgICAgICAgICAgICAgb3BlbkluOiBvcGVuSW4sXG4gICAgICAgICAgICAgICAgICAgIHRvb2xiYXJUaGVtZTogdG9vbGJhclRoZW1lLFxuICAgICAgICAgICAgICAgICAgICBpblBpY2tlcjogb3BlbkluID09PSAncGlja2VyJyAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBOYXZiYXIgSFRNTFxuICAgICAgICAgICAgICAgIGlmICghYXBwLl9jb21waWxlZFRlbXBsYXRlcy5zbWFydFNlbGVjdE5hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLnNtYXJ0U2VsZWN0TmF2YmFyID0gdDcuY29tcGlsZShhcHAucGFyYW1zLnNtYXJ0U2VsZWN0TmF2YmFyVGVtcGxhdGUgfHwgXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIm5hdmJhciB7eyNpZiBuYXZiYXJUaGVtZX19dGhlbWUte3tuYXZiYXJUaGVtZX19e3svaWZ9fVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibmF2YmFyLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7e2xlZnRUZW1wbGF0ZX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiY2VudGVyIHNsaWRpbmdcIj57e3BhZ2VUaXRsZX19PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PidcbiAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbmF2YmFySFRNTCA9IGFwcC5fY29tcGlsZWRUZW1wbGF0ZXMuc21hcnRTZWxlY3ROYXZiYXIoe1xuICAgICAgICAgICAgICAgICAgICBwYWdlVGl0bGU6IHBhZ2VUaXRsZSxcbiAgICAgICAgICAgICAgICAgICAgYmFja1RleHQ6IGJhY2tUZXh0LFxuICAgICAgICAgICAgICAgICAgICBjbG9zZVRleHQ6IGNsb3NlVGV4dCxcbiAgICAgICAgICAgICAgICAgICAgb3BlbkluOiBvcGVuSW4sXG4gICAgICAgICAgICAgICAgICAgIG5hdmJhclRoZW1lOiBuYXZiYXJUaGVtZSxcbiAgICAgICAgICAgICAgICAgICAgaW5Qb3B1cDogb3BlbkluID09PSAncG9wdXAnLFxuICAgICAgICAgICAgICAgICAgICBpblBhZ2U6IG9wZW5JbiA9PT0gJ3BhZ2UnLFxuICAgICAgICAgICAgICAgICAgICBsZWZ0VGVtcGxhdGU6IG9wZW5JbiA9PT0gJ3BvcHVwJyA/IFxuICAgICAgICAgICAgICAgICAgICAgICAgKGFwcC5wYXJhbXMuc21hcnRTZWxlY3RQb3B1cENsb3NlVGVtcGxhdGUgfHwgKG1hdGVyaWFsID8gJzxkaXYgY2xhc3M9XCJsZWZ0XCI+PGEgaHJlZj1cIiNcIiBjbGFzcz1cImxpbmsgY2xvc2UtcG9wdXAgaWNvbi1vbmx5XCI+PGkgY2xhc3M9XCJpY29uIGljb24tYmFja1wiPjwvaT48L2E+PC9kaXY+JyA6ICc8ZGl2IGNsYXNzPVwibGVmdFwiPjxhIGhyZWY9XCIjXCIgY2xhc3M9XCJsaW5rIGNsb3NlLXBvcHVwXCI+PGkgY2xhc3M9XCJpY29uIGljb24tYmFja1wiPjwvaT48c3Bhbj57e2Nsb3NlVGV4dH19PC9zcGFuPjwvYT48L2Rpdj4nKSkucmVwbGFjZSgve3tjbG9zZVRleHR9fS9nLCBjbG9zZVRleHQpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgIChhcHAucGFyYW1zLnNtYXJ0U2VsZWN0QmFja1RlbXBsYXRlIHx8IChtYXRlcmlhbCA/ICc8ZGl2IGNsYXNzPVwibGVmdFwiPjxhIGhyZWY9XCIjXCIgY2xhc3M9XCJiYWNrIGxpbmsgaWNvbi1vbmx5XCI+PGkgY2xhc3M9XCJpY29uIGljb24tYmFja1wiPjwvaT48L2E+PC9kaXY+JyA6ICc8ZGl2IGNsYXNzPVwibGVmdCBzbGlkaW5nXCI+PGEgaHJlZj1cIiNcIiBjbGFzcz1cImJhY2sgbGlua1wiPjxpIGNsYXNzPVwiaWNvbiBpY29uLWJhY2tcIj48L2k+PHNwYW4+e3tiYWNrVGV4dH19PC9zcGFuPjwvYT48L2Rpdj4nKSkucmVwbGFjZSgve3tiYWNrVGV4dH19L2csIGJhY2tUZXh0KVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIC8vIERldGVybWluZSBuYXZiYXIgbGF5b3V0IHR5cGUgLSBzdGF0aWMvZml4ZWQvdGhyb3VnaFxuICAgICAgICAgICAgICAgIGlmIChvcGVuSW4gPT09ICdwYWdlJykge1xuICAgICAgICAgICAgICAgICAgICBuYXZiYXJMYXlvdXQgPSAnc3RhdGljJztcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNtYXJ0U2VsZWN0LnBhcmVudHMoJy5uYXZiYXItdGhyb3VnaCcpLmxlbmd0aCA+IDApIG5hdmJhckxheW91dCA9ICd0aHJvdWdoJztcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNtYXJ0U2VsZWN0LnBhcmVudHMoJy5uYXZiYXItZml4ZWQnKS5sZW5ndGggPiAwKSBuYXZiYXJMYXlvdXQgPSAnZml4ZWQnO1xuICAgICAgICAgICAgICAgICAgICBub1Rvb2xiYXIgPSBzbWFydFNlbGVjdC5wYXJlbnRzKCcucGFnZScpLmhhc0NsYXNzKCduby10b29sYmFyJykgPyAnbm8tdG9vbGJhcicgOiAnJztcbiAgICAgICAgICAgICAgICAgICAgbm9OYXZiYXIgID0gc21hcnRTZWxlY3QucGFyZW50cygnLnBhZ2UnKS5oYXNDbGFzcygnbm8tbmF2YmFyJykgID8gJ25vLW5hdmJhcicgIDogJ25hdmJhci0nICsgbmF2YmFyTGF5b3V0O1xuICAgICAgICAgICAgICAgICAgICBub1RhYmJhciA9IHNtYXJ0U2VsZWN0LnBhcmVudHMoJy5wYWdlJykuaGFzQ2xhc3MoJ25vLXRhYmJhcicpID8gJ25vLXRhYmJhcicgOiAnJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG5hdmJhckxheW91dCA9ICdmaXhlZCc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBhZ2UgTGF5b3V0XG4gICAgICAgICAgICB2YXIgcGFnZU5hbWUgPSAnc21hcnQtc2VsZWN0LScgKyBpbnB1dE5hbWU7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHVzZVNlYXJjaGJhciA9IHR5cGVvZiBzbWFydFNlbGVjdC5kYXRhKCdzZWFyY2hiYXInKSA9PT0gJ3VuZGVmaW5lZCcgPyBhcHAucGFyYW1zLnNtYXJ0U2VsZWN0U2VhcmNoYmFyIDogKHNtYXJ0U2VsZWN0LmRhdGEoJ3NlYXJjaGJhcicpID09PSAndHJ1ZScgPyB0cnVlIDogZmFsc2UpO1xuICAgICAgICAgICAgdmFyIHNlYXJjaGJhclBsYWNlaG9sZGVyLCBzZWFyY2hiYXJDYW5jZWw7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAodXNlU2VhcmNoYmFyKSB7XG4gICAgICAgICAgICAgICAgc2VhcmNoYmFyUGxhY2Vob2xkZXIgPSBzbWFydFNlbGVjdC5kYXRhKCdzZWFyY2hiYXItcGxhY2Vob2xkZXInKSB8fCAnU2VhcmNoJztcbiAgICAgICAgICAgICAgICBzZWFyY2hiYXJDYW5jZWwgPSBzbWFydFNlbGVjdC5kYXRhKCdzZWFyY2hiYXItY2FuY2VsJykgfHwgJ0NhbmNlbCc7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHNlYXJjaGJhckhUTUwgPSAgICc8Zm9ybSBjbGFzcz1cInNlYXJjaGJhciBzZWFyY2hiYXItaW5pdFwiIGRhdGEtc2VhcmNoLWxpc3Q9XCIuc21hcnQtc2VsZWN0LWxpc3QtJyArIGlkICsgJ1wiIGRhdGEtc2VhcmNoLWluPVwiLml0ZW0tdGl0bGVcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwic2VhcmNoYmFyLWlucHV0XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxpbnB1dCB0eXBlPVwic2VhcmNoXCIgcGxhY2Vob2xkZXI9XCInICsgc2VhcmNoYmFyUGxhY2Vob2xkZXIgKyAnXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxhIGhyZWY9XCIjXCIgY2xhc3M9XCJzZWFyY2hiYXItY2xlYXJcIj48L2E+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAobWF0ZXJpYWwgPyAnJyA6ICc8YSBocmVmPVwiI1wiIGNsYXNzPVwic2VhcmNoYmFyLWNhbmNlbFwiPicgKyBzZWFyY2hiYXJDYW5jZWwgKyAnPC9hPicpICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9mb3JtPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwic2VhcmNoYmFyLW92ZXJsYXlcIj48L2Rpdj4nO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBwYWdlSFRNTCA9XG4gICAgICAgICAgICAgICAgKG9wZW5JbiAhPT0gJ3BpY2tlcicgJiYgbmF2YmFyTGF5b3V0ID09PSAndGhyb3VnaCcgPyBuYXZiYXJIVE1MIDogJycpICtcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBhZ2VzXCI+JyArXG4gICAgICAgICAgICAgICAgJyAgPGRpdiBkYXRhLXBhZ2U9XCInICsgcGFnZU5hbWUgKyAnXCIgZGF0YS1zZWxlY3QtbmFtZT1cIicgKyBzZWxlY3ROYW1lICsgJ1wiIGNsYXNzPVwicGFnZSBzbWFydC1zZWxlY3QtcGFnZSAnICsgbm9OYXZiYXIgKyAnICcgKyBub1Rvb2xiYXIgKyAnICcgKyBub1RhYmJhciArICdcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgIChvcGVuSW4gIT09ICdwaWNrZXInICYmIG5hdmJhckxheW91dCA9PT0gJ2ZpeGVkJyA/IG5hdmJhckhUTUwgOiAnJykgK1xuICAgICAgICAgICAgICAgICAgICAgKHVzZVNlYXJjaGJhciA/IHNlYXJjaGJhckhUTUwgOiAnJykgK1xuICAgICAgICAgICAgICAgICcgICAgPGRpdiBjbGFzcz1cInBhZ2UtY29udGVudFwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAob3BlbkluICE9PSAncGlja2VyJyAmJiBuYXZiYXJMYXlvdXQgPT09ICdzdGF0aWMnID8gbmF2YmFySFRNTCA6ICcnKSArXG4gICAgICAgICAgICAgICAgJyAgICAgIDxkaXYgY2xhc3M9XCJsaXN0LWJsb2NrICcgKyAodmlydHVhbExpc3QgPyAndmlydHVhbC1saXN0JyA6ICcnKSArICcgc21hcnQtc2VsZWN0LWxpc3QtJyArIGlkICsgJyAnICsgKGZvcm1UaGVtZSA/ICd0aGVtZS0nICsgZm9ybVRoZW1lIDogJycpICsgJ1wiPicgK1xuICAgICAgICAgICAgICAgICcgICAgICAgIDx1bD4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAodmlydHVhbExpc3QgPyAnJyA6IGlucHV0c0hUTUwpICtcbiAgICAgICAgICAgICAgICAnICAgICAgICA8L3VsPicgK1xuICAgICAgICAgICAgICAgICcgICAgICA8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAnICAgIDwvZGl2PicgK1xuICAgICAgICAgICAgICAgICcgIDwvZGl2PicgK1xuICAgICAgICAgICAgICAgICc8L2Rpdj4nO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIERlZmluZSBwb3B1cCBhbmQgcGlja2VyXG4gICAgICAgICAgICB2YXIgcG9wdXAsIHBpY2tlcjtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTY3JvbGwgU1MgUGlja2VyIFRvIElucHV0XG4gICAgICAgICAgICBmdW5jdGlvbiBzY3JvbGxUb0lucHV0KCkge1xuICAgICAgICAgICAgICAgIHZhciBwYWdlQ29udGVudCA9IHNtYXJ0U2VsZWN0LnBhcmVudHMoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgICAgICAgICBpZiAocGFnZUNvbnRlbnQubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIHBhZGRpbmdUb3AgPSBwYXJzZUludChwYWdlQ29udGVudC5jc3MoJ3BhZGRpbmctdG9wJyksIDEwKSxcbiAgICAgICAgICAgICAgICAgICAgcGFkZGluZ0JvdHRvbSA9IHBhcnNlSW50KHBhZ2VDb250ZW50LmNzcygncGFkZGluZy1ib3R0b20nKSwgMTApLFxuICAgICAgICAgICAgICAgICAgICBwYWdlSGVpZ2h0ID0gcGFnZUNvbnRlbnRbMF0ub2Zmc2V0SGVpZ2h0IC0gcGFkZGluZ1RvcCAtIHBpY2tlci5oZWlnaHQoKSxcbiAgICAgICAgICAgICAgICAgICAgcGFnZVNjcm9sbEhlaWdodCA9IHBhZ2VDb250ZW50WzBdLnNjcm9sbEhlaWdodCAtIHBhZGRpbmdUb3AgLSBwaWNrZXIuaGVpZ2h0KCksXG4gICAgICAgICAgICAgICAgICAgIG5ld1BhZGRpbmdCb3R0b207XG4gICAgICAgICAgICAgICAgdmFyIGlucHV0VG9wID0gc21hcnRTZWxlY3Qub2Zmc2V0KCkudG9wIC0gcGFkZGluZ1RvcCArIHNtYXJ0U2VsZWN0WzBdLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgICAgICBpZiAoaW5wdXRUb3AgPiBwYWdlSGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzY3JvbGxUb3AgPSBwYWdlQ29udGVudC5zY3JvbGxUb3AoKSArIGlucHV0VG9wIC0gcGFnZUhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNjcm9sbFRvcCArIHBhZ2VIZWlnaHQgPiBwYWdlU2Nyb2xsSGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdQYWRkaW5nQm90dG9tID0gc2Nyb2xsVG9wICsgcGFnZUhlaWdodCAtIHBhZ2VTY3JvbGxIZWlnaHQgKyBwYWRkaW5nQm90dG9tO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2VIZWlnaHQgPT09IHBhZ2VTY3JvbGxIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdQYWRkaW5nQm90dG9tID0gcGlja2VyLmhlaWdodCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnQuY3NzKHsncGFkZGluZy1ib3R0b20nOiAobmV3UGFkZGluZ0JvdHRvbSkgKyAncHgnfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnQuc2Nyb2xsVG9wKHNjcm9sbFRvcCwgMzAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBDbG9zZSBTUyBQaWNrZXIgb24gSFRNTCBDbGlja1xuICAgICAgICAgICAgZnVuY3Rpb24gY2xvc2VPbkhUTUxDbGljayhlKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNsb3NlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAoZS50YXJnZXQgPT09IHNtYXJ0U2VsZWN0WzBdIHx8ICQoZS50YXJnZXQpLnBhcmVudHMoc21hcnRTZWxlY3RbMF0pLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY2xvc2UgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCQoZS50YXJnZXQpLnBhcmVudHMoJy5waWNrZXItbW9kYWwnKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsb3NlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjbG9zZSkge1xuICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbCgnLnNtYXJ0LXNlbGVjdC1waWNrZXIubW9kYWwtaW4nKTsgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ2hlY2sgbWF4IGxlbmd0aFxuICAgICAgICAgICAgZnVuY3Rpb24gY2hlY2tNYXhMZW5ndGgoY29udGFpbmVyKSB7XG4gICAgICAgICAgICAgICAgaWYgKHNlbGVjdC5zZWxlY3RlZE9wdGlvbnMubGVuZ3RoID49IG1heExlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuZmluZCgnaW5wdXRbdHlwZT1cImNoZWNrYm94XCJdJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY2hlY2tlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykucGFyZW50cygnbGknKS5hZGRDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykucGFyZW50cygnbGknKS5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTsgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuZmluZCgnLmRpc2FibGVkJykucmVtb3ZlQ2xhc3MoJ2Rpc2FibGVkJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gRXZlbnQgTGlzdGVuZXJzIG9uIG5ldyBwYWdlXG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVJbnB1dHMoY29udGFpbmVyKSB7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyID0gJChjb250YWluZXIpO1xuICAgICAgICAgICAgICAgIGlmICh2aXJ0dWFsTGlzdCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdmlydHVhbExpc3RJbnN0YW5jZSA9IGFwcC52aXJ0dWFsTGlzdChjb250YWluZXIuZmluZCgnLnZpcnR1YWwtbGlzdCcpLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtczogdmFsdWVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGVtcGxhdGU6IHNtYXJ0U2VsZWN0SXRlbVRlbXBsYXRlLFxuICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0OiB2aXJ0dWFsTGlzdEhlaWdodCB8fCB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2hCeUl0ZW06IGZ1bmN0aW9uIChxdWVyeSwgaW5kZXgsIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS50ZXh0LnRvTG93ZXJDYXNlKCkuaW5kZXhPZihxdWVyeS50cmltKCkudG9Mb3dlckNhc2UoKSkgPj0wICkgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLm9uY2Uob3BlbkluID09PSAncG9wdXAnIHx8IG9wZW5JbiA9PT0gJ3BpY2tlcicgPyAnY2xvc2VkJzogJ3BhZ2VCZWZvcmVSZW1vdmUnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlydHVhbExpc3RJbnN0YW5jZSAmJiB2aXJ0dWFsTGlzdEluc3RhbmNlLmRlc3Ryb3kpIHZpcnR1YWxMaXN0SW5zdGFuY2UuZGVzdHJveSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG1heExlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBjaGVja01heExlbmd0aChjb250YWluZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb250YWluZXIub24oJ2NoYW5nZScsICdpbnB1dFtuYW1lPVwiJyArIGlucHV0TmFtZSArICdcIl0nLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9IHRoaXM7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IGlucHV0LnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICB2YXIgb3B0aW9uVGV4dCA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXQudHlwZSA9PT0gJ2NoZWNrYm94Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZWxlY3Qub3B0aW9ucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb24gPSBzZWxlY3Qub3B0aW9uc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLnZhbHVlID09PSB2YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBpbnB1dC5jaGVja2VkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uLnNlbGVjdGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvblRleHQucHVzaChvcHRpb24udGV4dENvbnRlbnQudHJpbSgpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF4TGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tNYXhMZW5ndGgoY29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvblRleHQgPSBbc21hcnRTZWxlY3QuZmluZCgnb3B0aW9uW3ZhbHVlPVwiJyArIHZhbHVlICsgJ1wiXScpLnRleHQoKV07XG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3QudmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICRzZWxlY3QudHJpZ2dlcignY2hhbmdlJyk7XG4gICAgICAgICAgICAgICAgICAgIHNtYXJ0U2VsZWN0LmZpbmQoJy5pdGVtLWFmdGVyJykudGV4dChvcHRpb25UZXh0LmpvaW4oJywgJykpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYmFja09uU2VsZWN0ICYmIGlucHV0VHlwZSA9PT0gJ3JhZGlvJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wZW5JbiA9PT0gJ3BvcHVwJykgYXBwLmNsb3NlTW9kYWwocG9wdXApO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAob3BlbkluID09PSAncGlja2VyJykgYXBwLmNsb3NlTW9kYWwocGlja2VyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Ugdmlldy5yb3V0ZXIuYmFjaygpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBwYWdlSW5pdChlKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2UgPSBlLmRldGFpbC5wYWdlO1xuICAgICAgICAgICAgICAgIGlmIChwYWdlLm5hbWUgPT09IHBhZ2VOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIGhhbmRsZUlucHV0cyhwYWdlLmNvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG9wZW5JbiA9PT0gJ3BvcHVwJykge1xuICAgICAgICAgICAgICAgIGlmIChyZUxheW91dCkge1xuICAgICAgICAgICAgICAgICAgICBwb3B1cCA9ICQoJy5wb3B1cC5zbWFydC1zZWxlY3QtcG9wdXAgLnZpZXcnKTtcbiAgICAgICAgICAgICAgICAgICAgcG9wdXAuaHRtbChwYWdlSFRNTCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwb3B1cCA9IGFwcC5wb3B1cChcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicG9wdXAgc21hcnQtc2VsZWN0LXBvcHVwIHNtYXJ0LXNlbGVjdC1wb3B1cC0nICsgaW5wdXROYW1lICsgJ1wiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwidmlldyBuYXZiYXItZml4ZWRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUhUTUwgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICBwb3B1cCA9ICQocG9wdXApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBhcHAuaW5pdFBhZ2UocG9wdXAuZmluZCgnLnBhZ2UnKSk7XG4gICAgICAgICAgICAgICAgaGFuZGxlSW5wdXRzKHBvcHVwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKG9wZW5JbiA9PT0gJ3BpY2tlcicpIHtcbiAgICAgICAgICAgICAgICBpZiAocmVMYXlvdXQpIHtcbiAgICAgICAgICAgICAgICAgICAgcGlja2VyID0gJCgnLnBpY2tlci1tb2RhbC5zbWFydC1zZWxlY3QtcGlja2VyIC52aWV3Jyk7XG4gICAgICAgICAgICAgICAgICAgIHBpY2tlci5odG1sKHBhZ2VIVE1MKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBpY2tlciA9IGFwcC5waWNrZXJNb2RhbChcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicGlja2VyLW1vZGFsIHNtYXJ0LXNlbGVjdC1waWNrZXIgc21hcnQtc2VsZWN0LXBpY2tlci0nICsgaW5wdXROYW1lICsgJ1wiJyArIChwaWNrZXJIZWlnaHQgPyAnIHN0eWxlPVwiaGVpZ2h0OicgKyBwaWNrZXJIZWlnaHQgKyAnXCInIDogJycpICsgJz4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b29sYmFySFRNTCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwaWNrZXItbW9kYWwtaW5uZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJ2aWV3XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlSFRNTCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+J1xuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgcGlja2VyID0gJChwaWNrZXIpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gU2Nyb2xsIFRvIElucHV0XG4gICAgICAgICAgICAgICAgICAgIHNjcm9sbFRvSW5wdXQoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIENsb3NlIE9uIENsaWNrXG4gICAgICAgICAgICAgICAgICAgICQoJ2h0bWwnKS5vbignY2xpY2snLCBjbG9zZU9uSFRNTENsaWNrKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIE9uIENsb3NlXG4gICAgICAgICAgICAgICAgICAgIHBpY2tlci5vbmNlKCdjbG9zZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJlc2V0IGxpbmtlZCBwaWNrZXJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNtYXJ0U2VsZWN0WzBdLmY3U21hcnRTZWxlY3RQaWNrZXIgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERldGFjaCBodG1sIGNsaWNrXG4gICAgICAgICAgICAgICAgICAgICAgICAkKCdodG1sJykub2ZmKCdjbGljaycsIGNsb3NlT25IVE1MQ2xpY2spOyAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBwYWdlIHBhZGRpbmcgYm90dG9tXG4gICAgICAgICAgICAgICAgICAgICAgICBzbWFydFNlbGVjdC5wYXJlbnRzKCcucGFnZS1jb250ZW50JykuY3NzKHtwYWRkaW5nQm90dG9tOiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIExpbmsgUGlja2VyXG4gICAgICAgICAgICAgICAgICAgIHNtYXJ0U2VsZWN0WzBdLmY3U21hcnRTZWxlY3RQaWNrZXIgPSBwaWNrZXJbMF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBJbml0IFBhZ2VcbiAgICAgICAgICAgICAgICBhcHAuaW5pdFBhZ2UocGlja2VyLmZpbmQoJy5wYWdlJykpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBBdHRhY2ggZXZlbnRzXG4gICAgICAgICAgICAgICAgaGFuZGxlSW5wdXRzKHBpY2tlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vbmNlKCdwYWdlSW5pdCcsICcuc21hcnQtc2VsZWN0LXBhZ2UnLCBwYWdlSW5pdCk7XG4gICAgICAgICAgICAgICAgdmlldy5yb3V0ZXIubG9hZCh7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IHBhZ2VIVE1MLFxuICAgICAgICAgICAgICAgICAgICByZWxvYWQ6IHJlTGF5b3V0ID8gdHJ1ZSA6IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgVmlydHVhbCBMaXN0ICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICB2YXIgVmlydHVhbExpc3QgPSBmdW5jdGlvbiAobGlzdEJsb2NrLCBwYXJhbXMpIHtcbiAgICAgICAgICAgIHZhciBkZWZhdWx0cyA9IHtcbiAgICAgICAgICAgICAgICBjb2xzOiAxLFxuICAgICAgICAgICAgICAgIGhlaWdodDogYXBwLnBhcmFtcy5tYXRlcmlhbCA/IDQ4IDogNDQsXG4gICAgICAgICAgICAgICAgY2FjaGU6IHRydWUsXG4gICAgICAgICAgICAgICAgZHluYW1pY0hlaWdodEJ1ZmZlclNpemU6IDEsXG4gICAgICAgICAgICAgICAgc2hvd0ZpbHRlcmVkSXRlbXNPbmx5OiBmYWxzZVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcbiAgICAgICAgICAgIGZvciAodmFyIGRlZiBpbiBkZWZhdWx0cykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW2RlZl0gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtc1tkZWZdID0gZGVmYXVsdHNbZGVmXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUHJlcGFyYXRpb25cbiAgICAgICAgICAgIHZhciB2bCA9IHRoaXM7XG4gICAgICAgICAgICB2bC5saXN0QmxvY2sgPSAkKGxpc3RCbG9jayk7XG4gICAgICAgICAgICB2bC5wYXJhbXMgPSBwYXJhbXM7XG4gICAgICAgICAgICB2bC5pdGVtcyA9IHZsLnBhcmFtcy5pdGVtcztcbiAgICAgICAgICAgIGlmICh2bC5wYXJhbXMuc2hvd0ZpbHRlcmVkSXRlbXNPbmx5KSB7XG4gICAgICAgICAgICAgICAgdmwuZmlsdGVyZWRJdGVtcyA9IFtdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHZsLnBhcmFtcy50ZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmwucGFyYW1zLnRlbXBsYXRlID09PSAnc3RyaW5nJykgdmwudGVtcGxhdGUgPSB0Ny5jb21waWxlKHZsLnBhcmFtcy50ZW1wbGF0ZSk7XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIHZsLnBhcmFtcy50ZW1wbGF0ZSA9PT0gJ2Z1bmN0aW9uJykgdmwudGVtcGxhdGUgPSB2bC5wYXJhbXMudGVtcGxhdGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2bC5wYWdlQ29udGVudCA9IHZsLmxpc3RCbG9jay5wYXJlbnRzKCcucGFnZS1jb250ZW50Jyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQmFkIHNjcm9sbFxuICAgICAgICAgICAgdmFyIHVwZGF0YWJsZVNjcm9sbDtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdmwucGFyYW1zLnVwZGF0YWJsZVNjcm9sbCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICB1cGRhdGFibGVTY3JvbGwgPSB2bC5wYXJhbXMudXBkYXRhYmxlU2Nyb2xsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdXBkYXRhYmxlU2Nyb2xsID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5pb3MgJiYgYXBwLmRldmljZS5vc1ZlcnNpb24uc3BsaXQoJy4nKVswXSA8IDgpIHtcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRhYmxlU2Nyb2xsID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIEFwcGVuZCA8dWw+XG4gICAgICAgICAgICB2bC51bCA9IHZsLnBhcmFtcy51bCA/ICQodmwucGFyYW1zLnVsKSA6IHZsLmxpc3RCbG9jay5jaGlsZHJlbigndWwnKTtcbiAgICAgICAgICAgIGlmICh2bC51bC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICB2bC5saXN0QmxvY2suYXBwZW5kKCc8dWw+PC91bD4nKTtcbiAgICAgICAgICAgICAgICB2bC51bCA9IHZsLmxpc3RCbG9jay5jaGlsZHJlbigndWwnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBET00gY2FjaGVkIGl0ZW1zXG4gICAgICAgICAgICB2bC5kb21DYWNoZSA9IHt9O1xuICAgICAgICAgICAgdmwuZGlzcGxheURvbUNhY2hlID0ge307XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVGVtcG9yYXJ5IERPTSBFbGVtZW50XG4gICAgICAgICAgICB2bC50ZW1wRG9tRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3VsJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gTGFzdCByZXBhaW4gcG9zaXRpb25cbiAgICAgICAgICAgIHZsLmxhc3RSZXBhaW50WSA9IG51bGw7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRnJhZ21lbnRcbiAgICAgICAgICAgIHZsLmZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEZpbHRlclxuICAgICAgICAgICAgdmwuZmlsdGVySXRlbXMgPSBmdW5jdGlvbiAoaW5kZXhlcywgcmVzZXRTY3JvbGxUb3ApIHtcbiAgICAgICAgICAgICAgICB2bC5maWx0ZXJlZEl0ZW1zID0gW107XG4gICAgICAgICAgICAgICAgdmFyIGZpcnN0SW5kZXggPSBpbmRleGVzWzBdO1xuICAgICAgICAgICAgICAgIHZhciBsYXN0SW5kZXggPSBpbmRleGVzW2luZGV4ZXMubGVuZ3RoIC0gMV07XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbmRleGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZsLmZpbHRlcmVkSXRlbXMucHVzaCh2bC5pdGVtc1tpbmRleGVzW2ldXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVzZXRTY3JvbGxUb3AgPT09ICd1bmRlZmluZWQnKSByZXNldFNjcm9sbFRvcCA9IHRydWU7XG4gICAgICAgICAgICAgICAgaWYgKHJlc2V0U2Nyb2xsVG9wKSB7XG4gICAgICAgICAgICAgICAgICAgIHZsLnBhZ2VDb250ZW50WzBdLnNjcm9sbFRvcCA9IDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZsLnVwZGF0ZSgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZsLnJlc2V0RmlsdGVyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmICh2bC5wYXJhbXMuc2hvd0ZpbHRlcmVkSXRlbXNPbmx5KSB7XG4gICAgICAgICAgICAgICAgICAgIHZsLmZpbHRlcmVkSXRlbXMgPSBbXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZsLmZpbHRlcmVkSXRlbXMgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdmwuZmlsdGVyZWRJdGVtczsgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZsLnVwZGF0ZSgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgcGFnZUhlaWdodCwgcm93c1BlclNjcmVlbiwgcm93c0JlZm9yZSwgcm93c0FmdGVyLCByb3dzVG9SZW5kZXIsIG1heEJ1ZmZlckhlaWdodCA9IDAsIGxpc3RIZWlnaHQ7XG4gICAgICAgICAgICB2YXIgZHluYW1pY0hlaWdodCA9IHR5cGVvZiB2bC5wYXJhbXMuaGVpZ2h0ID09PSAnZnVuY3Rpb24nO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNldCBsaXN0IHNpemVcbiAgICAgICAgICAgIHZsLnNldExpc3RTaXplID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBpdGVtcyA9IHZsLmZpbHRlcmVkSXRlbXMgfHwgdmwuaXRlbXM7XG4gICAgICAgICAgICAgICAgcGFnZUhlaWdodCA9IHZsLnBhZ2VDb250ZW50WzBdLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgICAgICBpZiAoZHluYW1pY0hlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICBsaXN0SGVpZ2h0ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgdmwuaGVpZ2h0cyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbUhlaWdodCA9IHZsLnBhcmFtcy5oZWlnaHQoaXRlbXNbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGlzdEhlaWdodCArPSBpdGVtSGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICAgICAgdmwuaGVpZ2h0cy5wdXNoKGl0ZW1IZWlnaHQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsaXN0SGVpZ2h0ID0gaXRlbXMubGVuZ3RoICogdmwucGFyYW1zLmhlaWdodCAvIHZsLnBhcmFtcy5jb2xzO1xuICAgICAgICAgICAgICAgICAgICByb3dzUGVyU2NyZWVuID0gTWF0aC5jZWlsKHBhZ2VIZWlnaHQgLyB2bC5wYXJhbXMuaGVpZ2h0KTtcbiAgICAgICAgICAgICAgICAgICAgcm93c0JlZm9yZSA9IHZsLnBhcmFtcy5yb3dzQmVmb3JlIHx8IHJvd3NQZXJTY3JlZW4gKiAyO1xuICAgICAgICAgICAgICAgICAgICByb3dzQWZ0ZXIgPSB2bC5wYXJhbXMucm93c0FmdGVyIHx8IHJvd3NQZXJTY3JlZW47XG4gICAgICAgICAgICAgICAgICAgIHJvd3NUb1JlbmRlciA9IChyb3dzUGVyU2NyZWVuICsgcm93c0JlZm9yZSArIHJvd3NBZnRlcik7XG4gICAgICAgICAgICAgICAgICAgIG1heEJ1ZmZlckhlaWdodCA9IHJvd3NCZWZvcmUgLyAyICogdmwucGFyYW1zLmhlaWdodDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICh1cGRhdGFibGVTY3JvbGwpIHtcbiAgICAgICAgICAgICAgICAgICAgdmwudWwuY3NzKHtoZWlnaHQ6IGxpc3RIZWlnaHQgKyAncHgnfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBSZW5kZXIgaXRlbXNcbiAgICAgICAgICAgIHZsLnJlbmRlciA9IGZ1bmN0aW9uIChmb3JjZSwgZm9yY2VTY3JvbGxUb3ApIHtcbiAgICAgICAgICAgICAgICBpZiAoZm9yY2UpIHZsLmxhc3RSZXBhaW50WSA9IG51bGw7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBzY3JvbGxUb3AgPSAtKHZsLmxpc3RCbG9ja1swXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3AgLSB2bC5wYWdlQ29udGVudFswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3ApO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZvcmNlU2Nyb2xsVG9wICE9PSAndW5kZWZpbmVkJykgc2Nyb2xsVG9wID0gZm9yY2VTY3JvbGxUb3A7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICh2bC5sYXN0UmVwYWludFkgPT09IG51bGwgfHwgTWF0aC5hYnMoc2Nyb2xsVG9wIC0gdmwubGFzdFJlcGFpbnRZKSA+IG1heEJ1ZmZlckhlaWdodCB8fCAoIXVwZGF0YWJsZVNjcm9sbCAmJiAodmwucGFnZUNvbnRlbnRbMF0uc2Nyb2xsVG9wICsgcGFnZUhlaWdodCA+PSB2bC5wYWdlQ29udGVudFswXS5zY3JvbGxIZWlnaHQpKSkge1xuICAgICAgICAgICAgICAgICAgICB2bC5sYXN0UmVwYWludFkgPSBzY3JvbGxUb3A7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgaXRlbXMgPSB2bC5maWx0ZXJlZEl0ZW1zIHx8IHZsLml0ZW1zLCBcbiAgICAgICAgICAgICAgICAgICAgZnJvbUluZGV4LCB0b0luZGV4LCBoZWlnaHRCZWZvcmVGaXJzdEl0ZW0gPSAwLCBoZWlnaHRCZWZvcmVMYXN0SXRlbSA9IDA7XG4gICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1Ub3AgPSAwLCBqLCBpdGVtSGVpZ2h0OyBcbiAgICAgICAgICAgICAgICAgICAgbWF4QnVmZmVySGVpZ2h0ID0gcGFnZUhlaWdodDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCB2bC5oZWlnaHRzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtSGVpZ2h0ID0gdmwuaGVpZ2h0c1tqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZnJvbUluZGV4ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtVG9wICsgaXRlbUhlaWdodCA+PSBzY3JvbGxUb3AgLSBwYWdlSGVpZ2h0ICogMiAqIHZsLnBhcmFtcy5keW5hbWljSGVpZ2h0QnVmZmVyU2l6ZSkgZnJvbUluZGV4ID0gajtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGhlaWdodEJlZm9yZUZpcnN0SXRlbSArPSBpdGVtSGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdG9JbmRleCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbVRvcCArIGl0ZW1IZWlnaHQgPj0gc2Nyb2xsVG9wICsgcGFnZUhlaWdodCAqIDIgKiB2bC5wYXJhbXMuZHluYW1pY0hlaWdodEJ1ZmZlclNpemUgfHwgaiA9PT0gdmwuaGVpZ2h0cy5sZW5ndGggLSAxKSB0b0luZGV4ID0gaiArIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVpZ2h0QmVmb3JlTGFzdEl0ZW0gKz0gaXRlbUhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1Ub3AgKz0gaXRlbUhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0b0luZGV4ID0gTWF0aC5taW4odG9JbmRleCwgaXRlbXMubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZyb21JbmRleCA9IChwYXJzZUludChzY3JvbGxUb3AgLyB2bC5wYXJhbXMuaGVpZ2h0KSAtIHJvd3NCZWZvcmUpICogdmwucGFyYW1zLmNvbHM7XG4gICAgICAgICAgICAgICAgICAgIGlmIChmcm9tSW5kZXggPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmcm9tSW5kZXggPSAwO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRvSW5kZXggPSBNYXRoLm1pbihmcm9tSW5kZXggKyByb3dzVG9SZW5kZXIgKiB2bC5wYXJhbXMuY29scywgaXRlbXMubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciB0b3BQb3NpdGlvbjtcbiAgICAgICAgICAgICAgICB2bC5yZWFjaEVuZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBmcm9tSW5kZXg7IGkgPCB0b0luZGV4OyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW0sIGluZGV4O1xuICAgICAgICAgICAgICAgICAgICAvLyBEZWZpbmUgcmVhbCBpdGVtIGluZGV4XG4gICAgICAgICAgICAgICAgICAgIGluZGV4ID0gdmwuaXRlbXMuaW5kZXhPZihpdGVtc1tpXSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoaSA9PT0gZnJvbUluZGV4KSB2bC5jdXJyZW50RnJvbUluZGV4ID0gaW5kZXg7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpID09PSB0b0luZGV4IC0gMSkgdmwuY3VycmVudFRvSW5kZXggPSBpbmRleDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSB2bC5pdGVtcy5sZW5ndGggLSAxKSB2bC5yZWFjaEVuZCA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBGaW5kIGl0ZW1zXG4gICAgICAgICAgICAgICAgICAgIGlmICh2bC5kb21DYWNoZVtpbmRleF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0gPSB2bC5kb21DYWNoZVtpbmRleF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmwudGVtcGxhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2bC50ZW1wRG9tRWxlbWVudC5pbm5lckhUTUwgPSB2bC50ZW1wbGF0ZShpdGVtc1tpXSwge2luZGV4OiBpbmRleH0pLnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHZsLnBhcmFtcy5yZW5kZXJJdGVtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmwudGVtcERvbUVsZW1lbnQuaW5uZXJIVE1MID0gdmwucGFyYW1zLnJlbmRlckl0ZW0oaW5kZXgsIGl0ZW1zW2ldKS50cmltKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2bC50ZW1wRG9tRWxlbWVudC5pbm5lckhUTUwgPSBpdGVtc1tpXS50cmltKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpdGVtID0gdmwudGVtcERvbUVsZW1lbnQuY2hpbGROb2Rlc1swXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2bC5wYXJhbXMuY2FjaGUpIHZsLmRvbUNhY2hlW2luZGV4XSA9IGl0ZW07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaXRlbS5mN1ZpcnR1YWxMaXN0SW5kZXggPSBpbmRleDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIFNldCBpdGVtIHRvcCBwb3NpdGlvblxuICAgICAgICAgICAgICAgICAgICBpZiAoaSA9PT0gZnJvbUluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY0hlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvcFBvc2l0aW9uID0gaGVpZ2h0QmVmb3JlRmlyc3RJdGVtO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wUG9zaXRpb24gPSAoaSAqIHZsLnBhcmFtcy5oZWlnaHQgLyB2bC5wYXJhbXMuY29scyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaXRlbS5zdHlsZS50b3AgPSB0b3BQb3NpdGlvbiArICdweCc7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBCZWZvcmUgaXRlbSBpbnNlcnRcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZsLnBhcmFtcy5vbkl0ZW1CZWZvcmVJbnNlcnQpIHZsLnBhcmFtcy5vbkl0ZW1CZWZvcmVJbnNlcnQodmwsIGl0ZW0pO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gQXBwZW5kIGl0ZW0gdG8gZnJhZ21lbnRcbiAgICAgICAgICAgICAgICAgICAgdmwuZnJhZ21lbnQuYXBwZW5kQ2hpbGQoaXRlbSk7XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBsaXN0IGhlaWdodCB3aXRoIG5vdCB1cGRhdGFibGUgc2Nyb2xsXG4gICAgICAgICAgICAgICAgaWYgKCF1cGRhdGFibGVTY3JvbGwpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZsLnVsWzBdLnN0eWxlLmhlaWdodCA9IGhlaWdodEJlZm9yZUxhc3RJdGVtICsgJ3B4JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZsLnVsWzBdLnN0eWxlLmhlaWdodCA9IGkgKiB2bC5wYXJhbXMuaGVpZ2h0IC8gdmwucGFyYW1zLmNvbHMgKyAncHgnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gVXBkYXRlIGxpc3QgaHRtbFxuICAgICAgICAgICAgICAgIGlmICh2bC5wYXJhbXMub25CZWZvcmVDbGVhcikgdmwucGFyYW1zLm9uQmVmb3JlQ2xlYXIodmwsIHZsLmZyYWdtZW50KTtcbiAgICAgICAgICAgICAgICB2bC51bFswXS5pbm5lckhUTUwgPSAnJztcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHZsLnBhcmFtcy5vbkl0ZW1zQmVmb3JlSW5zZXJ0KSB2bC5wYXJhbXMub25JdGVtc0JlZm9yZUluc2VydCh2bCwgdmwuZnJhZ21lbnQpO1xuICAgICAgICAgICAgICAgIHZsLnVsWzBdLmFwcGVuZENoaWxkKHZsLmZyYWdtZW50KTtcbiAgICAgICAgICAgICAgICBpZiAodmwucGFyYW1zLm9uSXRlbXNBZnRlckluc2VydCkgdmwucGFyYW1zLm9uSXRlbXNBZnRlckluc2VydCh2bCwgdmwuZnJhZ21lbnQpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZvcmNlU2Nyb2xsVG9wICE9PSAndW5kZWZpbmVkJyAmJiBmb3JjZSkge1xuICAgICAgICAgICAgICAgICAgICB2bC5wYWdlQ29udGVudC5zY3JvbGxUb3AoZm9yY2VTY3JvbGxUb3AsIDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgdmwuc2Nyb2xsVG9JdGVtID0gZnVuY3Rpb24gKGluZGV4KSB7XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gdmwuaXRlbXMubGVuZ3RoKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBpdGVtVG9wID0gMCwgbGlzdFRvcDtcbiAgICAgICAgICAgICAgICBpZiAoZHluYW1pY0hlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluZGV4OyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1Ub3AgKz0gdmwuaGVpZ2h0c1tpXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaXRlbVRvcCA9IGluZGV4ICogdmwucGFyYW1zLmhlaWdodDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbGlzdFRvcCA9IHZsLmxpc3RCbG9ja1swXS5vZmZzZXRUb3A7XG4gICAgICAgICAgICAgICAgdmwucmVuZGVyKHRydWUsIGxpc3RUb3AgKyBpdGVtVG9wIC0gcGFyc2VJbnQodmwucGFnZUNvbnRlbnQuY3NzKCdwYWRkaW5nLXRvcCcpLCAxMCkpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBIYW5kbGUgc2Nyb2xsIGV2ZW50XG4gICAgICAgICAgICB2bC5oYW5kbGVTY3JvbGwgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIHZsLnJlbmRlcigpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIC8vIEhhbmRsZSByZXNpemUgZXZlbnRcbiAgICAgICAgICAgIHZsLmhhbmRsZVJlc2l6ZSA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgdmwuc2V0TGlzdFNpemUoKTtcbiAgICAgICAgICAgICAgICB2bC5yZW5kZXIodHJ1ZSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIHZsLmF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uIChkZXRhY2gpIHtcbiAgICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gZGV0YWNoID8gJ29mZicgOiAnb24nO1xuICAgICAgICAgICAgICAgIHZsLnBhZ2VDb250ZW50W2FjdGlvbl0oJ3Njcm9sbCcsIHZsLmhhbmRsZVNjcm9sbCk7XG4gICAgICAgICAgICAgICAgdmwubGlzdEJsb2NrLnBhcmVudHMoJy50YWInKS5lcSgwKVthY3Rpb25dKCdzaG93JywgdmwuaGFuZGxlUmVzaXplKTtcbiAgICAgICAgICAgICAgICAkKHdpbmRvdylbYWN0aW9uXSgncmVzaXplJywgdmwuaGFuZGxlUmVzaXplKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBWaXJ0dWFsIExpc3RcbiAgICAgICAgICAgIHZsLmluaXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmwuYXR0YWNoRXZlbnRzKCk7XG4gICAgICAgICAgICAgICAgdmwuc2V0TGlzdFNpemUoKTtcbiAgICAgICAgICAgICAgICB2bC5yZW5kZXIoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQXBwZW5kXG4gICAgICAgICAgICB2bC5hcHBlbmRJdGVtcyA9IGZ1bmN0aW9uIChpdGVtcykge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmwuaXRlbXMucHVzaChpdGVtc1tpXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZsLnVwZGF0ZSgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZsLmFwcGVuZEl0ZW0gPSBmdW5jdGlvbiAoaXRlbSkge1xuICAgICAgICAgICAgICAgIHZsLmFwcGVuZEl0ZW1zKFtpdGVtXSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgLy8gUmVwbGFjZVxuICAgICAgICAgICAgdmwucmVwbGFjZUFsbEl0ZW1zID0gZnVuY3Rpb24gKGl0ZW1zKSB7XG4gICAgICAgICAgICAgICAgdmwuaXRlbXMgPSBpdGVtcztcbiAgICAgICAgICAgICAgICBkZWxldGUgdmwuZmlsdGVyZWRJdGVtcztcbiAgICAgICAgICAgICAgICB2bC5kb21DYWNoZSA9IHt9O1xuICAgICAgICAgICAgICAgIHZsLnVwZGF0ZSgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZsLnJlcGxhY2VJdGVtID0gZnVuY3Rpb24gKGluZGV4LCBpdGVtKSB7XG4gICAgICAgICAgICAgICAgdmwuaXRlbXNbaW5kZXhdID0gaXRlbTtcbiAgICAgICAgICAgICAgICBpZiAodmwucGFyYW1zLmNhY2hlKSBkZWxldGUgdmwuZG9tQ2FjaGVbaW5kZXhdO1xuICAgICAgICAgICAgICAgIHZsLnVwZGF0ZSgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIC8vIFByZXBlbmRcbiAgICAgICAgICAgIHZsLnByZXBlbmRJdGVtcyA9IGZ1bmN0aW9uIChpdGVtcykge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSBpdGVtcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICAgICAgICAgICAgICB2bC5pdGVtcy51bnNoaWZ0KGl0ZW1zW2ldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHZsLnBhcmFtcy5jYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3Q2FjaGUgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgY2FjaGVkIGluIHZsLmRvbUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdDYWNoZVtwYXJzZUludChjYWNoZWQsIDEwKSArIGl0ZW1zLmxlbmd0aF0gPSB2bC5kb21DYWNoZVtjYWNoZWRdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZsLmRvbUNhY2hlID0gbmV3Q2FjaGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZsLnVwZGF0ZSgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZsLnByZXBlbmRJdGVtID0gZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICAgICAgICAgICAgICB2bC5wcmVwZW5kSXRlbXMoW2l0ZW1dKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gTW92ZVxuICAgICAgICAgICAgdmwubW92ZUl0ZW0gPSBmdW5jdGlvbiAob2xkSW5kZXgsIG5ld0luZGV4KSB7XG4gICAgICAgICAgICAgICAgaWYgKG9sZEluZGV4ID09PSBuZXdJbmRleCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIC8vIHJlbW92ZSBpdGVtIGZyb20gYXJyYXlcbiAgICAgICAgICAgICAgICB2YXIgaXRlbSA9IHZsLml0ZW1zLnNwbGljZShvbGRJbmRleCwgMSlbMF07XG4gICAgICAgICAgICAgICAgaWYgKG5ld0luZGV4ID49IHZsLml0ZW1zLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBBZGQgaXRlbSB0byB0aGUgZW5kXG4gICAgICAgICAgICAgICAgICAgIHZsLml0ZW1zLnB1c2goaXRlbSk7XG4gICAgICAgICAgICAgICAgICAgIG5ld0luZGV4ID0gdmwuaXRlbXMubGVuZ3RoIC0gMTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEFkZCBpdGVtIHRvIG5ldyBpbmRleFxuICAgICAgICAgICAgICAgICAgICB2bC5pdGVtcy5zcGxpY2UobmV3SW5kZXgsIDAsIGl0ZW0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgY2FjaGVcbiAgICAgICAgICAgICAgICBpZiAodmwucGFyYW1zLmNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdDYWNoZSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBjYWNoZWQgaW4gdmwuZG9tQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWNoZWRJbmRleCA9IHBhcnNlSW50KGNhY2hlZCwgMTApO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxlZnRJbmRleCA9IG9sZEluZGV4IDwgbmV3SW5kZXggPyBvbGRJbmRleCA6IG5ld0luZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJpZ2h0SW5kZXggPSBvbGRJbmRleCA8IG5ld0luZGV4ID8gbmV3SW5kZXggOiBvbGRJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbmRleFNoaWZ0ID0gb2xkSW5kZXggPCBuZXdJbmRleCA/IC0xIDogMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZWRJbmRleCA8IGxlZnRJbmRleCB8fCBjYWNoZWRJbmRleCA+IHJpZ2h0SW5kZXgpIG5ld0NhY2hlW2NhY2hlZEluZGV4XSA9IHZsLmRvbUNhY2hlW2NhY2hlZEluZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZWRJbmRleCA9PT0gbGVmdEluZGV4KSBuZXdDYWNoZVtyaWdodEluZGV4XSA9IHZsLmRvbUNhY2hlW2NhY2hlZEluZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZWRJbmRleCA+IGxlZnRJbmRleCAmJiBjYWNoZWRJbmRleCA8PSByaWdodEluZGV4KSBuZXdDYWNoZVtjYWNoZWRJbmRleCArIGluZGV4U2hpZnRdID0gdmwuZG9tQ2FjaGVbY2FjaGVkSW5kZXhdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZsLmRvbUNhY2hlID0gbmV3Q2FjaGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZsLnVwZGF0ZSgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIC8vIEluc2VydCBiZWZvcmVcbiAgICAgICAgICAgIHZsLmluc2VydEl0ZW1CZWZvcmUgPSBmdW5jdGlvbiAoaW5kZXgsIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmwucHJlcGVuZEl0ZW0oaXRlbSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID49IHZsLml0ZW1zLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICB2bC5hcHBlbmRJdGVtKGl0ZW0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZsLml0ZW1zLnNwbGljZShpbmRleCwgMCwgaXRlbSk7XG4gICAgICAgICAgICAgICAgLy8gVXBkYXRlIGNhY2hlXG4gICAgICAgICAgICAgICAgaWYgKHZsLnBhcmFtcy5jYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3Q2FjaGUgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgY2FjaGVkIGluIHZsLmRvbUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2FjaGVkSW5kZXggPSBwYXJzZUludChjYWNoZWQsIDEwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZWRJbmRleCA+PSBpbmRleCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0NhY2hlW2NhY2hlZEluZGV4ICsgMV0gPSB2bC5kb21DYWNoZVtjYWNoZWRJbmRleF07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmwuZG9tQ2FjaGUgPSBuZXdDYWNoZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmwudXBkYXRlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgLy8gRGVsZXRlXG4gICAgICAgICAgICB2bC5kZWxldGVJdGVtcyA9IGZ1bmN0aW9uIChpbmRleGVzKSB7XG4gICAgICAgICAgICAgICAgdmFyIHByZXZJbmRleCwgaW5kZXhTaGlmdCA9IDA7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpbmRleGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IGluZGV4ZXNbaV07XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJldkluZGV4ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gcHJldkluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhTaGlmdCA9IC1pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGluZGV4ID0gaW5kZXggKyBpbmRleFNoaWZ0O1xuICAgICAgICAgICAgICAgICAgICBwcmV2SW5kZXggPSBpbmRleGVzW2ldO1xuICAgICAgICAgICAgICAgICAgICAvLyBEZWxldGUgaXRlbVxuICAgICAgICAgICAgICAgICAgICB2YXIgZGVsZXRlZEl0ZW0gPSB2bC5pdGVtcy5zcGxpY2UoaW5kZXgsIDEpWzBdO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gRGVsZXRlIGZyb20gZmlsdGVyZWRcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZsLmZpbHRlcmVkSXRlbXMgJiYgdmwuZmlsdGVyZWRJdGVtcy5pbmRleE9mKGRlbGV0ZWRJdGVtKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2bC5maWx0ZXJlZEl0ZW1zLnNwbGljZSh2bC5maWx0ZXJlZEl0ZW1zLmluZGV4T2YoZGVsZXRlZEl0ZW0pLCAxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgY2FjaGVcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZsLnBhcmFtcy5jYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5ld0NhY2hlID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBjYWNoZWQgaW4gdmwuZG9tQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2FjaGVkSW5kZXggPSBwYXJzZUludChjYWNoZWQsIDEwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FjaGVkSW5kZXggPT09IGluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB2bC5kb21DYWNoZVtpbmRleF07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHBhcnNlSW50KGNhY2hlZCwgMTApID4gaW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3Q2FjaGVbY2FjaGVkSW5kZXggLSAxXSA9IHZsLmRvbUNhY2hlW2NhY2hlZF07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdDYWNoZVtjYWNoZWRJbmRleF0gPSB2bC5kb21DYWNoZVtjYWNoZWRdOyAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHZsLmRvbUNhY2hlID0gbmV3Q2FjaGU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmwudXBkYXRlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdmwuZGVsZXRlQWxsSXRlbXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmwuaXRlbXMgPSBbXTtcbiAgICAgICAgICAgICAgICBkZWxldGUgdmwuZmlsdGVyZWRJdGVtcztcbiAgICAgICAgICAgICAgICBpZiAodmwucGFyYW1zLmNhY2hlKSB2bC5kb21DYWNoZSA9IHt9O1xuICAgICAgICAgICAgICAgIHZsLnVwZGF0ZSgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZsLmRlbGV0ZUl0ZW0gPSBmdW5jdGlvbiAoaW5kZXgpIHtcbiAgICAgICAgICAgICAgICB2bC5kZWxldGVJdGVtcyhbaW5kZXhdKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ2xlYXIgY2FjaGVcbiAgICAgICAgICAgIHZsLmNsZWFyQ2FjaGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmwuZG9tQ2FjaGUgPSB7fTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVXBkYXRlIFZpcnR1YWwgTGlzdFxuICAgICAgICAgICAgdmwudXBkYXRlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZsLnNldExpc3RTaXplKCk7XG4gICAgICAgICAgICAgICAgdmwucmVuZGVyKHRydWUpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBEZXN0cm95XG4gICAgICAgICAgICB2bC5kZXN0cm95ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZsLmF0dGFjaEV2ZW50cyh0cnVlKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgdmwuaXRlbXM7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHZsLmRvbUNhY2hlO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0IFZpcnR1YWwgTGlzdFxuICAgICAgICAgICAgdmwuaW5pdCgpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFN0b3JlIHZsIGluIGNvbnRhaW5lclxuICAgICAgICAgICAgdmwubGlzdEJsb2NrWzBdLmY3VmlydHVhbExpc3QgPSB2bDtcbiAgICAgICAgICAgIHJldHVybiB2bDtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8vIEFwcCBNZXRob2RcbiAgICAgICAgYXBwLnZpcnR1YWxMaXN0ID0gZnVuY3Rpb24gKGxpc3RCbG9jaywgcGFyYW1zKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFZpcnR1YWxMaXN0KGxpc3RCbG9jaywgcGFyYW1zKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGFwcC5yZWluaXRWaXJ0dWFsTGlzdCA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICB2YXIgcGFnZSA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICB2YXIgdmxpc3RzID0gcGFnZS5maW5kKCcudmlydHVhbC1saXN0Jyk7XG4gICAgICAgICAgICBpZiAodmxpc3RzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2bGlzdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgdmxpc3RJbnN0YW5jZSA9IHZsaXN0c1tpXS5mN1ZpcnR1YWxMaXN0O1xuICAgICAgICAgICAgICAgIGlmICh2bGlzdEluc3RhbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZsaXN0SW5zdGFuY2UudXBkYXRlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIFB1bGwgVG8gUmVmcmVzaCAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAuaW5pdFB1bGxUb1JlZnJlc2ggPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgdmFyIGV2ZW50c1RhcmdldCA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICBpZiAoIWV2ZW50c1RhcmdldC5oYXNDbGFzcygncHVsbC10by1yZWZyZXNoLWNvbnRlbnQnKSkge1xuICAgICAgICAgICAgICAgIGV2ZW50c1RhcmdldCA9IGV2ZW50c1RhcmdldC5maW5kKCcucHVsbC10by1yZWZyZXNoLWNvbnRlbnQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghZXZlbnRzVGFyZ2V0IHx8IGV2ZW50c1RhcmdldC5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgdG91Y2hJZCwgaXNUb3VjaGVkLCBpc01vdmVkLCB0b3VjaGVzU3RhcnQgPSB7fSwgaXNTY3JvbGxpbmcsIHRvdWNoZXNEaWZmLCB0b3VjaFN0YXJ0VGltZSwgY29udGFpbmVyLCByZWZyZXNoID0gZmFsc2UsIHVzZVRyYW5zbGF0ZSA9IGZhbHNlLCBzdGFydFRyYW5zbGF0ZSA9IDAsIHRyYW5zbGF0ZSwgc2Nyb2xsVG9wLCB3YXNTY3JvbGxlZCwgbGF5ZXIsIHRyaWdnZXJEaXN0YW5jZSwgZHluYW1pY1RyaWdnZXJEaXN0YW5jZSwgcHVsbFN0YXJ0ZWQ7XG4gICAgICAgICAgICB2YXIgcGFnZSA9IGV2ZW50c1RhcmdldC5oYXNDbGFzcygncGFnZScpID8gZXZlbnRzVGFyZ2V0IDogZXZlbnRzVGFyZ2V0LnBhcmVudHMoJy5wYWdlJyk7XG4gICAgICAgICAgICB2YXIgaGFzTmF2YmFyID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAocGFnZS5maW5kKCcubmF2YmFyJykubGVuZ3RoID4gMCB8fCBwYWdlLnBhcmVudHMoJy5uYXZiYXItZml4ZWQsIC5uYXZiYXItdGhyb3VnaCcpLmxlbmd0aCA+IDAgfHwgcGFnZS5oYXNDbGFzcygnbmF2YmFyLWZpeGVkJykgfHwgcGFnZS5oYXNDbGFzcygnbmF2YmFyLXRocm91Z2gnKSkgaGFzTmF2YmFyID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmIChwYWdlLmhhc0NsYXNzKCduby1uYXZiYXInKSkgaGFzTmF2YmFyID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAoIWhhc05hdmJhcikgZXZlbnRzVGFyZ2V0LmFkZENsYXNzKCdwdWxsLXRvLXJlZnJlc2gtbm8tbmF2YmFyJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgY29udGFpbmVyID0gZXZlbnRzVGFyZ2V0O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIERlZmluZSB0cmlnZ2VyIGRpc3RhbmNlXG4gICAgICAgICAgICBpZiAoY29udGFpbmVyLmF0dHIoJ2RhdGEtcHRyLWRpc3RhbmNlJykpIHtcbiAgICAgICAgICAgICAgICBkeW5hbWljVHJpZ2dlckRpc3RhbmNlID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRyaWdnZXJEaXN0YW5jZSA9IDQ0OyAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoaXNUb3VjaGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLm9zID09PSAnYW5kcm9pZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgndGFyZ2V0VG91Y2hlcycgaW4gZSAmJiBlLnRhcmdldFRvdWNoZXMubGVuZ3RoID4gMSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqL1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lciA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5oYXNDbGFzcygncmVmcmVzaGluZycpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHB1bGxTdGFydGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpc1Njcm9sbGluZyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB3YXNTY3JvbGxlZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBpZiAoZS50eXBlID09PSAndG91Y2hzdGFydCcpIHRvdWNoSWQgPSBlLnRhcmdldFRvdWNoZXNbMF0uaWRlbnRpZmllcjtcbiAgICAgICAgICAgICAgICB0b3VjaGVzU3RhcnQueCA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZS5wYWdlWDtcbiAgICAgICAgICAgICAgICB0b3VjaGVzU3RhcnQueSA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICB0b3VjaFN0YXJ0VGltZSA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZShlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFpc1RvdWNoZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgcGFnZVgsIHBhZ2VZLCB0b3VjaDtcbiAgICAgICAgICAgICAgICBpZiAoZS50eXBlID09PSAndG91Y2htb3ZlJykge1xuICAgICAgICAgICAgICAgICAgICBpZiAodG91Y2hJZCAmJiBlLnRvdWNoZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZS50b3VjaGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUudG91Y2hlc1tpXS5pZGVudGlmaWVyID09PSB0b3VjaElkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvdWNoID0gZS50b3VjaGVzW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRvdWNoKSB0b3VjaCA9IGUudGFyZ2V0VG91Y2hlc1swXTtcbiAgICAgICAgICAgICAgICAgICAgcGFnZVggPSB0b3VjaC5wYWdlWDtcbiAgICAgICAgICAgICAgICAgICAgcGFnZVkgPSB0b3VjaC5wYWdlWTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VYID0gZS5wYWdlWDtcbiAgICAgICAgICAgICAgICAgICAgcGFnZVkgPSBlLnBhZ2VZO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIXBhZ2VYIHx8ICFwYWdlWSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpc1Njcm9sbGluZyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNTY3JvbGxpbmcgPSAhIShpc1Njcm9sbGluZyB8fCBNYXRoLmFicyhwYWdlWSAtIHRvdWNoZXNTdGFydC55KSA+IE1hdGguYWJzKHBhZ2VYIC0gdG91Y2hlc1N0YXJ0LngpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFpc1Njcm9sbGluZykge1xuICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgc2Nyb2xsVG9wID0gY29udGFpbmVyWzBdLnNjcm9sbFRvcDtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHdhc1Njcm9sbGVkID09PSAndW5kZWZpbmVkJyAmJiBzY3JvbGxUb3AgIT09IDApIHdhc1Njcm9sbGVkID0gdHJ1ZTsgXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICghaXNNb3ZlZCkge1xuICAgICAgICAgICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqL1xuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIucmVtb3ZlQ2xhc3MoJ3RyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNjcm9sbFRvcCA+IGNvbnRhaW5lclswXS5vZmZzZXRIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChkeW5hbWljVHJpZ2dlckRpc3RhbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmlnZ2VyRGlzdGFuY2UgPSBjb250YWluZXIuYXR0cignZGF0YS1wdHItZGlzdGFuY2UnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmlnZ2VyRGlzdGFuY2UuaW5kZXhPZignJScpID49IDApIHRyaWdnZXJEaXN0YW5jZSA9IGNvbnRhaW5lclswXS5vZmZzZXRIZWlnaHQgKiBwYXJzZUludCh0cmlnZ2VyRGlzdGFuY2UsIDEwKSAvIDEwMDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzdGFydFRyYW5zbGF0ZSA9IGNvbnRhaW5lci5oYXNDbGFzcygncmVmcmVzaGluZycpID8gdHJpZ2dlckRpc3RhbmNlIDogMDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lclswXS5zY3JvbGxIZWlnaHQgPT09IGNvbnRhaW5lclswXS5vZmZzZXRIZWlnaHQgfHwgYXBwLmRldmljZS5vcyAhPT0gJ2lvcycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZVRyYW5zbGF0ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VUcmFuc2xhdGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpc01vdmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0b3VjaGVzRGlmZiA9IHBhZ2VZIC0gdG91Y2hlc1N0YXJ0Lnk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHRvdWNoZXNEaWZmID4gMCAmJiBzY3JvbGxUb3AgPD0gMCB8fCBzY3JvbGxUb3AgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIGlPUyA4IGZpeFxuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5vcyA9PT0gJ2lvcycgJiYgcGFyc2VJbnQoYXBwLmRldmljZS5vc1ZlcnNpb24uc3BsaXQoJy4nKVswXSwgMTApID4gNyAmJiBzY3JvbGxUb3AgPT09IDAgJiYgIXdhc1Njcm9sbGVkKSB1c2VUcmFuc2xhdGUgPSB0cnVlO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVzZVRyYW5zbGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlID0gKE1hdGgucG93KHRvdWNoZXNEaWZmLCAwLjg1KSArIHN0YXJ0VHJhbnNsYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDAsJyArIHRyYW5zbGF0ZSArICdweCwwKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICgodXNlVHJhbnNsYXRlICYmIE1hdGgucG93KHRvdWNoZXNEaWZmLCAwLjg1KSA+IHRyaWdnZXJEaXN0YW5jZSkgfHwgKCF1c2VUcmFuc2xhdGUgJiYgdG91Y2hlc0RpZmYgPj0gdHJpZ2dlckRpc3RhbmNlICogMikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlZnJlc2ggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmFkZENsYXNzKCdwdWxsLXVwJykucmVtb3ZlQ2xhc3MoJ3B1bGwtZG93bicpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVmcmVzaCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnJlbW92ZUNsYXNzKCdwdWxsLXVwJykuYWRkQ2xhc3MoJ3B1bGwtZG93bicpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghcHVsbFN0YXJ0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci50cmlnZ2VyKCdwdWxsc3RhcnQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHB1bGxTdGFydGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIudHJpZ2dlcigncHVsbG1vdmUnLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudDogZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbFRvcDogc2Nyb2xsVG9wLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlOiB0cmFuc2xhdGUsXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3VjaGVzRGlmZjogdG91Y2hlc0RpZmZcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwdWxsU3RhcnRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIucmVtb3ZlQ2xhc3MoJ3B1bGwtdXAgcHVsbC1kb3duJyk7XG4gICAgICAgICAgICAgICAgICAgIHJlZnJlc2ggPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoRW5kKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoZS50eXBlID09PSAndG91Y2hlbmQnICYmIGUuY2hhbmdlZFRvdWNoZXMgJiYgZS5jaGFuZ2VkVG91Y2hlcy5sZW5ndGggPiAwICYmIHRvdWNoSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGUuY2hhbmdlZFRvdWNoZXNbMF0uaWRlbnRpZmllciAhPT0gdG91Y2hJZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWlzVG91Y2hlZCB8fCAhaXNNb3ZlZCkge1xuICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmFkZENsYXNzKCd0cmFuc2l0aW9uaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZSA9IDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnRhaW5lci50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgICAgIGlmIChyZWZyZXNoKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5hZGRDbGFzcygncmVmcmVzaGluZycpO1xuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIudHJpZ2dlcigncmVmcmVzaCcsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAucHVsbFRvUmVmcmVzaERvbmUoY29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIucmVtb3ZlQ2xhc3MoJ3B1bGwtZG93bicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKHB1bGxTdGFydGVkKSBjb250YWluZXIudHJpZ2dlcigncHVsbGVuZCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIEF0dGFjaCBFdmVudHNcbiAgICAgICAgICAgIGV2ZW50c1RhcmdldC5vbihhcHAudG91Y2hFdmVudHMuc3RhcnQsIGhhbmRsZVRvdWNoU3RhcnQpO1xuICAgICAgICAgICAgZXZlbnRzVGFyZ2V0Lm9uKGFwcC50b3VjaEV2ZW50cy5tb3ZlLCBoYW5kbGVUb3VjaE1vdmUpO1xuICAgICAgICAgICAgZXZlbnRzVGFyZ2V0Lm9uKGFwcC50b3VjaEV2ZW50cy5lbmQsIGhhbmRsZVRvdWNoRW5kKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBEZXRhY2ggRXZlbnRzIG9uIHBhZ2UgcmVtb3ZlXG4gICAgICAgICAgICBpZiAocGFnZS5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIGZ1bmN0aW9uIGRlc3Ryb3lQdWxsVG9SZWZyZXNoKCkge1xuICAgICAgICAgICAgICAgIGV2ZW50c1RhcmdldC5vZmYoYXBwLnRvdWNoRXZlbnRzLnN0YXJ0LCBoYW5kbGVUb3VjaFN0YXJ0KTtcbiAgICAgICAgICAgICAgICBldmVudHNUYXJnZXQub2ZmKGFwcC50b3VjaEV2ZW50cy5tb3ZlLCBoYW5kbGVUb3VjaE1vdmUpO1xuICAgICAgICAgICAgICAgIGV2ZW50c1RhcmdldC5vZmYoYXBwLnRvdWNoRXZlbnRzLmVuZCwgaGFuZGxlVG91Y2hFbmQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZXZlbnRzVGFyZ2V0WzBdLmY3RGVzdHJveVB1bGxUb1JlZnJlc2ggPSBkZXN0cm95UHVsbFRvUmVmcmVzaDtcbiAgICAgICAgICAgIGZ1bmN0aW9uIGRldGFjaEV2ZW50cygpIHtcbiAgICAgICAgICAgICAgICBkZXN0cm95UHVsbFRvUmVmcmVzaCgpO1xuICAgICAgICAgICAgICAgIHBhZ2Uub2ZmKCdwYWdlQmVmb3JlUmVtb3ZlJywgZGV0YWNoRXZlbnRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBhZ2Uub24oJ3BhZ2VCZWZvcmVSZW1vdmUnLCBkZXRhY2hFdmVudHMpO1xuICAgICAgICBcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGFwcC5wdWxsVG9SZWZyZXNoRG9uZSA9IGZ1bmN0aW9uIChjb250YWluZXIpIHtcbiAgICAgICAgICAgIGNvbnRhaW5lciA9ICQoY29udGFpbmVyKTtcbiAgICAgICAgICAgIGlmIChjb250YWluZXIubGVuZ3RoID09PSAwKSBjb250YWluZXIgPSAkKCcucHVsbC10by1yZWZyZXNoLWNvbnRlbnQucmVmcmVzaGluZycpO1xuICAgICAgICAgICAgY29udGFpbmVyLnJlbW92ZUNsYXNzKCdyZWZyZXNoaW5nJykuYWRkQ2xhc3MoJ3RyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgICAgIGNvbnRhaW5lci50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBjb250YWluZXIucmVtb3ZlQ2xhc3MoJ3RyYW5zaXRpb25pbmcgcHVsbC11cCBwdWxsLWRvd24nKTtcbiAgICAgICAgICAgICAgICBjb250YWluZXIudHJpZ2dlcigncmVmcmVzaGRvbmUnKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICBhcHAucHVsbFRvUmVmcmVzaFRyaWdnZXIgPSBmdW5jdGlvbiAoY29udGFpbmVyKSB7XG4gICAgICAgICAgICBjb250YWluZXIgPSAkKGNvbnRhaW5lcik7XG4gICAgICAgICAgICBpZiAoY29udGFpbmVyLmxlbmd0aCA9PT0gMCkgY29udGFpbmVyID0gJCgnLnB1bGwtdG8tcmVmcmVzaC1jb250ZW50Jyk7XG4gICAgICAgICAgICBpZiAoY29udGFpbmVyLmhhc0NsYXNzKCdyZWZyZXNoaW5nJykpIHJldHVybjtcbiAgICAgICAgICAgIGNvbnRhaW5lci5hZGRDbGFzcygndHJhbnNpdGlvbmluZyByZWZyZXNoaW5nJyk7XG4gICAgICAgICAgICBjb250YWluZXIudHJpZ2dlcigncmVmcmVzaCcsIHtcbiAgICAgICAgICAgICAgICBkb25lOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5wdWxsVG9SZWZyZXNoRG9uZShjb250YWluZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgYXBwLmRlc3Ryb3lQdWxsVG9SZWZyZXNoID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgdmFyIHB1bGxUb1JlZnJlc2hDb250ZW50ID0gcGFnZUNvbnRhaW5lci5oYXNDbGFzcygncHVsbC10by1yZWZyZXNoLWNvbnRlbnQnKSA/IHBhZ2VDb250YWluZXIgOiBwYWdlQ29udGFpbmVyLmZpbmQoJy5wdWxsLXRvLXJlZnJlc2gtY29udGVudCcpO1xuICAgICAgICAgICAgaWYgKHB1bGxUb1JlZnJlc2hDb250ZW50Lmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKHB1bGxUb1JlZnJlc2hDb250ZW50WzBdLmY3RGVzdHJveVB1bGxUb1JlZnJlc2gpIHB1bGxUb1JlZnJlc2hDb250ZW50WzBdLmY3RGVzdHJveVB1bGxUb1JlZnJlc2goKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG5cbiAgICAgICAgLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBJbmZpbml0ZSBTY3JvbGwgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqL1xuICAgICAgICBmdW5jdGlvbiBoYW5kbGVJbmZpbml0ZVNjcm9sbCgpIHtcbiAgICAgICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovXG4gICAgICAgICAgICB2YXIgaW5mID0gJCh0aGlzKTtcbiAgICAgICAgICAgIHZhciBzY3JvbGxUb3AgPSBpbmZbMF0uc2Nyb2xsVG9wO1xuICAgICAgICAgICAgdmFyIHNjcm9sbEhlaWdodCA9IGluZlswXS5zY3JvbGxIZWlnaHQ7XG4gICAgICAgICAgICB2YXIgaGVpZ2h0ID0gaW5mWzBdLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgIHZhciBkaXN0YW5jZSA9IGluZlswXS5nZXRBdHRyaWJ1dGUoJ2RhdGEtZGlzdGFuY2UnKTtcbiAgICAgICAgICAgIHZhciB2aXJ0dWFsTGlzdENvbnRhaW5lciA9IGluZi5maW5kKCcudmlydHVhbC1saXN0Jyk7XG4gICAgICAgICAgICB2YXIgdmlydHVhbExpc3Q7XG4gICAgICAgICAgICB2YXIgb25Ub3AgPSBpbmYuaGFzQ2xhc3MoJ2luZmluaXRlLXNjcm9sbC10b3AnKTtcbiAgICAgICAgICAgIGlmICghZGlzdGFuY2UpIGRpc3RhbmNlID0gNTA7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGRpc3RhbmNlID09PSAnc3RyaW5nJyAmJiBkaXN0YW5jZS5pbmRleE9mKCclJykgPj0gMCkge1xuICAgICAgICAgICAgICAgIGRpc3RhbmNlID0gcGFyc2VJbnQoZGlzdGFuY2UsIDEwKSAvIDEwMCAqIGhlaWdodDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChkaXN0YW5jZSA+IGhlaWdodCkgZGlzdGFuY2UgPSBoZWlnaHQ7XG4gICAgICAgICAgICBpZiAob25Ub3ApIHtcbiAgICAgICAgICAgICAgICBpZiAoc2Nyb2xsVG9wIDwgZGlzdGFuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgaW5mLnRyaWdnZXIoJ2luZmluaXRlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHNjcm9sbFRvcCArIGhlaWdodCA+PSBzY3JvbGxIZWlnaHQgLSBkaXN0YW5jZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodmlydHVhbExpc3RDb250YWluZXIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmlydHVhbExpc3QgPSB2aXJ0dWFsTGlzdENvbnRhaW5lclswXS5mN1ZpcnR1YWxMaXN0O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpcnR1YWxMaXN0ICYmICF2aXJ0dWFsTGlzdC5yZWFjaEVuZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGluZi50cmlnZ2VyKCdpbmZpbml0ZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgYXBwLmF0dGFjaEluZmluaXRlU2Nyb2xsID0gZnVuY3Rpb24gKGluZmluaXRlQ29udGVudCkge1xuICAgICAgICAgICAgJChpbmZpbml0ZUNvbnRlbnQpLm9uKCdzY3JvbGwnLCBoYW5kbGVJbmZpbml0ZVNjcm9sbCk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5kZXRhY2hJbmZpbml0ZVNjcm9sbCA9IGZ1bmN0aW9uIChpbmZpbml0ZUNvbnRlbnQpIHtcbiAgICAgICAgICAgICQoaW5maW5pdGVDb250ZW50KS5vZmYoJ3Njcm9sbCcsIGhhbmRsZUluZmluaXRlU2Nyb2xsKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGFwcC5pbml0UGFnZUluZmluaXRlU2Nyb2xsID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgdmFyIGluZmluaXRlQ29udGVudCA9IHBhZ2VDb250YWluZXIuZmluZCgnLmluZmluaXRlLXNjcm9sbCcpO1xuICAgICAgICAgICAgaWYgKGluZmluaXRlQ29udGVudC5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIGFwcC5hdHRhY2hJbmZpbml0ZVNjcm9sbChpbmZpbml0ZUNvbnRlbnQpO1xuICAgICAgICAgICAgZnVuY3Rpb24gZGV0YWNoRXZlbnRzKCkge1xuICAgICAgICAgICAgICAgIGFwcC5kZXRhY2hJbmZpbml0ZVNjcm9sbChpbmZpbml0ZUNvbnRlbnQpO1xuICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIub2ZmKCdwYWdlQmVmb3JlUmVtb3ZlJywgZGV0YWNoRXZlbnRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIub24oJ3BhZ2VCZWZvcmVSZW1vdmUnLCBkZXRhY2hFdmVudHMpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBIaWRlL3Nob3cgVG9vbGJhci9OYXZiYXIgb24gc2Nyb2xsICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAuaW5pdFBhZ2VTY3JvbGxUb29sYmFycyA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIHZhciBzY3JvbGxDb250ZW50ID0gcGFnZUNvbnRhaW5lci5maW5kKCcucGFnZS1jb250ZW50Jyk7XG4gICAgICAgICAgICBpZiAoc2Nyb2xsQ29udGVudC5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIHZhciBoaWRlTmF2YmFyID0gKGFwcC5wYXJhbXMuaGlkZU5hdmJhck9uUGFnZVNjcm9sbCB8fCBzY3JvbGxDb250ZW50Lmhhc0NsYXNzKCdoaWRlLW5hdmJhci1vbi1zY3JvbGwnKSB8fCBzY3JvbGxDb250ZW50Lmhhc0NsYXNzKCdoaWRlLWJhcnMtb24tc2Nyb2xsJykpICYmICEoc2Nyb2xsQ29udGVudC5oYXNDbGFzcygna2VlcC1uYXZiYXItb24tc2Nyb2xsJykgfHwgc2Nyb2xsQ29udGVudC5oYXNDbGFzcygna2VlcC1iYXJzLW9uLXNjcm9sbCcpKTtcbiAgICAgICAgICAgIHZhciBoaWRlVG9vbGJhciA9IChhcHAucGFyYW1zLmhpZGVUb29sYmFyT25QYWdlU2Nyb2xsIHx8IHNjcm9sbENvbnRlbnQuaGFzQ2xhc3MoJ2hpZGUtdG9vbGJhci1vbi1zY3JvbGwnKSB8fCBzY3JvbGxDb250ZW50Lmhhc0NsYXNzKCdoaWRlLWJhcnMtb24tc2Nyb2xsJykpICYmICEoc2Nyb2xsQ29udGVudC5oYXNDbGFzcygna2VlcC10b29sYmFyLW9uLXNjcm9sbCcpIHx8IHNjcm9sbENvbnRlbnQuaGFzQ2xhc3MoJ2tlZXAtYmFycy1vbi1zY3JvbGwnKSk7XG4gICAgICAgICAgICB2YXIgaGlkZVRhYmJhciA9IChhcHAucGFyYW1zLmhpZGVUYWJiYXJPblBhZ2VTY3JvbGwgfHwgc2Nyb2xsQ29udGVudC5oYXNDbGFzcygnaGlkZS10YWJiYXItb24tc2Nyb2xsJykpICYmICEoc2Nyb2xsQ29udGVudC5oYXNDbGFzcygna2VlcC10YWJiYXItb24tc2Nyb2xsJykpO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmICghKGhpZGVOYXZiYXIgfHwgaGlkZVRvb2xiYXIgfHwgaGlkZVRhYmJhcikpIHJldHVybjtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdmFyIHZpZXdDb250YWluZXIgPSBzY3JvbGxDb250ZW50LnBhcmVudHMoJy4nICsgYXBwLnBhcmFtcy52aWV3Q2xhc3MpO1xuICAgICAgICAgICAgaWYgKHZpZXdDb250YWluZXIubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIG5hdmJhciA9IHZpZXdDb250YWluZXIuZmluZCgnLm5hdmJhcicpLCBcbiAgICAgICAgICAgICAgICB0b29sYmFyID0gdmlld0NvbnRhaW5lci5maW5kKCcudG9vbGJhcicpLCBcbiAgICAgICAgICAgICAgICB0YWJiYXI7XG4gICAgICAgICAgICBpZiAoaGlkZVRhYmJhcikge1xuICAgICAgICAgICAgICAgIHRhYmJhciA9IHZpZXdDb250YWluZXIuZmluZCgnLnRhYmJhcicpO1xuICAgICAgICAgICAgICAgIGlmICh0YWJiYXIubGVuZ3RoID09PSAwKSB0YWJiYXIgPSB2aWV3Q29udGFpbmVyLnBhcmVudHMoJy4nICsgYXBwLnBhcmFtcy52aWV3c0NsYXNzKS5maW5kKCcudGFiYmFyJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIGhhc05hdmJhciA9IG5hdmJhci5sZW5ndGggPiAwLFxuICAgICAgICAgICAgICAgIGhhc1Rvb2xiYXIgPSB0b29sYmFyLmxlbmd0aCA+IDAsXG4gICAgICAgICAgICAgICAgaGFzVGFiYmFyID0gdGFiYmFyICYmIHRhYmJhci5sZW5ndGggPiAwO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBwcmV2aW91c1Njcm9sbCwgY3VycmVudFNjcm9sbDtcbiAgICAgICAgICAgICAgICBwcmV2aW91c1Njcm9sbCA9IGN1cnJlbnRTY3JvbGwgPSBzY3JvbGxDb250ZW50WzBdLnNjcm9sbFRvcDtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgc2Nyb2xsSGVpZ2h0LCBvZmZzZXRIZWlnaHQsIHJlYWNoRW5kLCBhY3Rpb24sIG5hdmJhckhpZGRlbiwgdG9vbGJhckhpZGRlbiwgdGFiYmFySGlkZGVuO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciB0b29sYmFySGVpZ2h0ID0gKGhhc1Rvb2xiYXIgJiYgaGlkZVRvb2xiYXIpID8gdG9vbGJhclswXS5vZmZzZXRIZWlnaHQgOiAwO1xuICAgICAgICAgICAgdmFyIHRhYmJhckhlaWdodCA9IChoYXNUYWJiYXIgJiYgaGlkZVRhYmJhcikgPyB0YWJiYXJbMF0ub2Zmc2V0SGVpZ2h0IDogMDtcbiAgICAgICAgICAgIHZhciBib3R0b21CYXJIZWlnaHQgPSB0YWJiYXJIZWlnaHQgfHwgdG9vbGJhckhlaWdodDtcbiAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVTY3JvbGwoZSkge1xuICAgICAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmhhc0NsYXNzKCdwYWdlLW9uLWxlZnQnKSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRTY3JvbGwgPSBzY3JvbGxDb250ZW50WzBdLnNjcm9sbFRvcDtcbiAgICAgICAgICAgICAgICBzY3JvbGxIZWlnaHQgPSBzY3JvbGxDb250ZW50WzBdLnNjcm9sbEhlaWdodDtcbiAgICAgICAgICAgICAgICBvZmZzZXRIZWlnaHQgPSBzY3JvbGxDb250ZW50WzBdLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgICAgICByZWFjaEVuZCA9ICBjdXJyZW50U2Nyb2xsICsgb2Zmc2V0SGVpZ2h0ID49IHNjcm9sbEhlaWdodCAtIGJvdHRvbUJhckhlaWdodDtcbiAgICAgICAgICAgICAgICBuYXZiYXJIaWRkZW4gPSBuYXZiYXIuaGFzQ2xhc3MoJ25hdmJhci1oaWRkZW4nKTtcbiAgICAgICAgICAgICAgICB0b29sYmFySGlkZGVuID0gdG9vbGJhci5oYXNDbGFzcygndG9vbGJhci1oaWRkZW4nKTtcbiAgICAgICAgICAgICAgICB0YWJiYXJIaWRkZW4gPSB0YWJiYXIgJiYgdGFiYmFyLmhhc0NsYXNzKCd0b29sYmFyLWhpZGRlbicpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocmVhY2hFbmQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuc2hvd0JhcnNPblBhZ2VTY3JvbGxFbmQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbiA9ICdzaG93JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChwcmV2aW91c1Njcm9sbCA+IGN1cnJlbnRTY3JvbGwpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuc2hvd0JhcnNPblBhZ2VTY3JvbGxUb3AgfHwgY3VycmVudFNjcm9sbCA8PSA0NCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gJ3Nob3cnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gJ2hpZGUnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFNjcm9sbCA+IDQ0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSAnaGlkZSc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSAnc2hvdyc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChhY3Rpb24gPT09ICdzaG93Jykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaGFzTmF2YmFyICYmIGhpZGVOYXZiYXIgJiYgbmF2YmFySGlkZGVuKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuc2hvd05hdmJhcihuYXZiYXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5yZW1vdmVDbGFzcygnbm8tbmF2YmFyLWJ5LXNjcm9sbCcpOyBcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hdmJhckhpZGRlbiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChoYXNUb29sYmFyICYmIGhpZGVUb29sYmFyICYmIHRvb2xiYXJIaWRkZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5zaG93VG9vbGJhcih0b29sYmFyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIucmVtb3ZlQ2xhc3MoJ25vLXRvb2xiYXItYnktc2Nyb2xsJyk7IFxuICAgICAgICAgICAgICAgICAgICAgICAgdG9vbGJhckhpZGRlbiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChoYXNUYWJiYXIgJiYgaGlkZVRhYmJhciAmJiB0YWJiYXJIaWRkZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5zaG93VG9vbGJhcih0YWJiYXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5yZW1vdmVDbGFzcygnbm8tdGFiYmFyLWJ5LXNjcm9sbCcpOyBcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmJhckhpZGRlbiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaGFzTmF2YmFyICYmIGhpZGVOYXZiYXIgJiYgIW5hdmJhckhpZGRlbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmhpZGVOYXZiYXIobmF2YmFyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIuYWRkQ2xhc3MoJ25vLW5hdmJhci1ieS1zY3JvbGwnKTsgXG4gICAgICAgICAgICAgICAgICAgICAgICBuYXZiYXJIaWRkZW4gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChoYXNUb29sYmFyICYmIGhpZGVUb29sYmFyICYmICF0b29sYmFySGlkZGVuKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuaGlkZVRvb2xiYXIodG9vbGJhcik7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyLmFkZENsYXNzKCduby10b29sYmFyLWJ5LXNjcm9sbCcpOyBcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvb2xiYXJIaWRkZW4gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChoYXNUYWJiYXIgJiYgaGlkZVRhYmJhciAmJiAhdGFiYmFySGlkZGVuKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuaGlkZVRvb2xiYXIodGFiYmFyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIuYWRkQ2xhc3MoJ25vLXRhYmJhci1ieS1zY3JvbGwnKTsgXG4gICAgICAgICAgICAgICAgICAgICAgICB0YWJiYXJIaWRkZW4gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBwcmV2aW91c1Njcm9sbCA9IGN1cnJlbnRTY3JvbGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzY3JvbGxDb250ZW50Lm9uKCdzY3JvbGwnLCBoYW5kbGVTY3JvbGwpO1xuICAgICAgICAgICAgc2Nyb2xsQ29udGVudFswXS5mN1Njcm9sbFRvb2xiYXJzSGFuZGxlciA9IGhhbmRsZVNjcm9sbDtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmRlc3Ryb3lTY3JvbGxUb29sYmFycyA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIHZhciBzY3JvbGxDb250ZW50ID0gcGFnZUNvbnRhaW5lci5maW5kKCcucGFnZS1jb250ZW50Jyk7XG4gICAgICAgICAgICBpZiAoc2Nyb2xsQ29udGVudC5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIHZhciBoYW5kbGVyID0gc2Nyb2xsQ29udGVudFswXS5mN1Njcm9sbFRvb2xiYXJzSGFuZGxlcjtcbiAgICAgICAgICAgIGlmICghaGFuZGxlcikgcmV0dXJuO1xuICAgICAgICAgICAgc2Nyb2xsQ29udGVudC5vZmYoJ3Njcm9sbCcsIHNjcm9sbENvbnRlbnRbMF0uZjdTY3JvbGxUb29sYmFyc0hhbmRsZXIpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIE1hdGVyaWFsIFRhYmJhciAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAubWF0ZXJpYWxUYWJiYXJTZXRIaWdobGlnaHQgPSBmdW5jdGlvbiAodGFiYmFyLCBhY3RpdmVMaW5rKSB7XG4gICAgICAgICAgICB0YWJiYXIgPSAkKHRhYmJhcik7XG4gICAgICAgICAgICBhY3RpdmVMaW5rID0gYWN0aXZlTGluayB8fCB0YWJiYXIuZmluZCgnLnRhYi1saW5rLmFjdGl2ZScpO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciB0YWJMaW5rV2lkdGgsIGhpZ2hsaWdodFRyYW5zbGF0ZTtcbiAgICAgICAgICAgIGlmICh0YWJiYXIuaGFzQ2xhc3MoJ3RhYmJhci1zY3JvbGxhYmxlJykpIHtcbiAgICAgICAgICAgICAgICB0YWJMaW5rV2lkdGggPSBhY3RpdmVMaW5rWzBdLm9mZnNldFdpZHRoICsgJ3B4JztcbiAgICAgICAgICAgICAgICBoaWdobGlnaHRUcmFuc2xhdGUgPSAoYXBwLnJ0bCA/IC0gYWN0aXZlTGlua1swXS5vZmZzZXRMZWZ0OiBhY3RpdmVMaW5rWzBdLm9mZnNldExlZnQpICsgJ3B4JztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRhYkxpbmtXaWR0aCA9IDEgLyB0YWJiYXIuZmluZCgnLnRhYi1saW5rJykubGVuZ3RoICogMTAwICsgJyUnO1xuICAgICAgICAgICAgICAgIGhpZ2hsaWdodFRyYW5zbGF0ZSA9IChhcHAucnRsID8gLSBhY3RpdmVMaW5rLmluZGV4KCk6IGFjdGl2ZUxpbmsuaW5kZXgoKSkgKiAxMDAgKyAnJSc7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgdGFiYmFyLmZpbmQoJy50YWItbGluay1oaWdobGlnaHQnKVxuICAgICAgICAgICAgICAgIC5jc3Moe3dpZHRoOiB0YWJMaW5rV2lkdGh9KVxuICAgICAgICAgICAgICAgIC50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyBoaWdobGlnaHRUcmFuc2xhdGUgKyAnLDAsMCknKTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmluaXRQYWdlTWF0ZXJpYWxUYWJiYXIgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICB2YXIgdGFiYmFyID0gJChwYWdlQ29udGFpbmVyKS5maW5kKCcudGFiYmFyJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgZnVuY3Rpb24gdGFiYmFyU2V0SGlnaGxpZ2h0KCkge1xuICAgICAgICAgICAgICAgIGFwcC5tYXRlcmlhbFRhYmJhclNldEhpZ2hsaWdodCh0YWJiYXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRhYmJhci5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRhYmJhci5maW5kKCcudGFiLWxpbmstaGlnaGxpZ2h0JykubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRhYmJhci5maW5kKCcudG9vbGJhci1pbm5lcicpLmFwcGVuZCgnPHNwYW4gY2xhc3M9XCJ0YWItbGluay1oaWdobGlnaHRcIj48L3NwYW4+Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICB0YWJiYXJTZXRIaWdobGlnaHQoKTtcbiAgICAgICAgICAgICAgICAkKHdpbmRvdykub24oJ3Jlc2l6ZScsIHRhYmJhclNldEhpZ2hsaWdodCk7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5vbmNlKCdwYWdlQmVmb3JlUmVtb3ZlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAkKHdpbmRvdykub2ZmKCdyZXNpemUnLCB0YWJiYXJTZXRIaWdobGlnaHQpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgVGFicyAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovXG4gICAgICAgIGFwcC5zaG93VGFiID0gZnVuY3Rpb24gKHRhYiwgdGFiTGluaywgZm9yY2UpIHtcbiAgICAgICAgICAgIHZhciBuZXdUYWIgPSAkKHRhYik7XG4gICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGFiTGluayA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvcmNlID0gdGFiTGluaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobmV3VGFiLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgaWYgKG5ld1RhYi5oYXNDbGFzcygnYWN0aXZlJykpIHtcbiAgICAgICAgICAgICAgICBpZiAoZm9yY2UpIG5ld1RhYi50cmlnZ2VyKCdzaG93Jyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHRhYnMgPSBuZXdUYWIucGFyZW50KCcudGFicycpO1xuICAgICAgICAgICAgaWYgKHRhYnMubGVuZ3RoID09PSAwKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUmV0dXJuIHN3aXBlb3V0cyBpbiBoaWRkZW4gdGFic1xuICAgICAgICAgICAgYXBwLmFsbG93U3dpcGVvdXQgPSB0cnVlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEFuaW1hdGVkIHRhYnNcbiAgICAgICAgICAgIHZhciBpc0FuaW1hdGVkVGFicyA9IHRhYnMucGFyZW50KCkuaGFzQ2xhc3MoJ3RhYnMtYW5pbWF0ZWQtd3JhcCcpO1xuICAgICAgICAgICAgaWYgKGlzQW5pbWF0ZWRUYWJzKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRhYlRyYW5zbGF0ZSA9IChhcHAucnRsID8gbmV3VGFiLmluZGV4KCkgOiAtbmV3VGFiLmluZGV4KCkpICogMTAwO1xuICAgICAgICAgICAgICAgIHRhYnMudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgdGFiVHJhbnNsYXRlICsgJyUsMCwwKScpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFN3aXBlYWJsZSB0YWJzXG4gICAgICAgICAgICB2YXIgaXNTd2lwZWFibGVUYWJzID0gdGFicy5wYXJlbnQoKS5oYXNDbGFzcygndGFicy1zd2lwZWFibGUtd3JhcCcpLCBzd2lwZXI7XG4gICAgICAgICAgICBpZiAoaXNTd2lwZWFibGVUYWJzKSB7XG4gICAgICAgICAgICAgICAgc3dpcGVyID0gdGFicy5wYXJlbnQoKVswXS5zd2lwZXI7XG4gICAgICAgICAgICAgICAgaWYgKHN3aXBlci5hY3RpdmVJbmRleCAhPT0gbmV3VGFiLmluZGV4KCkpIHN3aXBlci5zbGlkZVRvKG5ld1RhYi5pbmRleCgpLCB1bmRlZmluZWQsIGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBSZW1vdmUgYWN0aXZlIGNsYXNzIGZyb20gb2xkIHRhYnNcbiAgICAgICAgICAgIHZhciBvbGRUYWIgPSB0YWJzLmNoaWxkcmVuKCcudGFiLmFjdGl2ZScpLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTtcbiAgICAgICAgICAgIC8vIEFkZCBhY3RpdmUgY2xhc3MgdG8gbmV3IHRhYlxuICAgICAgICAgICAgbmV3VGFiLmFkZENsYXNzKCdhY3RpdmUnKTtcbiAgICAgICAgICAgIC8vIFRyaWdnZXIgJ3Nob3cnIGV2ZW50IG9uIG5ldyB0YWJcbiAgICAgICAgICAgIG5ld1RhYi50cmlnZ2VyKCdzaG93Jyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVXBkYXRlIG5hdmJhcnMgaW4gbmV3IHRhYlxuICAgICAgICAgICAgaWYgKCFpc0FuaW1hdGVkVGFicyAmJiAhaXNTd2lwZWFibGVUYWJzICYmIG5ld1RhYi5maW5kKCcubmF2YmFyJykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIC8vIEZpbmQgdGFiJ3Mgdmlld1xuICAgICAgICAgICAgICAgIHZhciB2aWV3Q29udGFpbmVyO1xuICAgICAgICAgICAgICAgIGlmIChuZXdUYWIuaGFzQ2xhc3MoYXBwLnBhcmFtcy52aWV3Q2xhc3MpKSB2aWV3Q29udGFpbmVyID0gbmV3VGFiWzBdO1xuICAgICAgICAgICAgICAgIGVsc2Ugdmlld0NvbnRhaW5lciA9IG5ld1RhYi5wYXJlbnRzKCcuJyArIGFwcC5wYXJhbXMudmlld0NsYXNzKVswXTtcbiAgICAgICAgICAgICAgICBhcHAuc2l6ZU5hdmJhcnModmlld0NvbnRhaW5lcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRmluZCByZWxhdGVkIGxpbmsgZm9yIG5ldyB0YWJcbiAgICAgICAgICAgIGlmICh0YWJMaW5rKSB0YWJMaW5rID0gJCh0YWJMaW5rKTtcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIFNlYXJjaCBieSBpZFxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGFiID09PSAnc3RyaW5nJykgdGFiTGluayA9ICQoJy50YWItbGlua1tocmVmPVwiJyArIHRhYiArICdcIl0nKTtcbiAgICAgICAgICAgICAgICBlbHNlIHRhYkxpbmsgPSAkKCcudGFiLWxpbmtbaHJlZj1cIiMnICsgbmV3VGFiLmF0dHIoJ2lkJykgKyAnXCJdJyk7XG4gICAgICAgICAgICAgICAgLy8gU2VhcmNoIGJ5IGRhdGEtdGFiXG4gICAgICAgICAgICAgICAgaWYgKCF0YWJMaW5rIHx8IHRhYkxpbmsgJiYgdGFiTGluay5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgJCgnW2RhdGEtdGFiXScpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1RhYi5pcygkKHRoaXMpLmF0dHIoJ2RhdGEtdGFiJykpKSB0YWJMaW5rID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRhYkxpbmsubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRmluZCByZWxhdGVkIGxpbmsgZm9yIG9sZCB0YWJcbiAgICAgICAgICAgIHZhciBvbGRUYWJMaW5rO1xuICAgICAgICAgICAgaWYgKG9sZFRhYiAmJiBvbGRUYWIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIC8vIFNlYXJjaCBieSBpZFxuICAgICAgICAgICAgICAgIHZhciBvbGRUYWJJZCA9IG9sZFRhYi5hdHRyKCdpZCcpO1xuICAgICAgICAgICAgICAgIGlmIChvbGRUYWJJZCkgb2xkVGFiTGluayA9ICQoJy50YWItbGlua1tocmVmPVwiIycgKyBvbGRUYWJJZCArICdcIl0nKTtcbiAgICAgICAgICAgICAgICAvLyBTZWFyY2ggYnkgZGF0YS10YWJcbiAgICAgICAgICAgICAgICBpZiAoIW9sZFRhYkxpbmsgfHwgb2xkVGFiTGluayAmJiBvbGRUYWJMaW5rLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAkKCdbZGF0YS10YWJdJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob2xkVGFiLmlzKCQodGhpcykuYXR0cignZGF0YS10YWInKSkpIG9sZFRhYkxpbmsgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVXBkYXRlIGxpbmtzJyBjbGFzc2VzXG4gICAgICAgICAgICBpZiAodGFiTGluayAmJiB0YWJMaW5rLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICB0YWJMaW5rLmFkZENsYXNzKCdhY3RpdmUnKTtcbiAgICAgICAgICAgICAgICAvLyBNYXRlcmlhbCBIaWdobGlnaHRcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdGFiYmFyID0gdGFiTGluay5wYXJlbnRzKCcudGFiYmFyJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0YWJiYXIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhYmJhci5maW5kKCcudGFiLWxpbmstaGlnaGxpZ2h0JykubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFiYmFyLmZpbmQoJy50b29sYmFyLWlubmVyJykuYXBwZW5kKCc8c3BhbiBjbGFzcz1cInRhYi1saW5rLWhpZ2hsaWdodFwiPjwvc3Bhbj4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5tYXRlcmlhbFRhYmJhclNldEhpZ2hsaWdodCh0YWJiYXIsIHRhYkxpbmspO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG9sZFRhYkxpbmsgJiYgb2xkVGFiTGluay5sZW5ndGggPiAwKSBvbGRUYWJMaW5rLnJlbW92ZUNsYXNzKCdhY3RpdmUnKTtcbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfTtcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgQWNjb3JkaW9uICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAuYWNjb3JkaW9uVG9nZ2xlID0gZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICAgICAgICAgIGl0ZW0gPSAkKGl0ZW0pO1xuICAgICAgICAgICAgaWYgKGl0ZW0ubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoaXRlbS5oYXNDbGFzcygnYWNjb3JkaW9uLWl0ZW0tZXhwYW5kZWQnKSkgYXBwLmFjY29yZGlvbkNsb3NlKGl0ZW0pO1xuICAgICAgICAgICAgZWxzZSBhcHAuYWNjb3JkaW9uT3BlbihpdGVtKTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmFjY29yZGlvbk9wZW4gPSBmdW5jdGlvbiAoaXRlbSkge1xuICAgICAgICAgICAgaXRlbSA9ICQoaXRlbSk7XG4gICAgICAgICAgICB2YXIgbGlzdCA9IGl0ZW0ucGFyZW50cygnLmFjY29yZGlvbi1saXN0JykuZXEoMCk7XG4gICAgICAgICAgICB2YXIgY29udGVudCA9IGl0ZW0uY2hpbGRyZW4oJy5hY2NvcmRpb24taXRlbS1jb250ZW50Jyk7XG4gICAgICAgICAgICBpZiAoY29udGVudC5sZW5ndGggPT09IDApIGNvbnRlbnQgPSBpdGVtLmZpbmQoJy5hY2NvcmRpb24taXRlbS1jb250ZW50Jyk7XG4gICAgICAgICAgICB2YXIgZXhwYW5kZWRJdGVtID0gbGlzdC5sZW5ndGggPiAwICYmIGl0ZW0ucGFyZW50KCkuY2hpbGRyZW4oJy5hY2NvcmRpb24taXRlbS1leHBhbmRlZCcpO1xuICAgICAgICAgICAgaWYgKGV4cGFuZGVkSXRlbS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgYXBwLmFjY29yZGlvbkNsb3NlKGV4cGFuZGVkSXRlbSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb250ZW50LmNzcygnaGVpZ2h0JywgY29udGVudFswXS5zY3JvbGxIZWlnaHQgKyAncHgnKS50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbS5oYXNDbGFzcygnYWNjb3JkaW9uLWl0ZW0tZXhwYW5kZWQnKSkge1xuICAgICAgICAgICAgICAgICAgICBjb250ZW50LnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQuY3NzKCdoZWlnaHQnLCAnYXV0bycpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgY2xpZW50TGVmdCA9IGNvbnRlbnRbMF0uY2xpZW50TGVmdDtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudC50cmFuc2l0aW9uKCcnKTtcbiAgICAgICAgICAgICAgICAgICAgaXRlbS50cmlnZ2VyKCdvcGVuZWQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQuY3NzKCdoZWlnaHQnLCAnJyk7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0udHJpZ2dlcignY2xvc2VkJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpdGVtLnRyaWdnZXIoJ29wZW4nKTtcbiAgICAgICAgICAgIGl0ZW0uYWRkQ2xhc3MoJ2FjY29yZGlvbi1pdGVtLWV4cGFuZGVkJyk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5hY2NvcmRpb25DbG9zZSA9IGZ1bmN0aW9uIChpdGVtKSB7XG4gICAgICAgICAgICBpdGVtID0gJChpdGVtKTtcbiAgICAgICAgICAgIHZhciBjb250ZW50ID0gaXRlbS5jaGlsZHJlbignLmFjY29yZGlvbi1pdGVtLWNvbnRlbnQnKTtcbiAgICAgICAgICAgIGlmIChjb250ZW50Lmxlbmd0aCA9PT0gMCkgY29udGVudCA9IGl0ZW0uZmluZCgnLmFjY29yZGlvbi1pdGVtLWNvbnRlbnQnKTtcbiAgICAgICAgICAgIGl0ZW0ucmVtb3ZlQ2xhc3MoJ2FjY29yZGlvbi1pdGVtLWV4cGFuZGVkJyk7XG4gICAgICAgICAgICBjb250ZW50LnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICBjb250ZW50LmNzcygnaGVpZ2h0JywgY29udGVudFswXS5zY3JvbGxIZWlnaHQgKyAncHgnKTtcbiAgICAgICAgICAgIC8vIFJlbGF5b3V0XG4gICAgICAgICAgICB2YXIgY2xpZW50TGVmdCA9IGNvbnRlbnRbMF0uY2xpZW50TGVmdDtcbiAgICAgICAgICAgIC8vIENsb3NlXG4gICAgICAgICAgICBjb250ZW50LnRyYW5zaXRpb24oJycpO1xuICAgICAgICAgICAgY29udGVudC5jc3MoJ2hlaWdodCcsICcnKS50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbS5oYXNDbGFzcygnYWNjb3JkaW9uLWl0ZW0tZXhwYW5kZWQnKSkge1xuICAgICAgICAgICAgICAgICAgICBjb250ZW50LnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQuY3NzKCdoZWlnaHQnLCAnYXV0bycpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgY2xpZW50TGVmdCA9IGNvbnRlbnRbMF0uY2xpZW50TGVmdDtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudC50cmFuc2l0aW9uKCcnKTtcbiAgICAgICAgICAgICAgICAgICAgaXRlbS50cmlnZ2VyKCdvcGVuZWQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQuY3NzKCdoZWlnaHQnLCAnJyk7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0udHJpZ2dlcignY2xvc2VkJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpdGVtLnRyaWdnZXIoJ2Nsb3NlJyk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIEZhc3QgQ2xpY2tzICAgKioqKioqKioqKioqXG4gICAgICAgICoqKioqKioqKioqKiAgIEluc3BpcmVkIGJ5IGh0dHBzOi8vZ2l0aHViLmNvbS9mdGxhYnMvZmFzdGNsaWNrICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAuaW5pdEZhc3RDbGlja3MgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hY3RpdmVTdGF0ZSkge1xuICAgICAgICAgICAgICAgICQoJ2h0bWwnKS5hZGRDbGFzcygnd2F0Y2gtYWN0aXZlLXN0YXRlJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXBwLmRldmljZS5pb3MgJiYgYXBwLmRldmljZS53ZWJWaWV3KSB7XG4gICAgICAgICAgICAgICAgLy8gU3RyYW5nZSBoYWNrIHJlcXVpcmVkIGZvciBpT1MgOCB3ZWJ2aWV3IHRvIHdvcmsgb24gaW5wdXRzXG4gICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBmdW5jdGlvbiAoKSB7fSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHRvdWNoU3RhcnRYLCB0b3VjaFN0YXJ0WSwgdG91Y2hTdGFydFRpbWUsIHRhcmdldEVsZW1lbnQsIHRyYWNrQ2xpY2ssIGFjdGl2ZVNlbGVjdGlvbiwgc2Nyb2xsUGFyZW50LCBsYXN0Q2xpY2tUaW1lLCBpc01vdmVkLCB0YXBIb2xkRmlyZWQsIHRhcEhvbGRUaW1lb3V0O1xuICAgICAgICAgICAgdmFyIGFjdGl2YWJsZUVsZW1lbnQsIGFjdGl2ZVRpbWVvdXQsIG5lZWRzRmFzdENsaWNrLCBuZWVkc0Zhc3RDbGlja1RpbWVPdXQ7XG4gICAgICAgICAgICB2YXIgcmlwcGxlV2F2ZSwgcmlwcGxlVGFyZ2V0LCByaXBwbGVUcmFuc2Zvcm0sIHJpcHBsZVRpbWVvdXQ7XG4gICAgICAgICAgICBmdW5jdGlvbiBmaW5kQWN0aXZhYmxlRWxlbWVudChlbCkge1xuICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSAkKGVsKTtcbiAgICAgICAgICAgICAgICB2YXIgcGFyZW50cyA9IHRhcmdldC5wYXJlbnRzKGFwcC5wYXJhbXMuYWN0aXZlU3RhdGVFbGVtZW50cyk7XG4gICAgICAgICAgICAgICAgdmFyIGFjdGl2YWJsZTtcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LmlzKGFwcC5wYXJhbXMuYWN0aXZlU3RhdGVFbGVtZW50cykpIHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZhYmxlID0gdGFyZ2V0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocGFyZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGFjdGl2YWJsZSA9IGFjdGl2YWJsZSA/IGFjdGl2YWJsZS5hZGQocGFyZW50cykgOiBwYXJlbnRzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gYWN0aXZhYmxlID8gYWN0aXZhYmxlIDogdGFyZ2V0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaXNJbnNpZGVTY3JvbGxhYmxlVmlldyhlbCkge1xuICAgICAgICAgICAgICAgIHZhciBwYWdlQ29udGVudCA9IGVsLnBhcmVudHMoJy5wYWdlLWNvbnRlbnQsIC5wYW5lbCcpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocGFnZUNvbnRlbnQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFRoaXMgZXZlbnQgaGFuZGxlciBjb3ZlcnMgdGhlIFwidGFwIHRvIHN0b3Agc2Nyb2xsaW5nXCIuXG4gICAgICAgICAgICAgICAgaWYgKHBhZ2VDb250ZW50LnByb3AoJ3Njcm9sbEhhbmRsZXJTZXQnKSAhPT0gJ3llcycpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnQub24oJ3Njcm9sbCcsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChhY3RpdmVUaW1lb3V0KTtcbiAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQocmlwcGxlVGltZW91dCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudC5wcm9wKCdzY3JvbGxIYW5kbGVyU2V0JywgJ3llcycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBhZGRBY3RpdmUoKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFhY3RpdmFibGVFbGVtZW50KSByZXR1cm47XG4gICAgICAgICAgICAgICAgYWN0aXZhYmxlRWxlbWVudC5hZGRDbGFzcygnYWN0aXZlLXN0YXRlJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiByZW1vdmVBY3RpdmUoZWwpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWFjdGl2YWJsZUVsZW1lbnQpIHJldHVybjtcbiAgICAgICAgICAgICAgICBhY3RpdmFibGVFbGVtZW50LnJlbW92ZUNsYXNzKCdhY3RpdmUtc3RhdGUnKTtcbiAgICAgICAgICAgICAgICBhY3RpdmFibGVFbGVtZW50ID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGlzRm9ybUVsZW1lbnQoZWwpIHtcbiAgICAgICAgICAgICAgICB2YXIgbm9kZXMgPSAoJ2lucHV0IHNlbGVjdCB0ZXh0YXJlYSBsYWJlbCcpLnNwbGl0KCcgJyk7XG4gICAgICAgICAgICAgICAgaWYgKGVsLm5vZGVOYW1lICYmIG5vZGVzLmluZGV4T2YoZWwubm9kZU5hbWUudG9Mb3dlckNhc2UoKSkgPj0gMCkgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gYW5kcm9pZE5lZWRzQmx1cihlbCkge1xuICAgICAgICAgICAgICAgIHZhciBub0JsdXIgPSAoJ2J1dHRvbiBpbnB1dCB0ZXh0YXJlYSBzZWxlY3QnKS5zcGxpdCgnICcpO1xuICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIGVsICE9PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgIT09IGRvY3VtZW50LmJvZHkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vQmx1ci5pbmRleE9mKGVsLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gdGFyZ2V0TmVlZHNGYXN0Q2xpY2soZWwpIHtcbiAgICAgICAgICAgICAgICB2YXIgJGVsID0gJChlbCk7XG4gICAgICAgICAgICAgICAgaWYgKGVsLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdpbnB1dCcgJiYgZWwudHlwZSA9PT0gJ2ZpbGUnKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKCRlbC5oYXNDbGFzcygnbm8tZmFzdGNsaWNrJykgfHwgJGVsLnBhcmVudHMoJy5uby1mYXN0Y2xpY2snKS5sZW5ndGggPiAwKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiB0YXJnZXROZWVkc0ZvY3VzKGVsKSB7XG4gICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IGVsKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHRhZyA9IGVsLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICAgICAgdmFyIHNraXBJbnB1dHMgPSAoJ2J1dHRvbiBjaGVja2JveCBmaWxlIGltYWdlIHJhZGlvIHN1Ym1pdCcpLnNwbGl0KCcgJyk7XG4gICAgICAgICAgICAgICAgaWYgKGVsLmRpc2FibGVkIHx8IGVsLnJlYWRPbmx5KSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gJ3RleHRhcmVhJykgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gJ3NlbGVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UuYW5kcm9pZCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodGFnID09PSAnaW5wdXQnICYmIHNraXBJbnB1dHMuaW5kZXhPZihlbC50eXBlKSA8IDApIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gdGFyZ2V0TmVlZHNQcmV2ZW50KGVsKSB7XG4gICAgICAgICAgICAgICAgZWwgPSAkKGVsKTtcbiAgICAgICAgICAgICAgICB2YXIgcHJldmVudCA9IHRydWU7XG4gICAgICAgICAgICAgICAgaWYgKGVsLmlzKCdsYWJlbCcpIHx8IGVsLnBhcmVudHMoJ2xhYmVsJykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5hbmRyb2lkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2ZW50ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYXBwLmRldmljZS5pb3MgJiYgZWwuaXMoJ2lucHV0JykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcHJldmVudCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldmVudDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBNb3VzZSBIYW5kbGVyc1xuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlTW91c2VEb3duIChlKSB7XG4gICAgICAgICAgICAgICAgZmluZEFjdGl2YWJsZUVsZW1lbnQoZS50YXJnZXQpLmFkZENsYXNzKCdhY3RpdmUtc3RhdGUnKTtcbiAgICAgICAgICAgICAgICBpZiAoJ3doaWNoJyBpbiBlICYmIGUud2hpY2ggPT09IDMpIHtcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKCcuYWN0aXZlLXN0YXRlJykucmVtb3ZlQ2xhc3MoJ2FjdGl2ZS1zdGF0ZScpO1xuICAgICAgICAgICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwgJiYgYXBwLnBhcmFtcy5tYXRlcmlhbFJpcHBsZSkge1xuICAgICAgICAgICAgICAgICAgICB0b3VjaFN0YXJ0WCA9IGUucGFnZVg7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRZID0gZS5wYWdlWTtcbiAgICAgICAgICAgICAgICAgICAgcmlwcGxlVG91Y2hTdGFydChlLnRhcmdldCwgZS5wYWdlWCwgZS5wYWdlWSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlTW91c2VNb3ZlIChlKSB7XG4gICAgICAgICAgICAgICAgJCgnLmFjdGl2ZS1zdGF0ZScpLnJlbW92ZUNsYXNzKCdhY3RpdmUtc3RhdGUnKTtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBhcHAucGFyYW1zLm1hdGVyaWFsUmlwcGxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJpcHBsZVRvdWNoTW92ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZU1vdXNlVXAgKGUpIHtcbiAgICAgICAgICAgICAgICAkKCcuYWN0aXZlLXN0YXRlJykucmVtb3ZlQ2xhc3MoJ2FjdGl2ZS1zdGF0ZScpO1xuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsICYmIGFwcC5wYXJhbXMubWF0ZXJpYWxSaXBwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmlwcGxlVG91Y2hFbmQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gTWF0ZXJpYWwgVG91Y2ggUmlwcGxlIEVmZmVjdFxuICAgICAgICAgICAgZnVuY3Rpb24gZmluZFJpcHBsZUVsZW1lbnQoZWwpIHtcbiAgICAgICAgICAgICAgICB2YXIgbmVlZHNSaXBwbGUgPSBhcHAucGFyYW1zLm1hdGVyaWFsUmlwcGxlRWxlbWVudHM7XG4gICAgICAgICAgICAgICAgdmFyICRlbCA9ICQoZWwpO1xuICAgICAgICAgICAgICAgIGlmICgkZWwuaXMobmVlZHNSaXBwbGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgkZWwuaGFzQ2xhc3MoJ25vLXJpcHBsZScpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRlbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoJGVsLnBhcmVudHMobmVlZHNSaXBwbGUpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJpcHBsZVBhcmVudCA9ICRlbC5wYXJlbnRzKG5lZWRzUmlwcGxlKS5lcSgwKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJpcHBsZVBhcmVudC5oYXNDbGFzcygnbm8tcmlwcGxlJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmlwcGxlUGFyZW50O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZVJpcHBsZSh4LCB5LCBlbCkge1xuICAgICAgICAgICAgICAgIHZhciBib3ggPSBlbFswXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgICAgICAgICAgICB2YXIgY2VudGVyID0ge1xuICAgICAgICAgICAgICAgICAgICB4OiB4IC0gYm94LmxlZnQsXG4gICAgICAgICAgICAgICAgICAgIHk6IHkgLSBib3gudG9wXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgaGVpZ2h0ID0gYm94LmhlaWdodCxcbiAgICAgICAgICAgICAgICAgICAgd2lkdGggPSBib3gud2lkdGg7XG4gICAgICAgICAgICAgICAgdmFyIGRpYW1ldGVyID0gTWF0aC5tYXgoTWF0aC5wb3coKE1hdGgucG93KGhlaWdodCwgMikgKyBNYXRoLnBvdyh3aWR0aCwgMikpLCAwLjUpLCA0OCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHJpcHBsZVdhdmUgPSAkKFxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInJpcHBsZS13YXZlXCIgc3R5bGU9XCJ3aWR0aDogJyArIGRpYW1ldGVyICsgJ3B4OyBoZWlnaHQ6ICcrZGlhbWV0ZXIrJ3B4OyBtYXJnaW4tdG9wOi0nK2RpYW1ldGVyLzIrJ3B4OyBtYXJnaW4tbGVmdDotJytkaWFtZXRlci8yKydweDsgbGVmdDonK2NlbnRlci54KydweDsgdG9wOicrY2VudGVyLnkrJ3B4O1wiPjwvZGl2PidcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGVsLnByZXBlbmQocmlwcGxlV2F2ZSk7XG4gICAgICAgICAgICAgICAgdmFyIGNsaWVudExlZnQgPSByaXBwbGVXYXZlWzBdLmNsaWVudExlZnQ7XG4gICAgICAgICAgICAgICAgcmlwcGxlVHJhbnNmb3JtID0gJ3RyYW5zbGF0ZTNkKCcrKC1jZW50ZXIueCArIHdpZHRoLzIpKydweCwgJysoLWNlbnRlci55ICsgaGVpZ2h0LzIpKydweCwgMCkgc2NhbGUoMSknO1xuICAgICAgICAgICAgICAgIHJpcHBsZVdhdmUudHJhbnNmb3JtKHJpcHBsZVRyYW5zZm9ybSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgZnVuY3Rpb24gcmVtb3ZlUmlwcGxlKCkge1xuICAgICAgICAgICAgICAgIGlmICghcmlwcGxlV2F2ZSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHZhciB0b1JlbW92ZSA9IHJpcHBsZVdhdmU7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciByZW1vdmVUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHRvUmVtb3ZlLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgIH0sIDQwMCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHJpcHBsZVdhdmVcbiAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKCdyaXBwbGUtd2F2ZS1maWxsJylcbiAgICAgICAgICAgICAgICAgICAgLnRyYW5zZm9ybShyaXBwbGVUcmFuc2Zvcm0ucmVwbGFjZSgnc2NhbGUoMSknLCAnc2NhbGUoMS4wMSknKSlcbiAgICAgICAgICAgICAgICAgICAgLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJlbW92ZVRpbWVvdXQpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByaXBwbGVXYXZlID0gJCh0aGlzKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hZGRDbGFzcygncmlwcGxlLXdhdmUtb3V0JylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudHJhbnNmb3JtKHJpcHBsZVRyYW5zZm9ybS5yZXBsYWNlKCdzY2FsZSgxKScsICdzY2FsZSgxLjAxKScpKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmlwcGxlV2F2ZS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDcwMCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmlwcGxlV2F2ZS50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyZW1vdmVUaW1lb3V0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIDApO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcmlwcGxlV2F2ZSA9IHJpcHBsZVRhcmdldCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiByaXBwbGVUb3VjaFN0YXJ0IChlbCwgeCwgeSkge1xuICAgICAgICAgICAgICAgIHJpcHBsZVRhcmdldCA9IGZpbmRSaXBwbGVFbGVtZW50KGVsKTtcbiAgICAgICAgICAgICAgICBpZiAoIXJpcHBsZVRhcmdldCB8fCByaXBwbGVUYXJnZXQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJpcHBsZVRhcmdldCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWlzSW5zaWRlU2Nyb2xsYWJsZVZpZXcocmlwcGxlVGFyZ2V0KSkge1xuICAgICAgICAgICAgICAgICAgICBjcmVhdGVSaXBwbGUodG91Y2hTdGFydFgsIHRvdWNoU3RhcnRZLCByaXBwbGVUYXJnZXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmlwcGxlVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHRvdWNoU3RhcnRYLCB0b3VjaFN0YXJ0WSwgcmlwcGxlVGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAgICAgfSwgODApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIHJpcHBsZVRvdWNoTW92ZSgpIHtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQocmlwcGxlVGltZW91dCk7XG4gICAgICAgICAgICAgICAgcmVtb3ZlUmlwcGxlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiByaXBwbGVUb3VjaEVuZCgpIHtcbiAgICAgICAgICAgICAgICBpZiAocmlwcGxlV2F2ZSkge1xuICAgICAgICAgICAgICAgICAgICByZW1vdmVSaXBwbGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAocmlwcGxlVGFyZ2V0ICYmICFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyaXBwbGVUaW1lb3V0KTtcbiAgICAgICAgICAgICAgICAgICAgY3JlYXRlUmlwcGxlKHRvdWNoU3RhcnRYLCB0b3VjaFN0YXJ0WSwgcmlwcGxlVGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChyZW1vdmVSaXBwbGUsIDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlUmlwcGxlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNlbmQgQ2xpY2tcbiAgICAgICAgICAgIGZ1bmN0aW9uIHNlbmRDbGljayhlKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRvdWNoID0gZS5jaGFuZ2VkVG91Y2hlc1swXTtcbiAgICAgICAgICAgICAgICB2YXIgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ01vdXNlRXZlbnRzJyk7XG4gICAgICAgICAgICAgICAgdmFyIGV2ZW50VHlwZSA9ICdjbGljayc7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UuYW5kcm9pZCAmJiB0YXJnZXRFbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdzZWxlY3QnKSB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50VHlwZSA9ICdtb3VzZWRvd24nO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBldnQuaW5pdE1vdXNlRXZlbnQoZXZlbnRUeXBlLCB0cnVlLCB0cnVlLCB3aW5kb3csIDEsIHRvdWNoLnNjcmVlblgsIHRvdWNoLnNjcmVlblksIHRvdWNoLmNsaWVudFgsIHRvdWNoLmNsaWVudFksIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBudWxsKTtcbiAgICAgICAgICAgICAgICBldnQuZm9yd2FyZGVkVG91Y2hFdmVudCA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGFyZ2V0RWxlbWVudC5kaXNwYXRjaEV2ZW50KGV2dCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVG91Y2ggSGFuZGxlcnNcbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoZSkge1xuICAgICAgICAgICAgICAgIGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0YXBIb2xkRmlyZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAoZS50YXJnZXRUb3VjaGVzLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGl2YWJsZUVsZW1lbnQpIHJlbW92ZUFjdGl2ZSgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGUudG91Y2hlcy5sZW5ndGggPiAxICYmIGFjdGl2YWJsZUVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQWN0aXZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnRhcEhvbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcEhvbGRUaW1lb3V0KSBjbGVhclRpbWVvdXQodGFwSG9sZFRpbWVvdXQpO1xuICAgICAgICAgICAgICAgICAgICB0YXBIb2xkVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGUgJiYgZS50b3VjaGVzICYmIGUudG91Y2hlcy5sZW5ndGggPiAxKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB0YXBIb2xkRmlyZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJChlLnRhcmdldCkudHJpZ2dlcigndGFwaG9sZCcpO1xuICAgICAgICAgICAgICAgICAgICB9LCBhcHAucGFyYW1zLnRhcEhvbGREZWxheSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChuZWVkc0Zhc3RDbGlja1RpbWVPdXQpIGNsZWFyVGltZW91dChuZWVkc0Zhc3RDbGlja1RpbWVPdXQpO1xuICAgICAgICAgICAgICAgIG5lZWRzRmFzdENsaWNrID0gdGFyZ2V0TmVlZHNGYXN0Q2xpY2soZS50YXJnZXQpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIW5lZWRzRmFzdENsaWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyYWNrQ2xpY2sgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLmlvcykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gd2luZG93LmdldFNlbGVjdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0aW9uLnJhbmdlQ291bnQgJiYgc2VsZWN0aW9uLmZvY3VzTm9kZSAhPT0gZG9jdW1lbnQuYm9keSAmJiAoIXNlbGVjdGlvbi5pc0NvbGxhcHNlZCB8fCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ID09PSBzZWxlY3Rpb24uZm9jdXNOb2RlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlU2VsZWN0aW9uID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlU2VsZWN0aW9uID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UuYW5kcm9pZCkgIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFuZHJvaWROZWVkc0JsdXIoZS50YXJnZXQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hY3RpdmVFbGVtZW50LmJsdXIoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdHJhY2tDbGljayA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGFyZ2V0RWxlbWVudCA9IGUudGFyZ2V0O1xuICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRUaW1lID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICB0b3VjaFN0YXJ0WCA9IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWDtcbiAgICAgICAgICAgICAgICB0b3VjaFN0YXJ0WSA9IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gRGV0ZWN0IHNjcm9sbCBwYXJlbnRcbiAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5pb3MpIHtcbiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsUGFyZW50ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICAkKHRhcmdldEVsZW1lbnQpLnBhcmVudHMoKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmVudC5zY3JvbGxIZWlnaHQgPiBwYXJlbnQub2Zmc2V0SGVpZ2h0ICYmICFzY3JvbGxQYXJlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxQYXJlbnQgPSBwYXJlbnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsUGFyZW50LmY3U2Nyb2xsVG9wID0gc2Nyb2xsUGFyZW50LnNjcm9sbFRvcDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICgoZS50aW1lU3RhbXAgLSBsYXN0Q2xpY2tUaW1lKSA8IGFwcC5wYXJhbXMuZmFzdENsaWNrc0RlbGF5QmV0d2VlbkNsaWNrcykge1xuICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hY3RpdmVTdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICBhY3RpdmFibGVFbGVtZW50ID0gZmluZEFjdGl2YWJsZUVsZW1lbnQodGFyZ2V0RWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgIC8vIElmIGl0J3MgaW5zaWRlIGEgc2Nyb2xsYWJsZSB2aWV3LCB3ZSBkb24ndCB0cmlnZ2VyIGFjdGl2ZS1zdGF0ZSB5ZXQsXG4gICAgICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgaXQgY2FuIGJlIGEgc2Nyb2xsIGluc3RlYWQuIEJhc2VkIG9uIHRoZSBsaW5rOlxuICAgICAgICAgICAgICAgICAgICAvLyBodHRwOi8vbGFibm90ZS5iZWVkZXNrLmNvbS9jbGljay1zY3JvbGwtYW5kLXBzZXVkby1hY3RpdmUtb24tbW9iaWxlLXdlYmtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0luc2lkZVNjcm9sbGFibGVWaWV3KGFjdGl2YWJsZUVsZW1lbnQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhZGRBY3RpdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZVRpbWVvdXQgPSBzZXRUaW1lb3V0KGFkZEFjdGl2ZSwgODApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsICYmIGFwcC5wYXJhbXMubWF0ZXJpYWxSaXBwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmlwcGxlVG91Y2hTdGFydCh0YXJnZXRFbGVtZW50LCB0b3VjaFN0YXJ0WCwgdG91Y2hTdGFydFkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZShlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0cmFja0NsaWNrKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIF9pc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdmFyIGRpc3RhbmNlID0gYXBwLnBhcmFtcy5mYXN0Q2xpY2tzRGlzdGFuY2VUaHJlc2hvbGQ7XG4gICAgICAgICAgICAgICAgaWYgKGRpc3RhbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwYWdlWCA9IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWDtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhZ2VZID0gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZO1xuICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocGFnZVggLSB0b3VjaFN0YXJ0WCkgPiBkaXN0YW5jZSB8fCAgTWF0aC5hYnMocGFnZVkgLSB0b3VjaFN0YXJ0WSkgPiBkaXN0YW5jZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgX2lzTW92ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBfaXNNb3ZlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChfaXNNb3ZlZCkge1xuICAgICAgICAgICAgICAgICAgICB0cmFja0NsaWNrID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldEVsZW1lbnQgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBpc01vdmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMudGFwSG9sZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRhcEhvbGRUaW1lb3V0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcdFx0XHRpZiAoYXBwLnBhcmFtcy5hY3RpdmVTdGF0ZSkge1xuICAgICAgICBcdFx0XHRcdGNsZWFyVGltZW91dChhY3RpdmVUaW1lb3V0KTtcbiAgICAgICAgXHRcdFx0XHRyZW1vdmVBY3RpdmUoKTtcbiAgICAgICAgXHRcdFx0fVxuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBhcHAucGFyYW1zLm1hdGVyaWFsUmlwcGxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByaXBwbGVUb3VjaE1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoRW5kKGUpIHtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoYWN0aXZlVGltZW91dCk7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRhcEhvbGRUaW1lb3V0KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCF0cmFja0NsaWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYWN0aXZlU2VsZWN0aW9uICYmIG5lZWRzRmFzdENsaWNrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIShhcHAuZGV2aWNlLmFuZHJvaWQgJiYgIWUuY2FuY2VsYWJsZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PT0gZS50YXJnZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuYWN0aXZlU3RhdGUpIHJlbW92ZUFjdGl2ZSgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBhcHAucGFyYW1zLm1hdGVyaWFsUmlwcGxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByaXBwbGVUb3VjaEVuZCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCFhY3RpdmVTZWxlY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKChlLnRpbWVTdGFtcCAtIGxhc3RDbGlja1RpbWUpIDwgYXBwLnBhcmFtcy5mYXN0Q2xpY2tzRGVsYXlCZXR3ZWVuQ2xpY2tzKSB7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQocmVtb3ZlQWN0aXZlLCAwKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBsYXN0Q2xpY2tUaW1lID0gZS50aW1lU3RhbXA7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHRyYWNrQ2xpY2sgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UuaW9zICYmIHNjcm9sbFBhcmVudCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2Nyb2xsUGFyZW50LnNjcm9sbFRvcCAhPT0gc2Nyb2xsUGFyZW50LmY3U2Nyb2xsVG9wKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIEFkZCBhY3RpdmUtc3RhdGUgaGVyZSBiZWNhdXNlLCBpbiBhIHZlcnkgZmFzdCB0YXAsIHRoZSB0aW1lb3V0IGRpZG4ndFxuICAgICAgICAgICAgICAgIC8vIGhhdmUgdGhlIGNoYW5jZSB0byBleGVjdXRlLiBSZW1vdmluZyBhY3RpdmUtc3RhdGUgaW4gYSB0aW1lb3V0IGdpdmVzXG4gICAgICAgICAgICAgICAgLy8gdGhlIGNoYW5jZSB0byB0aGUgYW5pbWF0aW9uIGV4ZWN1dGUuXG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuYWN0aXZlU3RhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgYWRkQWN0aXZlKCk7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQocmVtb3ZlQWN0aXZlLCAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gUmVtb3ZlIFJpcHBsZVxuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsICYmIGFwcC5wYXJhbXMubWF0ZXJpYWxSaXBwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmlwcGxlVG91Y2hFbmQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFRyaWdnZXIgZm9jdXMgd2hlbiByZXF1aXJlZFxuICAgICAgICAgICAgICAgIGlmICh0YXJnZXROZWVkc0ZvY3VzKHRhcmdldEVsZW1lbnQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLmlvcyAmJiBhcHAuZGV2aWNlLndlYlZpZXcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoZXZlbnQudGltZVN0YW1wIC0gdG91Y2hTdGFydFRpbWUpID4gMTU5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RWxlbWVudCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RWxlbWVudC5mb2N1cygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RWxlbWVudC5mb2N1cygpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBCbHVyIGFjdGl2ZSBlbGVtZW50c1xuICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmIHRhcmdldEVsZW1lbnQgIT09IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAhPT0gZG9jdW1lbnQuYm9keSAmJiB0YXJnZXRFbGVtZW50Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICdsYWJlbCcpIHtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ibHVyKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBTZW5kIGNsaWNrXG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIHNlbmRDbGljayhlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaENhbmNlbChlKSB7XG4gICAgICAgICAgICAgICAgdHJhY2tDbGljayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHRhcmdldEVsZW1lbnQgPSBudWxsO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgQWN0aXZlIFN0YXRlXG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGFjdGl2ZVRpbWVvdXQpO1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0YXBIb2xkVGltZW91dCk7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuYWN0aXZlU3RhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlQWN0aXZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgUmlwcGxlXG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwgJiYgYXBwLnBhcmFtcy5tYXRlcmlhbFJpcHBsZSkge1xuICAgICAgICAgICAgICAgICAgICByaXBwbGVUb3VjaEVuZCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVDbGljayhlKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFsbG93Q2xpY2sgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHRyYWNrQ2xpY2spIHtcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RWxlbWVudCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIHRyYWNrQ2xpY2sgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldC50eXBlID09PSAnc3VibWl0JyAmJiBlLmRldGFpbCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCF0YXJnZXRFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghaXNGb3JtRWxlbWVudChlLnRhcmdldCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93Q2xpY2sgPSAgdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIW5lZWRzRmFzdENsaWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIGFsbG93Q2xpY2sgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PT0gdGFyZ2V0RWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICBhbGxvd0NsaWNrID0gIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChlLmZvcndhcmRlZFRvdWNoRXZlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgYWxsb3dDbGljayA9ICB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWUuY2FuY2VsYWJsZSkge1xuICAgICAgICAgICAgICAgICAgICBhbGxvd0NsaWNrID0gIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnRhcEhvbGQgJiYgYXBwLnBhcmFtcy50YXBIb2xkUHJldmVudENsaWNrcyAmJiB0YXBIb2xkRmlyZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgYWxsb3dDbGljayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWFsbG93Q2xpY2spIHtcbiAgICAgICAgICAgICAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldEVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXROZWVkc1ByZXZlbnQodGFyZ2V0RWxlbWVudCkgfHwgaXNNb3ZlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0YXJnZXRFbGVtZW50ID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbmVlZHNGYXN0Q2xpY2tUaW1lT3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIG5lZWRzRmFzdENsaWNrID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSwgKGFwcC5kZXZpY2UuaW9zIHx8IGFwcC5kZXZpY2UuYW5kcm9pZENocm9tZSA/IDEwMCA6IDQwMCkpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy50YXBIb2xkKSB7XG4gICAgICAgICAgICAgICAgICAgIHRhcEhvbGRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0YXBIb2xkRmlyZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfSwgKGFwcC5kZXZpY2UuaW9zIHx8IGFwcC5kZXZpY2UuYW5kcm9pZENocm9tZSA/IDEwMCA6IDQwMCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFsbG93Q2xpY2s7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXBwLnN1cHBvcnQudG91Y2gpIHtcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGhhbmRsZUNsaWNrLCB0cnVlKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGhhbmRsZVRvdWNoU3RhcnQpO1xuICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIGhhbmRsZVRvdWNoTW92ZSk7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCBoYW5kbGVUb3VjaEVuZCk7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hjYW5jZWwnLCBoYW5kbGVUb3VjaENhbmNlbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hY3RpdmVTdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBoYW5kbGVNb3VzZURvd24pO1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBoYW5kbGVNb3VzZU1vdmUpO1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgaGFuZGxlTW91c2VVcCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwgJiYgYXBwLnBhcmFtcy5tYXRlcmlhbFJpcHBsZSkge1xuICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NvbnRleHRtZW51JywgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGl2YWJsZUVsZW1lbnQpIHJlbW92ZUFjdGl2ZSgpO1xuICAgICAgICAgICAgICAgICAgICByaXBwbGVUb3VjaEVuZCgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgfTtcbiAgICAgICAgXG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIEhhbmRsZSBjbGlja3MgYW5kIG1ha2UgdGhlbSBmYXN0IChvbiB0YXApOyAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLmluaXRDbGlja0V2ZW50cyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVNjcm9sbFRvcChlKSB7XG4gICAgICAgICAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi9cbiAgICAgICAgICAgICAgICB2YXIgY2xpY2tlZCA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9ICQoZS50YXJnZXQpO1xuICAgICAgICAgICAgICAgIHZhciBpc0xpbmsgPSBjbGlja2VkWzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdhJyB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGlja2VkLnBhcmVudHMoJ2EnKS5sZW5ndGggPiAwIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFswXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnYScgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0LnBhcmVudHMoJ2EnKS5sZW5ndGggPiAwO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoaXNMaW5rKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2VDb250ZW50LCBwYWdlO1xuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnNjcm9sbFRvcE9uTmF2YmFyQ2xpY2sgJiYgY2xpY2tlZC5pcygnLm5hdmJhciAuY2VudGVyJykpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gRmluZCBhY3RpdmUgcGFnZVxuICAgICAgICAgICAgICAgICAgICB2YXIgbmF2YmFyID0gY2xpY2tlZC5wYXJlbnRzKCcubmF2YmFyJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBTdGF0aWMgTGF5b3V0XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50ID0gbmF2YmFyLnBhcmVudHMoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChwYWdlQ29udGVudC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpeGVkIExheW91dFxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hdmJhci5wYXJlbnRzKCcucGFnZScpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudCA9IG5hdmJhci5wYXJlbnRzKCcucGFnZScpLmZpbmQoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRocm91Z2ggTGF5b3V0XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFnZUNvbnRlbnQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hdmJhci5uZXh0QWxsKCcucGFnZXMnKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50ID0gbmF2YmFyLm5leHRBbGwoJy5wYWdlcycpLmZpbmQoJy5wYWdlOm5vdCgucGFnZS1vbi1sZWZ0KTpub3QoLnBhZ2Utb24tcmlnaHQpOm5vdCguY2FjaGVkKScpLmZpbmQoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuc2Nyb2xsVG9wT25TdGF0dXNiYXJDbGljayAmJiBjbGlja2VkLmlzKCcuc3RhdHVzYmFyLW92ZXJsYXknKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLnBvcHVwLm1vZGFsLWluJykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIG9wZW5lZCBwb3B1cFxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnQgPSAkKCcucG9wdXAubW9kYWwtaW4nKS5maW5kKCcucGFnZTpub3QoLnBhZ2Utb24tbGVmdCk6bm90KC5wYWdlLW9uLXJpZ2h0KTpub3QoLmNhY2hlZCknKS5maW5kKCcucGFnZS1jb250ZW50Jyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoJCgnLnBhbmVsLmFjdGl2ZScpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGZvciBvcGVuZWQgcGFuZWxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50ID0gJCgnLnBhbmVsLmFjdGl2ZScpLmZpbmQoJy5wYWdlOm5vdCgucGFnZS1vbi1sZWZ0KTpub3QoLnBhZ2Utb24tcmlnaHQpOm5vdCguY2FjaGVkKScpLmZpbmQoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICgkKCcudmlld3MgPiAudmlldy5hY3RpdmUnKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBWaWV3IGluIHRhYiBiYXIgYXBwIGxheW91dFxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnQgPSAkKCcudmlld3MgPiAudmlldy5hY3RpdmUnKS5maW5kKCcucGFnZTpub3QoLnBhZ2Utb24tbGVmdCk6bm90KC5wYWdlLW9uLXJpZ2h0KTpub3QoLmNhY2hlZCknKS5maW5kKCcucGFnZS1jb250ZW50Jyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBVc3VhbCBjYXNlXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudCA9ICQoJy52aWV3cycpLmZpbmQoJy5wYWdlOm5vdCgucGFnZS1vbi1sZWZ0KTpub3QoLnBhZ2Utb24tcmlnaHQpOm5vdCguY2FjaGVkKScpLmZpbmQoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHBhZ2VDb250ZW50ICYmIHBhZ2VDb250ZW50Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIHRhYlxuICAgICAgICAgICAgICAgICAgICBpZiAocGFnZUNvbnRlbnQuaGFzQ2xhc3MoJ3RhYicpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudCA9IHBhZ2VDb250ZW50LnBhcmVudCgnLnRhYnMnKS5jaGlsZHJlbignLnBhZ2UtY29udGVudC5hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAocGFnZUNvbnRlbnQubGVuZ3RoID4gMCkgcGFnZUNvbnRlbnQuc2Nyb2xsVG9wKDAsIDMwMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlQ2xpY2tzKGUpIHtcbiAgICAgICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqL1xuICAgICAgICAgICAgICAgIHZhciBjbGlja2VkID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICB2YXIgdXJsID0gY2xpY2tlZC5hdHRyKCdocmVmJyk7XG4gICAgICAgICAgICAgICAgdmFyIGlzTGluayA9IGNsaWNrZWRbMF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2EnO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiBsaW5rIGlzIGV4dGVybmFsXG4gICAgICAgICAgICAgICAgaWYgKGlzTGluaykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5pcyhhcHAucGFyYW1zLmV4dGVybmFsTGlua3MpIHx8ICh1cmwgJiYgdXJsLmluZGV4T2YoJ2phdmFzY3JpcHQ6JykgPj0gMCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHVybCAmJiBjbGlja2VkLmF0dHIoJ3RhcmdldCcpID09PSAnX3N5c3RlbScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Lm9wZW4odXJsLCAnX3N5c3RlbScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBDb2xsZWN0IENsaWNrZWQgZGF0YS0gYXR0cmlidXRlc1xuICAgICAgICAgICAgICAgIHZhciBjbGlja2VkRGF0YSA9IGNsaWNrZWQuZGF0YXNldCgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBTbWFydCBTZWxlY3RcbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnc21hcnQtc2VsZWN0JykpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5zbWFydFNlbGVjdE9wZW4pIGFwcC5zbWFydFNlbGVjdE9wZW4oY2xpY2tlZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBPcGVuIFBhbmVsXG4gICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ29wZW4tcGFuZWwnKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLnBhbmVsJykubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLnBhbmVsJykuaGFzQ2xhc3MoJ3BhbmVsLWxlZnQnKSkgYXBwLm9wZW5QYW5lbCgnbGVmdCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBhcHAub3BlblBhbmVsKCdyaWdodCcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNsaWNrZWREYXRhLnBhbmVsID09PSAncmlnaHQnKSBhcHAub3BlblBhbmVsKCdyaWdodCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBhcHAub3BlblBhbmVsKCdsZWZ0Jyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gQ2xvc2UgUGFuZWxcbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnY2xvc2UtcGFuZWwnKSkge1xuICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VQYW5lbCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ3BhbmVsLW92ZXJsYXknKSAmJiBhcHAucGFyYW1zLnBhbmVsc0Nsb3NlQnlPdXRzaWRlKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZVBhbmVsKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIFBvcG92ZXJcbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnb3Blbi1wb3BvdmVyJykpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBvcG92ZXI7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjbGlja2VkRGF0YS5wb3BvdmVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwb3BvdmVyID0gY2xpY2tlZERhdGEucG9wb3ZlcjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHBvcG92ZXIgPSAnLnBvcG92ZXInO1xuICAgICAgICAgICAgICAgICAgICBhcHAucG9wb3Zlcihwb3BvdmVyLCBjbGlja2VkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ2Nsb3NlLXBvcG92ZXInKSkge1xuICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbCgnLnBvcG92ZXIubW9kYWwtaW4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gUG9wdXBcbiAgICAgICAgICAgICAgICB2YXIgcG9wdXA7XG4gICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ29wZW4tcG9wdXAnKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZERhdGEucG9wdXApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvcHVwID0gY2xpY2tlZERhdGEucG9wdXA7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBwb3B1cCA9ICcucG9wdXAnO1xuICAgICAgICAgICAgICAgICAgICBhcHAucG9wdXAocG9wdXApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnY2xvc2UtcG9wdXAnKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZERhdGEucG9wdXApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvcHVwID0gY2xpY2tlZERhdGEucG9wdXA7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBwb3B1cCA9ICcucG9wdXAubW9kYWwtaW4nO1xuICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbChwb3B1cCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIExvZ2luIFNjcmVlblxuICAgICAgICAgICAgICAgIHZhciBsb2dpblNjcmVlbjtcbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnb3Blbi1sb2dpbi1zY3JlZW4nKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZERhdGEubG9naW5TY3JlZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2luU2NyZWVuID0gY2xpY2tlZERhdGEubG9naW5TY3JlZW47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBsb2dpblNjcmVlbiA9ICcubG9naW4tc2NyZWVuJztcbiAgICAgICAgICAgICAgICAgICAgYXBwLmxvZ2luU2NyZWVuKGxvZ2luU2NyZWVuKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ2Nsb3NlLWxvZ2luLXNjcmVlbicpKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKCcubG9naW4tc2NyZWVuLm1vZGFsLWluJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIENsb3NlIE1vZGFsXG4gICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ21vZGFsLW92ZXJsYXknKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLm1vZGFsLm1vZGFsLWluJykubGVuZ3RoID4gMCAmJiBhcHAucGFyYW1zLm1vZGFsQ2xvc2VCeU91dHNpZGUpXG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbCgnLm1vZGFsLm1vZGFsLWluJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmICgkKCcuYWN0aW9ucy1tb2RhbC5tb2RhbC1pbicpLmxlbmd0aCA+IDAgJiYgYXBwLnBhcmFtcy5hY3Rpb25zQ2xvc2VCeU91dHNpZGUpXG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbCgnLmFjdGlvbnMtbW9kYWwubW9kYWwtaW4nKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmICgkKCcucG9wb3Zlci5tb2RhbC1pbicpLmxlbmd0aCA+IDApIGFwcC5jbG9zZU1vZGFsKCcucG9wb3Zlci5tb2RhbC1pbicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygncG9wdXAtb3ZlcmxheScpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgkKCcucG9wdXAubW9kYWwtaW4nKS5sZW5ndGggPiAwICYmIGFwcC5wYXJhbXMucG9wdXBDbG9zZUJ5T3V0c2lkZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKCcucG9wdXAubW9kYWwtaW4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ3BpY2tlci1tb2RhbC1vdmVybGF5JykpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQoJy5waWNrZXItbW9kYWwubW9kYWwtaW4nKS5sZW5ndGggPiAwKVxuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmNsb3NlTW9kYWwoJy5waWNrZXItbW9kYWwubW9kYWwtaW4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFBpY2tlclxuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCdjbG9zZS1waWNrZXInKSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcGlja2VyVG9DbG9zZSA9ICQoJy5waWNrZXItbW9kYWwubW9kYWwtaW4nKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBpY2tlclRvQ2xvc2UubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmNsb3NlTW9kYWwocGlja2VyVG9DbG9zZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwaWNrZXJUb0Nsb3NlID0gJCgnLnBvcG92ZXIubW9kYWwtaW4gLnBpY2tlci1tb2RhbCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBpY2tlclRvQ2xvc2UubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKHBpY2tlclRvQ2xvc2UucGFyZW50cygnLnBvcG92ZXInKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ29wZW4tcGlja2VyJykpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBpY2tlclRvT3BlbjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNsaWNrZWREYXRhLnBpY2tlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGlja2VyVG9PcGVuID0gY2xpY2tlZERhdGEucGlja2VyO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcGlja2VyVG9PcGVuID0gJy5waWNrZXItbW9kYWwnO1xuICAgICAgICAgICAgICAgICAgICBhcHAucGlja2VyTW9kYWwocGlja2VyVG9PcGVuLCBjbGlja2VkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFRhYnNcbiAgICAgICAgICAgICAgICB2YXIgaXNUYWJMaW5rO1xuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCd0YWItbGluaycpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzVGFiTGluayA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5zaG93VGFiKGNsaWNrZWREYXRhLnRhYiB8fCBjbGlja2VkLmF0dHIoJ2hyZWYnKSwgY2xpY2tlZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIFN3aXBlb3V0IENsb3NlXG4gICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ3N3aXBlb3V0LWNsb3NlJykpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnN3aXBlb3V0Q2xvc2UoY2xpY2tlZC5wYXJlbnRzKCcuc3dpcGVvdXQtb3BlbmVkJykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBTd2lwZW91dCBEZWxldGVcbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnc3dpcGVvdXQtZGVsZXRlJykpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNsaWNrZWREYXRhLmNvbmZpcm0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gY2xpY2tlZERhdGEuY29uZmlybTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aXRsZSA9IGNsaWNrZWREYXRhLmNvbmZpcm1UaXRsZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aXRsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5jb25maXJtKHRleHQsIHRpdGxlLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5zd2lwZW91dERlbGV0ZShjbGlja2VkLnBhcmVudHMoJy5zd2lwZW91dCcpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjbGlja2VkRGF0YS5jbG9zZU9uQ2FuY2VsKSBhcHAuc3dpcGVvdXRDbG9zZShjbGlja2VkLnBhcmVudHMoJy5zd2lwZW91dCcpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5jb25maXJtKHRleHQsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnN3aXBlb3V0RGVsZXRlKGNsaWNrZWQucGFyZW50cygnLnN3aXBlb3V0JykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNsaWNrZWREYXRhLmNsb3NlT25DYW5jZWwpIGFwcC5zd2lwZW91dENsb3NlKGNsaWNrZWQucGFyZW50cygnLnN3aXBlb3V0JykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnN3aXBlb3V0RGVsZXRlKGNsaWNrZWQucGFyZW50cygnLnN3aXBlb3V0JykpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBTb3J0YWJsZVxuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCd0b2dnbGUtc29ydGFibGUnKSkge1xuICAgICAgICAgICAgICAgICAgICBhcHAuc29ydGFibGVUb2dnbGUoY2xpY2tlZERhdGEuc29ydGFibGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnb3Blbi1zb3J0YWJsZScpKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5zb3J0YWJsZU9wZW4oY2xpY2tlZERhdGEuc29ydGFibGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnY2xvc2Utc29ydGFibGUnKSkge1xuICAgICAgICAgICAgICAgICAgICBhcHAuc29ydGFibGVDbG9zZShjbGlja2VkRGF0YS5zb3J0YWJsZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIEFjY29yZGlvblxuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCdhY2NvcmRpb24taXRlbS10b2dnbGUnKSB8fCAoY2xpY2tlZC5oYXNDbGFzcygnaXRlbS1saW5rJykgJiYgY2xpY2tlZC5wYXJlbnQoKS5oYXNDbGFzcygnYWNjb3JkaW9uLWl0ZW0nKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFjY29yZGlvbkl0ZW0gPSBjbGlja2VkLnBhcmVudCgnLmFjY29yZGlvbi1pdGVtJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhY2NvcmRpb25JdGVtLmxlbmd0aCA9PT0gMCkgYWNjb3JkaW9uSXRlbSA9IGNsaWNrZWQucGFyZW50cygnLmFjY29yZGlvbi1pdGVtJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhY2NvcmRpb25JdGVtLmxlbmd0aCA9PT0gMCkgYWNjb3JkaW9uSXRlbSA9IGNsaWNrZWQucGFyZW50cygnbGknKTtcbiAgICAgICAgICAgICAgICAgICAgYXBwLmFjY29yZGlvblRvZ2dsZShhY2NvcmRpb25JdGVtKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFNwZWVkIERpYWxcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnZmxvYXRpbmctYnV0dG9uJykgJiYgY2xpY2tlZC5wYXJlbnQoKS5oYXNDbGFzcygnc3BlZWQtZGlhbCcpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGlja2VkLnBhcmVudCgpLnRvZ2dsZUNsYXNzKCdzcGVlZC1kaWFsLW9wZW5lZCcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCdjbG9zZS1zcGVlZC1kaWFsJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJy5zcGVlZC1kaWFsLW9wZW5lZCcpLnJlbW92ZUNsYXNzKCdzcGVlZC1kaWFsLW9wZW5lZCcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBMb2FkIFBhZ2VcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hamF4TGlua3MgJiYgIWNsaWNrZWQuaXMoYXBwLnBhcmFtcy5hamF4TGlua3MpIHx8ICFpc0xpbmsgfHwgIWFwcC5wYXJhbXMucm91dGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGlzTGluaykge1xuICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgdmFsaWRVcmwgPSB1cmwgJiYgdXJsLmxlbmd0aCA+IDAgJiYgdXJsICE9PSAnIycgJiYgIWlzVGFiTGluaztcbiAgICAgICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBjbGlja2VkRGF0YS50ZW1wbGF0ZTtcbiAgICAgICAgICAgICAgICBpZiAodmFsaWRVcmwgfHwgY2xpY2tlZC5oYXNDbGFzcygnYmFjaycpIHx8IHRlbXBsYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2aWV3O1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZERhdGEudmlldykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmlldyA9ICQoY2xpY2tlZERhdGEudmlldylbMF0uZjdWaWV3O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmlldyA9IGNsaWNrZWQucGFyZW50cygnLicgKyBhcHAucGFyYW1zLnZpZXdDbGFzcylbMF0gJiYgY2xpY2tlZC5wYXJlbnRzKCcuJyArIGFwcC5wYXJhbXMudmlld0NsYXNzKVswXS5mN1ZpZXc7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlldyAmJiB2aWV3LnBhcmFtcy5saW5rc1ZpZXcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZpZXcucGFyYW1zLmxpbmtzVmlldyA9PT0gJ3N0cmluZycpIHZpZXcgPSAkKHZpZXcucGFyYW1zLmxpbmtzVmlldylbMF0uZjdWaWV3O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHZpZXcucGFyYW1zLmxpbmtzVmlldyBpbnN0YW5jZW9mIFZpZXcpIHZpZXcgPSB2aWV3LnBhcmFtcy5saW5rc1ZpZXc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCF2aWV3KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLm1haW5WaWV3KSB2aWV3ID0gYXBwLm1haW5WaWV3O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghdmlldykgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhZ2VOYW1lO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRlbXBsYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodXJsLmluZGV4T2YoJyMnKSA9PT0gMCAmJiB1cmwgIT09ICcjJykgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuZG9tQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZU5hbWUgPSB1cmwuc3BsaXQoJyMnKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodXJsID09PSAnIycgJiYgIWNsaWNrZWQuaGFzQ2xhc3MoJ2JhY2snKSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXJsID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB2YXIgYW5pbWF0ZVBhZ2VzO1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNsaWNrZWREYXRhLmFuaW1hdGVQYWdlcyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFuaW1hdGVQYWdlcyA9IGNsaWNrZWREYXRhLmFuaW1hdGVQYWdlcztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCd3aXRoLWFuaW1hdGlvbicpKSBhbmltYXRlUGFnZXMgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ25vLWFuaW1hdGlvbicpKSBhbmltYXRlUGFnZXMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbmltYXRlUGFnZXM6IGFuaW1hdGVQYWdlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlnbm9yZUNhY2hlOiBjbGlja2VkRGF0YS5pZ25vcmVDYWNoZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmNlOiBjbGlja2VkRGF0YS5mb3JjZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbG9hZDogY2xpY2tlZERhdGEucmVsb2FkLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVsb2FkUHJldmlvdXM6IGNsaWNrZWREYXRhLnJlbG9hZFByZXZpb3VzLFxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZU5hbWU6IHBhZ2VOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgcHVzaFN0YXRlOiBjbGlja2VkRGF0YS5wdXNoU3RhdGUsXG4gICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHVybFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMudGVtcGxhdGU3UGFnZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuY29udGV4dE5hbWUgPSBjbGlja2VkRGF0YS5jb250ZXh0TmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb250ZXh0ID0gY2xpY2tlZERhdGEuY29udGV4dDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5jb250ZXh0ID0gSlNPTi5wYXJzZShjb250ZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAodGVtcGxhdGUgJiYgdGVtcGxhdGUgaW4gdDcudGVtcGxhdGVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnRlbXBsYXRlID0gdDcudGVtcGxhdGVzW3RlbXBsYXRlXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ2JhY2snKSkgdmlldy5yb3V0ZXIuYmFjayhvcHRpb25zKTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB2aWV3LnJvdXRlci5sb2FkKG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCdjbGljaycsICdhLCAub3Blbi1wYW5lbCwgLmNsb3NlLXBhbmVsLCAucGFuZWwtb3ZlcmxheSwgLm1vZGFsLW92ZXJsYXksIC5wb3B1cC1vdmVybGF5LCAuc3dpcGVvdXQtZGVsZXRlLCAuc3dpcGVvdXQtY2xvc2UsIC5jbG9zZS1wb3B1cCwgLm9wZW4tcG9wdXAsIC5vcGVuLXBvcG92ZXIsIC5vcGVuLWxvZ2luLXNjcmVlbiwgLmNsb3NlLWxvZ2luLXNjcmVlbiAuc21hcnQtc2VsZWN0LCAudG9nZ2xlLXNvcnRhYmxlLCAub3Blbi1zb3J0YWJsZSwgLmNsb3NlLXNvcnRhYmxlLCAuYWNjb3JkaW9uLWl0ZW0tdG9nZ2xlLCAuY2xvc2UtcGlja2VyLCAucGlja2VyLW1vZGFsLW92ZXJsYXknLCBoYW5kbGVDbGlja3MpO1xuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuc2Nyb2xsVG9wT25OYXZiYXJDbGljayB8fCBhcHAucGFyYW1zLnNjcm9sbFRvcE9uU3RhdHVzYmFyQ2xpY2spIHtcbiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vbignY2xpY2snLCAnLnN0YXR1c2Jhci1vdmVybGF5LCAubmF2YmFyIC5jZW50ZXInLCBoYW5kbGVTY3JvbGxUb3ApO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFByZXZlbnQgc2Nyb2xsaW5nIG9uIG92ZXJsYXlzXG4gICAgICAgICAgICBmdW5jdGlvbiBwcmV2ZW50U2Nyb2xsaW5nKGUpIHtcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXBwLnN1cHBvcnQudG91Y2ggJiYgIWFwcC5kZXZpY2UuYW5kcm9pZCkge1xuICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKChhcHAucGFyYW1zLmZhc3RDbGlja3MgPyAndG91Y2hzdGFydCcgOiAndG91Y2htb3ZlJyksICcucGFuZWwtb3ZlcmxheSwgLm1vZGFsLW92ZXJsYXksIC5wcmVsb2FkZXItaW5kaWNhdG9yLW92ZXJsYXksIC5wb3B1cC1vdmVybGF5LCAuc2VhcmNoYmFyLW92ZXJsYXknLCBwcmV2ZW50U2Nyb2xsaW5nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgQXBwIFJlc2l6ZSBBY3Rpb25zICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIC8vIFByZXZlbnQgaVBhZCBob3Jpem9udGFsIGJvZHkgc2Nyb2xsaW5nIHdoZW4gc29mdCBrZXlib2FyZCBpcyBvcGVuZWRcbiAgICAgICAgZnVuY3Rpb24gX2ZpeElwYWRCb2R5U2Nyb2xMZWZ0KCkge1xuICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UuaXBhZCkge1xuICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc2Nyb2xsTGVmdCA9IDA7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc2Nyb2xsTGVmdCA9IDA7XG4gICAgICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgYXBwLmluaXRSZXNpemUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAkKHdpbmRvdykub24oJ3Jlc2l6ZScsIGFwcC5yZXNpemUpO1xuICAgICAgICAgICAgJCh3aW5kb3cpLm9uKCdvcmllbnRhdGlvbmNoYW5nZScsIGFwcC5vcmllbnRhdGlvbmNoYW5nZSk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5yZXNpemUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoYXBwLnNpemVOYXZiYXJzKSBhcHAuc2l6ZU5hdmJhcnMoKTtcbiAgICAgICAgICAgIF9maXhJcGFkQm9keVNjcm9sTGVmdCgpO1xuICAgICAgICAgICAgXG4gICAgICAgIH07XG4gICAgICAgIGFwcC5vcmllbnRhdGlvbmNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlICYmIGFwcC5kZXZpY2UubWluaW1hbFVpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5vcmllbnRhdGlvbiA9PT0gOTAgfHwgd2luZG93Lm9yaWVudGF0aW9uID09PSAtOTApIGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF9maXhJcGFkQm9keVNjcm9sTGVmdCgpO1xuICAgICAgICB9O1xuICAgICAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgU3RvcmUgYW5kIHBhcnNlIGZvcm1zIGRhdGEgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5mb3Jtc0RhdGEgPSB7fTtcbiAgICAgICAgYXBwLmZvcm1TdG9yZURhdGEgPSBmdW5jdGlvbiAoZm9ybUlkLCBmb3JtSlNPTikge1xuICAgICAgICAgICAgLy8gU3RvcmUgZm9ybSBkYXRhIGluIGFwcC5mb3Jtc0RhdGFcbiAgICAgICAgICAgIGFwcC5mb3Jtc0RhdGFbZm9ybUlkXSA9IGZvcm1KU09OO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFN0b3JlIGZvcm0gZGF0YSBpbiBsb2NhbCBzdG9yYWdlIGFsc29cbiAgICAgICAgICAgIGFwcC5sc1snZjdmb3JtLScgKyBmb3JtSWRdID0gSlNPTi5zdHJpbmdpZnkoZm9ybUpTT04pO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuZm9ybURlbGV0ZURhdGEgPSBmdW5jdGlvbiAoZm9ybUlkKSB7XG4gICAgICAgICAgICAvLyBEZWxldGUgZm9ybSBkYXRhIGZyb20gYXBwLmZvcm1zRGF0YVxuICAgICAgICAgICAgaWYgKGFwcC5mb3Jtc0RhdGFbZm9ybUlkXSkge1xuICAgICAgICAgICAgICAgIGFwcC5mb3Jtc0RhdGFbZm9ybUlkXSA9ICcnO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBhcHAuZm9ybXNEYXRhW2Zvcm1JZF07XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGVsZXRlIGZvcm0gZGF0YSBmcm9tIGxvY2FsIHN0b3JhZ2UgYWxzb1xuICAgICAgICAgICAgaWYgKGFwcC5sc1snZjdmb3JtLScgKyBmb3JtSWRdKSB7XG4gICAgICAgICAgICAgICAgYXBwLmxzWydmN2Zvcm0tJyArIGZvcm1JZF0gPSAnJztcbiAgICAgICAgICAgICAgICBhcHAubHMucmVtb3ZlSXRlbSgnZjdmb3JtLScgKyBmb3JtSWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBhcHAuZm9ybUdldERhdGEgPSBmdW5jdGlvbiAoZm9ybUlkKSB7XG4gICAgICAgICAgICAvLyBGaXJzdCBvZiBhbGwgY2hlY2sgaW4gbG9jYWwgc3RvcmFnZVxuICAgICAgICAgICAgaWYgKGFwcC5sc1snZjdmb3JtLScgKyBmb3JtSWRdKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoYXBwLmxzWydmN2Zvcm0tJyArIGZvcm1JZF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gVHJ5IHRvIGdldCBpdCBmcm9tIGZvcm1zRGF0YSBvYmpcbiAgICAgICAgICAgIGVsc2UgaWYgKGFwcC5mb3Jtc0RhdGFbZm9ybUlkXSkgcmV0dXJuIGFwcC5mb3Jtc0RhdGFbZm9ybUlkXTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmZvcm1Ub0pTT04gPSBmdW5jdGlvbiAoZm9ybSkge1xuICAgICAgICAgICAgZm9ybSA9ICQoZm9ybSk7XG4gICAgICAgICAgICBpZiAoZm9ybS5sZW5ndGggIT09IDEpIHJldHVybiBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBGb3JtIGRhdGFcbiAgICAgICAgICAgIHZhciBmb3JtRGF0YSA9IHt9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNraXAgaW5wdXQgdHlwZXNcbiAgICAgICAgICAgIHZhciBza2lwVHlwZXMgPSBbJ3N1Ym1pdCcsICdpbWFnZScsICdidXR0b24nLCAnZmlsZSddO1xuICAgICAgICAgICAgdmFyIHNraXBOYW1lcyA9IFtdO1xuICAgICAgICAgICAgZm9ybS5maW5kKCdpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYScpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBpbnB1dC5hdHRyKCduYW1lJyk7XG4gICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBpbnB1dC5hdHRyKCd0eXBlJyk7XG4gICAgICAgICAgICAgICAgdmFyIHRhZyA9IHRoaXMubm9kZU5hbWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICBpZiAoc2tpcFR5cGVzLmluZGV4T2YodHlwZSkgPj0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmIChza2lwTmFtZXMuaW5kZXhPZihuYW1lKSA+PSAwIHx8ICFuYW1lKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gJ3NlbGVjdCcgJiYgaW5wdXQucHJvcCgnbXVsdGlwbGUnKSkge1xuICAgICAgICAgICAgICAgICAgICBza2lwTmFtZXMucHVzaChuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgZm9ybURhdGFbbmFtZV0gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgZm9ybS5maW5kKCdzZWxlY3RbbmFtZT1cIicgKyBuYW1lICsgJ1wiXSBvcHRpb24nKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnNlbGVjdGVkKSBmb3JtRGF0YVtuYW1lXS5wdXNoKHRoaXMudmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lwTmFtZXMucHVzaChuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtRGF0YVtuYW1lXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0uZmluZCgnaW5wdXRbbmFtZT1cIicgKyBuYW1lICsgJ1wiXScpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGVja2VkKSBmb3JtRGF0YVtuYW1lXS5wdXNoKHRoaXMudmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncmFkaW8nIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lwTmFtZXMucHVzaChuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLmZpbmQoJ2lucHV0W25hbWU9XCInICsgbmFtZSArICdcIl0nKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY2hlY2tlZCkgZm9ybURhdGFbbmFtZV0gPSB0aGlzLnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdCA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybURhdGFbbmFtZV0gPSBpbnB1dC52YWwoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGZvcm0udHJpZ2dlcignZm9ybVRvSlNPTicsIHtmb3JtRGF0YTogZm9ybURhdGF9KTtcbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gZm9ybURhdGE7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5mb3JtRnJvbUpTT04gPSBmdW5jdGlvbiAoZm9ybSwgZm9ybURhdGEpIHtcbiAgICAgICAgICAgIGZvcm0gPSAkKGZvcm0pO1xuICAgICAgICAgICAgaWYgKGZvcm0ubGVuZ3RoICE9PSAxKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2tpcCBpbnB1dCB0eXBlc1xuICAgICAgICAgICAgdmFyIHNraXBUeXBlcyA9IFsnc3VibWl0JywgJ2ltYWdlJywgJ2J1dHRvbicsICdmaWxlJ107XG4gICAgICAgICAgICB2YXIgc2tpcE5hbWVzID0gW107XG4gICAgICAgIFxuICAgICAgICAgICAgZm9ybS5maW5kKCdpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYScpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgdmFyIG5hbWUgPSBpbnB1dC5hdHRyKCduYW1lJyk7XG4gICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBpbnB1dC5hdHRyKCd0eXBlJyk7XG4gICAgICAgICAgICAgICAgdmFyIHRhZyA9IHRoaXMubm9kZU5hbWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICBpZiAoIWZvcm1EYXRhW25hbWVdKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKHNraXBUeXBlcy5pbmRleE9mKHR5cGUpID49IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAoc2tpcE5hbWVzLmluZGV4T2YobmFtZSkgPj0gMCB8fCAhbmFtZSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmICh0YWcgPT09ICdzZWxlY3QnICYmIGlucHV0LnByb3AoJ211bHRpcGxlJykpIHtcbiAgICAgICAgICAgICAgICAgICAgc2tpcE5hbWVzLnB1c2gobmFtZSk7XG4gICAgICAgICAgICAgICAgICAgIGZvcm0uZmluZCgnc2VsZWN0W25hbWU9XCInICsgbmFtZSArICdcIl0gb3B0aW9uJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybURhdGFbbmFtZV0uaW5kZXhPZih0aGlzLnZhbHVlKSA+PSAwKSB0aGlzLnNlbGVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgdGhpcy5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnY2hlY2tib3gnIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lwTmFtZXMucHVzaChuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLmZpbmQoJ2lucHV0W25hbWU9XCInICsgbmFtZSArICdcIl0nKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1EYXRhW25hbWVdLmluZGV4T2YodGhpcy52YWx1ZSkgPj0gMCkgdGhpcy5jaGVja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB0aGlzLmNoZWNrZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JhZGlvJyA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2tpcE5hbWVzLnB1c2gobmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybS5maW5kKCdpbnB1dFtuYW1lPVwiJyArIG5hbWUgKyAnXCJdJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3JtRGF0YVtuYW1lXSA9PT0gdGhpcy52YWx1ZSkgdGhpcy5jaGVja2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB0aGlzLmNoZWNrZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbChmb3JtRGF0YVtuYW1lXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBmb3JtLnRyaWdnZXIoJ2Zvcm1Gcm9tSlNPTicsIHtmb3JtRGF0YTogZm9ybURhdGF9KTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmluaXRGb3Jtc1N0b3JhZ2UgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICB2YXIgZm9ybXMgPSBwYWdlQ29udGFpbmVyLmZpbmQoJ2Zvcm0uc3RvcmUtZGF0YScpO1xuICAgICAgICAgICAgaWYgKGZvcm1zLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBQYXJzZSBmb3JtcyBkYXRhIGFuZCBmaWxsIGZvcm0gaWYgdGhlcmUgaXMgc3VjaCBkYXRhXG4gICAgICAgICAgICBmb3Jtcy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgaWQgPSB0aGlzLmdldEF0dHJpYnV0ZSgnaWQnKTtcbiAgICAgICAgICAgICAgICBpZiAoIWlkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIGZvcm1EYXRhID0gYXBwLmZvcm1HZXREYXRhKGlkKTtcbiAgICAgICAgICAgICAgICBpZiAoZm9ybURhdGEpIGFwcC5mb3JtRnJvbUpTT04odGhpcywgZm9ybURhdGEpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvLyBVcGRhdGUgZm9ybXMgZGF0YSBvbiBpbnB1dHMgY2hhbmdlXG4gICAgICAgICAgICBmdW5jdGlvbiBzdG9yZUZvcm0oKSB7XG4gICAgICAgICAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi9cbiAgICAgICAgICAgICAgICB2YXIgZm9ybSA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgdmFyIGZvcm1JZCA9IGZvcm1bMF0uaWQ7XG4gICAgICAgICAgICAgICAgaWYgKCFmb3JtSWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgZm9ybUpTT04gPSBhcHAuZm9ybVRvSlNPTihmb3JtKTtcbiAgICAgICAgICAgICAgICBpZiAoIWZvcm1KU09OKSByZXR1cm47XG4gICAgICAgICAgICAgICAgYXBwLmZvcm1TdG9yZURhdGEoZm9ybUlkLCBmb3JtSlNPTik7XG4gICAgICAgICAgICAgICAgZm9ybS50cmlnZ2VyKCdzdG9yZScsIHtkYXRhOiBmb3JtSlNPTn0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9ybXMub24oJ2NoYW5nZSBzdWJtaXQnLCBzdG9yZUZvcm0pO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIERldGFjaCBMaXN0ZW5lcnNcbiAgICAgICAgICAgIGZ1bmN0aW9uIHBhZ2VCZWZvcmVSZW1vdmUoKSB7XG4gICAgICAgICAgICAgICAgZm9ybXMub2ZmKCdjaGFuZ2Ugc3VibWl0Jywgc3RvcmVGb3JtKTtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyLm9mZigncGFnZUJlZm9yZVJlbW92ZScsIHBhZ2VCZWZvcmVSZW1vdmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5vbigncGFnZUJlZm9yZVJlbW92ZScsIHBhZ2VCZWZvcmVSZW1vdmUpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBBamF4IHN1Ym1pdCBmb3IgZm9ybXMgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIC8vIEFqYXggc3VibWl0IG9uIGZvcm1zXG4gICAgICAgICQoZG9jdW1lbnQpLm9uKCdzdWJtaXQgY2hhbmdlJywgJ2Zvcm0uYWpheC1zdWJtaXQsIGZvcm0uYWpheC1zdWJtaXQtb25jaGFuZ2UnLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgdmFyIGZvcm0gPSAkKHRoaXMpO1xuICAgICAgICAgICAgaWYgKGUudHlwZSA9PT0gJ2NoYW5nZScgJiYgIWZvcm0uaGFzQ2xhc3MoJ2FqYXgtc3VibWl0LW9uY2hhbmdlJykpIHJldHVybjtcbiAgICAgICAgICAgIGlmIChlLnR5cGUgPT09ICdzdWJtaXQnKSBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHZhciBtZXRob2QgPSBmb3JtLmF0dHIoJ21ldGhvZCcpIHx8ICdHRVQnO1xuICAgICAgICAgICAgdmFyIGNvbnRlbnRUeXBlID0gZm9ybS5wcm9wKCdlbmN0eXBlJykgfHwgZm9ybS5hdHRyKCdlbmN0eXBlJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHVybCA9IGZvcm0uYXR0cignYWN0aW9uJyk7XG4gICAgICAgICAgICBpZiAoIXVybCkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBkYXRhO1xuICAgICAgICAgICAgaWYgKG1ldGhvZCA9PT0gJ1BPU1QnKSBkYXRhID0gbmV3IEZvcm1EYXRhKGZvcm1bMF0pO1xuICAgICAgICAgICAgZWxzZSBkYXRhID0gJC5zZXJpYWxpemVPYmplY3QoYXBwLmZvcm1Ub0pTT04oZm9ybVswXSkpO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciB4aHIgPSAkLmFqYXgoe1xuICAgICAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kLFxuICAgICAgICAgICAgICAgIHVybDogdXJsLFxuICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiBjb250ZW50VHlwZSxcbiAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLFxuICAgICAgICAgICAgICAgIGJlZm9yZVNlbmQ6IGZ1bmN0aW9uICh4aHIpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9ybS50cmlnZ2VyKCdiZWZvcmVTdWJtaXQnLCB7ZGF0YTpkYXRhLCB4aHI6IHhocn0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uICh4aHIpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9ybS50cmlnZ2VyKCdzdWJtaXRFcnJvcicsIHtkYXRhOmRhdGEsIHhocjogeGhyfSk7ICBcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvcm0udHJpZ2dlcignc3VibWl0dGVkJywge2RhdGE6IGRhdGEsIHhocjogeGhyfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgXG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIFJlc2l6YWJsZSB0ZXh0YXJlYSAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLnJlc2l6ZVRleHRhcmVhID0gZnVuY3Rpb24gKHRleHRhcmVhKSB7XG4gICAgICAgICAgICB0ZXh0YXJlYSA9ICQodGV4dGFyZWEpO1xuICAgICAgICAgICAgaWYgKCF0ZXh0YXJlYS5oYXNDbGFzcygncmVzaXphYmxlJykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0ZXh0YXJlYS5jc3MoeydoZWlnaHQnOiAnJ30pO1xuICAgICAgICAgICAgdmFyIGhlaWdodCA9IHRleHRhcmVhWzBdLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgIHZhciBkaWZmID0gaGVpZ2h0IC0gdGV4dGFyZWFbMF0uY2xpZW50SGVpZ2h0O1xuICAgICAgICAgICAgdmFyIHNjcm9sbEhlaWdodCA9IHRleHRhcmVhWzBdLnNjcm9sbEhlaWdodDtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoc2Nyb2xsSGVpZ2h0ICsgZGlmZiA+IGhlaWdodCkge1xuICAgICAgICAgICAgICAgIHZhciBuZXdBcmVhSGVpZ2h0ID0gc2Nyb2xsSGVpZ2h0ICsgZGlmZjtcbiAgICAgICAgICAgICAgICB0ZXh0YXJlYS5jc3MoJ2hlaWdodCcsIG5ld0FyZWFIZWlnaHQgKyAncHgnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnJlc2l6YWJsZVRleHRhcmVhID0gZnVuY3Rpb24gKHRleHRhcmVhKSB7XG4gICAgICAgICAgICB0ZXh0YXJlYSA9ICQodGV4dGFyZWEpO1xuICAgICAgICAgICAgaWYgKHRleHRhcmVhLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgdmFyIHRleHRhcmVhVGltZW91dDtcbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRleHRhcmVhKCkge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0ZXh0YXJlYVRpbWVvdXQpO1xuICAgICAgICAgICAgICAgIHRleHRhcmVhVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBhcHAucmVzaXplVGV4dGFyZWEodGV4dGFyZWEpO1xuICAgICAgICAgICAgICAgIH0sIDApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGV4dGFyZWFbMF0uZjdEZXN0cm95UmVzaXphYmxlVGV4dGFyZWEgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdGV4dGFyZWEub2ZmKCdjaGFuZ2Uga2V5ZG93biBrZXlwcmVzcyBrZXl1cCBwYXN0ZSBjdXQnLCBoYW5kbGVUZXh0YXJlYSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmV0dXJuIHRleHRhcmVhLm9uKCdjaGFuZ2Uga2V5ZG93biBrZXlwcmVzcyBrZXl1cCBwYXN0ZSBjdXQnLCBoYW5kbGVUZXh0YXJlYSk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5kZXN0cm95UmVzaXphYmxlVGV4dGFyZWEgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICBpZiAocGFnZUNvbnRhaW5lci5sZW5ndGggPiAwICYmIHBhZ2VDb250YWluZXIuaXMoJ3RleHRhcmVhJykgJiYgcGFnZUNvbnRhaW5lclswXS5mN0Rlc3Ryb3lSZXNpemFibGVUZXh0YXJlYSkge1xuICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXJbMF0uZjdEZXN0cm95UmVzaXphYmxlVGV4dGFyZWEoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKHBhZ2VDb250YWluZXIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIuZmluZCgndGV4dGFyZWEucmVzaWFibGUnKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRleHRhcmVhID0gdGhpcztcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRleHRhcmVhLmY3RGVzdHJveVJlc2l6YWJsZVRleHRhcmVhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0YXJlYS5mN0Rlc3Ryb3lSZXNpemFibGVUZXh0YXJlYSAoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBhcHAuaW5pdFBhZ2VSZXNpemFibGVUZXh0YXJlYSA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIHZhciB0ZXh0YXJlYXMgPSBwYWdlQ29udGFpbmVyLmZpbmQoJ3RleHRhcmVhLnJlc2l6YWJsZScpO1xuICAgICAgICAgICAgdGV4dGFyZWFzLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGFwcC5yZXNpemFibGVUZXh0YXJlYSh0aGlzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIE1hdGVyaWFsIFRleHQgSW5wdXRzICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5pbml0UGFnZU1hdGVyaWFsSW5wdXRzID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgdmFyIHRleHRhcmVhcyA9IHBhZ2VDb250YWluZXIuZmluZCgndGV4dGFyZWEucmVzaXphYmxlJyk7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyLmZpbmQoJy5pdGVtLWlucHV0JykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGl0ZW1JbnB1dCA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgdmFyIG5vdElucHV0cyA9IFsnY2hlY2tib3gnLCAnYnV0dG9uJywgJ3N1Ym1pdCcsICdyYW5nZScsICdyYWRpbycsICdpbWFnZSddO1xuICAgICAgICAgICAgICAgIGl0ZW1JbnB1dC5maW5kKCdpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYScpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaW5wdXQgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBpZiAobm90SW5wdXRzLmluZGV4T2YoaW5wdXQuYXR0cigndHlwZScpKSA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1JbnB1dC5hZGRDbGFzcygnaXRlbS1pbnB1dC1maWVsZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlucHV0LnZhbCgpLnRyaW0oKSAhPT0gJycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dC5wYXJlbnRzKCcuaXRlbS1pbnB1dCwgLmlucHV0LWZpZWxkJykuYWRkKGlucHV0LnBhcmVudHMoJy5pdGVtLWlubmVyJykpLmFkZENsYXNzKCdub3QtZW1wdHktc3RhdGUnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGlmIChpdGVtSW5wdXQucGFyZW50cygnLmlucHV0LWl0ZW0sIC5pbnB1dHMtbGlzdCcpLmxlbmd0aCA+IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICBpdGVtSW5wdXQucGFyZW50cygnLmxpc3QtYmxvY2snKS5lcSgwKS5hZGRDbGFzcygnaW5wdXRzLWxpc3QnKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBNYXRlcmlhbCBGb2N1cyBJbnB1dHMgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLmluaXRNYXRlcmlhbFdhdGNoSW5wdXRzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIG5vdElucHV0cyA9IFsnY2hlY2tib3gnLCAnYnV0dG9uJywgJ3N1Ym1pdCcsICdyYW5nZScsICdyYWRpbycsICdpbWFnZSddO1xuICAgICAgICAgICAgZnVuY3Rpb24gYWRkRm9jdXNTdGF0ZShlKSB7XG4gICAgICAgICAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUqL1xuICAgICAgICAgICAgICAgIHZhciBpID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGkuYXR0cigndHlwZScpO1xuICAgICAgICAgICAgICAgIGlmIChub3RJbnB1dHMuaW5kZXhPZih0eXBlKSA+PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIGVscyA9IGkuYWRkKGkucGFyZW50cygnLml0ZW0taW5wdXQsIC5pbnB1dC1maWVsZCcpKS5hZGQoaS5wYXJlbnRzKCcuaXRlbS1pbm5lcicpLmVxKDApKTtcbiAgICAgICAgICAgICAgICBlbHMuYWRkQ2xhc3MoJ2ZvY3VzLXN0YXRlJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiByZW1vdmVGb2N1c1N0YXRlKGUpIHtcbiAgICAgICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSovXG4gICAgICAgICAgICAgICAgdmFyIGkgPSAkKHRoaXMpLCB2YWx1ZSA9IGkudmFsKCk7XG4gICAgICAgICAgICAgICAgdmFyIHR5cGUgPSBpLmF0dHIoJ3R5cGUnKTtcbiAgICAgICAgICAgICAgICBpZiAobm90SW5wdXRzLmluZGV4T2YodHlwZSkgPj0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHZhciBlbHMgPSBpLmFkZChpLnBhcmVudHMoJy5pdGVtLWlucHV0LCAuaW5wdXQtZmllbGQnKSkuYWRkKGkucGFyZW50cygnLml0ZW0taW5uZXInKS5lcSgwKSk7XG4gICAgICAgICAgICAgICAgZWxzLnJlbW92ZUNsYXNzKCdmb2N1cy1zdGF0ZScpO1xuICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS50cmltKCkgIT09ICcnKSB7XG4gICAgICAgICAgICAgICAgICAgIGVscy5hZGRDbGFzcygnbm90LWVtcHR5LXN0YXRlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBlbHMucmVtb3ZlQ2xhc3MoJ25vdC1lbXB0eS1zdGF0ZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIHdhdGNoQ2hhbmdlU3RhdGUoZSkge1xuICAgICAgICAgICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlKi9cbiAgICAgICAgICAgICAgICB2YXIgaSA9ICQodGhpcyksIHZhbHVlID0gaS52YWwoKTtcbiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGkuYXR0cigndHlwZScpO1xuICAgICAgICAgICAgICAgIGlmIChub3RJbnB1dHMuaW5kZXhPZih0eXBlKSA+PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIGVscyA9IGkuYWRkKGkucGFyZW50cygnLml0ZW0taW5wdXQsIC5pbnB1dC1maWVsZCcpKS5hZGQoaS5wYXJlbnRzKCcuaXRlbS1pbm5lcicpLmVxKDApKTtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUudHJpbSgpICE9PSAnJykge1xuICAgICAgICAgICAgICAgICAgICBlbHMuYWRkQ2xhc3MoJ25vdC1lbXB0eS1zdGF0ZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZWxzLnJlbW92ZUNsYXNzKCdub3QtZW1wdHktc3RhdGUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAkKGRvY3VtZW50KS5vbignY2hhbmdlJywgJy5pdGVtLWlucHV0IGlucHV0LCAuaXRlbS1pbnB1dCBzZWxlY3QsIC5pdGVtLWlucHV0IHRleHRhcmVhLCBpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCcsIHdhdGNoQ2hhbmdlU3RhdGUsIHRydWUpO1xuICAgICAgICAgICAgJChkb2N1bWVudCkub24oJ2ZvY3VzJywgJy5pdGVtLWlucHV0IGlucHV0LCAuaXRlbS1pbnB1dCBzZWxlY3QsIC5pdGVtLWlucHV0IHRleHRhcmVhLCBpbnB1dCwgdGV4dGFyZWEsIHNlbGVjdCcsIGFkZEZvY3VzU3RhdGUsIHRydWUpO1xuICAgICAgICAgICAgJChkb2N1bWVudCkub24oJ2JsdXInLCAnLml0ZW0taW5wdXQgaW5wdXQsIC5pdGVtLWlucHV0IHNlbGVjdCwgLml0ZW0taW5wdXQgdGV4dGFyZWEsIGlucHV0LCB0ZXh0YXJlYSwgc2VsZWN0JywgcmVtb3ZlRm9jdXNTdGF0ZSwgdHJ1ZSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgSGFuZGxlIEJyb3dzZXIncyBIaXN0b3J5ICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5wdXNoU3RhdGVRdWV1ZSA9IFtdO1xuICAgICAgICBhcHAucHVzaFN0YXRlQ2xlYXJRdWV1ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmIChhcHAucHVzaFN0YXRlUXVldWUubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICB2YXIgcXVldWUgPSBhcHAucHVzaFN0YXRlUXVldWUucG9wKCk7XG4gICAgICAgICAgICB2YXIgYW5pbWF0ZVBhZ2VzO1xuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMucHVzaFN0YXRlTm9BbmltYXRpb24gPT09IHRydWUpIGFuaW1hdGVQYWdlcyA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHF1ZXVlLmFjdGlvbiA9PT0gJ2JhY2snKSB7XG4gICAgICAgICAgICAgICAgYXBwLnJvdXRlci5iYWNrKHF1ZXVlLnZpZXcsIHthbmltYXRlUGFnZXM6IGFuaW1hdGVQYWdlc30pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHF1ZXVlLmFjdGlvbiA9PT0gJ2xvYWRQYWdlJykge1xuICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIubG9hZChxdWV1ZS52aWV3LCB7dXJsOiBxdWV1ZS5zdGF0ZVVybCwgYW5pbWF0ZVBhZ2VzOiBhbmltYXRlUGFnZXMsIHB1c2hTdGF0ZTogZmFsc2V9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChxdWV1ZS5hY3Rpb24gPT09ICdsb2FkQ29udGVudCcpIHtcbiAgICAgICAgICAgICAgICBhcHAucm91dGVyLmxvYWQocXVldWUudmlldywge2NvbnRlbnQ6IHF1ZXVlLnN0YXRlQ29udGVudCwgYW5pbWF0ZVBhZ2VzOiBhbmltYXRlUGFnZXMsIHB1c2hTdGF0ZTogZmFsc2V9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChxdWV1ZS5hY3Rpb24gPT09ICdsb2FkUGFnZU5hbWUnKSB7XG4gICAgICAgICAgICAgICAgYXBwLnJvdXRlci5sb2FkKHF1ZXVlLnZpZXcsIHtwYWdlTmFtZTogcXVldWUuc3RhdGVQYWdlTmFtZSwgdXJsOiBxdWV1ZS5zdGF0ZVVybCwgYW5pbWF0ZVBhZ2VzOiBhbmltYXRlUGFnZXMsIHB1c2hTdGF0ZTogZmFsc2V9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGFwcC5pbml0UHVzaFN0YXRlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIGJsb2NrUG9wc3RhdGUgPSB0cnVlO1xuICAgICAgICAgICAgJCh3aW5kb3cpLm9uKCdsb2FkJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBibG9ja1BvcHN0YXRlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSAmJiBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnKSB7XG4gICAgICAgICAgICAgICAgYmxvY2tQb3BzdGF0ZSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVBvcFN0YXRlKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoYmxvY2tQb3BzdGF0ZSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHZhciBtYWluVmlldyA9IGFwcC5tYWluVmlldztcbiAgICAgICAgICAgICAgICBpZiAoIW1haW5WaWV3KSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIHN0YXRlID0gZS5zdGF0ZTtcbiAgICAgICAgICAgICAgICBpZiAoIXN0YXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXRlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmlld0luZGV4OiBhcHAudmlld3MuaW5kZXhPZihtYWluVmlldyksXG4gICAgICAgICAgICAgICAgICAgICAgICB1cmwgOiBtYWluVmlldy5oaXN0b3J5WzBdXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZS52aWV3SW5kZXggPCAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIHZpZXcgPSBhcHAudmlld3Nbc3RhdGUudmlld0luZGV4XTtcbiAgICAgICAgICAgICAgICB2YXIgc3RhdGVVcmwgPSBzdGF0ZSAmJiBzdGF0ZS51cmwgfHwgdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHZhciBzdGF0ZUNvbnRlbnQgPSBzdGF0ZSAmJiBzdGF0ZS5jb250ZW50IHx8IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB2YXIgc3RhdGVQYWdlTmFtZSA9IHN0YXRlICYmIHN0YXRlLnBhZ2VOYW1lIHx8IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB2YXIgYW5pbWF0ZVBhZ2VzO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5wdXNoU3RhdGVOb0FuaW1hdGlvbiA9PT0gdHJ1ZSkgYW5pbWF0ZVBhZ2VzID0gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZVVybCAhPT0gdmlldy51cmwpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcuaGlzdG9yeS5pbmRleE9mKHN0YXRlVXJsKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBHbyBCYWNrXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5hbGxvd1BhZ2VDaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLmJhY2sodmlldywge3VybDp1bmRlZmluZWQsIGFuaW1hdGVQYWdlczogYW5pbWF0ZVBhZ2VzLCBwdXNoU3RhdGU6IGZhbHNlLCBwcmVsb2FkT25seTpmYWxzZX0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnB1c2hTdGF0ZVF1ZXVlLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdiYWNrJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlldzogdmlld1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHN0YXRlQ29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCBQYWdlXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5hbGxvd1BhZ2VDaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLmxvYWQodmlldywge2NvbnRlbnQ6c3RhdGVDb250ZW50LCBhbmltYXRlUGFnZXM6IGFuaW1hdGVQYWdlcywgcHVzaFN0YXRlOiBmYWxzZX0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnB1c2hTdGF0ZVF1ZXVlLnVuc2hpZnQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdsb2FkQ29udGVudCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlQ29udGVudDogc3RhdGVDb250ZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWV3OiB2aWV3XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHN0YXRlUGFnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIExvYWQgUGFnZSBieSBwYWdlIG5hbWUgd2l0aCBEb20gQ2FjaGVcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LmFsbG93UGFnZUNoYW5nZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIubG9hZCh2aWV3LCB7cGFnZU5hbWU6c3RhdGVQYWdlTmFtZSwgdXJsOiBzdGF0ZVVybCwgYW5pbWF0ZVBhZ2VzOiBhbmltYXRlUGFnZXMsIHB1c2hTdGF0ZTogZmFsc2V9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5wdXNoU3RhdGVRdWV1ZS51bnNoaWZ0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiAnbG9hZFBhZ2VOYW1lJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVQYWdlTmFtZTogc3RhdGVQYWdlTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmlldzogdmlld1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIExvYWQgUGFnZVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcuYWxsb3dQYWdlQ2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci5sb2FkKHZpZXcsIHt1cmw6c3RhdGVVcmwsIGFuaW1hdGVQYWdlczogYW5pbWF0ZVBhZ2VzLCBwdXNoU3RhdGU6IGZhbHNlfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAucHVzaFN0YXRlUXVldWUudW5zaGlmdCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ2xvYWRQYWdlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVVcmw6IHN0YXRlVXJsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWV3OiB2aWV3XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAkKHdpbmRvdykub24oJ3BvcHN0YXRlJywgaGFuZGxlUG9wU3RhdGUpO1xuICAgICAgICB9O1xuICAgICAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICBGcmFtZXdvcms3IFN3aXBlciBBZGRpdGlvbnNcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLnN3aXBlciA9IGZ1bmN0aW9uIChjb250YWluZXIsIHBhcmFtcykge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBTd2lwZXIoY29udGFpbmVyLCBwYXJhbXMpO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuaW5pdFBhZ2VTd2lwZXIgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICB2YXIgc3dpcGVycyA9IHBhZ2VDb250YWluZXIuZmluZCgnLnN3aXBlci1pbml0LCAudGFicy1zd2lwZWFibGUtd3JhcCcpO1xuICAgICAgICAgICAgaWYgKHN3aXBlcnMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBmdW5jdGlvbiBkZXN0cm95U3dpcGVyT25SZW1vdmUoc2xpZGVyKSB7XG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gZGVzdHJveVN3aXBlcigpIHtcbiAgICAgICAgICAgICAgICAgICAgc2xpZGVyLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5vZmYoJ3BhZ2VCZWZvcmVSZW1vdmUnLCBkZXN0cm95U3dpcGVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5vbigncGFnZUJlZm9yZVJlbW92ZScsIGRlc3Ryb3lTd2lwZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3dpcGVycy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgc3dpcGVyID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICBpZiAoc3dpcGVyLmhhc0NsYXNzKCd0YWJzLXN3aXBlYWJsZS13cmFwJykpIHtcbiAgICAgICAgICAgICAgICAgICAgc3dpcGVyLmFkZENsYXNzKCdzd2lwZXItY29udGFpbmVyJykuY2hpbGRyZW4oJy50YWJzJykuYWRkQ2xhc3MoJ3N3aXBlci13cmFwcGVyJykuY2hpbGRyZW4oJy50YWInKS5hZGRDbGFzcygnc3dpcGVyLXNsaWRlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBwYXJhbXM7XG4gICAgICAgICAgICAgICAgaWYgKHN3aXBlci5kYXRhKCdzd2lwZXInKSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSBKU09OLnBhcnNlKHN3aXBlci5kYXRhKCdzd2lwZXInKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSBzd2lwZXIuZGF0YXNldCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoc3dpcGVyLmhhc0NsYXNzKCd0YWJzLXN3aXBlYWJsZS13cmFwJykpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLm9uU2xpZGVDaGFuZ2VTdGFydCA9IGZ1bmN0aW9uIChzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuc2hvd1RhYihzLnNsaWRlcy5lcShzLmFjdGl2ZUluZGV4KSk7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBfc2xpZGVyID0gYXBwLnN3aXBlcihzd2lwZXJbMF0sIHBhcmFtcyk7XG4gICAgICAgICAgICAgICAgZGVzdHJveVN3aXBlck9uUmVtb3ZlKF9zbGlkZXIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5yZWluaXRQYWdlU3dpcGVyID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgdmFyIHNsaWRlcnMgPSBwYWdlQ29udGFpbmVyLmZpbmQoJy5zd2lwZXItaW5pdCwgLnRhYnMtc3dpcGVhYmxlLXdyYXAnKTtcbiAgICAgICAgICAgIGlmIChzbGlkZXJzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzbGlkZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNsaWRlckluc3RhbmNlID0gc2xpZGVyc1swXS5zd2lwZXI7XG4gICAgICAgICAgICAgICAgaWYgKHNsaWRlckluc3RhbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgIHNsaWRlckluc3RhbmNlLnVwZGF0ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIFBob3RvIEJyb3dzZXIgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgdmFyIFBob3RvQnJvd3NlciA9IGZ1bmN0aW9uIChwYXJhbXMpIHtcbiAgICAgICAgICAgIHZhciBwYiA9IHRoaXMsIGk7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIGRlZmF1bHRzID0ge1xuICAgICAgICAgICAgICAgIHBob3RvcyA6IFtdLFxuICAgICAgICAgICAgICAgIGluaXRpYWxTbGlkZTogMCxcbiAgICAgICAgICAgICAgICBzcGFjZUJldHdlZW46IDIwLFxuICAgICAgICAgICAgICAgIHNwZWVkOiAzMDAsXG4gICAgICAgICAgICAgICAgem9vbTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBtYXhab29tOiAzLFxuICAgICAgICAgICAgICAgIG1pblpvb206IDEsXG4gICAgICAgICAgICAgICAgZXhwb3NpdGlvbjogdHJ1ZSxcbiAgICAgICAgICAgICAgICBleHBvc2l0aW9uSGlkZUNhcHRpb25zOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB0eXBlOiAnc3RhbmRhbG9uZScsXG4gICAgICAgICAgICAgICAgbmF2YmFyOiB0cnVlLFxuICAgICAgICAgICAgICAgIHRvb2xiYXI6IHRydWUsXG4gICAgICAgICAgICAgICAgdGhlbWU6ICdsaWdodCcsXG4gICAgICAgICAgICAgICAgc3dpcGVUb0Nsb3NlOiB0cnVlLFxuICAgICAgICAgICAgICAgIGJhY2tMaW5rVGV4dDogJ0Nsb3NlJyxcbiAgICAgICAgICAgICAgICBvZlRleHQ6ICdvZicsXG4gICAgICAgICAgICAgICAgbG9vcDogZmFsc2UsXG4gICAgICAgICAgICAgICAgbGF6eUxvYWRpbmc6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGxhenlMb2FkaW5nSW5QcmV2TmV4dDogZmFsc2UsXG4gICAgICAgICAgICAgICAgbGF6eUxvYWRpbmdPblRyYW5zaXRpb25TdGFydDogZmFsc2UsXG4gICAgICAgICAgICAgICAgbWF0ZXJpYWw6IGFwcC5wYXJhbXMubWF0ZXJpYWwsXG4gICAgICAgICAgICAgICAgbWF0ZXJpYWxQcmVsb2FkZXJTdmc6IGFwcC5wYXJhbXMubWF0ZXJpYWxQcmVsb2FkZXJTdmcsXG4gICAgICAgICAgICAgICAgbWF0ZXJpYWxQcmVsb2FkZXJIdG1sOiBhcHAucGFyYW1zLm1hdGVyaWFsUHJlbG9hZGVySHRtbCxcbiAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgIENhbGxiYWNrczpcbiAgICAgICAgICAgICAgICBvbkxhenlJbWFnZUxvYWQocGIsIHNsaWRlLCBpbWcpXG4gICAgICAgICAgICAgICAgb25MYXp5SW1hZ2VSZWFkeShwYiwgc2xpZGUsIGltZylcbiAgICAgICAgICAgICAgICBvbk9wZW4ocGIpXG4gICAgICAgICAgICAgICAgb25DbG9zZShwYilcbiAgICAgICAgICAgICAgICBvblRyYW5zaXRpb25TdGFydChzd2lwZXIpXG4gICAgICAgICAgICAgICAgb25UcmFuc2l0aW9uRW5kKHN3aXBlcilcbiAgICAgICAgICAgICAgICBvblNsaWRlQ2hhbmdlU3RhcnQoc3dpcGVyKVxuICAgICAgICAgICAgICAgIG9uU2xpZGVDaGFuZ2VFbmQoc3dpcGVyKVxuICAgICAgICAgICAgICAgIG9uVGFwKHN3aXBlciwgZSlcbiAgICAgICAgICAgICAgICBvbkNsaWNrKHN3aXBlciwgZSlcbiAgICAgICAgICAgICAgICBvbkRvdWJsZVRhcChzd2lwZXIsIGUpXG4gICAgICAgICAgICAgICAgb25Td2lwZVRvQ2xvc2UocGIpXG4gICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcbiAgICAgICAgICAgIGlmICghcGFyYW1zLmJhY2tMaW5rVGV4dCAmJiBhcHAucGFyYW1zLm1hdGVyaWFsKSBkZWZhdWx0cy5iYWNrTGlua1RleHQgPSAnJztcbiAgICAgICAgICAgIGZvciAodmFyIGRlZiBpbiBkZWZhdWx0cykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW2RlZl0gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtc1tkZWZdID0gZGVmYXVsdHNbZGVmXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgcGIucGFyYW1zID0gcGFyYW1zO1xuICAgICAgICAgICAgcGIucGFyYW1zLmljb25zQ29sb3JDbGFzcyA9IHBiLnBhcmFtcy5pY29uc0NvbG9yID8gJ2NvbG9yLScgKyBwYi5wYXJhbXMuaWNvbnNDb2xvciA6IChwYi5wYXJhbXMudGhlbWUgPT09ICdkYXJrJyA/ICdjb2xvci13aGl0ZScgOiAnJyk7XG4gICAgICAgICAgICBwYi5wYXJhbXMucHJlbG9hZGVyQ29sb3JDbGFzcyA9IHBiLnBhcmFtcy50aGVtZSA9PT0gJ2RhcmsnID8gJ3ByZWxvYWRlci13aGl0ZScgOiAnJztcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBUZW1wbGF0ZXNcbiAgICAgICAgICAgIHZhciBwaG90b1RlbXBsYXRlID0gcGIucGFyYW1zLnBob3RvVGVtcGxhdGUgfHwgXG4gICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwaG90by1icm93c2VyLXNsaWRlIHN3aXBlci1zbGlkZVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAnPHNwYW4gY2xhc3M9XCJwaG90by1icm93c2VyLXpvb20tY29udGFpbmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGltZyBzcmM9XCJ7e2pzIFwidGhpcy51cmwgfHwgdGhpc1wifX1cIj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvc3Bhbj4nICtcbiAgICAgICAgICAgICAgICAnPC9kaXY+JztcbiAgICAgICAgICAgIHZhciBwaG90b0xhenlUZW1wbGF0ZSA9IHBiLnBhcmFtcy5sYXp5UGhvdG9UZW1wbGF0ZSB8fFxuICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicGhvdG8tYnJvd3Nlci1zbGlkZSBwaG90by1icm93c2VyLXNsaWRlLWxhenkgc3dpcGVyLXNsaWRlXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicHJlbG9hZGVyIHt7QHJvb3QucHJlbG9hZGVyQ29sb3JDbGFzc319XCI+e3sjaWYgQHJvb3QubWF0ZXJpYWx9fXt7QHJvb3QubWF0ZXJpYWxQcmVsb2FkZXJIdG1sfX17ey9pZn19PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz1cInBob3RvLWJyb3dzZXItem9vbS1jb250YWluZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8aW1nIGRhdGEtc3JjPVwie3tqcyBcInRoaXMudXJsIHx8IHRoaXNcIn19XCIgY2xhc3M9XCJzd2lwZXItbGF6eVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9zcGFuPicgK1xuICAgICAgICAgICAgICAgICc8L2Rpdj4nO1xuICAgICAgICAgICAgdmFyIG9iamVjdFRlbXBsYXRlID0gcGIucGFyYW1zLm9iamVjdFRlbXBsYXRlIHx8XG4gICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwaG90by1icm93c2VyLXNsaWRlIHBob3RvLWJyb3dzZXItb2JqZWN0LXNsaWRlIHN3aXBlci1zbGlkZVwiPnt7anMgXCJ0aGlzLmh0bWwgfHwgdGhpc1wifX08L2Rpdj4nO1xuICAgICAgICAgICAgdmFyIGNhcHRpb25UZW1wbGF0ZSA9IHBiLnBhcmFtcy5jYXB0aW9uVGVtcGxhdGUgfHxcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBob3RvLWJyb3dzZXItY2FwdGlvblwiIGRhdGEtY2FwdGlvbi1pbmRleD1cInt7QGluZGV4fX1cIj4nICtcbiAgICAgICAgICAgICAgICAgICAgJ3t7Y2FwdGlvbn19JyArXG4gICAgICAgICAgICAgICAgJzwvZGl2Pic7XG4gICAgICAgICAgICB2YXIgbmF2YmFyVGVtcGxhdGUgPSBwYi5wYXJhbXMubmF2YmFyVGVtcGxhdGUgfHxcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIm5hdmJhclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIm5hdmJhci1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJsZWZ0IHNsaWRpbmdcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGEgaHJlZj1cIiNcIiBjbGFzcz1cImxpbmsgY2xvc2UtcG9wdXAgcGhvdG8tYnJvd3Nlci1jbG9zZS1saW5rIHt7I3VubGVzcyBiYWNrTGlua1RleHR9fWljb24tb25seXt7L3VubGVzc319IHt7anMgXCJ0aGlzLnR5cGUgPT09IFxcJ3BhZ2VcXCcgPyBcXCdiYWNrXFwnIDogXFwnXFwnXCJ9fVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGkgY2xhc3M9XCJpY29uIGljb24tYmFjayB7e2ljb25zQ29sb3JDbGFzc319XCI+PC9pPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgYmFja0xpbmtUZXh0fX08c3Bhbj57e2JhY2tMaW5rVGV4dH19PC9zcGFuPnt7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9hPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJjZW50ZXIgc2xpZGluZ1wiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz1cInBob3RvLWJyb3dzZXItY3VycmVudFwiPjwvc3Bhbj4gJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPVwicGhvdG8tYnJvd3Nlci1vZlwiPnt7b2ZUZXh0fX08L3NwYW4+ICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz1cInBob3RvLWJyb3dzZXItdG90YWxcIj48L3NwYW4+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInJpZ2h0XCI+PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAnPC9kaXY+JztcbiAgICAgICAgICAgIHZhciB0b29sYmFyVGVtcGxhdGUgPSBwYi5wYXJhbXMudG9vbGJhclRlbXBsYXRlIHx8XG4gICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJ0b29sYmFyIHRhYmJhclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInRvb2xiYXItaW5uZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8YSBocmVmPVwiI1wiIGNsYXNzPVwibGluayBwaG90by1icm93c2VyLXByZXZcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGkgY2xhc3M9XCJpY29uIGljb24tcHJldiB7e2ljb25zQ29sb3JDbGFzc319XCI+PC9pPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvYT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8YSBocmVmPVwiI1wiIGNsYXNzPVwibGluayBwaG90by1icm93c2VyLW5leHRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGkgY2xhc3M9XCJpY29uIGljb24tbmV4dCB7e2ljb25zQ29sb3JDbGFzc319XCI+PC9pPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvYT4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICc8L2Rpdj4nO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBodG1sVGVtcGxhdGUgPSB0Ny5jb21waWxlKCc8ZGl2IGNsYXNzPVwicGhvdG8tYnJvd3NlciBwaG90by1icm93c2VyLXt7dGhlbWV9fVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInZpZXcgbmF2YmFyLWZpeGVkIHRvb2xiYXItZml4ZWRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICd7eyN1bmxlc3MgbWF0ZXJpYWx9fXt7I2lmIG5hdmJhcn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICBuYXZiYXJUZW1wbGF0ZSArXG4gICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fXt7L3VubGVzc319JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBhZ2Ugbm8tdG9vbGJhciB7eyN1bmxlc3MgbmF2YmFyfX1uby1uYXZiYXJ7ey91bmxlc3N9fSB0b29sYmFyLWZpeGVkIG5hdmJhci1maXhlZFwiIGRhdGEtcGFnZT1cInBob3RvLWJyb3dzZXItc2xpZGVzXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIG1hdGVyaWFsfX17eyNpZiBuYXZiYXJ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hdmJhclRlbXBsYXRlICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fXt7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgdG9vbGJhcn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9vbGJhclRlbXBsYXRlICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicGhvdG8tYnJvd3Nlci1jYXB0aW9ucyBwaG90by1icm93c2VyLWNhcHRpb25zLXt7anMgXCJ0aGlzLmNhcHRpb25zVGhlbWUgfHwgdGhpcy50aGVtZVwifX1cIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2VhY2ggcGhvdG9zfX17eyNpZiBjYXB0aW9ufX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FwdGlvblRlbXBsYXRlICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2lmfX17ey9lYWNofX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwaG90by1icm93c2VyLXN3aXBlci1jb250YWluZXIgc3dpcGVyLWNvbnRhaW5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBob3RvLWJyb3dzZXItc3dpcGVyLXdyYXBwZXIgc3dpcGVyLXdyYXBwZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNlYWNoIHBob3Rvc319JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjanNfY29tcGFyZSBcInRoaXMuaHRtbCB8fCAoKHR5cGVvZiB0aGlzID09PSBcXCdzdHJpbmdcXCcgfHwgdGhpcyBpbnN0YW5jZW9mIFN0cmluZykgJiYgKHRoaXMuaW5kZXhPZihcXCc8XFwnKSA+PSAwIHx8IHRoaXMuaW5kZXhPZihcXCc+XFwnKSA+PSAwKSlcIn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqZWN0VGVtcGxhdGUgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7ZWxzZX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIEByb290LmxhenlMb2FkaW5nfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaG90b0xhenlUZW1wbGF0ZSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7ZWxzZX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGhvdG9UZW1wbGF0ZSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9qc19jb21wYXJlfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9lYWNofX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICc8L2Rpdj4nKShwYi5wYXJhbXMpO1xuICAgICAgICBcbiAgICAgICAgICAgIHBiLmFjdGl2ZUluZGV4ID0gcGIucGFyYW1zLmluaXRpYWxTbGlkZTtcbiAgICAgICAgICAgIHBiLm9wZW5JbmRleCA9IHBiLmFjdGl2ZUluZGV4O1xuICAgICAgICAgICAgcGIub3BlbmVkID0gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAgICAgcGIub3BlbiA9IGZ1bmN0aW9uIChpbmRleCkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5kZXggPT09ICd1bmRlZmluZWQnKSBpbmRleCA9IHBiLmFjdGl2ZUluZGV4O1xuICAgICAgICAgICAgICAgIGluZGV4ID0gcGFyc2VJbnQoaW5kZXgsIDEwKTtcbiAgICAgICAgICAgICAgICBpZiAocGIub3BlbmVkICYmIHBiLnN3aXBlcikge1xuICAgICAgICAgICAgICAgICAgICBwYi5zd2lwZXIuc2xpZGVUbyhpbmRleCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcGIub3BlbmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBwYi5vcGVuSW5kZXggPSBpbmRleDtcbiAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLnR5cGUgPT09ICdzdGFuZGFsb25lJykge1xuICAgICAgICAgICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKGh0bWxUZW1wbGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMudHlwZSA9PT0gJ3BvcHVwJykge1xuICAgICAgICAgICAgICAgICAgICBwYi5wb3B1cCA9IGFwcC5wb3B1cCgnPGRpdiBjbGFzcz1cInBvcHVwIHBob3RvLWJyb3dzZXItcG9wdXBcIj4nICsgaHRtbFRlbXBsYXRlICsgJzwvZGl2PicpO1xuICAgICAgICAgICAgICAgICAgICAkKHBiLnBvcHVwKS5vbignY2xvc2VkJywgcGIub25Qb3B1cENsb3NlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy50eXBlID09PSAncGFnZScpIHtcbiAgICAgICAgICAgICAgICAgICAgJChkb2N1bWVudCkub24oJ3BhZ2VCZWZvcmVJbml0JywgcGIub25QYWdlQmVmb3JlSW5pdCk7XG4gICAgICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCdwYWdlQmVmb3JlUmVtb3ZlJywgcGIub25QYWdlQmVmb3JlUmVtb3ZlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwYi5wYXJhbXMudmlldykgcGIucGFyYW1zLnZpZXcgPSBhcHAubWFpblZpZXc7XG4gICAgICAgICAgICAgICAgICAgIHBiLnBhcmFtcy52aWV3LmxvYWRDb250ZW50KGh0bWxUZW1wbGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcGIubGF5b3V0KHBiLm9wZW5JbmRleCk7XG4gICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy5vbk9wZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgcGIucGFyYW1zLm9uT3BlbihwYik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYi5jbG9zZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBwYi5vcGVuZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAoIXBiLnN3aXBlckNvbnRhaW5lciB8fCBwYi5zd2lwZXJDb250YWluZXIubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy5vbkNsb3NlKSB7XG4gICAgICAgICAgICAgICAgICAgIHBiLnBhcmFtcy5vbkNsb3NlKHBiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gRGV0YWNoIGV2ZW50c1xuICAgICAgICAgICAgICAgIHBiLmF0dGFjaEV2ZW50cyh0cnVlKTtcbiAgICAgICAgICAgICAgICAvLyBEZWxldGUgZnJvbSBET01cbiAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLnR5cGUgPT09ICdzdGFuZGFsb25lJykge1xuICAgICAgICAgICAgICAgICAgICBwYi5jb250YWluZXIucmVtb3ZlQ2xhc3MoJ3Bob3RvLWJyb3dzZXItaW4nKS5hZGRDbGFzcygncGhvdG8tYnJvd3Nlci1vdXQnKS5hbmltYXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGIuY29udGFpbmVyLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gRGVzdHJveSBzbGlkZXJcbiAgICAgICAgICAgICAgICBwYi5zd2lwZXIuZGVzdHJveSgpO1xuICAgICAgICAgICAgICAgIC8vIERlbGV0ZSByZWZlcmVuY2VzXG4gICAgICAgICAgICAgICAgcGIuc3dpcGVyID0gcGIuc3dpcGVyQ29udGFpbmVyID0gcGIuc3dpcGVyV3JhcHBlciA9IHBiLnNsaWRlcyA9IGdlc3R1cmVTbGlkZSA9IGdlc3R1cmVJbWcgPSBnZXN0dXJlSW1nV3JhcCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgcGIub25Qb3B1cENsb3NlID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBwYi5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICQocGIucG9wdXApLm9mZigncGFnZUJlZm9yZUluaXQnLCBwYi5vblBvcHVwQ2xvc2UpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBiLm9uUGFnZUJlZm9yZUluaXQgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGlmIChlLmRldGFpbC5wYWdlLm5hbWUgPT09ICdwaG90by1icm93c2VyLXNsaWRlcycpIHtcbiAgICAgICAgICAgICAgICAgICAgcGIubGF5b3V0KHBiLm9wZW5JbmRleCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9mZigncGFnZUJlZm9yZUluaXQnLCBwYi5vblBhZ2VCZWZvcmVJbml0KTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYi5vblBhZ2VCZWZvcmVSZW1vdmUgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGlmIChlLmRldGFpbC5wYWdlLm5hbWUgPT09ICdwaG90by1icm93c2VyLXNsaWRlcycpIHtcbiAgICAgICAgICAgICAgICAgICAgcGIuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgJChkb2N1bWVudCkub2ZmKCdwYWdlQmVmb3JlUmVtb3ZlJywgcGIub25QYWdlQmVmb3JlUmVtb3ZlKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgcGIub25TbGlkZXJUcmFuc2l0aW9uU3RhcnQgPSBmdW5jdGlvbiAoc3dpcGVyKSB7XG4gICAgICAgICAgICAgICAgcGIuYWN0aXZlSW5kZXggPSBzd2lwZXIuYWN0aXZlSW5kZXg7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBjdXJyZW50ID0gc3dpcGVyLmFjdGl2ZUluZGV4ICsgMTtcbiAgICAgICAgICAgICAgICB2YXIgdG90YWwgPSBzd2lwZXIuc2xpZGVzLmxlbmd0aDtcbiAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgdG90YWwgPSB0b3RhbCAtIDI7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBjdXJyZW50IC0gc3dpcGVyLmxvb3BlZFNsaWRlcztcbiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgPCAxKSBjdXJyZW50ID0gdG90YWwgKyBjdXJyZW50O1xuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCA+IHRvdGFsKSBjdXJyZW50ID0gY3VycmVudCAtIHRvdGFsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwYi5jb250YWluZXIuZmluZCgnLnBob3RvLWJyb3dzZXItY3VycmVudCcpLnRleHQoY3VycmVudCk7XG4gICAgICAgICAgICAgICAgcGIuY29udGFpbmVyLmZpbmQoJy5waG90by1icm93c2VyLXRvdGFsJykudGV4dCh0b3RhbCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICQoJy5waG90by1icm93c2VyLXByZXYsIC5waG90by1icm93c2VyLW5leHQnKS5yZW1vdmVDbGFzcygncGhvdG8tYnJvd3Nlci1saW5rLWluYWN0aXZlJyk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHN3aXBlci5pc0JlZ2lubmluZyAmJiAhcGIucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgJCgnLnBob3RvLWJyb3dzZXItcHJldicpLmFkZENsYXNzKCdwaG90by1icm93c2VyLWxpbmstaW5hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHN3aXBlci5pc0VuZCAmJiAhcGIucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgJCgnLnBob3RvLWJyb3dzZXItbmV4dCcpLmFkZENsYXNzKCdwaG90by1icm93c2VyLWxpbmstaW5hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBjYXB0aW9uc1xuICAgICAgICAgICAgICAgIGlmIChwYi5jYXB0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHBiLmNhcHRpb25zQ29udGFpbmVyLmZpbmQoJy5waG90by1icm93c2VyLWNhcHRpb24tYWN0aXZlJykucmVtb3ZlQ2xhc3MoJ3Bob3RvLWJyb3dzZXItY2FwdGlvbi1hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNhcHRpb25JbmRleCA9IHBiLnBhcmFtcy5sb29wID8gc3dpcGVyLnNsaWRlcy5lcShzd2lwZXIuYWN0aXZlSW5kZXgpLmF0dHIoJ2RhdGEtc3dpcGVyLXNsaWRlLWluZGV4JykgOiBwYi5hY3RpdmVJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgcGIuY2FwdGlvbnNDb250YWluZXIuZmluZCgnW2RhdGEtY2FwdGlvbi1pbmRleD1cIicgKyBjYXB0aW9uSW5kZXggKyAnXCJdJykuYWRkQ2xhc3MoJ3Bob3RvLWJyb3dzZXItY2FwdGlvbi1hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBTdG9wIFZpZGVvXG4gICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzU2xpZGVWaWRlbyA9IHN3aXBlci5zbGlkZXMuZXEoc3dpcGVyLnByZXZpb3VzSW5kZXgpLmZpbmQoJ3ZpZGVvJyk7XG4gICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzU2xpZGVWaWRlby5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgncGF1c2UnIGluIHByZXZpb3VzU2xpZGVWaWRlb1swXSkgcHJldmlvdXNTbGlkZVZpZGVvWzBdLnBhdXNlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIENhbGxiYWNrXG4gICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy5vblRyYW5zaXRpb25TdGFydCkgcGIucGFyYW1zLm9uVHJhbnNpdGlvblN0YXJ0KHN3aXBlcik7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcGIub25TbGlkZXJUcmFuc2l0aW9uRW5kID0gZnVuY3Rpb24gKHN3aXBlcikge1xuICAgICAgICAgICAgICAgIC8vIFJlc2V0IHpvb21cbiAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLnpvb20gJiYgZ2VzdHVyZVNsaWRlICYmIHN3aXBlci5wcmV2aW91c0luZGV4ICE9PSBzd2lwZXIuYWN0aXZlSW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgZ2VzdHVyZUltZy50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDAsMCwwKSBzY2FsZSgxKScpO1xuICAgICAgICAgICAgICAgICAgICBnZXN0dXJlSW1nV3JhcC50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDAsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICBnZXN0dXJlU2xpZGUgPSBnZXN0dXJlSW1nID0gZ2VzdHVyZUltZ1dyYXAgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgIHNjYWxlID0gY3VycmVudFNjYWxlID0gMTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy5vblRyYW5zaXRpb25FbmQpIHBiLnBhcmFtcy5vblRyYW5zaXRpb25FbmQoc3dpcGVyKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHBiLmxheW91dCA9IGZ1bmN0aW9uIChpbmRleCkge1xuICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMudHlwZSA9PT0gJ3BhZ2UnKSB7XG4gICAgICAgICAgICAgICAgICAgIHBiLmNvbnRhaW5lciA9ICQoJy5waG90by1icm93c2VyLXN3aXBlci1jb250YWluZXInKS5wYXJlbnRzKCcudmlldycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcGIuY29udGFpbmVyID0gJCgnLnBob3RvLWJyb3dzZXInKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy50eXBlID09PSAnc3RhbmRhbG9uZScpIHtcbiAgICAgICAgICAgICAgICAgICAgcGIuY29udGFpbmVyLmFkZENsYXNzKCdwaG90by1icm93c2VyLWluJyk7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5zaXplTmF2YmFycyhwYi5jb250YWluZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwYi5zd2lwZXJDb250YWluZXIgPSBwYi5jb250YWluZXIuZmluZCgnLnBob3RvLWJyb3dzZXItc3dpcGVyLWNvbnRhaW5lcicpO1xuICAgICAgICAgICAgICAgIHBiLnN3aXBlcldyYXBwZXIgPSBwYi5jb250YWluZXIuZmluZCgnLnBob3RvLWJyb3dzZXItc3dpcGVyLXdyYXBwZXInKTtcbiAgICAgICAgICAgICAgICBwYi5zbGlkZXMgPSBwYi5jb250YWluZXIuZmluZCgnLnBob3RvLWJyb3dzZXItc2xpZGUnKTtcbiAgICAgICAgICAgICAgICBwYi5jYXB0aW9uc0NvbnRhaW5lciA9IHBiLmNvbnRhaW5lci5maW5kKCcucGhvdG8tYnJvd3Nlci1jYXB0aW9ucycpO1xuICAgICAgICAgICAgICAgIHBiLmNhcHRpb25zID0gcGIuY29udGFpbmVyLmZpbmQoJy5waG90by1icm93c2VyLWNhcHRpb24nKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgc2xpZGVyU2V0dGluZ3MgPSB7XG4gICAgICAgICAgICAgICAgICAgIG5leHRCdXR0b246IHBiLnBhcmFtcy5uZXh0QnV0dG9uIHx8ICcucGhvdG8tYnJvd3Nlci1uZXh0JyxcbiAgICAgICAgICAgICAgICAgICAgcHJldkJ1dHRvbjogcGIucGFyYW1zLnByZXZCdXR0b24gfHwgJy5waG90by1icm93c2VyLXByZXYnLFxuICAgICAgICAgICAgICAgICAgICBpbmRleEJ1dHRvbjogcGIucGFyYW1zLmluZGV4QnV0dG9uLFxuICAgICAgICAgICAgICAgICAgICBpbml0aWFsU2xpZGU6IGluZGV4LFxuICAgICAgICAgICAgICAgICAgICBzcGFjZUJldHdlZW46IHBiLnBhcmFtcy5zcGFjZUJldHdlZW4sXG4gICAgICAgICAgICAgICAgICAgIHNwZWVkOiBwYi5wYXJhbXMuc3BlZWQsXG4gICAgICAgICAgICAgICAgICAgIGxvb3A6IHBiLnBhcmFtcy5sb29wLFxuICAgICAgICAgICAgICAgICAgICBsYXp5TG9hZGluZzogcGIucGFyYW1zLmxhenlMb2FkaW5nLFxuICAgICAgICAgICAgICAgICAgICBsYXp5TG9hZGluZ0luUHJldk5leHQ6IHBiLnBhcmFtcy5sYXp5TG9hZGluZ0luUHJldk5leHQsXG4gICAgICAgICAgICAgICAgICAgIGxhenlMb2FkaW5nT25UcmFuc2l0aW9uU3RhcnQ6IHBiLnBhcmFtcy5sYXp5TG9hZGluZ09uVHJhbnNpdGlvblN0YXJ0LFxuICAgICAgICAgICAgICAgICAgICBwcmVsb2FkSW1hZ2VzOiBwYi5wYXJhbXMubGF6eUxvYWRpbmcgPyBmYWxzZSA6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIG9uVGFwOiBmdW5jdGlvbiAoc3dpcGVyLCBlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLm9uVGFwKSBwYi5wYXJhbXMub25UYXAoc3dpcGVyLCBlKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgb25DbGljazogZnVuY3Rpb24gKHN3aXBlciwgZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy5leHBvc2l0aW9uKSBwYi50b2dnbGVFeHBvc2l0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLm9uQ2xpY2spIHBiLnBhcmFtcy5vbkNsaWNrKHN3aXBlciwgZSk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIG9uRG91YmxlVGFwOiBmdW5jdGlvbiAoc3dpcGVyLCBlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYi50b2dnbGVab29tKGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy5vbkRvdWJsZVRhcCkgcGIucGFyYW1zLm9uRG91YmxlVGFwKHN3aXBlciwgZSk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIG9uVHJhbnNpdGlvblN0YXJ0OiBmdW5jdGlvbiAoc3dpcGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYi5vblNsaWRlclRyYW5zaXRpb25TdGFydChzd2lwZXIpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBvblRyYW5zaXRpb25FbmQ6IGZ1bmN0aW9uIChzd2lwZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBiLm9uU2xpZGVyVHJhbnNpdGlvbkVuZChzd2lwZXIpOyAgXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIG9uU2xpZGVDaGFuZ2VTdGFydDogcGIucGFyYW1zLm9uU2xpZGVDaGFuZ2VTdGFydCxcbiAgICAgICAgICAgICAgICAgICAgb25TbGlkZUNoYW5nZUVuZDogcGIucGFyYW1zLm9uU2xpZGVDaGFuZ2VFbmQsXG4gICAgICAgICAgICAgICAgICAgIG9uTGF6eUltYWdlTG9hZDogZnVuY3Rpb24gKHN3aXBlciwgc2xpZGUsIGltZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy5vbkxhenlJbWFnZUxvYWQpIHBiLnBhcmFtcy5vbkxhenlJbWFnZUxvYWQocGIsIHNsaWRlLCBpbWcpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBvbkxhenlJbWFnZVJlYWR5OiBmdW5jdGlvbiAoc3dpcGVyLCBzbGlkZSwgaW1nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKHNsaWRlKS5yZW1vdmVDbGFzcygncGhvdG8tYnJvd3Nlci1zbGlkZS1sYXp5Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLm9uTGF6eUltYWdlUmVhZHkpIHBiLnBhcmFtcy5vbkxhenlJbWFnZVJlYWR5KHBiLCBzbGlkZSwgaW1nKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMuc3dpcGVUb0Nsb3NlICYmIHBiLnBhcmFtcy50eXBlICE9PSAncGFnZScpIHtcbiAgICAgICAgICAgICAgICAgICAgc2xpZGVyU2V0dGluZ3Mub25Ub3VjaFN0YXJ0ID0gcGIuc3dpcGVDbG9zZVRvdWNoU3RhcnQ7XG4gICAgICAgICAgICAgICAgICAgIHNsaWRlclNldHRpbmdzLm9uVG91Y2hNb3ZlT3Bwb3NpdGUgPSBwYi5zd2lwZUNsb3NlVG91Y2hNb3ZlO1xuICAgICAgICAgICAgICAgICAgICBzbGlkZXJTZXR0aW5ncy5vblRvdWNoRW5kID0gcGIuc3dpcGVDbG9zZVRvdWNoRW5kO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcGIuc3dpcGVyID0gYXBwLnN3aXBlcihwYi5zd2lwZXJDb250YWluZXIsIHNsaWRlclNldHRpbmdzKTtcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcGIub25TbGlkZXJUcmFuc2l0aW9uU3RhcnQocGIuc3dpcGVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcGIuYXR0YWNoRXZlbnRzKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcGIuYXR0YWNoRXZlbnRzID0gZnVuY3Rpb24gKGRldGFjaCkge1xuICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSBkZXRhY2ggPyAnb2ZmJyA6ICdvbic7XG4gICAgICAgICAgICAgICAgLy8gU2xpZGUgYmV0d2VlbiBwaG90b3NcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy56b29tKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSBwYi5wYXJhbXMubG9vcCA/IHBiLnN3aXBlci5zbGlkZXMgOiBwYi5zbGlkZXM7XG4gICAgICAgICAgICAgICAgICAgIC8vIFNjYWxlIGltYWdlXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFthY3Rpb25dKCdnZXN0dXJlc3RhcnQnLCBwYi5vblNsaWRlR2VzdHVyZVN0YXJ0KTtcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W2FjdGlvbl0oJ2dlc3R1cmVjaGFuZ2UnLCBwYi5vblNsaWRlR2VzdHVyZUNoYW5nZSk7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFthY3Rpb25dKCdnZXN0dXJlZW5kJywgcGIub25TbGlkZUdlc3R1cmVFbmQpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gTW92ZSBpbWFnZVxuICAgICAgICAgICAgICAgICAgICB0YXJnZXRbYWN0aW9uXShhcHAudG91Y2hFdmVudHMuc3RhcnQsIHBiLm9uU2xpZGVUb3VjaFN0YXJ0KTtcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W2FjdGlvbl0oYXBwLnRvdWNoRXZlbnRzLm1vdmUsIHBiLm9uU2xpZGVUb3VjaE1vdmUpO1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXRbYWN0aW9uXShhcHAudG91Y2hFdmVudHMuZW5kLCBwYi5vblNsaWRlVG91Y2hFbmQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwYi5jb250YWluZXIuZmluZCgnLnBob3RvLWJyb3dzZXItY2xvc2UtbGluaycpW2FjdGlvbl0oJ2NsaWNrJywgcGIuY2xvc2UpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgaXNUb3VjaGVkLCBpc01vdmVkLCB0b3VjaGVzU3RhcnQgPSB7fSwgdG91Y2hlc0N1cnJlbnQgPSB7fSwgdG91Y2hTdGFydFRpbWUsIGlzU2Nyb2xsaW5nLCBhbmltYXRpbmcgPSBmYWxzZSwgY3VycmVudFRyYW5zbGF0ZTtcbiAgICAgICAgICAgIHZhciBhbGxvd0NsaWNrID0gdHJ1ZTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBFeHBvc2VcbiAgICAgICAgICAgIHBiLmV4cG9zZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHBiLnRvZ2dsZUV4cG9zaXRpb24gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBiLmNvbnRhaW5lcikgcGIuY29udGFpbmVyLnRvZ2dsZUNsYXNzKCdwaG90by1icm93c2VyLWV4cG9zZWQnKTtcbiAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLmV4cG9zaXRpb25IaWRlQ2FwdGlvbnMpIHBiLmNhcHRpb25zQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCdwaG90by1icm93c2VyLWNhcHRpb25zLWV4cG9zZWQnKTtcbiAgICAgICAgICAgICAgICBwYi5leHBvc2VkID0gIXBiLmV4cG9zZWQ7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcGIuZW5hYmxlRXhwb3NpdGlvbiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAocGIuY29udGFpbmVyKSBwYi5jb250YWluZXIuYWRkQ2xhc3MoJ3Bob3RvLWJyb3dzZXItZXhwb3NlZCcpO1xuICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMuZXhwb3NpdGlvbkhpZGVDYXB0aW9ucykgcGIuY2FwdGlvbnNDb250YWluZXIuYWRkQ2xhc3MoJ3Bob3RvLWJyb3dzZXItY2FwdGlvbnMtZXhwb3NlZCcpO1xuICAgICAgICAgICAgICAgIHBiLmV4cG9zZWQgPSB0cnVlO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBiLmRpc2FibGVFeHBvc2l0aW9uID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChwYi5jb250YWluZXIpIHBiLmNvbnRhaW5lci5yZW1vdmVDbGFzcygncGhvdG8tYnJvd3Nlci1leHBvc2VkJyk7XG4gICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy5leHBvc2l0aW9uSGlkZUNhcHRpb25zKSBwYi5jYXB0aW9uc0NvbnRhaW5lci5yZW1vdmVDbGFzcygncGhvdG8tYnJvd3Nlci1jYXB0aW9ucy1leHBvc2VkJyk7XG4gICAgICAgICAgICAgICAgcGIuZXhwb3NlZCA9IGZhbHNlO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gR2VzdHVyZXNcbiAgICAgICAgICAgIHZhciBnZXN0dXJlU2xpZGUsIGdlc3R1cmVJbWcsIGdlc3R1cmVJbWdXcmFwLCBzY2FsZSA9IDEsIGN1cnJlbnRTY2FsZSA9IDEsIGlzU2NhbGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgcGIub25TbGlkZUdlc3R1cmVTdGFydCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFnZXN0dXJlU2xpZGUgfHwgIWdlc3R1cmVTbGlkZS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgZ2VzdHVyZVNsaWRlID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGdlc3R1cmVTbGlkZS5sZW5ndGggPT09IDApIGdlc3R1cmVTbGlkZSA9IHBiLnN3aXBlci5zbGlkZXMuZXEocGIuc3dpcGVyLmFjdGl2ZUluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgZ2VzdHVyZUltZyA9IGdlc3R1cmVTbGlkZS5maW5kKCdpbWcsIHN2ZywgY2FudmFzJyk7XG4gICAgICAgICAgICAgICAgICAgIGdlc3R1cmVJbWdXcmFwID0gZ2VzdHVyZUltZy5wYXJlbnQoJy5waG90by1icm93c2VyLXpvb20tY29udGFpbmVyJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChnZXN0dXJlSW1nV3JhcC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdlc3R1cmVJbWcgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZ2VzdHVyZUltZy50cmFuc2l0aW9uKDApO1xuICAgICAgICAgICAgICAgIGlzU2NhbGluZyA9IHRydWU7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcGIub25TbGlkZUdlc3R1cmVDaGFuZ2UgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGlmICghZ2VzdHVyZUltZyB8fCBnZXN0dXJlSW1nLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHNjYWxlID0gZS5zY2FsZSAqIGN1cnJlbnRTY2FsZTtcbiAgICAgICAgICAgICAgICBpZiAoc2NhbGUgPiBwYi5wYXJhbXMubWF4Wm9vbSkge1xuICAgICAgICAgICAgICAgICAgICBzY2FsZSA9IHBiLnBhcmFtcy5tYXhab29tIC0gMSArIE1hdGgucG93KChzY2FsZSAtIHBiLnBhcmFtcy5tYXhab29tICsgMSksIDAuNSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzY2FsZSA8IHBiLnBhcmFtcy5taW5ab29tKSB7XG4gICAgICAgICAgICAgICAgICAgIHNjYWxlID0gIHBiLnBhcmFtcy5taW5ab29tICsgMSAtIE1hdGgucG93KChwYi5wYXJhbXMubWluWm9vbSAtIHNjYWxlICsgMSksIDAuNSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGdlc3R1cmVJbWcudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLDAsMCkgc2NhbGUoJyArIHNjYWxlICsgJyknKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYi5vblNsaWRlR2VzdHVyZUVuZCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFnZXN0dXJlSW1nIHx8IGdlc3R1cmVJbWcubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgc2NhbGUgPSBNYXRoLm1heChNYXRoLm1pbihzY2FsZSwgcGIucGFyYW1zLm1heFpvb20pLCBwYi5wYXJhbXMubWluWm9vbSk7XG4gICAgICAgICAgICAgICAgZ2VzdHVyZUltZy50cmFuc2l0aW9uKHBiLnBhcmFtcy5zcGVlZCkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLDAsMCkgc2NhbGUoJyArIHNjYWxlICsgJyknKTtcbiAgICAgICAgICAgICAgICBjdXJyZW50U2NhbGUgPSBzY2FsZTtcbiAgICAgICAgICAgICAgICBpc1NjYWxpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAoc2NhbGUgPT09IDEpIGdlc3R1cmVTbGlkZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYi50b2dnbGVab29tID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWdlc3R1cmVTbGlkZSkge1xuICAgICAgICAgICAgICAgICAgICBnZXN0dXJlU2xpZGUgPSBwYi5zd2lwZXIuc2xpZGVzLmVxKHBiLnN3aXBlci5hY3RpdmVJbmRleCk7XG4gICAgICAgICAgICAgICAgICAgIGdlc3R1cmVJbWcgPSBnZXN0dXJlU2xpZGUuZmluZCgnaW1nLCBzdmcsIGNhbnZhcycpO1xuICAgICAgICAgICAgICAgICAgICBnZXN0dXJlSW1nV3JhcCA9IGdlc3R1cmVJbWcucGFyZW50KCcucGhvdG8tYnJvd3Nlci16b29tLWNvbnRhaW5lcicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWdlc3R1cmVJbWcgfHwgZ2VzdHVyZUltZy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgdG91Y2hYLCB0b3VjaFksIG9mZnNldFgsIG9mZnNldFksIGRpZmZYLCBkaWZmWSwgdHJhbnNsYXRlWCwgdHJhbnNsYXRlWSwgaW1hZ2VXaWR0aCwgaW1hZ2VIZWlnaHQsIHNjYWxlZFdpZHRoLCBzY2FsZWRIZWlnaHQsIHRyYW5zbGF0ZU1pblgsIHRyYW5zbGF0ZU1pblksIHRyYW5zbGF0ZU1heFgsIHRyYW5zbGF0ZU1heFk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW1hZ2VUb3VjaGVzU3RhcnQueCA9PT0gJ3VuZGVmaW5lZCcgJiYgZSkge1xuICAgICAgICAgICAgICAgICAgICB0b3VjaFggPSBlLnR5cGUgPT09ICd0b3VjaGVuZCcgPyBlLmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYIDogZS5wYWdlWDtcbiAgICAgICAgICAgICAgICAgICAgdG91Y2hZID0gZS50eXBlID09PSAndG91Y2hlbmQnID8gZS5jaGFuZ2VkVG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0b3VjaFggPSBpbWFnZVRvdWNoZXNTdGFydC54O1xuICAgICAgICAgICAgICAgICAgICB0b3VjaFkgPSBpbWFnZVRvdWNoZXNTdGFydC55O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoc2NhbGUgJiYgc2NhbGUgIT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gWm9vbSBPdXRcbiAgICAgICAgICAgICAgICAgICAgc2NhbGUgPSBjdXJyZW50U2NhbGUgPSAxO1xuICAgICAgICAgICAgICAgICAgICBnZXN0dXJlSW1nV3JhcC50cmFuc2l0aW9uKDMwMCkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgZ2VzdHVyZUltZy50cmFuc2l0aW9uKDMwMCkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLDAsMCkgc2NhbGUoMSknKTtcbiAgICAgICAgICAgICAgICAgICAgZ2VzdHVyZVNsaWRlID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gWm9vbSBJblxuICAgICAgICAgICAgICAgICAgICBzY2FsZSA9IGN1cnJlbnRTY2FsZSA9IHBiLnBhcmFtcy5tYXhab29tO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WCA9IHBiLmNvbnRhaW5lci5vZmZzZXQoKS5sZWZ0O1xuICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0WSA9IHBiLmNvbnRhaW5lci5vZmZzZXQoKS50b3A7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaWZmWCA9IG9mZnNldFggKyBwYi5jb250YWluZXJbMF0ub2Zmc2V0V2lkdGgvMiAtIHRvdWNoWDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZZID0gb2Zmc2V0WSArIHBiLmNvbnRhaW5lclswXS5vZmZzZXRIZWlnaHQvMiAtIHRvdWNoWTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBpbWFnZVdpZHRoID0gZ2VzdHVyZUltZ1swXS5vZmZzZXRXaWR0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlSGVpZ2h0ID0gZ2VzdHVyZUltZ1swXS5vZmZzZXRIZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBzY2FsZWRXaWR0aCA9IGltYWdlV2lkdGggKiBzY2FsZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlZEhlaWdodCA9IGltYWdlSGVpZ2h0ICogc2NhbGU7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlTWluWCA9IE1hdGgubWluKChwYi5zd2lwZXIud2lkdGggLyAyIC0gc2NhbGVkV2lkdGggLyAyKSwgMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGVNaW5ZID0gTWF0aC5taW4oKHBiLnN3aXBlci5oZWlnaHQgLyAyIC0gc2NhbGVkSGVpZ2h0IC8gMiksIDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlTWF4WCA9IC10cmFuc2xhdGVNaW5YO1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlTWF4WSA9IC10cmFuc2xhdGVNaW5ZO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZVggPSBkaWZmWCAqIHNjYWxlO1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlWSA9IGRpZmZZICogc2NhbGU7XG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGVYIDwgdHJhbnNsYXRlTWluWCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZVggPSAgdHJhbnNsYXRlTWluWDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGVYID4gdHJhbnNsYXRlTWF4WCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZVggPSB0cmFuc2xhdGVNYXhYO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHJhbnNsYXRlWSA8IHRyYW5zbGF0ZU1pblkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGVZID0gIHRyYW5zbGF0ZU1pblk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHJhbnNsYXRlWSA+IHRyYW5zbGF0ZU1heFkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGVZID0gdHJhbnNsYXRlTWF4WTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZVggPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlWSA9IDA7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZ2VzdHVyZUltZ1dyYXAudHJhbnNpdGlvbigzMDApLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHRyYW5zbGF0ZVggKyAncHgsICcgKyB0cmFuc2xhdGVZICsgJ3B4LDApJyk7XG4gICAgICAgICAgICAgICAgICAgIGdlc3R1cmVJbWcudHJhbnNpdGlvbigzMDApLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwwLDApIHNjYWxlKCcgKyBzY2FsZSArICcpJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgaW1hZ2VJc1RvdWNoZWQsIGltYWdlSXNNb3ZlZCwgaW1hZ2VDdXJyZW50WCwgaW1hZ2VDdXJyZW50WSwgaW1hZ2VNaW5YLCBpbWFnZU1pblksIGltYWdlTWF4WCwgaW1hZ2VNYXhZLCBpbWFnZVdpZHRoLCBpbWFnZUhlaWdodCwgaW1hZ2VUb3VjaGVzU3RhcnQgPSB7fSwgaW1hZ2VUb3VjaGVzQ3VycmVudCA9IHt9LCBpbWFnZVN0YXJ0WCwgaW1hZ2VTdGFydFksIHZlbG9jaXR5UHJldlBvc2l0aW9uWCwgdmVsb2NpdHlQcmV2VGltZSwgdmVsb2NpdHlYLCB2ZWxvY2l0eVByZXZQb3NpdGlvblksIHZlbG9jaXR5WTtcbiAgICAgICAgXG4gICAgICAgICAgICBwYi5vblNsaWRlVG91Y2hTdGFydCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFnZXN0dXJlSW1nIHx8IGdlc3R1cmVJbWcubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKGltYWdlSXNUb3VjaGVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2Uub3MgPT09ICdhbmRyb2lkJykgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGltYWdlSXNUb3VjaGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpbWFnZVRvdWNoZXNTdGFydC54ID0gZS50eXBlID09PSAndG91Y2hzdGFydCcgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBlLnBhZ2VYO1xuICAgICAgICAgICAgICAgIGltYWdlVG91Y2hlc1N0YXJ0LnkgPSBlLnR5cGUgPT09ICd0b3VjaHN0YXJ0JyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcGIub25TbGlkZVRvdWNoTW92ZSA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFnZXN0dXJlSW1nIHx8IGdlc3R1cmVJbWcubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgcGIuc3dpcGVyLmFsbG93Q2xpY2sgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAoIWltYWdlSXNUb3VjaGVkIHx8ICFnZXN0dXJlU2xpZGUpIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCFpbWFnZUlzTW92ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2VXaWR0aCA9IGdlc3R1cmVJbWdbMF0ub2Zmc2V0V2lkdGg7XG4gICAgICAgICAgICAgICAgICAgIGltYWdlSGVpZ2h0ID0gZ2VzdHVyZUltZ1swXS5vZmZzZXRIZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgIGltYWdlU3RhcnRYID0gJC5nZXRUcmFuc2xhdGUoZ2VzdHVyZUltZ1dyYXBbMF0sICd4JykgfHwgMDtcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2VTdGFydFkgPSAkLmdldFRyYW5zbGF0ZShnZXN0dXJlSW1nV3JhcFswXSwgJ3knKSB8fCAwO1xuICAgICAgICAgICAgICAgICAgICBnZXN0dXJlSW1nV3JhcC50cmFuc2l0aW9uKDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBEZWZpbmUgaWYgd2UgbmVlZCBpbWFnZSBkcmFnXG4gICAgICAgICAgICAgICAgdmFyIHNjYWxlZFdpZHRoID0gaW1hZ2VXaWR0aCAqIHNjYWxlO1xuICAgICAgICAgICAgICAgIHZhciBzY2FsZWRIZWlnaHQgPSBpbWFnZUhlaWdodCAqIHNjYWxlO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoc2NhbGVkV2lkdGggPCBwYi5zd2lwZXIud2lkdGggJiYgc2NhbGVkSGVpZ2h0IDwgcGIuc3dpcGVyLmhlaWdodCkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpbWFnZU1pblggPSBNYXRoLm1pbigocGIuc3dpcGVyLndpZHRoIC8gMiAtIHNjYWxlZFdpZHRoIC8gMiksIDApO1xuICAgICAgICAgICAgICAgIGltYWdlTWF4WCA9IC1pbWFnZU1pblg7XG4gICAgICAgICAgICAgICAgaW1hZ2VNaW5ZID0gTWF0aC5taW4oKHBiLnN3aXBlci5oZWlnaHQgLyAyIC0gc2NhbGVkSGVpZ2h0IC8gMiksIDApO1xuICAgICAgICAgICAgICAgIGltYWdlTWF4WSA9IC1pbWFnZU1pblk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaW1hZ2VUb3VjaGVzQ3VycmVudC54ID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGUucGFnZVg7XG4gICAgICAgICAgICAgICAgaW1hZ2VUb3VjaGVzQ3VycmVudC55ID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICghaW1hZ2VJc01vdmVkICYmICFpc1NjYWxpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGguZmxvb3IoaW1hZ2VNaW5YKSA9PT0gTWF0aC5mbG9vcihpbWFnZVN0YXJ0WCkgJiYgaW1hZ2VUb3VjaGVzQ3VycmVudC54IDwgaW1hZ2VUb3VjaGVzU3RhcnQueCkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIChNYXRoLmZsb29yKGltYWdlTWF4WCkgPT09IE1hdGguZmxvb3IoaW1hZ2VTdGFydFgpICYmIGltYWdlVG91Y2hlc0N1cnJlbnQueCA+IGltYWdlVG91Y2hlc1N0YXJ0LngpXG4gICAgICAgICAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlSXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgaW1hZ2VJc01vdmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpbWFnZUN1cnJlbnRYID0gaW1hZ2VUb3VjaGVzQ3VycmVudC54IC0gaW1hZ2VUb3VjaGVzU3RhcnQueCArIGltYWdlU3RhcnRYO1xuICAgICAgICAgICAgICAgIGltYWdlQ3VycmVudFkgPSBpbWFnZVRvdWNoZXNDdXJyZW50LnkgLSBpbWFnZVRvdWNoZXNTdGFydC55ICsgaW1hZ2VTdGFydFk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGltYWdlQ3VycmVudFggPCBpbWFnZU1pblgpIHtcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2VDdXJyZW50WCA9ICBpbWFnZU1pblggKyAxIC0gTWF0aC5wb3coKGltYWdlTWluWCAtIGltYWdlQ3VycmVudFggKyAxKSwgMC44KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGltYWdlQ3VycmVudFggPiBpbWFnZU1heFgpIHtcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2VDdXJyZW50WCA9IGltYWdlTWF4WCAtIDEgKyBNYXRoLnBvdygoaW1hZ2VDdXJyZW50WCAtIGltYWdlTWF4WCArIDEpLCAwLjgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoaW1hZ2VDdXJyZW50WSA8IGltYWdlTWluWSkge1xuICAgICAgICAgICAgICAgICAgICBpbWFnZUN1cnJlbnRZID0gIGltYWdlTWluWSArIDEgLSBNYXRoLnBvdygoaW1hZ2VNaW5ZIC0gaW1hZ2VDdXJyZW50WSArIDEpLCAwLjgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaW1hZ2VDdXJyZW50WSA+IGltYWdlTWF4WSkge1xuICAgICAgICAgICAgICAgICAgICBpbWFnZUN1cnJlbnRZID0gaW1hZ2VNYXhZIC0gMSArIE1hdGgucG93KChpbWFnZUN1cnJlbnRZIC0gaW1hZ2VNYXhZICsgMSksIDAuOCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvL1ZlbG9jaXR5XG4gICAgICAgICAgICAgICAgaWYgKCF2ZWxvY2l0eVByZXZQb3NpdGlvblgpIHZlbG9jaXR5UHJldlBvc2l0aW9uWCA9IGltYWdlVG91Y2hlc0N1cnJlbnQueDtcbiAgICAgICAgICAgICAgICBpZiAoIXZlbG9jaXR5UHJldlBvc2l0aW9uWSkgdmVsb2NpdHlQcmV2UG9zaXRpb25ZID0gaW1hZ2VUb3VjaGVzQ3VycmVudC55O1xuICAgICAgICAgICAgICAgIGlmICghdmVsb2NpdHlQcmV2VGltZSkgdmVsb2NpdHlQcmV2VGltZSA9IERhdGUubm93KCk7XG4gICAgICAgICAgICAgICAgdmVsb2NpdHlYID0gKGltYWdlVG91Y2hlc0N1cnJlbnQueCAtIHZlbG9jaXR5UHJldlBvc2l0aW9uWCkgLyAoRGF0ZS5ub3coKSAtIHZlbG9jaXR5UHJldlRpbWUpIC8gMjtcbiAgICAgICAgICAgICAgICB2ZWxvY2l0eVkgPSAoaW1hZ2VUb3VjaGVzQ3VycmVudC55IC0gdmVsb2NpdHlQcmV2UG9zaXRpb25ZKSAvIChEYXRlLm5vdygpIC0gdmVsb2NpdHlQcmV2VGltZSkgLyAyO1xuICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhpbWFnZVRvdWNoZXNDdXJyZW50LnggLSB2ZWxvY2l0eVByZXZQb3NpdGlvblgpIDwgMikgdmVsb2NpdHlYID0gMDtcbiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoaW1hZ2VUb3VjaGVzQ3VycmVudC55IC0gdmVsb2NpdHlQcmV2UG9zaXRpb25ZKSA8IDIpIHZlbG9jaXR5WSA9IDA7XG4gICAgICAgICAgICAgICAgdmVsb2NpdHlQcmV2UG9zaXRpb25YID0gaW1hZ2VUb3VjaGVzQ3VycmVudC54O1xuICAgICAgICAgICAgICAgIHZlbG9jaXR5UHJldlBvc2l0aW9uWSA9IGltYWdlVG91Y2hlc0N1cnJlbnQueTtcbiAgICAgICAgICAgICAgICB2ZWxvY2l0eVByZXZUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgZ2VzdHVyZUltZ1dyYXAudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgaW1hZ2VDdXJyZW50WCArICdweCwgJyArIGltYWdlQ3VycmVudFkgKyAncHgsMCknKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYi5vblNsaWRlVG91Y2hFbmQgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGlmICghZ2VzdHVyZUltZyB8fCBnZXN0dXJlSW1nLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmICghaW1hZ2VJc1RvdWNoZWQgfHwgIWltYWdlSXNNb3ZlZCkge1xuICAgICAgICAgICAgICAgICAgICBpbWFnZUlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpbWFnZUlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpbWFnZUlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGltYWdlSXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZhciBtb21lbnR1bUR1cmF0aW9uWCA9IDMwMDtcbiAgICAgICAgICAgICAgICB2YXIgbW9tZW50dW1EdXJhdGlvblkgPSAzMDA7XG4gICAgICAgICAgICAgICAgdmFyIG1vbWVudHVtRGlzdGFuY2VYID0gdmVsb2NpdHlYICogbW9tZW50dW1EdXJhdGlvblg7XG4gICAgICAgICAgICAgICAgdmFyIG5ld1Bvc2l0aW9uWCA9IGltYWdlQ3VycmVudFggKyBtb21lbnR1bURpc3RhbmNlWDtcbiAgICAgICAgICAgICAgICB2YXIgbW9tZW50dW1EaXN0YW5jZVkgPSB2ZWxvY2l0eVkgKiBtb21lbnR1bUR1cmF0aW9uWTtcbiAgICAgICAgICAgICAgICB2YXIgbmV3UG9zaXRpb25ZID0gaW1hZ2VDdXJyZW50WSArIG1vbWVudHVtRGlzdGFuY2VZO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvL0ZpeCBkdXJhdGlvblxuICAgICAgICAgICAgICAgIGlmICh2ZWxvY2l0eVggIT09IDApIG1vbWVudHVtRHVyYXRpb25YID0gTWF0aC5hYnMoKG5ld1Bvc2l0aW9uWCAtIGltYWdlQ3VycmVudFgpIC8gdmVsb2NpdHlYKTtcbiAgICAgICAgICAgICAgICBpZiAodmVsb2NpdHlZICE9PSAwKSBtb21lbnR1bUR1cmF0aW9uWSA9IE1hdGguYWJzKChuZXdQb3NpdGlvblkgLSBpbWFnZUN1cnJlbnRZKSAvIHZlbG9jaXR5WSk7XG4gICAgICAgICAgICAgICAgdmFyIG1vbWVudHVtRHVyYXRpb24gPSBNYXRoLm1heChtb21lbnR1bUR1cmF0aW9uWCwgbW9tZW50dW1EdXJhdGlvblkpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpbWFnZUN1cnJlbnRYID0gbmV3UG9zaXRpb25YO1xuICAgICAgICAgICAgICAgIGltYWdlQ3VycmVudFkgPSBuZXdQb3NpdGlvblk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIERlZmluZSBpZiB3ZSBuZWVkIGltYWdlIGRyYWdcbiAgICAgICAgICAgICAgICB2YXIgc2NhbGVkV2lkdGggPSBpbWFnZVdpZHRoICogc2NhbGU7XG4gICAgICAgICAgICAgICAgdmFyIHNjYWxlZEhlaWdodCA9IGltYWdlSGVpZ2h0ICogc2NhbGU7XG4gICAgICAgICAgICAgICAgaW1hZ2VNaW5YID0gTWF0aC5taW4oKHBiLnN3aXBlci53aWR0aCAvIDIgLSBzY2FsZWRXaWR0aCAvIDIpLCAwKTtcbiAgICAgICAgICAgICAgICBpbWFnZU1heFggPSAtaW1hZ2VNaW5YO1xuICAgICAgICAgICAgICAgIGltYWdlTWluWSA9IE1hdGgubWluKChwYi5zd2lwZXIuaGVpZ2h0IC8gMiAtIHNjYWxlZEhlaWdodCAvIDIpLCAwKTtcbiAgICAgICAgICAgICAgICBpbWFnZU1heFkgPSAtaW1hZ2VNaW5ZO1xuICAgICAgICAgICAgICAgIGltYWdlQ3VycmVudFggPSBNYXRoLm1heChNYXRoLm1pbihpbWFnZUN1cnJlbnRYLCBpbWFnZU1heFgpLCBpbWFnZU1pblgpO1xuICAgICAgICAgICAgICAgIGltYWdlQ3VycmVudFkgPSBNYXRoLm1heChNYXRoLm1pbihpbWFnZUN1cnJlbnRZLCBpbWFnZU1heFkpLCBpbWFnZU1pblkpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBnZXN0dXJlSW1nV3JhcC50cmFuc2l0aW9uKG1vbWVudHVtRHVyYXRpb24pLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIGltYWdlQ3VycmVudFggKyAncHgsICcgKyBpbWFnZUN1cnJlbnRZICsgJ3B4LDApJyk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFN3aXBlIFVwIFRvIENsb3NlXG4gICAgICAgICAgICB2YXIgc3dpcGVUb0Nsb3NlSXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICB2YXIgYWxsb3dTd2lwZVRvQ2xvc2UgPSB0cnVlO1xuICAgICAgICAgICAgdmFyIHN3aXBlVG9DbG9zZURpZmYsIHN3aXBlVG9DbG9zZVN0YXJ0LCBzd2lwZVRvQ2xvc2VDdXJyZW50LCBzd2lwZVRvQ2xvc2VTdGFydGVkID0gZmFsc2UsIHN3aXBlVG9DbG9zZUFjdGl2ZVNsaWRlLCBzd2lwZVRvQ2xvc2VUaW1lU3RhcnQ7XG4gICAgICAgICAgICBwYi5zd2lwZUNsb3NlVG91Y2hTdGFydCA9IGZ1bmN0aW9uIChzd2lwZXIsIGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWFsbG93U3dpcGVUb0Nsb3NlKSByZXR1cm47XG4gICAgICAgICAgICAgICAgc3dpcGVUb0Nsb3NlSXNUb3VjaGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYi5zd2lwZUNsb3NlVG91Y2hNb3ZlID0gZnVuY3Rpb24gKHN3aXBlciwgZSkge1xuICAgICAgICAgICAgICAgIGlmICghc3dpcGVUb0Nsb3NlSXNUb3VjaGVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKCFzd2lwZVRvQ2xvc2VTdGFydGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHN3aXBlVG9DbG9zZVN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBzd2lwZVRvQ2xvc2VTdGFydCA9IGUudHlwZSA9PT0gJ3RvdWNobW92ZScgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgOiBlLnBhZ2VZO1xuICAgICAgICAgICAgICAgICAgICBzd2lwZVRvQ2xvc2VBY3RpdmVTbGlkZSA9IHBiLnN3aXBlci5zbGlkZXMuZXEocGIuc3dpcGVyLmFjdGl2ZUluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgc3dpcGVUb0Nsb3NlVGltZVN0YXJ0ID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIHN3aXBlVG9DbG9zZUN1cnJlbnQgPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICBzd2lwZVRvQ2xvc2VEaWZmID0gc3dpcGVUb0Nsb3NlU3RhcnQgLSBzd2lwZVRvQ2xvc2VDdXJyZW50O1xuICAgICAgICAgICAgICAgIHZhciBvcGFjaXR5ID0gMSAtIE1hdGguYWJzKHN3aXBlVG9DbG9zZURpZmYpIC8gMzAwO1xuICAgICAgICAgICAgICAgIHN3aXBlVG9DbG9zZUFjdGl2ZVNsaWRlLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwnICsgKC1zd2lwZVRvQ2xvc2VEaWZmKSArICdweCwwKScpO1xuICAgICAgICAgICAgICAgIHBiLnN3aXBlci5jb250YWluZXIuY3NzKCdvcGFjaXR5Jywgb3BhY2l0eSkudHJhbnNpdGlvbigwKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYi5zd2lwZUNsb3NlVG91Y2hFbmQgPSBmdW5jdGlvbiAoc3dpcGVyLCBlKSB7XG4gICAgICAgICAgICAgICAgc3dpcGVUb0Nsb3NlSXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKCFzd2lwZVRvQ2xvc2VTdGFydGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHN3aXBlVG9DbG9zZVN0YXJ0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzd2lwZVRvQ2xvc2VTdGFydGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgYWxsb3dTd2lwZVRvQ2xvc2UgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB2YXIgZGlmZiA9IE1hdGguYWJzKHN3aXBlVG9DbG9zZURpZmYpO1xuICAgICAgICAgICAgICAgIHZhciB0aW1lRGlmZiA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCkgLSBzd2lwZVRvQ2xvc2VUaW1lU3RhcnQ7XG4gICAgICAgICAgICAgICAgaWYgKCh0aW1lRGlmZiA8IDMwMCAmJiBkaWZmID4gMjApIHx8ICh0aW1lRGlmZiA+PSAzMDAgJiYgZGlmZiA+IDEwMCkpIHtcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLnR5cGUgPT09ICdzdGFuZGFsb25lJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBiLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLnR5cGUgPT09ICdwb3B1cCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbChwYi5wb3B1cCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLm9uU3dpcGVUb0Nsb3NlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGIucGFyYW1zLm9uU3dpcGVUb0Nsb3NlKHBiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93U3dpcGVUb0Nsb3NlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGRpZmYgIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgc3dpcGVUb0Nsb3NlQWN0aXZlU2xpZGUuYWRkQ2xhc3MoJ3RyYW5zaXRpb25pbmcnKS50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93U3dpcGVUb0Nsb3NlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXBlVG9DbG9zZUFjdGl2ZVNsaWRlLnJlbW92ZUNsYXNzKCd0cmFuc2l0aW9uaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYWxsb3dTd2lwZVRvQ2xvc2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwYi5zd2lwZXIuY29udGFpbmVyLmNzcygnb3BhY2l0eScsICcnKS50cmFuc2l0aW9uKCcnKTtcbiAgICAgICAgICAgICAgICBzd2lwZVRvQ2xvc2VBY3RpdmVTbGlkZS50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gcGI7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBhcHAucGhvdG9Ccm93c2VyID0gZnVuY3Rpb24gKHBhcmFtcykge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBQaG90b0Jyb3dzZXIocGFyYW1zKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIEF1dG9jb21wbGV0ZSAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgdmFyIEF1dG9jb21wbGV0ZSA9IGZ1bmN0aW9uIChwYXJhbXMpIHtcbiAgICAgICAgICAgIHZhciBhID0gdGhpcztcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQYXJhbXNcbiAgICAgICAgICAgIHZhciBkZWZhdWx0cyA9IHtcbiAgICAgICAgICAgICAgICAvLyBTdGFuZGFsb25lIE9wdGlvbnNcbiAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgIG9wZW5lcjogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgcG9wdXBDbG9zZVRleHQ6ICdDbG9zZScsXG4gICAgICAgICAgICAgICAgYmFja1RleHQ6ICdCYWNrJyxcbiAgICAgICAgICAgICAgICBzZWFyY2hiYXJQbGFjZWhvbGRlclRleHQ6ICdTZWFyY2guLi4nLFxuICAgICAgICAgICAgICAgIHNlYXJjaGJhckNhbmNlbFRleHQ6ICdDYW5jZWwnLFxuICAgICAgICAgICAgICAgIG9wZW5JbjogJ3BhZ2UnLFxuICAgICAgICAgICAgICAgIGJhY2tPblNlbGVjdDogZmFsc2UsXG4gICAgICAgICAgICAgICAgbm90Rm91bmRUZXh0OiAnTm90aGluZyBmb3VuZCcsXG4gICAgICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICBwYWdlVGl0bGU6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAqL1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBIYW5kbGUgRGF0YVxuICAgICAgICAgICAgICAgIC8qXG4gICAgICAgICAgICAgICAgc291cmNlOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgbGltaXQ6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIHZhbHVlUHJvcGVydHk6ICdpZCcsXG4gICAgICAgICAgICAgICAgdGV4dFByb3BlcnR5OiAndGV4dCcsXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIERyb3Bkb3duIE9wdGlvbnNcbiAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgIGRyb3Bkb3duUGxhY2Vob2xkZXJUZXh0OiAnVHlwZSBhbnl0aGluZy4uLicsXG4gICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICB1cGRhdGVJbnB1dFZhbHVlT25TZWxlY3Q6IHRydWUsXG4gICAgICAgICAgICAgICAgZXhwYW5kSW5wdXQ6IGZhbHNlLFxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBQcmVsb2FkZXJcbiAgICAgICAgICAgICAgICBwcmVsb2FkZXJDb2xvcjogZmFsc2UsXG4gICAgICAgICAgICAgICAgcHJlbG9hZGVyOiBmYWxzZSxcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gVGVtcGxhdGVzXG4gICAgICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICBpdGVtVGVtcGxhdGU6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBuYXZiYXJUZW1wbGF0ZTogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgIGRyb3Bkb3duVGVtcGxhdGU6IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgIGRyb3Bkb3duSXRlbVRlbXBsYXRlOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgZHJvcGRvd25QbGFjZWhvbGRlclRlbXBsYXRlOiB1bmRlZmluZWRcbiAgICAgICAgICAgICAgICAqL1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBDb2xvciB0aGVtZXNcbiAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgIG5hdmJhclRoZW1lOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgZm9ybVRoZW1lOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgKi9cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gQ2FsbGJhY2tzXG4gICAgICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICBvbkNoYW5nZTogZnVuY3Rpb24gKGEsIHZhbHVlKSAtIGZvciBub3QgZHJvcGRvd25cbiAgICAgICAgICAgICAgICBvbk9wZW46IGZ1bmN0aW9uIChhKVxuICAgICAgICAgICAgICAgIG9uQ2xvc2U6IGZ1bmN0aW9uIChhKVxuICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcbiAgICAgICAgICAgIGZvciAodmFyIGRlZiBpbiBkZWZhdWx0cykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW2RlZl0gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtc1tkZWZdID0gZGVmYXVsdHNbZGVmXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhLnBhcmFtcyA9IHBhcmFtcztcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBPcGVuZXIgTGluayAmIFZpZXdcbiAgICAgICAgICAgIGlmIChhLnBhcmFtcy5vcGVuZXIpIHtcbiAgICAgICAgICAgICAgICBhLm9wZW5lciA9ICQoYS5wYXJhbXMub3BlbmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciB2aWV3ID0gYS5wYXJhbXMudmlldztcbiAgICAgICAgICAgIGlmICghYS5wYXJhbXMudmlldyAmJiBhLm9wZW5lciAmJiBhLm9wZW5lci5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAvLyBGaW5kIHJlbGF0ZWQgdmlld1xuICAgICAgICAgICAgICAgIHZpZXcgPSBhLm9wZW5lci5wYXJlbnRzKCcuJyArIGFwcC5wYXJhbXMudmlld0NsYXNzKTtcbiAgICAgICAgICAgICAgICBpZiAodmlldy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICB2aWV3ID0gdmlld1swXS5mN1ZpZXc7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5wdXRcbiAgICAgICAgICAgIGlmIChhLnBhcmFtcy5pbnB1dCkge1xuICAgICAgICAgICAgICAgIGEuaW5wdXQgPSAkKGEucGFyYW1zLmlucHV0KTtcbiAgICAgICAgICAgICAgICBpZiAoYS5pbnB1dC5sZW5ndGggPT09IDAgJiYgYS5wYXJhbXMub3BlbkluID09PSAnZHJvcGRvd24nKSByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQXJyYXkgd2l0aCBzZWxlY3RlZCBpdGVtc1xuICAgICAgICAgICAgYS52YWx1ZSA9IGEucGFyYW1zLnZhbHVlIHx8IFtdO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIElEICYgSW5wdXRzXG4gICAgICAgICAgICBhLmlkID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTtcbiAgICAgICAgICAgIGEuaW5wdXRUeXBlID0gYS5wYXJhbXMubXVsdGlwbGUgPyAnY2hlY2tib3gnIDogJ3JhZGlvJztcbiAgICAgICAgICAgIGEuaW5wdXROYW1lID0gYS5pbnB1dFR5cGUgKyAnLScgKyBhLmlkO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIElzIE1hdGVyaWFsXG4gICAgICAgICAgICB2YXIgbWF0ZXJpYWwgPSBhcHAucGFyYW1zLm1hdGVyaWFsO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEJhY2sgT24gU2VsZWN0XG4gICAgICAgICAgICB2YXIgYmFja09uU2VsZWN0ID0gYS5wYXJhbXMuYmFja09uU2VsZWN0O1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChhLnBhcmFtcy5vcGVuSW4gIT09ICdkcm9wZG93bicpIHtcbiAgICAgICAgICAgICAgICAvLyBJdGVtIFRlbXBsYXRlXG4gICAgICAgICAgICAgICAgYS5pdGVtVGVtcGxhdGUgPSB0Ny5jb21waWxlKGEucGFyYW1zLml0ZW1UZW1wbGF0ZSB8fFxuICAgICAgICAgICAgICAgICAgICAnPGxpPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxsYWJlbCBjbGFzcz1cImxhYmVsLXt7aW5wdXRUeXBlfX0gaXRlbS1jb250ZW50XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxpbnB1dCB0eXBlPVwie3tpbnB1dFR5cGV9fVwiIG5hbWU9XCJ7e2lucHV0TmFtZX19XCIgdmFsdWU9XCJ7e3ZhbHVlfX1cIiB7eyNpZiBzZWxlY3RlZH19Y2hlY2tlZHt7L2lmfX0+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIG1hdGVyaWFsfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLW1lZGlhXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGkgY2xhc3M9XCJpY29uIGljb24tZm9ybS17e2lucHV0VHlwZX19XCI+PC9pPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLXRpdGxlXCI+e3t0ZXh0fX08L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7e2Vsc2V9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgY2hlY2tib3h9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tbWVkaWFcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8aSBjbGFzcz1cImljb24gaWNvbi1mb3JtLWNoZWNrYm94XCI+PC9pPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLXRpdGxlXCI+e3t0ZXh0fX08L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9sYWJlbD4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvbGk+J1xuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgLy8gUGFnZSBMYXlvdXRcbiAgICAgICAgICAgICAgICB2YXIgcGFnZVRpdGxlID0gYS5wYXJhbXMucGFnZVRpdGxlIHx8ICcnO1xuICAgICAgICAgICAgICAgIGlmICghcGFnZVRpdGxlICYmIGEub3BlbmVyICYmIGEub3BlbmVyLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBwYWdlVGl0bGUgPSBhLm9wZW5lci5maW5kKCcuaXRlbS10aXRsZScpLnRleHQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2VOYW1lID0gJ2F1dG9jb21wbGV0ZS0nICsgYS5pbnB1dE5hbWU7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBuYXZiYXJUaGVtZSA9IGEucGFyYW1zLm5hdmJhclRoZW1lLFxuICAgICAgICAgICAgICAgICAgICBmb3JtVGhlbWUgPSBhLnBhcmFtcy5mb3JtVGhlbWU7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIE5hdmJhciBIVE1MXG4gICAgICAgICAgICAgICAgdmFyIG5hdmJhckhUTUw7XG4gICAgICAgICAgICAgICAgdmFyIG5vTmF2YmFyID0gJycsIG5vVG9vbGJhciA9ICcnLCBuYXZiYXJMYXlvdXQ7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGEubmF2YmFyVGVtcGxhdGUgPSB0Ny5jb21waWxlKGEucGFyYW1zLm5hdmJhclRlbXBsYXRlIHx8XG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibmF2YmFyIHt7I2lmIG5hdmJhclRoZW1lfX10aGVtZS17e25hdmJhclRoZW1lfX17ey9pZn19XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIm5hdmJhci1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibGVmdCBzbGlkaW5nXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBtYXRlcmlhbH19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8YSBocmVmPVwiI1wiIGNsYXNzPVwibGluayB7eyNpZiBpblBvcHVwfX1jbG9zZS1wb3B1cHt7ZWxzZX19YmFja3t7L2lmfX0gaWNvbi1vbmx5XCI+PGkgY2xhc3M9XCJpY29uIGljb24tYmFja1wiPjwvaT48L2E+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7e2Vsc2V9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGEgaHJlZj1cIiNcIiBjbGFzcz1cImxpbmsge3sjaWYgaW5Qb3B1cH19Y2xvc2UtcG9wdXB7e2Vsc2V9fWJhY2t7ey9pZn19XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGkgY2xhc3M9XCJpY29uIGljb24tYmFja1wiPjwvaT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBpblBvcHVwfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3Bhbj57e3BvcHVwQ2xvc2VUZXh0fX08L3NwYW4+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3tlbHNlfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3Bhbj57e2JhY2tUZXh0fX08L3NwYW4+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9hPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImNlbnRlciBzbGlkaW5nXCI+e3twYWdlVGl0bGV9fTwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBwcmVsb2FkZXJ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicmlnaHRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJhdXRvY29tcGxldGUtcHJlbG9hZGVyIHByZWxvYWRlciB7eyNpZiBwcmVsb2FkZXJDb2xvcn19cHJlbG9hZGVyLXt7cHJlbG9hZGVyQ29sb3J9fXt7L2lmfX1cIj48L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PidcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIG5hdmJhckhUTUwgPSBhLm5hdmJhclRlbXBsYXRlKHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZVRpdGxlOiBwYWdlVGl0bGUsXG4gICAgICAgICAgICAgICAgICAgIGJhY2tUZXh0OiBhLnBhcmFtcy5iYWNrVGV4dCxcbiAgICAgICAgICAgICAgICAgICAgcG9wdXBDbG9zZVRleHQ6IGEucGFyYW1zLnBvcHVwQ2xvc2VUZXh0LFxuICAgICAgICAgICAgICAgICAgICBvcGVuSW46IGEucGFyYW1zLm9wZW5JbixcbiAgICAgICAgICAgICAgICAgICAgbmF2YmFyVGhlbWU6IG5hdmJhclRoZW1lLFxuICAgICAgICAgICAgICAgICAgICBpblBvcHVwOiBhLnBhcmFtcy5vcGVuSW4gPT09ICdwb3B1cCcsXG4gICAgICAgICAgICAgICAgICAgIGluUGFnZTogYS5wYXJhbXMub3BlbkluID09PSAncGFnZScsXG4gICAgICAgICAgICAgICAgICAgIG1hdGVyaWFsOiBtYXRlcmlhbCxcbiAgICAgICAgICAgICAgICAgICAgcHJlbG9hZGVyOiBhLnBhcmFtcy5wcmVsb2FkZXIsXG4gICAgICAgICAgICAgICAgICAgIHByZWxvYWRlckNvbG9yOiBhLnBhcmFtcy5wcmVsb2FkZXJDb2xvcixcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIG5hdmJhciBsYXlvdXQgdHlwZSAtIHN0YXRpYy9maXhlZC90aHJvdWdoXG4gICAgICAgICAgICAgICAgaWYgKGEucGFyYW1zLm9wZW5JbiA9PT0gJ3BhZ2UnKSB7XG4gICAgICAgICAgICAgICAgICAgIG5hdmJhckxheW91dCA9ICdzdGF0aWMnO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYS5vcGVuZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhLm9wZW5lci5wYXJlbnRzKCcubmF2YmFyLXRocm91Z2gnKS5sZW5ndGggPiAwKSBuYXZiYXJMYXlvdXQgPSAndGhyb3VnaCc7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYS5vcGVuZXIucGFyZW50cygnLm5hdmJhci1maXhlZCcpLmxlbmd0aCA+IDApIG5hdmJhckxheW91dCA9ICdmaXhlZCc7XG4gICAgICAgICAgICAgICAgICAgICAgICBub1Rvb2xiYXIgPSBhLm9wZW5lci5wYXJlbnRzKCcucGFnZScpLmhhc0NsYXNzKCduby10b29sYmFyJykgPyAnbm8tdG9vbGJhcicgOiAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vTmF2YmFyICA9IGEub3BlbmVyLnBhcmVudHMoJy5wYWdlJykuaGFzQ2xhc3MoJ25vLW5hdmJhcicpICA/ICduby1uYXZiYXInICA6ICduYXZiYXItJyArIG5hdmJhckxheW91dDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh2aWV3LmNvbnRhaW5lcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQodmlldy5jb250YWluZXIpLmhhc0NsYXNzKCduYXZiYXItdGhyb3VnaCcpIHx8ICQodmlldy5jb250YWluZXIpLmZpbmQoJy5uYXZiYXItdGhyb3VnaCcpLmxlbmd0aCA+IDApIG5hdmJhckxheW91dCA9ICd0aHJvdWdoJztcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKHZpZXcuY29udGFpbmVyKS5oYXNDbGFzcygnbmF2YmFyLWZpeGVkJykgfHwgJCh2aWV3LmNvbnRhaW5lcikuZmluZCgnLm5hdmJhci1maXhlZCcpLmxlbmd0aCA+IDApIG5hdmJhckxheW91dCA9ICdmaXhlZCc7XG4gICAgICAgICAgICAgICAgICAgICAgICBub1Rvb2xiYXIgPSAkKHZpZXcuYWN0aXZlUGFnZS5jb250YWluZXIpLmhhc0NsYXNzKCduby10b29sYmFyJykgPyAnbm8tdG9vbGJhcicgOiAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vTmF2YmFyICA9ICQodmlldy5hY3RpdmVQYWdlLmNvbnRhaW5lcikuaGFzQ2xhc3MoJ25vLW5hdmJhcicpICA/ICduby1uYXZiYXInICA6ICduYXZiYXItJyArIG5hdmJhckxheW91dDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmF2YmFyTGF5b3V0ID0gJ2ZpeGVkJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHNlYXJjaGJhckhUTUwgPVxuICAgICAgICAgICAgICAgICAgICAnPGZvcm0gY2xhc3M9XCJzZWFyY2hiYXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwic2VhcmNoYmFyLWlucHV0XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxpbnB1dCB0eXBlPVwic2VhcmNoXCIgcGxhY2Vob2xkZXI9XCInICsgYS5wYXJhbXMuc2VhcmNoYmFyUGxhY2Vob2xkZXJUZXh0ICsgJ1wiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8YSBocmVmPVwiI1wiIGNsYXNzPVwic2VhcmNoYmFyLWNsZWFyXCI+PC9hPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgKG1hdGVyaWFsID8gJycgOiAnPGEgaHJlZj1cIiNcIiBjbGFzcz1cInNlYXJjaGJhci1jYW5jZWxcIj4nICsgYS5wYXJhbXMuc2VhcmNoYmFyQ2FuY2VsVGV4dCArICc8L2E+JykgK1xuICAgICAgICAgICAgICAgICAgICAnPC9mb3JtPicgK1xuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInNlYXJjaGJhci1vdmVybGF5XCI+PC9kaXY+JztcbiAgICAgICAgICAgICAgICB2YXIgcGFnZUhUTUwgPVxuICAgICAgICAgICAgICAgICAgICAobmF2YmFyTGF5b3V0ID09PSAndGhyb3VnaCcgPyBuYXZiYXJIVE1MIDogJycpICtcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwYWdlc1wiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgZGF0YS1wYWdlPVwiJyArIHBhZ2VOYW1lICsgJ1wiIGNsYXNzPVwicGFnZSBhdXRvY29tcGxldGUtcGFnZSAnICsgbm9OYXZiYXIgKyAnICcgKyBub1Rvb2xiYXIgKyAnXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKG5hdmJhckxheW91dCA9PT0gJ2ZpeGVkJyA/IG5hdmJhckhUTUwgOiAnJykgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlYXJjaGJhckhUTUwgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicGFnZS1jb250ZW50XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChuYXZiYXJMYXlvdXQgPT09ICdzdGF0aWMnID8gbmF2YmFySFRNTCA6ICcnKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibGlzdC1ibG9jayBhdXRvY29tcGxldGUtZm91bmQgYXV0b2NvbXBsZXRlLWxpc3QtJyArIGEuaWQgKyAnICcgKyAoZm9ybVRoZW1lID8gJ3RoZW1lLScgKyBmb3JtVGhlbWUgOiAnJykgKyAnXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHVsPjwvdWw+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJsaXN0LWJsb2NrIGF1dG9jb21wbGV0ZS1ub3QtZm91bmRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8dWw+PGxpIGNsYXNzPVwiaXRlbS1jb250ZW50XCI+PGRpdiBjbGFzcz1cIml0ZW0taW5uZXJcIj48ZGl2IGNsYXNzPVwiaXRlbS10aXRsZVwiPicgKyBhLnBhcmFtcy5ub3RGb3VuZFRleHQgKyAnPC9kaXY+PC9kaXY+PC9saT48L3VsPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibGlzdC1ibG9jayBhdXRvY29tcGxldGUtdmFsdWVzXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHVsPjwvdWw+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgYS5kcm9wZG93bkl0ZW1UZW1wbGF0ZSA9IHQ3LmNvbXBpbGUoYS5wYXJhbXMuZHJvcGRvd25JdGVtVGVtcGxhdGUgfHxcbiAgICAgICAgICAgICAgICAgICAgJzxsaT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8bGFiZWwgY2xhc3M9XCJ7eyN1bmxlc3MgcGxhY2Vob2xkZXJ9fWxhYmVsLXJhZGlve3svdW5sZXNzfX0gaXRlbS1jb250ZW50XCIgZGF0YS12YWx1ZT1cInt7dmFsdWV9fVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tdGl0bGVcIj57e3RleHR9fTwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8L2xhYmVsPicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9saT4nXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBhLmRyb3Bkb3duUGxhY2Vob2xkZXJUZW1wbGF0ZSA9IHQ3LmNvbXBpbGUoYS5wYXJhbXMuZHJvcGRvd25QbGFjZWhvbGRlclRlbXBsYXRlIHx8XG4gICAgICAgICAgICAgICAgICAgICc8bGkgY2xhc3M9XCJhdXRvY29tcGxldGUtZHJvcGRvd24tcGxhY2Vob2xkZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1jb250ZW50XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS10aXRsZVwiPnt7dGV4dH19PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvbGFiZWw+JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2xpPidcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGEuZHJvcGRvd25UZW1wbGF0ZSA9IHQ3LmNvbXBpbGUoYS5wYXJhbXMuZHJvcGRvd25UZW1wbGF0ZSB8fFxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImF1dG9jb21wbGV0ZS1kcm9wZG93blwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJhdXRvY29tcGxldGUtZHJvcGRvd24taW5uZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImxpc3QtYmxvY2tcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzx1bD48L3VsPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBwcmVsb2FkZXJ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJhdXRvY29tcGxldGUtcHJlbG9hZGVyIHByZWxvYWRlciB7eyNpZiBwcmVsb2FkZXJDb2xvcn19cHJlbG9hZGVyLXt7cHJlbG9hZGVyQ29sb3J9fXt7L2lmfX1cIj57eyNpZiBtYXRlcmlhbH19e3ttYXRlcmlhbFByZWxvYWRlckh0bWx9fXt7L2lmfX08L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBEZWZpbmUgcG9wdXBcbiAgICAgICAgICAgIGEucG9wdXAgPSB1bmRlZmluZWQ7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGVmaW5lIERyb3Bkb3duXG4gICAgICAgICAgICBhLmRyb3Bkb3duID0gdW5kZWZpbmVkO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEhhbmRsZSBJbnB1dCBWYWx1ZSBDaGFuZ2VcbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZUlucHV0VmFsdWUgKGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgcXVlcnkgPSBhLmlucHV0LnZhbCgpO1xuICAgICAgICAgICAgICAgIGlmIChhLnBhcmFtcy5zb3VyY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgYS5wYXJhbXMuc291cmNlKGEsIHF1ZXJ5LCBmdW5jdGlvbiAoaXRlbXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdGVtc0hUTUwgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsaW1pdCA9IGEucGFyYW1zLmxpbWl0ID8gTWF0aC5taW4oYS5wYXJhbXMubGltaXQsIGl0ZW1zLmxlbmd0aCkgOiBpdGVtcy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICBhLml0ZW1zID0gaXRlbXM7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaSwgajtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZWdFeHAgPSBuZXcgUmVnRXhwKCcoJytxdWVyeSsnKScsICdpJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGltaXQ7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdGVtVmFsdWUgPSB0eXBlb2YgaXRlbXNbaV0gPT09ICdvYmplY3QnID8gaXRlbXNbaV1bYS5wYXJhbXMudmFsdWVQcm9wZXJ0eV0gOiBpdGVtc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc0hUTUwgKz0gYS5kcm9wZG93bkl0ZW1UZW1wbGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpdGVtVmFsdWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6ICh0eXBlb2YgaXRlbXNbaV0gIT09ICdvYmplY3QnID8gaXRlbXNbaV0gOiBpdGVtc1tpXVthLnBhcmFtcy50ZXh0UHJvcGVydHldKS5yZXBsYWNlKHJlZ0V4cCwgJzxiPiQxPC9iPicpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbXNIVE1MID09PSAnJyAmJiBxdWVyeSA9PT0gJycgJiYgYS5wYXJhbXMuZHJvcGRvd25QbGFjZWhvbGRlclRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc0hUTUwgKz0gYS5kcm9wZG93blBsYWNlaG9sZGVyVGVtcGxhdGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBhLnBhcmFtcy5kcm9wZG93blBsYWNlaG9sZGVyVGV4dCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGEuZHJvcGRvd24uZmluZCgndWwnKS5odG1sKGl0ZW1zSFRNTCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIEhhbmRsZSBEcm9wIERvd24gQ2xpY2tcbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZURyb3Bkb3duQ2xpY2sgKGUpIHtcbiAgICAgICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqL1xuICAgICAgICAgICAgICAgIHZhciBjbGlja2VkID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICB2YXIgY2xpY2tlZEl0ZW07XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhLml0ZW1zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpdGVtVmFsdWUgPSB0eXBlb2YgYS5pdGVtc1tpXSA9PT0gJ29iamVjdCcgPyBhLml0ZW1zW2ldW2EucGFyYW1zLnZhbHVlUHJvcGVydHldIDogYS5pdGVtc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gY2xpY2tlZC5hdHRyKCdkYXRhLXZhbHVlJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtVmFsdWUgPT09IHZhbHVlIHx8IGl0ZW1WYWx1ZSAqIDEgPT09IHZhbHVlICogMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2xpY2tlZEl0ZW0gPSBhLml0ZW1zW2ldO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhLnBhcmFtcy51cGRhdGVJbnB1dFZhbHVlT25TZWxlY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgYS5pbnB1dC52YWwodHlwZW9mIGNsaWNrZWRJdGVtID09PSAnb2JqZWN0JyA/IGNsaWNrZWRJdGVtW2EucGFyYW1zLnRleHRQcm9wZXJ0eV0gOiBjbGlja2VkSXRlbSk7XG4gICAgICAgICAgICAgICAgICAgIGEuaW5wdXQudHJpZ2dlcignaW5wdXQgY2hhbmdlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub25DaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgYS5wYXJhbXMub25DaGFuZ2UoYSwgY2xpY2tlZEl0ZW0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgYS5jbG9zZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIEhhbmRsZSBIVE1MIENsaWNrIHRvIGNsb3NlIERyb3Bkb3duXG4gICAgICAgICAgICBmdW5jdGlvbiBjbG9zZU9uSFRNTENsaWNrIChlKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9ICQoZS50YXJnZXQpO1xuICAgICAgICAgICAgICAgIGlmICghKHRhcmdldC5pcyhhLmlucHV0WzBdKSB8fCBhLmRyb3Bkb3duICYmIHRhcmdldC5wYXJlbnRzKGEuZHJvcGRvd25bMF0pLmxlbmd0aCA+IDApKSB7XG4gICAgICAgICAgICAgICAgICAgIGEuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgYS5wb3NpdGlvbkRyb3BEb3duID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBsaXN0QmxvY2sgPSBhLmlucHV0LnBhcmVudHMoJy5saXN0LWJsb2NrJyksXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50ID0gYS5pbnB1dC5wYXJlbnRzKCcucGFnZS1jb250ZW50JyksXG4gICAgICAgICAgICAgICAgICAgIHBhZGRpbmdUb3AgPSBwYXJzZUludChwYWdlQ29udGVudC5jc3MoJ3BhZGRpbmctdG9wJyksIDEwKSxcbiAgICAgICAgICAgICAgICAgICAgcGFkZGluZ0JvdHRvbSA9IHBhcnNlSW50KHBhZ2VDb250ZW50LmNzcygncGFkZGluZy10b3AnKSwgMTApLFxuICAgICAgICAgICAgICAgICAgICBpbnB1dE9mZnNldCA9IGEuaW5wdXQub2Zmc2V0KCksXG4gICAgICAgICAgICAgICAgICAgIGxpc3RCbG9ja09mZnNldCA9IGxpc3RCbG9jay5sZW5ndGggPiAwID8gbGlzdEJsb2NrLm9mZnNldCgpIDogMCxcbiAgICAgICAgICAgICAgICAgICAgbWF4SGVpZ2h0ID0gcGFnZUNvbnRlbnRbMF0uc2Nyb2xsSGVpZ2h0IC0gcGFkZGluZ0JvdHRvbSAtIChpbnB1dE9mZnNldC50b3AgKyBwYWdlQ29udGVudFswXS5zY3JvbGxUb3ApIC0gYS5pbnB1dFswXS5vZmZzZXRIZWlnaHQ7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGEuZHJvcGRvd24uY3NzKHtcbiAgICAgICAgICAgICAgICAgICAgbGVmdDogKGxpc3RCbG9jay5sZW5ndGggPiAwID8gbGlzdEJsb2NrT2Zmc2V0LmxlZnQgOiBpbnB1dE9mZnNldC5sZWZ0KSArICdweCcsXG4gICAgICAgICAgICAgICAgICAgIHRvcDogaW5wdXRPZmZzZXQudG9wICsgcGFnZUNvbnRlbnRbMF0uc2Nyb2xsVG9wICsgYS5pbnB1dFswXS5vZmZzZXRIZWlnaHQgKyAncHgnLFxuICAgICAgICAgICAgICAgICAgICB3aWR0aDogKGxpc3RCbG9jay5sZW5ndGggPiAwID8gbGlzdEJsb2NrWzBdLm9mZnNldFdpZHRoIDogYS5pbnB1dFswXS5vZmZzZXRXaWR0aCkgKyAncHgnXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgYS5kcm9wZG93bi5jaGlsZHJlbignLmF1dG9jb21wbGV0ZS1kcm9wZG93bi1pbm5lcicpLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgIG1heEhlaWdodDogbWF4SGVpZ2h0ICsgJ3B4JyxcbiAgICAgICAgICAgICAgICAgICAgcGFkZGluZ0xlZnQ6IGxpc3RCbG9jay5sZW5ndGggPiAwICYmICFhLnBhcmFtcy5leHBhbmRJbnB1dCA/IGlucHV0T2Zmc2V0LmxlZnQgLSAobWF0ZXJpYWwgPyAxNiA6IDE1KSArICdweCcgOiAnJ1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBFdmVudCBMaXN0ZW5lcnMgb24gbmV3IHBhZ2VcbiAgICAgICAgICAgIGEucGFnZUluaXQgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIHZhciBwYWdlID0gZS5kZXRhaWwucGFnZTtcbiAgICAgICAgICAgICAgICBhLnBhZ2UgPSAkKHBhZ2UuY29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICBhLnBhZ2VEYXRhID0gcGFnZTtcbiAgICAgICAgICAgICAgICBpZiAocGFnZS5uYW1lICE9PSBwYWdlTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBjb250YWluZXIgPSAkKHBhZ2UuY29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICAvLyBJbml0IFNlYXJjaCBCYXJcbiAgICAgICAgICAgICAgICB2YXIgc2VhcmNoYmFyID0gYXBwLnNlYXJjaGJhcihjb250YWluZXIuZmluZCgnLnNlYXJjaGJhcicpLCB7XG4gICAgICAgICAgICAgICAgICAgIGN1c3RvbVNlYXJjaDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgb25TZWFyY2g6IGZ1bmN0aW9uIChzZWFyY2hiYXIsIGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLnF1ZXJ5Lmxlbmd0aCA9PT0gMCAmJiBzZWFyY2hiYXIuYWN0aXZlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VhcmNoYmFyLm92ZXJsYXkuYWRkQ2xhc3MoJ3NlYXJjaGJhci1vdmVybGF5LWFjdGl2ZScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VhcmNoYmFyLm92ZXJsYXkucmVtb3ZlQ2xhc3MoJ3NlYXJjaGJhci1vdmVybGF5LWFjdGl2ZScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpLCBqLCBrO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhLnBhcmFtcy5zb3VyY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLnBhcmFtcy5zb3VyY2UoYSwgZGF0YS5xdWVyeSwgZnVuY3Rpb24oaXRlbXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1zSFRNTCA9ICcnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGltaXQgPSBhLnBhcmFtcy5saW1pdCA/IE1hdGgubWluKGEucGFyYW1zLmxpbWl0LCBpdGVtcy5sZW5ndGgpIDogaXRlbXMubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLml0ZW1zID0gaXRlbXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsaW1pdDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdGVtVmFsdWUgPSB0eXBlb2YgaXRlbXNbaV0gPT09ICdvYmplY3QnID8gaXRlbXNbaV1bYS5wYXJhbXMudmFsdWVQcm9wZXJ0eV0gOiBpdGVtc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBhLnZhbHVlLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFWYWx1ZSA9IHR5cGVvZiBhLnZhbHVlW2pdID09PSAnb2JqZWN0JyA/IGEudmFsdWVbal1bYS5wYXJhbXMudmFsdWVQcm9wZXJ0eV0gOiBhLnZhbHVlW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhVmFsdWUgPT09IGl0ZW1WYWx1ZSB8fCBhVmFsdWUgKiAxID09PSBpdGVtVmFsdWUgKiAxKSBzZWxlY3RlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc0hUTUwgKz0gYS5pdGVtVGVtcGxhdGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpdGVtVmFsdWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogdHlwZW9mIGl0ZW1zW2ldICE9PSAnb2JqZWN0JyA/IGl0ZW1zW2ldIDogaXRlbXNbaV1bYS5wYXJhbXMudGV4dFByb3BlcnR5XSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dFR5cGU6IGEuaW5wdXRUeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBhLmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0TmFtZTogYS5pbnB1dE5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHNlbGVjdGVkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrYm94OiBhLmlucHV0VHlwZSA9PT0gJ2NoZWNrYm94JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRlcmlhbDogbWF0ZXJpYWxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5maW5kKCcuYXV0b2NvbXBsZXRlLWZvdW5kIHVsJykuaHRtbChpdGVtc0hUTUwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5xdWVyeS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuZmluZCgnLmF1dG9jb21wbGV0ZS1ub3QtZm91bmQnKS5zaG93KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmZpbmQoJy5hdXRvY29tcGxldGUtZm91bmQsIC5hdXRvY29tcGxldGUtdmFsdWVzJykuaGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmZpbmQoJy5hdXRvY29tcGxldGUtdmFsdWVzJykuc2hvdygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5maW5kKCcuYXV0b2NvbXBsZXRlLWZvdW5kLCAuYXV0b2NvbXBsZXRlLW5vdC1mb3VuZCcpLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5maW5kKCcuYXV0b2NvbXBsZXRlLWZvdW5kJykuc2hvdygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmZpbmQoJy5hdXRvY29tcGxldGUtbm90LWZvdW5kLCAuYXV0b2NvbXBsZXRlLXZhbHVlcycpLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFNhdmUgc2VhcmNoYmFyIGluc3RhbmNlXG4gICAgICAgICAgICAgICAgYS5zZWFyY2hiYXIgPSBzZWFyY2hiYXI7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSB2YWx1ZXNcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVWYWx1ZXMoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZXNIVE1MID0gJyc7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYS52YWx1ZS5sZW5ndGg7IGkrKykge1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlc0hUTUwgKz0gYS5pdGVtVGVtcGxhdGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0eXBlb2YgYS52YWx1ZVtpXSA9PT0gJ29iamVjdCcgPyBhLnZhbHVlW2ldW2EucGFyYW1zLnZhbHVlUHJvcGVydHldIDogYS52YWx1ZVtpXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiB0eXBlb2YgYS52YWx1ZVtpXSA9PT0gJ29iamVjdCcgPyBhLnZhbHVlW2ldW2EucGFyYW1zLnRleHRQcm9wZXJ0eV06IGEudmFsdWVbaV0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRUeXBlOiBhLmlucHV0VHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogYS5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dE5hbWU6IGEuaW5wdXROYW1lICsgJy1jaGVja2VkJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja2JveDogYS5pbnB1dFR5cGUgPT09ICdjaGVja2JveCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0ZXJpYWw6IG1hdGVyaWFsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiB0cnVlXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuZmluZCgnLmF1dG9jb21wbGV0ZS12YWx1ZXMgdWwnKS5odG1sKHZhbHVlc0hUTUwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gSGFuZGxlIElucHV0c1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5vbignY2hhbmdlJywgJ2lucHV0W3R5cGU9XCJyYWRpb1wiXSwgaW5wdXRbdHlwZT1cImNoZWNrYm94XCJdJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gdGhpcztcbiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gaW5wdXQudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gJChpbnB1dCkucGFyZW50cygnbGknKS5maW5kKCcuaXRlbS10aXRsZScpLnRleHQoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlzVmFsdWVzID0gJChpbnB1dCkucGFyZW50cygnLmF1dG9jb21wbGV0ZS12YWx1ZXMnKS5sZW5ndGggPiAwO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbSwgaXRlbVZhbHVlLCBhVmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbHVlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGEuaW5wdXRUeXBlID09PSAnY2hlY2tib3gnICYmICFpbnB1dC5jaGVja2VkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGEudmFsdWUubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYVZhbHVlID0gdHlwZW9mIGEudmFsdWVbaV0gPT09ICdzdHJpbmcnID8gYS52YWx1ZVtpXSA6IGEudmFsdWVbaV1bYS5wYXJhbXMudmFsdWVQcm9wZXJ0eV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhVmFsdWUgPT09IHZhbHVlIHx8IGFWYWx1ZSAqIDEgPT09IHZhbHVlICogMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS52YWx1ZS5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlVmFsdWVzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGEucGFyYW1zLm9uQ2hhbmdlKSBhLnBhcmFtcy5vbkNoYW5nZShhLCBhLnZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gRmluZCBSZWxhdGVkIEl0ZW1cbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGEuaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1WYWx1ZSA9IHR5cGVvZiBhLml0ZW1zW2ldID09PSAnc3RyaW5nJyA/IGEuaXRlbXNbaV0gOiBhLml0ZW1zW2ldW2EucGFyYW1zLnZhbHVlUHJvcGVydHldO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1WYWx1ZSA9PT0gdmFsdWUgfHwgaXRlbVZhbHVlICogMSA9PT0gdmFsdWUgKiAxKSBpdGVtID0gYS5pdGVtc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgU2VsZWN0ZWQgVmFsdWVcbiAgICAgICAgICAgICAgICAgICAgaWYgKGEuaW5wdXRUeXBlID09PSAncmFkaW8nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhLnZhbHVlID0gW2l0ZW1dO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlucHV0LmNoZWNrZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLnZhbHVlLnB1c2goaXRlbSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYS52YWx1ZS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhVmFsdWUgPSB0eXBlb2YgYS52YWx1ZVtpXSA9PT0gJ3N0cmluZycgPyBhLnZhbHVlW2ldIDogYS52YWx1ZVtpXVthLnBhcmFtcy52YWx1ZVByb3BlcnR5XTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFWYWx1ZSA9PT0gdmFsdWUgfHwgYVZhbHVlICogMSA9PT0gdmFsdWUgKiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLnZhbHVlLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIFZhbHVlcyBCbG9ja1xuICAgICAgICAgICAgICAgICAgICB1cGRhdGVWYWx1ZXMoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIE9uIFNlbGVjdCBDYWxsYmFja1xuICAgICAgICAgICAgICAgICAgICBpZiAoKGEuaW5wdXRUeXBlID09PSAncmFkaW8nICYmIGlucHV0LmNoZWNrZWQgfHwgYS5pbnB1dFR5cGUgPT09ICdjaGVja2JveCcpICYmIGEucGFyYW1zLm9uQ2hhbmdlICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYS5wYXJhbXMub25DaGFuZ2UoYSwgYS52YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGJhY2tPblNlbGVjdCAmJiBhLmlucHV0VHlwZSA9PT0gJ3JhZGlvJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGEucGFyYW1zLm9wZW5JbiA9PT0gJ3BvcHVwJykgYXBwLmNsb3NlTW9kYWwoYS5wb3B1cCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHZpZXcucm91dGVyLmJhY2soKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVmFsdWVzIE9uIFBhZ2UgSW5pdFxuICAgICAgICAgICAgICAgIHVwZGF0ZVZhbHVlcygpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub25PcGVuKSBhLnBhcmFtcy5vbk9wZW4oYSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNob3cgSGlkZSBQcmVsb2FkZXJcbiAgICAgICAgICAgIGEuc2hvd1ByZWxvYWRlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub3BlbkluID09PSAnZHJvcGRvd24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhLmRyb3Bkb3duKSBhLmRyb3Bkb3duLmZpbmQoJy5hdXRvY29tcGxldGUtcHJlbG9hZGVyJykuYWRkQ2xhc3MoJ2F1dG9jb21wbGV0ZS1wcmVsb2FkZXItdmlzaWJsZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlICQoJy5hdXRvY29tcGxldGUtcHJlbG9hZGVyJykuYWRkQ2xhc3MoJ2F1dG9jb21wbGV0ZS1wcmVsb2FkZXItdmlzaWJsZScpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICBhLmhpZGVQcmVsb2FkZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKGEucGFyYW1zLm9wZW5JbiA9PT0gJ2Ryb3Bkb3duJykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYS5kcm9wZG93bikgYS5kcm9wZG93bi5maW5kKCcuYXV0b2NvbXBsZXRlLXByZWxvYWRlcicpLnJlbW92ZUNsYXNzKCdhdXRvY29tcGxldGUtcHJlbG9hZGVyLXZpc2libGUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSAkKCcuYXV0b2NvbXBsZXRlLXByZWxvYWRlcicpLnJlbW92ZUNsYXNzKCdhdXRvY29tcGxldGUtcHJlbG9hZGVyLXZpc2libGUnKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gT3BlbiBBdXRvY29tcGxldGUgUGFnZS9Qb3B1cFxuICAgICAgICAgICAgYS5vcGVuID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChhLm9wZW5lZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGEub3BlbmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub3BlbkluID09PSAnZHJvcGRvd24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYS5kcm9wZG93bikge1xuICAgICAgICAgICAgICAgICAgICAgICAgYS5kcm9wZG93biA9ICQoYS5kcm9wZG93blRlbXBsYXRlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVsb2FkZXI6IGEucGFyYW1zLnByZWxvYWRlcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVsb2FkZXJDb2xvcjogYS5wYXJhbXMucHJlbG9hZGVyQ29sb3IsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0ZXJpYWw6IG1hdGVyaWFsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGVyaWFsUHJlbG9hZGVySHRtbDogYXBwLnBhcmFtcy5tYXRlcmlhbFByZWxvYWRlckh0bWxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGEuZHJvcGRvd24ub24oJ2NsaWNrJywgJ2xhYmVsJywgaGFuZGxlRHJvcGRvd25DbGljayk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhciBsaXN0QmxvY2sgPSBhLmlucHV0LnBhcmVudHMoJy5saXN0LWJsb2NrJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsaXN0QmxvY2subGVuZ3RoICYmIGEuaW5wdXQucGFyZW50cygnLml0ZW0tY29udGVudCcpLmxlbmd0aCA+IDAgJiYgYS5wYXJhbXMuZXhwYW5kSW5wdXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGEuaW5wdXQucGFyZW50cygnLml0ZW0tY29udGVudCcpLmFkZENsYXNzKCdpdGVtLWNvbnRlbnQtZHJvcGRvd24tZXhwYW5kJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYS5wb3NpdGlvbkRyb3BEb3duKCk7XG4gICAgICAgICAgICAgICAgICAgIGEuaW5wdXQucGFyZW50cygnLnBhZ2UtY29udGVudCcpLmFwcGVuZChhLmRyb3Bkb3duKTtcbiAgICAgICAgICAgICAgICAgICAgYS5kcm9wZG93bi5hZGRDbGFzcygnYXV0b2NvbXBsZXRlLWRyb3Bkb3duLWluJyk7XG4gICAgICAgICAgICAgICAgICAgIGEuaW5wdXQudHJpZ2dlcignaW5wdXQnKTtcbiAgICAgICAgICAgICAgICAgICAgJCh3aW5kb3cpLm9uKCdyZXNpemUnLCBhLnBvc2l0aW9uRHJvcERvd24pO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub25PcGVuKSBhLnBhcmFtcy5vbk9wZW4oYSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vbmNlKCdwYWdlSW5pdCcsICcuYXV0b2NvbXBsZXRlLXBhZ2UnLCBhLnBhZ2VJbml0KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGEucGFyYW1zLm9wZW5JbiA9PT0gJ3BvcHVwJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgYS5wb3B1cCA9IGFwcC5wb3B1cChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBvcHVwIGF1dG9jb21wbGV0ZS1wb3B1cCBhdXRvY29tcGxldGUtcG9wdXAtJyArIGEuaW5wdXROYW1lICsgJ1wiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInZpZXcgbmF2YmFyLWZpeGVkXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlSFRNTCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+J1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgICAgICBhLnBvcHVwID0gJChhLnBvcHVwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGEucG9wdXAub25jZSgnY2xvc2VkJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEucG9wdXAgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5vcGVuZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub25DbG9zZSkgYS5wYXJhbXMub25DbG9zZShhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmlldy5yb3V0ZXIubG9hZCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudDogcGFnZUhUTUxcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgJChkb2N1bWVudCkub25jZSgncGFnZUJhY2snLCAnLmF1dG9jb21wbGV0ZS1wYWdlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEub3BlbmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGEucGFyYW1zLm9uQ2xvc2UpIGEucGFyYW1zLm9uQ2xvc2UoYSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBhLmNsb3NlID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWEub3BlbmVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKGEucGFyYW1zLm9wZW5JbiA9PT0gJ2Ryb3Bkb3duJykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZSAmJiBlLnR5cGUgPT09ICdibHVyJyAmJiBhLmRyb3Bkb3duLmZpbmQoJ2xhYmVsLmFjdGl2ZS1zdGF0ZScpLmxlbmd0aCA+IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgYS5kcm9wZG93bi5yZW1vdmVDbGFzcygnYXV0b2NvbXBsZXRlLWRyb3Bkb3duLWluJykucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIGEuaW5wdXQucGFyZW50cygnLml0ZW0tY29udGVudC1kcm9wZG93bi1leHBhbmQnKS5yZW1vdmVDbGFzcygnaXRlbS1jb250ZW50LWRyb3Bkb3duLWV4cGFuZCcpO1xuICAgICAgICAgICAgICAgICAgICBhLm9wZW5lZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAkKHdpbmRvdykub2ZmKCdyZXNpemUnLCBhLnBvc2l0aW9uRHJvcERvd24pO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub25DbG9zZSkgYS5wYXJhbXMub25DbG9zZShhKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGEucGFyYW1zLm9wZW5JbiA9PT0gJ3BvcHVwJykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYS5wb3B1cCkgYXBwLmNsb3NlTW9kYWwoYS5wb3B1cCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0IEV2ZW50c1xuICAgICAgICAgICAgYS5pbml0RXZlbnRzID0gZnVuY3Rpb24gKGRldGFjaCkge1xuICAgICAgICAgICAgICAgIHZhciBtZXRob2QgPSBkZXRhY2ggPyAnb2ZmJyA6ICdvbic7XG4gICAgICAgICAgICAgICAgaWYgKGEucGFyYW1zLm9wZW5JbiAhPT0gJ2Ryb3Bkb3duJyAmJiBhLm9wZW5lcikge1xuICAgICAgICAgICAgICAgICAgICBhLm9wZW5lclttZXRob2RdKCdjbGljaycsIGEub3Blbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhLnBhcmFtcy5vcGVuSW4gPT09ICdkcm9wZG93bicgJiYgYS5pbnB1dCkge1xuICAgICAgICAgICAgICAgICAgICBhLmlucHV0W21ldGhvZF0oJ2ZvY3VzJywgYS5vcGVuKTtcbiAgICAgICAgICAgICAgICAgICAgYS5pbnB1dFttZXRob2RdKCdpbnB1dCcsIGhhbmRsZUlucHV0VmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5hbmRyb2lkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKCdodG1sJylbbWV0aG9kXSgnY2xpY2snLCBjbG9zZU9uSFRNTENsaWNrKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGEuaW5wdXRbbWV0aG9kXSgnYmx1cicsIGEuY2xvc2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChkZXRhY2ggJiYgYS5kcm9wZG93bikge1xuICAgICAgICAgICAgICAgICAgICBhLmRyb3Bkb3duID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQvRGVzdHJveSBNZXRob2RzXG4gICAgICAgICAgICBhLmluaXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgYS5pbml0RXZlbnRzKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYS5kZXN0cm95ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGEuaW5pdEV2ZW50cyh0cnVlKTtcbiAgICAgICAgICAgICAgICBhID0gbnVsbDtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdFxuICAgICAgICAgICAgYS5pbml0KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGE7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5hdXRvY29tcGxldGUgPSBmdW5jdGlvbiAocGFyYW1zKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IEF1dG9jb21wbGV0ZShwYXJhbXMpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIFBpY2tlciAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICB2YXIgUGlja2VyID0gZnVuY3Rpb24gKHBhcmFtcykge1xuICAgICAgICAgICAgdmFyIHAgPSB0aGlzO1xuICAgICAgICAgICAgdmFyIGRlZmF1bHRzID0ge1xuICAgICAgICAgICAgICAgIHVwZGF0ZVZhbHVlc09uTW9tZW50dW06IGZhbHNlLFxuICAgICAgICAgICAgICAgIHVwZGF0ZVZhbHVlc09uVG91Y2htb3ZlOiB0cnVlLFxuICAgICAgICAgICAgICAgIHJvdGF0ZUVmZmVjdDogZmFsc2UsXG4gICAgICAgICAgICAgICAgbW9tZW50dW1SYXRpbzogNyxcbiAgICAgICAgICAgICAgICBmcmVlTW9kZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgLy8gQ29tbW9uIHNldHRpbmdzXG4gICAgICAgICAgICAgICAgY2xvc2VCeU91dHNpZGVDbGljazogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzY3JvbGxUb0lucHV0OiB0cnVlLFxuICAgICAgICAgICAgICAgIGlucHV0UmVhZE9ubHk6IHRydWUsXG4gICAgICAgICAgICAgICAgY29udmVydFRvUG9wb3ZlcjogdHJ1ZSxcbiAgICAgICAgICAgICAgICBvbmx5SW5Qb3BvdmVyOiBmYWxzZSxcbiAgICAgICAgICAgICAgICB0b29sYmFyOiB0cnVlLFxuICAgICAgICAgICAgICAgIHRvb2xiYXJDbG9zZVRleHQ6ICdEb25lJyxcbiAgICAgICAgICAgICAgICB0b29sYmFyVGVtcGxhdGU6IFxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInRvb2xiYXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwidG9vbGJhci1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibGVmdFwiPjwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicmlnaHRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxhIGhyZWY9XCIjXCIgY2xhc3M9XCJsaW5rIGNsb3NlLXBpY2tlclwiPnt7Y2xvc2VUZXh0fX08L2E+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+J1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcbiAgICAgICAgICAgIGZvciAodmFyIGRlZiBpbiBkZWZhdWx0cykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW2RlZl0gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtc1tkZWZdID0gZGVmYXVsdHNbZGVmXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwLnBhcmFtcyA9IHBhcmFtcztcbiAgICAgICAgICAgIHAuY29scyA9IFtdO1xuICAgICAgICAgICAgcC5pbml0aWFsaXplZCA9IGZhbHNlO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBJbmxpbmUgZmxhZ1xuICAgICAgICAgICAgcC5pbmxpbmUgPSBwLnBhcmFtcy5jb250YWluZXIgPyB0cnVlIDogZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gM0QgVHJhbnNmb3JtcyBvcmlnaW4gYnVnLCBvbmx5IG9uIHNhZmFyaVxuICAgICAgICAgICAgdmFyIG9yaWdpbkJ1ZyA9IGFwcC5kZXZpY2UuaW9zIHx8IChuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkuaW5kZXhPZignc2FmYXJpJykgPj0gMCAmJiBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkuaW5kZXhPZignY2hyb21lJykgPCAwKSAmJiAhYXBwLmRldmljZS5hbmRyb2lkO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNob3VsZCBiZSBjb252ZXJ0ZWQgdG8gcG9wb3ZlclxuICAgICAgICAgICAgZnVuY3Rpb24gaXNQb3BvdmVyKCkge1xuICAgICAgICAgICAgICAgIHZhciB0b1BvcG92ZXIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAoIXAucGFyYW1zLmNvbnZlcnRUb1BvcG92ZXIgJiYgIXAucGFyYW1zLm9ubHlJblBvcG92ZXIpIHJldHVybiB0b1BvcG92ZXI7XG4gICAgICAgICAgICAgICAgaWYgKCFwLmlubGluZSAmJiBwLnBhcmFtcy5pbnB1dCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMub25seUluUG9wb3ZlcikgdG9Qb3BvdmVyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5pb3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b1BvcG92ZXIgPSBhcHAuZGV2aWNlLmlwYWQgPyB0cnVlIDogZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCh3aW5kb3cpLndpZHRoKCkgPj0gNzY4KSB0b1BvcG92ZXIgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBcbiAgICAgICAgICAgICAgICByZXR1cm4gdG9Qb3BvdmVyOyBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGluUG9wb3ZlcigpIHtcbiAgICAgICAgICAgICAgICBpZiAocC5vcGVuZWQgJiYgcC5jb250YWluZXIgJiYgcC5jb250YWluZXIubGVuZ3RoID4gMCAmJiBwLmNvbnRhaW5lci5wYXJlbnRzKCcucG9wb3ZlcicpLmxlbmd0aCA+IDApIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFZhbHVlXG4gICAgICAgICAgICBwLnNldFZhbHVlID0gZnVuY3Rpb24gKGFyclZhbHVlcywgdHJhbnNpdGlvbikge1xuICAgICAgICAgICAgICAgIHZhciB2YWx1ZUluZGV4ID0gMDtcbiAgICAgICAgICAgICAgICBpZiAocC5jb2xzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBwLnZhbHVlID0gYXJyVmFsdWVzO1xuICAgICAgICAgICAgICAgICAgICBwLnVwZGF0ZVZhbHVlKGFyclZhbHVlcyk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwLmNvbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAuY29sc1tpXSAmJiAhcC5jb2xzW2ldLmRpdmlkZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuY29sc1tpXS5zZXRWYWx1ZShhcnJWYWx1ZXNbdmFsdWVJbmRleF0sIHRyYW5zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVJbmRleCsrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHAudXBkYXRlVmFsdWUgPSBmdW5jdGlvbiAoZm9yY2VWYWx1ZXMpIHtcbiAgICAgICAgICAgICAgICB2YXIgbmV3VmFsdWUgPSBmb3JjZVZhbHVlcyB8fCBbXTtcbiAgICAgICAgICAgICAgICB2YXIgbmV3RGlzcGxheVZhbHVlID0gW107XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwLmNvbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmNvbHNbaV0uZGl2aWRlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3VmFsdWUucHVzaChwLmNvbHNbaV0udmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3RGlzcGxheVZhbHVlLnB1c2gocC5jb2xzW2ldLmRpc3BsYXlWYWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG5ld1ZhbHVlLmluZGV4T2YodW5kZWZpbmVkKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcC52YWx1ZSA9IG5ld1ZhbHVlO1xuICAgICAgICAgICAgICAgIHAuZGlzcGxheVZhbHVlID0gbmV3RGlzcGxheVZhbHVlO1xuICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5vbkNoYW5nZSkge1xuICAgICAgICAgICAgICAgICAgICBwLnBhcmFtcy5vbkNoYW5nZShwLCBwLnZhbHVlLCBwLmRpc3BsYXlWYWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChwLmlucHV0ICYmIHAuaW5wdXQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAkKHAuaW5wdXQpLnZhbChwLnBhcmFtcy5mb3JtYXRWYWx1ZSA/IHAucGFyYW1zLmZvcm1hdFZhbHVlKHAsIHAudmFsdWUsIHAuZGlzcGxheVZhbHVlKSA6IHAudmFsdWUuam9pbignICcpKTtcbiAgICAgICAgICAgICAgICAgICAgJChwLmlucHV0KS50cmlnZ2VyKCdjaGFuZ2UnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIENvbHVtbnMgSGFuZGxlcnNcbiAgICAgICAgICAgIHAuaW5pdFBpY2tlckNvbCA9IGZ1bmN0aW9uIChjb2xFbGVtZW50LCB1cGRhdGVJdGVtcykge1xuICAgICAgICAgICAgICAgIHZhciBjb2xDb250YWluZXIgPSAkKGNvbEVsZW1lbnQpO1xuICAgICAgICAgICAgICAgIHZhciBjb2xJbmRleCA9IGNvbENvbnRhaW5lci5pbmRleCgpO1xuICAgICAgICAgICAgICAgIHZhciBjb2wgPSBwLmNvbHNbY29sSW5kZXhdO1xuICAgICAgICAgICAgICAgIGlmIChjb2wuZGl2aWRlcikgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGNvbC5jb250YWluZXIgPSBjb2xDb250YWluZXI7XG4gICAgICAgICAgICAgICAgY29sLndyYXBwZXIgPSBjb2wuY29udGFpbmVyLmZpbmQoJy5waWNrZXItaXRlbXMtY29sLXdyYXBwZXInKTtcbiAgICAgICAgICAgICAgICBjb2wuaXRlbXMgPSBjb2wud3JhcHBlci5maW5kKCcucGlja2VyLWl0ZW0nKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgaSwgajtcbiAgICAgICAgICAgICAgICB2YXIgd3JhcHBlckhlaWdodCwgaXRlbUhlaWdodCwgaXRlbXNIZWlnaHQsIG1pblRyYW5zbGF0ZSwgbWF4VHJhbnNsYXRlO1xuICAgICAgICAgICAgICAgIGNvbC5yZXBsYWNlVmFsdWVzID0gZnVuY3Rpb24gKHZhbHVlcywgZGlzcGxheVZhbHVlcykge1xuICAgICAgICAgICAgICAgICAgICBjb2wuZGVzdHJveUV2ZW50cygpO1xuICAgICAgICAgICAgICAgICAgICBjb2wudmFsdWVzID0gdmFsdWVzO1xuICAgICAgICAgICAgICAgICAgICBjb2wuZGlzcGxheVZhbHVlcyA9IGRpc3BsYXlWYWx1ZXM7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdJdGVtc0hUTUwgPSBwLmNvbHVtbkhUTUwoY29sLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgY29sLndyYXBwZXIuaHRtbChuZXdJdGVtc0hUTUwpO1xuICAgICAgICAgICAgICAgICAgICBjb2wuaXRlbXMgPSBjb2wud3JhcHBlci5maW5kKCcucGlja2VyLWl0ZW0nKTtcbiAgICAgICAgICAgICAgICAgICAgY29sLmNhbGNTaXplKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbC5zZXRWYWx1ZShjb2wudmFsdWVzWzBdLCAwLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgY29sLmluaXRFdmVudHMoKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGNvbC5jYWxjU2l6ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLnJvdGF0ZUVmZmVjdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sLmNvbnRhaW5lci5yZW1vdmVDbGFzcygncGlja2VyLWl0ZW1zLWNvbC1hYnNvbHV0ZScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb2wud2lkdGgpIGNvbC5jb250YWluZXIuY3NzKHt3aWR0aDonJ30pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhciBjb2xXaWR0aCwgY29sSGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICBjb2xXaWR0aCA9IDA7XG4gICAgICAgICAgICAgICAgICAgIGNvbEhlaWdodCA9IGNvbC5jb250YWluZXJbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICB3cmFwcGVySGVpZ2h0ID0gY29sLndyYXBwZXJbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICBpdGVtSGVpZ2h0ID0gY29sLml0ZW1zWzBdLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgaXRlbXNIZWlnaHQgPSBpdGVtSGVpZ2h0ICogY29sLml0ZW1zLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgbWluVHJhbnNsYXRlID0gY29sSGVpZ2h0IC8gMiAtIGl0ZW1zSGVpZ2h0ICsgaXRlbUhlaWdodCAvIDI7XG4gICAgICAgICAgICAgICAgICAgIG1heFRyYW5zbGF0ZSA9IGNvbEhlaWdodCAvIDIgLSBpdGVtSGVpZ2h0IC8gMjsgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChjb2wud2lkdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbFdpZHRoID0gY29sLndpZHRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnNlSW50KGNvbFdpZHRoLCAxMCkgPT09IGNvbFdpZHRoKSBjb2xXaWR0aCA9IGNvbFdpZHRoICsgJ3B4JztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbC5jb250YWluZXIuY3NzKHt3aWR0aDogY29sV2lkdGh9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMucm90YXRlRWZmZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbC53aWR0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbC5pdGVtcy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLmNzcyh7d2lkdGg6J2F1dG8nfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbFdpZHRoID0gTWF0aC5tYXgoY29sV2lkdGgsIGl0ZW1bMF0ub2Zmc2V0V2lkdGgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLmNzcyh7d2lkdGg6Jyd9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2wuY29udGFpbmVyLmNzcyh7d2lkdGg6IChjb2xXaWR0aCArIDIpICsgJ3B4J30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgY29sLmNvbnRhaW5lci5hZGRDbGFzcygncGlja2VyLWl0ZW1zLWNvbC1hYnNvbHV0ZScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBjb2wuY2FsY1NpemUoKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjb2wud3JhcHBlci50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDAsJyArIG1heFRyYW5zbGF0ZSArICdweCwwKScpLnRyYW5zaXRpb24oMCk7XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgYWN0aXZlSW5kZXggPSAwO1xuICAgICAgICAgICAgICAgIHZhciBhbmltYXRpb25GcmFtZUlkO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBTZXQgVmFsdWUgRnVuY3Rpb25cbiAgICAgICAgICAgICAgICBjb2wuc2V0VmFsdWUgPSBmdW5jdGlvbiAobmV3VmFsdWUsIHRyYW5zaXRpb24sIHZhbHVlQ2FsbGJhY2tzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHJhbnNpdGlvbiA9PT0gJ3VuZGVmaW5lZCcpIHRyYW5zaXRpb24gPSAnJztcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld0FjdGl2ZUluZGV4ID0gY29sLndyYXBwZXIuZmluZCgnLnBpY2tlci1pdGVtW2RhdGEtcGlja2VyLXZhbHVlPVwiJyArIG5ld1ZhbHVlICsgJ1wiXScpLmluZGV4KCk7XG4gICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBuZXdBY3RpdmVJbmRleCA9PT0gJ3VuZGVmaW5lZCcgfHwgbmV3QWN0aXZlSW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1RyYW5zbGF0ZSA9IC1uZXdBY3RpdmVJbmRleCAqIGl0ZW1IZWlnaHQgKyBtYXhUcmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSB3cmFwcGVyXG4gICAgICAgICAgICAgICAgICAgIGNvbC53cmFwcGVyLnRyYW5zaXRpb24odHJhbnNpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIGNvbC53cmFwcGVyLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwnICsgKG5ld1RyYW5zbGF0ZSkgKyAncHgsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBXYXRjaCBpdGVtc1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMudXBkYXRlVmFsdWVzT25Nb21lbnR1bSAmJiBjb2wuYWN0aXZlSW5kZXggJiYgY29sLmFjdGl2ZUluZGV4ICE9PSBuZXdBY3RpdmVJbmRleCApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQuY2FuY2VsQW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uRnJhbWVJZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2wud3JhcHBlci50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5jYW5jZWxBbmltYXRpb25GcmFtZShhbmltYXRpb25GcmFtZUlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlRHVyaW5nU2Nyb2xsKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBpdGVtc1xuICAgICAgICAgICAgICAgICAgICBjb2wudXBkYXRlSXRlbXMobmV3QWN0aXZlSW5kZXgsIG5ld1RyYW5zbGF0ZSwgdHJhbnNpdGlvbiwgdmFsdWVDYWxsYmFja3MpO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbC51cGRhdGVJdGVtcyA9IGZ1bmN0aW9uIChhY3RpdmVJbmRleCwgdHJhbnNsYXRlLCB0cmFuc2l0aW9uLCB2YWx1ZUNhbGxiYWNrcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRyYW5zbGF0ZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZSA9ICQuZ2V0VHJhbnNsYXRlKGNvbC53cmFwcGVyWzBdLCAneScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBhY3RpdmVJbmRleCA9PT0gJ3VuZGVmaW5lZCcpIGFjdGl2ZUluZGV4ID0gLU1hdGgucm91bmQoKHRyYW5zbGF0ZSAtIG1heFRyYW5zbGF0ZSkvaXRlbUhlaWdodCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhY3RpdmVJbmRleCA8IDApIGFjdGl2ZUluZGV4ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGl2ZUluZGV4ID49IGNvbC5pdGVtcy5sZW5ndGgpIGFjdGl2ZUluZGV4ID0gY29sLml0ZW1zLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c0FjdGl2ZUluZGV4ID0gY29sLmFjdGl2ZUluZGV4O1xuICAgICAgICAgICAgICAgICAgICBjb2wuYWN0aXZlSW5kZXggPSBhY3RpdmVJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgY29sLndyYXBwZXIuZmluZCgnLnBpY2tlci1zZWxlY3RlZCcpLnJlbW92ZUNsYXNzKCdwaWNrZXItc2VsZWN0ZWQnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGNvbC5pdGVtcy50cmFuc2l0aW9uKHRyYW5zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGVjdGVkSXRlbSA9IGNvbC5pdGVtcy5lcShhY3RpdmVJbmRleCkuYWRkQ2xhc3MoJ3BpY2tlci1zZWxlY3RlZCcpLnRyYW5zZm9ybSgnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gU2V0IDNEIHJvdGF0ZSBlZmZlY3RcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLnJvdGF0ZUVmZmVjdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBlcmNlbnRhZ2UgPSAodHJhbnNsYXRlIC0gKE1hdGguZmxvb3IoKHRyYW5zbGF0ZSAtIG1heFRyYW5zbGF0ZSkvaXRlbUhlaWdodCkgKiBpdGVtSGVpZ2h0ICsgbWF4VHJhbnNsYXRlKSkgLyBpdGVtSGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2wuaXRlbXMuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW0gPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdGVtT2Zmc2V0VG9wID0gaXRlbS5pbmRleCgpICogaXRlbUhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHJhbnNsYXRlT2Zmc2V0ID0gbWF4VHJhbnNsYXRlIC0gdHJhbnNsYXRlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdGVtT2Zmc2V0ID0gaXRlbU9mZnNldFRvcCAtIHRyYW5zbGF0ZU9mZnNldDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGVyY2VudGFnZSA9IGl0ZW1PZmZzZXQgLyBpdGVtSGVpZ2h0O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbXNGaXQgPSBNYXRoLmNlaWwoY29sLmhlaWdodCAvIGl0ZW1IZWlnaHQgLyAyKSArIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFuZ2xlID0gKC0xOCpwZXJjZW50YWdlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYW5nbGUgPiAxODApIGFuZ2xlID0gMTgwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhbmdsZSA8IC0xODApIGFuZ2xlID0gLTE4MDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBGYXIgY2xhc3NcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocGVyY2VudGFnZSkgPiBpdGVtc0ZpdCkgaXRlbS5hZGRDbGFzcygncGlja2VyLWl0ZW0tZmFyJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpdGVtLnJlbW92ZUNsYXNzKCdwaWNrZXItaXRlbS1mYXInKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXQgdHJhbnNmb3JtXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDAsICcgKyAoLXRyYW5zbGF0ZSArIG1heFRyYW5zbGF0ZSkgKyAncHgsICcgKyAob3JpZ2luQnVnID8gLTExMCA6IDApICsgJ3B4KSByb3RhdGVYKCcgKyBhbmdsZSArICdkZWcpJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlQ2FsbGJhY2tzIHx8IHR5cGVvZiB2YWx1ZUNhbGxiYWNrcyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSB2YWx1ZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbC52YWx1ZSA9IHNlbGVjdGVkSXRlbS5hdHRyKCdkYXRhLXBpY2tlci12YWx1ZScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sLmRpc3BsYXlWYWx1ZSA9IGNvbC5kaXNwbGF5VmFsdWVzID8gY29sLmRpc3BsYXlWYWx1ZXNbYWN0aXZlSW5kZXhdIDogY29sLnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gT24gY2hhbmdlIGNhbGxiYWNrXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNBY3RpdmVJbmRleCAhPT0gYWN0aXZlSW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sLm9uQ2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbC5vbkNoYW5nZShwLCBjb2wudmFsdWUsIGNvbC5kaXNwbGF5VmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnVwZGF0ZVZhbHVlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiB1cGRhdGVEdXJpbmdTY3JvbGwoKSB7XG4gICAgICAgICAgICAgICAgICAgIGFuaW1hdGlvbkZyYW1lSWQgPSAkLnJlcXVlc3RBbmltYXRpb25GcmFtZShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2wudXBkYXRlSXRlbXModW5kZWZpbmVkLCB1bmRlZmluZWQsIDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlRHVyaW5nU2Nyb2xsKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gVXBkYXRlIGl0ZW1zIG9uIGluaXRcbiAgICAgICAgICAgICAgICBpZiAodXBkYXRlSXRlbXMpIGNvbC51cGRhdGVJdGVtcygwLCBtYXhUcmFuc2xhdGUsIDApO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgYWxsb3dJdGVtQ2xpY2sgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHZhciBpc1RvdWNoZWQsIGlzTW92ZWQsIHRvdWNoU3RhcnRZLCB0b3VjaEN1cnJlbnRZLCB0b3VjaFN0YXJ0VGltZSwgdG91Y2hFbmRUaW1lLCBzdGFydFRyYW5zbGF0ZSwgcmV0dXJuVG8sIGN1cnJlbnRUcmFuc2xhdGUsIHByZXZUcmFuc2xhdGUsIHZlbG9jaXR5VHJhbnNsYXRlLCB2ZWxvY2l0eVRpbWU7XG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydCAoZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXNNb3ZlZCB8fCBpc1RvdWNoZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB0b3VjaFN0YXJ0WSA9IHRvdWNoQ3VycmVudFkgPSBlLnR5cGUgPT09ICd0b3VjaHN0YXJ0JyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRUaW1lID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGFsbG93SXRlbUNsaWNrID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgc3RhcnRUcmFuc2xhdGUgPSBjdXJyZW50VHJhbnNsYXRlID0gJC5nZXRUcmFuc2xhdGUoY29sLndyYXBwZXJbMF0sICd5Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSAoZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzVG91Y2hlZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIGFsbG93SXRlbUNsaWNrID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoQ3VycmVudFkgPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBGaXJzdCBtb3ZlXG4gICAgICAgICAgICAgICAgICAgICAgICAkLmNhbmNlbEFuaW1hdGlvbkZyYW1lKGFuaW1hdGlvbkZyYW1lSWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNNb3ZlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydFRyYW5zbGF0ZSA9IGN1cnJlbnRUcmFuc2xhdGUgPSAkLmdldFRyYW5zbGF0ZShjb2wud3JhcHBlclswXSwgJ3knKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbC53cmFwcGVyLnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRpZmYgPSB0b3VjaEN1cnJlbnRZIC0gdG91Y2hTdGFydFk7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUcmFuc2xhdGUgPSBzdGFydFRyYW5zbGF0ZSArIGRpZmY7XG4gICAgICAgICAgICAgICAgICAgIHJldHVyblRvID0gdW5kZWZpbmVkO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gTm9ybWFsaXplIHRyYW5zbGF0ZVxuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFRyYW5zbGF0ZSA8IG1pblRyYW5zbGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFRyYW5zbGF0ZSA9IG1pblRyYW5zbGF0ZSAtIE1hdGgucG93KG1pblRyYW5zbGF0ZSAtIGN1cnJlbnRUcmFuc2xhdGUsIDAuOCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5UbyA9ICdtaW4nO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VHJhbnNsYXRlID4gbWF4VHJhbnNsYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNsYXRlID0gbWF4VHJhbnNsYXRlICsgTWF0aC5wb3coY3VycmVudFRyYW5zbGF0ZSAtIG1heFRyYW5zbGF0ZSwgMC44KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblRvID0gJ21heCc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8gVHJhbnNmb3JtIHdyYXBwZXJcbiAgICAgICAgICAgICAgICAgICAgY29sLndyYXBwZXIudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLCcgKyBjdXJyZW50VHJhbnNsYXRlICsgJ3B4LDApJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgaXRlbXNcbiAgICAgICAgICAgICAgICAgICAgY29sLnVwZGF0ZUl0ZW1zKHVuZGVmaW5lZCwgY3VycmVudFRyYW5zbGF0ZSwgMCwgcC5wYXJhbXMudXBkYXRlVmFsdWVzT25Ub3VjaG1vdmUpO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2FsYyB2ZWxvY2l0eVxuICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eVRyYW5zbGF0ZSA9IGN1cnJlbnRUcmFuc2xhdGUgLSBwcmV2VHJhbnNsYXRlIHx8IGN1cnJlbnRUcmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5VGltZSA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgICAgIHByZXZUcmFuc2xhdGUgPSBjdXJyZW50VHJhbnNsYXRlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaEVuZCAoZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzVG91Y2hlZCB8fCAhaXNNb3ZlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgY29sLndyYXBwZXIudHJhbnNpdGlvbignJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXR1cm5Ubykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJldHVyblRvID09PSAnbWluJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbC53cmFwcGVyLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwnICsgbWluVHJhbnNsYXRlICsgJ3B4LDApJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGNvbC53cmFwcGVyLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwnICsgbWF4VHJhbnNsYXRlICsgJ3B4LDApJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdG91Y2hFbmRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2ZWxvY2l0eSwgbmV3VHJhbnNsYXRlO1xuICAgICAgICAgICAgICAgICAgICBpZiAodG91Y2hFbmRUaW1lIC0gdG91Y2hTdGFydFRpbWUgPiAzMDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1RyYW5zbGF0ZSA9IGN1cnJlbnRUcmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eSA9IE1hdGguYWJzKHZlbG9jaXR5VHJhbnNsYXRlIC8gKHRvdWNoRW5kVGltZSAtIHZlbG9jaXR5VGltZSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3VHJhbnNsYXRlID0gY3VycmVudFRyYW5zbGF0ZSArIHZlbG9jaXR5VHJhbnNsYXRlICogcC5wYXJhbXMubW9tZW50dW1SYXRpbztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgbmV3VHJhbnNsYXRlID0gTWF0aC5tYXgoTWF0aC5taW4obmV3VHJhbnNsYXRlLCBtYXhUcmFuc2xhdGUpLCBtaW5UcmFuc2xhdGUpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gQWN0aXZlIEluZGV4XG4gICAgICAgICAgICAgICAgICAgIHZhciBhY3RpdmVJbmRleCA9IC1NYXRoLmZsb29yKChuZXdUcmFuc2xhdGUgLSBtYXhUcmFuc2xhdGUpL2l0ZW1IZWlnaHQpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gTm9ybWFsaXplIHRyYW5zbGF0ZVxuICAgICAgICAgICAgICAgICAgICBpZiAoIXAucGFyYW1zLmZyZWVNb2RlKSBuZXdUcmFuc2xhdGUgPSAtYWN0aXZlSW5kZXggKiBpdGVtSGVpZ2h0ICsgbWF4VHJhbnNsYXRlO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gVHJhbnNmb3JtIHdyYXBwZXJcbiAgICAgICAgICAgICAgICAgICAgY29sLndyYXBwZXIudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLCcgKyAocGFyc2VJbnQobmV3VHJhbnNsYXRlLDEwKSkgKyAncHgsMCknKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBpdGVtc1xuICAgICAgICAgICAgICAgICAgICBjb2wudXBkYXRlSXRlbXMoYWN0aXZlSW5kZXgsIG5ld1RyYW5zbGF0ZSwgJycsIHRydWUpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gV2F0Y2ggaXRlbXNcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLnVwZGF0ZVZhbHVlc09uTW9tZW50dW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZUR1cmluZ1Njcm9sbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sLndyYXBwZXIudHJhbnNpdGlvbkVuZChmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQuY2FuY2VsQW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uRnJhbWVJZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gQWxsb3cgY2xpY2tcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxvd0l0ZW1DbGljayA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH0sIDEwMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVDbGljayhlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYWxsb3dJdGVtQ2xpY2spIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgJC5jYW5jZWxBbmltYXRpb25GcmFtZShhbmltYXRpb25GcmFtZUlkKTtcbiAgICAgICAgICAgICAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi9cbiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gJCh0aGlzKS5hdHRyKCdkYXRhLXBpY2tlci12YWx1ZScpO1xuICAgICAgICAgICAgICAgICAgICBjb2wuc2V0VmFsdWUodmFsdWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgY29sLmluaXRFdmVudHMgPSBmdW5jdGlvbiAoZGV0YWNoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBtZXRob2QgPSBkZXRhY2ggPyAnb2ZmJyA6ICdvbic7XG4gICAgICAgICAgICAgICAgICAgIGNvbC5jb250YWluZXJbbWV0aG9kXShhcHAudG91Y2hFdmVudHMuc3RhcnQsIGhhbmRsZVRvdWNoU3RhcnQpO1xuICAgICAgICAgICAgICAgICAgICBjb2wuY29udGFpbmVyW21ldGhvZF0oYXBwLnRvdWNoRXZlbnRzLm1vdmUsIGhhbmRsZVRvdWNoTW92ZSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbC5jb250YWluZXJbbWV0aG9kXShhcHAudG91Y2hFdmVudHMuZW5kLCBoYW5kbGVUb3VjaEVuZCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbC5pdGVtc1ttZXRob2RdKCdjbGljaycsIGhhbmRsZUNsaWNrKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGNvbC5kZXN0cm95RXZlbnRzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBjb2wuaW5pdEV2ZW50cyh0cnVlKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBjb2wuY29udGFpbmVyWzBdLmY3RGVzdHJveVBpY2tlckNvbCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgY29sLmRlc3Ryb3lFdmVudHMoKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBjb2wuaW5pdEV2ZW50cygpO1xuICAgICAgICBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwLmRlc3Ryb3lQaWNrZXJDb2wgPSBmdW5jdGlvbiAoY29sQ29udGFpbmVyKSB7XG4gICAgICAgICAgICAgICAgY29sQ29udGFpbmVyID0gJChjb2xDb250YWluZXIpO1xuICAgICAgICAgICAgICAgIGlmICgnZjdEZXN0cm95UGlja2VyQ29sJyBpbiBjb2xDb250YWluZXJbMF0pIGNvbENvbnRhaW5lclswXS5mN0Rlc3Ryb3lQaWNrZXJDb2woKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICAvLyBSZXNpemUgY29sc1xuICAgICAgICAgICAgZnVuY3Rpb24gcmVzaXplQ29scygpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXAub3BlbmVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwLmNvbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmNvbHNbaV0uZGl2aWRlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5jb2xzW2ldLmNhbGNTaXplKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLmNvbHNbaV0uc2V0VmFsdWUocC5jb2xzW2ldLnZhbHVlLCAwLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAkKHdpbmRvdykub24oJ3Jlc2l6ZScsIHJlc2l6ZUNvbHMpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEhUTUwgTGF5b3V0XG4gICAgICAgICAgICBwLmNvbHVtbkhUTUwgPSBmdW5jdGlvbiAoY29sLCBvbmx5SXRlbXMpIHtcbiAgICAgICAgICAgICAgICB2YXIgY29sdW1uSXRlbXNIVE1MID0gJyc7XG4gICAgICAgICAgICAgICAgdmFyIGNvbHVtbkhUTUwgPSAnJztcbiAgICAgICAgICAgICAgICBpZiAoY29sLmRpdmlkZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgY29sdW1uSFRNTCArPSAnPGRpdiBjbGFzcz1cInBpY2tlci1pdGVtcy1jb2wgcGlja2VyLWl0ZW1zLWNvbC1kaXZpZGVyICcgKyAoY29sLnRleHRBbGlnbiA/ICdwaWNrZXItaXRlbXMtY29sLScgKyBjb2wudGV4dEFsaWduIDogJycpICsgJyAnICsgKGNvbC5jc3NDbGFzcyB8fCAnJykgKyAnXCI+JyArIGNvbC5jb250ZW50ICsgJzwvZGl2Pic7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGNvbC52YWx1ZXMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbkl0ZW1zSFRNTCArPSAnPGRpdiBjbGFzcz1cInBpY2tlci1pdGVtXCIgZGF0YS1waWNrZXItdmFsdWU9XCInICsgY29sLnZhbHVlc1tqXSArICdcIj4nICsgKGNvbC5kaXNwbGF5VmFsdWVzID8gY29sLmRpc3BsYXlWYWx1ZXNbal0gOiBjb2wudmFsdWVzW2pdKSArICc8L2Rpdj4nO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbHVtbkhUTUwgKz0gJzxkaXYgY2xhc3M9XCJwaWNrZXItaXRlbXMtY29sICcgKyAoY29sLnRleHRBbGlnbiA/ICdwaWNrZXItaXRlbXMtY29sLScgKyBjb2wudGV4dEFsaWduIDogJycpICsgJyAnICsgKGNvbC5jc3NDbGFzcyB8fCAnJykgKyAnXCI+PGRpdiBjbGFzcz1cInBpY2tlci1pdGVtcy1jb2wtd3JhcHBlclwiPicgKyBjb2x1bW5JdGVtc0hUTUwgKyAnPC9kaXY+PC9kaXY+JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG9ubHlJdGVtcyA/IGNvbHVtbkl0ZW1zSFRNTCA6IGNvbHVtbkhUTUw7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcC5sYXlvdXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBpY2tlckhUTUwgPSAnJztcbiAgICAgICAgICAgICAgICB2YXIgcGlja2VyQ2xhc3MgPSAnJztcbiAgICAgICAgICAgICAgICB2YXIgaTtcbiAgICAgICAgICAgICAgICBwLmNvbHMgPSBbXTtcbiAgICAgICAgICAgICAgICB2YXIgY29sc0hUTUwgPSAnJztcbiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcC5wYXJhbXMuY29scy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgY29sID0gcC5wYXJhbXMuY29sc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgY29sc0hUTUwgKz0gcC5jb2x1bW5IVE1MKHAucGFyYW1zLmNvbHNbaV0pO1xuICAgICAgICAgICAgICAgICAgICBwLmNvbHMucHVzaChjb2wpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwaWNrZXJDbGFzcyA9ICdwaWNrZXItbW9kYWwgcGlja2VyLWNvbHVtbnMgJyArIChwLnBhcmFtcy5jc3NDbGFzcyB8fCAnJykgKyAocC5wYXJhbXMucm90YXRlRWZmZWN0ID8gJyBwaWNrZXItM2QnIDogJycpO1xuICAgICAgICAgICAgICAgIHBpY2tlckhUTUwgPVxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIicgKyAocGlja2VyQ2xhc3MpICsgJ1wiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgKHAucGFyYW1zLnRvb2xiYXIgPyBwLnBhcmFtcy50b29sYmFyVGVtcGxhdGUucmVwbGFjZSgve3tjbG9zZVRleHR9fS9nLCBwLnBhcmFtcy50b29sYmFyQ2xvc2VUZXh0KSA6ICcnKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBpY2tlci1tb2RhbC1pbm5lciBwaWNrZXItaXRlbXNcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2xzSFRNTCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwaWNrZXItY2VudGVyLWhpZ2hsaWdodFwiPjwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcC5waWNrZXJIVE1MID0gcGlja2VySFRNTDsgICAgXG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIElucHV0IEV2ZW50c1xuICAgICAgICAgICAgZnVuY3Rpb24gb3Blbk9uSW5wdXQoZSkge1xuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICBpZiAocC5vcGVuZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICBwLm9wZW4oKTtcbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMuc2Nyb2xsVG9JbnB1dCAmJiAhaXNQb3BvdmVyKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhZ2VDb250ZW50ID0gcC5pbnB1dC5wYXJlbnRzKCcucGFnZS1jb250ZW50Jyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYWdlQ29udGVudC5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHZhciBwYWRkaW5nVG9wID0gcGFyc2VJbnQocGFnZUNvbnRlbnQuY3NzKCdwYWRkaW5nLXRvcCcpLCAxMCksXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nQm90dG9tID0gcGFyc2VJbnQocGFnZUNvbnRlbnQuY3NzKCdwYWRkaW5nLWJvdHRvbScpLCAxMCksXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlSGVpZ2h0ID0gcGFnZUNvbnRlbnRbMF0ub2Zmc2V0SGVpZ2h0IC0gcGFkZGluZ1RvcCAtIHAuY29udGFpbmVyLmhlaWdodCgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZVNjcm9sbEhlaWdodCA9IHBhZ2VDb250ZW50WzBdLnNjcm9sbEhlaWdodCAtIHBhZGRpbmdUb3AgLSBwLmNvbnRhaW5lci5oZWlnaHQoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhZGRpbmdCb3R0b207XG4gICAgICAgICAgICAgICAgICAgIHZhciBpbnB1dFRvcCA9IHAuaW5wdXQub2Zmc2V0KCkudG9wIC0gcGFkZGluZ1RvcCArIHAuaW5wdXRbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXRUb3AgPiBwYWdlSGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsVG9wID0gcGFnZUNvbnRlbnQuc2Nyb2xsVG9wKCkgKyBpbnB1dFRvcCAtIHBhZ2VIZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2Nyb2xsVG9wICsgcGFnZUhlaWdodCA+IHBhZ2VTY3JvbGxIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdQYWRkaW5nQm90dG9tID0gc2Nyb2xsVG9wICsgcGFnZUhlaWdodCAtIHBhZ2VTY3JvbGxIZWlnaHQgKyBwYWRkaW5nQm90dG9tO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYWdlSGVpZ2h0ID09PSBwYWdlU2Nyb2xsSGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhZGRpbmdCb3R0b20gPSBwLmNvbnRhaW5lci5oZWlnaHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnQuY3NzKHsncGFkZGluZy1ib3R0b20nOiAobmV3UGFkZGluZ0JvdHRvbSkgKyAncHgnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudC5zY3JvbGxUb3Aoc2Nyb2xsVG9wLCAzMDApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gY2xvc2VPbkhUTUxDbGljayhlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGluUG9wb3ZlcigpKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKHAuaW5wdXQgJiYgcC5pbnB1dC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldCAhPT0gcC5pbnB1dFswXSAmJiAkKGUudGFyZ2V0KS5wYXJlbnRzKCcucGlja2VyLW1vZGFsJykubGVuZ3RoID09PSAwKSBwLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoJChlLnRhcmdldCkucGFyZW50cygnLnBpY2tlci1tb2RhbCcpLmxlbmd0aCA9PT0gMCkgcC5jbG9zZSgpOyAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAocC5wYXJhbXMuaW5wdXQpIHtcbiAgICAgICAgICAgICAgICBwLmlucHV0ID0gJChwLnBhcmFtcy5pbnB1dCk7XG4gICAgICAgICAgICAgICAgaWYgKHAuaW5wdXQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMuaW5wdXRSZWFkT25seSkgcC5pbnB1dC5wcm9wKCdyZWFkT25seScsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXAuaW5saW5lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLmlucHV0Lm9uKCdjbGljaycsIG9wZW5PbklucHV0KTsgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLmlucHV0UmVhZE9ubHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuaW5wdXQub24oJ2ZvY3VzIG1vdXNlZG93bicsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoIXAuaW5saW5lICYmIHAucGFyYW1zLmNsb3NlQnlPdXRzaWRlQ2xpY2spICQoJ2h0bWwnKS5vbignY2xpY2snLCBjbG9zZU9uSFRNTENsaWNrKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBPcGVuXG4gICAgICAgICAgICBmdW5jdGlvbiBvblBpY2tlckNsb3NlKCkge1xuICAgICAgICAgICAgICAgIHAub3BlbmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKHAuaW5wdXQgJiYgcC5pbnB1dC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHAuaW5wdXQucGFyZW50cygnLnBhZ2UtY29udGVudCcpLmNzcyh7J3BhZGRpbmctYm90dG9tJzogJyd9KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwpIHAuaW5wdXQudHJpZ2dlcignYmx1cicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMub25DbG9zZSkgcC5wYXJhbXMub25DbG9zZShwKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gRGVzdHJveSBldmVudHNcbiAgICAgICAgICAgICAgICBwLmNvbnRhaW5lci5maW5kKCcucGlja2VyLWl0ZW1zLWNvbCcpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBwLmRlc3Ryb3lQaWNrZXJDb2wodGhpcyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgcC5vcGVuZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHAub3BlbiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgdG9Qb3BvdmVyID0gaXNQb3BvdmVyKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICghcC5vcGVuZWQpIHtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIExheW91dFxuICAgICAgICAgICAgICAgICAgICBwLmxheW91dCgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gQXBwZW5kXG4gICAgICAgICAgICAgICAgICAgIGlmICh0b1BvcG92ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAucGlja2VySFRNTCA9ICc8ZGl2IGNsYXNzPVwicG9wb3ZlciBwb3BvdmVyLXBpY2tlci1jb2x1bW5zXCI+PGRpdiBjbGFzcz1cInBvcG92ZXItaW5uZXJcIj4nICsgcC5waWNrZXJIVE1MICsgJzwvZGl2PjwvZGl2Pic7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLnBvcG92ZXIgPSBhcHAucG9wb3ZlcihwLnBpY2tlckhUTUwsIHAucGFyYW1zLmlucHV0LCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuY29udGFpbmVyID0gJChwLnBvcG92ZXIpLmZpbmQoJy5waWNrZXItbW9kYWwnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQocC5wb3BvdmVyKS5vbignY2xvc2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25QaWNrZXJDbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocC5pbmxpbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuY29udGFpbmVyID0gJChwLnBpY2tlckhUTUwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXIuYWRkQ2xhc3MoJ3BpY2tlci1tb2RhbC1pbmxpbmUnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQocC5wYXJhbXMuY29udGFpbmVyKS5hcHBlbmQocC5jb250YWluZXIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXIgPSAkKGFwcC5waWNrZXJNb2RhbChwLnBpY2tlckhUTUwpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQocC5jb250YWluZXIpXG4gICAgICAgICAgICAgICAgICAgICAgICAub24oJ2Nsb3NlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uUGlja2VyQ2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBTdG9yZSBwaWNrZXIgaW5zdGFuY2VcbiAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXJbMF0uZjdQaWNrZXIgPSBwO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gSW5pdCBFdmVudHNcbiAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXIuZmluZCgnLnBpY2tlci1pdGVtcy1jb2wnKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB1cGRhdGVJdGVtcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoKCFwLmluaXRpYWxpemVkICYmIHAucGFyYW1zLnZhbHVlKSB8fCAocC5pbml0aWFsaXplZCAmJiBwLnZhbHVlKSkgdXBkYXRlSXRlbXMgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuaW5pdFBpY2tlckNvbCh0aGlzLCB1cGRhdGVJdGVtcyk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gU2V0IHZhbHVlXG4gICAgICAgICAgICAgICAgICAgIGlmICghcC5pbml0aWFsaXplZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAudmFsdWUpIHAuc2V0VmFsdWUocC52YWx1ZSwgMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChwLnBhcmFtcy52YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAuc2V0VmFsdWUocC5wYXJhbXMudmFsdWUsIDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAudmFsdWUpIHAuc2V0VmFsdWUocC52YWx1ZSwgMCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIE1hdGVyaWFsIEZvY3VzXG4gICAgICAgICAgICAgICAgICAgIGlmIChwLmlucHV0ICYmIHAuaW5wdXQubGVuZ3RoID4gMCAmJiBhcHAucGFyYW1zLm1hdGVyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLmlucHV0LnRyaWdnZXIoJ2ZvY3VzJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFNldCBmbGFnXG4gICAgICAgICAgICAgICAgcC5vcGVuZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHAuaW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMub25PcGVuKSBwLnBhcmFtcy5vbk9wZW4ocCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIENsb3NlXG4gICAgICAgICAgICBwLmNsb3NlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmICghcC5vcGVuZWQgfHwgcC5pbmxpbmUpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAoaW5Qb3BvdmVyKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLmNsb3NlTW9kYWwocC5wb3BvdmVyKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLmNsb3NlTW9kYWwocC5jb250YWluZXIpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBEZXN0cm95XG4gICAgICAgICAgICBwLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcC5jbG9zZSgpO1xuICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5pbnB1dCAmJiBwLmlucHV0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcC5pbnB1dC5vZmYoJ2NsaWNrIGZvY3VzJywgb3Blbk9uSW5wdXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAkKCdodG1sJykub2ZmKCdjbGljaycsIGNsb3NlT25IVE1MQ2xpY2spO1xuICAgICAgICAgICAgICAgICQod2luZG93KS5vZmYoJ3Jlc2l6ZScsIHJlc2l6ZUNvbHMpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAocC5pbmxpbmUpIHtcbiAgICAgICAgICAgICAgICBwLm9wZW4oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmICghcC5pbml0aWFsaXplZCAmJiBwLnBhcmFtcy52YWx1ZSkgcC5zZXRWYWx1ZShwLnBhcmFtcy52YWx1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHA7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5waWNrZXIgPSBmdW5jdGlvbiAocGFyYW1zKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFBpY2tlcihwYXJhbXMpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIENhbGVuZGFyICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHZhciBDYWxlbmRhciA9IGZ1bmN0aW9uIChwYXJhbXMpIHtcbiAgICAgICAgICAgIHZhciBwID0gdGhpcztcbiAgICAgICAgICAgIHZhciBkZWZhdWx0cyA9IHtcbiAgICAgICAgICAgICAgICBtb250aE5hbWVzOiBbJ0phbnVhcnknLCAnRmVicnVhcnknLCAnTWFyY2gnLCAnQXByaWwnLCAnTWF5JywgJ0p1bmUnLCAnSnVseScsICdBdWd1c3QnICwgJ1NlcHRlbWJlcicgLCAnT2N0b2JlcicsICdOb3ZlbWJlcicsICdEZWNlbWJlciddLFxuICAgICAgICAgICAgICAgIG1vbnRoTmFtZXNTaG9ydDogWydKYW4nLCAnRmViJywgJ01hcicsICdBcHInLCAnTWF5JywgJ0p1bicsICdKdWwnLCAnQXVnJywgJ1NlcCcsICdPY3QnLCAnTm92JywgJ0RlYyddLFxuICAgICAgICAgICAgICAgIGRheU5hbWVzOiBbJ1N1bmRheScsICdNb25kYXknLCAnVHVlc2RheScsICdXZWRuZXNkYXknLCAnVGh1cnNkYXknLCAnRnJpZGF5JywgJ1NhdHVyZGF5J10sXG4gICAgICAgICAgICAgICAgZGF5TmFtZXNTaG9ydDogWydTdW4nLCAnTW9uJywgJ1R1ZScsICdXZWQnLCAnVGh1JywgJ0ZyaScsICdTYXQnXSxcbiAgICAgICAgICAgICAgICBmaXJzdERheTogMSwgLy8gRmlyc3QgZGF5IG9mIHRoZSB3ZWVrLCBNb25kYXlcbiAgICAgICAgICAgICAgICB3ZWVrZW5kRGF5czogWzAsIDZdLCAvLyBTdW5kYXkgYW5kIFNhdHVyZGF5XG4gICAgICAgICAgICAgICAgbXVsdGlwbGU6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHJhbmdlUGlja2VyOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBkYXRlRm9ybWF0OiAneXl5eS1tbS1kZCcsXG4gICAgICAgICAgICAgICAgZGlyZWN0aW9uOiAnaG9yaXpvbnRhbCcsIC8vIG9yICd2ZXJ0aWNhbCdcbiAgICAgICAgICAgICAgICBtaW5EYXRlOiBudWxsLFxuICAgICAgICAgICAgICAgIG1heERhdGU6IG51bGwsXG4gICAgICAgICAgICAgICAgZGlzYWJsZWQ6IG51bGwsIC8vIGRhdGVzIHJhbmdlIG9mIGRpc2FibGVkIGRheXNcbiAgICAgICAgICAgICAgICBldmVudHM6IG51bGwsIC8vIGRhdGVzIHJhbmdlIG9mIGRheXMgd2l0aCBldmVudHNcbiAgICAgICAgICAgICAgICByYW5nZXNDbGFzc2VzOiBudWxsLCAvL2FycmF5IHdpdGggY3VzdG9tIGNsYXNzZXMgZGF0ZSByYW5nZXNcbiAgICAgICAgICAgICAgICB0b3VjaE1vdmU6IHRydWUsXG4gICAgICAgICAgICAgICAgYW5pbWF0ZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBjbG9zZU9uU2VsZWN0OiBmYWxzZSxcbiAgICAgICAgICAgICAgICBtb250aFBpY2tlcjogdHJ1ZSxcbiAgICAgICAgICAgICAgICBtb250aFBpY2tlclRlbXBsYXRlOlxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBpY2tlci1jYWxlbmRhci1tb250aC1waWNrZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8YSBocmVmPVwiI1wiIGNsYXNzPVwibGluayBpY29uLW9ubHkgcGlja2VyLWNhbGVuZGFyLXByZXYtbW9udGhcIj48aSBjbGFzcz1cImljb24gaWNvbi1wcmV2XCI+PC9pPjwvYT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz1cImN1cnJlbnQtbW9udGgtdmFsdWVcIj48L3NwYW4+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGEgaHJlZj1cIiNcIiBjbGFzcz1cImxpbmsgaWNvbi1vbmx5IHBpY2tlci1jYWxlbmRhci1uZXh0LW1vbnRoXCI+PGkgY2xhc3M9XCJpY29uIGljb24tbmV4dFwiPjwvaT48L2E+JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nLFxuICAgICAgICAgICAgICAgIHllYXJQaWNrZXI6IHRydWUsXG4gICAgICAgICAgICAgICAgeWVhclBpY2tlclRlbXBsYXRlOlxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBpY2tlci1jYWxlbmRhci15ZWFyLXBpY2tlclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxhIGhyZWY9XCIjXCIgY2xhc3M9XCJsaW5rIGljb24tb25seSBwaWNrZXItY2FsZW5kYXItcHJldi15ZWFyXCI+PGkgY2xhc3M9XCJpY29uIGljb24tcHJldlwiPjwvaT48L2E+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPHNwYW4gY2xhc3M9XCJjdXJyZW50LXllYXItdmFsdWVcIj48L3NwYW4+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGEgaHJlZj1cIiNcIiBjbGFzcz1cImxpbmsgaWNvbi1vbmx5IHBpY2tlci1jYWxlbmRhci1uZXh0LXllYXJcIj48aSBjbGFzcz1cImljb24gaWNvbi1uZXh0XCI+PC9pPjwvYT4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicsXG4gICAgICAgICAgICAgICAgd2Vla0hlYWRlcjogdHJ1ZSxcbiAgICAgICAgICAgICAgICAvLyBDb21tb24gc2V0dGluZ3NcbiAgICAgICAgICAgICAgICBjbG9zZUJ5T3V0c2lkZUNsaWNrOiB0cnVlLFxuICAgICAgICAgICAgICAgIHNjcm9sbFRvSW5wdXQ6IHRydWUsXG4gICAgICAgICAgICAgICAgaW5wdXRSZWFkT25seTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBjb252ZXJ0VG9Qb3BvdmVyOiB0cnVlLFxuICAgICAgICAgICAgICAgIG9ubHlJblBvcG92ZXI6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHRvb2xiYXI6IHRydWUsXG4gICAgICAgICAgICAgICAgdG9vbGJhckNsb3NlVGV4dDogJ0RvbmUnLFxuICAgICAgICAgICAgICAgIGhlYWRlclBsYWNlaG9sZGVyOiAnU2VsZWN0IGRhdGUnLFxuICAgICAgICAgICAgICAgIGhlYWRlcjogYXBwLnBhcmFtcy5tYXRlcmlhbCxcbiAgICAgICAgICAgICAgICBmb290ZXI6IGFwcC5wYXJhbXMubWF0ZXJpYWwsXG4gICAgICAgICAgICAgICAgdG9vbGJhclRlbXBsYXRlOlxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInRvb2xiYXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwidG9vbGJhci1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7e21vbnRoUGlja2VyfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3t5ZWFyUGlja2VyfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicsXG4gICAgICAgICAgICAgICAgaGVhZGVyVGVtcGxhdGU6XG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicGlja2VyLWhlYWRlclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwaWNrZXItY2FsZW5kYXItc2VsZWN0ZWQtZGF0ZVwiPnt7cGxhY2Vob2xkZXJ9fTwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyxcbiAgICAgICAgICAgICAgICBmb290ZXJUZW1wbGF0ZTpcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwaWNrZXItZm9vdGVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGEgaHJlZj1cIiNcIiBjbGFzcz1cImJ1dHRvbiBjbG9zZS1waWNrZXJcIj57e2Nsb3NlVGV4dH19PC9hPicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyxcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLyogQ2FsbGJhY2tzXG4gICAgICAgICAgICAgICAgb25Nb250aEFkZFxuICAgICAgICAgICAgICAgIG9uQ2hhbmdlXG4gICAgICAgICAgICAgICAgb25PcGVuXG4gICAgICAgICAgICAgICAgb25DbG9zZVxuICAgICAgICAgICAgICAgIG9uRGF5Q2xpY2tcbiAgICAgICAgICAgICAgICBvbk1vbnRoWWVhckNoYW5nZVN0YXJ0XG4gICAgICAgICAgICAgICAgb25Nb250aFllYXJDaGFuZ2VFbmRcbiAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcbiAgICAgICAgICAgIGZvciAodmFyIGRlZiBpbiBkZWZhdWx0cykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW2RlZl0gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtc1tkZWZdID0gZGVmYXVsdHNbZGVmXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwLnBhcmFtcyA9IHBhcmFtcztcbiAgICAgICAgICAgIHAuaW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbmxpbmUgZmxhZ1xuICAgICAgICAgICAgcC5pbmxpbmUgPSBwLnBhcmFtcy5jb250YWluZXIgPyB0cnVlIDogZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSXMgaG9yaXpvbnRhbFxuICAgICAgICAgICAgcC5pc0ggPSBwLnBhcmFtcy5kaXJlY3Rpb24gPT09ICdob3Jpem9udGFsJztcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBSVEwgaW52ZXJ0ZXJcbiAgICAgICAgICAgIHZhciBpbnZlcnRlciA9IHAuaXNIID8gKGFwcC5ydGwgPyAtMSA6IDEpIDogMTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBBbmltYXRpbmcgZmxhZ1xuICAgICAgICAgICAgcC5hbmltYXRpbmcgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTaG91bGQgYmUgY29udmVydGVkIHRvIHBvcG92ZXJcbiAgICAgICAgICAgIGZ1bmN0aW9uIGlzUG9wb3ZlcigpIHtcbiAgICAgICAgICAgICAgICB2YXIgdG9Qb3BvdmVyID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKCFwLnBhcmFtcy5jb252ZXJ0VG9Qb3BvdmVyICYmICFwLnBhcmFtcy5vbmx5SW5Qb3BvdmVyKSByZXR1cm4gdG9Qb3BvdmVyO1xuICAgICAgICAgICAgICAgIGlmICghcC5pbmxpbmUgJiYgcC5wYXJhbXMuaW5wdXQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm9ubHlJblBvcG92ZXIpIHRvUG9wb3ZlciA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UuaW9zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9Qb3BvdmVyID0gYXBwLmRldmljZS5pcGFkID8gdHJ1ZSA6IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQod2luZG93KS53aWR0aCgpID49IDc2OCkgdG9Qb3BvdmVyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdG9Qb3BvdmVyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaW5Qb3BvdmVyKCkge1xuICAgICAgICAgICAgICAgIGlmIChwLm9wZW5lZCAmJiBwLmNvbnRhaW5lciAmJiBwLmNvbnRhaW5lci5sZW5ndGggPiAwICYmIHAuY29udGFpbmVyLnBhcmVudHMoJy5wb3BvdmVyJykubGVuZ3RoID4gMCkgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRm9ybWF0IGRhdGVcbiAgICAgICAgICAgIGZ1bmN0aW9uIGZvcm1hdERhdGUoZGF0ZSkge1xuICAgICAgICAgICAgICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlKTtcbiAgICAgICAgICAgICAgICB2YXIgeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKTtcbiAgICAgICAgICAgICAgICB2YXIgbW9udGggPSBkYXRlLmdldE1vbnRoKCk7XG4gICAgICAgICAgICAgICAgdmFyIG1vbnRoMSA9IG1vbnRoICsgMTtcbiAgICAgICAgICAgICAgICB2YXIgZGF5ID0gZGF0ZS5nZXREYXRlKCk7XG4gICAgICAgICAgICAgICAgdmFyIHdlZWtEYXkgPSBkYXRlLmdldERheSgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4gcC5wYXJhbXMuZGF0ZUZvcm1hdFxuICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgveXl5eS9nLCB5ZWFyKVxuICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgveXkvZywgKHllYXIgKyAnJykuc3Vic3RyaW5nKDIpKVxuICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvbW0vZywgbW9udGgxIDwgMTAgPyAnMCcgKyBtb250aDEgOiBtb250aDEpXG4gICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9tKFxcVyspL2csIG1vbnRoMSArICckMScpXG4gICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9NTS9nLCBwLnBhcmFtcy5tb250aE5hbWVzW21vbnRoXSlcbiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL00oXFxXKykvZywgcC5wYXJhbXMubW9udGhOYW1lc1Nob3J0W21vbnRoXSArICckMScpXG4gICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9kZC9nLCBkYXkgPCAxMCA/ICcwJyArIGRheSA6IGRheSlcbiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL2QoXFxXKykvZywgZGF5ICsgJyQxJylcbiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL0REL2csIHAucGFyYW1zLmRheU5hbWVzW3dlZWtEYXldKVxuICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvRChcXFcrKS9nLCBwLnBhcmFtcy5kYXlOYW1lc1Nob3J0W3dlZWtEYXldICsgJyQxJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFZhbHVlXG4gICAgICAgICAgICBwLmFkZFZhbHVlID0gZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm11bHRpcGxlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcC52YWx1ZSkgcC52YWx1ZSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaW5WYWx1ZXNJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwLnZhbHVlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3IERhdGUodmFsdWUpLmdldFRpbWUoKSA9PT0gbmV3IERhdGUocC52YWx1ZVtpXSkuZ2V0VGltZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5WYWx1ZXNJbmRleCA9IGk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpblZhbHVlc0luZGV4ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC52YWx1ZS5wdXNoKHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAudmFsdWUuc3BsaWNlKGluVmFsdWVzSW5kZXgsIDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHAudXBkYXRlVmFsdWUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAocC5wYXJhbXMucmFuZ2VQaWNrZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLnZhbHVlKSBwLnZhbHVlID0gW107XG4gICAgICAgICAgICAgICAgICAgIGlmIChwLnZhbHVlLmxlbmd0aCA9PT0gMiB8fCBwLnZhbHVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC52YWx1ZSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChwLnZhbHVlWzBdICE9PSB2YWx1ZSkgcC52YWx1ZS5wdXNoKHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBwLnZhbHVlID0gW107XG4gICAgICAgICAgICAgICAgICAgIHAudmFsdWUuc29ydChmdW5jdGlvbiAoYSxiKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYSAtIGI7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBwLnVwZGF0ZVZhbHVlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwLnZhbHVlID0gW3ZhbHVlXTtcbiAgICAgICAgICAgICAgICAgICAgcC51cGRhdGVWYWx1ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwLnNldFZhbHVlID0gZnVuY3Rpb24gKGFyclZhbHVlcykge1xuICAgICAgICAgICAgICAgIHAudmFsdWUgPSBhcnJWYWx1ZXM7XG4gICAgICAgICAgICAgICAgcC51cGRhdGVWYWx1ZSgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHAudXBkYXRlVmFsdWUgPSBmdW5jdGlvbiAob25seUhlYWRlcikge1xuICAgICAgICAgICAgICAgIHZhciBpLCBpbnB1dFZhbHVlO1xuICAgICAgICAgICAgICAgIGlmIChwLmNvbnRhaW5lciAmJiBwLmNvbnRhaW5lci5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci5maW5kKCcucGlja2VyLWNhbGVuZGFyLWRheS1zZWxlY3RlZCcpLnJlbW92ZUNsYXNzKCdwaWNrZXItY2FsZW5kYXItZGF5LXNlbGVjdGVkJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2YWx1ZURhdGU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5yYW5nZVBpY2tlciAmJiBwLnZhbHVlLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gcC52YWx1ZVswXTsgaSA8PSBwLnZhbHVlWzFdOyBpICs9IDI0KjYwKjYwKjEwMDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZURhdGUgPSBuZXcgRGF0ZShpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1kYXlbZGF0YS1kYXRlPVwiJyArIHZhbHVlRGF0ZS5nZXRGdWxsWWVhcigpICsgJy0nICsgdmFsdWVEYXRlLmdldE1vbnRoKCkgKyAnLScgKyB2YWx1ZURhdGUuZ2V0RGF0ZSgpICsgJ1wiXScpLmFkZENsYXNzKCdwaWNrZXItY2FsZW5kYXItZGF5LXNlbGVjdGVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcC52YWx1ZS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlRGF0ZSA9IG5ldyBEYXRlKHAudmFsdWVbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci5maW5kKCcucGlja2VyLWNhbGVuZGFyLWRheVtkYXRhLWRhdGU9XCInICsgdmFsdWVEYXRlLmdldEZ1bGxZZWFyKCkgKyAnLScgKyB2YWx1ZURhdGUuZ2V0TW9udGgoKSArICctJyArIHZhbHVlRGF0ZS5nZXREYXRlKCkgKyAnXCJdJykuYWRkQ2xhc3MoJ3BpY2tlci1jYWxlbmRhci1kYXktc2VsZWN0ZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm9uQ2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgICAgIHAucGFyYW1zLm9uQ2hhbmdlKHAsIHAudmFsdWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoKHAuaW5wdXQgJiYgcC5pbnB1dC5sZW5ndGggPiAwKSB8fCAoYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBwLnBhcmFtcy5oZWFkZXIpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5mb3JtYXRWYWx1ZSkgaW5wdXRWYWx1ZSA9IHAucGFyYW1zLmZvcm1hdFZhbHVlKHAsIHAudmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0VmFsdWUgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwLnZhbHVlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRWYWx1ZS5wdXNoKGZvcm1hdERhdGUocC52YWx1ZVtpXSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRWYWx1ZSA9IGlucHV0VmFsdWUuam9pbihwLnBhcmFtcy5yYW5nZVBpY2tlciA/ICcgLSAnIDogJywgJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwgJiYgcC5wYXJhbXMuaGVhZGVyICYmIHAuY29udGFpbmVyICYmIHAuY29udGFpbmVyLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuY29udGFpbmVyLmZpbmQoJy5waWNrZXItY2FsZW5kYXItc2VsZWN0ZWQtZGF0ZScpLnRleHQoaW5wdXRWYWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaW5wdXQgJiYgcC5pbnB1dC5sZW5ndGggPiAwICYmICFvbmx5SGVhZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKHAuaW5wdXQpLnZhbChpbnB1dFZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICQocC5pbnB1dCkudHJpZ2dlcignY2hhbmdlJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDb2x1bW5zIEhhbmRsZXJzXG4gICAgICAgICAgICBwLmluaXRDYWxlbmRhckV2ZW50cyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgY29sO1xuICAgICAgICAgICAgICAgIHZhciBhbGxvd0l0ZW1DbGljayA9IHRydWU7XG4gICAgICAgICAgICAgICAgdmFyIGlzVG91Y2hlZCwgaXNNb3ZlZCwgdG91Y2hTdGFydFgsIHRvdWNoU3RhcnRZLCB0b3VjaEN1cnJlbnRYLCB0b3VjaEN1cnJlbnRZLCB0b3VjaFN0YXJ0VGltZSwgdG91Y2hFbmRUaW1lLCBzdGFydFRyYW5zbGF0ZSwgY3VycmVudFRyYW5zbGF0ZSwgd3JhcHBlcldpZHRoLCB3cmFwcGVySGVpZ2h0LCBwZXJjZW50YWdlLCB0b3VjaGVzRGlmZiwgaXNTY3JvbGxpbmc7XG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydCAoZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXNNb3ZlZCB8fCBpc1RvdWNoZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgLy8gZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB0b3VjaFN0YXJ0WCA9IHRvdWNoQ3VycmVudFkgPSBlLnR5cGUgPT09ICd0b3VjaHN0YXJ0JyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGUucGFnZVg7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRZID0gdG91Y2hDdXJyZW50WSA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICAgICAgdG91Y2hTdGFydFRpbWUgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgICAgICBwZXJjZW50YWdlID0gMDtcbiAgICAgICAgICAgICAgICAgICAgYWxsb3dJdGVtQ2xpY2sgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBpc1Njcm9sbGluZyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgc3RhcnRUcmFuc2xhdGUgPSBjdXJyZW50VHJhbnNsYXRlID0gcC5tb250aHNUcmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZSAoZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzVG91Y2hlZCkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdG91Y2hDdXJyZW50WCA9IGUudHlwZSA9PT0gJ3RvdWNobW92ZScgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBlLnBhZ2VYO1xuICAgICAgICAgICAgICAgICAgICB0b3VjaEN1cnJlbnRZID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaXNTY3JvbGxpbmcgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpc1Njcm9sbGluZyA9ICEhKGlzU2Nyb2xsaW5nIHx8IE1hdGguYWJzKHRvdWNoQ3VycmVudFkgLSB0b3VjaFN0YXJ0WSkgPiBNYXRoLmFicyh0b3VjaEN1cnJlbnRYIC0gdG91Y2hTdGFydFgpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAocC5pc0ggJiYgaXNTY3JvbGxpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAuYW5pbWF0aW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBhbGxvd0l0ZW1DbGljayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTW92ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpcnN0IG1vdmVcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzTW92ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgd3JhcHBlcldpZHRoID0gcC53cmFwcGVyWzBdLm9mZnNldFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgd3JhcHBlckhlaWdodCA9IHAud3JhcHBlclswXS5vZmZzZXRIZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIudHJhbnNpdGlvbigwKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB0b3VjaGVzRGlmZiA9IHAuaXNIID8gdG91Y2hDdXJyZW50WCAtIHRvdWNoU3RhcnRYIDogdG91Y2hDdXJyZW50WSAtIHRvdWNoU3RhcnRZO1xuICAgICAgICAgICAgICAgICAgICBwZXJjZW50YWdlID0gdG91Y2hlc0RpZmYvKHAuaXNIID8gd3JhcHBlcldpZHRoIDogd3JhcHBlckhlaWdodCk7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUcmFuc2xhdGUgPSAocC5tb250aHNUcmFuc2xhdGUgKiBpbnZlcnRlciArIHBlcmNlbnRhZ2UpICogMTAwO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gVHJhbnNmb3JtIHdyYXBwZXJcbiAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIChwLmlzSCA/IGN1cnJlbnRUcmFuc2xhdGUgOiAwKSArICclLCAnICsgKHAuaXNIID8gMCA6IGN1cnJlbnRUcmFuc2xhdGUpICsgJyUsIDApJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaEVuZCAoZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzVG91Y2hlZCB8fCAhaXNNb3ZlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHRvdWNoRW5kVGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodG91Y2hFbmRUaW1lIC0gdG91Y2hTdGFydFRpbWUgPCAzMDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh0b3VjaGVzRGlmZikgPCAxMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVzZXRNb250aCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodG91Y2hlc0RpZmYgPj0gMTApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnJ0bCkgcC5uZXh0TW9udGgoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHAucHJldk1vbnRoKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnJ0bCkgcC5wcmV2TW9udGgoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHAubmV4dE1vbnRoKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGVyY2VudGFnZSA8PSAtMC41KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5ydGwpIHAucHJldk1vbnRoKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBwLm5leHRNb250aCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocGVyY2VudGFnZSA+PSAwLjUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnJ0bCkgcC5uZXh0TW9udGgoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHAucHJldk1vbnRoKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnJlc2V0TW9udGgoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gQWxsb3cgY2xpY2tcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxvd0l0ZW1DbGljayA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH0sIDEwMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVEYXlDbGljayhlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYWxsb3dJdGVtQ2xpY2spIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRheSA9ICQoZS50YXJnZXQpLnBhcmVudHMoJy5waWNrZXItY2FsZW5kYXItZGF5Jyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXkubGVuZ3RoID09PSAwICYmICQoZS50YXJnZXQpLmhhc0NsYXNzKCdwaWNrZXItY2FsZW5kYXItZGF5JykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRheSA9ICQoZS50YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXkubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXkuaGFzQ2xhc3MoJ3BpY2tlci1jYWxlbmRhci1kYXktc2VsZWN0ZWQnKSAmJiAhKHAucGFyYW1zLm11bHRpcGxlIHx8IHAucGFyYW1zLnJhbmdlUGlja2VyKSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGF5Lmhhc0NsYXNzKCdwaWNrZXItY2FsZW5kYXItZGF5LWRpc2FibGVkJykpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLnBhcmFtcy5yYW5nZVBpY2tlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRheS5oYXNDbGFzcygncGlja2VyLWNhbGVuZGFyLWRheS1uZXh0JykpIHAubmV4dE1vbnRoKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF5Lmhhc0NsYXNzKCdwaWNrZXItY2FsZW5kYXItZGF5LXByZXYnKSkgcC5wcmV2TW9udGgoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YXIgZGF0ZVllYXIgPSBkYXkuYXR0cignZGF0YS15ZWFyJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBkYXRlTW9udGggPSBkYXkuYXR0cignZGF0YS1tb250aCcpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgZGF0ZURheSA9IGRheS5hdHRyKCdkYXRhLWRheScpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMub25EYXlDbGljaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5wYXJhbXMub25EYXlDbGljayhwLCBkYXlbMF0sIGRhdGVZZWFyLCBkYXRlTW9udGgsIGRhdGVEYXkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHAuYWRkVmFsdWUobmV3IERhdGUoZGF0ZVllYXIsIGRhdGVNb250aCwgZGF0ZURheSkuZ2V0VGltZSgpKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLmNsb3NlT25TZWxlY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5yYW5nZVBpY2tlciAmJiBwLnZhbHVlLmxlbmd0aCA9PT0gMiB8fCAhcC5wYXJhbXMucmFuZ2VQaWNrZXIpIHAuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcC5jb250YWluZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1wcmV2LW1vbnRoJykub24oJ2NsaWNrJywgcC5wcmV2TW9udGgpO1xuICAgICAgICAgICAgICAgIHAuY29udGFpbmVyLmZpbmQoJy5waWNrZXItY2FsZW5kYXItbmV4dC1tb250aCcpLm9uKCdjbGljaycsIHAubmV4dE1vbnRoKTtcbiAgICAgICAgICAgICAgICBwLmNvbnRhaW5lci5maW5kKCcucGlja2VyLWNhbGVuZGFyLXByZXYteWVhcicpLm9uKCdjbGljaycsIHAucHJldlllYXIpO1xuICAgICAgICAgICAgICAgIHAuY29udGFpbmVyLmZpbmQoJy5waWNrZXItY2FsZW5kYXItbmV4dC15ZWFyJykub24oJ2NsaWNrJywgcC5uZXh0WWVhcik7XG4gICAgICAgICAgICAgICAgcC53cmFwcGVyLm9uKCdjbGljaycsIGhhbmRsZURheUNsaWNrKTtcbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMudG91Y2hNb3ZlKSB7XG4gICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci5vbihhcHAudG91Y2hFdmVudHMuc3RhcnQsIGhhbmRsZVRvdWNoU3RhcnQpO1xuICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIub24oYXBwLnRvdWNoRXZlbnRzLm1vdmUsIGhhbmRsZVRvdWNoTW92ZSk7XG4gICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci5vbihhcHAudG91Y2hFdmVudHMuZW5kLCBoYW5kbGVUb3VjaEVuZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBwLmNvbnRhaW5lclswXS5mN0Rlc3Ryb3lDYWxlbmRhckV2ZW50cyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1wcmV2LW1vbnRoJykub2ZmKCdjbGljaycsIHAucHJldk1vbnRoKTtcbiAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1uZXh0LW1vbnRoJykub2ZmKCdjbGljaycsIHAubmV4dE1vbnRoKTtcbiAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1wcmV2LXllYXInKS5vZmYoJ2NsaWNrJywgcC5wcmV2WWVhcik7XG4gICAgICAgICAgICAgICAgICAgIHAuY29udGFpbmVyLmZpbmQoJy5waWNrZXItY2FsZW5kYXItbmV4dC15ZWFyJykub2ZmKCdjbGljaycsIHAubmV4dFllYXIpO1xuICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIub2ZmKCdjbGljaycsIGhhbmRsZURheUNsaWNrKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLnRvdWNoTW92ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLm9mZihhcHAudG91Y2hFdmVudHMuc3RhcnQsIGhhbmRsZVRvdWNoU3RhcnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLm9mZihhcHAudG91Y2hFdmVudHMubW92ZSwgaGFuZGxlVG91Y2hNb3ZlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci5vZmYoYXBwLnRvdWNoRXZlbnRzLmVuZCwgaGFuZGxlVG91Y2hFbmQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHAuZGVzdHJveUNhbGVuZGFyRXZlbnRzID0gZnVuY3Rpb24gKGNvbENvbnRhaW5lcikge1xuICAgICAgICAgICAgICAgIGlmICgnZjdEZXN0cm95Q2FsZW5kYXJFdmVudHMnIGluIHAuY29udGFpbmVyWzBdKSBwLmNvbnRhaW5lclswXS5mN0Rlc3Ryb3lDYWxlbmRhckV2ZW50cygpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTY2FuIERhdGVzIFJhbmdlXG4gICAgICAgICAgICBwLmRhdGVJblJhbmdlID0gZnVuY3Rpb24gKGRheURhdGUsIHJhbmdlKSB7XG4gICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdmFyIGk7XG4gICAgICAgICAgICAgICAgaWYgKCFyYW5nZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmICgkLmlzQXJyYXkocmFuZ2UpKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCByYW5nZS5sZW5ndGg7IGkgKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyYW5nZVtpXS5mcm9tIHx8IHJhbmdlW2ldLnRvKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmdlW2ldLmZyb20gJiYgcmFuZ2VbaV0udG8pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChkYXlEYXRlIDw9IG5ldyBEYXRlKHJhbmdlW2ldLnRvKS5nZXRUaW1lKCkpICYmIChkYXlEYXRlID49IG5ldyBEYXRlKHJhbmdlW2ldLmZyb20pLmdldFRpbWUoKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChyYW5nZVtpXS5mcm9tKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXlEYXRlID49IG5ldyBEYXRlKHJhbmdlW2ldLmZyb20pLmdldFRpbWUoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJhbmdlW2ldLnRvKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXlEYXRlIDw9IG5ldyBEYXRlKHJhbmdlW2ldLnRvKS5nZXRUaW1lKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF5RGF0ZSA9PT0gbmV3IERhdGUocmFuZ2VbaV0pLmdldFRpbWUoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChyYW5nZS5mcm9tIHx8IHJhbmdlLnRvKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyYW5nZS5mcm9tICYmIHJhbmdlLnRvKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGRheURhdGUgPD0gbmV3IERhdGUocmFuZ2UudG8pLmdldFRpbWUoKSkgJiYgKGRheURhdGUgPj0gbmV3IERhdGUocmFuZ2UuZnJvbSkuZ2V0VGltZSgpKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChyYW5nZS5mcm9tKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF5RGF0ZSA+PSBuZXcgRGF0ZShyYW5nZS5mcm9tKS5nZXRUaW1lKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmFuZ2UudG8pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXlEYXRlIDw9IG5ldyBEYXRlKHJhbmdlLnRvKS5nZXRUaW1lKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIHJhbmdlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIG1hdGNoID0gcmFuZ2UobmV3IERhdGUoZGF5RGF0ZSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2g7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgLy8gQ2FsZW5kYXIgTWV0aG9kc1xuICAgICAgICAgICAgcC5kYXlzSW5Nb250aCA9IGZ1bmN0aW9uIChkYXRlKSB7XG4gICAgICAgICAgICAgICAgdmFyIGQgPSBuZXcgRGF0ZShkYXRlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERhdGUoZC5nZXRGdWxsWWVhcigpLCBkLmdldE1vbnRoKCkgKyAxLCAwKS5nZXREYXRlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcC5tb250aEhUTUwgPSBmdW5jdGlvbiAoZGF0ZSwgb2Zmc2V0KSB7XG4gICAgICAgICAgICAgICAgZGF0ZSA9IG5ldyBEYXRlKGRhdGUpO1xuICAgICAgICAgICAgICAgIHZhciB5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpLFxuICAgICAgICAgICAgICAgICAgICBtb250aCA9IGRhdGUuZ2V0TW9udGgoKSxcbiAgICAgICAgICAgICAgICAgICAgZGF5ID0gZGF0ZS5nZXREYXRlKCk7XG4gICAgICAgICAgICAgICAgaWYgKG9mZnNldCA9PT0gJ25leHQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtb250aCA9PT0gMTEpIGRhdGUgPSBuZXcgRGF0ZSh5ZWFyICsgMSwgMCk7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgZGF0ZSA9IG5ldyBEYXRlKHllYXIsIG1vbnRoICsgMSwgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChvZmZzZXQgPT09ICdwcmV2Jykge1xuICAgICAgICAgICAgICAgICAgICBpZiAobW9udGggPT09IDApIGRhdGUgPSBuZXcgRGF0ZSh5ZWFyIC0gMSwgMTEpO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIGRhdGUgPSBuZXcgRGF0ZSh5ZWFyLCBtb250aCAtIDEsIDEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAob2Zmc2V0ID09PSAnbmV4dCcgfHwgb2Zmc2V0ID09PSAncHJldicpIHtcbiAgICAgICAgICAgICAgICAgICAgbW9udGggPSBkYXRlLmdldE1vbnRoKCk7XG4gICAgICAgICAgICAgICAgICAgIHllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBkYXlzSW5QcmV2TW9udGggPSBwLmRheXNJbk1vbnRoKG5ldyBEYXRlKGRhdGUuZ2V0RnVsbFllYXIoKSwgZGF0ZS5nZXRNb250aCgpKS5nZXRUaW1lKCkgLSAxMCAqIDI0ICogNjAgKiA2MCAqIDEwMDApLFxuICAgICAgICAgICAgICAgICAgICBkYXlzSW5Nb250aCA9IHAuZGF5c0luTW9udGgoZGF0ZSksXG4gICAgICAgICAgICAgICAgICAgIGZpcnN0RGF5T2ZNb250aEluZGV4ID0gbmV3IERhdGUoZGF0ZS5nZXRGdWxsWWVhcigpLCBkYXRlLmdldE1vbnRoKCkpLmdldERheSgpO1xuICAgICAgICAgICAgICAgIGlmIChmaXJzdERheU9mTW9udGhJbmRleCA9PT0gMCkgZmlyc3REYXlPZk1vbnRoSW5kZXggPSA3O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgZGF5RGF0ZSwgY3VycmVudFZhbHVlcyA9IFtdLCBpLCBqLCBrLFxuICAgICAgICAgICAgICAgICAgICByb3dzID0gNiwgY29scyA9IDcsXG4gICAgICAgICAgICAgICAgICAgIG1vbnRoSFRNTCA9ICcnLFxuICAgICAgICAgICAgICAgICAgICBkYXlJbmRleCA9IDAgKyAocC5wYXJhbXMuZmlyc3REYXkgLSAxKSxcbiAgICAgICAgICAgICAgICAgICAgdG9kYXkgPSBuZXcgRGF0ZSgpLnNldEhvdXJzKDAsMCwwLDApLFxuICAgICAgICAgICAgICAgICAgICBtaW5EYXRlID0gcC5wYXJhbXMubWluRGF0ZSA/IG5ldyBEYXRlKHAucGFyYW1zLm1pbkRhdGUpLmdldFRpbWUoKSA6IG51bGwsXG4gICAgICAgICAgICAgICAgICAgIG1heERhdGUgPSBwLnBhcmFtcy5tYXhEYXRlID8gbmV3IERhdGUocC5wYXJhbXMubWF4RGF0ZSkuZ2V0VGltZSgpIDogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQsXG4gICAgICAgICAgICAgICAgICAgIGhhc0V2ZW50O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocC52YWx1ZSAmJiBwLnZhbHVlLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcC52YWx1ZS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFZhbHVlcy5wdXNoKG5ldyBEYXRlKHAudmFsdWVbaV0pLnNldEhvdXJzKDAsMCwwLDApKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgZm9yIChpID0gMTsgaSA8PSByb3dzOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJvd0hUTUwgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJvdyA9IGk7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDE7IGogPD0gY29sczsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29sID0gajtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRheUluZGV4ICsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRheU51bWJlciA9IGRheUluZGV4IC0gZmlyc3REYXlPZk1vbnRoSW5kZXg7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgd2Vla0RheUluZGV4ID0gKGNvbCAtIDEgKyBwLnBhcmFtcy5maXJzdERheSA+IDYpID8gKGNvbCAtIDEgLSA3ICsgcC5wYXJhbXMuZmlyc3REYXkpIDogKGNvbCAtIDEgKyBwLnBhcmFtcy5maXJzdERheSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYWRkQ2xhc3MgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXlOdW1iZXIgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF5TnVtYmVyID0gZGF5c0luUHJldk1vbnRoICsgZGF5TnVtYmVyICsgMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyArPSAnIHBpY2tlci1jYWxlbmRhci1kYXktcHJldic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF5RGF0ZSA9IG5ldyBEYXRlKG1vbnRoIC0gMSA8IDAgPyB5ZWFyIC0gMSA6IHllYXIsIG1vbnRoIC0gMSA8IDAgPyAxMSA6IG1vbnRoIC0gMSwgZGF5TnVtYmVyKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXlOdW1iZXIgPSBkYXlOdW1iZXIgKyAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXlOdW1iZXIgPiBkYXlzSW5Nb250aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXlOdW1iZXIgPSBkYXlOdW1iZXIgLSBkYXlzSW5Nb250aDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkQ2xhc3MgKz0gJyBwaWNrZXItY2FsZW5kYXItZGF5LW5leHQnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXlEYXRlID0gbmV3IERhdGUobW9udGggKyAxID4gMTEgPyB5ZWFyICsgMSA6IHllYXIsIG1vbnRoICsgMSA+IDExID8gMCA6IG1vbnRoICsgMSwgZGF5TnVtYmVyKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXlEYXRlID0gbmV3IERhdGUoeWVhciwgbW9udGgsIGRheU51bWJlcikuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRvZGF5XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF5RGF0ZSA9PT0gdG9kYXkpIGFkZENsYXNzICs9ICcgcGlja2VyLWNhbGVuZGFyLWRheS10b2RheSc7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBTZWxlY3RlZFxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLnJhbmdlUGlja2VyICYmIGN1cnJlbnRWYWx1ZXMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRheURhdGUgPj0gY3VycmVudFZhbHVlc1swXSAmJiBkYXlEYXRlIDw9IGN1cnJlbnRWYWx1ZXNbMV0pIGFkZENsYXNzICs9ICcgcGlja2VyLWNhbGVuZGFyLWRheS1zZWxlY3RlZCc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFZhbHVlcy5pbmRleE9mKGRheURhdGUpID49IDApIGFkZENsYXNzICs9ICcgcGlja2VyLWNhbGVuZGFyLWRheS1zZWxlY3RlZCc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBXZWVrZW5kXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMud2Vla2VuZERheXMuaW5kZXhPZih3ZWVrRGF5SW5kZXgpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyArPSAnIHBpY2tlci1jYWxlbmRhci1kYXktd2Vla2VuZCc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBIYXMgRXZlbnRzXG4gICAgICAgICAgICAgICAgICAgICAgICBoYXNFdmVudCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLmV2ZW50cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLmRhdGVJblJhbmdlKGRheURhdGUsIHAucGFyYW1zLmV2ZW50cykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzRXZlbnQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoYXNFdmVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZENsYXNzICs9ICcgcGlja2VyLWNhbGVuZGFyLWRheS1oYXMtZXZlbnRzJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEN1c3RvbSBSYW5nZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5yYW5nZXNDbGFzc2VzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChrID0gMDsgayA8IHAucGFyYW1zLnJhbmdlc0NsYXNzZXMubGVuZ3RoOyBrKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAuZGF0ZUluUmFuZ2UoZGF5RGF0ZSwgcC5wYXJhbXMucmFuZ2VzQ2xhc3Nlc1trXS5yYW5nZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZENsYXNzICs9ICcgJyArIHAucGFyYW1zLnJhbmdlc0NsYXNzZXNba10uY3NzQ2xhc3M7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBEaXNhYmxlZFxuICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgobWluRGF0ZSAmJiBkYXlEYXRlIDwgbWluRGF0ZSkgfHwgKG1heERhdGUgJiYgZGF5RGF0ZSA+IG1heERhdGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLmRpc2FibGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAuZGF0ZUluUmFuZ2UoZGF5RGF0ZSwgcC5wYXJhbXMuZGlzYWJsZWQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlzYWJsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyArPSAnIHBpY2tlci1jYWxlbmRhci1kYXktZGlzYWJsZWQnO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXlEYXRlID0gbmV3IERhdGUoZGF5RGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGF5WWVhciA9IGRheURhdGUuZ2V0RnVsbFllYXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkYXlNb250aCA9IGRheURhdGUuZ2V0TW9udGgoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvd0hUTUwgKz0gJzxkaXYgZGF0YS15ZWFyPVwiJyArIGRheVllYXIgKyAnXCIgZGF0YS1tb250aD1cIicgKyBkYXlNb250aCArICdcIiBkYXRhLWRheT1cIicgKyBkYXlOdW1iZXIgKyAnXCIgY2xhc3M9XCJwaWNrZXItY2FsZW5kYXItZGF5JyArIChhZGRDbGFzcykgKyAnXCIgZGF0YS1kYXRlPVwiJyArIChkYXlZZWFyICsgJy0nICsgZGF5TW9udGggKyAnLScgKyBkYXlOdW1iZXIpICsgJ1wiPjxzcGFuPicrZGF5TnVtYmVyKyc8L3NwYW4+PC9kaXY+JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBtb250aEhUTUwgKz0gJzxkaXYgY2xhc3M9XCJwaWNrZXItY2FsZW5kYXItcm93XCI+JyArIHJvd0hUTUwgKyAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbW9udGhIVE1MID0gJzxkaXYgY2xhc3M9XCJwaWNrZXItY2FsZW5kYXItbW9udGhcIiBkYXRhLXllYXI9XCInICsgeWVhciArICdcIiBkYXRhLW1vbnRoPVwiJyArIG1vbnRoICsgJ1wiPicgKyBtb250aEhUTUwgKyAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICByZXR1cm4gbW9udGhIVE1MO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHAuYW5pbWF0aW5nID0gZmFsc2U7XG4gICAgICAgICAgICBwLnVwZGF0ZUN1cnJlbnRNb250aFllYXIgPSBmdW5jdGlvbiAoZGlyKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkaXIgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIHAuY3VycmVudE1vbnRoID0gcGFyc2VJbnQocC5tb250aHMuZXEoMSkuYXR0cignZGF0YS1tb250aCcpLCAxMCk7XG4gICAgICAgICAgICAgICAgICAgIHAuY3VycmVudFllYXIgPSBwYXJzZUludChwLm1vbnRocy5lcSgxKS5hdHRyKCdkYXRhLXllYXInKSwgMTApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50TW9udGggPSBwYXJzZUludChwLm1vbnRocy5lcShkaXIgPT09ICduZXh0JyA/IChwLm1vbnRocy5sZW5ndGggLSAxKSA6IDApLmF0dHIoJ2RhdGEtbW9udGgnKSwgMTApO1xuICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRZZWFyID0gcGFyc2VJbnQocC5tb250aHMuZXEoZGlyID09PSAnbmV4dCcgPyAocC5tb250aHMubGVuZ3RoIC0gMSkgOiAwKS5hdHRyKCdkYXRhLXllYXInKSwgMTApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwLmNvbnRhaW5lci5maW5kKCcuY3VycmVudC1tb250aC12YWx1ZScpLnRleHQocC5wYXJhbXMubW9udGhOYW1lc1twLmN1cnJlbnRNb250aF0pO1xuICAgICAgICAgICAgICAgIHAuY29udGFpbmVyLmZpbmQoJy5jdXJyZW50LXllYXItdmFsdWUnKS50ZXh0KHAuY3VycmVudFllYXIpO1xuICAgICAgICBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwLm9uTW9udGhDaGFuZ2VTdGFydCA9IGZ1bmN0aW9uIChkaXIpIHtcbiAgICAgICAgICAgICAgICBwLnVwZGF0ZUN1cnJlbnRNb250aFllYXIoZGlyKTtcbiAgICAgICAgICAgICAgICBwLm1vbnRocy5yZW1vdmVDbGFzcygncGlja2VyLWNhbGVuZGFyLW1vbnRoLWN1cnJlbnQgcGlja2VyLWNhbGVuZGFyLW1vbnRoLXByZXYgcGlja2VyLWNhbGVuZGFyLW1vbnRoLW5leHQnKTtcbiAgICAgICAgICAgICAgICB2YXIgY3VycmVudEluZGV4ID0gZGlyID09PSAnbmV4dCcgPyBwLm1vbnRocy5sZW5ndGggLSAxIDogMDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcC5tb250aHMuZXEoY3VycmVudEluZGV4KS5hZGRDbGFzcygncGlja2VyLWNhbGVuZGFyLW1vbnRoLWN1cnJlbnQnKTtcbiAgICAgICAgICAgICAgICBwLm1vbnRocy5lcShkaXIgPT09ICduZXh0JyA/IGN1cnJlbnRJbmRleCAtIDEgOiBjdXJyZW50SW5kZXggKyAxKS5hZGRDbGFzcyhkaXIgPT09ICduZXh0JyA/ICdwaWNrZXItY2FsZW5kYXItbW9udGgtcHJldicgOiAncGlja2VyLWNhbGVuZGFyLW1vbnRoLW5leHQnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm9uTW9udGhZZWFyQ2hhbmdlU3RhcnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcC5wYXJhbXMub25Nb250aFllYXJDaGFuZ2VTdGFydChwLCBwLmN1cnJlbnRZZWFyLCBwLmN1cnJlbnRNb250aCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHAub25Nb250aENoYW5nZUVuZCA9IGZ1bmN0aW9uIChkaXIsIHJlYnVpbGRCb3RoKSB7XG4gICAgICAgICAgICAgICAgcC5hbmltYXRpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB2YXIgbmV4dE1vbnRoSFRNTCwgcHJldk1vbnRoSFRNTCwgbmV3TW9udGhIVE1MO1xuICAgICAgICAgICAgICAgIHAud3JhcHBlci5maW5kKCcucGlja2VyLWNhbGVuZGFyLW1vbnRoOm5vdCgucGlja2VyLWNhbGVuZGFyLW1vbnRoLXByZXYpOm5vdCgucGlja2VyLWNhbGVuZGFyLW1vbnRoLWN1cnJlbnQpOm5vdCgucGlja2VyLWNhbGVuZGFyLW1vbnRoLW5leHQpJykucmVtb3ZlKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZGlyID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBkaXIgPSAnbmV4dCc7XG4gICAgICAgICAgICAgICAgICAgIHJlYnVpbGRCb3RoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFyZWJ1aWxkQm90aCkge1xuICAgICAgICAgICAgICAgICAgICBuZXdNb250aEhUTUwgPSBwLm1vbnRoSFRNTChuZXcgRGF0ZShwLmN1cnJlbnRZZWFyLCBwLmN1cnJlbnRNb250aCksIGRpcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1tb250aC1uZXh0LCAucGlja2VyLWNhbGVuZGFyLW1vbnRoLXByZXYnKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgcHJldk1vbnRoSFRNTCA9IHAubW9udGhIVE1MKG5ldyBEYXRlKHAuY3VycmVudFllYXIsIHAuY3VycmVudE1vbnRoKSwgJ3ByZXYnKTtcbiAgICAgICAgICAgICAgICAgICAgbmV4dE1vbnRoSFRNTCA9IHAubW9udGhIVE1MKG5ldyBEYXRlKHAuY3VycmVudFllYXIsIHAuY3VycmVudE1vbnRoKSwgJ25leHQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGRpciA9PT0gJ25leHQnIHx8IHJlYnVpbGRCb3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci5hcHBlbmQobmV3TW9udGhIVE1MIHx8IG5leHRNb250aEhUTUwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZGlyID09PSAncHJldicgfHwgcmVidWlsZEJvdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLnByZXBlbmQobmV3TW9udGhIVE1MIHx8IHByZXZNb250aEhUTUwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwLm1vbnRocyA9IHAud3JhcHBlci5maW5kKCcucGlja2VyLWNhbGVuZGFyLW1vbnRoJyk7XG4gICAgICAgICAgICAgICAgcC5zZXRNb250aHNUcmFuc2xhdGUocC5tb250aHNUcmFuc2xhdGUpO1xuICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5vbk1vbnRoQWRkKSB7XG4gICAgICAgICAgICAgICAgICAgIHAucGFyYW1zLm9uTW9udGhBZGQocCwgZGlyID09PSAnbmV4dCcgPyBwLm1vbnRocy5lcShwLm1vbnRocy5sZW5ndGggLSAxKVswXSA6IHAubW9udGhzLmVxKDApWzBdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm9uTW9udGhZZWFyQ2hhbmdlRW5kKSB7XG4gICAgICAgICAgICAgICAgICAgIHAucGFyYW1zLm9uTW9udGhZZWFyQ2hhbmdlRW5kKHAsIHAuY3VycmVudFllYXIsIHAuY3VycmVudE1vbnRoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcC5zZXRNb250aHNUcmFuc2xhdGUgPSBmdW5jdGlvbiAodHJhbnNsYXRlKSB7XG4gICAgICAgICAgICAgICAgdHJhbnNsYXRlID0gdHJhbnNsYXRlIHx8IHAubW9udGhzVHJhbnNsYXRlIHx8IDA7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwLm1vbnRoc1RyYW5zbGF0ZSA9PT0gJ3VuZGVmaW5lZCcpIHAubW9udGhzVHJhbnNsYXRlID0gdHJhbnNsYXRlO1xuICAgICAgICAgICAgICAgIHAubW9udGhzLnJlbW92ZUNsYXNzKCdwaWNrZXItY2FsZW5kYXItbW9udGgtY3VycmVudCBwaWNrZXItY2FsZW5kYXItbW9udGgtcHJldiBwaWNrZXItY2FsZW5kYXItbW9udGgtbmV4dCcpO1xuICAgICAgICAgICAgICAgIHZhciBwcmV2TW9udGhUcmFuc2xhdGUgPSAtKHRyYW5zbGF0ZSArIDEpICogMTAwICogaW52ZXJ0ZXI7XG4gICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRNb250aFRyYW5zbGF0ZSA9IC10cmFuc2xhdGUgKiAxMDAgKiBpbnZlcnRlcjtcbiAgICAgICAgICAgICAgICB2YXIgbmV4dE1vbnRoVHJhbnNsYXRlID0gLSh0cmFuc2xhdGUgLSAxKSAqIDEwMCAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgIHAubW9udGhzLmVxKDApLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIChwLmlzSCA/IHByZXZNb250aFRyYW5zbGF0ZSA6IDApICsgJyUsICcgKyAocC5pc0ggPyAwIDogcHJldk1vbnRoVHJhbnNsYXRlKSArICclLCAwKScpLmFkZENsYXNzKCdwaWNrZXItY2FsZW5kYXItbW9udGgtcHJldicpO1xuICAgICAgICAgICAgICAgIHAubW9udGhzLmVxKDEpLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIChwLmlzSCA/IGN1cnJlbnRNb250aFRyYW5zbGF0ZSA6IDApICsgJyUsICcgKyAocC5pc0ggPyAwIDogY3VycmVudE1vbnRoVHJhbnNsYXRlKSArICclLCAwKScpLmFkZENsYXNzKCdwaWNrZXItY2FsZW5kYXItbW9udGgtY3VycmVudCcpO1xuICAgICAgICAgICAgICAgIHAubW9udGhzLmVxKDIpLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIChwLmlzSCA/IG5leHRNb250aFRyYW5zbGF0ZSA6IDApICsgJyUsICcgKyAocC5pc0ggPyAwIDogbmV4dE1vbnRoVHJhbnNsYXRlKSArICclLCAwKScpLmFkZENsYXNzKCdwaWNrZXItY2FsZW5kYXItbW9udGgtbmV4dCcpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHAubmV4dE1vbnRoID0gZnVuY3Rpb24gKHRyYW5zaXRpb24pIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRyYW5zaXRpb24gPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiB0cmFuc2l0aW9uID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uID0gJyc7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcC5wYXJhbXMuYW5pbWF0ZSkgdHJhbnNpdGlvbiA9IDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBuZXh0TW9udGggPSBwYXJzZUludChwLm1vbnRocy5lcShwLm1vbnRocy5sZW5ndGggLSAxKS5hdHRyKCdkYXRhLW1vbnRoJyksIDEwKTtcbiAgICAgICAgICAgICAgICB2YXIgbmV4dFllYXIgPSBwYXJzZUludChwLm1vbnRocy5lcShwLm1vbnRocy5sZW5ndGggLSAxKS5hdHRyKCdkYXRhLXllYXInKSwgMTApO1xuICAgICAgICAgICAgICAgIHZhciBuZXh0RGF0ZSA9IG5ldyBEYXRlKG5leHRZZWFyLCBuZXh0TW9udGgpO1xuICAgICAgICAgICAgICAgIHZhciBuZXh0RGF0ZVRpbWUgPSBuZXh0RGF0ZS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb25FbmRDYWxsYmFjayA9IHAuYW5pbWF0aW5nID8gZmFsc2UgOiB0cnVlO1xuICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5tYXhEYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChuZXh0RGF0ZVRpbWUgPiBuZXcgRGF0ZShwLnBhcmFtcy5tYXhEYXRlKS5nZXRUaW1lKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBwLnJlc2V0TW9udGgoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwLm1vbnRoc1RyYW5zbGF0ZSAtLTtcbiAgICAgICAgICAgICAgICBpZiAobmV4dE1vbnRoID09PSBwLmN1cnJlbnRNb250aCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dE1vbnRoVHJhbnNsYXRlID0gLShwLm1vbnRoc1RyYW5zbGF0ZSkgKiAxMDAgKiBpbnZlcnRlcjtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5leHRNb250aEhUTUwgPSAkKHAubW9udGhIVE1MKG5leHREYXRlVGltZSwgJ25leHQnKSkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHAuaXNIID8gbmV4dE1vbnRoVHJhbnNsYXRlIDogMCkgKyAnJSwgJyArIChwLmlzSCA/IDAgOiBuZXh0TW9udGhUcmFuc2xhdGUpICsgJyUsIDApJykuYWRkQ2xhc3MoJ3BpY2tlci1jYWxlbmRhci1tb250aC1uZXh0Jyk7XG4gICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci5hcHBlbmQobmV4dE1vbnRoSFRNTFswXSk7XG4gICAgICAgICAgICAgICAgICAgIHAubW9udGhzID0gcC53cmFwcGVyLmZpbmQoJy5waWNrZXItY2FsZW5kYXItbW9udGgnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm9uTW9udGhBZGQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAucGFyYW1zLm9uTW9udGhBZGQocCwgcC5tb250aHMuZXEocC5tb250aHMubGVuZ3RoIC0gMSlbMF0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHAuYW5pbWF0aW5nID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBwLm9uTW9udGhDaGFuZ2VTdGFydCgnbmV4dCcpO1xuICAgICAgICAgICAgICAgIHZhciB0cmFuc2xhdGUgPSAocC5tb250aHNUcmFuc2xhdGUgKiAxMDApICogaW52ZXJ0ZXI7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHAud3JhcHBlci50cmFuc2l0aW9uKHRyYW5zaXRpb24pLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIChwLmlzSCA/IHRyYW5zbGF0ZSA6IDApICsgJyUsICcgKyAocC5pc0ggPyAwIDogdHJhbnNsYXRlKSArICclLCAwKScpO1xuICAgICAgICAgICAgICAgIGlmICh0cmFuc2l0aW9uRW5kQ2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5vbk1vbnRoQ2hhbmdlRW5kKCduZXh0Jyk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIXAucGFyYW1zLmFuaW1hdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcC5vbk1vbnRoQ2hhbmdlRW5kKCduZXh0Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHAucHJldk1vbnRoID0gZnVuY3Rpb24gKHRyYW5zaXRpb24pIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRyYW5zaXRpb24gPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiB0cmFuc2l0aW9uID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgICAgICB0cmFuc2l0aW9uID0gJyc7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcC5wYXJhbXMuYW5pbWF0ZSkgdHJhbnNpdGlvbiA9IDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBwcmV2TW9udGggPSBwYXJzZUludChwLm1vbnRocy5lcSgwKS5hdHRyKCdkYXRhLW1vbnRoJyksIDEwKTtcbiAgICAgICAgICAgICAgICB2YXIgcHJldlllYXIgPSBwYXJzZUludChwLm1vbnRocy5lcSgwKS5hdHRyKCdkYXRhLXllYXInKSwgMTApO1xuICAgICAgICAgICAgICAgIHZhciBwcmV2RGF0ZSA9IG5ldyBEYXRlKHByZXZZZWFyLCBwcmV2TW9udGggKyAxLCAtMSk7XG4gICAgICAgICAgICAgICAgdmFyIHByZXZEYXRlVGltZSA9IHByZXZEYXRlLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICB2YXIgdHJhbnNpdGlvbkVuZENhbGxiYWNrID0gcC5hbmltYXRpbmcgPyBmYWxzZSA6IHRydWU7XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm1pbkRhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZEYXRlVGltZSA8IG5ldyBEYXRlKHAucGFyYW1zLm1pbkRhdGUpLmdldFRpbWUoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAucmVzZXRNb250aCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHAubW9udGhzVHJhbnNsYXRlICsrO1xuICAgICAgICAgICAgICAgIGlmIChwcmV2TW9udGggPT09IHAuY3VycmVudE1vbnRoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwcmV2TW9udGhUcmFuc2xhdGUgPSAtKHAubW9udGhzVHJhbnNsYXRlKSAqIDEwMCAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgICAgICB2YXIgcHJldk1vbnRoSFRNTCA9ICQocC5tb250aEhUTUwocHJldkRhdGVUaW1lLCAncHJldicpKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAocC5pc0ggPyBwcmV2TW9udGhUcmFuc2xhdGUgOiAwKSArICclLCAnICsgKHAuaXNIID8gMCA6IHByZXZNb250aFRyYW5zbGF0ZSkgKyAnJSwgMCknKS5hZGRDbGFzcygncGlja2VyLWNhbGVuZGFyLW1vbnRoLXByZXYnKTtcbiAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLnByZXBlbmQocHJldk1vbnRoSFRNTFswXSk7XG4gICAgICAgICAgICAgICAgICAgIHAubW9udGhzID0gcC53cmFwcGVyLmZpbmQoJy5waWNrZXItY2FsZW5kYXItbW9udGgnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm9uTW9udGhBZGQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAucGFyYW1zLm9uTW9udGhBZGQocCwgcC5tb250aHMuZXEoMClbMF0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHAuYW5pbWF0aW5nID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBwLm9uTW9udGhDaGFuZ2VTdGFydCgncHJldicpO1xuICAgICAgICAgICAgICAgIHZhciB0cmFuc2xhdGUgPSAocC5tb250aHNUcmFuc2xhdGUgKiAxMDApICogaW52ZXJ0ZXI7XG4gICAgICAgICAgICAgICAgcC53cmFwcGVyLnRyYW5zaXRpb24odHJhbnNpdGlvbikudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHAuaXNIID8gdHJhbnNsYXRlIDogMCkgKyAnJSwgJyArIChwLmlzSCA/IDAgOiB0cmFuc2xhdGUpICsgJyUsIDApJyk7XG4gICAgICAgICAgICAgICAgaWYgKHRyYW5zaXRpb25FbmRDYWxsYmFjaykge1xuICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLm9uTW9udGhDaGFuZ2VFbmQoJ3ByZXYnKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghcC5wYXJhbXMuYW5pbWF0ZSkge1xuICAgICAgICAgICAgICAgICAgICBwLm9uTW9udGhDaGFuZ2VFbmQoJ3ByZXYnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcC5yZXNldE1vbnRoID0gZnVuY3Rpb24gKHRyYW5zaXRpb24pIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRyYW5zaXRpb24gPT09ICd1bmRlZmluZWQnKSB0cmFuc2l0aW9uID0gJyc7XG4gICAgICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZSA9IChwLm1vbnRoc1RyYW5zbGF0ZSAqIDEwMCkgKiBpbnZlcnRlcjtcbiAgICAgICAgICAgICAgICBwLndyYXBwZXIudHJhbnNpdGlvbih0cmFuc2l0aW9uKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAocC5pc0ggPyB0cmFuc2xhdGUgOiAwKSArICclLCAnICsgKHAuaXNIID8gMCA6IHRyYW5zbGF0ZSkgKyAnJSwgMCknKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwLnNldFllYXJNb250aCA9IGZ1bmN0aW9uICh5ZWFyLCBtb250aCwgdHJhbnNpdGlvbikge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgeWVhciA9PT0gJ3VuZGVmaW5lZCcpIHllYXIgPSBwLmN1cnJlbnRZZWFyO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbW9udGggPT09ICd1bmRlZmluZWQnKSBtb250aCA9IHAuY3VycmVudE1vbnRoO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHJhbnNpdGlvbiA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIHRyYW5zaXRpb24gPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb24gPSAnJztcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLnBhcmFtcy5hbmltYXRlKSB0cmFuc2l0aW9uID0gMDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHRhcmdldERhdGU7XG4gICAgICAgICAgICAgICAgaWYgKHllYXIgPCBwLmN1cnJlbnRZZWFyKSB7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldERhdGUgPSBuZXcgRGF0ZSh5ZWFyLCBtb250aCArIDEsIC0xKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXREYXRlID0gbmV3IERhdGUoeWVhciwgbW9udGgpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm1heERhdGUgJiYgdGFyZ2V0RGF0ZSA+IG5ldyBEYXRlKHAucGFyYW1zLm1heERhdGUpLmdldFRpbWUoKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5taW5EYXRlICYmIHRhcmdldERhdGUgPCBuZXcgRGF0ZShwLnBhcmFtcy5taW5EYXRlKS5nZXRUaW1lKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgY3VycmVudERhdGUgPSBuZXcgRGF0ZShwLmN1cnJlbnRZZWFyLCBwLmN1cnJlbnRNb250aCkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgIHZhciBkaXIgPSB0YXJnZXREYXRlID4gY3VycmVudERhdGUgPyAnbmV4dCcgOiAncHJldic7XG4gICAgICAgICAgICAgICAgdmFyIG5ld01vbnRoSFRNTCA9IHAubW9udGhIVE1MKG5ldyBEYXRlKHllYXIsIG1vbnRoKSk7XG4gICAgICAgICAgICAgICAgcC5tb250aHNUcmFuc2xhdGUgPSBwLm1vbnRoc1RyYW5zbGF0ZSB8fCAwO1xuICAgICAgICAgICAgICAgIHZhciBwcmV2VHJhbnNsYXRlID0gcC5tb250aHNUcmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgdmFyIG1vbnRoVHJhbnNsYXRlLCB3cmFwcGVyVHJhbnNsYXRlO1xuICAgICAgICAgICAgICAgIHZhciB0cmFuc2l0aW9uRW5kQ2FsbGJhY2sgPSBwLmFuaW1hdGluZyA/IGZhbHNlIDogdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0RGF0ZSA+IGN1cnJlbnREYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFRvIG5leHRcbiAgICAgICAgICAgICAgICAgICAgcC5tb250aHNUcmFuc2xhdGUgLS07XG4gICAgICAgICAgICAgICAgICAgIGlmICghcC5hbmltYXRpbmcpIHAubW9udGhzLmVxKHAubW9udGhzLmxlbmd0aCAtIDEpLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIuYXBwZW5kKG5ld01vbnRoSFRNTCk7XG4gICAgICAgICAgICAgICAgICAgIHAubW9udGhzID0gcC53cmFwcGVyLmZpbmQoJy5waWNrZXItY2FsZW5kYXItbW9udGgnKTtcbiAgICAgICAgICAgICAgICAgICAgbW9udGhUcmFuc2xhdGUgPSAtKHByZXZUcmFuc2xhdGUgLSAxKSAqIDEwMCAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgICAgICBwLm1vbnRocy5lcShwLm1vbnRocy5sZW5ndGggLSAxKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAocC5pc0ggPyBtb250aFRyYW5zbGF0ZSA6IDApICsgJyUsICcgKyAocC5pc0ggPyAwIDogbW9udGhUcmFuc2xhdGUpICsgJyUsIDApJykuYWRkQ2xhc3MoJ3BpY2tlci1jYWxlbmRhci1tb250aC1uZXh0Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBUbyBwcmV2XG4gICAgICAgICAgICAgICAgICAgIHAubW9udGhzVHJhbnNsYXRlICsrO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXAuYW5pbWF0aW5nKSBwLm1vbnRocy5lcSgwKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLnByZXBlbmQobmV3TW9udGhIVE1MKTtcbiAgICAgICAgICAgICAgICAgICAgcC5tb250aHMgPSBwLndyYXBwZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1tb250aCcpO1xuICAgICAgICAgICAgICAgICAgICBtb250aFRyYW5zbGF0ZSA9IC0ocHJldlRyYW5zbGF0ZSArIDEpICogMTAwICogaW52ZXJ0ZXI7XG4gICAgICAgICAgICAgICAgICAgIHAubW9udGhzLmVxKDApLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIChwLmlzSCA/IG1vbnRoVHJhbnNsYXRlIDogMCkgKyAnJSwgJyArIChwLmlzSCA/IDAgOiBtb250aFRyYW5zbGF0ZSkgKyAnJSwgMCknKS5hZGRDbGFzcygncGlja2VyLWNhbGVuZGFyLW1vbnRoLXByZXYnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm9uTW9udGhBZGQpIHtcbiAgICAgICAgICAgICAgICAgICAgcC5wYXJhbXMub25Nb250aEFkZChwLCBkaXIgPT09ICduZXh0JyA/IHAubW9udGhzLmVxKHAubW9udGhzLmxlbmd0aCAtIDEpWzBdIDogcC5tb250aHMuZXEoMClbMF0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwLmFuaW1hdGluZyA9IHRydWU7XG4gICAgICAgICAgICAgICAgcC5vbk1vbnRoQ2hhbmdlU3RhcnQoZGlyKTtcbiAgICAgICAgICAgICAgICB3cmFwcGVyVHJhbnNsYXRlID0gKHAubW9udGhzVHJhbnNsYXRlICogMTAwKSAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgIHAud3JhcHBlci50cmFuc2l0aW9uKHRyYW5zaXRpb24pLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIChwLmlzSCA/IHdyYXBwZXJUcmFuc2xhdGUgOiAwKSArICclLCAnICsgKHAuaXNIID8gMCA6IHdyYXBwZXJUcmFuc2xhdGUpICsgJyUsIDApJyk7XG4gICAgICAgICAgICAgICAgaWYgKHRyYW5zaXRpb25FbmRDYWxsYmFjaykge1xuICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAub25Nb250aENoYW5nZUVuZChkaXIsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFwLnBhcmFtcy5hbmltYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIHAub25Nb250aENoYW5nZUVuZChkaXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwLm5leHRZZWFyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHAuc2V0WWVhck1vbnRoKHAuY3VycmVudFllYXIgKyAxKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwLnByZXZZZWFyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHAuc2V0WWVhck1vbnRoKHAuY3VycmVudFllYXIgLSAxKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgIC8vIEhUTUwgTGF5b3V0XG4gICAgICAgICAgICBwLmxheW91dCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgcGlja2VySFRNTCA9ICcnO1xuICAgICAgICAgICAgICAgIHZhciBwaWNrZXJDbGFzcyA9ICcnO1xuICAgICAgICAgICAgICAgIHZhciBpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgbGF5b3V0RGF0ZSA9IHAudmFsdWUgJiYgcC52YWx1ZS5sZW5ndGggPyBwLnZhbHVlWzBdIDogbmV3IERhdGUoKS5zZXRIb3VycygwLDAsMCwwKTtcbiAgICAgICAgICAgICAgICB2YXIgcHJldk1vbnRoSFRNTCA9IHAubW9udGhIVE1MKGxheW91dERhdGUsICdwcmV2Jyk7XG4gICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRNb250aEhUTUwgPSBwLm1vbnRoSFRNTChsYXlvdXREYXRlKTtcbiAgICAgICAgICAgICAgICB2YXIgbmV4dE1vbnRoSFRNTCA9IHAubW9udGhIVE1MKGxheW91dERhdGUsICduZXh0Jyk7XG4gICAgICAgICAgICAgICAgdmFyIG1vbnRoc0hUTUwgPSAnPGRpdiBjbGFzcz1cInBpY2tlci1jYWxlbmRhci1tb250aHNcIj48ZGl2IGNsYXNzPVwicGlja2VyLWNhbGVuZGFyLW1vbnRocy13cmFwcGVyXCI+JyArIChwcmV2TW9udGhIVE1MICsgY3VycmVudE1vbnRoSFRNTCArIG5leHRNb250aEhUTUwpICsgJzwvZGl2PjwvZGl2Pic7XG4gICAgICAgICAgICAgICAgLy8gV2VlayBkYXlzIGhlYWRlclxuICAgICAgICAgICAgICAgIHZhciB3ZWVrSGVhZGVySFRNTCA9ICcnO1xuICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy53ZWVrSGVhZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCA3OyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3ZWVrRGF5SW5kZXggPSAoaSArIHAucGFyYW1zLmZpcnN0RGF5ID4gNikgPyAoaSAtIDcgKyBwLnBhcmFtcy5maXJzdERheSkgOiAoaSArIHAucGFyYW1zLmZpcnN0RGF5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkYXlOYW1lID0gcC5wYXJhbXMuZGF5TmFtZXNTaG9ydFt3ZWVrRGF5SW5kZXhdO1xuICAgICAgICAgICAgICAgICAgICAgICAgd2Vla0hlYWRlckhUTUwgKz0gJzxkaXYgY2xhc3M9XCJwaWNrZXItY2FsZW5kYXItd2Vlay1kYXkgJyArICgocC5wYXJhbXMud2Vla2VuZERheXMuaW5kZXhPZih3ZWVrRGF5SW5kZXgpID49IDApID8gJ3BpY2tlci1jYWxlbmRhci13ZWVrLWRheS13ZWVrZW5kJyA6ICcnKSArICdcIj4gJyArIGRheU5hbWUgKyAnPC9kaXY+JztcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgd2Vla0hlYWRlckhUTUwgPSAnPGRpdiBjbGFzcz1cInBpY2tlci1jYWxlbmRhci13ZWVrLWRheXNcIj4nICsgd2Vla0hlYWRlckhUTUwgKyAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcGlja2VyQ2xhc3MgPSAncGlja2VyLW1vZGFsIHBpY2tlci1jYWxlbmRhcicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIChwLnBhcmFtcy5yYW5nZVBpY2tlciA/ICcgcGlja2VyLWNhbGVuZGFyLXJhbmdlJyA6ICcnKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKHAucGFyYW1zLmNzc0NsYXNzID8gJyAnICsgcC5wYXJhbXMuY3NzQ2xhc3MgOiAnJyk7XG4gICAgICAgICAgICAgICAgdmFyIHRvb2xiYXJIVE1MID0gcC5wYXJhbXMudG9vbGJhciA/IHAucGFyYW1zLnRvb2xiYXJUZW1wbGF0ZS5yZXBsYWNlKC97e2Nsb3NlVGV4dH19L2csIHAucGFyYW1zLnRvb2xiYXJDbG9zZVRleHQpIDogJyc7XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLnRvb2xiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdG9vbGJhckhUTUwgPSBwLnBhcmFtcy50b29sYmFyVGVtcGxhdGVcbiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC97e2Nsb3NlVGV4dH19L2csIHAucGFyYW1zLnRvb2xiYXJDbG9zZVRleHQpXG4gICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgve3ttb250aFBpY2tlcn19L2csIChwLnBhcmFtcy5tb250aFBpY2tlciA/IHAucGFyYW1zLm1vbnRoUGlja2VyVGVtcGxhdGUgOiAnJykpXG4gICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgve3t5ZWFyUGlja2VyfX0vZywgKHAucGFyYW1zLnllYXJQaWNrZXIgPyBwLnBhcmFtcy55ZWFyUGlja2VyVGVtcGxhdGUgOiAnJykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgaGVhZGVySFRNTCA9IHAucGFyYW1zLmhlYWRlciA/IHAucGFyYW1zLmhlYWRlclRlbXBsYXRlLnJlcGxhY2UoL3t7Y2xvc2VUZXh0fX0vZywgcC5wYXJhbXMudG9vbGJhckNsb3NlVGV4dCkucmVwbGFjZSgve3twbGFjZWhvbGRlcn19L2csIHAucGFyYW1zLmhlYWRlclBsYWNlaG9sZGVyKSA6ICcnO1xuICAgICAgICAgICAgICAgIHZhciBmb290ZXJIVE1MID0gcC5wYXJhbXMuZm9vdGVyID8gcC5wYXJhbXMuZm9vdGVyVGVtcGxhdGUucmVwbGFjZSgve3tjbG9zZVRleHR9fS9nLCBwLnBhcmFtcy50b29sYmFyQ2xvc2VUZXh0KSA6ICcnO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBwaWNrZXJIVE1MID1cbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCInICsgKHBpY2tlckNsYXNzKSArICdcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlckhUTUwgK1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9vdGVySFRNTCArXG4gICAgICAgICAgICAgICAgICAgICAgICB0b29sYmFySFRNTCArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBpY2tlci1tb2RhbC1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdlZWtIZWFkZXJIVE1MICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb250aHNIVE1MICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2Pic7XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgICAgICBwLnBpY2tlckhUTUwgPSBwaWNrZXJIVE1MO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbnB1dCBFdmVudHNcbiAgICAgICAgICAgIGZ1bmN0aW9uIG9wZW5PbklucHV0KGUpIHtcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgaWYgKHAub3BlbmVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgcC5vcGVuKCk7XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLnNjcm9sbFRvSW5wdXQgJiYgIWlzUG9wb3ZlcigpICYmICFhcHAucGFyYW1zLm1hdGVyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwYWdlQ29udGVudCA9IHAuaW5wdXQucGFyZW50cygnLnBhZ2UtY29udGVudCcpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFnZUNvbnRlbnQubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB2YXIgcGFkZGluZ1RvcCA9IHBhcnNlSW50KHBhZ2VDb250ZW50LmNzcygncGFkZGluZy10b3AnKSwgMTApLFxuICAgICAgICAgICAgICAgICAgICAgICAgcGFkZGluZ0JvdHRvbSA9IHBhcnNlSW50KHBhZ2VDb250ZW50LmNzcygncGFkZGluZy1ib3R0b20nKSwgMTApLFxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUhlaWdodCA9IHBhZ2VDb250ZW50WzBdLm9mZnNldEhlaWdodCAtIHBhZGRpbmdUb3AgLSBwLmNvbnRhaW5lci5oZWlnaHQoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VTY3JvbGxIZWlnaHQgPSBwYWdlQ29udGVudFswXS5zY3JvbGxIZWlnaHQgLSBwYWRkaW5nVG9wIC0gcC5jb250YWluZXIuaGVpZ2h0KCksXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdQYWRkaW5nQm90dG9tO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlucHV0VG9wID0gcC5pbnB1dC5vZmZzZXQoKS50b3AgLSBwYWRkaW5nVG9wICsgcC5pbnB1dFswXS5vZmZzZXRIZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dFRvcCA+IHBhZ2VIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzY3JvbGxUb3AgPSBwYWdlQ29udGVudC5zY3JvbGxUb3AoKSArIGlucHV0VG9wIC0gcGFnZUhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzY3JvbGxUb3AgKyBwYWdlSGVpZ2h0ID4gcGFnZVNjcm9sbEhlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhZGRpbmdCb3R0b20gPSBzY3JvbGxUb3AgKyBwYWdlSGVpZ2h0IC0gcGFnZVNjcm9sbEhlaWdodCArIHBhZGRpbmdCb3R0b207XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2VIZWlnaHQgPT09IHBhZ2VTY3JvbGxIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGFkZGluZ0JvdHRvbSA9IHAuY29udGFpbmVyLmhlaWdodCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudC5jc3MoeydwYWRkaW5nLWJvdHRvbSc6IChuZXdQYWRkaW5nQm90dG9tKSArICdweCd9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50LnNjcm9sbFRvcChzY3JvbGxUb3AsIDMwMCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBjbG9zZU9uSFRNTENsaWNrKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoaW5Qb3BvdmVyKCkpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAocC5pbnB1dCAmJiBwLmlucHV0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGUudGFyZ2V0ICE9PSBwLmlucHV0WzBdICYmICQoZS50YXJnZXQpLnBhcmVudHMoJy5waWNrZXItbW9kYWwnKS5sZW5ndGggPT09IDApIHAuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgkKGUudGFyZ2V0KS5wYXJlbnRzKCcucGlja2VyLW1vZGFsJykubGVuZ3RoID09PSAwKSBwLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmIChwLnBhcmFtcy5pbnB1dCkge1xuICAgICAgICAgICAgICAgIHAuaW5wdXQgPSAkKHAucGFyYW1zLmlucHV0KTtcbiAgICAgICAgICAgICAgICBpZiAocC5pbnB1dC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5pbnB1dFJlYWRPbmx5KSBwLmlucHV0LnByb3AoJ3JlYWRPbmx5JywgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcC5pbmxpbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuaW5wdXQub24oJ2NsaWNrJywgb3Blbk9uSW5wdXQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5pbnB1dFJlYWRPbmx5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLmlucHV0Lm9uKCdmb2N1cyBtb3VzZWRvd24nLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoIXAuaW5saW5lICYmIHAucGFyYW1zLmNsb3NlQnlPdXRzaWRlQ2xpY2spICQoJ2h0bWwnKS5vbignY2xpY2snLCBjbG9zZU9uSFRNTENsaWNrKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBPcGVuXG4gICAgICAgICAgICBmdW5jdGlvbiBvblBpY2tlckNsb3NlKCkge1xuICAgICAgICAgICAgICAgIHAub3BlbmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKHAuaW5wdXQgJiYgcC5pbnB1dC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHAuaW5wdXQucGFyZW50cygnLnBhZ2UtY29udGVudCcpLmNzcyh7J3BhZGRpbmctYm90dG9tJzogJyd9KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwpIHAuaW5wdXQudHJpZ2dlcignYmx1cicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMub25DbG9zZSkgcC5wYXJhbXMub25DbG9zZShwKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gRGVzdHJveSBldmVudHNcbiAgICAgICAgICAgICAgICBwLmRlc3Ryb3lDYWxlbmRhckV2ZW50cygpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIHAub3BlbmVkID0gZmFsc2U7XG4gICAgICAgICAgICBwLm9wZW4gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRvUG9wb3ZlciA9IGlzUG9wb3ZlcigpO1xuICAgICAgICAgICAgICAgIHZhciB1cGRhdGVWYWx1ZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmICghcC5vcGVuZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gU2V0IGRhdGUgdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMudmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwLnZhbHVlID0gcC5wYXJhbXMudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlVmFsdWUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBMYXlvdXRcbiAgICAgICAgICAgICAgICAgICAgcC5sYXlvdXQoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIEFwcGVuZFxuICAgICAgICAgICAgICAgICAgICBpZiAodG9Qb3BvdmVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLnBpY2tlckhUTUwgPSAnPGRpdiBjbGFzcz1cInBvcG92ZXIgcG9wb3Zlci1waWNrZXItY2FsZW5kYXJcIj48ZGl2IGNsYXNzPVwicG9wb3Zlci1pbm5lclwiPicgKyBwLnBpY2tlckhUTUwgKyAnPC9kaXY+PC9kaXY+JztcbiAgICAgICAgICAgICAgICAgICAgICAgIHAucG9wb3ZlciA9IGFwcC5wb3BvdmVyKHAucGlja2VySFRNTCwgcC5wYXJhbXMuaW5wdXQsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXIgPSAkKHAucG9wb3ZlcikuZmluZCgnLnBpY2tlci1tb2RhbCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJChwLnBvcG92ZXIpLm9uKCdjbG9zZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblBpY2tlckNsb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChwLmlubGluZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXIgPSAkKHAucGlja2VySFRNTCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLmNvbnRhaW5lci5hZGRDbGFzcygncGlja2VyLW1vZGFsLWlubGluZScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJChwLnBhcmFtcy5jb250YWluZXIpLmFwcGVuZChwLmNvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLmNvbnRhaW5lciA9ICQoYXBwLnBpY2tlck1vZGFsKHAucGlja2VySFRNTCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJChwLmNvbnRhaW5lcilcbiAgICAgICAgICAgICAgICAgICAgICAgIC5vbignY2xvc2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25QaWNrZXJDbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIFN0b3JlIGNhbGVuZGFyIGluc3RhbmNlXG4gICAgICAgICAgICAgICAgICAgIHAuY29udGFpbmVyWzBdLmY3Q2FsZW5kYXIgPSBwO1xuICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIgPSBwLmNvbnRhaW5lci5maW5kKCcucGlja2VyLWNhbGVuZGFyLW1vbnRocy13cmFwcGVyJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBNb250aHNcbiAgICAgICAgICAgICAgICAgICAgcC5tb250aHMgPSBwLndyYXBwZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1tb250aCcpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIGN1cnJlbnQgbW9udGggYW5kIHllYXJcbiAgICAgICAgICAgICAgICAgICAgcC51cGRhdGVDdXJyZW50TW9udGhZZWFyKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBTZXQgaW5pdGlhbCB0cmFuc2xhdGVcbiAgICAgICAgICAgICAgICAgICAgcC5tb250aHNUcmFuc2xhdGUgPSAwO1xuICAgICAgICAgICAgICAgICAgICBwLnNldE1vbnRoc1RyYW5zbGF0ZSgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gSW5pdCBldmVudHNcbiAgICAgICAgICAgICAgICAgICAgcC5pbml0Q2FsZW5kYXJFdmVudHMoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBpbnB1dCB2YWx1ZVxuICAgICAgICAgICAgICAgICAgICBpZiAodXBkYXRlVmFsdWUpIHAudXBkYXRlVmFsdWUoKTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBwLnZhbHVlKSBwLnVwZGF0ZVZhbHVlKHRydWUpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gTWF0ZXJpYWwgRm9jdXNcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaW5wdXQgJiYgcC5pbnB1dC5sZW5ndGggPiAwICYmIGFwcC5wYXJhbXMubWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuaW5wdXQudHJpZ2dlcignZm9jdXMnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFNldCBmbGFnXG4gICAgICAgICAgICAgICAgcC5vcGVuZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHAuaW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5vbk1vbnRoQWRkKSB7XG4gICAgICAgICAgICAgICAgICAgIHAubW9udGhzLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5wYXJhbXMub25Nb250aEFkZChwLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5vbk9wZW4pIHAucGFyYW1zLm9uT3BlbihwKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ2xvc2VcbiAgICAgICAgICAgIHAuY2xvc2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFwLm9wZW5lZCB8fCBwLmlubGluZSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmIChpblBvcG92ZXIoKSkge1xuICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbChwLnBvcG92ZXIpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbChwLmNvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIERlc3Ryb3lcbiAgICAgICAgICAgIHAuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBwLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLmlucHV0ICYmIHAuaW5wdXQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBwLmlucHV0Lm9mZignY2xpY2sgZm9jdXMnLCBvcGVuT25JbnB1dCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICQoJ2h0bWwnKS5vZmYoJ2NsaWNrJywgY2xvc2VPbkhUTUxDbGljayk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChwLmlubGluZSkge1xuICAgICAgICAgICAgICAgIHAub3BlbigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKCFwLmluaXRpYWxpemVkICYmIHAucGFyYW1zLnZhbHVlKSBwLnNldFZhbHVlKHAucGFyYW1zLnZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gcDtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmNhbGVuZGFyID0gZnVuY3Rpb24gKHBhcmFtcykge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBDYWxlbmRhcihwYXJhbXMpO1xuICAgICAgICB9O1xuICAgICAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBOb3RpZmljYXRpb25zICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHZhciBfdGVtcE5vdGlmaWNhdGlvbkVsZW1lbnQ7XG4gICAgICAgIGFwcC5hZGROb3RpZmljYXRpb24gPSBmdW5jdGlvbiAocGFyYW1zKSB7XG4gICAgICAgICAgICBpZiAoIXBhcmFtcykgcmV0dXJuO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtcy5tZWRpYSA9PT0gJ3VuZGVmaW5lZCcpIHBhcmFtcy5tZWRpYSA9IGFwcC5wYXJhbXMubm90aWZpY2F0aW9uTWVkaWE7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtcy50aXRsZSA9PT0gJ3VuZGVmaW5lZCcpIHBhcmFtcy50aXRsZSA9IGFwcC5wYXJhbXMubm90aWZpY2F0aW9uVGl0bGU7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtcy5zdWJ0aXRsZSA9PT0gJ3VuZGVmaW5lZCcpIHBhcmFtcy5zdWJ0aXRsZSA9IGFwcC5wYXJhbXMubm90aWZpY2F0aW9uU3VidGl0bGU7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtcy5jbG9zZUljb24gPT09ICd1bmRlZmluZWQnKSBwYXJhbXMuY2xvc2VJY29uID0gYXBwLnBhcmFtcy5ub3RpZmljYXRpb25DbG9zZUljb247XG4gICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtcy5ob2xkID09PSAndW5kZWZpbmVkJykgcGFyYW1zLmhvbGQgPSBhcHAucGFyYW1zLm5vdGlmaWNhdGlvbkhvbGQ7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtcy5jbG9zZU9uQ2xpY2sgPT09ICd1bmRlZmluZWQnKSBwYXJhbXMuY2xvc2VPbkNsaWNrID0gYXBwLnBhcmFtcy5ub3RpZmljYXRpb25DbG9zZU9uQ2xpY2s7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtcy5idXR0b24gPT09ICd1bmRlZmluZWQnKSBwYXJhbXMuYnV0dG9uID0gYXBwLnBhcmFtcy5ub3RpZmljYXRpb25DbG9zZUJ1dHRvblRleHQgJiYge1xuICAgICAgICAgICAgICAgIHRleHQ6IGFwcC5wYXJhbXMubm90aWZpY2F0aW9uQ2xvc2VCdXR0b25UZXh0LFxuICAgICAgICAgICAgICAgIGNsb3NlOiB0cnVlXG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIGlmICghX3RlbXBOb3RpZmljYXRpb25FbGVtZW50KSBfdGVtcE5vdGlmaWNhdGlvbkVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgXG4gICAgICAgICAgICBwYXJhbXMubWF0ZXJpYWwgPSBhcHAucGFyYW1zLm1hdGVyaWFsO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSAkKCcubm90aWZpY2F0aW9ucycpO1xuICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKCc8ZGl2IGNsYXNzPVwibm90aWZpY2F0aW9ucyBsaXN0LWJsb2NrJyArIChwYXJhbXMubWF0ZXJpYWwgPyAnJyA6ICcgbWVkaWEtbGlzdCcpICsgJ1wiPjx1bD48L3VsPjwvZGl2PicpO1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lciA9ICQoJy5ub3RpZmljYXRpb25zJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgbGlzdCA9IGNvbnRhaW5lci5jaGlsZHJlbigndWwnKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdmFyIG5vdGlmaWNhdGlvblRlbXBsYXRlID0gYXBwLnBhcmFtcy5ub3RpZmljYXRpb25UZW1wbGF0ZSB8fCBcbiAgICAgICAgICAgICAgICAne3sjaWYgY3VzdG9tfX0nICtcbiAgICAgICAgICAgICAgICAnPGxpPnt7Y3VzdG9tfX08L2xpPicgK1xuICAgICAgICAgICAgICAgICd7e2Vsc2V9fScgK1xuICAgICAgICAgICAgICAgICc8bGkgY2xhc3M9XCJub3RpZmljYXRpb24taXRlbSBub3RpZmljYXRpb24taGlkZGVuXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1jb250ZW50XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgbWF0ZXJpYWx9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tdGl0bGVcIj57e2pzIFwidGhpcy5tZXNzYWdlIHx8IHRoaXMudGl0bGUgfHwgdGhpcy5zdWJ0aXRsZVwifX08L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIC4uL2J1dHRvbn19e3sjYnV0dG9ufX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLWFmdGVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGEgaHJlZj1cIiNcIiBjbGFzcz1cImJ1dHRvbiB7eyNpZiBjb2xvcn19Y29sb3Ite3tjb2xvcn19e3svaWZ9fSB7eyNqc19jb21wYXJlIFwidGhpcy5jbG9zZSAhPT0gZmFsc2VcIn19Y2xvc2Utbm90aWZpY2F0aW9ue3svanNfY29tcGFyZX19XCI+e3t0ZXh0fX08L2E+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2J1dHRvbn19e3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICd7e2Vsc2V9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBtZWRpYX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLW1lZGlhXCI+e3ttZWRpYX19PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0taW5uZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLXRpdGxlLXJvd1wiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIHRpdGxlfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS10aXRsZVwiPnt7dGl0bGV9fTwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBjbG9zZUljb259fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLWFmdGVyXCI+PGEgaHJlZj1cIiNcIiBjbGFzcz1cImNsb3NlLW5vdGlmaWNhdGlvblwiPjxzcGFuPjwvc3Bhbj48L2E+PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBzdWJ0aXRsZX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1zdWJ0aXRsZVwiPnt7c3VidGl0bGV9fTwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgbWVzc2FnZX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS10ZXh0XCI+e3ttZXNzYWdlfX08L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgJzwvbGk+JyArXG4gICAgICAgICAgICAgICAgJ3t7L2lmfX0nO1xuICAgICAgICAgICAgaWYgKCFhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLm5vdGlmaWNhdGlvbikge1xuICAgICAgICAgICAgICAgIGFwcC5fY29tcGlsZWRUZW1wbGF0ZXMubm90aWZpY2F0aW9uID0gdDcuY29tcGlsZShub3RpZmljYXRpb25UZW1wbGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBfdGVtcE5vdGlmaWNhdGlvbkVsZW1lbnQuaW5uZXJIVE1MID0gYXBwLl9jb21waWxlZFRlbXBsYXRlcy5ub3RpZmljYXRpb24ocGFyYW1zKTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgaXRlbSA9ICQoX3RlbXBOb3RpZmljYXRpb25FbGVtZW50KS5jaGlsZHJlbigpO1xuICAgICAgICBcbiAgICAgICAgICAgIGl0ZW0ub24oJ2NsaWNrJywgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgY2xvc2UgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gJChlLnRhcmdldCk7XG4gICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5tYXRlcmlhbCAmJiB0YXJnZXQuaGFzQ2xhc3MoJ2J1dHRvbicpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbXMuYnV0dG9uICYmIHBhcmFtcy5idXR0b24ub25DbGljaykgcGFyYW1zLmJ1dHRvbi5vbkNsaWNrLmNhbGwodGFyZ2V0WzBdLCBlLCBpdGVtWzBdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldC5pcygnLmNsb3NlLW5vdGlmaWNhdGlvbicpIHx8ICQoZS50YXJnZXQpLnBhcmVudHMoJy5jbG9zZS1ub3RpZmljYXRpb24nKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsb3NlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbXMub25DbGljaykgcGFyYW1zLm9uQ2xpY2soZSwgaXRlbVswXSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbXMuY2xvc2VPbkNsaWNrKSBjbG9zZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjbG9zZSkgYXBwLmNsb3NlTm90aWZpY2F0aW9uKGl0ZW1bMF0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAocGFyYW1zLm9uQ2xvc2UpIHtcbiAgICAgICAgICAgICAgICBpdGVtLmRhdGEoJ2Y3Tm90aWZpY2F0aW9uT25DbG9zZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLm9uQ2xvc2UoaXRlbVswXSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocGFyYW1zLmFkZGl0aW9uYWxDbGFzcykge1xuICAgICAgICAgICAgICAgIGl0ZW0uYWRkQ2xhc3MocGFyYW1zLmFkZGl0aW9uYWxDbGFzcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocGFyYW1zLmhvbGQpIHtcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0ubGVuZ3RoID4gMCkgYXBwLmNsb3NlTm90aWZpY2F0aW9uKGl0ZW1bMF0pO1xuICAgICAgICAgICAgICAgIH0sIHBhcmFtcy5ob2xkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBsaXN0W3BhcmFtcy5tYXRlcmlhbCA/ICdhcHBlbmQnIDogJ3ByZXBlbmQnXShpdGVtWzBdKTtcbiAgICAgICAgICAgIGNvbnRhaW5lci5zaG93KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIGl0ZW1IZWlnaHQgPSBpdGVtLm91dGVySGVpZ2h0KCksIGNsaWVudExlZnQ7XG4gICAgICAgICAgICBpZiAocGFyYW1zLm1hdGVyaWFsKSB7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwgJytpdGVtSGVpZ2h0KydweCwgMCknKTtcbiAgICAgICAgICAgICAgICBjb250YWluZXIudHJhbnNpdGlvbigwKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgY2xpZW50TGVmdCA9IGl0ZW1bMF0uY2xpZW50TGVmdDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgY29udGFpbmVyLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwgMCwgMCknKTtcbiAgICAgICAgICAgICAgICBjb250YWluZXIudHJhbnNpdGlvbignJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpdGVtLmNzcygnbWFyZ2luVG9wJywgLWl0ZW1IZWlnaHQgKyAncHgnKTtcbiAgICAgICAgICAgICAgICBpdGVtLnRyYW5zaXRpb24oMCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGNsaWVudExlZnQgPSBpdGVtWzBdLmNsaWVudExlZnQ7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGl0ZW0udHJhbnNpdGlvbignJyk7XG4gICAgICAgICAgICAgICAgaXRlbS5jc3MoJ21hcmdpblRvcCcsICcwcHgnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBjb250YWluZXIudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLCAwLDApJyk7XG4gICAgICAgICAgICBpdGVtLnJlbW92ZUNsYXNzKCdub3RpZmljYXRpb24taGlkZGVuJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGl0ZW1bMF07XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5jbG9zZU5vdGlmaWNhdGlvbiA9IGZ1bmN0aW9uIChpdGVtKSB7XG4gICAgICAgICAgICBpdGVtID0gJChpdGVtKTtcbiAgICAgICAgICAgIGlmIChpdGVtLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKGl0ZW0uaGFzQ2xhc3MoJ25vdGlmaWNhdGlvbi1pdGVtLXJlbW92aW5nJykpIHJldHVybjtcbiAgICAgICAgICAgIHZhciBjb250YWluZXIgPSAkKCcubm90aWZpY2F0aW9ucycpO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBpdGVtSGVpZ2h0ID0gaXRlbS5vdXRlckhlaWdodCgpO1xuICAgICAgICAgICAgaXRlbS5jc3MoJ2hlaWdodCcsIGl0ZW1IZWlnaHQgKyAncHgnKS50cmFuc2l0aW9uKDApLmFkZENsYXNzKCdub3RpZmljYXRpb24taXRlbS1yZW1vdmluZycpO1xuICAgICAgICAgICAgdmFyIGNsaWVudExlZnQgPSBpdGVtWzBdLmNsaWVudExlZnQ7XG4gICAgICAgIFxuICAgICAgICAgICAgaXRlbS5jc3MoJ2hlaWdodCcsICcwcHgnKS50cmFuc2l0aW9uKCcnKTtcbiAgICAgICAgICAgIGlmIChpdGVtLmRhdGEoJ2Y3Tm90aWZpY2F0aW9uT25DbG9zZScpKSBpdGVtLmRhdGEoJ2Y3Tm90aWZpY2F0aW9uT25DbG9zZScpKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5maW5kKCcubm90aWZpY2F0aW9uLWl0ZW06bm90KC5ub3RpZmljYXRpb24taXRlbS1yZW1vdmluZyknKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBjb250YWluZXIudHJhbnNmb3JtKCcnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpdGVtLmFkZENsYXNzKCdub3RpZmljYXRpb24taGlkZGVuJykudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaXRlbS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICBpZiAoY29udGFpbmVyLmZpbmQoJy5ub3RpZmljYXRpb24taXRlbScpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuaGlkZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgIENvbXBpbGUgVGVtcGxhdGU3IFRlbXBsYXRlcyBPbiBBcHAgSW5pdFxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAuaW5pdFRlbXBsYXRlN1RlbXBsYXRlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICghd2luZG93LlRlbXBsYXRlNykgcmV0dXJuO1xuICAgICAgICAgICAgVGVtcGxhdGU3LnRlbXBsYXRlcyA9IFRlbXBsYXRlNy50ZW1wbGF0ZXMgfHwgYXBwLnBhcmFtcy50ZW1wbGF0ZXMgfHwge307XG4gICAgICAgICAgICBUZW1wbGF0ZTcuZGF0YSA9IFRlbXBsYXRlNy5kYXRhIHx8IGFwcC5wYXJhbXMudGVtcGxhdGU3RGF0YSB8fCB7fTtcbiAgICAgICAgICAgIFRlbXBsYXRlNy5jYWNoZSA9IFRlbXBsYXRlNy5jYWNoZSB8fCB7fTtcbiAgICAgICAgXG4gICAgICAgICAgICBhcHAudGVtcGxhdGVzID0gVGVtcGxhdGU3LnRlbXBsYXRlcztcbiAgICAgICAgICAgIGFwcC50ZW1wbGF0ZTdEYXRhID0gVGVtcGxhdGU3LmRhdGE7XG4gICAgICAgICAgICBhcHAudGVtcGxhdGU3Q2FjaGUgPSBUZW1wbGF0ZTcuY2FjaGU7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUHJlY29tcGlsZSB0ZW1wbGF0ZXMgb24gYXBwIGluaXRcbiAgICAgICAgICAgIGlmICghYXBwLnBhcmFtcy5wcmVjb21waWxlVGVtcGxhdGVzKSByZXR1cm47XG4gICAgICAgICAgICAkKCdzY3JpcHRbdHlwZT1cInRleHQvdGVtcGxhdGU3XCJdJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGlkID0gJCh0aGlzKS5hdHRyKCdpZCcpO1xuICAgICAgICAgICAgICAgIGlmICghaWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICBUZW1wbGF0ZTcudGVtcGxhdGVzW2lkXSA9IFRlbXBsYXRlNy5jb21waWxlKCQodGhpcykuaHRtbCgpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBQbHVnaW5zIEFQSSAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICB2YXIgX3BsdWdpbnMgPSBbXTtcbiAgICAgICAgYXBwLmluaXRQbHVnaW5zID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgLy8gSW5pdGlhbGl6ZSBwbHVnaW5zXG4gICAgICAgICAgICBmb3IgKHZhciBwbHVnaW4gaW4gYXBwLnBsdWdpbnMpIHtcbiAgICAgICAgICAgICAgICB2YXIgcCA9IGFwcC5wbHVnaW5zW3BsdWdpbl0oYXBwLCBhcHAucGFyYW1zW3BsdWdpbl0pO1xuICAgICAgICAgICAgICAgIGlmIChwKSBfcGx1Z2lucy5wdXNoKHApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICAvLyBQbHVnaW4gSG9va3NcbiAgICAgICAgYXBwLnBsdWdpbkhvb2sgPSBmdW5jdGlvbiAoaG9vaykge1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBfcGx1Z2lucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmIChfcGx1Z2luc1tpXS5ob29rcyAmJiBob29rIGluIF9wbHVnaW5zW2ldLmhvb2tzKSB7XG4gICAgICAgICAgICAgICAgICAgIF9wbHVnaW5zW2ldLmhvb2tzW2hvb2tdKGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdLCBhcmd1bWVudHNbM10sIGFyZ3VtZW50c1s0XSwgYXJndW1lbnRzWzVdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIC8vIFByZXZlbnRlZCBieSBwbHVnaW5cbiAgICAgICAgYXBwLnBsdWdpblByZXZlbnQgPSBmdW5jdGlvbiAoYWN0aW9uKSB7XG4gICAgICAgICAgICB2YXIgcHJldmVudCA9IGZhbHNlO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBfcGx1Z2lucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmIChfcGx1Z2luc1tpXS5wcmV2ZW50cyAmJiBhY3Rpb24gaW4gX3BsdWdpbnNbaV0ucHJldmVudHMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKF9wbHVnaW5zW2ldLnByZXZlbnRzW2FjdGlvbl0oYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0sIGFyZ3VtZW50c1szXSwgYXJndW1lbnRzWzRdLCBhcmd1bWVudHNbNV0pKSBwcmV2ZW50ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcHJldmVudDtcbiAgICAgICAgfTtcbiAgICAgICAgLy8gUHJlcHJvY2VzcyBjb250ZW50IGJ5IHBsdWdpblxuICAgICAgICBhcHAucGx1Z2luUHJvY2VzcyA9IGZ1bmN0aW9uIChwcm9jZXNzLCBkYXRhKSB7XG4gICAgICAgICAgICB2YXIgcHJvY2Vzc2VkID0gZGF0YTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgX3BsdWdpbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoX3BsdWdpbnNbaV0ucHJlcHJvY2VzcyAmJiBwcm9jZXNzIGluIF9wbHVnaW5zW2ldLnByZXByb2Nlc3MpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzc2VkID0gX3BsdWdpbnNbaV0ucHJlcHJvY2Vzc1twcm9jZXNzXShkYXRhLCBhcmd1bWVudHNbMl0sIGFyZ3VtZW50c1szXSwgYXJndW1lbnRzWzRdLCBhcmd1bWVudHNbNV0sIGFyZ3VtZW50c1s2XSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHByb2Nlc3NlZDtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIEFwcCBJbml0ICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5pbml0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgLy8gQ29tcGlsZSBUZW1wbGF0ZTcgdGVtcGxhdGVzIG9uIGFwcCBsb2FkXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRUZW1wbGF0ZTdUZW1wbGF0ZXMpIGFwcC5pbml0VGVtcGxhdGU3VGVtcGxhdGVzKCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgUGx1Z2luc1xuICAgICAgICAgICAgaWYgKGFwcC5pbml0UGx1Z2lucykgYXBwLmluaXRQbHVnaW5zKCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgRGV2aWNlXG4gICAgICAgICAgICBpZiAoYXBwLmdldERldmljZUluZm8pIGFwcC5nZXREZXZpY2VJbmZvKCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgQ2xpY2sgZXZlbnRzXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRGYXN0Q2xpY2tzICYmIGFwcC5wYXJhbXMuZmFzdENsaWNrcykgYXBwLmluaXRGYXN0Q2xpY2tzKCk7XG4gICAgICAgICAgICBpZiAoYXBwLmluaXRDbGlja0V2ZW50cykgYXBwLmluaXRDbGlja0V2ZW50cygpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgZWFjaCBwYWdlIGNhbGxiYWNrc1xuICAgICAgICAgICAgJCgnLnBhZ2U6bm90KC5jYWNoZWQpJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgYXBwLmluaXRQYWdlV2l0aENhbGxiYWNrKHRoaXMpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBlYWNoIG5hdmJhciBjYWxsYmFja3NcbiAgICAgICAgICAgICQoJy5uYXZiYXI6bm90KC5jYWNoZWQpJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgYXBwLmluaXROYXZiYXJXaXRoQ2FsbGJhY2sodGhpcyk7IFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgcmVzaXplIGV2ZW50c1xuICAgICAgICAgICAgaWYgKGFwcC5pbml0UmVzaXplKSBhcHAuaW5pdFJlc2l6ZSgpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgcHVzaCBzdGF0ZVxuICAgICAgICAgICAgaWYgKGFwcC5pbml0UHVzaFN0YXRlICYmIGFwcC5wYXJhbXMucHVzaFN0YXRlKSBhcHAuaW5pdFB1c2hTdGF0ZSgpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgTGl2ZSBTd2lwZW91dHMgZXZlbnRzXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRTd2lwZW91dCAmJiBhcHAucGFyYW1zLnN3aXBlb3V0KSBhcHAuaW5pdFN3aXBlb3V0KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBMaXZlIFNvcnRhYmxlIGV2ZW50c1xuICAgICAgICAgICAgaWYgKGFwcC5pbml0U29ydGFibGUgJiYgYXBwLnBhcmFtcy5zb3J0YWJsZSkgYXBwLmluaXRTb3J0YWJsZSgpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgTGl2ZSBTd2lwZSBQYW5lbHNcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdFN3aXBlUGFuZWxzICYmIChhcHAucGFyYW1zLnN3aXBlUGFuZWwgfHwgYXBwLnBhcmFtcy5zd2lwZVBhbmVsT25seUNsb3NlKSkgYXBwLmluaXRTd2lwZVBhbmVscygpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0IE1hdGVyaWFsIElucHV0c1xuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwgJiYgYXBwLmluaXRNYXRlcmlhbFdhdGNoSW5wdXRzKSBhcHAuaW5pdE1hdGVyaWFsV2F0Y2hJbnB1dHMoKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gQXBwIEluaXQgY2FsbGJhY2tcbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm9uQXBwSW5pdCkgYXBwLnBhcmFtcy5vbkFwcEluaXQoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQbHVnaW4gYXBwIGluaXQgaG9va1xuICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ2FwcEluaXQnKTtcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKGFwcC5wYXJhbXMuaW5pdCkgYXBwLmluaXQoKTtcbiAgICAgICAgXG5cbiAgICAgICAgLy9SZXR1cm4gaW5zdGFuY2UgICAgICAgIFxuICAgICAgICByZXR1cm4gYXBwO1xuICAgIH07XG4gICAgXG5cbiAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIERvbTcgTGlicmFyeVxuICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgdmFyIERvbTcgPSAoZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgRG9tNyA9IGZ1bmN0aW9uIChhcnIpIHtcbiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXMsIGkgPSAwO1xuICAgICAgICAgICAgLy8gQ3JlYXRlIGFycmF5LWxpa2Ugb2JqZWN0XG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgX3RoaXNbaV0gPSBhcnJbaV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBfdGhpcy5sZW5ndGggPSBhcnIubGVuZ3RoO1xuICAgICAgICAgICAgLy8gUmV0dXJuIGNvbGxlY3Rpb24gd2l0aCBtZXRob2RzXG4gICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgfTtcbiAgICAgICAgdmFyICQgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpIHtcbiAgICAgICAgICAgIHZhciBhcnIgPSBbXSwgaSA9IDA7XG4gICAgICAgICAgICBpZiAoc2VsZWN0b3IgJiYgIWNvbnRleHQpIHtcbiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0b3IgaW5zdGFuY2VvZiBEb203KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxlY3RvcjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoc2VsZWN0b3IpIHtcbiAgICAgICAgICAgICAgICAvLyBTdHJpbmdcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNlbGVjdG9yID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZWxzLCB0ZW1wUGFyZW50LCBodG1sO1xuICAgICAgICAgICAgICAgICAgICBzZWxlY3RvciA9IGh0bWwgPSBzZWxlY3Rvci50cmltKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChodG1sLmluZGV4T2YoJzwnKSA+PSAwICYmIGh0bWwuaW5kZXhPZignPicpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b0NyZWF0ZSA9ICdkaXYnO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGh0bWwuaW5kZXhPZignPGxpJykgPT09IDApIHRvQ3JlYXRlID0gJ3VsJztcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChodG1sLmluZGV4T2YoJzx0cicpID09PSAwKSB0b0NyZWF0ZSA9ICd0Ym9keSc7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaHRtbC5pbmRleE9mKCc8dGQnKSA9PT0gMCB8fCBodG1sLmluZGV4T2YoJzx0aCcpID09PSAwKSB0b0NyZWF0ZSA9ICd0cic7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaHRtbC5pbmRleE9mKCc8dGJvZHknKSA9PT0gMCkgdG9DcmVhdGUgPSAndGFibGUnO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGh0bWwuaW5kZXhPZignPG9wdGlvbicpID09PSAwKSB0b0NyZWF0ZSA9ICdzZWxlY3QnO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGVtcFBhcmVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodG9DcmVhdGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGVtcFBhcmVudC5pbm5lckhUTUwgPSBodG1sO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRlbXBQYXJlbnQuY2hpbGROb2Rlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFyci5wdXNoKHRlbXBQYXJlbnQuY2hpbGROb2Rlc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbnRleHQgJiYgc2VsZWN0b3JbMF0gPT09ICcjJyAmJiAhc2VsZWN0b3IubWF0Y2goL1sgLjw+On5dLykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBQdXJlIElEIHNlbGVjdG9yXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzID0gW2RvY3VtZW50LmdldEVsZW1lbnRCeUlkKHNlbGVjdG9yLnNwbGl0KCcjJylbMV0pXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE90aGVyIHNlbGVjdG9yc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVscyA9IChjb250ZXh0IHx8IGRvY3VtZW50KS5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBlbHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxzW2ldKSBhcnIucHVzaChlbHNbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIE5vZGUvZWxlbWVudFxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHNlbGVjdG9yLm5vZGVUeXBlIHx8IHNlbGVjdG9yID09PSB3aW5kb3cgfHwgc2VsZWN0b3IgPT09IGRvY3VtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGFyci5wdXNoKHNlbGVjdG9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy9BcnJheSBvZiBlbGVtZW50cyBvciBpbnN0YW5jZSBvZiBEb21cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChzZWxlY3Rvci5sZW5ndGggPiAwICYmIHNlbGVjdG9yWzBdLm5vZGVUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzZWxlY3Rvci5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goc2VsZWN0b3JbaV0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG5ldyBEb203KGFycik7XG4gICAgICAgIH07XG5cbiAgICAgICAgRG9tNy5wcm90b3R5cGUgPSB7XG4gICAgICAgICAgICAvLyBDbGFzc2VzIGFuZCBhdHRyaXV0ZXNcbiAgICAgICAgICAgIGFkZENsYXNzOiBmdW5jdGlvbiAoY2xhc3NOYW1lKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjbGFzc05hbWUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgY2xhc3NlcyA9IGNsYXNzTmFtZS5zcGxpdCgnICcpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2xhc3Nlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpc1tqXS5jbGFzc0xpc3QgIT09ICd1bmRlZmluZWQnKSB0aGlzW2pdLmNsYXNzTGlzdC5hZGQoY2xhc3Nlc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIChjbGFzc05hbWUpIHtcbiAgICAgICAgICAgICAgICB2YXIgY2xhc3NlcyA9IGNsYXNzTmFtZS5zcGxpdCgnICcpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2xhc3Nlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpc1tqXS5jbGFzc0xpc3QgIT09ICd1bmRlZmluZWQnKSB0aGlzW2pdLmNsYXNzTGlzdC5yZW1vdmUoY2xhc3Nlc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaGFzQ2xhc3M6IGZ1bmN0aW9uIChjbGFzc05hbWUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXNbMF0pIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiB0aGlzWzBdLmNsYXNzTGlzdC5jb250YWlucyhjbGFzc05hbWUpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiAoY2xhc3NOYW1lKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNsYXNzZXMgPSBjbGFzc05hbWUuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNsYXNzZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB0aGlzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRoaXNbal0uY2xhc3NMaXN0ICE9PSAndW5kZWZpbmVkJykgdGhpc1tqXS5jbGFzc0xpc3QudG9nZ2xlKGNsYXNzZXNbaV0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGF0dHI6IGZ1bmN0aW9uIChhdHRycywgdmFsdWUpIHtcbiAgICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgYXR0cnMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEdldCBhdHRyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzWzBdKSByZXR1cm4gdGhpc1swXS5nZXRBdHRyaWJ1dGUoYXR0cnMpO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBTZXQgYXR0cnNcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0cmluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV0uc2V0QXR0cmlidXRlKGF0dHJzLCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBPYmplY3RcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBhdHRyTmFtZSBpbiBhdHRycykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldW2F0dHJOYW1lXSA9IGF0dHJzW2F0dHJOYW1lXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXS5zZXRBdHRyaWJ1dGUoYXR0ck5hbWUsIGF0dHJzW2F0dHJOYW1lXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICByZW1vdmVBdHRyOiBmdW5jdGlvbiAoYXR0cikge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLnJlbW92ZUF0dHJpYnV0ZShhdHRyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcHJvcDogZnVuY3Rpb24gKHByb3BzLCB2YWx1ZSkge1xuICAgICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxICYmIHR5cGVvZiBwcm9wcyA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IHByb3BcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0pIHJldHVybiB0aGlzWzBdW3Byb3BzXTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gU2V0IHByb3BzXG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBTdHJpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldW3Byb3BzXSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gT2JqZWN0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgcHJvcE5hbWUgaW4gcHJvcHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXVtwcm9wTmFtZV0gPSBwcm9wc1twcm9wTmFtZV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkYXRhOiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEdldCB2YWx1ZVxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpc1swXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0uZG9tN0VsZW1lbnREYXRhU3RvcmFnZSAmJiAoa2V5IGluIHRoaXNbMF0uZG9tN0VsZW1lbnREYXRhU3RvcmFnZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1swXS5kb203RWxlbWVudERhdGFTdG9yYWdlW2tleV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YUtleSA9IHRoaXNbMF0uZ2V0QXR0cmlidXRlKCdkYXRhLScgKyBrZXkpOyAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YUtleSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0YUtleTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFNldCB2YWx1ZVxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbCA9IHRoaXNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVsLmRvbTdFbGVtZW50RGF0YVN0b3JhZ2UpIGVsLmRvbTdFbGVtZW50RGF0YVN0b3JhZ2UgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmRvbTdFbGVtZW50RGF0YVN0b3JhZ2Vba2V5XSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICByZW1vdmVEYXRhOiBmdW5jdGlvbihrZXkpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVsID0gdGhpc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVsLmRvbTdFbGVtZW50RGF0YVN0b3JhZ2UgJiYgZWwuZG9tN0VsZW1lbnREYXRhU3RvcmFnZVtrZXldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbC5kb203RWxlbWVudERhdGFTdG9yYWdlW2tleV0gPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGVsLmRvbTdFbGVtZW50RGF0YVN0b3JhZ2Vba2V5XTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkYXRhc2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGVsID0gdGhpc1swXTtcbiAgICAgICAgICAgICAgICBpZiAoZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGFzZXQgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVsLmRhdGFzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGRhdGFLZXkgaW4gZWwuZGF0YXNldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFzZXRbZGF0YUtleV0gPSBlbC5kYXRhc2V0W2RhdGFLZXldO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbC5hdHRyaWJ1dGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGF0dHIgPSBlbC5hdHRyaWJ1dGVzW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdHRyLm5hbWUuaW5kZXhPZignZGF0YS0nKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFzZXRbJC50b0NhbWVsQ2FzZShhdHRyLm5hbWUuc3BsaXQoJ2RhdGEtJylbMV0pXSA9IGF0dHIudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBkYXRhc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YXNldFtrZXldID09PSAnZmFsc2UnKSBkYXRhc2V0W2tleV0gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGRhdGFzZXRba2V5XSA9PT0gJ3RydWUnKSBkYXRhc2V0W2tleV0gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocGFyc2VGbG9hdChkYXRhc2V0W2tleV0pID09PSBkYXRhc2V0W2tleV0gKiAxKSBkYXRhc2V0W2tleV0gPSBkYXRhc2V0W2tleV0gKiAxO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhc2V0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdmFsOiBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpc1swXSkgcmV0dXJuIHRoaXNbMF0udmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXS52YWx1ZSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAvLyBUcmFuc2Zvcm1zXG4gICAgICAgICAgICB0cmFuc2Zvcm0gOiBmdW5jdGlvbiAodHJhbnNmb3JtKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBlbFN0eWxlID0gdGhpc1tpXS5zdHlsZTtcbiAgICAgICAgICAgICAgICAgICAgZWxTdHlsZS53ZWJraXRUcmFuc2Zvcm0gPSBlbFN0eWxlLk1zVHJhbnNmb3JtID0gZWxTdHlsZS5tc1RyYW5zZm9ybSA9IGVsU3R5bGUuTW96VHJhbnNmb3JtID0gZWxTdHlsZS5PVHJhbnNmb3JtID0gZWxTdHlsZS50cmFuc2Zvcm0gPSB0cmFuc2Zvcm07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRyYW5zaXRpb246IGZ1bmN0aW9uIChkdXJhdGlvbikge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZHVyYXRpb24gIT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIGR1cmF0aW9uID0gZHVyYXRpb24gKyAnbXMnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVsU3R5bGUgPSB0aGlzW2ldLnN0eWxlO1xuICAgICAgICAgICAgICAgICAgICBlbFN0eWxlLndlYmtpdFRyYW5zaXRpb25EdXJhdGlvbiA9IGVsU3R5bGUuTXNUcmFuc2l0aW9uRHVyYXRpb24gPSBlbFN0eWxlLm1zVHJhbnNpdGlvbkR1cmF0aW9uID0gZWxTdHlsZS5Nb3pUcmFuc2l0aW9uRHVyYXRpb24gPSBlbFN0eWxlLk9UcmFuc2l0aW9uRHVyYXRpb24gPSBlbFN0eWxlLnRyYW5zaXRpb25EdXJhdGlvbiA9IGR1cmF0aW9uO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAvL0V2ZW50c1xuICAgICAgICAgICAgb246IGZ1bmN0aW9uIChldmVudE5hbWUsIHRhcmdldFNlbGVjdG9yLCBsaXN0ZW5lciwgY2FwdHVyZSkge1xuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZUxpdmVFdmVudChlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQodGFyZ2V0KS5pcyh0YXJnZXRTZWxlY3RvcikpIGxpc3RlbmVyLmNhbGwodGFyZ2V0LCBlKTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50cyA9ICQodGFyZ2V0KS5wYXJlbnRzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IHBhcmVudHMubGVuZ3RoOyBrKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJChwYXJlbnRzW2tdKS5pcyh0YXJnZXRTZWxlY3RvcikpIGxpc3RlbmVyLmNhbGwocGFyZW50c1trXSwgZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIGV2ZW50cyA9IGV2ZW50TmFtZS5zcGxpdCgnICcpO1xuICAgICAgICAgICAgICAgIHZhciBpLCBqO1xuICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0U2VsZWN0b3IgPT09ICdmdW5jdGlvbicgfHwgdGFyZ2V0U2VsZWN0b3IgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBVc3VhbCBldmVudHNcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0U2VsZWN0b3IgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lciA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlID0gYXJndW1lbnRzWzJdIHx8IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IGV2ZW50cy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV0uYWRkRXZlbnRMaXN0ZW5lcihldmVudHNbal0sIGxpc3RlbmVyLCBjYXB0dXJlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vTGl2ZSBldmVudHNcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBldmVudHMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXNbaV0uZG9tN0xpdmVMaXN0ZW5lcnMpIHRoaXNbaV0uZG9tN0xpdmVMaXN0ZW5lcnMgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLmRvbTdMaXZlTGlzdGVuZXJzLnB1c2goe2xpc3RlbmVyOiBsaXN0ZW5lciwgbGl2ZUxpc3RlbmVyOiBoYW5kbGVMaXZlRXZlbnR9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLmFkZEV2ZW50TGlzdGVuZXIoZXZlbnRzW2pdLCBoYW5kbGVMaXZlRXZlbnQsIGNhcHR1cmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvZmY6IGZ1bmN0aW9uIChldmVudE5hbWUsIHRhcmdldFNlbGVjdG9yLCBsaXN0ZW5lciwgY2FwdHVyZSkge1xuICAgICAgICAgICAgICAgIHZhciBldmVudHMgPSBldmVudE5hbWUuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0U2VsZWN0b3IgPT09ICdmdW5jdGlvbicgfHwgdGFyZ2V0U2VsZWN0b3IgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVXN1YWwgZXZlbnRzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXRTZWxlY3RvciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lciA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FwdHVyZSA9IGFyZ3VtZW50c1syXSB8fCBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tqXS5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50c1tpXSwgbGlzdGVuZXIsIGNhcHR1cmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gTGl2ZSBldmVudFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzW2pdLmRvbTdMaXZlTGlzdGVuZXJzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgdGhpc1tqXS5kb203TGl2ZUxpc3RlbmVycy5sZW5ndGg7IGsrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbal0uZG9tN0xpdmVMaXN0ZW5lcnNba10ubGlzdGVuZXIgPT09IGxpc3RlbmVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tqXS5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50c1tpXSwgdGhpc1tqXS5kb203TGl2ZUxpc3RlbmVyc1trXS5saXZlTGlzdGVuZXIsIGNhcHR1cmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9uY2U6IGZ1bmN0aW9uIChldmVudE5hbWUsIHRhcmdldFNlbGVjdG9yLCBsaXN0ZW5lciwgY2FwdHVyZSkge1xuICAgICAgICAgICAgICAgIHZhciBkb20gPSB0aGlzO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0U2VsZWN0b3IgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIgPSBhcmd1bWVudHNbMV07XG4gICAgICAgICAgICAgICAgICAgIGNhcHR1cmUgPSBhcmd1bWVudHNbMl07XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFNlbGVjdG9yID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHByb3h5KGUpIHtcbiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXIuY2FsbChlLnRhcmdldCwgZSk7XG4gICAgICAgICAgICAgICAgICAgIGRvbS5vZmYoZXZlbnROYW1lLCB0YXJnZXRTZWxlY3RvciwgcHJveHksIGNhcHR1cmUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZG9tLm9uKGV2ZW50TmFtZSwgdGFyZ2V0U2VsZWN0b3IsIHByb3h5LCBjYXB0dXJlKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0cmlnZ2VyOiBmdW5jdGlvbiAoZXZlbnROYW1lLCBldmVudERhdGEpIHtcbiAgICAgICAgICAgICAgICB2YXIgZXZlbnRzID0gZXZlbnROYW1lLnNwbGl0KCcgJyk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB0aGlzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZ0O1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldnQgPSBuZXcgQ3VzdG9tRXZlbnQoZXZlbnRzW2ldLCB7ZGV0YWlsOiBldmVudERhdGEsIGJ1YmJsZXM6IHRydWUsIGNhbmNlbGFibGU6IHRydWV9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZ0ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0V2ZW50Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZ0LmluaXRFdmVudChldmVudHNbaV0sIHRydWUsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2dC5kZXRhaWwgPSBldmVudERhdGE7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2pdLmRpc3BhdGNoRXZlbnQoZXZ0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0cmFuc2l0aW9uRW5kOiBmdW5jdGlvbiAoY2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICB2YXIgZXZlbnRzID0gWyd3ZWJraXRUcmFuc2l0aW9uRW5kJywgJ3RyYW5zaXRpb25lbmQnLCAnb1RyYW5zaXRpb25FbmQnLCAnTVNUcmFuc2l0aW9uRW5kJywgJ21zVHJhbnNpdGlvbkVuZCddLFxuICAgICAgICAgICAgICAgICAgICBpLCBqLCBkb20gPSB0aGlzO1xuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGZpcmVDYWxsQmFjayhlKSB7XG4gICAgICAgICAgICAgICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovXG4gICAgICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldCAhPT0gdGhpcykgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXMsIGUpO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb20ub2ZmKGV2ZW50c1tpXSwgZmlyZUNhbGxCYWNrKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGV2ZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9tLm9uKGV2ZW50c1tpXSwgZmlyZUNhbGxCYWNrKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBhbmltYXRpb25FbmQ6IGZ1bmN0aW9uIChjYWxsYmFjaykge1xuICAgICAgICAgICAgICAgIHZhciBldmVudHMgPSBbJ3dlYmtpdEFuaW1hdGlvbkVuZCcsICdPQW5pbWF0aW9uRW5kJywgJ01TQW5pbWF0aW9uRW5kJywgJ2FuaW1hdGlvbmVuZCddLFxuICAgICAgICAgICAgICAgICAgICBpLCBqLCBkb20gPSB0aGlzO1xuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGZpcmVDYWxsQmFjayhlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGUpO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb20ub2ZmKGV2ZW50c1tpXSwgZmlyZUNhbGxCYWNrKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGV2ZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9tLm9uKGV2ZW50c1tpXSwgZmlyZUNhbGxCYWNrKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAvLyBTaXppbmcvU3R5bGVzXG4gICAgICAgICAgICB3aWR0aDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzWzBdID09PSB3aW5kb3cpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy5pbm5lcldpZHRoO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQodGhpcy5jc3MoJ3dpZHRoJykpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb3V0ZXJXaWR0aDogZnVuY3Rpb24gKGluY2x1ZGVNYXJnaW5zKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5jbHVkZU1hcmdpbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdHlsZXMgPSB0aGlzLnN0eWxlcygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbMF0ub2Zmc2V0V2lkdGggKyBwYXJzZUZsb2F0KHN0eWxlcy5nZXRQcm9wZXJ0eVZhbHVlKCdtYXJnaW4tcmlnaHQnKSkgKyBwYXJzZUZsb2F0KHN0eWxlcy5nZXRQcm9wZXJ0eVZhbHVlKCdtYXJnaW4tbGVmdCcpKTsgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbMF0ub2Zmc2V0V2lkdGg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaGVpZ2h0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0gPT09IHdpbmRvdykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93LmlubmVySGVpZ2h0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhcnNlRmxvYXQodGhpcy5jc3MoJ2hlaWdodCcpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG91dGVySGVpZ2h0OiBmdW5jdGlvbiAoaW5jbHVkZU1hcmdpbnMpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlTWFyZ2lucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0eWxlcyA9IHRoaXMuc3R5bGVzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1swXS5vZmZzZXRIZWlnaHQgKyBwYXJzZUZsb2F0KHN0eWxlcy5nZXRQcm9wZXJ0eVZhbHVlKCdtYXJnaW4tdG9wJykpICsgcGFyc2VGbG9hdChzdHlsZXMuZ2V0UHJvcGVydHlWYWx1ZSgnbWFyZ2luLWJvdHRvbScpKTsgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9mZnNldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVsID0gdGhpc1swXTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJveCA9IGVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgYm9keSA9IGRvY3VtZW50LmJvZHk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjbGllbnRUb3AgID0gZWwuY2xpZW50VG9wICB8fCBib2R5LmNsaWVudFRvcCAgfHwgMDtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNsaWVudExlZnQgPSBlbC5jbGllbnRMZWZ0IHx8IGJvZHkuY2xpZW50TGVmdCB8fCAwO1xuICAgICAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsVG9wICA9IHdpbmRvdy5wYWdlWU9mZnNldCB8fCBlbC5zY3JvbGxUb3A7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzY3JvbGxMZWZ0ID0gd2luZG93LnBhZ2VYT2Zmc2V0IHx8IGVsLnNjcm9sbExlZnQ7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b3A6IGJveC50b3AgICsgc2Nyb2xsVG9wICAtIGNsaWVudFRvcCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnQ6IGJveC5sZWZ0ICsgc2Nyb2xsTGVmdCAtIGNsaWVudExlZnRcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBoaWRlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXNbaV0uc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2hvdzogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzdHlsZXM6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgaSwgc3R5bGVzO1xuICAgICAgICAgICAgICAgIGlmICh0aGlzWzBdKSByZXR1cm4gd2luZG93LmdldENvbXB1dGVkU3R5bGUodGhpc1swXSwgbnVsbCk7XG4gICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNzczogZnVuY3Rpb24gKHByb3BzLCB2YWx1ZSkge1xuICAgICAgICAgICAgICAgIHZhciBpO1xuICAgICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcHJvcHMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc1swXSkgcmV0dXJuIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHRoaXNbMF0sIG51bGwpLmdldFByb3BlcnR5VmFsdWUocHJvcHMpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBwcm9wIGluIHByb3BzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV0uc3R5bGVbcHJvcF0gPSBwcm9wc1twcm9wXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMiAmJiB0eXBlb2YgcHJvcHMgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLnN0eWxlW3Byb3BzXSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgIFxuICAgICAgICAgICAgLy9Eb20gbWFuaXB1bGF0aW9uXG4gICAgICAgICAgICBlYWNoOiBmdW5jdGlvbiAoY2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbCh0aGlzW2ldLCBpLCB0aGlzW2ldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZmlsdGVyOiBmdW5jdGlvbiAoY2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlZEl0ZW1zID0gW107XG4gICAgICAgICAgICAgICAgdmFyIGRvbSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkb20ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrLmNhbGwoZG9tW2ldLCBpLCBkb21baV0pKSBtYXRjaGVkSXRlbXMucHVzaChkb21baV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERvbTcobWF0Y2hlZEl0ZW1zKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBodG1sOiBmdW5jdGlvbiAoaHRtbCkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaHRtbCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbMF0gPyB0aGlzWzBdLmlubmVySFRNTCA6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXS5pbm5lckhUTUwgPSBodG1sO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB0ZXh0OiBmdW5jdGlvbiAodGV4dCkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGV4dCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWzBdLnRleHRDb250ZW50LnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLnRleHRDb250ZW50ID0gdGV4dDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaXM6IGZ1bmN0aW9uIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgIGlmICghdGhpc1swXSB8fCB0eXBlb2Ygc2VsZWN0b3IgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgdmFyIGNvbXBhcmVXaXRoLCBpO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBlbCA9IHRoaXNbMF07XG4gICAgICAgICAgICAgICAgICAgIGlmIChlbCA9PT0gZG9jdW1lbnQpIHJldHVybiBzZWxlY3RvciA9PT0gZG9jdW1lbnQ7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlbCA9PT0gd2luZG93KSByZXR1cm4gc2VsZWN0b3IgPT09IHdpbmRvdztcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChlbC5tYXRjaGVzKSByZXR1cm4gZWwubWF0Y2hlcyhzZWxlY3Rvcik7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGVsLndlYmtpdE1hdGNoZXNTZWxlY3RvcikgcmV0dXJuIGVsLndlYmtpdE1hdGNoZXNTZWxlY3RvcihzZWxlY3Rvcik7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGVsLm1vek1hdGNoZXNTZWxlY3RvcikgcmV0dXJuIGVsLm1vek1hdGNoZXNTZWxlY3RvcihzZWxlY3Rvcik7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGVsLm1zTWF0Y2hlc1NlbGVjdG9yKSByZXR1cm4gZWwubXNNYXRjaGVzU2VsZWN0b3Ioc2VsZWN0b3IpO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBhcmVXaXRoID0gJChzZWxlY3Rvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29tcGFyZVdpdGgubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcGFyZVdpdGhbaV0gPT09IHRoaXNbMF0pIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHNlbGVjdG9yID09PSBkb2N1bWVudCkgcmV0dXJuIHRoaXNbMF0gPT09IGRvY3VtZW50O1xuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHNlbGVjdG9yID09PSB3aW5kb3cpIHJldHVybiB0aGlzWzBdID09PSB3aW5kb3c7XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rvci5ub2RlVHlwZSB8fCBzZWxlY3RvciBpbnN0YW5jZW9mIERvbTcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBhcmVXaXRoID0gc2VsZWN0b3Iubm9kZVR5cGUgPyBbc2VsZWN0b3JdIDogc2VsZWN0b3I7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29tcGFyZVdpdGgubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29tcGFyZVdpdGhbaV0gPT09IHRoaXNbMF0pIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGluZGV4T2Y6IGZ1bmN0aW9uIChlbCkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpc1tpXSA9PT0gZWwpIHJldHVybiBpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpbmRleDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZCA9IHRoaXNbMF07XG4gICAgICAgICAgICAgICAgICAgIHZhciBpID0gMDtcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKChjaGlsZCA9IGNoaWxkLnByZXZpb3VzU2libGluZykgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5ub2RlVHlwZSA9PT0gMSkgaSsrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXE6IGZ1bmN0aW9uIChpbmRleCkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaW5kZXggPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcztcbiAgICAgICAgICAgICAgICB2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgdmFyIHJldHVybkluZGV4O1xuICAgICAgICAgICAgICAgIGlmIChpbmRleCA+IGxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEb203KFtdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm5JbmRleCA9IGxlbmd0aCArIGluZGV4O1xuICAgICAgICAgICAgICAgICAgICBpZiAocmV0dXJuSW5kZXggPCAwKSByZXR1cm4gbmV3IERvbTcoW10pO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBuZXcgRG9tNyhbdGhpc1tyZXR1cm5JbmRleF1dKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEb203KFt0aGlzW2luZGV4XV0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGFwcGVuZDogZnVuY3Rpb24gKG5ld0NoaWxkKSB7XG4gICAgICAgICAgICAgICAgdmFyIGksIGo7XG4gICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0ZW1wRGl2LmlubmVySFRNTCA9IG5ld0NoaWxkO1xuICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHRlbXBEaXYuZmlyc3RDaGlsZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV0uYXBwZW5kQ2hpbGQodGVtcERpdi5maXJzdENoaWxkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChuZXdDaGlsZCBpbnN0YW5jZW9mIERvbTcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBuZXdDaGlsZC5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV0uYXBwZW5kQ2hpbGQobmV3Q2hpbGRbal0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXS5hcHBlbmRDaGlsZChuZXdDaGlsZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYXBwZW5kVG86IGZ1bmN0aW9uIChwYXJlbnQpIHtcbiAgICAgICAgICAgICAgICAkKHBhcmVudCkuYXBwZW5kKHRoaXMpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHByZXBlbmQ6IGZ1bmN0aW9uIChuZXdDaGlsZCkge1xuICAgICAgICAgICAgICAgIHZhciBpLCBqO1xuICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3Q2hpbGQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGVtcERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGVtcERpdi5pbm5lckhUTUwgPSBuZXdDaGlsZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IHRlbXBEaXYuY2hpbGROb2Rlcy5sZW5ndGggLSAxOyBqID49IDA7IGotLSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV0uaW5zZXJ0QmVmb3JlKHRlbXBEaXYuY2hpbGROb2Rlc1tqXSwgdGhpc1tpXS5jaGlsZE5vZGVzWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXNbaV0uaW5zZXJ0QWRqYWNlbnRIVE1MKCdhZnRlcmJlZ2luJywgbmV3Q2hpbGQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG5ld0NoaWxkIGluc3RhbmNlb2YgRG9tNykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IG5ld0NoaWxkLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXS5pbnNlcnRCZWZvcmUobmV3Q2hpbGRbal0sIHRoaXNbaV0uY2hpbGROb2Rlc1swXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLmluc2VydEJlZm9yZShuZXdDaGlsZCwgdGhpc1tpXS5jaGlsZE5vZGVzWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwcmVwZW5kVG86IGZ1bmN0aW9uIChwYXJlbnQpIHtcbiAgICAgICAgICAgICAgICAkKHBhcmVudCkucHJlcGVuZCh0aGlzKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpbnNlcnRCZWZvcmU6IGZ1bmN0aW9uIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgIHZhciBiZWZvcmUgPSAkKHNlbGVjdG9yKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJlZm9yZS5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZVswXS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0aGlzW2ldLCBiZWZvcmVbMF0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGJlZm9yZS5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGJlZm9yZS5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZm9yZVtqXS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0aGlzW2ldLmNsb25lTm9kZSh0cnVlKSwgYmVmb3JlW2pdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpbnNlcnRBZnRlcjogZnVuY3Rpb24gKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFmdGVyID0gJChzZWxlY3Rvcik7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhZnRlci5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyWzBdLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRoaXNbaV0sIGFmdGVyWzBdLm5leHRTaWJsaW5nKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChhZnRlci5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGFmdGVyLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJbal0ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGhpc1tpXS5jbG9uZU5vZGUodHJ1ZSksIGFmdGVyW2pdLm5leHRTaWJsaW5nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBuZXh0OiBmdW5jdGlvbiAoc2VsZWN0b3IpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0ubmV4dEVsZW1lbnRTaWJsaW5nICYmICQodGhpc1swXS5uZXh0RWxlbWVudFNpYmxpbmcpLmlzKHNlbGVjdG9yKSkgcmV0dXJuIG5ldyBEb203KFt0aGlzWzBdLm5leHRFbGVtZW50U2libGluZ10pO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gbmV3IERvbTcoW10pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0ubmV4dEVsZW1lbnRTaWJsaW5nKSByZXR1cm4gbmV3IERvbTcoW3RoaXNbMF0ubmV4dEVsZW1lbnRTaWJsaW5nXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBuZXcgRG9tNyhbXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gbmV3IERvbTcoW10pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG5leHRBbGw6IGZ1bmN0aW9uIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgIHZhciBuZXh0RWxzID0gW107XG4gICAgICAgICAgICAgICAgdmFyIGVsID0gdGhpc1swXTtcbiAgICAgICAgICAgICAgICBpZiAoIWVsKSByZXR1cm4gbmV3IERvbTcoW10pO1xuICAgICAgICAgICAgICAgIHdoaWxlIChlbC5uZXh0RWxlbWVudFNpYmxpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5leHQgPSBlbC5uZXh0RWxlbWVudFNpYmxpbmc7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYoJChuZXh0KS5pcyhzZWxlY3RvcikpIG5leHRFbHMucHVzaChuZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIG5leHRFbHMucHVzaChuZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgZWwgPSBuZXh0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERvbTcobmV4dEVscyk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcHJldjogZnVuY3Rpb24gKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzWzBdLnByZXZpb3VzRWxlbWVudFNpYmxpbmcgJiYgJCh0aGlzWzBdLnByZXZpb3VzRWxlbWVudFNpYmxpbmcpLmlzKHNlbGVjdG9yKSkgcmV0dXJuIG5ldyBEb203KFt0aGlzWzBdLnByZXZpb3VzRWxlbWVudFNpYmxpbmddKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIG5ldyBEb203KFtdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzWzBdLnByZXZpb3VzRWxlbWVudFNpYmxpbmcpIHJldHVybiBuZXcgRG9tNyhbdGhpc1swXS5wcmV2aW91c0VsZW1lbnRTaWJsaW5nXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBuZXcgRG9tNyhbXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gbmV3IERvbTcoW10pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHByZXZBbGw6IGZ1bmN0aW9uIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgIHZhciBwcmV2RWxzID0gW107XG4gICAgICAgICAgICAgICAgdmFyIGVsID0gdGhpc1swXTtcbiAgICAgICAgICAgICAgICBpZiAoIWVsKSByZXR1cm4gbmV3IERvbTcoW10pO1xuICAgICAgICAgICAgICAgIHdoaWxlIChlbC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwcmV2ID0gZWwucHJldmlvdXNFbGVtZW50U2libGluZztcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZigkKHByZXYpLmlzKHNlbGVjdG9yKSkgcHJldkVscy5wdXNoKHByZXYpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcHJldkVscy5wdXNoKHByZXYpO1xuICAgICAgICAgICAgICAgICAgICBlbCA9IHByZXY7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRG9tNyhwcmV2RWxzKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwYXJlbnQ6IGZ1bmN0aW9uIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgIHZhciBwYXJlbnRzID0gW107XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzW2ldLnBhcmVudE5vZGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKHRoaXNbaV0ucGFyZW50Tm9kZSkuaXMoc2VsZWN0b3IpKSBwYXJlbnRzLnB1c2godGhpc1tpXS5wYXJlbnROb2RlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50cy5wdXNoKHRoaXNbaV0ucGFyZW50Tm9kZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuICQoJC51bmlxdWUocGFyZW50cykpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHBhcmVudHM6IGZ1bmN0aW9uIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgIHZhciBwYXJlbnRzID0gW107XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnQgPSB0aGlzW2ldLnBhcmVudE5vZGU7XG4gICAgICAgICAgICAgICAgICAgIHdoaWxlIChwYXJlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKHBhcmVudCkuaXMoc2VsZWN0b3IpKSBwYXJlbnRzLnB1c2gocGFyZW50KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudHMucHVzaChwYXJlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50ID0gcGFyZW50LnBhcmVudE5vZGU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuICQoJC51bmlxdWUocGFyZW50cykpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNsb3Nlc3Q6IGZ1bmN0aW9uIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgIHZhciBjbG9zZXN0ID0gdGhpcztcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNlbGVjdG9yID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERvbTcoW10pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWNsb3Nlc3QuaXMoc2VsZWN0b3IpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsb3Nlc3QgPSBjbG9zZXN0LnBhcmVudHMoc2VsZWN0b3IpLmVxKDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gY2xvc2VzdDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmaW5kIDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgdmFyIGZvdW5kRWxlbWVudHMgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZvdW5kID0gdGhpc1tpXS5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBmb3VuZC5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRFbGVtZW50cy5wdXNoKGZvdW5kW2pdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERvbTcoZm91bmRFbGVtZW50cyk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY2hpbGRyZW46IGZ1bmN0aW9uIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgIHZhciBjaGlsZHJlbiA9IFtdO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgY2hpbGROb2RlcyA9IHRoaXNbaV0uY2hpbGROb2RlcztcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY2hpbGROb2Rlcy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZE5vZGVzW2pdLm5vZGVUeXBlID09PSAxKSBjaGlsZHJlbi5wdXNoKGNoaWxkTm9kZXNbal0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkTm9kZXNbal0ubm9kZVR5cGUgPT09IDEgJiYgJChjaGlsZE5vZGVzW2pdKS5pcyhzZWxlY3RvcikpIGNoaWxkcmVuLnB1c2goY2hpbGROb2Rlc1tqXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEb203KCQudW5pcXVlKGNoaWxkcmVuKSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzW2ldLnBhcmVudE5vZGUpIHRoaXNbaV0ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzW2ldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZGV0YWNoOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYWRkOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGRvbSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgdmFyIGksIGo7XG4gICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdG9BZGQgPSAkKGFyZ3VtZW50c1tpXSk7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCB0b0FkZC5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9tW2RvbS5sZW5ndGhdID0gdG9BZGRbal07XG4gICAgICAgICAgICAgICAgICAgICAgICBkb20ubGVuZ3RoKys7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRvbTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8vIFNob3J0Y3V0c1xuICAgICAgICAoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIHNob3J0Y3V0cyA9ICgnY2xpY2sgYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IGtleXVwIGtleWRvd24ga2V5cHJlc3Mgc3VibWl0IGNoYW5nZSBtb3VzZWRvd24gbW91c2Vtb3ZlIG1vdXNldXAgbW91c2VlbnRlciBtb3VzZWxlYXZlIG1vdXNlb3V0IG1vdXNlb3ZlciB0b3VjaHN0YXJ0IHRvdWNoZW5kIHRvdWNobW92ZSByZXNpemUgc2Nyb2xsJykuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgIHZhciBub3RUcmlnZ2VyID0gKCdyZXNpemUgc2Nyb2xsJykuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZU1ldGhvZChuYW1lKSB7XG4gICAgICAgICAgICAgICAgRG9tNy5wcm90b3R5cGVbbmFtZV0gPSBmdW5jdGlvbiAodGFyZ2V0U2VsZWN0b3IsIGxpc3RlbmVyLCBjYXB0dXJlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRhcmdldFNlbGVjdG9yID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm90VHJpZ2dlci5pbmRleE9mKG5hbWUpIDwgMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmFtZSBpbiB0aGlzW2ldKSB0aGlzW2ldW25hbWVdKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzW2ldKS50cmlnZ2VyKG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vbihuYW1lLCB0YXJnZXRTZWxlY3RvciwgbGlzdGVuZXIsIGNhcHR1cmUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2hvcnRjdXRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY3JlYXRlTWV0aG9kKHNob3J0Y3V0c1tpXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pKCk7XG4gICAgICAgIFxuXG4gICAgICAgIC8vIEdsb2JhbCBBamF4IFNldHVwXG4gICAgICAgIHZhciBnbG9iYWxBamF4T3B0aW9ucyA9IHt9O1xuICAgICAgICAkLmFqYXhTZXR1cCA9IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICAgICAgICBpZiAob3B0aW9ucy50eXBlKSBvcHRpb25zLm1ldGhvZCA9IG9wdGlvbnMudHlwZTtcbiAgICAgICAgICAgICQuZWFjaChvcHRpb25zLCBmdW5jdGlvbiAob3B0aW9uTmFtZSwgb3B0aW9uVmFsdWUpIHtcbiAgICAgICAgICAgICAgICBnbG9iYWxBamF4T3B0aW9uc1tvcHRpb25OYW1lXSAgPSBvcHRpb25WYWx1ZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLy8gQWpheFxuICAgICAgICB2YXIgX2pzb25wUmVxdWVzdHMgPSAwO1xuICAgICAgICAkLmFqYXggPSBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgICAgICAgdmFyIGRlZmF1bHRzID0ge1xuICAgICAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgICAgICAgICAgZGF0YTogZmFsc2UsXG4gICAgICAgICAgICAgICAgYXN5bmM6IHRydWUsXG4gICAgICAgICAgICAgICAgY2FjaGU6IHRydWUsXG4gICAgICAgICAgICAgICAgdXNlcjogJycsXG4gICAgICAgICAgICAgICAgcGFzc3dvcmQ6ICcnLFxuICAgICAgICAgICAgICAgIGhlYWRlcnM6IHt9LFxuICAgICAgICAgICAgICAgIHhockZpZWxkczoge30sXG4gICAgICAgICAgICAgICAgc3RhdHVzQ29kZToge30sXG4gICAgICAgICAgICAgICAgcHJvY2Vzc0RhdGE6IHRydWUsXG4gICAgICAgICAgICAgICAgZGF0YVR5cGU6ICd0ZXh0JyxcbiAgICAgICAgICAgICAgICBjb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcsXG4gICAgICAgICAgICAgICAgdGltZW91dDogMFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBbJ2JlZm9yZVNlbmQnLCAnZXJyb3InLCAnY29tcGxldGUnLCAnc3VjY2VzcycsICdzdGF0dXNDb2RlJ107XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgIC8vRm9yIGpRdWVyeSBndXlzXG4gICAgICAgICAgICBpZiAob3B0aW9ucy50eXBlKSBvcHRpb25zLm1ldGhvZCA9IG9wdGlvbnMudHlwZTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBNZXJnZSBnbG9iYWwgYW5kIGRlZmF1bHRzXG4gICAgICAgICAgICAkLmVhY2goZ2xvYmFsQWpheE9wdGlvbnMsIGZ1bmN0aW9uIChnbG9iYWxPcHRpb25OYW1lLCBnbG9iYWxPcHRpb25WYWx1ZSkge1xuICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja3MuaW5kZXhPZihnbG9iYWxPcHRpb25OYW1lKSA8IDApIGRlZmF1bHRzW2dsb2JhbE9wdGlvbk5hbWVdID0gZ2xvYmFsT3B0aW9uVmFsdWU7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBGdW5jdGlvbiB0byBydW4gWEhSIGNhbGxiYWNrcyBhbmQgZXZlbnRzXG4gICAgICAgICAgICBmdW5jdGlvbiBmaXJlQWpheENhbGxiYWNrIChldmVudE5hbWUsIGV2ZW50RGF0YSwgY2FsbGJhY2tOYW1lKSB7XG4gICAgICAgICAgICAgICAgdmFyIGEgPSBhcmd1bWVudHM7XG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50TmFtZSkgJChkb2N1bWVudCkudHJpZ2dlcihldmVudE5hbWUsIGV2ZW50RGF0YSk7XG4gICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBHbG9iYWwgY2FsbGJhY2tcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrTmFtZSBpbiBnbG9iYWxBamF4T3B0aW9ucykgZ2xvYmFsQWpheE9wdGlvbnNbY2FsbGJhY2tOYW1lXShhWzNdLCBhWzRdLCBhWzVdLCBhWzZdKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gT3B0aW9ucyBjYWxsYmFja1xuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9uc1tjYWxsYmFja05hbWVdKSBvcHRpb25zW2NhbGxiYWNrTmFtZV0oYVszXSwgYVs0XSwgYVs1XSwgYVs2XSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIE1lcmdlIG9wdGlvbnMgYW5kIGRlZmF1bHRzXG4gICAgICAgICAgICAkLmVhY2goZGVmYXVsdHMsIGZ1bmN0aW9uIChwcm9wLCBkZWZhdWx0VmFsdWUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIShwcm9wIGluIG9wdGlvbnMpKSBvcHRpb25zW3Byb3BdID0gZGVmYXVsdFZhbHVlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGVmYXVsdCBVUkxcbiAgICAgICAgICAgIGlmICghb3B0aW9ucy51cmwpIHtcbiAgICAgICAgICAgICAgICBvcHRpb25zLnVybCA9IHdpbmRvdy5sb2NhdGlvbi50b1N0cmluZygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gUGFyYW1ldGVycyBQcmVmaXhcbiAgICAgICAgICAgIHZhciBwYXJhbXNQcmVmaXggPSBvcHRpb25zLnVybC5pbmRleE9mKCc/JykgPj0gMCA/ICcmJyA6ICc/JztcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBVQyBtZXRob2RcbiAgICAgICAgICAgIHZhciBfbWV0aG9kID0gb3B0aW9ucy5tZXRob2QudG9VcHBlckNhc2UoKTtcbiAgICAgICAgICAgIC8vIERhdGEgdG8gbW9kaWZ5IEdFVCBVUkxcbiAgICAgICAgICAgIGlmICgoX21ldGhvZCA9PT0gJ0dFVCcgfHwgX21ldGhvZCA9PT0gJ0hFQUQnIHx8IF9tZXRob2QgPT09ICdPUFRJT05TJyB8fCBfbWV0aG9kID09PSAnREVMRVRFJykgJiYgb3B0aW9ucy5kYXRhKSB7XG4gICAgICAgICAgICAgICAgdmFyIHN0cmluZ0RhdGE7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zLmRhdGEgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFNob3VsZCBiZSBrZXk9dmFsdWUgc3RyaW5nXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmRhdGEuaW5kZXhPZignPycpID49IDApIHN0cmluZ0RhdGEgPSBvcHRpb25zLmRhdGEuc3BsaXQoJz8nKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBzdHJpbmdEYXRhID0gb3B0aW9ucy5kYXRhO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gU2hvdWxkIGJlIGtleT12YWx1ZSBvYmplY3RcbiAgICAgICAgICAgICAgICAgICAgc3RyaW5nRGF0YSA9ICQuc2VyaWFsaXplT2JqZWN0KG9wdGlvbnMuZGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzdHJpbmdEYXRhLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnVybCArPSBwYXJhbXNQcmVmaXggKyBzdHJpbmdEYXRhO1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW1zUHJlZml4ID09PSAnPycpIHBhcmFtc1ByZWZpeCA9ICcmJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBKU09OUFxuICAgICAgICAgICAgaWYgKG9wdGlvbnMuZGF0YVR5cGUgPT09ICdqc29uJyAmJiBvcHRpb25zLnVybC5pbmRleE9mKCdjYWxsYmFjaz0nKSA+PSAwKSB7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja05hbWUgPSAnZjdqc29ucF8nICsgRGF0ZS5ub3coKSArIChfanNvbnBSZXF1ZXN0cysrKTtcbiAgICAgICAgICAgICAgICB2YXIgYWJvcnRUaW1lb3V0O1xuICAgICAgICAgICAgICAgIHZhciBjYWxsYmFja1NwbGl0ID0gb3B0aW9ucy51cmwuc3BsaXQoJ2NhbGxiYWNrPScpO1xuICAgICAgICAgICAgICAgIHZhciByZXF1ZXN0VXJsID0gY2FsbGJhY2tTcGxpdFswXSArICdjYWxsYmFjaz0nICsgY2FsbGJhY2tOYW1lO1xuICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja1NwbGl0WzFdLmluZGV4T2YoJyYnKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBhZGRWYXJzID0gY2FsbGJhY2tTcGxpdFsxXS5zcGxpdCgnJicpLmZpbHRlcihmdW5jdGlvbiAoZWwpIHsgcmV0dXJuIGVsLmluZGV4T2YoJz0nKSA+IDA7IH0pLmpvaW4oJyYnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFkZFZhcnMubGVuZ3RoID4gMCkgcmVxdWVzdFVybCArPSAnJicgKyBhZGRWYXJzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gQ3JlYXRlIHNjcmlwdFxuICAgICAgICAgICAgICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICAgICAgICAgICAgICBzY3JpcHQudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnO1xuICAgICAgICAgICAgICAgIHNjcmlwdC5vbmVycm9yID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChhYm9ydFRpbWVvdXQpO1xuICAgICAgICAgICAgICAgICAgICBmaXJlQWpheENhbGxiYWNrKHVuZGVmaW5lZCwgdW5kZWZpbmVkLCAnZXJyb3InLCBudWxsLCAnc2NyaXB0ZXJyb3InKTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHNjcmlwdC5zcmMgPSByZXF1ZXN0VXJsO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBIYW5kbGVyXG4gICAgICAgICAgICAgICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoYWJvcnRUaW1lb3V0KTtcbiAgICAgICAgICAgICAgICAgICAgZmlyZUFqYXhDYWxsYmFjayh1bmRlZmluZWQsIHVuZGVmaW5lZCwgJ3N1Y2Nlc3MnLCBkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgc2NyaXB0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc2NyaXB0KTtcbiAgICAgICAgICAgICAgICAgICAgc2NyaXB0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHdpbmRvd1tjYWxsYmFja05hbWVdO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaGVhZCcpLmFwcGVuZENoaWxkKHNjcmlwdCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnRpbWVvdXQgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGFib3J0VGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc2NyaXB0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmlwdCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICBmaXJlQWpheENhbGxiYWNrKHVuZGVmaW5lZCwgdW5kZWZpbmVkLCAnZXJyb3InLCBudWxsLCAndGltZW91dCcpO1xuICAgICAgICAgICAgICAgICAgICB9LCBvcHRpb25zLnRpbWVvdXQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIENhY2hlIGZvciBHRVQvSEVBRCByZXF1ZXN0c1xuICAgICAgICAgICAgaWYgKF9tZXRob2QgPT09ICdHRVQnIHx8IF9tZXRob2QgPT09ICdIRUFEJyB8fCBfbWV0aG9kID09PSAnT1BUSU9OUycgfHwgX21ldGhvZCA9PT0gJ0RFTEVURScpIHtcbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5jYWNoZSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy51cmwgKz0gKHBhcmFtc1ByZWZpeCArICdfbm9jYWNoZT0nICsgRGF0ZS5ub3coKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIENyZWF0ZSBYSFJcbiAgICAgICAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTYXZlIFJlcXVlc3QgVVJMXG4gICAgICAgICAgICB4aHIucmVxdWVzdFVybCA9IG9wdGlvbnMudXJsO1xuICAgICAgICAgICAgeGhyLnJlcXVlc3RQYXJhbWV0ZXJzID0gb3B0aW9ucztcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBPcGVuIFhIUlxuICAgICAgICAgICAgeGhyLm9wZW4oX21ldGhvZCwgb3B0aW9ucy51cmwsIG9wdGlvbnMuYXN5bmMsIG9wdGlvbnMudXNlciwgb3B0aW9ucy5wYXNzd29yZCk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ3JlYXRlIFBPU1QgRGF0YVxuICAgICAgICAgICAgdmFyIHBvc3REYXRhID0gbnVsbDtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoKF9tZXRob2QgPT09ICdQT1NUJyB8fCBfbWV0aG9kID09PSAnUFVUJyB8fCBfbWV0aG9kID09PSAnUEFUQ0gnKSAmJiBvcHRpb25zLmRhdGEpIHtcbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5wcm9jZXNzRGF0YSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcG9zdERhdGFJbnN0YW5jZXMgPSBbQXJyYXlCdWZmZXIsIEJsb2IsIERvY3VtZW50LCBGb3JtRGF0YV07XG4gICAgICAgICAgICAgICAgICAgIC8vIFBvc3QgRGF0YVxuICAgICAgICAgICAgICAgICAgICBpZiAocG9zdERhdGFJbnN0YW5jZXMuaW5kZXhPZihvcHRpb25zLmRhdGEuY29uc3RydWN0b3IpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvc3REYXRhID0gb3B0aW9ucy5kYXRhO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUE9TVCBIZWFkZXJzXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgYm91bmRhcnkgPSAnLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJyArIERhdGUubm93KCkudG9TdHJpbmcoMTYpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRlbnRUeXBlID09PSAnbXVsdGlwYXJ0XFwvZm9ybS1kYXRhJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAnbXVsdGlwYXJ0XFwvZm9ybS1kYXRhOyBib3VuZGFyeT0nICsgYm91bmRhcnkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtVHlwZScsIG9wdGlvbnMuY29udGVudFR5cGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcG9zdERhdGEgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfZGF0YSA9ICQuc2VyaWFsaXplT2JqZWN0KG9wdGlvbnMuZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5jb250ZW50VHlwZSA9PT0gJ211bHRpcGFydFxcL2Zvcm0tZGF0YScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBib3VuZGFyeSA9ICctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0nICsgRGF0ZS5ub3coKS50b1N0cmluZygxNik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX2RhdGEgPSBfZGF0YS5zcGxpdCgnJicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBfbmV3RGF0YSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgX2RhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX25ld0RhdGEucHVzaCgnQ29udGVudC1EaXNwb3NpdGlvbjogZm9ybS1kYXRhOyBuYW1lPVwiJyArIF9kYXRhW2ldLnNwbGl0KCc9JylbMF0gKyAnXCJcXHJcXG5cXHJcXG4nICsgX2RhdGFbaV0uc3BsaXQoJz0nKVsxXSArICdcXHJcXG4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zdERhdGEgPSAnLS0nICsgYm91bmRhcnkgKyAnXFxyXFxuJyArIF9uZXdEYXRhLmpvaW4oJy0tJyArIGJvdW5kYXJ5ICsgJ1xcclxcbicpICsgJy0tJyArIGJvdW5kYXJ5ICsgJy0tXFxyXFxuJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3REYXRhID0gb3B0aW9ucy5jb250ZW50VHlwZSA9PT0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcgPyBfZGF0YSA6IF9kYXRhLnJlcGxhY2UoLyYvZywgJ1xcclxcbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwb3N0RGF0YSA9IG9wdGlvbnMuZGF0YTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIEFkZGl0aW9uYWwgaGVhZGVyc1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMuaGVhZGVycykge1xuICAgICAgICAgICAgICAgICQuZWFjaChvcHRpb25zLmhlYWRlcnMsIGZ1bmN0aW9uIChoZWFkZXJOYW1lLCBoZWFkZXJDYWxsYmFjaykge1xuICAgICAgICAgICAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcihoZWFkZXJOYW1lLCBoZWFkZXJDYWxsYmFjayk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIGNyb3NzRG9tYWluXG4gICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuY3Jvc3NEb21haW4gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgb3B0aW9ucy5jcm9zc0RvbWFpbiA9IC9eKFtcXHctXSs6KT9cXC9cXC8oW15cXC9dKykvLnRlc3Qob3B0aW9ucy51cmwpICYmIFJlZ0V4cC4kMiAhPT0gd2luZG93LmxvY2F0aW9uLmhvc3Q7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKCFvcHRpb25zLmNyb3NzRG9tYWluKSB7XG4gICAgICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtUmVxdWVzdGVkLVdpdGgnLCAnWE1MSHR0cFJlcXVlc3QnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAob3B0aW9ucy54aHJGaWVsZHMpIHtcbiAgICAgICAgICAgICAgICAkLmVhY2gob3B0aW9ucy54aHJGaWVsZHMsIGZ1bmN0aW9uIChmaWVsZE5hbWUsIGZpZWxkVmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgeGhyW2ZpZWxkTmFtZV0gPSBmaWVsZFZhbHVlO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIHZhciB4aHJUaW1lb3V0O1xuICAgICAgICAgICAgLy8gSGFuZGxlIFhIUlxuICAgICAgICAgICAgeGhyLm9ubG9hZCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHhoclRpbWVvdXQpIGNsZWFyVGltZW91dCh4aHJUaW1lb3V0KTtcbiAgICAgICAgICAgICAgICBpZiAoKHhoci5zdGF0dXMgPj0gMjAwICYmIHhoci5zdGF0dXMgPCAzMDApIHx8IHhoci5zdGF0dXMgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlc3BvbnNlRGF0YTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZGF0YVR5cGUgPT09ICdqc29uJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZURhdGEgPSBKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcmVBamF4Q2FsbGJhY2soJ2FqYXhTdWNjZXNzJywge3hocjogeGhyfSwgJ3N1Y2Nlc3MnLCByZXNwb25zZURhdGEsIHhoci5zdGF0dXMsIHhocik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyZUFqYXhDYWxsYmFjaygnYWpheEVycm9yJywge3hocjogeGhyLCBwYXJzZWVycm9yOiB0cnVlfSwgJ2Vycm9yJywgeGhyLCAncGFyc2VlcnJvcicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VEYXRhID0geGhyLnJlc3BvbnNlVHlwZSA9PT0gJ3RleHQnIHx8IHhoci5yZXNwb25zZVR5cGUgPT09ICcnID8geGhyLnJlc3BvbnNlVGV4dCA6IHhoci5yZXNwb25zZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpcmVBamF4Q2FsbGJhY2soJ2FqYXhTdWNjZXNzJywge3hocjogeGhyfSwgJ3N1Y2Nlc3MnLCByZXNwb25zZURhdGEsIHhoci5zdGF0dXMsIHhocik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZpcmVBamF4Q2FsbGJhY2soJ2FqYXhFcnJvcicsIHt4aHI6IHhocn0sICdlcnJvcicsIHhociwgeGhyLnN0YXR1cyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnN0YXR1c0NvZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGdsb2JhbEFqYXhPcHRpb25zLnN0YXR1c0NvZGUgJiYgZ2xvYmFsQWpheE9wdGlvbnMuc3RhdHVzQ29kZVt4aHIuc3RhdHVzXSkgZ2xvYmFsQWpheE9wdGlvbnMuc3RhdHVzQ29kZVt4aHIuc3RhdHVzXSh4aHIpO1xuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5zdGF0dXNDb2RlW3hoci5zdGF0dXNdKSBvcHRpb25zLnN0YXR1c0NvZGVbeGhyLnN0YXR1c10oeGhyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZmlyZUFqYXhDYWxsYmFjaygnYWpheENvbXBsZXRlJywge3hocjogeGhyfSwgJ2NvbXBsZXRlJywgeGhyLCB4aHIuc3RhdHVzKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgeGhyLm9uZXJyb3IgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGlmICh4aHJUaW1lb3V0KSBjbGVhclRpbWVvdXQoeGhyVGltZW91dCk7XG4gICAgICAgICAgICAgICAgZmlyZUFqYXhDYWxsYmFjaygnYWpheEVycm9yJywge3hocjogeGhyfSwgJ2Vycm9yJywgeGhyLCB4aHIuc3RhdHVzKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQWpheCBzdGFydCBjYWxsYmFja1xuICAgICAgICAgICAgZmlyZUFqYXhDYWxsYmFjaygnYWpheFN0YXJ0Jywge3hocjogeGhyfSwgJ3N0YXJ0JywgeGhyKTtcbiAgICAgICAgICAgIGZpcmVBamF4Q2FsbGJhY2sodW5kZWZpbmVkLCB1bmRlZmluZWQsICdiZWZvcmVTZW5kJywgeGhyKTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2VuZCBYSFJcbiAgICAgICAgICAgIHhoci5zZW5kKHBvc3REYXRhKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBUaW1lb3V0XG4gICAgICAgICAgICBpZiAob3B0aW9ucy50aW1lb3V0ID4gMCkge1xuICAgICAgICAgICAgICAgIHhoci5vbmFib3J0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoeGhyVGltZW91dCkgY2xlYXJUaW1lb3V0KHhoclRpbWVvdXQpO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgeGhyVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB4aHIuYWJvcnQoKTtcbiAgICAgICAgICAgICAgICAgICAgZmlyZUFqYXhDYWxsYmFjaygnYWpheEVycm9yJywge3hocjogeGhyLCB0aW1lb3V0OiB0cnVlfSwgJ2Vycm9yJywgeGhyLCAndGltZW91dCcpO1xuICAgICAgICAgICAgICAgICAgICBmaXJlQWpheENhbGxiYWNrKCdhamF4Q29tcGxldGUnLCB7eGhyOiB4aHIsIHRpbWVvdXQ6IHRydWV9LCAnY29tcGxldGUnLCB4aHIsICd0aW1lb3V0Jyk7XG4gICAgICAgICAgICAgICAgfSwgb3B0aW9ucy50aW1lb3V0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBSZXR1cm4gWEhSIG9iamVjdFxuICAgICAgICAgICAgcmV0dXJuIHhocjtcbiAgICAgICAgfTtcbiAgICAgICAgLy8gU2hyb3RjdXRzXG4gICAgICAgIChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgbWV0aG9kcyA9ICgnZ2V0IHBvc3QgZ2V0SlNPTicpLnNwbGl0KCcgJyk7XG4gICAgICAgICAgICBmdW5jdGlvbiBjcmVhdGVNZXRob2QobWV0aG9kKSB7XG4gICAgICAgICAgICAgICAgJFttZXRob2RdID0gZnVuY3Rpb24gKHVybCwgZGF0YSwgc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJC5hamF4KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsLFxuICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QgPT09ICdwb3N0JyA/ICdQT1NUJyA6ICdHRVQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogdHlwZW9mIGRhdGEgPT09ICdmdW5jdGlvbicgPyB1bmRlZmluZWQgOiBkYXRhLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogdHlwZW9mIGRhdGEgPT09ICdmdW5jdGlvbicgPyBkYXRhIDogc3VjY2VzcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiBtZXRob2QgPT09ICdnZXRKU09OJyA/ICdqc29uJyA6IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZXRob2RzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY3JlYXRlTWV0aG9kKG1ldGhvZHNbaV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KSgpO1xuICAgICAgICBcblxuICAgICAgICAvLyBET00gTGlicmFyeSBVdGlsaXRlc1xuICAgICAgICAkLnBhcnNlVXJsUXVlcnkgPSBmdW5jdGlvbiAodXJsKSB7XG4gICAgICAgICAgICB2YXIgcXVlcnkgPSB7fSwgaSwgcGFyYW1zLCBwYXJhbTtcbiAgICAgICAgICAgIGlmICh1cmwuaW5kZXhPZignPycpID49IDApIHVybCA9IHVybC5zcGxpdCgnPycpWzFdO1xuICAgICAgICAgICAgZWxzZSByZXR1cm4gcXVlcnk7XG4gICAgICAgICAgICBwYXJhbXMgPSB1cmwuc3BsaXQoJyYnKTtcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwYXJhbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBwYXJhbSA9IHBhcmFtc1tpXS5zcGxpdCgnPScpO1xuICAgICAgICAgICAgICAgIHF1ZXJ5W3BhcmFtWzBdXSA9IHBhcmFtWzFdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHF1ZXJ5O1xuICAgICAgICB9O1xuICAgICAgICAkLmlzQXJyYXkgPSBmdW5jdGlvbiAoYXJyKSB7XG4gICAgICAgICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5hcHBseShhcnIpID09PSAnW29iamVjdCBBcnJheV0nKSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIGVsc2UgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9O1xuICAgICAgICAkLmVhY2ggPSBmdW5jdGlvbiAob2JqLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoIWNhbGxiYWNrKSByZXR1cm47XG4gICAgICAgICAgICB2YXIgaSwgcHJvcDtcbiAgICAgICAgICAgIGlmICgkLmlzQXJyYXkob2JqKSB8fCBvYmogaW5zdGFuY2VvZiBEb203KSB7XG4gICAgICAgICAgICAgICAgLy8gQXJyYXlcbiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgb2JqLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGksIG9ialtpXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gT2JqZWN0XG4gICAgICAgICAgICAgICAgZm9yIChwcm9wIGluIG9iaikge1xuICAgICAgICAgICAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KHByb3ApKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhwcm9wLCBvYmpbcHJvcF0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICAkLnVuaXF1ZSA9IGZ1bmN0aW9uIChhcnIpIHtcbiAgICAgICAgICAgIHZhciB1bmlxdWUgPSBbXTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJyLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHVuaXF1ZS5pbmRleE9mKGFycltpXSkgPT09IC0xKSB1bmlxdWUucHVzaChhcnJbaV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHVuaXF1ZTtcbiAgICAgICAgfTtcbiAgICAgICAgJC5zZXJpYWxpemVPYmplY3QgPSAkLnBhcmFtID0gZnVuY3Rpb24gKG9iaiwgcGFyZW50cykge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmogPT09ICdzdHJpbmcnKSByZXR1cm4gb2JqO1xuICAgICAgICAgICAgdmFyIHJlc3VsdEFycmF5ID0gW107XG4gICAgICAgICAgICB2YXIgc2VwYXJhdG9yID0gJyYnO1xuICAgICAgICAgICAgcGFyZW50cyA9IHBhcmVudHMgfHwgW107XG4gICAgICAgICAgICB2YXIgbmV3UGFyZW50cztcbiAgICAgICAgICAgIGZ1bmN0aW9uIHZhcl9uYW1lKG5hbWUpIHtcbiAgICAgICAgICAgICAgICBpZiAocGFyZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBfcGFyZW50cyA9ICcnO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHBhcmVudHMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqID09PSAwKSBfcGFyZW50cyArPSBwYXJlbnRzW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBfcGFyZW50cyArPSAnWycgKyBlbmNvZGVVUklDb21wb25lbnQocGFyZW50c1tqXSkgKyAnXSc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9wYXJlbnRzICsgJ1snICsgZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpICsgJ10nO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudChuYW1lKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiB2YXJfdmFsdWUodmFsdWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gb2JqKSB7XG4gICAgICAgICAgICAgICAgaWYgKG9iai5oYXNPd25Qcm9wZXJ0eShwcm9wKSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdG9QdXNoO1xuICAgICAgICAgICAgICAgICAgICBpZiAoJC5pc0FycmF5KG9ialtwcm9wXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvUHVzaCA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvYmpbcHJvcF0ubGVuZ3RoOyBpICsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEkLmlzQXJyYXkob2JqW3Byb3BdW2ldKSAmJiB0eXBlb2Ygb2JqW3Byb3BdW2ldID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdQYXJlbnRzID0gcGFyZW50cy5zbGljZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdQYXJlbnRzLnB1c2gocHJvcCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhcmVudHMucHVzaChpICsgJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b1B1c2gucHVzaCgkLnNlcmlhbGl6ZU9iamVjdChvYmpbcHJvcF1baV0sIG5ld1BhcmVudHMpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvUHVzaC5wdXNoKHZhcl9uYW1lKHByb3ApICsgJ1tdPScgKyB2YXJfdmFsdWUob2JqW3Byb3BdW2ldKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRvUHVzaC5sZW5ndGggPiAwKSByZXN1bHRBcnJheS5wdXNoKHRvUHVzaC5qb2luKHNlcGFyYXRvcikpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiBvYmpbcHJvcF0gPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBPYmplY3QsIGNvbnZlcnQgdG8gbmFtZWQgYXJyYXlcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhcmVudHMgPSBwYXJlbnRzLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdQYXJlbnRzLnB1c2gocHJvcCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0b1B1c2ggPSAkLnNlcmlhbGl6ZU9iamVjdChvYmpbcHJvcF0sIG5ld1BhcmVudHMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRvUHVzaCAhPT0gJycpIHJlc3VsdEFycmF5LnB1c2godG9QdXNoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0eXBlb2Ygb2JqW3Byb3BdICE9PSAndW5kZWZpbmVkJyAmJiBvYmpbcHJvcF0gIT09ICcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBTaG91bGQgYmUgc3RyaW5nIG9yIHBsYWluIHZhbHVlXG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRBcnJheS5wdXNoKHZhcl9uYW1lKHByb3ApICsgJz0nICsgdmFyX3ZhbHVlKG9ialtwcm9wXSkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdEFycmF5LmpvaW4oc2VwYXJhdG9yKTtcbiAgICAgICAgfTtcbiAgICAgICAgJC50b0NhbWVsQ2FzZSA9IGZ1bmN0aW9uIChzdHJpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiBzdHJpbmcudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC8tKC4pL2csIGZ1bmN0aW9uKG1hdGNoLCBncm91cDEpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZ3JvdXAxLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgJC5kYXRhc2V0ID0gZnVuY3Rpb24gKGVsKSB7XG4gICAgICAgICAgICByZXR1cm4gJChlbCkuZGF0YXNldCgpO1xuICAgICAgICB9O1xuICAgICAgICAkLmdldFRyYW5zbGF0ZSA9IGZ1bmN0aW9uIChlbCwgYXhpcykge1xuICAgICAgICAgICAgdmFyIG1hdHJpeCwgY3VyVHJhbnNmb3JtLCBjdXJTdHlsZSwgdHJhbnNmb3JtTWF0cml4O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIGF1dG9tYXRpYyBheGlzIGRldGVjdGlvblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBheGlzID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIGF4aXMgPSAneCc7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgY3VyU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbCwgbnVsbCk7XG4gICAgICAgICAgICBpZiAod2luZG93LldlYktpdENTU01hdHJpeCkge1xuICAgICAgICAgICAgICAgIGN1clRyYW5zZm9ybSA9IGN1clN0eWxlLnRyYW5zZm9ybSB8fCBjdXJTdHlsZS53ZWJraXRUcmFuc2Zvcm07XG4gICAgICAgICAgICAgICAgaWYgKGN1clRyYW5zZm9ybS5zcGxpdCgnLCcpLmxlbmd0aCA+IDYpIHtcbiAgICAgICAgICAgICAgICAgICAgY3VyVHJhbnNmb3JtID0gY3VyVHJhbnNmb3JtLnNwbGl0KCcsICcpLm1hcChmdW5jdGlvbihhKXtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhLnJlcGxhY2UoJywnLCcuJyk7XG4gICAgICAgICAgICAgICAgICAgIH0pLmpvaW4oJywgJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIFNvbWUgb2xkIHZlcnNpb25zIG9mIFdlYmtpdCBjaG9rZSB3aGVuICdub25lJyBpcyBwYXNzZWQ7IHBhc3NcbiAgICAgICAgICAgICAgICAvLyBlbXB0eSBzdHJpbmcgaW5zdGVhZCBpbiB0aGlzIGNhc2VcbiAgICAgICAgICAgICAgICB0cmFuc2Zvcm1NYXRyaXggPSBuZXcgV2ViS2l0Q1NTTWF0cml4KGN1clRyYW5zZm9ybSA9PT0gJ25vbmUnID8gJycgOiBjdXJUcmFuc2Zvcm0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdHJhbnNmb3JtTWF0cml4ID0gY3VyU3R5bGUuTW96VHJhbnNmb3JtIHx8IGN1clN0eWxlLk9UcmFuc2Zvcm0gfHwgY3VyU3R5bGUuTXNUcmFuc2Zvcm0gfHwgY3VyU3R5bGUubXNUcmFuc2Zvcm0gIHx8IGN1clN0eWxlLnRyYW5zZm9ybSB8fCBjdXJTdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCd0cmFuc2Zvcm0nKS5yZXBsYWNlKCd0cmFuc2xhdGUoJywgJ21hdHJpeCgxLCAwLCAwLCAxLCcpO1xuICAgICAgICAgICAgICAgIG1hdHJpeCA9IHRyYW5zZm9ybU1hdHJpeC50b1N0cmluZygpLnNwbGl0KCcsJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKGF4aXMgPT09ICd4Jykge1xuICAgICAgICAgICAgICAgIC8vTGF0ZXN0IENocm9tZSBhbmQgd2Via2l0cyBGaXhcbiAgICAgICAgICAgICAgICBpZiAod2luZG93LldlYktpdENTU01hdHJpeClcbiAgICAgICAgICAgICAgICAgICAgY3VyVHJhbnNmb3JtID0gdHJhbnNmb3JtTWF0cml4Lm00MTtcbiAgICAgICAgICAgICAgICAvL0NyYXp5IElFMTAgTWF0cml4XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAobWF0cml4Lmxlbmd0aCA9PT0gMTYpXG4gICAgICAgICAgICAgICAgICAgIGN1clRyYW5zZm9ybSA9IHBhcnNlRmxvYXQobWF0cml4WzEyXSk7XG4gICAgICAgICAgICAgICAgLy9Ob3JtYWwgQnJvd3NlcnNcbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIGN1clRyYW5zZm9ybSA9IHBhcnNlRmxvYXQobWF0cml4WzRdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChheGlzID09PSAneScpIHtcbiAgICAgICAgICAgICAgICAvL0xhdGVzdCBDaHJvbWUgYW5kIHdlYmtpdHMgRml4XG4gICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5XZWJLaXRDU1NNYXRyaXgpXG4gICAgICAgICAgICAgICAgICAgIGN1clRyYW5zZm9ybSA9IHRyYW5zZm9ybU1hdHJpeC5tNDI7XG4gICAgICAgICAgICAgICAgLy9DcmF6eSBJRTEwIE1hdHJpeFxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1hdHJpeC5sZW5ndGggPT09IDE2KVxuICAgICAgICAgICAgICAgICAgICBjdXJUcmFuc2Zvcm0gPSBwYXJzZUZsb2F0KG1hdHJpeFsxM10pO1xuICAgICAgICAgICAgICAgIC8vTm9ybWFsIEJyb3dzZXJzXG4gICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICBjdXJUcmFuc2Zvcm0gPSBwYXJzZUZsb2F0KG1hdHJpeFs1XSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBjdXJUcmFuc2Zvcm0gfHwgMDtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICQucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICBpZiAod2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSkgcmV0dXJuIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoY2FsbGJhY2spO1xuICAgICAgICAgICAgZWxzZSBpZiAod2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSkgcmV0dXJuIHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUoY2FsbGJhY2spO1xuICAgICAgICAgICAgZWxzZSBpZiAod2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZSkgcmV0dXJuIHdpbmRvdy5tb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWUoY2FsbGJhY2spO1xuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy5zZXRUaW1lb3V0KGNhbGxiYWNrLCAxMDAwIC8gNjApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICAkLmNhbmNlbEFuaW1hdGlvbkZyYW1lID0gZnVuY3Rpb24gKGlkKSB7XG4gICAgICAgICAgICBpZiAod2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lKSByZXR1cm4gd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lKGlkKTtcbiAgICAgICAgICAgIGVsc2UgaWYgKHdpbmRvdy53ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZSkgcmV0dXJuIHdpbmRvdy53ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZShpZCk7XG4gICAgICAgICAgICBlbHNlIGlmICh3aW5kb3cubW96Q2FuY2VsQW5pbWF0aW9uRnJhbWUpIHJldHVybiB3aW5kb3cubW96Q2FuY2VsQW5pbWF0aW9uRnJhbWUoaWQpO1xuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy5jbGVhclRpbWVvdXQoaWQpO1xuICAgICAgICAgICAgfSAgXG4gICAgICAgIH07XG4gICAgICAgICQuc3VwcG9ydFRvdWNoID0gISEoKCdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdykgfHwgd2luZG93LkRvY3VtZW50VG91Y2ggJiYgZG9jdW1lbnQgaW5zdGFuY2VvZiBEb2N1bWVudFRvdWNoKTtcbiAgICAgICAgXG4gICAgICAgIC8vIExpbmsgdG8gcHJvdG90eXBlXG4gICAgICAgICQuZm4gPSBEb203LnByb3RvdHlwZTtcbiAgICAgICAgXG4gICAgICAgIC8vIFBsdWdpbnNcbiAgICAgICAgJC5mbi5zY3JvbGxUbyA9IGZ1bmN0aW9uIChsZWZ0LCB0b3AsIGR1cmF0aW9uLCBlYXNpbmcsIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gNCAmJiB0eXBlb2YgZWFzaW5nID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBlYXNpbmc7XG4gICAgICAgICAgICAgICAgZWFzaW5nID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGVsID0gdGhpcztcbiAgICAgICAgICAgICAgICB2YXIgY3VycmVudFRvcCwgY3VycmVudExlZnQsIG1heFRvcCwgbWF4TGVmdCwgbmV3VG9wLCBuZXdMZWZ0LCBzY3JvbGxUb3AsIHNjcm9sbExlZnQ7XG4gICAgICAgICAgICAgICAgdmFyIGFuaW1hdGVUb3AgPSB0b3AgPiAwIHx8IHRvcCA9PT0gMDtcbiAgICAgICAgICAgICAgICB2YXIgYW5pbWF0ZUxlZnQgPSBsZWZ0ID4gMCB8fCBsZWZ0ID09PSAwO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZWFzaW5nID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBlYXNpbmcgPSAnc3dpbmcnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoYW5pbWF0ZVRvcCkge1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50VG9wID0gZWwuc2Nyb2xsVG9wO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWR1cmF0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbC5zY3JvbGxUb3AgPSB0b3A7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFuaW1hdGVMZWZ0KSB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRMZWZ0ID0gZWwuc2Nyb2xsTGVmdDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFkdXJhdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2Nyb2xsTGVmdCA9IGxlZnQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFkdXJhdGlvbikgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmIChhbmltYXRlVG9wKSB7XG4gICAgICAgICAgICAgICAgICAgIG1heFRvcCA9IGVsLnNjcm9sbEhlaWdodCAtIGVsLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgbmV3VG9wID0gTWF0aC5tYXgoTWF0aC5taW4odG9wLCBtYXhUb3ApLCAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFuaW1hdGVMZWZ0KSB7XG4gICAgICAgICAgICAgICAgICAgIG1heExlZnQgPSBlbC5zY3JvbGxXaWR0aCAtIGVsLm9mZnNldFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICBuZXdMZWZ0ID0gTWF0aC5tYXgoTWF0aC5taW4obGVmdCwgbWF4TGVmdCksIDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgc3RhcnRUaW1lID0gbnVsbDtcbiAgICAgICAgICAgICAgICBpZiAoYW5pbWF0ZVRvcCAmJiBuZXdUb3AgPT09IGN1cnJlbnRUb3ApIGFuaW1hdGVUb3AgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAoYW5pbWF0ZUxlZnQgJiYgbmV3TGVmdCA9PT0gY3VycmVudExlZnQpIGFuaW1hdGVMZWZ0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVuZGVyKHRpbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRpbWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdGFydFRpbWUgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0VGltZSA9IHRpbWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIGRvbmVMZWZ0LCBkb25lVG9wLCBkb25lO1xuICAgICAgICAgICAgICAgICAgICB2YXIgcHJvZ3Jlc3MgPSBNYXRoLm1heChNYXRoLm1pbigodGltZSAtIHN0YXJ0VGltZSkgLyBkdXJhdGlvbiwgMSksIDApO1xuICAgICAgICAgICAgICAgICAgICB2YXIgZWFzZVByb2dyZXNzID0gZWFzaW5nID09PSAnbGluZWFyJyA/IHByb2dyZXNzIDogKDAuNSAtIE1hdGguY29zKCBwcm9ncmVzcyAqIE1hdGguUEkgKSAvIDIpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYW5pbWF0ZVRvcCkgc2Nyb2xsVG9wID0gY3VycmVudFRvcCArIChlYXNlUHJvZ3Jlc3MgKiAobmV3VG9wIC0gY3VycmVudFRvcCkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYW5pbWF0ZUxlZnQpIHNjcm9sbExlZnQgPSBjdXJyZW50TGVmdCArIChlYXNlUHJvZ3Jlc3MgKiAobmV3TGVmdCAtIGN1cnJlbnRMZWZ0KSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhbmltYXRlVG9wICYmIG5ld1RvcCA+IGN1cnJlbnRUb3AgJiYgc2Nyb2xsVG9wID49IG5ld1RvcCkgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNjcm9sbFRvcCA9IG5ld1RvcDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChhbmltYXRlVG9wICYmIG5ld1RvcCA8IGN1cnJlbnRUb3AgJiYgc2Nyb2xsVG9wIDw9IG5ld1RvcCkgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNjcm9sbFRvcCA9IG5ld1RvcDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoYW5pbWF0ZUxlZnQgJiYgbmV3TGVmdCA+IGN1cnJlbnRMZWZ0ICYmIHNjcm9sbExlZnQgPj0gbmV3TGVmdCkgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNjcm9sbExlZnQgPSBuZXdMZWZ0O1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFuaW1hdGVMZWZ0ICYmIG5ld0xlZnQgPCBjdXJyZW50TGVmdCAmJiBzY3JvbGxMZWZ0IDw9IG5ld0xlZnQpICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbC5zY3JvbGxMZWZ0ID0gbmV3TGVmdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoZG9uZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjaygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChhbmltYXRlVG9wKSBlbC5zY3JvbGxUb3AgPSBzY3JvbGxUb3A7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhbmltYXRlTGVmdCkgZWwuc2Nyb2xsTGVmdCA9IHNjcm9sbExlZnQ7XG4gICAgICAgICAgICAgICAgICAgICQucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHJlbmRlcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICQucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHJlbmRlcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgJC5mbi5zY3JvbGxUb3AgPSBmdW5jdGlvbiAodG9wLCBkdXJhdGlvbiwgZWFzaW5nLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDMgJiYgdHlwZW9mIGVhc2luZyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZWFzaW5nO1xuICAgICAgICAgICAgICAgIGVhc2luZyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBkb20gPSB0aGlzO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB0b3AgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgaWYgKGRvbS5sZW5ndGggPiAwKSByZXR1cm4gZG9tWzBdLnNjcm9sbFRvcDtcbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGRvbS5zY3JvbGxUbyh1bmRlZmluZWQsIHRvcCwgZHVyYXRpb24sIGVhc2luZywgY2FsbGJhY2spO1xuICAgICAgICB9O1xuICAgICAgICAkLmZuLnNjcm9sbExlZnQgPSBmdW5jdGlvbiAobGVmdCwgZHVyYXRpb24sIGVhc2luZywgY2FsbGJhY2spIHtcbiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAzICYmIHR5cGVvZiBlYXNpbmcgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGVhc2luZztcbiAgICAgICAgICAgICAgICBlYXNpbmcgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgZG9tID0gdGhpcztcbiAgICAgICAgICAgIGlmICh0eXBlb2YgbGVmdCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBpZiAoZG9tLmxlbmd0aCA+IDApIHJldHVybiBkb21bMF0uc2Nyb2xsTGVmdDtcbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGRvbS5zY3JvbGxUbyhsZWZ0LCB1bmRlZmluZWQsIGR1cmF0aW9uLCBlYXNpbmcsIGNhbGxiYWNrKTtcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gJDtcbiAgICB9KSgpO1xuICAgIFxuICAgIC8vIEV4cG9ydCBEb203IHRvIEZyYW1ld29yazdcbiAgICBGcmFtZXdvcms3LiQgPSBEb203O1xuICAgIFxuICAgIC8vIEV4cG9ydCB0byBsb2NhbCBzY29wZVxuICAgIHZhciAkID0gRG9tNztcbiAgICBcbiAgICAvLyBFeHBvcnQgdG8gV2luZG93XG4gICAgd2luZG93LkRvbTcgPSBEb203O1xuICAgIFxuXG4gICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICBGZWF0dXJlcyBTdXBwb3J0IERldGVjdGlvblxuICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgRnJhbWV3b3JrNy5wcm90b3R5cGUuc3VwcG9ydCA9IChmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBzdXBwb3J0ID0ge1xuICAgICAgICAgICAgdG91Y2g6ICEhKCgnb250b3VjaHN0YXJ0JyBpbiB3aW5kb3cpIHx8IHdpbmRvdy5Eb2N1bWVudFRvdWNoICYmIGRvY3VtZW50IGluc3RhbmNlb2YgRG9jdW1lbnRUb3VjaClcbiAgICAgICAgfTtcbiAgICBcbiAgICAgICAgLy8gRXhwb3J0IG9iamVjdFxuICAgICAgICByZXR1cm4gc3VwcG9ydDtcbiAgICB9KSgpO1xuICAgIFxuXG4gICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICBEZXZpY2UvT1MgRGV0ZWN0aW9uXG4gICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICBGcmFtZXdvcms3LnByb3RvdHlwZS5kZXZpY2UgPSAoZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgZGV2aWNlID0ge307XG4gICAgICAgIHZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQ7XG4gICAgICAgIHZhciAkID0gRG9tNztcbiAgICBcbiAgICAgICAgdmFyIGFuZHJvaWQgPSB1YS5tYXRjaCgvKEFuZHJvaWQpOz9bXFxzXFwvXSsoW1xcZC5dKyk/Lyk7XG4gICAgICAgIHZhciBpcGFkID0gdWEubWF0Y2goLyhpUGFkKS4qT1NcXHMoW1xcZF9dKykvKTtcbiAgICAgICAgdmFyIGlwb2QgPSB1YS5tYXRjaCgvKGlQb2QpKC4qT1NcXHMoW1xcZF9dKykpPy8pO1xuICAgICAgICB2YXIgaXBob25lID0gIWlwYWQgJiYgdWEubWF0Y2goLyhpUGhvbmVcXHNPUylcXHMoW1xcZF9dKykvKTtcbiAgICBcbiAgICAgICAgZGV2aWNlLmlvcyA9IGRldmljZS5hbmRyb2lkID0gZGV2aWNlLmlwaG9uZSA9IGRldmljZS5pcGFkID0gZGV2aWNlLmFuZHJvaWRDaHJvbWUgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgIC8vIEFuZHJvaWRcbiAgICAgICAgaWYgKGFuZHJvaWQpIHtcbiAgICAgICAgICAgIGRldmljZS5vcyA9ICdhbmRyb2lkJztcbiAgICAgICAgICAgIGRldmljZS5vc1ZlcnNpb24gPSBhbmRyb2lkWzJdO1xuICAgICAgICAgICAgZGV2aWNlLmFuZHJvaWQgPSB0cnVlO1xuICAgICAgICAgICAgZGV2aWNlLmFuZHJvaWRDaHJvbWUgPSB1YS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJ2Nocm9tZScpID49IDA7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGlwYWQgfHwgaXBob25lIHx8IGlwb2QpIHtcbiAgICAgICAgICAgIGRldmljZS5vcyA9ICdpb3MnO1xuICAgICAgICAgICAgZGV2aWNlLmlvcyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgLy8gaU9TXG4gICAgICAgIGlmIChpcGhvbmUgJiYgIWlwb2QpIHtcbiAgICAgICAgICAgIGRldmljZS5vc1ZlcnNpb24gPSBpcGhvbmVbMl0ucmVwbGFjZSgvXy9nLCAnLicpO1xuICAgICAgICAgICAgZGV2aWNlLmlwaG9uZSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGlwYWQpIHtcbiAgICAgICAgICAgIGRldmljZS5vc1ZlcnNpb24gPSBpcGFkWzJdLnJlcGxhY2UoL18vZywgJy4nKTtcbiAgICAgICAgICAgIGRldmljZS5pcGFkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaXBvZCkge1xuICAgICAgICAgICAgZGV2aWNlLm9zVmVyc2lvbiA9IGlwb2RbM10gPyBpcG9kWzNdLnJlcGxhY2UoL18vZywgJy4nKSA6IG51bGw7XG4gICAgICAgICAgICBkZXZpY2UuaXBob25lID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICAvLyBpT1MgOCsgY2hhbmdlZCBVQVxuICAgICAgICBpZiAoZGV2aWNlLmlvcyAmJiBkZXZpY2Uub3NWZXJzaW9uICYmIHVhLmluZGV4T2YoJ1ZlcnNpb24vJykgPj0gMCkge1xuICAgICAgICAgICAgaWYgKGRldmljZS5vc1ZlcnNpb24uc3BsaXQoJy4nKVswXSA9PT0gJzEwJykge1xuICAgICAgICAgICAgICAgIGRldmljZS5vc1ZlcnNpb24gPSB1YS50b0xvd2VyQ2FzZSgpLnNwbGl0KCd2ZXJzaW9uLycpWzFdLnNwbGl0KCcgJylbMF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgLy8gV2Vidmlld1xuICAgICAgICBkZXZpY2Uud2ViVmlldyA9IChpcGhvbmUgfHwgaXBhZCB8fCBpcG9kKSAmJiB1YS5tYXRjaCgvLipBcHBsZVdlYktpdCg/IS4qU2FmYXJpKS9pKTtcbiAgICAgICAgICAgIFxuICAgICAgICAvLyBNaW5pbWFsIFVJXG4gICAgICAgIGlmIChkZXZpY2Uub3MgJiYgZGV2aWNlLm9zID09PSAnaW9zJykge1xuICAgICAgICAgICAgdmFyIG9zVmVyc2lvbkFyciA9IGRldmljZS5vc1ZlcnNpb24uc3BsaXQoJy4nKTtcbiAgICAgICAgICAgIGRldmljZS5taW5pbWFsVWkgPSAhZGV2aWNlLndlYlZpZXcgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKGlwb2QgfHwgaXBob25lKSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAob3NWZXJzaW9uQXJyWzBdICogMSA9PT0gNyA/IG9zVmVyc2lvbkFyclsxXSAqIDEgPj0gMSA6IG9zVmVyc2lvbkFyclswXSAqIDEgPiA3KSAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCdtZXRhW25hbWU9XCJ2aWV3cG9ydFwiXScpLmxlbmd0aCA+IDAgJiYgJCgnbWV0YVtuYW1lPVwidmlld3BvcnRcIl0nKS5hdHRyKCdjb250ZW50JykuaW5kZXhPZignbWluaW1hbC11aScpID49IDA7XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgLy8gQ2hlY2sgZm9yIHN0YXR1cyBiYXIgYW5kIGZ1bGxzY3JlZW4gYXBwIG1vZGVcbiAgICAgICAgdmFyIHdpbmRvd1dpZHRoID0gJCh3aW5kb3cpLndpZHRoKCk7XG4gICAgICAgIHZhciB3aW5kb3dIZWlnaHQgPSAkKHdpbmRvdykuaGVpZ2h0KCk7XG4gICAgICAgIGRldmljZS5zdGF0dXNCYXIgPSBmYWxzZTtcbiAgICAgICAgaWYgKGRldmljZS53ZWJWaWV3ICYmICh3aW5kb3dXaWR0aCAqIHdpbmRvd0hlaWdodCA9PT0gc2NyZWVuLndpZHRoICogc2NyZWVuLmhlaWdodCkpIHtcbiAgICAgICAgICAgIGRldmljZS5zdGF0dXNCYXIgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgZGV2aWNlLnN0YXR1c0JhciA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgXG4gICAgICAgIC8vIENsYXNzZXNcbiAgICAgICAgdmFyIGNsYXNzTmFtZXMgPSBbXTtcbiAgICBcbiAgICAgICAgLy8gUGl4ZWwgUmF0aW9cbiAgICAgICAgZGV2aWNlLnBpeGVsUmF0aW8gPSB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyB8fCAxO1xuICAgICAgICBjbGFzc05hbWVzLnB1c2goJ3BpeGVsLXJhdGlvLScgKyBNYXRoLmZsb29yKGRldmljZS5waXhlbFJhdGlvKSk7XG4gICAgICAgIGlmIChkZXZpY2UucGl4ZWxSYXRpbyA+PSAyKSB7XG4gICAgICAgICAgICBjbGFzc05hbWVzLnB1c2goJ3JldGluYScpO1xuICAgICAgICB9XG4gICAgXG4gICAgICAgIC8vIE9TIGNsYXNzZXNcbiAgICAgICAgaWYgKGRldmljZS5vcykge1xuICAgICAgICAgICAgY2xhc3NOYW1lcy5wdXNoKGRldmljZS5vcywgZGV2aWNlLm9zICsgJy0nICsgZGV2aWNlLm9zVmVyc2lvbi5zcGxpdCgnLicpWzBdLCBkZXZpY2Uub3MgKyAnLScgKyBkZXZpY2Uub3NWZXJzaW9uLnJlcGxhY2UoL1xcLi9nLCAnLScpKTtcbiAgICAgICAgICAgIGlmIChkZXZpY2Uub3MgPT09ICdpb3MnKSB7XG4gICAgICAgICAgICAgICAgdmFyIG1ham9yID0gcGFyc2VJbnQoZGV2aWNlLm9zVmVyc2lvbi5zcGxpdCgnLicpWzBdLCAxMCk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IG1ham9yIC0gMTsgaSA+PSA2OyBpLS0pIHtcbiAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lcy5wdXNoKCdpb3MtZ3QtJyArIGkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIC8vIFN0YXR1cyBiYXIgY2xhc3Nlc1xuICAgICAgICBpZiAoZGV2aWNlLnN0YXR1c0Jhcikge1xuICAgICAgICAgICAgY2xhc3NOYW1lcy5wdXNoKCd3aXRoLXN0YXR1c2Jhci1vdmVybGF5Jyk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAkKCdodG1sJykucmVtb3ZlQ2xhc3MoJ3dpdGgtc3RhdHVzYmFyLW92ZXJsYXknKTtcbiAgICAgICAgfVxuICAgIFxuICAgICAgICAvLyBBZGQgaHRtbCBjbGFzc2VzXG4gICAgICAgIGlmIChjbGFzc05hbWVzLmxlbmd0aCA+IDApICQoJ2h0bWwnKS5hZGRDbGFzcyhjbGFzc05hbWVzLmpvaW4oJyAnKSk7XG4gICAgXG4gICAgICAgIC8vIEV4cG9ydCBvYmplY3RcbiAgICAgICAgcmV0dXJuIGRldmljZTtcbiAgICB9KSgpO1xuICAgIFxuXG4gICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICBQbHVnaW5zIHByb3RvdHlwZVxuICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgRnJhbWV3b3JrNy5wcm90b3R5cGUucGx1Z2lucyA9IHt9O1xuICAgIFxuXG4gICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICBUZW1wbGF0ZTcgVGVtcGxhdGUgZW5naW5lXG4gICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICB3aW5kb3cuVGVtcGxhdGU3ID0gKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgZnVuY3Rpb24gaXNBcnJheShhcnIpIHtcbiAgICAgICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmFwcGx5KGFycikgPT09ICdbb2JqZWN0IEFycmF5XSc7XG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gaXNPYmplY3Qob2JqKSB7XG4gICAgICAgICAgICByZXR1cm4gb2JqIGluc3RhbmNlb2YgT2JqZWN0O1xuICAgICAgICB9XG4gICAgICAgIGZ1bmN0aW9uIGlzRnVuY3Rpb24oZnVuYykge1xuICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBmdW5jID09PSAnZnVuY3Rpb24nO1xuICAgICAgICB9XG4gICAgICAgIHZhciBjYWNoZSA9IHt9O1xuICAgICAgICBmdW5jdGlvbiBoZWxwZXJUb1NsaWNlcyhzdHJpbmcpIHtcbiAgICAgICAgICAgIHZhciBoZWxwZXJQYXJ0cyA9IHN0cmluZy5yZXBsYWNlKC9be30jfV0vZywgJycpLnNwbGl0KCcgJyk7XG4gICAgICAgICAgICB2YXIgc2xpY2VzID0gW107XG4gICAgICAgICAgICB2YXIgc2hpZnRJbmRleCwgaSwgajtcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBoZWxwZXJQYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciBwYXJ0ID0gaGVscGVyUGFydHNbaV07XG4gICAgICAgICAgICAgICAgaWYgKGkgPT09IDApIHNsaWNlcy5wdXNoKHBhcnQpO1xuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFydC5pbmRleE9mKCdcIicpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBQbGFpbiBTdHJpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJ0Lm1hdGNoKC9cIi9nKS5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBPbmUgd29yZCBzdHJpbmdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGljZXMucHVzaChwYXJ0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpbmQgY2xvc2VkIEluZGV4XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hpZnRJbmRleCA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gaSArIDE7IGogPCBoZWxwZXJQYXJ0cy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0ICs9ICcgJyArIGhlbHBlclBhcnRzW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGVscGVyUGFydHNbal0uaW5kZXhPZignXCInKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGlmdEluZGV4ID0gajtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWNlcy5wdXNoKHBhcnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNoaWZ0SW5kZXgpIGkgPSBzaGlmdEluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnQuaW5kZXhPZignPScpID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhhc2hcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFzaFBhcnRzID0gcGFydC5zcGxpdCgnPScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYXNoTmFtZSA9IGhhc2hQYXJ0c1swXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFzaENvbnRlbnQgPSBoYXNoUGFydHNbMV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhc2hDb250ZW50Lm1hdGNoKC9cIi9nKS5sZW5ndGggIT09IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hpZnRJbmRleCA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IGkgKyAxOyBqIDwgaGVscGVyUGFydHMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2hDb250ZW50ICs9ICcgJyArIGhlbHBlclBhcnRzW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhlbHBlclBhcnRzW2pdLmluZGV4T2YoJ1wiJykgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoaWZ0SW5kZXggPSBqO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGlmdEluZGV4KSBpID0gc2hpZnRJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhhc2ggPSBbaGFzaE5hbWUsIGhhc2hDb250ZW50LnJlcGxhY2UoL1wiL2csJycpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGljZXMucHVzaChoYXNoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBsYWluIHZhcmlhYmxlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpY2VzLnB1c2gocGFydCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gc2xpY2VzO1xuICAgICAgICB9XG4gICAgICAgIGZ1bmN0aW9uIHN0cmluZ1RvQmxvY2tzKHN0cmluZykge1xuICAgICAgICAgICAgdmFyIGJsb2NrcyA9IFtdLCBpLCBqLCBrO1xuICAgICAgICAgICAgaWYgKCFzdHJpbmcpIHJldHVybiBbXTtcbiAgICAgICAgICAgIHZhciBfYmxvY2tzID0gc3RyaW5nLnNwbGl0KC8oe3tbXntefV0qfX0pLyk7XG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgX2Jsb2Nrcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciBibG9jayA9IF9ibG9ja3NbaV07XG4gICAgICAgICAgICAgICAgaWYgKGJsb2NrID09PSAnJykgY29udGludWU7XG4gICAgICAgICAgICAgICAgaWYgKGJsb2NrLmluZGV4T2YoJ3t7JykgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGJsb2Nrcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdwbGFpbicsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50OiBibG9ja1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChibG9jay5pbmRleE9mKCd7LycpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChibG9jay5pbmRleE9mKCd7IycpIDwgMCAmJiBibG9jay5pbmRleE9mKCcgJykgPCAwICYmIGJsb2NrLmluZGV4T2YoJ2Vsc2UnKSA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNpbXBsZSB2YXJpYWJsZVxuICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICd2YXJpYWJsZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dE5hbWU6IGJsb2NrLnJlcGxhY2UoL1t7fV0vZywgJycpXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIEhlbHBlcnNcbiAgICAgICAgICAgICAgICAgICAgdmFyIGhlbHBlclNsaWNlcyA9IGhlbHBlclRvU2xpY2VzKGJsb2NrKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGhlbHBlck5hbWUgPSBoZWxwZXJTbGljZXNbMF07XG4gICAgICAgICAgICAgICAgICAgIHZhciBpc1BhcnRpYWwgPSBoZWxwZXJOYW1lID09PSAnPic7XG4gICAgICAgICAgICAgICAgICAgIHZhciBoZWxwZXJDb250ZXh0ID0gW107XG4gICAgICAgICAgICAgICAgICAgIHZhciBoZWxwZXJIYXNoID0ge307XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDE7IGogPCBoZWxwZXJTbGljZXMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGljZSA9IGhlbHBlclNsaWNlc1tqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KHNsaWNlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhhc2hcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWxwZXJIYXNoW3NsaWNlWzBdXSA9IHNsaWNlWzFdID09PSAnZmFsc2UnID8gZmFsc2UgOiBzbGljZVsxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlbHBlckNvbnRleHQucHVzaChzbGljZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChibG9jay5pbmRleE9mKCd7IycpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENvbmRpdGlvbi9IZWxwZXJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoZWxwZXJTdGFydEluZGV4ID0gaTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoZWxwZXJDb250ZW50ID0gJyc7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZWxzZUNvbnRlbnQgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b1NraXAgPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNoaWZ0SW5kZXg7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZm91bmRDbG9zZWQgPSBmYWxzZSwgZm91bmRFbHNlID0gZmFsc2UsIGZvdW5kQ2xvc2VkRWxzZSA9IGZhbHNlLCBkZXB0aCA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSBpICsgMTsgaiA8IF9ibG9ja3MubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2Jsb2Nrc1tqXS5pbmRleE9mKCd7eyMnKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlcHRoICsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2Jsb2Nrc1tqXS5pbmRleE9mKCd7ey8nKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlcHRoIC0tO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoX2Jsb2Nrc1tqXS5pbmRleE9mKCd7eyMnICsgaGVscGVyTmFtZSkgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWxwZXJDb250ZW50ICs9IF9ibG9ja3Nbal07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3VuZEVsc2UpIGVsc2VDb250ZW50ICs9IF9ibG9ja3Nbal07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvU2tpcCArKztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoX2Jsb2Nrc1tqXS5pbmRleE9mKCd7ey8nICsgaGVscGVyTmFtZSkgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9Ta2lwID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9Ta2lwLS07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWxwZXJDb250ZW50ICs9IF9ibG9ja3Nbal07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm91bmRFbHNlKSBlbHNlQ29udGVudCArPSBfYmxvY2tzW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hpZnRJbmRleCA9IGo7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZENsb3NlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChfYmxvY2tzW2pdLmluZGV4T2YoJ2Vsc2UnKSA+PSAwICYmIGRlcHRoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kRWxzZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWZvdW5kRWxzZSkgaGVscGVyQ29udGVudCArPSBfYmxvY2tzW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm91bmRFbHNlKSBlbHNlQ29udGVudCArPSBfYmxvY2tzW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3VuZENsb3NlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGlmdEluZGV4KSBpID0gc2hpZnRJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBibG9ja3MucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdoZWxwZXInLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWxwZXJOYW1lOiBoZWxwZXJOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0TmFtZTogaGVscGVyQ29udGV4dCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudDogaGVscGVyQ29udGVudCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW52ZXJzZUNvbnRlbnQ6IGVsc2VDb250ZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNoOiBoZWxwZXJIYXNoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYmxvY2suaW5kZXhPZignICcpID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzUGFydGlhbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlbHBlck5hbWUgPSAnX3BhcnRpYWwnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoZWxwZXJDb250ZXh0WzBdKSBoZWxwZXJDb250ZXh0WzBdID0gJ1wiJyArIGhlbHBlckNvbnRleHRbMF0ucmVwbGFjZSgvXCJ8Jy9nLCAnJykgKyAnXCInO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2tzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdoZWxwZXInLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlbHBlck5hbWU6IGhlbHBlck5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dE5hbWU6IGhlbHBlckNvbnRleHQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzaDogaGVscGVySGFzaFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYmxvY2tzO1xuICAgICAgICB9XG4gICAgICAgIHZhciBUZW1wbGF0ZTcgPSBmdW5jdGlvbiAodGVtcGxhdGUpIHtcbiAgICAgICAgICAgIHZhciB0ID0gdGhpcztcbiAgICAgICAgICAgIHQudGVtcGxhdGUgPSB0ZW1wbGF0ZTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcGlsZUZuKGJsb2NrLCBkZXB0aCkge1xuICAgICAgICAgICAgICAgIGlmIChibG9jay5jb250ZW50KSByZXR1cm4gY29tcGlsZShibG9jay5jb250ZW50LCBkZXB0aCk7XG4gICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gZnVuY3Rpb24gKCkge3JldHVybiAnJzsgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGdldENvbXBpbGVJbnZlcnNlKGJsb2NrLCBkZXB0aCkge1xuICAgICAgICAgICAgICAgIGlmIChibG9jay5pbnZlcnNlQ29udGVudCkgcmV0dXJuIGNvbXBpbGUoYmxvY2suaW52ZXJzZUNvbnRlbnQsIGRlcHRoKTtcbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBmdW5jdGlvbiAoKSB7cmV0dXJuICcnOyB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcGlsZVZhcihuYW1lLCBjdHgpIHtcbiAgICAgICAgICAgICAgICB2YXIgdmFyaWFibGUsIHBhcnRzLCBsZXZlbHNVcCA9IDAsIGluaXRpYWxDdHggPSBjdHg7XG4gICAgICAgICAgICAgICAgaWYgKG5hbWUuaW5kZXhPZignLi4vJykgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgbGV2ZWxzVXAgPSBuYW1lLnNwbGl0KCcuLi8nKS5sZW5ndGggLSAxO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3RGVwdGggPSBjdHguc3BsaXQoJ18nKVsxXSAtIGxldmVsc1VwO1xuICAgICAgICAgICAgICAgICAgICBjdHggPSAnY3R4XycgKyAobmV3RGVwdGggPj0gMSA/IG5ld0RlcHRoIDogMSk7XG4gICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbmFtZS5zcGxpdCgnLi4vJylbbGV2ZWxzVXBdLnNwbGl0KCcuJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKG5hbWUuaW5kZXhPZignQGdsb2JhbCcpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGN0eCA9ICdUZW1wbGF0ZTcuZ2xvYmFsJztcbiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBuYW1lLnNwbGl0KCdAZ2xvYmFsLicpWzFdLnNwbGl0KCcuJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKG5hbWUuaW5kZXhPZignQHJvb3QnKSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBjdHggPSAncm9vdCc7XG4gICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbmFtZS5zcGxpdCgnQHJvb3QuJylbMV0uc3BsaXQoJy4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcnRzID0gbmFtZS5zcGxpdCgnLicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXJpYWJsZSA9IGN0eDtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwYXJ0ID0gcGFydHNbaV07XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJ0LmluZGV4T2YoJ0AnKSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWFibGUgKz0gJ1soZGF0YSAmJiBkYXRhLicgKyBwYXJ0LnJlcGxhY2UoJ0AnLCAnJykgKyAnKV0nO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWFibGUgPSAnKGRhdGEgJiYgZGF0YS4nICsgbmFtZS5yZXBsYWNlKCdAJywgJycpICsgJyknO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzRmluaXRlKHBhcnQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWFibGUgKz0gJ1snICsgcGFydCArICddJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYXJ0LmluZGV4T2YoJ3RoaXMnKSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZSA9IHBhcnQucmVwbGFjZSgndGhpcycsIGN0eCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZSArPSAnLicgKyBwYXJ0OyAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhcmlhYmxlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcGlsZWRBcmd1bWVudHMoY29udGV4dEFycmF5LCBjdHgpIHtcbiAgICAgICAgICAgICAgICB2YXIgYXJyID0gW107XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb250ZXh0QXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHRBcnJheVtpXS5pbmRleE9mKCdcIicpID09PSAwKSBhcnIucHVzaChjb250ZXh0QXJyYXlbaV0pO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFyci5wdXNoKGdldENvbXBpbGVWYXIoY29udGV4dEFycmF5W2ldLCBjdHgpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4gYXJyLmpvaW4oJywgJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBjb21waWxlKHRlbXBsYXRlLCBkZXB0aCkge1xuICAgICAgICAgICAgICAgIGRlcHRoID0gZGVwdGggfHwgMTtcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IHRlbXBsYXRlIHx8IHQudGVtcGxhdGU7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUZW1wbGF0ZTc6IFRlbXBsYXRlIG11c3QgYmUgYSBzdHJpbmcnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIGJsb2NrcyA9IHN0cmluZ1RvQmxvY2tzKHRlbXBsYXRlKTtcbiAgICAgICAgICAgICAgICBpZiAoYmxvY2tzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgeyByZXR1cm4gJyc7IH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBjdHggPSAnY3R4XycgKyBkZXB0aDtcbiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0U3RyaW5nID0gJyc7XG4gICAgICAgICAgICAgICAgaWYgKGRlcHRoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZyArPSAnKGZ1bmN0aW9uICgnICsgY3R4ICsgJywgZGF0YSwgcm9vdCkge1xcbic7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmcgKz0gJyhmdW5jdGlvbiAoJyArIGN0eCArICcsIGRhdGEpIHtcXG4nO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0U3RyaW5nICs9ICdmdW5jdGlvbiBpc0FycmF5KGFycil7cmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuYXBwbHkoYXJyKSA9PT0gXFwnW29iamVjdCBBcnJheV1cXCc7fVxcbic7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZyArPSAnZnVuY3Rpb24gaXNGdW5jdGlvbihmdW5jKXtyZXR1cm4gKHR5cGVvZiBmdW5jID09PSBcXCdmdW5jdGlvblxcJyk7fVxcbic7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZyArPSAnZnVuY3Rpb24gYyh2YWwsIGN0eCkge2lmICh0eXBlb2YgdmFsICE9PSBcInVuZGVmaW5lZFwiICYmIHZhbCAhPT0gbnVsbCkge2lmIChpc0Z1bmN0aW9uKHZhbCkpIHtyZXR1cm4gdmFsLmNhbGwoY3R4KTt9IGVsc2UgcmV0dXJuIHZhbDt9IGVsc2UgcmV0dXJuIFwiXCI7fVxcbic7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZyArPSAncm9vdCA9IHJvb3QgfHwgY3R4XzEgfHwge307XFxuJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVzdWx0U3RyaW5nICs9ICd2YXIgciA9IFxcJ1xcJztcXG4nO1xuICAgICAgICAgICAgICAgIHZhciBpLCBqLCBjb250ZXh0O1xuICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBibG9ja3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJsb2NrID0gYmxvY2tzW2ldO1xuICAgICAgICAgICAgICAgICAgICAvLyBQbGFpbiBibG9ja1xuICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2sudHlwZSA9PT0gJ3BsYWluJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0U3RyaW5nICs9ICdyICs9XFwnJyArIChibG9jay5jb250ZW50KS5yZXBsYWNlKC9cXHIvZywgJ1xcXFxyJykucmVwbGFjZSgvXFxuL2csICdcXFxcbicpLnJlcGxhY2UoLycvZywgJ1xcXFwnICsgJ1xcJycpICsgJ1xcJzsnO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIHZhcmlhYmxlLCBjb21waWxlZEFyZ3VtZW50cztcbiAgICAgICAgICAgICAgICAgICAgLy8gVmFyaWFibGUgYmxvY2tcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJsb2NrLnR5cGUgPT09ICd2YXJpYWJsZScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlID0gZ2V0Q29tcGlsZVZhcihibG9jay5jb250ZXh0TmFtZSwgY3R4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZyArPSAnciArPSBjKCcgKyB2YXJpYWJsZSArICcsICcgKyBjdHggKyAnKTsnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIEhlbHBlcnMgYmxvY2tcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJsb2NrLnR5cGUgPT09ICdoZWxwZXInKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2suaGVscGVyTmFtZSBpbiB0LmhlbHBlcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21waWxlZEFyZ3VtZW50cyA9IGdldENvbXBpbGVkQXJndW1lbnRzKGJsb2NrLmNvbnRleHROYW1lLCBjdHgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZyArPSAnciArPSAoVGVtcGxhdGU3LmhlbHBlcnMuJyArIGJsb2NrLmhlbHBlck5hbWUgKyAnKS5jYWxsKCcgKyBjdHggKyAnLCAnICsgKGNvbXBpbGVkQXJndW1lbnRzICYmIChjb21waWxlZEFyZ3VtZW50cyArICcsICcpKSArJ3toYXNoOicgKyBKU09OLnN0cmluZ2lmeShibG9jay5oYXNoKSArICcsIGRhdGE6IGRhdGEgfHwge30sIGZuOiAnICsgZ2V0Q29tcGlsZUZuKGJsb2NrLCBkZXB0aCArIDEpICsgJywgaW52ZXJzZTogJyArIGdldENvbXBpbGVJbnZlcnNlKGJsb2NrLCBkZXB0aCArIDEpICsgJywgcm9vdDogcm9vdH0pOyc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2suY29udGV4dE5hbWUubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RlbXBsYXRlNzogTWlzc2luZyBoZWxwZXI6IFwiJyArIGJsb2NrLmhlbHBlck5hbWUgKyAnXCInKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlID0gZ2V0Q29tcGlsZVZhcihibG9jay5oZWxwZXJOYW1lLCBjdHgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmcgKz0gJ2lmICgnICsgdmFyaWFibGUgKyAnKSB7JztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0U3RyaW5nICs9ICdpZiAoaXNBcnJheSgnICsgdmFyaWFibGUgKyAnKSkgeyc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZyArPSAnciArPSAoVGVtcGxhdGU3LmhlbHBlcnMuZWFjaCkuY2FsbCgnICsgY3R4ICsgJywgJyArIHZhcmlhYmxlICsgJywge2hhc2g6JyArIEpTT04uc3RyaW5naWZ5KGJsb2NrLmhhc2gpICsgJywgZGF0YTogZGF0YSB8fCB7fSwgZm46ICcgKyBnZXRDb21waWxlRm4oYmxvY2ssIGRlcHRoKzEpICsgJywgaW52ZXJzZTogJyArIGdldENvbXBpbGVJbnZlcnNlKGJsb2NrLCBkZXB0aCsxKSArICcsIHJvb3Q6IHJvb3R9KTsnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmcgKz0gJ31lbHNlIHsnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmcgKz0gJ3IgKz0gKFRlbXBsYXRlNy5oZWxwZXJzLndpdGgpLmNhbGwoJyArIGN0eCArICcsICcgKyB2YXJpYWJsZSArICcsIHtoYXNoOicgKyBKU09OLnN0cmluZ2lmeShibG9jay5oYXNoKSArICcsIGRhdGE6IGRhdGEgfHwge30sIGZuOiAnICsgZ2V0Q29tcGlsZUZuKGJsb2NrLCBkZXB0aCsxKSArICcsIGludmVyc2U6ICcgKyBnZXRDb21waWxlSW52ZXJzZShibG9jaywgZGVwdGgrMSkgKyAnLCByb290OiByb290fSk7JztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0U3RyaW5nICs9ICd9fSc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZyArPSAnXFxucmV0dXJuIHI7fSknO1xuICAgICAgICAgICAgICAgIHJldHVybiBldmFsLmNhbGwod2luZG93LCByZXN1bHRTdHJpbmcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdC5jb21waWxlID0gZnVuY3Rpb24gKHRlbXBsYXRlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0LmNvbXBpbGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHQuY29tcGlsZWQgPSBjb21waWxlKHRlbXBsYXRlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHQuY29tcGlsZWQ7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9O1xuICAgICAgICBUZW1wbGF0ZTcucHJvdG90eXBlID0ge1xuICAgICAgICAgICAgb3B0aW9uczoge30sXG4gICAgICAgICAgICBwYXJ0aWFsczoge30sXG4gICAgICAgICAgICBoZWxwZXJzOiB7XG4gICAgICAgICAgICAgICAgJ19wYXJ0aWFsJyA6IGZ1bmN0aW9uIChwYXJ0aWFsTmFtZSwgb3B0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcCA9IFRlbXBsYXRlNy5wcm90b3R5cGUucGFydGlhbHNbcGFydGlhbE5hbWVdO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXAgfHwgKHAgJiYgIXAudGVtcGxhdGUpKSByZXR1cm4gJyc7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcC5jb21waWxlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5jb21waWxlZCA9IHQ3LmNvbXBpbGUocC50ZW1wbGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIGN0eCA9IHRoaXM7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGhhc2hOYW1lIGluIG9wdGlvbnMuaGFzaCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3R4W2hhc2hOYW1lXSA9IG9wdGlvbnMuaGFzaFtoYXNoTmFtZV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAuY29tcGlsZWQoY3R4LCBvcHRpb25zLmRhdGEsIG9wdGlvbnMucm9vdCk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAnZXNjYXBlJzogZnVuY3Rpb24gKGNvbnRleHQsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0ICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUZW1wbGF0ZTc6IFBhc3NlZCBjb250ZXh0IHRvIFwiZXNjYXBlXCIgaGVscGVyIHNob3VsZCBiZSBhIHN0cmluZycpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjb250ZXh0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLyYvZywgJyZhbXA7JylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvPC9nLCAnJmx0OycpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoLz4vZywgJyZndDsnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cIi9nLCAnJnF1b3Q7Jyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAnaWYnOiBmdW5jdGlvbiAoY29udGV4dCwgb3B0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihjb250ZXh0KSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9ucy5mbih0aGlzLCBvcHRpb25zLmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMuaW52ZXJzZSh0aGlzLCBvcHRpb25zLmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAndW5sZXNzJzogZnVuY3Rpb24gKGNvbnRleHQsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oY29udGV4dCkpIHsgY29udGV4dCA9IGNvbnRleHQuY2FsbCh0aGlzKTsgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbnRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25zLmZuKHRoaXMsIG9wdGlvbnMuZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9ucy5pbnZlcnNlKHRoaXMsIG9wdGlvbnMuZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICdlYWNoJzogZnVuY3Rpb24gKGNvbnRleHQsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJldCA9ICcnLCBpID0gMDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oY29udGV4dCkpIHsgY29udGV4dCA9IGNvbnRleHQuY2FsbCh0aGlzKTsgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNBcnJheShjb250ZXh0KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaGFzaC5yZXZlcnNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQucmV2ZXJzZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvbnRleHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXQgKz0gb3B0aW9ucy5mbihjb250ZXh0W2ldLCB7Zmlyc3Q6IGkgPT09IDAsIGxhc3Q6IGkgPT09IGNvbnRleHQubGVuZ3RoIC0gMSwgaW5kZXg6IGl9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmhhc2gucmV2ZXJzZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0LnJldmVyc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBjb250ZXh0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaSsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldCArPSBvcHRpb25zLmZuKGNvbnRleHRba2V5XSwge2tleToga2V5fSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGkgPiAwKSByZXR1cm4gcmV0O1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBvcHRpb25zLmludmVyc2UodGhpcyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAnd2l0aCc6IGZ1bmN0aW9uIChjb250ZXh0LCBvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGNvbnRleHQpKSB7IGNvbnRleHQgPSBjb250ZXh0LmNhbGwodGhpcyk7IH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMuZm4oY29udGV4dCk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAnam9pbic6IGZ1bmN0aW9uIChjb250ZXh0LCBvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGNvbnRleHQpKSB7IGNvbnRleHQgPSBjb250ZXh0LmNhbGwodGhpcyk7IH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQuam9pbihvcHRpb25zLmhhc2guZGVsaW1pdGVyIHx8IG9wdGlvbnMuaGFzaC5kZWxpbWV0ZXIpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgJ2pzJzogZnVuY3Rpb24gKGV4cHJlc3Npb24sIG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZ1bmM7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleHByZXNzaW9uLmluZGV4T2YoJ3JldHVybicpPj0wKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jID0gJyhmdW5jdGlvbigpeycrZXhwcmVzc2lvbisnfSknO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZnVuYyA9ICcoZnVuY3Rpb24oKXtyZXR1cm4gKCcrZXhwcmVzc2lvbisnKX0pJztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXZhbC5jYWxsKHRoaXMsIGZ1bmMpLmNhbGwodGhpcyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAnanNfY29tcGFyZSc6IGZ1bmN0aW9uIChleHByZXNzaW9uLCBvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBmdW5jO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXhwcmVzc2lvbi5pbmRleE9mKCdyZXR1cm4nKT49MCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZnVuYyA9ICcoZnVuY3Rpb24oKXsnK2V4cHJlc3Npb24rJ30pJztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmMgPSAnKGZ1bmN0aW9uKCl7cmV0dXJuICgnK2V4cHJlc3Npb24rJyl9KSc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbmRpdGlvbiA9IGV2YWwuY2FsbCh0aGlzLCBmdW5jKS5jYWxsKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9ucy5mbih0aGlzLCBvcHRpb25zLmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMuaW52ZXJzZSh0aGlzLCBvcHRpb25zLmRhdGEpOyAgIFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB2YXIgdDcgPSBmdW5jdGlvbiAodGVtcGxhdGUsIGRhdGEpIHtcbiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbmV3IFRlbXBsYXRlNyh0ZW1wbGF0ZSk7XG4gICAgICAgICAgICAgICAgdmFyIHJlbmRlcmVkID0gaW5zdGFuY2UuY29tcGlsZSgpKGRhdGEpO1xuICAgICAgICAgICAgICAgIGluc3RhbmNlID0gbnVsbDtcbiAgICAgICAgICAgICAgICByZXR1cm4gKHJlbmRlcmVkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgcmV0dXJuIG5ldyBUZW1wbGF0ZTcodGVtcGxhdGUpO1xuICAgICAgICB9O1xuICAgICAgICB0Ny5yZWdpc3RlckhlbHBlciA9IGZ1bmN0aW9uIChuYW1lLCBmbikge1xuICAgICAgICAgICAgVGVtcGxhdGU3LnByb3RvdHlwZS5oZWxwZXJzW25hbWVdID0gZm47XG4gICAgICAgIH07XG4gICAgICAgIHQ3LnVucmVnaXN0ZXJIZWxwZXIgPSBmdW5jdGlvbiAobmFtZSkge1xuICAgICAgICAgICAgVGVtcGxhdGU3LnByb3RvdHlwZS5oZWxwZXJzW25hbWVdID0gdW5kZWZpbmVkOyAgXG4gICAgICAgICAgICBkZWxldGUgVGVtcGxhdGU3LnByb3RvdHlwZS5oZWxwZXJzW25hbWVdO1xuICAgICAgICB9O1xuICAgICAgICB0Ny5yZWdpc3RlclBhcnRpYWwgPSBmdW5jdGlvbiAobmFtZSwgdGVtcGxhdGUpIHtcbiAgICAgICAgICAgIFRlbXBsYXRlNy5wcm90b3R5cGUucGFydGlhbHNbbmFtZV0gPSB7dGVtcGxhdGU6IHRlbXBsYXRlfTtcbiAgICAgICAgfTtcbiAgICAgICAgdDcudW5yZWdpc3RlclBhcnRpYWwgPSBmdW5jdGlvbiAobmFtZSwgdGVtcGxhdGUpIHtcbiAgICAgICAgICAgIGlmIChUZW1wbGF0ZTcucHJvdG90eXBlLnBhcnRpYWxzW25hbWVdKSB7XG4gICAgICAgICAgICAgICAgVGVtcGxhdGU3LnByb3RvdHlwZS5wYXJ0aWFsc1tuYW1lXSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBkZWxldGUgVGVtcGxhdGU3LnByb3RvdHlwZS5wYXJ0aWFsc1tuYW1lXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIHQ3LmNvbXBpbGUgPSBmdW5jdGlvbiAodGVtcGxhdGUsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgIHZhciBpbnN0YW5jZSA9IG5ldyBUZW1wbGF0ZTcodGVtcGxhdGUsIG9wdGlvbnMpO1xuICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlLmNvbXBpbGUoKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIHQ3Lm9wdGlvbnMgPSBUZW1wbGF0ZTcucHJvdG90eXBlLm9wdGlvbnM7XG4gICAgICAgIHQ3LmhlbHBlcnMgPSBUZW1wbGF0ZTcucHJvdG90eXBlLmhlbHBlcnM7XG4gICAgICAgIHQ3LnBhcnRpYWxzID0gVGVtcGxhdGU3LnByb3RvdHlwZS5wYXJ0aWFscztcbiAgICAgICAgcmV0dXJuIHQ3O1xuICAgIH0pKCk7XG5cbiAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIFN3aXBlclxuICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgd2luZG93LlN3aXBlciA9IGZ1bmN0aW9uIChjb250YWluZXIsIHBhcmFtcykge1xuICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgU3dpcGVyKSkgcmV0dXJuIG5ldyBTd2lwZXIoY29udGFpbmVyLCBwYXJhbXMpO1xuICAgICAgICB2YXIgZGVmYXVsdHMgPSB7XG4gICAgICAgICAgICBkaXJlY3Rpb246ICdob3Jpem9udGFsJyxcbiAgICAgICAgICAgIHRvdWNoRXZlbnRzVGFyZ2V0OiAnY29udGFpbmVyJyxcbiAgICAgICAgICAgIGluaXRpYWxTbGlkZTogMCxcbiAgICAgICAgICAgIHNwZWVkOiAzMDAsXG4gICAgICAgICAgICAvLyBhdXRvcGxheVxuICAgICAgICAgICAgYXV0b3BsYXk6IGZhbHNlLFxuICAgICAgICAgICAgYXV0b3BsYXlEaXNhYmxlT25JbnRlcmFjdGlvbjogdHJ1ZSxcbiAgICAgICAgICAgIGF1dG9wbGF5U3RvcE9uTGFzdDogZmFsc2UsXG4gICAgICAgICAgICAvLyBUbyBzdXBwb3J0IGlPUydzIHN3aXBlLXRvLWdvLWJhY2sgZ2VzdHVyZSAod2hlbiBiZWluZyB1c2VkIGluLWFwcCwgd2l0aCBVSVdlYlZpZXcpLlxuICAgICAgICAgICAgaU9TRWRnZVN3aXBlRGV0ZWN0aW9uOiBmYWxzZSxcbiAgICAgICAgICAgIGlPU0VkZ2VTd2lwZVRocmVzaG9sZDogMjAsXG4gICAgICAgICAgICAvLyBGcmVlIG1vZGVcbiAgICAgICAgICAgIGZyZWVNb2RlOiBmYWxzZSxcbiAgICAgICAgICAgIGZyZWVNb2RlTW9tZW50dW06IHRydWUsXG4gICAgICAgICAgICBmcmVlTW9kZU1vbWVudHVtUmF0aW86IDEsXG4gICAgICAgICAgICBmcmVlTW9kZU1vbWVudHVtQm91bmNlOiB0cnVlLFxuICAgICAgICAgICAgZnJlZU1vZGVNb21lbnR1bUJvdW5jZVJhdGlvOiAxLFxuICAgICAgICAgICAgZnJlZU1vZGVTdGlja3k6IGZhbHNlLFxuICAgICAgICAgICAgZnJlZU1vZGVNaW5pbXVtVmVsb2NpdHk6IDAuMDIsXG4gICAgICAgICAgICAvLyBBdXRvaGVpZ2h0XG4gICAgICAgICAgICBhdXRvSGVpZ2h0OiBmYWxzZSxcbiAgICAgICAgICAgIC8vIFNldCB3cmFwcGVyIHdpZHRoXG4gICAgICAgICAgICBzZXRXcmFwcGVyU2l6ZTogZmFsc2UsXG4gICAgICAgICAgICAvLyBWaXJ0dWFsIFRyYW5zbGF0ZVxuICAgICAgICAgICAgdmlydHVhbFRyYW5zbGF0ZTogZmFsc2UsXG4gICAgICAgICAgICAvLyBFZmZlY3RzXG4gICAgICAgICAgICBlZmZlY3Q6ICdzbGlkZScsIC8vICdzbGlkZScgb3IgJ2ZhZGUnIG9yICdjdWJlJyBvciAnY292ZXJmbG93JyBvciAnZmxpcCdcbiAgICAgICAgICAgIGNvdmVyZmxvdzoge1xuICAgICAgICAgICAgICAgIHJvdGF0ZTogNTAsXG4gICAgICAgICAgICAgICAgc3RyZXRjaDogMCxcbiAgICAgICAgICAgICAgICBkZXB0aDogMTAwLFxuICAgICAgICAgICAgICAgIG1vZGlmaWVyOiAxLFxuICAgICAgICAgICAgICAgIHNsaWRlU2hhZG93cyA6IHRydWVcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmbGlwOiB7XG4gICAgICAgICAgICAgICAgc2xpZGVTaGFkb3dzIDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBsaW1pdFJvdGF0aW9uOiB0cnVlXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY3ViZToge1xuICAgICAgICAgICAgICAgIHNsaWRlU2hhZG93czogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzaGFkb3c6IHRydWUsXG4gICAgICAgICAgICAgICAgc2hhZG93T2Zmc2V0OiAyMCxcbiAgICAgICAgICAgICAgICBzaGFkb3dTY2FsZTogMC45NFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGZhZGU6IHtcbiAgICAgICAgICAgICAgICBjcm9zc0ZhZGU6IGZhbHNlXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLy8gUGFyYWxsYXhcbiAgICAgICAgICAgIHBhcmFsbGF4OiBmYWxzZSxcbiAgICAgICAgICAgIC8vIFNjcm9sbGJhclxuICAgICAgICAgICAgc2Nyb2xsYmFyOiBudWxsLFxuICAgICAgICAgICAgc2Nyb2xsYmFySGlkZTogdHJ1ZSxcbiAgICAgICAgICAgIHNjcm9sbGJhckRyYWdnYWJsZTogZmFsc2UsXG4gICAgICAgICAgICBzY3JvbGxiYXJTbmFwT25SZWxlYXNlOiBmYWxzZSxcbiAgICAgICAgICAgIC8vIEtleWJvYXJkIE1vdXNld2hlZWxcbiAgICAgICAgICAgIGtleWJvYXJkQ29udHJvbDogZmFsc2UsXG4gICAgICAgICAgICBtb3VzZXdoZWVsQ29udHJvbDogZmFsc2UsXG4gICAgICAgICAgICBtb3VzZXdoZWVsUmVsZWFzZU9uRWRnZXM6IGZhbHNlLFxuICAgICAgICAgICAgbW91c2V3aGVlbEludmVydDogZmFsc2UsXG4gICAgICAgICAgICBtb3VzZXdoZWVsRm9yY2VUb0F4aXM6IGZhbHNlLFxuICAgICAgICAgICAgbW91c2V3aGVlbFNlbnNpdGl2aXR5OiAxLFxuICAgICAgICAgICAgLy8gSGFzaCBOYXZpZ2F0aW9uXG4gICAgICAgICAgICBoYXNobmF2OiBmYWxzZSxcbiAgICAgICAgICAgIC8vIEJyZWFrcG9pbnRzXG4gICAgICAgICAgICBicmVha3BvaW50czogdW5kZWZpbmVkLFxuICAgICAgICAgICAgLy8gU2xpZGVzIGdyaWRcbiAgICAgICAgICAgIHNwYWNlQmV0d2VlbjogMCxcbiAgICAgICAgICAgIHNsaWRlc1BlclZpZXc6IDEsXG4gICAgICAgICAgICBzbGlkZXNQZXJDb2x1bW46IDEsXG4gICAgICAgICAgICBzbGlkZXNQZXJDb2x1bW5GaWxsOiAnY29sdW1uJyxcbiAgICAgICAgICAgIHNsaWRlc1Blckdyb3VwOiAxLFxuICAgICAgICAgICAgY2VudGVyZWRTbGlkZXM6IGZhbHNlLFxuICAgICAgICAgICAgc2xpZGVzT2Zmc2V0QmVmb3JlOiAwLCAvLyBpbiBweFxuICAgICAgICAgICAgc2xpZGVzT2Zmc2V0QWZ0ZXI6IDAsIC8vIGluIHB4XG4gICAgICAgICAgICAvLyBSb3VuZCBsZW5ndGhcbiAgICAgICAgICAgIHJvdW5kTGVuZ3RoczogZmFsc2UsXG4gICAgICAgICAgICAvLyBUb3VjaGVzXG4gICAgICAgICAgICB0b3VjaFJhdGlvOiAxLFxuICAgICAgICAgICAgdG91Y2hBbmdsZTogNDUsXG4gICAgICAgICAgICBzaW11bGF0ZVRvdWNoOiB0cnVlLFxuICAgICAgICAgICAgc2hvcnRTd2lwZXM6IHRydWUsXG4gICAgICAgICAgICBsb25nU3dpcGVzOiB0cnVlLFxuICAgICAgICAgICAgbG9uZ1N3aXBlc1JhdGlvOiAwLjUsXG4gICAgICAgICAgICBsb25nU3dpcGVzTXM6IDMwMCxcbiAgICAgICAgICAgIGZvbGxvd0ZpbmdlcjogdHJ1ZSxcbiAgICAgICAgICAgIG9ubHlFeHRlcm5hbDogZmFsc2UsXG4gICAgICAgICAgICB0aHJlc2hvbGQ6IDAsXG4gICAgICAgICAgICB0b3VjaE1vdmVTdG9wUHJvcGFnYXRpb246IHRydWUsXG4gICAgICAgICAgICAvLyBVbmlxdWUgTmF2aWdhdGlvbiBFbGVtZW50c1xuICAgICAgICAgICAgdW5pcXVlTmF2RWxlbWVudHM6IHRydWUsXG4gICAgICAgICAgICAvLyBQYWdpbmF0aW9uXG4gICAgICAgICAgICBwYWdpbmF0aW9uOiBudWxsLFxuICAgICAgICAgICAgcGFnaW5hdGlvbkVsZW1lbnQ6ICdzcGFuJyxcbiAgICAgICAgICAgIHBhZ2luYXRpb25DbGlja2FibGU6IGZhbHNlLFxuICAgICAgICAgICAgcGFnaW5hdGlvbkhpZGU6IGZhbHNlLFxuICAgICAgICAgICAgcGFnaW5hdGlvbkJ1bGxldFJlbmRlcjogbnVsbCxcbiAgICAgICAgICAgIHBhZ2luYXRpb25Qcm9ncmVzc1JlbmRlcjogbnVsbCxcbiAgICAgICAgICAgIHBhZ2luYXRpb25GcmFjdGlvblJlbmRlcjogbnVsbCxcbiAgICAgICAgICAgIHBhZ2luYXRpb25DdXN0b21SZW5kZXI6IG51bGwsXG4gICAgICAgICAgICBwYWdpbmF0aW9uVHlwZTogJ2J1bGxldHMnLCAvLyAnYnVsbGV0cycgb3IgJ3Byb2dyZXNzJyBvciAnZnJhY3Rpb24nIG9yICdjdXN0b20nXG4gICAgICAgICAgICAvLyBSZXNpc3RhbmNlXG4gICAgICAgICAgICByZXNpc3RhbmNlOiB0cnVlLFxuICAgICAgICAgICAgcmVzaXN0YW5jZVJhdGlvOiAwLjg1LFxuICAgICAgICAgICAgLy8gTmV4dC9wcmV2IGJ1dHRvbnNcbiAgICAgICAgICAgIG5leHRCdXR0b246IG51bGwsXG4gICAgICAgICAgICBwcmV2QnV0dG9uOiBudWxsLFxuICAgICAgICAgICAgLy8gUHJvZ3Jlc3NcbiAgICAgICAgICAgIHdhdGNoU2xpZGVzUHJvZ3Jlc3M6IGZhbHNlLFxuICAgICAgICAgICAgd2F0Y2hTbGlkZXNWaXNpYmlsaXR5OiBmYWxzZSxcbiAgICAgICAgICAgIC8vIEN1cnNvclxuICAgICAgICAgICAgZ3JhYkN1cnNvcjogZmFsc2UsXG4gICAgICAgICAgICAvLyBDbGlja3NcbiAgICAgICAgICAgIHByZXZlbnRDbGlja3M6IHRydWUsXG4gICAgICAgICAgICBwcmV2ZW50Q2xpY2tzUHJvcGFnYXRpb246IHRydWUsXG4gICAgICAgICAgICBzbGlkZVRvQ2xpY2tlZFNsaWRlOiBmYWxzZSxcbiAgICAgICAgICAgIC8vIExhenkgTG9hZGluZ1xuICAgICAgICAgICAgbGF6eUxvYWRpbmc6IGZhbHNlLFxuICAgICAgICAgICAgbGF6eUxvYWRpbmdJblByZXZOZXh0OiBmYWxzZSxcbiAgICAgICAgICAgIGxhenlMb2FkaW5nSW5QcmV2TmV4dEFtb3VudDogMSxcbiAgICAgICAgICAgIGxhenlMb2FkaW5nT25UcmFuc2l0aW9uU3RhcnQ6IGZhbHNlLFxuICAgICAgICAgICAgLy8gSW1hZ2VzXG4gICAgICAgICAgICBwcmVsb2FkSW1hZ2VzOiB0cnVlLFxuICAgICAgICAgICAgdXBkYXRlT25JbWFnZXNSZWFkeTogdHJ1ZSxcbiAgICAgICAgICAgIC8vIGxvb3BcbiAgICAgICAgICAgIGxvb3A6IGZhbHNlLFxuICAgICAgICAgICAgbG9vcEFkZGl0aW9uYWxTbGlkZXM6IDAsXG4gICAgICAgICAgICBsb29wZWRTbGlkZXM6IG51bGwsXG4gICAgICAgICAgICAvLyBDb250cm9sXG4gICAgICAgICAgICBjb250cm9sOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBjb250cm9sSW52ZXJzZTogZmFsc2UsXG4gICAgICAgICAgICBjb250cm9sQnk6ICdzbGlkZScsIC8vb3IgJ2NvbnRhaW5lcidcbiAgICAgICAgICAgIC8vIFN3aXBpbmcvbm8gc3dpcGluZ1xuICAgICAgICAgICAgYWxsb3dTd2lwZVRvUHJldjogdHJ1ZSxcbiAgICAgICAgICAgIGFsbG93U3dpcGVUb05leHQ6IHRydWUsXG4gICAgICAgICAgICBzd2lwZUhhbmRsZXI6IG51bGwsIC8vJy5zd2lwZS1oYW5kbGVyJyxcbiAgICAgICAgICAgIG5vU3dpcGluZzogdHJ1ZSxcbiAgICAgICAgICAgIG5vU3dpcGluZ0NsYXNzOiAnc3dpcGVyLW5vLXN3aXBpbmcnLFxuICAgICAgICAgICAgLy8gTlNcbiAgICAgICAgICAgIHNsaWRlQ2xhc3M6ICdzd2lwZXItc2xpZGUnLFxuICAgICAgICAgICAgc2xpZGVBY3RpdmVDbGFzczogJ3N3aXBlci1zbGlkZS1hY3RpdmUnLFxuICAgICAgICAgICAgc2xpZGVWaXNpYmxlQ2xhc3M6ICdzd2lwZXItc2xpZGUtdmlzaWJsZScsXG4gICAgICAgICAgICBzbGlkZUR1cGxpY2F0ZUNsYXNzOiAnc3dpcGVyLXNsaWRlLWR1cGxpY2F0ZScsXG4gICAgICAgICAgICBzbGlkZU5leHRDbGFzczogJ3N3aXBlci1zbGlkZS1uZXh0JyxcbiAgICAgICAgICAgIHNsaWRlUHJldkNsYXNzOiAnc3dpcGVyLXNsaWRlLXByZXYnLFxuICAgICAgICAgICAgd3JhcHBlckNsYXNzOiAnc3dpcGVyLXdyYXBwZXInLFxuICAgICAgICAgICAgYnVsbGV0Q2xhc3M6ICdzd2lwZXItcGFnaW5hdGlvbi1idWxsZXQnLFxuICAgICAgICAgICAgYnVsbGV0QWN0aXZlQ2xhc3M6ICdzd2lwZXItcGFnaW5hdGlvbi1idWxsZXQtYWN0aXZlJyxcbiAgICAgICAgICAgIGJ1dHRvbkRpc2FibGVkQ2xhc3M6ICdzd2lwZXItYnV0dG9uLWRpc2FibGVkJyxcbiAgICAgICAgICAgIHBhZ2luYXRpb25DdXJyZW50Q2xhc3M6ICdzd2lwZXItcGFnaW5hdGlvbi1jdXJyZW50JyxcbiAgICAgICAgICAgIHBhZ2luYXRpb25Ub3RhbENsYXNzOiAnc3dpcGVyLXBhZ2luYXRpb24tdG90YWwnLFxuICAgICAgICAgICAgcGFnaW5hdGlvbkhpZGRlbkNsYXNzOiAnc3dpcGVyLXBhZ2luYXRpb24taGlkZGVuJyxcbiAgICAgICAgICAgIHBhZ2luYXRpb25Qcm9ncmVzc2JhckNsYXNzOiAnc3dpcGVyLXBhZ2luYXRpb24tcHJvZ3Jlc3NiYXInLFxuICAgICAgICAgICAgLy8gT2JzZXJ2ZXJcbiAgICAgICAgICAgIG9ic2VydmVyOiBmYWxzZSxcbiAgICAgICAgICAgIG9ic2VydmVQYXJlbnRzOiBmYWxzZSxcbiAgICAgICAgICAgIC8vIEFjY2Vzc2liaWxpdHlcbiAgICAgICAgICAgIGExMXk6IGZhbHNlLFxuICAgICAgICAgICAgcHJldlNsaWRlTWVzc2FnZTogJ1ByZXZpb3VzIHNsaWRlJyxcbiAgICAgICAgICAgIG5leHRTbGlkZU1lc3NhZ2U6ICdOZXh0IHNsaWRlJyxcbiAgICAgICAgICAgIGZpcnN0U2xpZGVNZXNzYWdlOiAnVGhpcyBpcyB0aGUgZmlyc3Qgc2xpZGUnLFxuICAgICAgICAgICAgbGFzdFNsaWRlTWVzc2FnZTogJ1RoaXMgaXMgdGhlIGxhc3Qgc2xpZGUnLFxuICAgICAgICAgICAgcGFnaW5hdGlvbkJ1bGxldE1lc3NhZ2U6ICdHbyB0byBzbGlkZSB7e2luZGV4fX0nLFxuICAgICAgICAgICAgLy8gQ2FsbGJhY2tzXG4gICAgICAgICAgICBydW5DYWxsYmFja3NPbkluaXQ6IHRydWVcbiAgICAgICAgICAgIC8qXG4gICAgICAgICAgICBDYWxsYmFja3M6XG4gICAgICAgICAgICBvbkluaXQ6IGZ1bmN0aW9uIChzd2lwZXIpXG4gICAgICAgICAgICBvbkRlc3Ryb3k6IGZ1bmN0aW9uIChzd2lwZXIpXG4gICAgICAgICAgICBvbkNsaWNrOiBmdW5jdGlvbiAoc3dpcGVyLCBlKVxuICAgICAgICAgICAgb25UYXA6IGZ1bmN0aW9uIChzd2lwZXIsIGUpXG4gICAgICAgICAgICBvbkRvdWJsZVRhcDogZnVuY3Rpb24gKHN3aXBlciwgZSlcbiAgICAgICAgICAgIG9uU2xpZGVyTW92ZTogZnVuY3Rpb24gKHN3aXBlciwgZSlcbiAgICAgICAgICAgIG9uU2xpZGVDaGFuZ2VTdGFydDogZnVuY3Rpb24gKHN3aXBlcilcbiAgICAgICAgICAgIG9uU2xpZGVDaGFuZ2VFbmQ6IGZ1bmN0aW9uIChzd2lwZXIpXG4gICAgICAgICAgICBvblRyYW5zaXRpb25TdGFydDogZnVuY3Rpb24gKHN3aXBlcilcbiAgICAgICAgICAgIG9uVHJhbnNpdGlvbkVuZDogZnVuY3Rpb24gKHN3aXBlcilcbiAgICAgICAgICAgIG9uSW1hZ2VzUmVhZHk6IGZ1bmN0aW9uIChzd2lwZXIpXG4gICAgICAgICAgICBvblByb2dyZXNzOiBmdW5jdGlvbiAoc3dpcGVyLCBwcm9ncmVzcylcbiAgICAgICAgICAgIG9uVG91Y2hTdGFydDogZnVuY3Rpb24gKHN3aXBlciwgZSlcbiAgICAgICAgICAgIG9uVG91Y2hNb3ZlOiBmdW5jdGlvbiAoc3dpcGVyLCBlKVxuICAgICAgICAgICAgb25Ub3VjaE1vdmVPcHBvc2l0ZTogZnVuY3Rpb24gKHN3aXBlciwgZSlcbiAgICAgICAgICAgIG9uVG91Y2hFbmQ6IGZ1bmN0aW9uIChzd2lwZXIsIGUpXG4gICAgICAgICAgICBvblJlYWNoQmVnaW5uaW5nOiBmdW5jdGlvbiAoc3dpcGVyKVxuICAgICAgICAgICAgb25SZWFjaEVuZDogZnVuY3Rpb24gKHN3aXBlcilcbiAgICAgICAgICAgIG9uU2V0VHJhbnNpdGlvbjogZnVuY3Rpb24gKHN3aXBlciwgZHVyYXRpb24pXG4gICAgICAgICAgICBvblNldFRyYW5zbGF0ZTogZnVuY3Rpb24gKHN3aXBlciwgdHJhbnNsYXRlKVxuICAgICAgICAgICAgb25BdXRvcGxheVN0YXJ0OiBmdW5jdGlvbiAoc3dpcGVyKVxuICAgICAgICAgICAgb25BdXRvcGxheVN0b3A6IGZ1bmN0aW9uIChzd2lwZXIpLFxuICAgICAgICAgICAgb25MYXp5SW1hZ2VMb2FkOiBmdW5jdGlvbiAoc3dpcGVyLCBzbGlkZSwgaW1hZ2UpXG4gICAgICAgICAgICBvbkxhenlJbWFnZVJlYWR5OiBmdW5jdGlvbiAoc3dpcGVyLCBzbGlkZSwgaW1hZ2UpXG4gICAgICAgICAgICAqL1xuICAgICAgICBcbiAgICAgICAgfTtcbiAgICAgICAgdmFyIGluaXRpYWxWaXJ0dWFsVHJhbnNsYXRlID0gcGFyYW1zICYmIHBhcmFtcy52aXJ0dWFsVHJhbnNsYXRlO1xuICAgICAgICBcbiAgICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xuICAgICAgICB2YXIgb3JpZ2luYWxQYXJhbXMgPSB7fTtcbiAgICAgICAgZm9yICh2YXIgcGFyYW0gaW4gcGFyYW1zKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtc1twYXJhbV0gPT09ICdvYmplY3QnICYmIHBhcmFtc1twYXJhbV0gIT09IG51bGwgJiYgIShwYXJhbXNbcGFyYW1dLm5vZGVUeXBlIHx8IHBhcmFtc1twYXJhbV0gPT09IHdpbmRvdyB8fCBwYXJhbXNbcGFyYW1dID09PSBkb2N1bWVudCB8fCAodHlwZW9mIERvbTcgIT09ICd1bmRlZmluZWQnICYmIHBhcmFtc1twYXJhbV0gaW5zdGFuY2VvZiBEb203KSB8fCAodHlwZW9mIGpRdWVyeSAhPT0gJ3VuZGVmaW5lZCcgJiYgcGFyYW1zW3BhcmFtXSBpbnN0YW5jZW9mIGpRdWVyeSkpKSB7XG4gICAgICAgICAgICAgICAgb3JpZ2luYWxQYXJhbXNbcGFyYW1dID0ge307XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgZGVlcFBhcmFtIGluIHBhcmFtc1twYXJhbV0pIHtcbiAgICAgICAgICAgICAgICAgICAgb3JpZ2luYWxQYXJhbXNbcGFyYW1dW2RlZXBQYXJhbV0gPSBwYXJhbXNbcGFyYW1dW2RlZXBQYXJhbV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgb3JpZ2luYWxQYXJhbXNbcGFyYW1dID0gcGFyYW1zW3BhcmFtXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBmb3IgKHZhciBkZWYgaW4gZGVmYXVsdHMpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW2RlZl0gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1zW2RlZl0gPSBkZWZhdWx0c1tkZWZdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIHBhcmFtc1tkZWZdID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGRlZXBEZWYgaW4gZGVmYXVsdHNbZGVmXSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtc1tkZWZdW2RlZXBEZWZdID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zW2RlZl1bZGVlcERlZl0gPSBkZWZhdWx0c1tkZWZdW2RlZXBEZWZdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBTd2lwZXJcbiAgICAgICAgdmFyIHMgPSB0aGlzO1xuICAgICAgICBcbiAgICAgICAgLy8gUGFyYW1zXG4gICAgICAgIHMucGFyYW1zID0gcGFyYW1zO1xuICAgICAgICBzLm9yaWdpbmFsUGFyYW1zID0gb3JpZ2luYWxQYXJhbXM7XG4gICAgICAgIFxuICAgICAgICAvLyBDbGFzc25hbWVcbiAgICAgICAgcy5jbGFzc05hbWVzID0gW107XG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIERvbSBMaWJyYXJ5IGFuZCBwbHVnaW5zXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgaWYgKHR5cGVvZiAkICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgRG9tNyAhPT0gJ3VuZGVmaW5lZCcpe1xuICAgICAgICAgICAgJCA9IERvbTc7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiAkID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBEb203ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICQgPSB3aW5kb3cuRG9tNyB8fCB3aW5kb3cuWmVwdG8gfHwgd2luZG93LmpRdWVyeTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICQgPSBEb203O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCEkKSByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgLy8gRXhwb3J0IGl0IHRvIFN3aXBlciBpbnN0YW5jZVxuICAgICAgICBzLiQgPSAkO1xuICAgICAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgQnJlYWtwb2ludHNcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLmN1cnJlbnRCcmVha3BvaW50ID0gdW5kZWZpbmVkO1xuICAgICAgICBzLmdldEFjdGl2ZUJyZWFrcG9pbnQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAvL0dldCBicmVha3BvaW50IGZvciB3aW5kb3cgd2lkdGhcbiAgICAgICAgICAgIGlmICghcy5wYXJhbXMuYnJlYWtwb2ludHMpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIHZhciBicmVha3BvaW50ID0gZmFsc2U7XG4gICAgICAgICAgICB2YXIgcG9pbnRzID0gW10sIHBvaW50O1xuICAgICAgICAgICAgZm9yICggcG9pbnQgaW4gcy5wYXJhbXMuYnJlYWtwb2ludHMgKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmJyZWFrcG9pbnRzLmhhc093blByb3BlcnR5KHBvaW50KSkge1xuICAgICAgICAgICAgICAgICAgICBwb2ludHMucHVzaChwb2ludCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcG9pbnRzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcGFyc2VJbnQoYSwgMTApID4gcGFyc2VJbnQoYiwgMTApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBvaW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHBvaW50ID0gcG9pbnRzW2ldO1xuICAgICAgICAgICAgICAgIGlmIChwb2ludCA+PSB3aW5kb3cuaW5uZXJXaWR0aCAmJiAhYnJlYWtwb2ludCkge1xuICAgICAgICAgICAgICAgICAgICBicmVha3BvaW50ID0gcG9pbnQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGJyZWFrcG9pbnQgfHwgJ21heCc7XG4gICAgICAgIH07XG4gICAgICAgIHMuc2V0QnJlYWtwb2ludCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIC8vU2V0IGJyZWFrcG9pbnQgZm9yIHdpbmRvdyB3aWR0aCBhbmQgdXBkYXRlIHBhcmFtZXRlcnNcbiAgICAgICAgICAgIHZhciBicmVha3BvaW50ID0gcy5nZXRBY3RpdmVCcmVha3BvaW50KCk7XG4gICAgICAgICAgICBpZiAoYnJlYWtwb2ludCAmJiBzLmN1cnJlbnRCcmVha3BvaW50ICE9PSBicmVha3BvaW50KSB7XG4gICAgICAgICAgICAgICAgdmFyIGJyZWFrUG9pbnRzUGFyYW1zID0gYnJlYWtwb2ludCBpbiBzLnBhcmFtcy5icmVha3BvaW50cyA/IHMucGFyYW1zLmJyZWFrcG9pbnRzW2JyZWFrcG9pbnRdIDogcy5vcmlnaW5hbFBhcmFtcztcbiAgICAgICAgICAgICAgICB2YXIgbmVlZHNSZUxvb3AgPSBzLnBhcmFtcy5sb29wICYmIChicmVha1BvaW50c1BhcmFtcy5zbGlkZXNQZXJWaWV3ICE9PSBzLnBhcmFtcy5zbGlkZXNQZXJWaWV3KTtcbiAgICAgICAgICAgICAgICBmb3IgKCB2YXIgcGFyYW0gaW4gYnJlYWtQb2ludHNQYXJhbXMgKSB7XG4gICAgICAgICAgICAgICAgICAgIHMucGFyYW1zW3BhcmFtXSA9IGJyZWFrUG9pbnRzUGFyYW1zW3BhcmFtXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcy5jdXJyZW50QnJlYWtwb2ludCA9IGJyZWFrcG9pbnQ7XG4gICAgICAgICAgICAgICAgaWYobmVlZHNSZUxvb3AgJiYgcy5kZXN0cm95TG9vcCkge1xuICAgICAgICAgICAgICAgICAgICBzLnJlTG9vcCh0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIC8vIFNldCBicmVha3BvaW50IG9uIGxvYWRcbiAgICAgICAgaWYgKHMucGFyYW1zLmJyZWFrcG9pbnRzKSB7XG4gICAgICAgICAgICBzLnNldEJyZWFrcG9pbnQoKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgUHJlcGFyYXRpb24gLSBEZWZpbmUgQ29udGFpbmVyLCBXcmFwcGVyIGFuZCBQYWdpbmF0aW9uXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgcy5jb250YWluZXIgPSAkKGNvbnRhaW5lcik7XG4gICAgICAgIGlmIChzLmNvbnRhaW5lci5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgaWYgKHMuY29udGFpbmVyLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgIHZhciBzd2lwZXJzID0gW107XG4gICAgICAgICAgICBzLmNvbnRhaW5lci5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgY29udGFpbmVyID0gdGhpcztcbiAgICAgICAgICAgICAgICBzd2lwZXJzLnB1c2gobmV3IFN3aXBlcih0aGlzLCBwYXJhbXMpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHN3aXBlcnM7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIFNhdmUgaW5zdGFuY2UgaW4gY29udGFpbmVyIEhUTUwgRWxlbWVudCBhbmQgaW4gZGF0YVxuICAgICAgICBzLmNvbnRhaW5lclswXS5zd2lwZXIgPSBzO1xuICAgICAgICBzLmNvbnRhaW5lci5kYXRhKCdzd2lwZXInLCBzKTtcbiAgICAgICAgXG4gICAgICAgIHMuY2xhc3NOYW1lcy5wdXNoKCdzd2lwZXItY29udGFpbmVyLScgKyBzLnBhcmFtcy5kaXJlY3Rpb24pO1xuICAgICAgICBcbiAgICAgICAgaWYgKHMucGFyYW1zLmZyZWVNb2RlKSB7XG4gICAgICAgICAgICBzLmNsYXNzTmFtZXMucHVzaCgnc3dpcGVyLWNvbnRhaW5lci1mcmVlLW1vZGUnKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXMuc3VwcG9ydC5mbGV4Ym94KSB7XG4gICAgICAgICAgICBzLmNsYXNzTmFtZXMucHVzaCgnc3dpcGVyLWNvbnRhaW5lci1uby1mbGV4Ym94Jyk7XG4gICAgICAgICAgICBzLnBhcmFtcy5zbGlkZXNQZXJDb2x1bW4gPSAxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzLnBhcmFtcy5hdXRvSGVpZ2h0KSB7XG4gICAgICAgICAgICBzLmNsYXNzTmFtZXMucHVzaCgnc3dpcGVyLWNvbnRhaW5lci1hdXRvaGVpZ2h0Jyk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gRW5hYmxlIHNsaWRlcyBwcm9ncmVzcyB3aGVuIHJlcXVpcmVkXG4gICAgICAgIGlmIChzLnBhcmFtcy5wYXJhbGxheCB8fCBzLnBhcmFtcy53YXRjaFNsaWRlc1Zpc2liaWxpdHkpIHtcbiAgICAgICAgICAgIHMucGFyYW1zLndhdGNoU2xpZGVzUHJvZ3Jlc3MgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIC8vIENvdmVyZmxvdyAvIDNEXG4gICAgICAgIGlmIChbJ2N1YmUnLCAnY292ZXJmbG93JywgJ2ZsaXAnXS5pbmRleE9mKHMucGFyYW1zLmVmZmVjdCkgPj0gMCkge1xuICAgICAgICAgICAgaWYgKHMuc3VwcG9ydC50cmFuc2Zvcm1zM2QpIHtcbiAgICAgICAgICAgICAgICBzLnBhcmFtcy53YXRjaFNsaWRlc1Byb2dyZXNzID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBzLmNsYXNzTmFtZXMucHVzaCgnc3dpcGVyLWNvbnRhaW5lci0zZCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcy5wYXJhbXMuZWZmZWN0ID0gJ3NsaWRlJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAocy5wYXJhbXMuZWZmZWN0ICE9PSAnc2xpZGUnKSB7XG4gICAgICAgICAgICBzLmNsYXNzTmFtZXMucHVzaCgnc3dpcGVyLWNvbnRhaW5lci0nICsgcy5wYXJhbXMuZWZmZWN0KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocy5wYXJhbXMuZWZmZWN0ID09PSAnY3ViZScpIHtcbiAgICAgICAgICAgIHMucGFyYW1zLnJlc2lzdGFuY2VSYXRpbyA9IDA7XG4gICAgICAgICAgICBzLnBhcmFtcy5zbGlkZXNQZXJWaWV3ID0gMTtcbiAgICAgICAgICAgIHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbiA9IDE7XG4gICAgICAgICAgICBzLnBhcmFtcy5zbGlkZXNQZXJHcm91cCA9IDE7XG4gICAgICAgICAgICBzLnBhcmFtcy5jZW50ZXJlZFNsaWRlcyA9IGZhbHNlO1xuICAgICAgICAgICAgcy5wYXJhbXMuc3BhY2VCZXR3ZWVuID0gMDtcbiAgICAgICAgICAgIHMucGFyYW1zLnZpcnR1YWxUcmFuc2xhdGUgPSB0cnVlO1xuICAgICAgICAgICAgcy5wYXJhbXMuc2V0V3JhcHBlclNpemUgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocy5wYXJhbXMuZWZmZWN0ID09PSAnZmFkZScgfHwgcy5wYXJhbXMuZWZmZWN0ID09PSAnZmxpcCcpIHtcbiAgICAgICAgICAgIHMucGFyYW1zLnNsaWRlc1BlclZpZXcgPSAxO1xuICAgICAgICAgICAgcy5wYXJhbXMuc2xpZGVzUGVyQ29sdW1uID0gMTtcbiAgICAgICAgICAgIHMucGFyYW1zLnNsaWRlc1Blckdyb3VwID0gMTtcbiAgICAgICAgICAgIHMucGFyYW1zLndhdGNoU2xpZGVzUHJvZ3Jlc3MgPSB0cnVlO1xuICAgICAgICAgICAgcy5wYXJhbXMuc3BhY2VCZXR3ZWVuID0gMDtcbiAgICAgICAgICAgIHMucGFyYW1zLnNldFdyYXBwZXJTaXplID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGluaXRpYWxWaXJ0dWFsVHJhbnNsYXRlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIHMucGFyYW1zLnZpcnR1YWxUcmFuc2xhdGUgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBHcmFiIEN1cnNvclxuICAgICAgICBpZiAocy5wYXJhbXMuZ3JhYkN1cnNvciAmJiBzLnN1cHBvcnQudG91Y2gpIHtcbiAgICAgICAgICAgIHMucGFyYW1zLmdyYWJDdXJzb3IgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gV3JhcHBlclxuICAgICAgICBzLndyYXBwZXIgPSBzLmNvbnRhaW5lci5jaGlsZHJlbignLicgKyBzLnBhcmFtcy53cmFwcGVyQ2xhc3MpO1xuICAgICAgICBcbiAgICAgICAgLy8gUGFnaW5hdGlvblxuICAgICAgICBpZiAocy5wYXJhbXMucGFnaW5hdGlvbikge1xuICAgICAgICAgICAgcy5wYWdpbmF0aW9uQ29udGFpbmVyID0gJChzLnBhcmFtcy5wYWdpbmF0aW9uKTtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy51bmlxdWVOYXZFbGVtZW50cyAmJiB0eXBlb2Ygcy5wYXJhbXMucGFnaW5hdGlvbiA9PT0gJ3N0cmluZycgJiYgcy5wYWdpbmF0aW9uQ29udGFpbmVyLmxlbmd0aCA+IDEgJiYgcy5jb250YWluZXIuZmluZChzLnBhcmFtcy5wYWdpbmF0aW9uKS5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICBzLnBhZ2luYXRpb25Db250YWluZXIgPSBzLmNvbnRhaW5lci5maW5kKHMucGFyYW1zLnBhZ2luYXRpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wYWdpbmF0aW9uVHlwZSA9PT0gJ2J1bGxldHMnICYmIHMucGFyYW1zLnBhZ2luYXRpb25DbGlja2FibGUpIHtcbiAgICAgICAgICAgICAgICBzLnBhZ2luYXRpb25Db250YWluZXIuYWRkQ2xhc3MoJ3N3aXBlci1wYWdpbmF0aW9uLWNsaWNrYWJsZScpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcy5wYXJhbXMucGFnaW5hdGlvbkNsaWNrYWJsZSA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcy5wYWdpbmF0aW9uQ29udGFpbmVyLmFkZENsYXNzKCdzd2lwZXItcGFnaW5hdGlvbi0nICsgcy5wYXJhbXMucGFnaW5hdGlvblR5cGUpO1xuICAgICAgICB9XG4gICAgICAgIC8vIE5leHQvUHJldiBCdXR0b25zXG4gICAgICAgIGlmIChzLnBhcmFtcy5uZXh0QnV0dG9uIHx8IHMucGFyYW1zLnByZXZCdXR0b24pIHtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5uZXh0QnV0dG9uKSB7XG4gICAgICAgICAgICAgICAgcy5uZXh0QnV0dG9uID0gJChzLnBhcmFtcy5uZXh0QnV0dG9uKTtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMudW5pcXVlTmF2RWxlbWVudHMgJiYgdHlwZW9mIHMucGFyYW1zLm5leHRCdXR0b24gPT09ICdzdHJpbmcnICYmIHMubmV4dEJ1dHRvbi5sZW5ndGggPiAxICYmIHMuY29udGFpbmVyLmZpbmQocy5wYXJhbXMubmV4dEJ1dHRvbikubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHMubmV4dEJ1dHRvbiA9IHMuY29udGFpbmVyLmZpbmQocy5wYXJhbXMubmV4dEJ1dHRvbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnByZXZCdXR0b24pIHtcbiAgICAgICAgICAgICAgICBzLnByZXZCdXR0b24gPSAkKHMucGFyYW1zLnByZXZCdXR0b24pO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy51bmlxdWVOYXZFbGVtZW50cyAmJiB0eXBlb2Ygcy5wYXJhbXMucHJldkJ1dHRvbiA9PT0gJ3N0cmluZycgJiYgcy5wcmV2QnV0dG9uLmxlbmd0aCA+IDEgJiYgcy5jb250YWluZXIuZmluZChzLnBhcmFtcy5wcmV2QnV0dG9uKS5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5wcmV2QnV0dG9uID0gcy5jb250YWluZXIuZmluZChzLnBhcmFtcy5wcmV2QnV0dG9uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIElzIEhvcml6b250YWxcbiAgICAgICAgcy5pc0hvcml6b250YWwgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gcy5wYXJhbXMuZGlyZWN0aW9uID09PSAnaG9yaXpvbnRhbCc7XG4gICAgICAgIH07XG4gICAgICAgIC8vIHMuaXNIID0gaXNIO1xuICAgICAgICBcbiAgICAgICAgLy8gUlRMXG4gICAgICAgIHMucnRsID0gcy5pc0hvcml6b250YWwoKSAmJiAocy5jb250YWluZXJbMF0uZGlyLnRvTG93ZXJDYXNlKCkgPT09ICdydGwnIHx8IHMuY29udGFpbmVyLmNzcygnZGlyZWN0aW9uJykgPT09ICdydGwnKTtcbiAgICAgICAgaWYgKHMucnRsKSB7XG4gICAgICAgICAgICBzLmNsYXNzTmFtZXMucHVzaCgnc3dpcGVyLWNvbnRhaW5lci1ydGwnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gV3JvbmcgUlRMIHN1cHBvcnRcbiAgICAgICAgaWYgKHMucnRsKSB7XG4gICAgICAgICAgICBzLndyb25nUlRMID0gcy53cmFwcGVyLmNzcygnZGlzcGxheScpID09PSAnLXdlYmtpdC1ib3gnO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBDb2x1bW5zXG4gICAgICAgIGlmIChzLnBhcmFtcy5zbGlkZXNQZXJDb2x1bW4gPiAxKSB7XG4gICAgICAgICAgICBzLmNsYXNzTmFtZXMucHVzaCgnc3dpcGVyLWNvbnRhaW5lci1tdWx0aXJvdycpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBDaGVjayBmb3IgQW5kcm9pZFxuICAgICAgICBpZiAocy5kZXZpY2UuYW5kcm9pZCkge1xuICAgICAgICAgICAgcy5jbGFzc05hbWVzLnB1c2goJ3N3aXBlci1jb250YWluZXItYW5kcm9pZCcpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBBZGQgY2xhc3Nlc1xuICAgICAgICBzLmNvbnRhaW5lci5hZGRDbGFzcyhzLmNsYXNzTmFtZXMuam9pbignICcpKTtcbiAgICAgICAgXG4gICAgICAgIC8vIFRyYW5zbGF0ZVxuICAgICAgICBzLnRyYW5zbGF0ZSA9IDA7XG4gICAgICAgIFxuICAgICAgICAvLyBQcm9ncmVzc1xuICAgICAgICBzLnByb2dyZXNzID0gMDtcbiAgICAgICAgXG4gICAgICAgIC8vIFZlbG9jaXR5XG4gICAgICAgIHMudmVsb2NpdHkgPSAwO1xuICAgICAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgTG9ja3MsIHVubG9ja3NcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLmxvY2tTd2lwZVRvTmV4dCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHMucGFyYW1zLmFsbG93U3dpcGVUb05leHQgPSBmYWxzZTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5sb2NrU3dpcGVUb1ByZXYgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBzLnBhcmFtcy5hbGxvd1N3aXBlVG9QcmV2ID0gZmFsc2U7XG4gICAgICAgIH07XG4gICAgICAgIHMubG9ja1N3aXBlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHMucGFyYW1zLmFsbG93U3dpcGVUb05leHQgPSBzLnBhcmFtcy5hbGxvd1N3aXBlVG9QcmV2ID0gZmFsc2U7XG4gICAgICAgIH07XG4gICAgICAgIHMudW5sb2NrU3dpcGVUb05leHQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBzLnBhcmFtcy5hbGxvd1N3aXBlVG9OZXh0ID0gdHJ1ZTtcbiAgICAgICAgfTtcbiAgICAgICAgcy51bmxvY2tTd2lwZVRvUHJldiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHMucGFyYW1zLmFsbG93U3dpcGVUb1ByZXYgPSB0cnVlO1xuICAgICAgICB9O1xuICAgICAgICBzLnVubG9ja1N3aXBlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHMucGFyYW1zLmFsbG93U3dpcGVUb05leHQgPSBzLnBhcmFtcy5hbGxvd1N3aXBlVG9QcmV2ID0gdHJ1ZTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIFJvdW5kIGhlbHBlclxuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGZ1bmN0aW9uIHJvdW5kKGEpIHtcbiAgICAgICAgICAgIHJldHVybiBNYXRoLmZsb29yKGEpO1xuICAgICAgICB9XG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIFNldCBncmFiIGN1cnNvclxuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGlmIChzLnBhcmFtcy5ncmFiQ3Vyc29yKSB7XG4gICAgICAgICAgICBzLmNvbnRhaW5lclswXS5zdHlsZS5jdXJzb3IgPSAnbW92ZSc7XG4gICAgICAgICAgICBzLmNvbnRhaW5lclswXS5zdHlsZS5jdXJzb3IgPSAnLXdlYmtpdC1ncmFiJztcbiAgICAgICAgICAgIHMuY29udGFpbmVyWzBdLnN0eWxlLmN1cnNvciA9ICctbW96LWdyYWInO1xuICAgICAgICAgICAgcy5jb250YWluZXJbMF0uc3R5bGUuY3Vyc29yID0gJ2dyYWInO1xuICAgICAgICB9XG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIFVwZGF0ZSBvbiBJbWFnZXMgUmVhZHlcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLmltYWdlc1RvTG9hZCA9IFtdO1xuICAgICAgICBzLmltYWdlc0xvYWRlZCA9IDA7XG4gICAgICAgIFxuICAgICAgICBzLmxvYWRJbWFnZSA9IGZ1bmN0aW9uIChpbWdFbGVtZW50LCBzcmMsIHNyY3NldCwgY2hlY2tGb3JDb21wbGV0ZSwgY2FsbGJhY2spIHtcbiAgICAgICAgICAgIHZhciBpbWFnZTtcbiAgICAgICAgICAgIGZ1bmN0aW9uIG9uUmVhZHkgKCkge1xuICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykgY2FsbGJhY2soKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghaW1nRWxlbWVudC5jb21wbGV0ZSB8fCAhY2hlY2tGb3JDb21wbGV0ZSkge1xuICAgICAgICAgICAgICAgIGlmIChzcmMpIHtcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2UgPSBuZXcgd2luZG93LkltYWdlKCk7XG4gICAgICAgICAgICAgICAgICAgIGltYWdlLm9ubG9hZCA9IG9uUmVhZHk7XG4gICAgICAgICAgICAgICAgICAgIGltYWdlLm9uZXJyb3IgPSBvblJlYWR5O1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3Jjc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbWFnZS5zcmNzZXQgPSBzcmNzZXQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHNyYykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2Uuc3JjID0gc3JjO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgb25SZWFkeSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB9IGVsc2Ugey8vaW1hZ2UgYWxyZWFkeSBsb2FkZWQuLi5cbiAgICAgICAgICAgICAgICBvblJlYWR5KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHMucHJlbG9hZEltYWdlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHMuaW1hZ2VzVG9Mb2FkID0gcy5jb250YWluZXIuZmluZCgnaW1nJyk7XG4gICAgICAgICAgICBmdW5jdGlvbiBfb25SZWFkeSgpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHMgPT09ICd1bmRlZmluZWQnIHx8IHMgPT09IG51bGwpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAocy5pbWFnZXNMb2FkZWQgIT09IHVuZGVmaW5lZCkgcy5pbWFnZXNMb2FkZWQrKztcbiAgICAgICAgICAgICAgICBpZiAocy5pbWFnZXNMb2FkZWQgPT09IHMuaW1hZ2VzVG9Mb2FkLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMudXBkYXRlT25JbWFnZXNSZWFkeSkgcy51cGRhdGUoKTtcbiAgICAgICAgICAgICAgICAgICAgcy5lbWl0KCdvbkltYWdlc1JlYWR5Jywgcyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzLmltYWdlc1RvTG9hZC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHMubG9hZEltYWdlKHMuaW1hZ2VzVG9Mb2FkW2ldLCAocy5pbWFnZXNUb0xvYWRbaV0uY3VycmVudFNyYyB8fCBzLmltYWdlc1RvTG9hZFtpXS5nZXRBdHRyaWJ1dGUoJ3NyYycpKSwgKHMuaW1hZ2VzVG9Mb2FkW2ldLnNyY3NldCB8fCBzLmltYWdlc1RvTG9hZFtpXS5nZXRBdHRyaWJ1dGUoJ3NyY3NldCcpKSwgdHJ1ZSwgX29uUmVhZHkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgQXV0b3BsYXlcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLmF1dG9wbGF5VGltZW91dElkID0gdW5kZWZpbmVkO1xuICAgICAgICBzLmF1dG9wbGF5aW5nID0gZmFsc2U7XG4gICAgICAgIHMuYXV0b3BsYXlQYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgZnVuY3Rpb24gYXV0b3BsYXkoKSB7XG4gICAgICAgICAgICBzLmF1dG9wbGF5VGltZW91dElkID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgcy5maXhMb29wKCk7XG4gICAgICAgICAgICAgICAgICAgIHMuX3NsaWRlTmV4dCgpO1xuICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uQXV0b3BsYXknLCBzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcy5pc0VuZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5fc2xpZGVOZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uQXV0b3BsYXknLCBzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcGFyYW1zLmF1dG9wbGF5U3RvcE9uTGFzdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMuX3NsaWRlVG8oMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5lbWl0KCdvbkF1dG9wbGF5Jywgcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLnN0b3BBdXRvcGxheSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgcy5wYXJhbXMuYXV0b3BsYXkpO1xuICAgICAgICB9XG4gICAgICAgIHMuc3RhcnRBdXRvcGxheSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygcy5hdXRvcGxheVRpbWVvdXRJZCAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIGlmICghcy5wYXJhbXMuYXV0b3BsYXkpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIGlmIChzLmF1dG9wbGF5aW5nKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICBzLmF1dG9wbGF5aW5nID0gdHJ1ZTtcbiAgICAgICAgICAgIHMuZW1pdCgnb25BdXRvcGxheVN0YXJ0Jywgcyk7XG4gICAgICAgICAgICBhdXRvcGxheSgpO1xuICAgICAgICB9O1xuICAgICAgICBzLnN0b3BBdXRvcGxheSA9IGZ1bmN0aW9uIChpbnRlcm5hbCkge1xuICAgICAgICAgICAgaWYgKCFzLmF1dG9wbGF5VGltZW91dElkKSByZXR1cm47XG4gICAgICAgICAgICBpZiAocy5hdXRvcGxheVRpbWVvdXRJZCkgY2xlYXJUaW1lb3V0KHMuYXV0b3BsYXlUaW1lb3V0SWQpO1xuICAgICAgICAgICAgcy5hdXRvcGxheWluZyA9IGZhbHNlO1xuICAgICAgICAgICAgcy5hdXRvcGxheVRpbWVvdXRJZCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIHMuZW1pdCgnb25BdXRvcGxheVN0b3AnLCBzKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5wYXVzZUF1dG9wbGF5ID0gZnVuY3Rpb24gKHNwZWVkKSB7XG4gICAgICAgICAgICBpZiAocy5hdXRvcGxheVBhdXNlZCkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKHMuYXV0b3BsYXlUaW1lb3V0SWQpIGNsZWFyVGltZW91dChzLmF1dG9wbGF5VGltZW91dElkKTtcbiAgICAgICAgICAgIHMuYXV0b3BsYXlQYXVzZWQgPSB0cnVlO1xuICAgICAgICAgICAgaWYgKHNwZWVkID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcy5hdXRvcGxheVBhdXNlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGF1dG9wbGF5KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzLndyYXBwZXIudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcykgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICBzLmF1dG9wbGF5UGF1c2VkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcy5hdXRvcGxheWluZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5zdG9wQXV0b3BsYXkoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGF1dG9wbGF5KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgTWluL01heCBUcmFuc2xhdGVcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLm1pblRyYW5zbGF0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiAoLXMuc25hcEdyaWRbMF0pO1xuICAgICAgICB9O1xuICAgICAgICBzLm1heFRyYW5zbGF0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiAoLXMuc25hcEdyaWRbcy5zbmFwR3JpZC5sZW5ndGggLSAxXSk7XG4gICAgICAgIH07XG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIFNsaWRlci9zbGlkZXMgc2l6ZXNcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLnVwZGF0ZUF1dG9IZWlnaHQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAvLyBVcGRhdGUgSGVpZ2h0XG4gICAgICAgICAgICB2YXIgc2xpZGUgPSBzLnNsaWRlcy5lcShzLmFjdGl2ZUluZGV4KVswXTtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc2xpZGUgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5ld0hlaWdodCA9IHNsaWRlLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgICAgICBpZiAobmV3SGVpZ2h0KSBzLndyYXBwZXIuY3NzKCdoZWlnaHQnLCBuZXdIZWlnaHQgKyAncHgnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgcy51cGRhdGVDb250YWluZXJTaXplID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIHdpZHRoLCBoZWlnaHQ7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHMucGFyYW1zLndpZHRoICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIHdpZHRoID0gcy5wYXJhbXMud2lkdGg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB3aWR0aCA9IHMuY29udGFpbmVyWzBdLmNsaWVudFdpZHRoO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHR5cGVvZiBzLnBhcmFtcy5oZWlnaHQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgaGVpZ2h0ID0gcy5wYXJhbXMuaGVpZ2h0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaGVpZ2h0ID0gcy5jb250YWluZXJbMF0uY2xpZW50SGVpZ2h0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHdpZHRoID09PSAwICYmIHMuaXNIb3Jpem9udGFsKCkgfHwgaGVpZ2h0ID09PSAwICYmICFzLmlzSG9yaXpvbnRhbCgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vU3VidHJhY3QgcGFkZGluZ3NcbiAgICAgICAgICAgIHdpZHRoID0gd2lkdGggLSBwYXJzZUludChzLmNvbnRhaW5lci5jc3MoJ3BhZGRpbmctbGVmdCcpLCAxMCkgLSBwYXJzZUludChzLmNvbnRhaW5lci5jc3MoJ3BhZGRpbmctcmlnaHQnKSwgMTApO1xuICAgICAgICAgICAgaGVpZ2h0ID0gaGVpZ2h0IC0gcGFyc2VJbnQocy5jb250YWluZXIuY3NzKCdwYWRkaW5nLXRvcCcpLCAxMCkgLSBwYXJzZUludChzLmNvbnRhaW5lci5jc3MoJ3BhZGRpbmctYm90dG9tJyksIDEwKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTdG9yZSB2YWx1ZXNcbiAgICAgICAgICAgIHMud2lkdGggPSB3aWR0aDtcbiAgICAgICAgICAgIHMuaGVpZ2h0ID0gaGVpZ2h0O1xuICAgICAgICAgICAgcy5zaXplID0gcy5pc0hvcml6b250YWwoKSA/IHMud2lkdGggOiBzLmhlaWdodDtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIHMudXBkYXRlU2xpZGVzU2l6ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHMuc2xpZGVzID0gcy53cmFwcGVyLmNoaWxkcmVuKCcuJyArIHMucGFyYW1zLnNsaWRlQ2xhc3MpO1xuICAgICAgICAgICAgcy5zbmFwR3JpZCA9IFtdO1xuICAgICAgICAgICAgcy5zbGlkZXNHcmlkID0gW107XG4gICAgICAgICAgICBzLnNsaWRlc1NpemVzR3JpZCA9IFtdO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBzcGFjZUJldHdlZW4gPSBzLnBhcmFtcy5zcGFjZUJldHdlZW4sXG4gICAgICAgICAgICAgICAgc2xpZGVQb3NpdGlvbiA9IC1zLnBhcmFtcy5zbGlkZXNPZmZzZXRCZWZvcmUsXG4gICAgICAgICAgICAgICAgaSxcbiAgICAgICAgICAgICAgICBwcmV2U2xpZGVTaXplID0gMCxcbiAgICAgICAgICAgICAgICBpbmRleCA9IDA7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHMuc2l6ZSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3BhY2VCZXR3ZWVuID09PSAnc3RyaW5nJyAmJiBzcGFjZUJldHdlZW4uaW5kZXhPZignJScpID49IDApIHtcbiAgICAgICAgICAgICAgICBzcGFjZUJldHdlZW4gPSBwYXJzZUZsb2F0KHNwYWNlQmV0d2Vlbi5yZXBsYWNlKCclJywgJycpKSAvIDEwMCAqIHMuc2l6ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBzLnZpcnR1YWxTaXplID0gLXNwYWNlQmV0d2VlbjtcbiAgICAgICAgICAgIC8vIHJlc2V0IG1hcmdpbnNcbiAgICAgICAgICAgIGlmIChzLnJ0bCkgcy5zbGlkZXMuY3NzKHttYXJnaW5MZWZ0OiAnJywgbWFyZ2luVG9wOiAnJ30pO1xuICAgICAgICAgICAgZWxzZSBzLnNsaWRlcy5jc3Moe21hcmdpblJpZ2h0OiAnJywgbWFyZ2luQm90dG9tOiAnJ30pO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBzbGlkZXNOdW1iZXJFdmVuVG9Sb3dzO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbiA+IDEpIHtcbiAgICAgICAgICAgICAgICBpZiAoTWF0aC5mbG9vcihzLnNsaWRlcy5sZW5ndGggLyBzLnBhcmFtcy5zbGlkZXNQZXJDb2x1bW4pID09PSBzLnNsaWRlcy5sZW5ndGggLyBzLnBhcmFtcy5zbGlkZXNQZXJDb2x1bW4pIHtcbiAgICAgICAgICAgICAgICAgICAgc2xpZGVzTnVtYmVyRXZlblRvUm93cyA9IHMuc2xpZGVzLmxlbmd0aDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNsaWRlc051bWJlckV2ZW5Ub1Jvd3MgPSBNYXRoLmNlaWwocy5zbGlkZXMubGVuZ3RoIC8gcy5wYXJhbXMuc2xpZGVzUGVyQ29sdW1uKSAqIHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNsaWRlc1BlclZpZXcgIT09ICdhdXRvJyAmJiBzLnBhcmFtcy5zbGlkZXNQZXJDb2x1bW5GaWxsID09PSAncm93Jykge1xuICAgICAgICAgICAgICAgICAgICBzbGlkZXNOdW1iZXJFdmVuVG9Sb3dzID0gTWF0aC5tYXgoc2xpZGVzTnVtYmVyRXZlblRvUm93cywgcy5wYXJhbXMuc2xpZGVzUGVyVmlldyAqIHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIENhbGMgc2xpZGVzXG4gICAgICAgICAgICB2YXIgc2xpZGVTaXplO1xuICAgICAgICAgICAgdmFyIHNsaWRlc1BlckNvbHVtbiA9IHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbjtcbiAgICAgICAgICAgIHZhciBzbGlkZXNQZXJSb3cgPSBzbGlkZXNOdW1iZXJFdmVuVG9Sb3dzIC8gc2xpZGVzUGVyQ29sdW1uO1xuICAgICAgICAgICAgdmFyIG51bUZ1bGxDb2x1bW5zID0gc2xpZGVzUGVyUm93IC0gKHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbiAqIHNsaWRlc1BlclJvdyAtIHMuc2xpZGVzLmxlbmd0aCk7XG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcy5zbGlkZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBzbGlkZVNpemUgPSAwO1xuICAgICAgICAgICAgICAgIHZhciBzbGlkZSA9IHMuc2xpZGVzLmVxKGkpO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zbGlkZXNQZXJDb2x1bW4gPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFNldCBzbGlkZXMgb3JkZXJcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1NsaWRlT3JkZXJJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbHVtbiwgcm93O1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuc2xpZGVzUGVyQ29sdW1uRmlsbCA9PT0gJ2NvbHVtbicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbiA9IE1hdGguZmxvb3IoaSAvIHNsaWRlc1BlckNvbHVtbik7XG4gICAgICAgICAgICAgICAgICAgICAgICByb3cgPSBpIC0gY29sdW1uICogc2xpZGVzUGVyQ29sdW1uO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbHVtbiA+IG51bUZ1bGxDb2x1bW5zIHx8IChjb2x1bW4gPT09IG51bUZ1bGxDb2x1bW5zICYmIHJvdyA9PT0gc2xpZGVzUGVyQ29sdW1uLTEpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCsrcm93ID49IHNsaWRlc1BlckNvbHVtbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3cgPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW4rKztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdTbGlkZU9yZGVySW5kZXggPSBjb2x1bW4gKyByb3cgKiBzbGlkZXNOdW1iZXJFdmVuVG9Sb3dzIC8gc2xpZGVzUGVyQ29sdW1uO1xuICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY3NzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJy13ZWJraXQtYm94LW9yZGluYWwtZ3JvdXAnOiBuZXdTbGlkZU9yZGVySW5kZXgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICctbW96LWJveC1vcmRpbmFsLWdyb3VwJzogbmV3U2xpZGVPcmRlckluZGV4LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLW1zLWZsZXgtb3JkZXInOiBuZXdTbGlkZU9yZGVySW5kZXgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICctd2Via2l0LW9yZGVyJzogbmV3U2xpZGVPcmRlckluZGV4LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnb3JkZXInOiBuZXdTbGlkZU9yZGVySW5kZXhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvdyA9IE1hdGguZmxvb3IoaSAvIHNsaWRlc1BlclJvdyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2x1bW4gPSBpIC0gcm93ICogc2xpZGVzUGVyUm93O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHNsaWRlXG4gICAgICAgICAgICAgICAgICAgICAgICAuY3NzKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWFyZ2luLXRvcCc6IChyb3cgIT09IDAgJiYgcy5wYXJhbXMuc3BhY2VCZXR3ZWVuKSAmJiAocy5wYXJhbXMuc3BhY2VCZXR3ZWVuICsgJ3B4JylcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAuYXR0cignZGF0YS1zd2lwZXItY29sdW1uJywgY29sdW1uKVxuICAgICAgICAgICAgICAgICAgICAgICAgLmF0dHIoJ2RhdGEtc3dpcGVyLXJvdycsIHJvdyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoc2xpZGUuY3NzKCdkaXNwbGF5JykgPT09ICdub25lJykgY29udGludWU7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNsaWRlc1BlclZpZXcgPT09ICdhdXRvJykge1xuICAgICAgICAgICAgICAgICAgICBzbGlkZVNpemUgPSBzLmlzSG9yaXpvbnRhbCgpID8gc2xpZGUub3V0ZXJXaWR0aCh0cnVlKSA6IHNsaWRlLm91dGVySGVpZ2h0KHRydWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucm91bmRMZW5ndGhzKSBzbGlkZVNpemUgPSByb3VuZChzbGlkZVNpemUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc2xpZGVTaXplID0gKHMuc2l6ZSAtIChzLnBhcmFtcy5zbGlkZXNQZXJWaWV3IC0gMSkgKiBzcGFjZUJldHdlZW4pIC8gcy5wYXJhbXMuc2xpZGVzUGVyVmlldztcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnJvdW5kTGVuZ3Rocykgc2xpZGVTaXplID0gcm91bmQoc2xpZGVTaXplKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChzLmlzSG9yaXpvbnRhbCgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnNsaWRlc1tpXS5zdHlsZS53aWR0aCA9IHNsaWRlU2l6ZSArICdweCc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnNsaWRlc1tpXS5zdHlsZS5oZWlnaHQgPSBzbGlkZVNpemUgKyAncHgnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHMuc2xpZGVzW2ldLnN3aXBlclNsaWRlU2l6ZSA9IHNsaWRlU2l6ZTtcbiAgICAgICAgICAgICAgICBzLnNsaWRlc1NpemVzR3JpZC5wdXNoKHNsaWRlU2l6ZSk7XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuY2VudGVyZWRTbGlkZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgc2xpZGVQb3NpdGlvbiA9IHNsaWRlUG9zaXRpb24gKyBzbGlkZVNpemUgLyAyICsgcHJldlNsaWRlU2l6ZSAvIDIgKyBzcGFjZUJldHdlZW47XG4gICAgICAgICAgICAgICAgICAgIGlmIChpID09PSAwKSBzbGlkZVBvc2l0aW9uID0gc2xpZGVQb3NpdGlvbiAtIHMuc2l6ZSAvIDIgLSBzcGFjZUJldHdlZW47XG4gICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhzbGlkZVBvc2l0aW9uKSA8IDEgLyAxMDAwKSBzbGlkZVBvc2l0aW9uID0gMDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKChpbmRleCkgJSBzLnBhcmFtcy5zbGlkZXNQZXJHcm91cCA9PT0gMCkgcy5zbmFwR3JpZC5wdXNoKHNsaWRlUG9zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICBzLnNsaWRlc0dyaWQucHVzaChzbGlkZVBvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgoaW5kZXgpICUgcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXAgPT09IDApIHMuc25hcEdyaWQucHVzaChzbGlkZVBvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgcy5zbGlkZXNHcmlkLnB1c2goc2xpZGVQb3NpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIHNsaWRlUG9zaXRpb24gPSBzbGlkZVBvc2l0aW9uICsgc2xpZGVTaXplICsgc3BhY2VCZXR3ZWVuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcy52aXJ0dWFsU2l6ZSArPSBzbGlkZVNpemUgKyBzcGFjZUJldHdlZW47XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHByZXZTbGlkZVNpemUgPSBzbGlkZVNpemU7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGluZGV4ICsrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcy52aXJ0dWFsU2l6ZSA9IE1hdGgubWF4KHMudmlydHVhbFNpemUsIHMuc2l6ZSkgKyBzLnBhcmFtcy5zbGlkZXNPZmZzZXRBZnRlcjtcbiAgICAgICAgICAgIHZhciBuZXdTbGlkZXNHcmlkO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICBzLnJ0bCAmJiBzLndyb25nUlRMICYmIChzLnBhcmFtcy5lZmZlY3QgPT09ICdzbGlkZScgfHwgcy5wYXJhbXMuZWZmZWN0ID09PSAnY292ZXJmbG93JykpIHtcbiAgICAgICAgICAgICAgICBzLndyYXBwZXIuY3NzKHt3aWR0aDogcy52aXJ0dWFsU2l6ZSArIHMucGFyYW1zLnNwYWNlQmV0d2VlbiArICdweCd9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghcy5zdXBwb3J0LmZsZXhib3ggfHwgcy5wYXJhbXMuc2V0V3JhcHBlclNpemUpIHtcbiAgICAgICAgICAgICAgICBpZiAocy5pc0hvcml6b250YWwoKSkgcy53cmFwcGVyLmNzcyh7d2lkdGg6IHMudmlydHVhbFNpemUgKyBzLnBhcmFtcy5zcGFjZUJldHdlZW4gKyAncHgnfSk7XG4gICAgICAgICAgICAgICAgZWxzZSBzLndyYXBwZXIuY3NzKHtoZWlnaHQ6IHMudmlydHVhbFNpemUgKyBzLnBhcmFtcy5zcGFjZUJldHdlZW4gKyAncHgnfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbiA+IDEpIHtcbiAgICAgICAgICAgICAgICBzLnZpcnR1YWxTaXplID0gKHNsaWRlU2l6ZSArIHMucGFyYW1zLnNwYWNlQmV0d2VlbikgKiBzbGlkZXNOdW1iZXJFdmVuVG9Sb3dzO1xuICAgICAgICAgICAgICAgIHMudmlydHVhbFNpemUgPSBNYXRoLmNlaWwocy52aXJ0dWFsU2l6ZSAvIHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbikgLSBzLnBhcmFtcy5zcGFjZUJldHdlZW47XG4gICAgICAgICAgICAgICAgcy53cmFwcGVyLmNzcyh7d2lkdGg6IHMudmlydHVhbFNpemUgKyBzLnBhcmFtcy5zcGFjZUJldHdlZW4gKyAncHgnfSk7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmNlbnRlcmVkU2xpZGVzKSB7XG4gICAgICAgICAgICAgICAgICAgIG5ld1NsaWRlc0dyaWQgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHMuc25hcEdyaWQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLnNuYXBHcmlkW2ldIDwgcy52aXJ0dWFsU2l6ZSArIHMuc25hcEdyaWRbMF0pIG5ld1NsaWRlc0dyaWQucHVzaChzLnNuYXBHcmlkW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzLnNuYXBHcmlkID0gbmV3U2xpZGVzR3JpZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUmVtb3ZlIGxhc3QgZ3JpZCBlbGVtZW50cyBkZXBlbmRpbmcgb24gd2lkdGhcbiAgICAgICAgICAgIGlmICghcy5wYXJhbXMuY2VudGVyZWRTbGlkZXMpIHtcbiAgICAgICAgICAgICAgICBuZXdTbGlkZXNHcmlkID0gW107XG4gICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHMuc25hcEdyaWQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuc25hcEdyaWRbaV0gPD0gcy52aXJ0dWFsU2l6ZSAtIHMuc2l6ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3U2xpZGVzR3JpZC5wdXNoKHMuc25hcEdyaWRbaV0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHMuc25hcEdyaWQgPSBuZXdTbGlkZXNHcmlkO1xuICAgICAgICAgICAgICAgIGlmIChNYXRoLmZsb29yKHMudmlydHVhbFNpemUgLSBzLnNpemUpIC0gTWF0aC5mbG9vcihzLnNuYXBHcmlkW3Muc25hcEdyaWQubGVuZ3RoIC0gMV0pID4gMSkge1xuICAgICAgICAgICAgICAgICAgICBzLnNuYXBHcmlkLnB1c2gocy52aXJ0dWFsU2l6ZSAtIHMuc2l6ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMuc25hcEdyaWQubGVuZ3RoID09PSAwKSBzLnNuYXBHcmlkID0gWzBdO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zcGFjZUJldHdlZW4gIT09IDApIHtcbiAgICAgICAgICAgICAgICBpZiAocy5pc0hvcml6b250YWwoKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5ydGwpIHMuc2xpZGVzLmNzcyh7bWFyZ2luTGVmdDogc3BhY2VCZXR3ZWVuICsgJ3B4J30pO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHMuc2xpZGVzLmNzcyh7bWFyZ2luUmlnaHQ6IHNwYWNlQmV0d2VlbiArICdweCd9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBzLnNsaWRlcy5jc3Moe21hcmdpbkJvdHRvbTogc3BhY2VCZXR3ZWVuICsgJ3B4J30pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLndhdGNoU2xpZGVzUHJvZ3Jlc3MpIHtcbiAgICAgICAgICAgICAgICBzLnVwZGF0ZVNsaWRlc09mZnNldCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBzLnVwZGF0ZVNsaWRlc09mZnNldCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcy5zbGlkZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBzLnNsaWRlc1tpXS5zd2lwZXJTbGlkZU9mZnNldCA9IHMuaXNIb3Jpem9udGFsKCkgPyBzLnNsaWRlc1tpXS5vZmZzZXRMZWZ0IDogcy5zbGlkZXNbaV0ub2Zmc2V0VG9wO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgU2xpZGVyL3NsaWRlcyBwcm9ncmVzc1xuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMudXBkYXRlU2xpZGVzUHJvZ3Jlc3MgPSBmdW5jdGlvbiAodHJhbnNsYXRlKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHRyYW5zbGF0ZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICB0cmFuc2xhdGUgPSBzLnRyYW5zbGF0ZSB8fCAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMuc2xpZGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBzLnNsaWRlc1swXS5zd2lwZXJTbGlkZU9mZnNldCA9PT0gJ3VuZGVmaW5lZCcpIHMudXBkYXRlU2xpZGVzT2Zmc2V0KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIG9mZnNldENlbnRlciA9IC10cmFuc2xhdGU7XG4gICAgICAgICAgICBpZiAocy5ydGwpIG9mZnNldENlbnRlciA9IHRyYW5zbGF0ZTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBWaXNpYmxlIFNsaWRlc1xuICAgICAgICAgICAgcy5zbGlkZXMucmVtb3ZlQ2xhc3Mocy5wYXJhbXMuc2xpZGVWaXNpYmxlQ2xhc3MpO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzLnNsaWRlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciBzbGlkZSA9IHMuc2xpZGVzW2ldO1xuICAgICAgICAgICAgICAgIHZhciBzbGlkZVByb2dyZXNzID0gKG9mZnNldENlbnRlciAtIHNsaWRlLnN3aXBlclNsaWRlT2Zmc2V0KSAvIChzbGlkZS5zd2lwZXJTbGlkZVNpemUgKyBzLnBhcmFtcy5zcGFjZUJldHdlZW4pO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy53YXRjaFNsaWRlc1Zpc2liaWxpdHkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRlQmVmb3JlID0gLShvZmZzZXRDZW50ZXIgLSBzbGlkZS5zd2lwZXJTbGlkZU9mZnNldCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzbGlkZUFmdGVyID0gc2xpZGVCZWZvcmUgKyBzLnNsaWRlc1NpemVzR3JpZFtpXTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlzVmlzaWJsZSA9XG4gICAgICAgICAgICAgICAgICAgICAgICAoc2xpZGVCZWZvcmUgPj0gMCAmJiBzbGlkZUJlZm9yZSA8IHMuc2l6ZSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIChzbGlkZUFmdGVyID4gMCAmJiBzbGlkZUFmdGVyIDw9IHMuc2l6ZSkgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIChzbGlkZUJlZm9yZSA8PSAwICYmIHNsaWRlQWZ0ZXIgPj0gcy5zaXplKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVmlzaWJsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5zbGlkZXMuZXEoaSkuYWRkQ2xhc3Mocy5wYXJhbXMuc2xpZGVWaXNpYmxlQ2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHNsaWRlLnByb2dyZXNzID0gcy5ydGwgPyAtc2xpZGVQcm9ncmVzcyA6IHNsaWRlUHJvZ3Jlc3M7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHMudXBkYXRlUHJvZ3Jlc3MgPSBmdW5jdGlvbiAodHJhbnNsYXRlKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHRyYW5zbGF0ZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICB0cmFuc2xhdGUgPSBzLnRyYW5zbGF0ZSB8fCAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZXNEaWZmID0gcy5tYXhUcmFuc2xhdGUoKSAtIHMubWluVHJhbnNsYXRlKCk7XG4gICAgICAgICAgICB2YXIgd2FzQmVnaW5uaW5nID0gcy5pc0JlZ2lubmluZztcbiAgICAgICAgICAgIHZhciB3YXNFbmQgPSBzLmlzRW5kO1xuICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZXNEaWZmID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcy5wcm9ncmVzcyA9IDA7XG4gICAgICAgICAgICAgICAgcy5pc0JlZ2lubmluZyA9IHMuaXNFbmQgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcy5wcm9ncmVzcyA9ICh0cmFuc2xhdGUgLSBzLm1pblRyYW5zbGF0ZSgpKSAvICh0cmFuc2xhdGVzRGlmZik7XG4gICAgICAgICAgICAgICAgcy5pc0JlZ2lubmluZyA9IHMucHJvZ3Jlc3MgPD0gMDtcbiAgICAgICAgICAgICAgICBzLmlzRW5kID0gcy5wcm9ncmVzcyA+PSAxO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMuaXNCZWdpbm5pbmcgJiYgIXdhc0JlZ2lubmluZykgcy5lbWl0KCdvblJlYWNoQmVnaW5uaW5nJywgcyk7XG4gICAgICAgICAgICBpZiAocy5pc0VuZCAmJiAhd2FzRW5kKSBzLmVtaXQoJ29uUmVhY2hFbmQnLCBzKTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAocy5wYXJhbXMud2F0Y2hTbGlkZXNQcm9ncmVzcykgcy51cGRhdGVTbGlkZXNQcm9ncmVzcyh0cmFuc2xhdGUpO1xuICAgICAgICAgICAgcy5lbWl0KCdvblByb2dyZXNzJywgcywgcy5wcm9ncmVzcyk7XG4gICAgICAgIH07XG4gICAgICAgIHMudXBkYXRlQWN0aXZlSW5kZXggPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgdHJhbnNsYXRlID0gcy5ydGwgPyBzLnRyYW5zbGF0ZSA6IC1zLnRyYW5zbGF0ZTtcbiAgICAgICAgICAgIHZhciBuZXdBY3RpdmVJbmRleCwgaSwgc25hcEluZGV4O1xuICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHMuc2xpZGVzR3JpZC5sZW5ndGg7IGkgKyspIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHMuc2xpZGVzR3JpZFtpICsgMV0gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGUgPj0gcy5zbGlkZXNHcmlkW2ldICYmIHRyYW5zbGF0ZSA8IHMuc2xpZGVzR3JpZFtpICsgMV0gLSAocy5zbGlkZXNHcmlkW2kgKyAxXSAtIHMuc2xpZGVzR3JpZFtpXSkgLyAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdBY3RpdmVJbmRleCA9IGk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodHJhbnNsYXRlID49IHMuc2xpZGVzR3JpZFtpXSAmJiB0cmFuc2xhdGUgPCBzLnNsaWRlc0dyaWRbaSArIDFdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdBY3RpdmVJbmRleCA9IGkgKyAxO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHJhbnNsYXRlID49IHMuc2xpZGVzR3JpZFtpXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3QWN0aXZlSW5kZXggPSBpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gTm9ybWFsaXplIHNsaWRlSW5kZXhcbiAgICAgICAgICAgIGlmIChuZXdBY3RpdmVJbmRleCA8IDAgfHwgdHlwZW9mIG5ld0FjdGl2ZUluZGV4ID09PSAndW5kZWZpbmVkJykgbmV3QWN0aXZlSW5kZXggPSAwO1xuICAgICAgICAgICAgLy8gZm9yIChpID0gMDsgaSA8IHMuc2xpZGVzR3JpZC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIC8vIGlmICgtIHRyYW5zbGF0ZSA+PSBzLnNsaWRlc0dyaWRbaV0pIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gbmV3QWN0aXZlSW5kZXggPSBpO1xuICAgICAgICAgICAgICAgIC8vIH1cbiAgICAgICAgICAgIC8vIH1cbiAgICAgICAgICAgIHNuYXBJbmRleCA9IE1hdGguZmxvb3IobmV3QWN0aXZlSW5kZXggLyBzLnBhcmFtcy5zbGlkZXNQZXJHcm91cCk7XG4gICAgICAgICAgICBpZiAoc25hcEluZGV4ID49IHMuc25hcEdyaWQubGVuZ3RoKSBzbmFwSW5kZXggPSBzLnNuYXBHcmlkLmxlbmd0aCAtIDE7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKG5ld0FjdGl2ZUluZGV4ID09PSBzLmFjdGl2ZUluZGV4KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcy5zbmFwSW5kZXggPSBzbmFwSW5kZXg7XG4gICAgICAgICAgICBzLnByZXZpb3VzSW5kZXggPSBzLmFjdGl2ZUluZGV4O1xuICAgICAgICAgICAgcy5hY3RpdmVJbmRleCA9IG5ld0FjdGl2ZUluZGV4O1xuICAgICAgICAgICAgcy51cGRhdGVDbGFzc2VzKCk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBDbGFzc2VzXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgcy51cGRhdGVDbGFzc2VzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcy5zbGlkZXMucmVtb3ZlQ2xhc3Mocy5wYXJhbXMuc2xpZGVBY3RpdmVDbGFzcyArICcgJyArIHMucGFyYW1zLnNsaWRlTmV4dENsYXNzICsgJyAnICsgcy5wYXJhbXMuc2xpZGVQcmV2Q2xhc3MpO1xuICAgICAgICAgICAgdmFyIGFjdGl2ZVNsaWRlID0gcy5zbGlkZXMuZXEocy5hY3RpdmVJbmRleCk7XG4gICAgICAgICAgICAvLyBBY3RpdmUgY2xhc3Nlc1xuICAgICAgICAgICAgYWN0aXZlU2xpZGUuYWRkQ2xhc3Mocy5wYXJhbXMuc2xpZGVBY3RpdmVDbGFzcyk7XG4gICAgICAgICAgICAvLyBOZXh0IFNsaWRlXG4gICAgICAgICAgICB2YXIgbmV4dFNsaWRlID0gYWN0aXZlU2xpZGUubmV4dCgnLicgKyBzLnBhcmFtcy5zbGlkZUNsYXNzKS5hZGRDbGFzcyhzLnBhcmFtcy5zbGlkZU5leHRDbGFzcyk7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMubG9vcCAmJiBuZXh0U2xpZGUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcy5zbGlkZXMuZXEoMCkuYWRkQ2xhc3Mocy5wYXJhbXMuc2xpZGVOZXh0Q2xhc3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gUHJldiBTbGlkZVxuICAgICAgICAgICAgdmFyIHByZXZTbGlkZSA9IGFjdGl2ZVNsaWRlLnByZXYoJy4nICsgcy5wYXJhbXMuc2xpZGVDbGFzcykuYWRkQ2xhc3Mocy5wYXJhbXMuc2xpZGVQcmV2Q2xhc3MpO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3AgJiYgcHJldlNsaWRlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHMuc2xpZGVzLmVxKC0xKS5hZGRDbGFzcyhzLnBhcmFtcy5zbGlkZVByZXZDbGFzcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUGFnaW5hdGlvblxuICAgICAgICAgICAgaWYgKHMucGFnaW5hdGlvbkNvbnRhaW5lciAmJiBzLnBhZ2luYXRpb25Db250YWluZXIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIC8vIEN1cnJlbnQvVG90YWxcbiAgICAgICAgICAgICAgICB2YXIgY3VycmVudCxcbiAgICAgICAgICAgICAgICAgICAgdG90YWwgPSBzLnBhcmFtcy5sb29wID8gTWF0aC5jZWlsKChzLnNsaWRlcy5sZW5ndGggLSBzLmxvb3BlZFNsaWRlcyAqIDIpIC8gcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXApIDogcy5zbmFwR3JpZC5sZW5ndGg7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IE1hdGguY2VpbCgocy5hY3RpdmVJbmRleCAtIHMubG9vcGVkU2xpZGVzKS9zLnBhcmFtcy5zbGlkZXNQZXJHcm91cCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50ID4gcy5zbGlkZXMubGVuZ3RoIC0gMSAtIHMubG9vcGVkU2xpZGVzICogMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQgLSAocy5zbGlkZXMubGVuZ3RoIC0gcy5sb29wZWRTbGlkZXMgKiAyKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCA+IHRvdGFsIC0gMSkgY3VycmVudCA9IGN1cnJlbnQgLSB0b3RhbDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgPCAwICYmIHMucGFyYW1zLnBhZ2luYXRpb25UeXBlICE9PSAnYnVsbGV0cycpIGN1cnJlbnQgPSB0b3RhbCArIGN1cnJlbnQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHMuc25hcEluZGV4ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHMuc25hcEluZGV4O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IHMuYWN0aXZlSW5kZXggfHwgMDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBUeXBlc1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wYWdpbmF0aW9uVHlwZSA9PT0gJ2J1bGxldHMnICYmIHMuYnVsbGV0cyAmJiBzLmJ1bGxldHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBzLmJ1bGxldHMucmVtb3ZlQ2xhc3Mocy5wYXJhbXMuYnVsbGV0QWN0aXZlQ2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYWdpbmF0aW9uQ29udGFpbmVyLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuYnVsbGV0cy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS5pbmRleCgpID09PSBjdXJyZW50KSAkKHRoaXMpLmFkZENsYXNzKHMucGFyYW1zLmJ1bGxldEFjdGl2ZUNsYXNzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5idWxsZXRzLmVxKGN1cnJlbnQpLmFkZENsYXNzKHMucGFyYW1zLmJ1bGxldEFjdGl2ZUNsYXNzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucGFnaW5hdGlvblR5cGUgPT09ICdmcmFjdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5wYWdpbmF0aW9uQ29udGFpbmVyLmZpbmQoJy4nICsgcy5wYXJhbXMucGFnaW5hdGlvbkN1cnJlbnRDbGFzcykudGV4dChjdXJyZW50ICsgMSk7XG4gICAgICAgICAgICAgICAgICAgIHMucGFnaW5hdGlvbkNvbnRhaW5lci5maW5kKCcuJyArIHMucGFyYW1zLnBhZ2luYXRpb25Ub3RhbENsYXNzKS50ZXh0KHRvdGFsKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnBhZ2luYXRpb25UeXBlID09PSAncHJvZ3Jlc3MnKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzY2FsZSA9IChjdXJyZW50ICsgMSkgLyB0b3RhbCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlWCA9IHNjYWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGVZID0gMTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFzLmlzSG9yaXpvbnRhbCgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVkgPSBzY2FsZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlWCA9IDE7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcy5wYWdpbmF0aW9uQ29udGFpbmVyLmZpbmQoJy4nICsgcy5wYXJhbXMucGFnaW5hdGlvblByb2dyZXNzYmFyQ2xhc3MpLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwwLDApIHNjYWxlWCgnICsgc2NhbGVYICsgJykgc2NhbGVZKCcgKyBzY2FsZVkgKyAnKScpLnRyYW5zaXRpb24ocy5wYXJhbXMuc3BlZWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucGFnaW5hdGlvblR5cGUgPT09ICdjdXN0b20nICYmIHMucGFyYW1zLnBhZ2luYXRpb25DdXN0b21SZW5kZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5wYWdpbmF0aW9uQ29udGFpbmVyLmh0bWwocy5wYXJhbXMucGFnaW5hdGlvbkN1c3RvbVJlbmRlcihzLCBjdXJyZW50ICsgMSwgdG90YWwpKTtcbiAgICAgICAgICAgICAgICAgICAgcy5lbWl0KCdvblBhZ2luYXRpb25SZW5kZXJlZCcsIHMsIHMucGFnaW5hdGlvbkNvbnRhaW5lclswXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIE5leHQvYWN0aXZlIGJ1dHRvbnNcbiAgICAgICAgICAgIGlmICghcy5wYXJhbXMubG9vcCkge1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wcmV2QnV0dG9uICYmIHMucHJldkJ1dHRvbiAmJiBzLnByZXZCdXR0b24ubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5pc0JlZ2lubmluZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5wcmV2QnV0dG9uLmFkZENsYXNzKHMucGFyYW1zLmJ1dHRvbkRpc2FibGVkQ2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmExMXkgJiYgcy5hMTF5KSBzLmExMXkuZGlzYWJsZShzLnByZXZCdXR0b24pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5wcmV2QnV0dG9uLnJlbW92ZUNsYXNzKHMucGFyYW1zLmJ1dHRvbkRpc2FibGVkQ2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmExMXkgJiYgcy5hMTF5KSBzLmExMXkuZW5hYmxlKHMucHJldkJ1dHRvbik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLm5leHRCdXR0b24gJiYgcy5uZXh0QnV0dG9uICYmIHMubmV4dEJ1dHRvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLmlzRW5kKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLm5leHRCdXR0b24uYWRkQ2xhc3Mocy5wYXJhbXMuYnV0dG9uRGlzYWJsZWRDbGFzcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuYTExeSAmJiBzLmExMXkpIHMuYTExeS5kaXNhYmxlKHMubmV4dEJ1dHRvbik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLm5leHRCdXR0b24ucmVtb3ZlQ2xhc3Mocy5wYXJhbXMuYnV0dG9uRGlzYWJsZWRDbGFzcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuYTExeSAmJiBzLmExMXkpIHMuYTExeS5lbmFibGUocy5uZXh0QnV0dG9uKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIFBhZ2luYXRpb25cbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLnVwZGF0ZVBhZ2luYXRpb24gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoIXMucGFyYW1zLnBhZ2luYXRpb24pIHJldHVybjtcbiAgICAgICAgICAgIGlmIChzLnBhZ2luYXRpb25Db250YWluZXIgJiYgcy5wYWdpbmF0aW9uQ29udGFpbmVyLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICB2YXIgcGFnaW5hdGlvbkhUTUwgPSAnJztcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucGFnaW5hdGlvblR5cGUgPT09ICdidWxsZXRzJykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbnVtYmVyT2ZCdWxsZXRzID0gcy5wYXJhbXMubG9vcCA/IE1hdGguY2VpbCgocy5zbGlkZXMubGVuZ3RoIC0gcy5sb29wZWRTbGlkZXMgKiAyKSAvIHMucGFyYW1zLnNsaWRlc1Blckdyb3VwKSA6IHMuc25hcEdyaWQubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG51bWJlck9mQnVsbGV0czsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucGFnaW5hdGlvbkJ1bGxldFJlbmRlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2luYXRpb25IVE1MICs9IHMucGFyYW1zLnBhZ2luYXRpb25CdWxsZXRSZW5kZXIoaSwgcy5wYXJhbXMuYnVsbGV0Q2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnaW5hdGlvbkhUTUwgKz0gJzwnICsgcy5wYXJhbXMucGFnaW5hdGlvbkVsZW1lbnQrJyBjbGFzcz1cIicgKyBzLnBhcmFtcy5idWxsZXRDbGFzcyArICdcIj48LycgKyBzLnBhcmFtcy5wYWdpbmF0aW9uRWxlbWVudCArICc+JztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzLnBhZ2luYXRpb25Db250YWluZXIuaHRtbChwYWdpbmF0aW9uSFRNTCk7XG4gICAgICAgICAgICAgICAgICAgIHMuYnVsbGV0cyA9IHMucGFnaW5hdGlvbkNvbnRhaW5lci5maW5kKCcuJyArIHMucGFyYW1zLmJ1bGxldENsYXNzKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnBhZ2luYXRpb25DbGlja2FibGUgJiYgcy5wYXJhbXMuYTExeSAmJiBzLmExMXkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuYTExeS5pbml0UGFnaW5hdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wYWdpbmF0aW9uVHlwZSA9PT0gJ2ZyYWN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucGFnaW5hdGlvbkZyYWN0aW9uUmVuZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdpbmF0aW9uSFRNTCA9IHMucGFyYW1zLnBhZ2luYXRpb25GcmFjdGlvblJlbmRlcihzLCBzLnBhcmFtcy5wYWdpbmF0aW9uQ3VycmVudENsYXNzLCBzLnBhcmFtcy5wYWdpbmF0aW9uVG90YWxDbGFzcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdpbmF0aW9uSFRNTCA9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPVwiJyArIHMucGFyYW1zLnBhZ2luYXRpb25DdXJyZW50Q2xhc3MgKyAnXCI+PC9zcGFuPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICcgLyAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHNwYW4gY2xhc3M9XCInICsgcy5wYXJhbXMucGFnaW5hdGlvblRvdGFsQ2xhc3MrJ1wiPjwvc3Bhbj4nO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHMucGFnaW5hdGlvbkNvbnRhaW5lci5odG1sKHBhZ2luYXRpb25IVE1MKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnBhZ2luYXRpb25UeXBlID09PSAncHJvZ3Jlc3MnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wYWdpbmF0aW9uUHJvZ3Jlc3NSZW5kZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2luYXRpb25IVE1MID0gcy5wYXJhbXMucGFnaW5hdGlvblByb2dyZXNzUmVuZGVyKHMsIHMucGFyYW1zLnBhZ2luYXRpb25Qcm9ncmVzc2JhckNsYXNzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2luYXRpb25IVE1MID0gJzxzcGFuIGNsYXNzPVwiJyArIHMucGFyYW1zLnBhZ2luYXRpb25Qcm9ncmVzc2JhckNsYXNzICsgJ1wiPjwvc3Bhbj4nO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHMucGFnaW5hdGlvbkNvbnRhaW5lci5odG1sKHBhZ2luYXRpb25IVE1MKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnBhZ2luYXRpb25UeXBlICE9PSAnY3VzdG9tJykge1xuICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uUGFnaW5hdGlvblJlbmRlcmVkJywgcywgcy5wYWdpbmF0aW9uQ29udGFpbmVyWzBdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIENvbW1vbiB1cGRhdGUgbWV0aG9kXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgcy51cGRhdGUgPSBmdW5jdGlvbiAodXBkYXRlVHJhbnNsYXRlKSB7XG4gICAgICAgICAgICBzLnVwZGF0ZUNvbnRhaW5lclNpemUoKTtcbiAgICAgICAgICAgIHMudXBkYXRlU2xpZGVzU2l6ZSgpO1xuICAgICAgICAgICAgcy51cGRhdGVQcm9ncmVzcygpO1xuICAgICAgICAgICAgcy51cGRhdGVQYWdpbmF0aW9uKCk7XG4gICAgICAgICAgICBzLnVwZGF0ZUNsYXNzZXMoKTtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zY3JvbGxiYXIgJiYgcy5zY3JvbGxiYXIpIHtcbiAgICAgICAgICAgICAgICBzLnNjcm9sbGJhci5zZXQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGZvcmNlU2V0VHJhbnNsYXRlKCkge1xuICAgICAgICAgICAgICAgIG5ld1RyYW5zbGF0ZSA9IE1hdGgubWluKE1hdGgubWF4KHMudHJhbnNsYXRlLCBzLm1heFRyYW5zbGF0ZSgpKSwgcy5taW5UcmFuc2xhdGUoKSk7XG4gICAgICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNsYXRlKG5ld1RyYW5zbGF0ZSk7XG4gICAgICAgICAgICAgICAgcy51cGRhdGVBY3RpdmVJbmRleCgpO1xuICAgICAgICAgICAgICAgIHMudXBkYXRlQ2xhc3NlcygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHVwZGF0ZVRyYW5zbGF0ZSkge1xuICAgICAgICAgICAgICAgIHZhciB0cmFuc2xhdGVkLCBuZXdUcmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgaWYgKHMuY29udHJvbGxlciAmJiBzLmNvbnRyb2xsZXIuc3BsaW5lKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuY29udHJvbGxlci5zcGxpbmUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5mcmVlTW9kZSkge1xuICAgICAgICAgICAgICAgICAgICBmb3JjZVNldFRyYW5zbGF0ZSgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuYXV0b0hlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy51cGRhdGVBdXRvSGVpZ2h0KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgocy5wYXJhbXMuc2xpZGVzUGVyVmlldyA9PT0gJ2F1dG8nIHx8IHMucGFyYW1zLnNsaWRlc1BlclZpZXcgPiAxKSAmJiBzLmlzRW5kICYmICFzLnBhcmFtcy5jZW50ZXJlZFNsaWRlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlZCA9IHMuc2xpZGVUbyhzLnNsaWRlcy5sZW5ndGggLSAxLCAwLCBmYWxzZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGVkID0gcy5zbGlkZVRvKHMuYWN0aXZlSW5kZXgsIDAsIGZhbHNlLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRyYW5zbGF0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmNlU2V0VHJhbnNsYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChzLnBhcmFtcy5hdXRvSGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgcy51cGRhdGVBdXRvSGVpZ2h0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBSZXNpemUgSGFuZGxlclxuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMub25SZXNpemUgPSBmdW5jdGlvbiAoZm9yY2VVcGRhdGVQYWdpbmF0aW9uKSB7XG4gICAgICAgICAgICAvL0JyZWFrcG9pbnRzXG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuYnJlYWtwb2ludHMpIHtcbiAgICAgICAgICAgICAgICBzLnNldEJyZWFrcG9pbnQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBEaXNhYmxlIGxvY2tzIG9uIHJlc2l6ZVxuICAgICAgICAgICAgdmFyIGFsbG93U3dpcGVUb1ByZXYgPSBzLnBhcmFtcy5hbGxvd1N3aXBlVG9QcmV2O1xuICAgICAgICAgICAgdmFyIGFsbG93U3dpcGVUb05leHQgPSBzLnBhcmFtcy5hbGxvd1N3aXBlVG9OZXh0O1xuICAgICAgICAgICAgcy5wYXJhbXMuYWxsb3dTd2lwZVRvUHJldiA9IHMucGFyYW1zLmFsbG93U3dpcGVUb05leHQgPSB0cnVlO1xuICAgICAgICBcbiAgICAgICAgICAgIHMudXBkYXRlQ29udGFpbmVyU2l6ZSgpO1xuICAgICAgICAgICAgcy51cGRhdGVTbGlkZXNTaXplKCk7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuc2xpZGVzUGVyVmlldyA9PT0gJ2F1dG8nIHx8IHMucGFyYW1zLmZyZWVNb2RlIHx8IGZvcmNlVXBkYXRlUGFnaW5hdGlvbikgcy51cGRhdGVQYWdpbmF0aW9uKCk7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuc2Nyb2xsYmFyICYmIHMuc2Nyb2xsYmFyKSB7XG4gICAgICAgICAgICAgICAgcy5zY3JvbGxiYXIuc2V0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5jb250cm9sbGVyICYmIHMuY29udHJvbGxlci5zcGxpbmUpIHtcbiAgICAgICAgICAgICAgICBzLmNvbnRyb2xsZXIuc3BsaW5lID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHNsaWRlQ2hhbmdlZEJ5U2xpZGVUbyA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmZyZWVNb2RlKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5ld1RyYW5zbGF0ZSA9IE1hdGgubWluKE1hdGgubWF4KHMudHJhbnNsYXRlLCBzLm1heFRyYW5zbGF0ZSgpKSwgcy5taW5UcmFuc2xhdGUoKSk7XG4gICAgICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNsYXRlKG5ld1RyYW5zbGF0ZSk7XG4gICAgICAgICAgICAgICAgcy51cGRhdGVBY3RpdmVJbmRleCgpO1xuICAgICAgICAgICAgICAgIHMudXBkYXRlQ2xhc3NlcygpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuYXV0b0hlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICBzLnVwZGF0ZUF1dG9IZWlnaHQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzLnVwZGF0ZUNsYXNzZXMoKTtcbiAgICAgICAgICAgICAgICBpZiAoKHMucGFyYW1zLnNsaWRlc1BlclZpZXcgPT09ICdhdXRvJyB8fCBzLnBhcmFtcy5zbGlkZXNQZXJWaWV3ID4gMSkgJiYgcy5pc0VuZCAmJiAhcy5wYXJhbXMuY2VudGVyZWRTbGlkZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgc2xpZGVDaGFuZ2VkQnlTbGlkZVRvID0gcy5zbGlkZVRvKHMuc2xpZGVzLmxlbmd0aCAtIDEsIDAsIGZhbHNlLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNsaWRlQ2hhbmdlZEJ5U2xpZGVUbyA9IHMuc2xpZGVUbyhzLmFjdGl2ZUluZGV4LCAwLCBmYWxzZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxhenlMb2FkaW5nICYmICFzbGlkZUNoYW5nZWRCeVNsaWRlVG8gJiYgcy5sYXp5KSB7XG4gICAgICAgICAgICAgICAgcy5sYXp5LmxvYWQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIFJldHVybiBsb2NrcyBhZnRlciByZXNpemVcbiAgICAgICAgICAgIHMucGFyYW1zLmFsbG93U3dpcGVUb1ByZXYgPSBhbGxvd1N3aXBlVG9QcmV2O1xuICAgICAgICAgICAgcy5wYXJhbXMuYWxsb3dTd2lwZVRvTmV4dCA9IGFsbG93U3dpcGVUb05leHQ7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBFdmVudHNcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBcbiAgICAgICAgLy9EZWZpbmUgVG91Y2ggRXZlbnRzXG4gICAgICAgIHZhciBkZXNrdG9wRXZlbnRzID0gWydtb3VzZWRvd24nLCAnbW91c2Vtb3ZlJywgJ21vdXNldXAnXTtcbiAgICAgICAgaWYgKHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQpIGRlc2t0b3BFdmVudHMgPSBbJ3BvaW50ZXJkb3duJywgJ3BvaW50ZXJtb3ZlJywgJ3BvaW50ZXJ1cCddO1xuICAgICAgICBlbHNlIGlmICh3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQpIGRlc2t0b3BFdmVudHMgPSBbJ01TUG9pbnRlckRvd24nLCAnTVNQb2ludGVyTW92ZScsICdNU1BvaW50ZXJVcCddO1xuICAgICAgICBzLnRvdWNoRXZlbnRzID0ge1xuICAgICAgICAgICAgc3RhcnQgOiBzLnN1cHBvcnQudG91Y2ggfHwgIXMucGFyYW1zLnNpbXVsYXRlVG91Y2ggID8gJ3RvdWNoc3RhcnQnIDogZGVza3RvcEV2ZW50c1swXSxcbiAgICAgICAgICAgIG1vdmUgOiBzLnN1cHBvcnQudG91Y2ggfHwgIXMucGFyYW1zLnNpbXVsYXRlVG91Y2ggPyAndG91Y2htb3ZlJyA6IGRlc2t0b3BFdmVudHNbMV0sXG4gICAgICAgICAgICBlbmQgOiBzLnN1cHBvcnQudG91Y2ggfHwgIXMucGFyYW1zLnNpbXVsYXRlVG91Y2ggPyAndG91Y2hlbmQnIDogZGVza3RvcEV2ZW50c1syXVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIC8vIFdQOCBUb3VjaCBFdmVudHMgRml4XG4gICAgICAgIGlmICh3aW5kb3cubmF2aWdhdG9yLnBvaW50ZXJFbmFibGVkIHx8IHdpbmRvdy5uYXZpZ2F0b3IubXNQb2ludGVyRW5hYmxlZCkge1xuICAgICAgICAgICAgKHMucGFyYW1zLnRvdWNoRXZlbnRzVGFyZ2V0ID09PSAnY29udGFpbmVyJyA/IHMuY29udGFpbmVyIDogcy53cmFwcGVyKS5hZGRDbGFzcygnc3dpcGVyLXdwOC0nICsgcy5wYXJhbXMuZGlyZWN0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gQXR0YWNoL2RldGFjaCBldmVudHNcbiAgICAgICAgcy5pbml0RXZlbnRzID0gZnVuY3Rpb24gKGRldGFjaCkge1xuICAgICAgICAgICAgdmFyIGFjdGlvbkRvbSA9IGRldGFjaCA/ICdvZmYnIDogJ29uJztcbiAgICAgICAgICAgIHZhciBhY3Rpb24gPSBkZXRhY2ggPyAncmVtb3ZlRXZlbnRMaXN0ZW5lcicgOiAnYWRkRXZlbnRMaXN0ZW5lcic7XG4gICAgICAgICAgICB2YXIgdG91Y2hFdmVudHNUYXJnZXQgPSBzLnBhcmFtcy50b3VjaEV2ZW50c1RhcmdldCA9PT0gJ2NvbnRhaW5lcicgPyBzLmNvbnRhaW5lclswXSA6IHMud3JhcHBlclswXTtcbiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBzLnN1cHBvcnQudG91Y2ggPyB0b3VjaEV2ZW50c1RhcmdldCA6IGRvY3VtZW50O1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBtb3ZlQ2FwdHVyZSA9IHMucGFyYW1zLm5lc3RlZCA/IHRydWUgOiBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAvL1RvdWNoIEV2ZW50c1xuICAgICAgICAgICAgaWYgKHMuYnJvd3Nlci5pZSkge1xuICAgICAgICAgICAgICAgIHRvdWNoRXZlbnRzVGFyZ2V0W2FjdGlvbl0ocy50b3VjaEV2ZW50cy5zdGFydCwgcy5vblRvdWNoU3RhcnQsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICB0YXJnZXRbYWN0aW9uXShzLnRvdWNoRXZlbnRzLm1vdmUsIHMub25Ub3VjaE1vdmUsIG1vdmVDYXB0dXJlKTtcbiAgICAgICAgICAgICAgICB0YXJnZXRbYWN0aW9uXShzLnRvdWNoRXZlbnRzLmVuZCwgcy5vblRvdWNoRW5kLCBmYWxzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAocy5zdXBwb3J0LnRvdWNoKSB7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoRXZlbnRzVGFyZ2V0W2FjdGlvbl0ocy50b3VjaEV2ZW50cy5zdGFydCwgcy5vblRvdWNoU3RhcnQsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgdG91Y2hFdmVudHNUYXJnZXRbYWN0aW9uXShzLnRvdWNoRXZlbnRzLm1vdmUsIHMub25Ub3VjaE1vdmUsIG1vdmVDYXB0dXJlKTtcbiAgICAgICAgICAgICAgICAgICAgdG91Y2hFdmVudHNUYXJnZXRbYWN0aW9uXShzLnRvdWNoRXZlbnRzLmVuZCwgcy5vblRvdWNoRW5kLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChwYXJhbXMuc2ltdWxhdGVUb3VjaCAmJiAhcy5kZXZpY2UuaW9zICYmICFzLmRldmljZS5hbmRyb2lkKSB7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoRXZlbnRzVGFyZ2V0W2FjdGlvbl0oJ21vdXNlZG93bicsIHMub25Ub3VjaFN0YXJ0LCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50W2FjdGlvbl0oJ21vdXNlbW92ZScsIHMub25Ub3VjaE1vdmUsIG1vdmVDYXB0dXJlKTtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRbYWN0aW9uXSgnbW91c2V1cCcsIHMub25Ub3VjaEVuZCwgZmFsc2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHdpbmRvd1thY3Rpb25dKCdyZXNpemUnLCBzLm9uUmVzaXplKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBOZXh0LCBQcmV2LCBJbmRleFxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLm5leHRCdXR0b24gJiYgcy5uZXh0QnV0dG9uICYmIHMubmV4dEJ1dHRvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcy5uZXh0QnV0dG9uW2FjdGlvbkRvbV0oJ2NsaWNrJywgcy5vbkNsaWNrTmV4dCk7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmExMXkgJiYgcy5hMTF5KSBzLm5leHRCdXR0b25bYWN0aW9uRG9tXSgna2V5ZG93bicsIHMuYTExeS5vbkVudGVyS2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wcmV2QnV0dG9uICYmIHMucHJldkJ1dHRvbiAmJiBzLnByZXZCdXR0b24ubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHMucHJldkJ1dHRvblthY3Rpb25Eb21dKCdjbGljaycsIHMub25DbGlja1ByZXYpO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5hMTF5ICYmIHMuYTExeSkgcy5wcmV2QnV0dG9uW2FjdGlvbkRvbV0oJ2tleWRvd24nLCBzLmExMXkub25FbnRlcktleSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMucGFnaW5hdGlvbiAmJiBzLnBhcmFtcy5wYWdpbmF0aW9uQ2xpY2thYmxlKSB7XG4gICAgICAgICAgICAgICAgcy5wYWdpbmF0aW9uQ29udGFpbmVyW2FjdGlvbkRvbV0oJ2NsaWNrJywgJy4nICsgcy5wYXJhbXMuYnVsbGV0Q2xhc3MsIHMub25DbGlja0luZGV4KTtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuYTExeSAmJiBzLmExMXkpIHMucGFnaW5hdGlvbkNvbnRhaW5lclthY3Rpb25Eb21dKCdrZXlkb3duJywgJy4nICsgcy5wYXJhbXMuYnVsbGV0Q2xhc3MsIHMuYTExeS5vbkVudGVyS2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQcmV2ZW50IExpbmtzIENsaWNrc1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnByZXZlbnRDbGlja3MgfHwgcy5wYXJhbXMucHJldmVudENsaWNrc1Byb3BhZ2F0aW9uKSB0b3VjaEV2ZW50c1RhcmdldFthY3Rpb25dKCdjbGljaycsIHMucHJldmVudENsaWNrcywgdHJ1ZSk7XG4gICAgICAgIH07XG4gICAgICAgIHMuYXR0YWNoRXZlbnRzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcy5pbml0RXZlbnRzKCk7XG4gICAgICAgIH07XG4gICAgICAgIHMuZGV0YWNoRXZlbnRzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcy5pbml0RXZlbnRzKHRydWUpO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgSGFuZGxlIENsaWNrc1xuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIC8vIFByZXZlbnQgQ2xpY2tzXG4gICAgICAgIHMuYWxsb3dDbGljayA9IHRydWU7XG4gICAgICAgIHMucHJldmVudENsaWNrcyA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICBpZiAoIXMuYWxsb3dDbGljaykge1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wcmV2ZW50Q2xpY2tzKSBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnByZXZlbnRDbGlja3NQcm9wYWdhdGlvbiAmJiBzLmFuaW1hdGluZykge1xuICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgLy8gQ2xpY2tzXG4gICAgICAgIHMub25DbGlja05leHQgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgaWYgKHMuaXNFbmQgJiYgIXMucGFyYW1zLmxvb3ApIHJldHVybjtcbiAgICAgICAgICAgIHMuc2xpZGVOZXh0KCk7XG4gICAgICAgIH07XG4gICAgICAgIHMub25DbGlja1ByZXYgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgaWYgKHMuaXNCZWdpbm5pbmcgJiYgIXMucGFyYW1zLmxvb3ApIHJldHVybjtcbiAgICAgICAgICAgIHMuc2xpZGVQcmV2KCk7XG4gICAgICAgIH07XG4gICAgICAgIHMub25DbGlja0luZGV4ID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIHZhciBpbmRleCA9ICQodGhpcykuaW5kZXgoKSAqIHMucGFyYW1zLnNsaWRlc1Blckdyb3VwO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIGluZGV4ID0gaW5kZXggKyBzLmxvb3BlZFNsaWRlcztcbiAgICAgICAgICAgIHMuc2xpZGVUbyhpbmRleCk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBIYW5kbGUgVG91Y2hlc1xuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGZ1bmN0aW9uIGZpbmRFbGVtZW50SW5FdmVudChlLCBzZWxlY3Rvcikge1xuICAgICAgICAgICAgdmFyIGVsID0gJChlLnRhcmdldCk7XG4gICAgICAgICAgICBpZiAoIWVsLmlzKHNlbGVjdG9yKSkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIGVsID0gZWwucGFyZW50cyhzZWxlY3Rvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHNlbGVjdG9yLm5vZGVUeXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBmb3VuZDtcbiAgICAgICAgICAgICAgICAgICAgZWwucGFyZW50cygpLmVhY2goZnVuY3Rpb24gKGluZGV4LCBfZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfZWwgPT09IHNlbGVjdG9yKSBmb3VuZCA9IHNlbGVjdG9yO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFmb3VuZCkgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gc2VsZWN0b3I7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGVsLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZWxbMF07XG4gICAgICAgIH1cbiAgICAgICAgcy51cGRhdGVDbGlja2VkU2xpZGUgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgdmFyIHNsaWRlID0gZmluZEVsZW1lbnRJbkV2ZW50KGUsICcuJyArIHMucGFyYW1zLnNsaWRlQ2xhc3MpO1xuICAgICAgICAgICAgdmFyIHNsaWRlRm91bmQgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmIChzbGlkZSkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcy5zbGlkZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuc2xpZGVzW2ldID09PSBzbGlkZSkgc2xpZGVGb3VuZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmIChzbGlkZSAmJiBzbGlkZUZvdW5kKSB7XG4gICAgICAgICAgICAgICAgcy5jbGlja2VkU2xpZGUgPSBzbGlkZTtcbiAgICAgICAgICAgICAgICBzLmNsaWNrZWRJbmRleCA9ICQoc2xpZGUpLmluZGV4KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzLmNsaWNrZWRTbGlkZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICBzLmNsaWNrZWRJbmRleCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuc2xpZGVUb0NsaWNrZWRTbGlkZSAmJiBzLmNsaWNrZWRJbmRleCAhPT0gdW5kZWZpbmVkICYmIHMuY2xpY2tlZEluZGV4ICE9PSBzLmFjdGl2ZUluZGV4KSB7XG4gICAgICAgICAgICAgICAgdmFyIHNsaWRlVG9JbmRleCA9IHMuY2xpY2tlZEluZGV4LFxuICAgICAgICAgICAgICAgICAgICByZWFsSW5kZXgsXG4gICAgICAgICAgICAgICAgICAgIGR1cGxpY2F0ZWRTbGlkZXM7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuYW5pbWF0aW5nKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIHJlYWxJbmRleCA9ICQocy5jbGlja2VkU2xpZGUpLmF0dHIoJ2RhdGEtc3dpcGVyLXNsaWRlLWluZGV4Jyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5jZW50ZXJlZFNsaWRlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChzbGlkZVRvSW5kZXggPCBzLmxvb3BlZFNsaWRlcyAtIHMucGFyYW1zLnNsaWRlc1BlclZpZXcvMikgfHwgKHNsaWRlVG9JbmRleCA+IHMuc2xpZGVzLmxlbmd0aCAtIHMubG9vcGVkU2xpZGVzICsgcy5wYXJhbXMuc2xpZGVzUGVyVmlldy8yKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMuZml4TG9vcCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlVG9JbmRleCA9IHMud3JhcHBlci5jaGlsZHJlbignLicgKyBzLnBhcmFtcy5zbGlkZUNsYXNzICsgJ1tkYXRhLXN3aXBlci1zbGlkZS1pbmRleD1cIicgKyByZWFsSW5kZXggKyAnXCJdOm5vdCguc3dpcGVyLXNsaWRlLWR1cGxpY2F0ZSknKS5lcSgwKS5pbmRleCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLnNsaWRlVG8oc2xpZGVUb0luZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMuc2xpZGVUbyhzbGlkZVRvSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNsaWRlVG9JbmRleCA+IHMuc2xpZGVzLmxlbmd0aCAtIHMucGFyYW1zLnNsaWRlc1BlclZpZXcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLmZpeExvb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGlkZVRvSW5kZXggPSBzLndyYXBwZXIuY2hpbGRyZW4oJy4nICsgcy5wYXJhbXMuc2xpZGVDbGFzcyArICdbZGF0YS1zd2lwZXItc2xpZGUtaW5kZXg9XCInICsgcmVhbEluZGV4ICsgJ1wiXTpub3QoLnN3aXBlci1zbGlkZS1kdXBsaWNhdGUpJykuZXEoMCkuaW5kZXgoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5zbGlkZVRvKHNsaWRlVG9JbmRleCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLnNsaWRlVG8oc2xpZGVUb0luZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcy5zbGlkZVRvKHNsaWRlVG9JbmRleCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgdmFyIGlzVG91Y2hlZCxcbiAgICAgICAgICAgIGlzTW92ZWQsXG4gICAgICAgICAgICBhbGxvd1RvdWNoQ2FsbGJhY2tzLFxuICAgICAgICAgICAgdG91Y2hTdGFydFRpbWUsXG4gICAgICAgICAgICBpc1Njcm9sbGluZyxcbiAgICAgICAgICAgIGN1cnJlbnRUcmFuc2xhdGUsXG4gICAgICAgICAgICBzdGFydFRyYW5zbGF0ZSxcbiAgICAgICAgICAgIGFsbG93VGhyZXNob2xkTW92ZSxcbiAgICAgICAgICAgIC8vIEZvcm0gZWxlbWVudHMgdG8gbWF0Y2hcbiAgICAgICAgICAgIGZvcm1FbGVtZW50cyA9ICdpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgYnV0dG9uJyxcbiAgICAgICAgICAgIC8vIExhc3QgY2xpY2sgdGltZVxuICAgICAgICAgICAgbGFzdENsaWNrVGltZSA9IERhdGUubm93KCksIGNsaWNrVGltZW91dCxcbiAgICAgICAgICAgIC8vVmVsb2NpdGllc1xuICAgICAgICAgICAgdmVsb2NpdGllcyA9IFtdLFxuICAgICAgICAgICAgYWxsb3dNb21lbnR1bUJvdW5jZTtcbiAgICAgICAgXG4gICAgICAgIC8vIEFuaW1hdGluZyBGbGFnXG4gICAgICAgIHMuYW5pbWF0aW5nID0gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAvLyBUb3VjaGVzIGluZm9ybWF0aW9uXG4gICAgICAgIHMudG91Y2hlcyA9IHtcbiAgICAgICAgICAgIHN0YXJ0WDogMCxcbiAgICAgICAgICAgIHN0YXJ0WTogMCxcbiAgICAgICAgICAgIGN1cnJlbnRYOiAwLFxuICAgICAgICAgICAgY3VycmVudFk6IDAsXG4gICAgICAgICAgICBkaWZmOiAwXG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvLyBUb3VjaCBoYW5kbGVyc1xuICAgICAgICB2YXIgaXNUb3VjaEV2ZW50LCBzdGFydE1vdmluZztcbiAgICAgICAgcy5vblRvdWNoU3RhcnQgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgaWYgKGUub3JpZ2luYWxFdmVudCkgZSA9IGUub3JpZ2luYWxFdmVudDtcbiAgICAgICAgICAgIGlzVG91Y2hFdmVudCA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnO1xuICAgICAgICAgICAgaWYgKCFpc1RvdWNoRXZlbnQgJiYgJ3doaWNoJyBpbiBlICYmIGUud2hpY2ggPT09IDMpIHJldHVybjtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5ub1N3aXBpbmcgJiYgZmluZEVsZW1lbnRJbkV2ZW50KGUsICcuJyArIHMucGFyYW1zLm5vU3dpcGluZ0NsYXNzKSkge1xuICAgICAgICAgICAgICAgIHMuYWxsb3dDbGljayA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnN3aXBlSGFuZGxlcikge1xuICAgICAgICAgICAgICAgIGlmICghZmluZEVsZW1lbnRJbkV2ZW50KGUsIHMucGFyYW1zLnN3aXBlSGFuZGxlcikpIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgc3RhcnRYID0gcy50b3VjaGVzLmN1cnJlbnRYID0gZS50eXBlID09PSAndG91Y2hzdGFydCcgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBlLnBhZ2VYO1xuICAgICAgICAgICAgdmFyIHN0YXJ0WSA9IHMudG91Y2hlcy5jdXJyZW50WSA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBEbyBOT1Qgc3RhcnQgaWYgaU9TIGVkZ2Ugc3dpcGUgaXMgZGV0ZWN0ZWQuIE90aGVyd2lzZSBpT1MgYXBwIChVSVdlYlZpZXcpIGNhbm5vdCBzd2lwZS10by1nby1iYWNrIGFueW1vcmVcbiAgICAgICAgICAgIGlmKHMuZGV2aWNlLmlvcyAmJiBzLnBhcmFtcy5pT1NFZGdlU3dpcGVEZXRlY3Rpb24gJiYgc3RhcnRYIDw9IHMucGFyYW1zLmlPU0VkZ2VTd2lwZVRocmVzaG9sZCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpc1RvdWNoZWQgPSB0cnVlO1xuICAgICAgICAgICAgaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgYWxsb3dUb3VjaENhbGxiYWNrcyA9IHRydWU7XG4gICAgICAgICAgICBpc1Njcm9sbGluZyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIHN0YXJ0TW92aW5nID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgcy50b3VjaGVzLnN0YXJ0WCA9IHN0YXJ0WDtcbiAgICAgICAgICAgIHMudG91Y2hlcy5zdGFydFkgPSBzdGFydFk7XG4gICAgICAgICAgICB0b3VjaFN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgICAgICAgICBzLmFsbG93Q2xpY2sgPSB0cnVlO1xuICAgICAgICAgICAgcy51cGRhdGVDb250YWluZXJTaXplKCk7XG4gICAgICAgICAgICBzLnN3aXBlRGlyZWN0aW9uID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnRocmVzaG9sZCA+IDApIGFsbG93VGhyZXNob2xkTW92ZSA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKGUudHlwZSAhPT0gJ3RvdWNoc3RhcnQnKSB7XG4gICAgICAgICAgICAgICAgdmFyIHByZXZlbnREZWZhdWx0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAoJChlLnRhcmdldCkuaXMoZm9ybUVsZW1lbnRzKSkgcHJldmVudERlZmF1bHQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiAkKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpLmlzKGZvcm1FbGVtZW50cykpIHtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYWN0aXZlRWxlbWVudC5ibHVyKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChwcmV2ZW50RGVmYXVsdCkge1xuICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcy5lbWl0KCdvblRvdWNoU3RhcnQnLCBzLCBlKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIHMub25Ub3VjaE1vdmUgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgaWYgKGUub3JpZ2luYWxFdmVudCkgZSA9IGUub3JpZ2luYWxFdmVudDtcbiAgICAgICAgICAgIGlmIChpc1RvdWNoRXZlbnQgJiYgZS50eXBlID09PSAnbW91c2Vtb3ZlJykgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKGUucHJldmVudGVkQnlOZXN0ZWRTd2lwZXIpIHtcbiAgICAgICAgICAgICAgICBzLnRvdWNoZXMuc3RhcnRYID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGUucGFnZVg7XG4gICAgICAgICAgICAgICAgcy50b3VjaGVzLnN0YXJ0WSA9IGUudHlwZSA9PT0gJ3RvdWNobW92ZScgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgOiBlLnBhZ2VZO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5vbmx5RXh0ZXJuYWwpIHtcbiAgICAgICAgICAgICAgICAvLyBpc01vdmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBzLmFsbG93Q2xpY2sgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAoaXNUb3VjaGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHMudG91Y2hlcy5zdGFydFggPSBzLnRvdWNoZXMuY3VycmVudFggPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZS5wYWdlWDtcbiAgICAgICAgICAgICAgICAgICAgcy50b3VjaGVzLnN0YXJ0WSA9IHMudG91Y2hlcy5jdXJyZW50WSA9IGUudHlwZSA9PT0gJ3RvdWNobW92ZScgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgOiBlLnBhZ2VZO1xuICAgICAgICAgICAgICAgICAgICB0b3VjaFN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpc1RvdWNoRXZlbnQgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkge1xuICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldCA9PT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiAkKGUudGFyZ2V0KS5pcyhmb3JtRWxlbWVudHMpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzTW92ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBzLmFsbG93Q2xpY2sgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhbGxvd1RvdWNoQ2FsbGJhY2tzKSB7XG4gICAgICAgICAgICAgICAgcy5lbWl0KCdvblRvdWNoTW92ZScsIHMsIGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGUudGFyZ2V0VG91Y2hlcyAmJiBlLnRhcmdldFRvdWNoZXMubGVuZ3RoID4gMSkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgIHMudG91Y2hlcy5jdXJyZW50WCA9IGUudHlwZSA9PT0gJ3RvdWNobW92ZScgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBlLnBhZ2VYO1xuICAgICAgICAgICAgcy50b3VjaGVzLmN1cnJlbnRZID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHR5cGVvZiBpc1Njcm9sbGluZyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICB2YXIgdG91Y2hBbmdsZSA9IE1hdGguYXRhbjIoTWF0aC5hYnMocy50b3VjaGVzLmN1cnJlbnRZIC0gcy50b3VjaGVzLnN0YXJ0WSksIE1hdGguYWJzKHMudG91Y2hlcy5jdXJyZW50WCAtIHMudG91Y2hlcy5zdGFydFgpKSAqIDE4MCAvIE1hdGguUEk7XG4gICAgICAgICAgICAgICAgaXNTY3JvbGxpbmcgPSBzLmlzSG9yaXpvbnRhbCgpID8gdG91Y2hBbmdsZSA+IHMucGFyYW1zLnRvdWNoQW5nbGUgOiAoOTAgLSB0b3VjaEFuZ2xlID4gcy5wYXJhbXMudG91Y2hBbmdsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaXNTY3JvbGxpbmcpIHtcbiAgICAgICAgICAgICAgICBzLmVtaXQoJ29uVG91Y2hNb3ZlT3Bwb3NpdGUnLCBzLCBlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3RhcnRNb3ZpbmcgPT09ICd1bmRlZmluZWQnICYmIHMuYnJvd3Nlci5pZVRvdWNoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMudG91Y2hlcy5jdXJyZW50WCAhPT0gcy50b3VjaGVzLnN0YXJ0WCB8fCBzLnRvdWNoZXMuY3VycmVudFkgIT09IHMudG91Y2hlcy5zdGFydFkpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhcnRNb3ZpbmcgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghaXNUb3VjaGVkKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoaXNTY3JvbGxpbmcpICB7XG4gICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFzdGFydE1vdmluZyAmJiBzLmJyb3dzZXIuaWVUb3VjaCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHMuYWxsb3dDbGljayA9IGZhbHNlO1xuICAgICAgICAgICAgcy5lbWl0KCdvblNsaWRlck1vdmUnLCBzLCBlKTtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy50b3VjaE1vdmVTdG9wUHJvcGFnYXRpb24gJiYgIXMucGFyYW1zLm5lc3RlZCkge1xuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKCFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5sb29wKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuZml4TG9vcCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdGFydFRyYW5zbGF0ZSA9IHMuZ2V0V3JhcHBlclRyYW5zbGF0ZSgpO1xuICAgICAgICAgICAgICAgIHMuc2V0V3JhcHBlclRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgaWYgKHMuYW5pbWF0aW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIHMud3JhcHBlci50cmlnZ2VyKCd3ZWJraXRUcmFuc2l0aW9uRW5kIHRyYW5zaXRpb25lbmQgb1RyYW5zaXRpb25FbmQgTVNUcmFuc2l0aW9uRW5kIG1zVHJhbnNpdGlvbkVuZCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuYXV0b3BsYXkgJiYgcy5hdXRvcGxheWluZykge1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuYXV0b3BsYXlEaXNhYmxlT25JbnRlcmFjdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5zdG9wQXV0b3BsYXkoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMucGF1c2VBdXRvcGxheSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGFsbG93TW9tZW50dW1Cb3VuY2UgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAvL0dyYWIgQ3Vyc29yXG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmdyYWJDdXJzb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5jb250YWluZXJbMF0uc3R5bGUuY3Vyc29yID0gJ21vdmUnO1xuICAgICAgICAgICAgICAgICAgICBzLmNvbnRhaW5lclswXS5zdHlsZS5jdXJzb3IgPSAnLXdlYmtpdC1ncmFiYmluZyc7XG4gICAgICAgICAgICAgICAgICAgIHMuY29udGFpbmVyWzBdLnN0eWxlLmN1cnNvciA9ICctbW96LWdyYWJiaW4nO1xuICAgICAgICAgICAgICAgICAgICBzLmNvbnRhaW5lclswXS5zdHlsZS5jdXJzb3IgPSAnZ3JhYmJpbmcnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlzTW92ZWQgPSB0cnVlO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBkaWZmID0gcy50b3VjaGVzLmRpZmYgPSBzLmlzSG9yaXpvbnRhbCgpID8gcy50b3VjaGVzLmN1cnJlbnRYIC0gcy50b3VjaGVzLnN0YXJ0WCA6IHMudG91Y2hlcy5jdXJyZW50WSAtIHMudG91Y2hlcy5zdGFydFk7XG4gICAgICAgIFxuICAgICAgICAgICAgZGlmZiA9IGRpZmYgKiBzLnBhcmFtcy50b3VjaFJhdGlvO1xuICAgICAgICAgICAgaWYgKHMucnRsKSBkaWZmID0gLWRpZmY7XG4gICAgICAgIFxuICAgICAgICAgICAgcy5zd2lwZURpcmVjdGlvbiA9IGRpZmYgPiAwID8gJ3ByZXYnIDogJ25leHQnO1xuICAgICAgICAgICAgY3VycmVudFRyYW5zbGF0ZSA9IGRpZmYgKyBzdGFydFRyYW5zbGF0ZTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgZGlzYWJsZVBhcmVudFN3aXBlciA9IHRydWU7XG4gICAgICAgICAgICBpZiAoKGRpZmYgPiAwICYmIGN1cnJlbnRUcmFuc2xhdGUgPiBzLm1pblRyYW5zbGF0ZSgpKSkge1xuICAgICAgICAgICAgICAgIGRpc2FibGVQYXJlbnRTd2lwZXIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucmVzaXN0YW5jZSkgY3VycmVudFRyYW5zbGF0ZSA9IHMubWluVHJhbnNsYXRlKCkgLSAxICsgTWF0aC5wb3coLXMubWluVHJhbnNsYXRlKCkgKyBzdGFydFRyYW5zbGF0ZSArIGRpZmYsIHMucGFyYW1zLnJlc2lzdGFuY2VSYXRpbyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChkaWZmIDwgMCAmJiBjdXJyZW50VHJhbnNsYXRlIDwgcy5tYXhUcmFuc2xhdGUoKSkge1xuICAgICAgICAgICAgICAgIGRpc2FibGVQYXJlbnRTd2lwZXIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucmVzaXN0YW5jZSkgY3VycmVudFRyYW5zbGF0ZSA9IHMubWF4VHJhbnNsYXRlKCkgKyAxIC0gTWF0aC5wb3cocy5tYXhUcmFuc2xhdGUoKSAtIHN0YXJ0VHJhbnNsYXRlIC0gZGlmZiwgcy5wYXJhbXMucmVzaXN0YW5jZVJhdGlvKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoZGlzYWJsZVBhcmVudFN3aXBlcikge1xuICAgICAgICAgICAgICAgIGUucHJldmVudGVkQnlOZXN0ZWRTd2lwZXIgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIERpcmVjdGlvbnMgbG9ja3NcbiAgICAgICAgICAgIGlmICghcy5wYXJhbXMuYWxsb3dTd2lwZVRvTmV4dCAmJiBzLnN3aXBlRGlyZWN0aW9uID09PSAnbmV4dCcgJiYgY3VycmVudFRyYW5zbGF0ZSA8IHN0YXJ0VHJhbnNsYXRlKSB7XG4gICAgICAgICAgICAgICAgY3VycmVudFRyYW5zbGF0ZSA9IHN0YXJ0VHJhbnNsYXRlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5hbGxvd1N3aXBlVG9QcmV2ICYmIHMuc3dpcGVEaXJlY3Rpb24gPT09ICdwcmV2JyAmJiBjdXJyZW50VHJhbnNsYXRlID4gc3RhcnRUcmFuc2xhdGUpIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNsYXRlID0gc3RhcnRUcmFuc2xhdGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5mb2xsb3dGaW5nZXIpIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBUaHJlc2hvbGRcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy50aHJlc2hvbGQgPiAwKSB7XG4gICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGRpZmYpID4gcy5wYXJhbXMudGhyZXNob2xkIHx8IGFsbG93VGhyZXNob2xkTW92ZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWFsbG93VGhyZXNob2xkTW92ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWxsb3dUaHJlc2hvbGRNb3ZlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMudG91Y2hlcy5zdGFydFggPSBzLnRvdWNoZXMuY3VycmVudFg7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnRvdWNoZXMuc3RhcnRZID0gcy50b3VjaGVzLmN1cnJlbnRZO1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudFRyYW5zbGF0ZSA9IHN0YXJ0VHJhbnNsYXRlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy50b3VjaGVzLmRpZmYgPSBzLmlzSG9yaXpvbnRhbCgpID8gcy50b3VjaGVzLmN1cnJlbnRYIC0gcy50b3VjaGVzLnN0YXJ0WCA6IHMudG91Y2hlcy5jdXJyZW50WSAtIHMudG91Y2hlcy5zdGFydFk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUcmFuc2xhdGUgPSBzdGFydFRyYW5zbGF0ZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIFVwZGF0ZSBhY3RpdmUgaW5kZXggaW4gZnJlZSBtb2RlXG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuZnJlZU1vZGUgfHwgcy5wYXJhbXMud2F0Y2hTbGlkZXNQcm9ncmVzcykge1xuICAgICAgICAgICAgICAgIHMudXBkYXRlQWN0aXZlSW5kZXgoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5mcmVlTW9kZSkge1xuICAgICAgICAgICAgICAgIC8vVmVsb2NpdHlcbiAgICAgICAgICAgICAgICBpZiAodmVsb2NpdGllcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdGllcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBzLnRvdWNoZXNbcy5pc0hvcml6b250YWwoKSA/ICdzdGFydFgnIDogJ3N0YXJ0WSddLFxuICAgICAgICAgICAgICAgICAgICAgICAgdGltZTogdG91Y2hTdGFydFRpbWVcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZlbG9jaXRpZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBzLnRvdWNoZXNbcy5pc0hvcml6b250YWwoKSA/ICdjdXJyZW50WCcgOiAnY3VycmVudFknXSxcbiAgICAgICAgICAgICAgICAgICAgdGltZTogKG5ldyB3aW5kb3cuRGF0ZSgpKS5nZXRUaW1lKClcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIFVwZGF0ZSBwcm9ncmVzc1xuICAgICAgICAgICAgcy51cGRhdGVQcm9ncmVzcyhjdXJyZW50VHJhbnNsYXRlKTtcbiAgICAgICAgICAgIC8vIFVwZGF0ZSB0cmFuc2xhdGVcbiAgICAgICAgICAgIHMuc2V0V3JhcHBlclRyYW5zbGF0ZShjdXJyZW50VHJhbnNsYXRlKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5vblRvdWNoRW5kID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgIGlmIChlLm9yaWdpbmFsRXZlbnQpIGUgPSBlLm9yaWdpbmFsRXZlbnQ7XG4gICAgICAgICAgICBpZiAoYWxsb3dUb3VjaENhbGxiYWNrcykge1xuICAgICAgICAgICAgICAgIHMuZW1pdCgnb25Ub3VjaEVuZCcsIHMsIGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYWxsb3dUb3VjaENhbGxiYWNrcyA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKCFpc1RvdWNoZWQpIHJldHVybjtcbiAgICAgICAgICAgIC8vUmV0dXJuIEdyYWIgQ3Vyc29yXG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuZ3JhYkN1cnNvciAmJiBpc01vdmVkICYmIGlzVG91Y2hlZCkge1xuICAgICAgICAgICAgICAgIHMuY29udGFpbmVyWzBdLnN0eWxlLmN1cnNvciA9ICdtb3ZlJztcbiAgICAgICAgICAgICAgICBzLmNvbnRhaW5lclswXS5zdHlsZS5jdXJzb3IgPSAnLXdlYmtpdC1ncmFiJztcbiAgICAgICAgICAgICAgICBzLmNvbnRhaW5lclswXS5zdHlsZS5jdXJzb3IgPSAnLW1vei1ncmFiJztcbiAgICAgICAgICAgICAgICBzLmNvbnRhaW5lclswXS5zdHlsZS5jdXJzb3IgPSAnZ3JhYic7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVGltZSBkaWZmXG4gICAgICAgICAgICB2YXIgdG91Y2hFbmRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICAgIHZhciB0aW1lRGlmZiA9IHRvdWNoRW5kVGltZSAtIHRvdWNoU3RhcnRUaW1lO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFRhcCwgZG91YmxlVGFwLCBDbGlja1xuICAgICAgICAgICAgaWYgKHMuYWxsb3dDbGljaykge1xuICAgICAgICAgICAgICAgIHMudXBkYXRlQ2xpY2tlZFNsaWRlKGUpO1xuICAgICAgICAgICAgICAgIHMuZW1pdCgnb25UYXAnLCBzLCBlKTtcbiAgICAgICAgICAgICAgICBpZiAodGltZURpZmYgPCAzMDAgJiYgKHRvdWNoRW5kVGltZSAtIGxhc3RDbGlja1RpbWUpID4gMzAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjbGlja1RpbWVvdXQpIGNsZWFyVGltZW91dChjbGlja1RpbWVvdXQpO1xuICAgICAgICAgICAgICAgICAgICBjbGlja1RpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcykgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnBhZ2luYXRpb25IaWRlICYmIHMucGFnaW5hdGlvbkNvbnRhaW5lci5sZW5ndGggPiAwICYmICEkKGUudGFyZ2V0KS5oYXNDbGFzcyhzLnBhcmFtcy5idWxsZXRDbGFzcykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLnBhZ2luYXRpb25Db250YWluZXIudG9nZ2xlQ2xhc3Mocy5wYXJhbXMucGFnaW5hdGlvbkhpZGRlbkNsYXNzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHMuZW1pdCgnb25DbGljaycsIHMsIGUpO1xuICAgICAgICAgICAgICAgICAgICB9LCAzMDApO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRpbWVEaWZmIDwgMzAwICYmICh0b3VjaEVuZFRpbWUgLSBsYXN0Q2xpY2tUaW1lKSA8IDMwMCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tUaW1lb3V0KSBjbGVhclRpbWVvdXQoY2xpY2tUaW1lb3V0KTtcbiAgICAgICAgICAgICAgICAgICAgcy5lbWl0KCdvbkRvdWJsZVRhcCcsIHMsIGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBsYXN0Q2xpY2tUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChzKSBzLmFsbG93Q2xpY2sgPSB0cnVlO1xuICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKCFpc1RvdWNoZWQgfHwgIWlzTW92ZWQgfHwgIXMuc3dpcGVEaXJlY3Rpb24gfHwgcy50b3VjaGVzLmRpZmYgPT09IDAgfHwgY3VycmVudFRyYW5zbGF0ZSA9PT0gc3RhcnRUcmFuc2xhdGUpIHtcbiAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaXNUb3VjaGVkID0gaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBjdXJyZW50UG9zO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmZvbGxvd0Zpbmdlcikge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRQb3MgPSBzLnJ0bCA/IHMudHJhbnNsYXRlIDogLXMudHJhbnNsYXRlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY3VycmVudFBvcyA9IC1jdXJyZW50VHJhbnNsYXRlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmZyZWVNb2RlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRQb3MgPCAtcy5taW5UcmFuc2xhdGUoKSkge1xuICAgICAgICAgICAgICAgICAgICBzLnNsaWRlVG8ocy5hY3RpdmVJbmRleCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoY3VycmVudFBvcyA+IC1zLm1heFRyYW5zbGF0ZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnNsaWRlcy5sZW5ndGggPCBzLnNuYXBHcmlkLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5zbGlkZVRvKHMuc25hcEdyaWQubGVuZ3RoIC0gMSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnNsaWRlVG8ocy5zbGlkZXMubGVuZ3RoIC0gMSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmZyZWVNb2RlTW9tZW50dW0pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZlbG9jaXRpZXMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxhc3RNb3ZlRXZlbnQgPSB2ZWxvY2l0aWVzLnBvcCgpLCB2ZWxvY2l0eUV2ZW50ID0gdmVsb2NpdGllcy5wb3AoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGlzdGFuY2UgPSBsYXN0TW92ZUV2ZW50LnBvc2l0aW9uIC0gdmVsb2NpdHlFdmVudC5wb3NpdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0aW1lID0gbGFzdE1vdmVFdmVudC50aW1lIC0gdmVsb2NpdHlFdmVudC50aW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy52ZWxvY2l0eSA9IGRpc3RhbmNlIC8gdGltZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMudmVsb2NpdHkgPSBzLnZlbG9jaXR5IC8gMjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhzLnZlbG9jaXR5KSA8IHMucGFyYW1zLmZyZWVNb2RlTWluaW11bVZlbG9jaXR5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy52ZWxvY2l0eSA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIGltcGxpZXMgdGhhdCB0aGUgdXNlciBzdG9wcGVkIG1vdmluZyBhIGZpbmdlciB0aGVuIHJlbGVhc2VkLlxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhlcmUgd291bGQgYmUgbm8gZXZlbnRzIHdpdGggZGlzdGFuY2UgemVybywgc28gdGhlIGxhc3QgZXZlbnQgaXMgc3RhbGUuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGltZSA+IDE1MCB8fCAobmV3IHdpbmRvdy5EYXRlKCkuZ2V0VGltZSgpIC0gbGFzdE1vdmVFdmVudC50aW1lKSA+IDMwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMudmVsb2NpdHkgPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy52ZWxvY2l0eSA9IDA7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHZlbG9jaXRpZXMubGVuZ3RoID0gMDtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1vbWVudHVtRHVyYXRpb24gPSAxMDAwICogcy5wYXJhbXMuZnJlZU1vZGVNb21lbnR1bVJhdGlvO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbW9tZW50dW1EaXN0YW5jZSA9IHMudmVsb2NpdHkgKiBtb21lbnR1bUR1cmF0aW9uO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1Bvc2l0aW9uID0gcy50cmFuc2xhdGUgKyBtb21lbnR1bURpc3RhbmNlO1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5ydGwpIG5ld1Bvc2l0aW9uID0gLSBuZXdQb3NpdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRvQm91bmNlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHZhciBhZnRlckJvdW5jZVBvc2l0aW9uO1xuICAgICAgICAgICAgICAgICAgICB2YXIgYm91bmNlQW1vdW50ID0gTWF0aC5hYnMocy52ZWxvY2l0eSkgKiAyMCAqIHMucGFyYW1zLmZyZWVNb2RlTW9tZW50dW1Cb3VuY2VSYXRpbztcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1Bvc2l0aW9uIDwgcy5tYXhUcmFuc2xhdGUoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmZyZWVNb2RlTW9tZW50dW1Cb3VuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3UG9zaXRpb24gKyBzLm1heFRyYW5zbGF0ZSgpIDwgLWJvdW5jZUFtb3VudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdQb3NpdGlvbiA9IHMubWF4VHJhbnNsYXRlKCkgLSBib3VuY2VBbW91bnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyQm91bmNlUG9zaXRpb24gPSBzLm1heFRyYW5zbGF0ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvQm91bmNlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvd01vbWVudHVtQm91bmNlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1Bvc2l0aW9uID0gcy5tYXhUcmFuc2xhdGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChuZXdQb3NpdGlvbiA+IHMubWluVHJhbnNsYXRlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5mcmVlTW9kZU1vbWVudHVtQm91bmNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1Bvc2l0aW9uIC0gcy5taW5UcmFuc2xhdGUoKSA+IGJvdW5jZUFtb3VudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdQb3NpdGlvbiA9IHMubWluVHJhbnNsYXRlKCkgKyBib3VuY2VBbW91bnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmdGVyQm91bmNlUG9zaXRpb24gPSBzLm1pblRyYW5zbGF0ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvQm91bmNlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbGxvd01vbWVudHVtQm91bmNlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1Bvc2l0aW9uID0gcy5taW5UcmFuc2xhdGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChzLnBhcmFtcy5mcmVlTW9kZVN0aWNreSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGogPSAwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5leHRTbGlkZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IDA7IGogPCBzLnNuYXBHcmlkLmxlbmd0aDsgaiArPSAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMuc25hcEdyaWRbal0gPiAtbmV3UG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dFNsaWRlID0gajtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhzLnNuYXBHcmlkW25leHRTbGlkZV0gLSBuZXdQb3NpdGlvbikgPCBNYXRoLmFicyhzLnNuYXBHcmlkW25leHRTbGlkZSAtIDFdIC0gbmV3UG9zaXRpb24pIHx8IHMuc3dpcGVEaXJlY3Rpb24gPT09ICduZXh0Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1Bvc2l0aW9uID0gcy5zbmFwR3JpZFtuZXh0U2xpZGVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdQb3NpdGlvbiA9IHMuc25hcEdyaWRbbmV4dFNsaWRlIC0gMV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXMucnRsKSBuZXdQb3NpdGlvbiA9IC0gbmV3UG9zaXRpb247XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy9GaXggZHVyYXRpb25cbiAgICAgICAgICAgICAgICAgICAgaWYgKHMudmVsb2NpdHkgIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLnJ0bCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vbWVudHVtRHVyYXRpb24gPSBNYXRoLmFicygoLW5ld1Bvc2l0aW9uIC0gcy50cmFuc2xhdGUpIC8gcy52ZWxvY2l0eSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb21lbnR1bUR1cmF0aW9uID0gTWF0aC5hYnMoKG5ld1Bvc2l0aW9uIC0gcy50cmFuc2xhdGUpIC8gcy52ZWxvY2l0eSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocy5wYXJhbXMuZnJlZU1vZGVTdGlja3kpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuc2xpZGVSZXNldCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuZnJlZU1vZGVNb21lbnR1bUJvdW5jZSAmJiBkb0JvdW5jZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy51cGRhdGVQcm9ncmVzcyhhZnRlckJvdW5jZVBvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuc2V0V3JhcHBlclRyYW5zaXRpb24obW9tZW50dW1EdXJhdGlvbik7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnNldFdyYXBwZXJUcmFuc2xhdGUobmV3UG9zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5vblRyYW5zaXRpb25TdGFydCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5hbmltYXRpbmcgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy53cmFwcGVyLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcyB8fCAhYWxsb3dNb21lbnR1bUJvdW5jZSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMuZW1pdCgnb25Nb21lbnR1bUJvdW5jZScsIHMpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLnNldFdyYXBwZXJUcmFuc2l0aW9uKHMucGFyYW1zLnNwZWVkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLnNldFdyYXBwZXJUcmFuc2xhdGUoYWZ0ZXJCb3VuY2VQb3NpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy53cmFwcGVyLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXMpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5vblRyYW5zaXRpb25FbmQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHMudmVsb2NpdHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMudXBkYXRlUHJvZ3Jlc3MobmV3UG9zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNpdGlvbihtb21lbnR1bUR1cmF0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuc2V0V3JhcHBlclRyYW5zbGF0ZShuZXdQb3NpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLm9uVHJhbnNpdGlvblN0YXJ0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXMuYW5pbWF0aW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5hbmltYXRpbmcgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMud3JhcHBlci50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMub25UcmFuc2l0aW9uRW5kKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy51cGRhdGVQcm9ncmVzcyhuZXdQb3NpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHMudXBkYXRlQWN0aXZlSW5kZXgoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5mcmVlTW9kZU1vbWVudHVtIHx8IHRpbWVEaWZmID49IHMucGFyYW1zLmxvbmdTd2lwZXNNcykge1xuICAgICAgICAgICAgICAgICAgICBzLnVwZGF0ZVByb2dyZXNzKCk7XG4gICAgICAgICAgICAgICAgICAgIHMudXBkYXRlQWN0aXZlSW5kZXgoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIEZpbmQgY3VycmVudCBzbGlkZVxuICAgICAgICAgICAgdmFyIGksIHN0b3BJbmRleCA9IDAsIGdyb3VwU2l6ZSA9IHMuc2xpZGVzU2l6ZXNHcmlkWzBdO1xuICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHMuc2xpZGVzR3JpZC5sZW5ndGg7IGkgKz0gcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXApIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHMuc2xpZGVzR3JpZFtpICsgcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXBdICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFBvcyA+PSBzLnNsaWRlc0dyaWRbaV0gJiYgY3VycmVudFBvcyA8IHMuc2xpZGVzR3JpZFtpICsgcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdG9wSW5kZXggPSBpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBTaXplID0gcy5zbGlkZXNHcmlkW2kgKyBzLnBhcmFtcy5zbGlkZXNQZXJHcm91cF0gLSBzLnNsaWRlc0dyaWRbaV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50UG9zID49IHMuc2xpZGVzR3JpZFtpXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RvcEluZGV4ID0gaTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwU2l6ZSA9IHMuc2xpZGVzR3JpZFtzLnNsaWRlc0dyaWQubGVuZ3RoIC0gMV0gLSBzLnNsaWRlc0dyaWRbcy5zbGlkZXNHcmlkLmxlbmd0aCAtIDJdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIEZpbmQgY3VycmVudCBzbGlkZSBzaXplXG4gICAgICAgICAgICB2YXIgcmF0aW8gPSAoY3VycmVudFBvcyAtIHMuc2xpZGVzR3JpZFtzdG9wSW5kZXhdKSAvIGdyb3VwU2l6ZTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAodGltZURpZmYgPiBzLnBhcmFtcy5sb25nU3dpcGVzTXMpIHtcbiAgICAgICAgICAgICAgICAvLyBMb25nIHRvdWNoZXNcbiAgICAgICAgICAgICAgICBpZiAoIXMucGFyYW1zLmxvbmdTd2lwZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5zbGlkZVRvKHMuYWN0aXZlSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzLnN3aXBlRGlyZWN0aW9uID09PSAnbmV4dCcpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJhdGlvID49IHMucGFyYW1zLmxvbmdTd2lwZXNSYXRpbykgcy5zbGlkZVRvKHN0b3BJbmRleCArIHMucGFyYW1zLnNsaWRlc1Blckdyb3VwKTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBzLnNsaWRlVG8oc3RvcEluZGV4KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzLnN3aXBlRGlyZWN0aW9uID09PSAncHJldicpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJhdGlvID4gKDEgLSBzLnBhcmFtcy5sb25nU3dpcGVzUmF0aW8pKSBzLnNsaWRlVG8oc3RvcEluZGV4ICsgcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXApO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHMuc2xpZGVUbyhzdG9wSW5kZXgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIFNob3J0IHN3aXBlc1xuICAgICAgICAgICAgICAgIGlmICghcy5wYXJhbXMuc2hvcnRTd2lwZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5zbGlkZVRvKHMuYWN0aXZlSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzLnN3aXBlRGlyZWN0aW9uID09PSAnbmV4dCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5zbGlkZVRvKHN0b3BJbmRleCArIHMucGFyYW1zLnNsaWRlc1Blckdyb3VwKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzLnN3aXBlRGlyZWN0aW9uID09PSAncHJldicpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5zbGlkZVRvKHN0b3BJbmRleCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBUcmFuc2l0aW9uc1xuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMuX3NsaWRlVG8gPSBmdW5jdGlvbiAoc2xpZGVJbmRleCwgc3BlZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBzLnNsaWRlVG8oc2xpZGVJbmRleCwgc3BlZWQsIHRydWUsIHRydWUpO1xuICAgICAgICB9O1xuICAgICAgICBzLnNsaWRlVG8gPSBmdW5jdGlvbiAoc2xpZGVJbmRleCwgc3BlZWQsIHJ1bkNhbGxiYWNrcywgaW50ZXJuYWwpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcnVuQ2FsbGJhY2tzID09PSAndW5kZWZpbmVkJykgcnVuQ2FsbGJhY2tzID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc2xpZGVJbmRleCA9PT0gJ3VuZGVmaW5lZCcpIHNsaWRlSW5kZXggPSAwO1xuICAgICAgICAgICAgaWYgKHNsaWRlSW5kZXggPCAwKSBzbGlkZUluZGV4ID0gMDtcbiAgICAgICAgICAgIHMuc25hcEluZGV4ID0gTWF0aC5mbG9vcihzbGlkZUluZGV4IC8gcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXApO1xuICAgICAgICAgICAgaWYgKHMuc25hcEluZGV4ID49IHMuc25hcEdyaWQubGVuZ3RoKSBzLnNuYXBJbmRleCA9IHMuc25hcEdyaWQubGVuZ3RoIC0gMTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgdHJhbnNsYXRlID0gLSBzLnNuYXBHcmlkW3Muc25hcEluZGV4XTtcbiAgICAgICAgICAgIC8vIFN0b3AgYXV0b3BsYXlcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5hdXRvcGxheSAmJiBzLmF1dG9wbGF5aW5nKSB7XG4gICAgICAgICAgICAgICAgaWYgKGludGVybmFsIHx8ICFzLnBhcmFtcy5hdXRvcGxheURpc2FibGVPbkludGVyYWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHMucGF1c2VBdXRvcGxheShzcGVlZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzLnN0b3BBdXRvcGxheSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIFVwZGF0ZSBwcm9ncmVzc1xuICAgICAgICAgICAgcy51cGRhdGVQcm9ncmVzcyh0cmFuc2xhdGUpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIE5vcm1hbGl6ZSBzbGlkZUluZGV4XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHMuc2xpZGVzR3JpZC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmICgtIE1hdGguZmxvb3IodHJhbnNsYXRlICogMTAwKSA+PSBNYXRoLmZsb29yKHMuc2xpZGVzR3JpZFtpXSAqIDEwMCkpIHtcbiAgICAgICAgICAgICAgICAgICAgc2xpZGVJbmRleCA9IGk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIERpcmVjdGlvbnMgbG9ja3NcbiAgICAgICAgICAgIGlmICghcy5wYXJhbXMuYWxsb3dTd2lwZVRvTmV4dCAmJiB0cmFuc2xhdGUgPCBzLnRyYW5zbGF0ZSAmJiB0cmFuc2xhdGUgPCBzLm1pblRyYW5zbGF0ZSgpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5hbGxvd1N3aXBlVG9QcmV2ICYmIHRyYW5zbGF0ZSA+IHMudHJhbnNsYXRlICYmIHRyYW5zbGF0ZSA+IHMubWF4VHJhbnNsYXRlKCkpIHtcbiAgICAgICAgICAgICAgICBpZiAoKHMuYWN0aXZlSW5kZXggfHwgMCkgIT09IHNsaWRlSW5kZXggKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVXBkYXRlIEluZGV4XG4gICAgICAgICAgICBpZiAodHlwZW9mIHNwZWVkID09PSAndW5kZWZpbmVkJykgc3BlZWQgPSBzLnBhcmFtcy5zcGVlZDtcbiAgICAgICAgICAgIHMucHJldmlvdXNJbmRleCA9IHMuYWN0aXZlSW5kZXggfHwgMDtcbiAgICAgICAgICAgIHMuYWN0aXZlSW5kZXggPSBzbGlkZUluZGV4O1xuICAgICAgICBcbiAgICAgICAgICAgIGlmICgocy5ydGwgJiYgLXRyYW5zbGF0ZSA9PT0gcy50cmFuc2xhdGUpIHx8ICghcy5ydGwgJiYgdHJhbnNsYXRlID09PSBzLnRyYW5zbGF0ZSkpIHtcbiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgSGVpZ2h0XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmF1dG9IZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgcy51cGRhdGVBdXRvSGVpZ2h0KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHMudXBkYXRlQ2xhc3NlcygpO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5lZmZlY3QgIT09ICdzbGlkZScpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNsYXRlKHRyYW5zbGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHMudXBkYXRlQ2xhc3NlcygpO1xuICAgICAgICAgICAgcy5vblRyYW5zaXRpb25TdGFydChydW5DYWxsYmFja3MpO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChzcGVlZCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHMuc2V0V3JhcHBlclRyYW5zbGF0ZSh0cmFuc2xhdGUpO1xuICAgICAgICAgICAgICAgIHMuc2V0V3JhcHBlclRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgcy5vblRyYW5zaXRpb25FbmQocnVuQ2FsbGJhY2tzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHMuc2V0V3JhcHBlclRyYW5zbGF0ZSh0cmFuc2xhdGUpO1xuICAgICAgICAgICAgICAgIHMuc2V0V3JhcHBlclRyYW5zaXRpb24oc3BlZWQpO1xuICAgICAgICAgICAgICAgIGlmICghcy5hbmltYXRpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5hbmltYXRpbmcgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBzLndyYXBwZXIudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXMpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMub25UcmFuc2l0aW9uRW5kKHJ1bkNhbGxiYWNrcyk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBzLm9uVHJhbnNpdGlvblN0YXJ0ID0gZnVuY3Rpb24gKHJ1bkNhbGxiYWNrcykge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBydW5DYWxsYmFja3MgPT09ICd1bmRlZmluZWQnKSBydW5DYWxsYmFja3MgPSB0cnVlO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmF1dG9IZWlnaHQpIHtcbiAgICAgICAgICAgICAgICBzLnVwZGF0ZUF1dG9IZWlnaHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLmxhenkpIHMubGF6eS5vblRyYW5zaXRpb25TdGFydCgpO1xuICAgICAgICAgICAgaWYgKHJ1bkNhbGxiYWNrcykge1xuICAgICAgICAgICAgICAgIHMuZW1pdCgnb25UcmFuc2l0aW9uU3RhcnQnLCBzKTtcbiAgICAgICAgICAgICAgICBpZiAocy5hY3RpdmVJbmRleCAhPT0gcy5wcmV2aW91c0luZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgIHMuZW1pdCgnb25TbGlkZUNoYW5nZVN0YXJ0Jywgcyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLmFjdGl2ZUluZGV4ID4gcy5wcmV2aW91c0luZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uU2xpZGVOZXh0U3RhcnQnLCBzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuZW1pdCgnb25TbGlkZVByZXZTdGFydCcsIHMpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgcy5vblRyYW5zaXRpb25FbmQgPSBmdW5jdGlvbiAocnVuQ2FsbGJhY2tzKSB7XG4gICAgICAgICAgICBzLmFuaW1hdGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNpdGlvbigwKTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcnVuQ2FsbGJhY2tzID09PSAndW5kZWZpbmVkJykgcnVuQ2FsbGJhY2tzID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmIChzLmxhenkpIHMubGF6eS5vblRyYW5zaXRpb25FbmQoKTtcbiAgICAgICAgICAgIGlmIChydW5DYWxsYmFja3MpIHtcbiAgICAgICAgICAgICAgICBzLmVtaXQoJ29uVHJhbnNpdGlvbkVuZCcsIHMpO1xuICAgICAgICAgICAgICAgIGlmIChzLmFjdGl2ZUluZGV4ICE9PSBzLnByZXZpb3VzSW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5lbWl0KCdvblNsaWRlQ2hhbmdlRW5kJywgcyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLmFjdGl2ZUluZGV4ID4gcy5wcmV2aW91c0luZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uU2xpZGVOZXh0RW5kJywgcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uU2xpZGVQcmV2RW5kJywgcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuaGFzaG5hdiAmJiBzLmhhc2huYXYpIHtcbiAgICAgICAgICAgICAgICBzLmhhc2huYXYuc2V0SGFzaCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgfTtcbiAgICAgICAgcy5zbGlkZU5leHQgPSBmdW5jdGlvbiAocnVuQ2FsbGJhY2tzLCBzcGVlZCwgaW50ZXJuYWwpIHtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5sb29wKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMuYW5pbWF0aW5nKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgcy5maXhMb29wKCk7XG4gICAgICAgICAgICAgICAgdmFyIGNsaWVudExlZnQgPSBzLmNvbnRhaW5lclswXS5jbGllbnRMZWZ0O1xuICAgICAgICAgICAgICAgIHJldHVybiBzLnNsaWRlVG8ocy5hY3RpdmVJbmRleCArIHMucGFyYW1zLnNsaWRlc1Blckdyb3VwLCBzcGVlZCwgcnVuQ2FsbGJhY2tzLCBpbnRlcm5hbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHJldHVybiBzLnNsaWRlVG8ocy5hY3RpdmVJbmRleCArIHMucGFyYW1zLnNsaWRlc1Blckdyb3VwLCBzcGVlZCwgcnVuQ2FsbGJhY2tzLCBpbnRlcm5hbCk7XG4gICAgICAgIH07XG4gICAgICAgIHMuX3NsaWRlTmV4dCA9IGZ1bmN0aW9uIChzcGVlZCkge1xuICAgICAgICAgICAgcmV0dXJuIHMuc2xpZGVOZXh0KHRydWUsIHNwZWVkLCB0cnVlKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5zbGlkZVByZXYgPSBmdW5jdGlvbiAocnVuQ2FsbGJhY2tzLCBzcGVlZCwgaW50ZXJuYWwpIHtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5sb29wKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMuYW5pbWF0aW5nKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgcy5maXhMb29wKCk7XG4gICAgICAgICAgICAgICAgdmFyIGNsaWVudExlZnQgPSBzLmNvbnRhaW5lclswXS5jbGllbnRMZWZ0O1xuICAgICAgICAgICAgICAgIHJldHVybiBzLnNsaWRlVG8ocy5hY3RpdmVJbmRleCAtIDEsIHNwZWVkLCBydW5DYWxsYmFja3MsIGludGVybmFsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgcmV0dXJuIHMuc2xpZGVUbyhzLmFjdGl2ZUluZGV4IC0gMSwgc3BlZWQsIHJ1bkNhbGxiYWNrcywgaW50ZXJuYWwpO1xuICAgICAgICB9O1xuICAgICAgICBzLl9zbGlkZVByZXYgPSBmdW5jdGlvbiAoc3BlZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBzLnNsaWRlUHJldih0cnVlLCBzcGVlZCwgdHJ1ZSk7XG4gICAgICAgIH07XG4gICAgICAgIHMuc2xpZGVSZXNldCA9IGZ1bmN0aW9uIChydW5DYWxsYmFja3MsIHNwZWVkLCBpbnRlcm5hbCkge1xuICAgICAgICAgICAgcmV0dXJuIHMuc2xpZGVUbyhzLmFjdGl2ZUluZGV4LCBzcGVlZCwgcnVuQ2FsbGJhY2tzKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIFRyYW5zbGF0ZS90cmFuc2l0aW9uIGhlbHBlcnNcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLnNldFdyYXBwZXJUcmFuc2l0aW9uID0gZnVuY3Rpb24gKGR1cmF0aW9uLCBieUNvbnRyb2xsZXIpIHtcbiAgICAgICAgICAgIHMud3JhcHBlci50cmFuc2l0aW9uKGR1cmF0aW9uKTtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5lZmZlY3QgIT09ICdzbGlkZScgJiYgcy5lZmZlY3RzW3MucGFyYW1zLmVmZmVjdF0pIHtcbiAgICAgICAgICAgICAgICBzLmVmZmVjdHNbcy5wYXJhbXMuZWZmZWN0XS5zZXRUcmFuc2l0aW9uKGR1cmF0aW9uKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wYXJhbGxheCAmJiBzLnBhcmFsbGF4KSB7XG4gICAgICAgICAgICAgICAgcy5wYXJhbGxheC5zZXRUcmFuc2l0aW9uKGR1cmF0aW9uKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zY3JvbGxiYXIgJiYgcy5zY3JvbGxiYXIpIHtcbiAgICAgICAgICAgICAgICBzLnNjcm9sbGJhci5zZXRUcmFuc2l0aW9uKGR1cmF0aW9uKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5jb250cm9sICYmIHMuY29udHJvbGxlcikge1xuICAgICAgICAgICAgICAgIHMuY29udHJvbGxlci5zZXRUcmFuc2l0aW9uKGR1cmF0aW9uLCBieUNvbnRyb2xsZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcy5lbWl0KCdvblNldFRyYW5zaXRpb24nLCBzLCBkdXJhdGlvbik7XG4gICAgICAgIH07XG4gICAgICAgIHMuc2V0V3JhcHBlclRyYW5zbGF0ZSA9IGZ1bmN0aW9uICh0cmFuc2xhdGUsIHVwZGF0ZUFjdGl2ZUluZGV4LCBieUNvbnRyb2xsZXIpIHtcbiAgICAgICAgICAgIHZhciB4ID0gMCwgeSA9IDAsIHogPSAwO1xuICAgICAgICAgICAgaWYgKHMuaXNIb3Jpem9udGFsKCkpIHtcbiAgICAgICAgICAgICAgICB4ID0gcy5ydGwgPyAtdHJhbnNsYXRlIDogdHJhbnNsYXRlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgeSA9IHRyYW5zbGF0ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAocy5wYXJhbXMucm91bmRMZW5ndGhzKSB7XG4gICAgICAgICAgICAgICAgeCA9IHJvdW5kKHgpO1xuICAgICAgICAgICAgICAgIHkgPSByb3VuZCh5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoIXMucGFyYW1zLnZpcnR1YWxUcmFuc2xhdGUpIHtcbiAgICAgICAgICAgICAgICBpZiAocy5zdXBwb3J0LnRyYW5zZm9ybXMzZCkgcy53cmFwcGVyLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHggKyAncHgsICcgKyB5ICsgJ3B4LCAnICsgeiArICdweCknKTtcbiAgICAgICAgICAgICAgICBlbHNlIHMud3JhcHBlci50cmFuc2Zvcm0oJ3RyYW5zbGF0ZSgnICsgeCArICdweCwgJyArIHkgKyAncHgpJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgcy50cmFuc2xhdGUgPSBzLmlzSG9yaXpvbnRhbCgpID8geCA6IHk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ2hlY2sgaWYgd2UgbmVlZCB0byB1cGRhdGUgcHJvZ3Jlc3NcbiAgICAgICAgICAgIHZhciBwcm9ncmVzcztcbiAgICAgICAgICAgIHZhciB0cmFuc2xhdGVzRGlmZiA9IHMubWF4VHJhbnNsYXRlKCkgLSBzLm1pblRyYW5zbGF0ZSgpO1xuICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZXNEaWZmID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcHJvZ3Jlc3MgPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcHJvZ3Jlc3MgPSAodHJhbnNsYXRlIC0gcy5taW5UcmFuc2xhdGUoKSkgLyAodHJhbnNsYXRlc0RpZmYpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHByb2dyZXNzICE9PSBzLnByb2dyZXNzKSB7XG4gICAgICAgICAgICAgICAgcy51cGRhdGVQcm9ncmVzcyh0cmFuc2xhdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmICh1cGRhdGVBY3RpdmVJbmRleCkgcy51cGRhdGVBY3RpdmVJbmRleCgpO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmVmZmVjdCAhPT0gJ3NsaWRlJyAmJiBzLmVmZmVjdHNbcy5wYXJhbXMuZWZmZWN0XSkge1xuICAgICAgICAgICAgICAgIHMuZWZmZWN0c1tzLnBhcmFtcy5lZmZlY3RdLnNldFRyYW5zbGF0ZShzLnRyYW5zbGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMucGFyYWxsYXggJiYgcy5wYXJhbGxheCkge1xuICAgICAgICAgICAgICAgIHMucGFyYWxsYXguc2V0VHJhbnNsYXRlKHMudHJhbnNsYXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zY3JvbGxiYXIgJiYgcy5zY3JvbGxiYXIpIHtcbiAgICAgICAgICAgICAgICBzLnNjcm9sbGJhci5zZXRUcmFuc2xhdGUocy50cmFuc2xhdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmNvbnRyb2wgJiYgcy5jb250cm9sbGVyKSB7XG4gICAgICAgICAgICAgICAgcy5jb250cm9sbGVyLnNldFRyYW5zbGF0ZShzLnRyYW5zbGF0ZSwgYnlDb250cm9sbGVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHMuZW1pdCgnb25TZXRUcmFuc2xhdGUnLCBzLCBzLnRyYW5zbGF0ZSk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBzLmdldFRyYW5zbGF0ZSA9IGZ1bmN0aW9uIChlbCwgYXhpcykge1xuICAgICAgICAgICAgdmFyIG1hdHJpeCwgY3VyVHJhbnNmb3JtLCBjdXJTdHlsZSwgdHJhbnNmb3JtTWF0cml4O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIGF1dG9tYXRpYyBheGlzIGRldGVjdGlvblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBheGlzID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIGF4aXMgPSAneCc7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnZpcnR1YWxUcmFuc2xhdGUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcy5ydGwgPyAtcy50cmFuc2xhdGUgOiBzLnRyYW5zbGF0ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBjdXJTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsLCBudWxsKTtcbiAgICAgICAgICAgIGlmICh3aW5kb3cuV2ViS2l0Q1NTTWF0cml4KSB7XG4gICAgICAgICAgICAgICAgY3VyVHJhbnNmb3JtID0gY3VyU3R5bGUudHJhbnNmb3JtIHx8IGN1clN0eWxlLndlYmtpdFRyYW5zZm9ybTtcbiAgICAgICAgICAgICAgICBpZiAoY3VyVHJhbnNmb3JtLnNwbGl0KCcsJykubGVuZ3RoID4gNikge1xuICAgICAgICAgICAgICAgICAgICBjdXJUcmFuc2Zvcm0gPSBjdXJUcmFuc2Zvcm0uc3BsaXQoJywgJykubWFwKGZ1bmN0aW9uKGEpe1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEucmVwbGFjZSgnLCcsJy4nKTtcbiAgICAgICAgICAgICAgICAgICAgfSkuam9pbignLCAnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gU29tZSBvbGQgdmVyc2lvbnMgb2YgV2Via2l0IGNob2tlIHdoZW4gJ25vbmUnIGlzIHBhc3NlZDsgcGFzc1xuICAgICAgICAgICAgICAgIC8vIGVtcHR5IHN0cmluZyBpbnN0ZWFkIGluIHRoaXMgY2FzZVxuICAgICAgICAgICAgICAgIHRyYW5zZm9ybU1hdHJpeCA9IG5ldyB3aW5kb3cuV2ViS2l0Q1NTTWF0cml4KGN1clRyYW5zZm9ybSA9PT0gJ25vbmUnID8gJycgOiBjdXJUcmFuc2Zvcm0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdHJhbnNmb3JtTWF0cml4ID0gY3VyU3R5bGUuTW96VHJhbnNmb3JtIHx8IGN1clN0eWxlLk9UcmFuc2Zvcm0gfHwgY3VyU3R5bGUuTXNUcmFuc2Zvcm0gfHwgY3VyU3R5bGUubXNUcmFuc2Zvcm0gIHx8IGN1clN0eWxlLnRyYW5zZm9ybSB8fCBjdXJTdHlsZS5nZXRQcm9wZXJ0eVZhbHVlKCd0cmFuc2Zvcm0nKS5yZXBsYWNlKCd0cmFuc2xhdGUoJywgJ21hdHJpeCgxLCAwLCAwLCAxLCcpO1xuICAgICAgICAgICAgICAgIG1hdHJpeCA9IHRyYW5zZm9ybU1hdHJpeC50b1N0cmluZygpLnNwbGl0KCcsJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKGF4aXMgPT09ICd4Jykge1xuICAgICAgICAgICAgICAgIC8vTGF0ZXN0IENocm9tZSBhbmQgd2Via2l0cyBGaXhcbiAgICAgICAgICAgICAgICBpZiAod2luZG93LldlYktpdENTU01hdHJpeClcbiAgICAgICAgICAgICAgICAgICAgY3VyVHJhbnNmb3JtID0gdHJhbnNmb3JtTWF0cml4Lm00MTtcbiAgICAgICAgICAgICAgICAvL0NyYXp5IElFMTAgTWF0cml4XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAobWF0cml4Lmxlbmd0aCA9PT0gMTYpXG4gICAgICAgICAgICAgICAgICAgIGN1clRyYW5zZm9ybSA9IHBhcnNlRmxvYXQobWF0cml4WzEyXSk7XG4gICAgICAgICAgICAgICAgLy9Ob3JtYWwgQnJvd3NlcnNcbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIGN1clRyYW5zZm9ybSA9IHBhcnNlRmxvYXQobWF0cml4WzRdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChheGlzID09PSAneScpIHtcbiAgICAgICAgICAgICAgICAvL0xhdGVzdCBDaHJvbWUgYW5kIHdlYmtpdHMgRml4XG4gICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5XZWJLaXRDU1NNYXRyaXgpXG4gICAgICAgICAgICAgICAgICAgIGN1clRyYW5zZm9ybSA9IHRyYW5zZm9ybU1hdHJpeC5tNDI7XG4gICAgICAgICAgICAgICAgLy9DcmF6eSBJRTEwIE1hdHJpeFxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1hdHJpeC5sZW5ndGggPT09IDE2KVxuICAgICAgICAgICAgICAgICAgICBjdXJUcmFuc2Zvcm0gPSBwYXJzZUZsb2F0KG1hdHJpeFsxM10pO1xuICAgICAgICAgICAgICAgIC8vTm9ybWFsIEJyb3dzZXJzXG4gICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICBjdXJUcmFuc2Zvcm0gPSBwYXJzZUZsb2F0KG1hdHJpeFs1XSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5ydGwgJiYgY3VyVHJhbnNmb3JtKSBjdXJUcmFuc2Zvcm0gPSAtY3VyVHJhbnNmb3JtO1xuICAgICAgICAgICAgcmV0dXJuIGN1clRyYW5zZm9ybSB8fCAwO1xuICAgICAgICB9O1xuICAgICAgICBzLmdldFdyYXBwZXJUcmFuc2xhdGUgPSBmdW5jdGlvbiAoYXhpcykge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBheGlzID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIGF4aXMgPSBzLmlzSG9yaXpvbnRhbCgpID8gJ3gnIDogJ3knO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHMuZ2V0VHJhbnNsYXRlKHMud3JhcHBlclswXSwgYXhpcyk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBPYnNlcnZlclxuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMub2JzZXJ2ZXJzID0gW107XG4gICAgICAgIGZ1bmN0aW9uIGluaXRPYnNlcnZlcih0YXJnZXQsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgICAgICAgICAgLy8gY3JlYXRlIGFuIG9ic2VydmVyIGluc3RhbmNlXG4gICAgICAgICAgICB2YXIgT2JzZXJ2ZXJGdW5jID0gd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIgfHwgd2luZG93LldlYmtpdE11dGF0aW9uT2JzZXJ2ZXI7XG4gICAgICAgICAgICB2YXIgb2JzZXJ2ZXIgPSBuZXcgT2JzZXJ2ZXJGdW5jKGZ1bmN0aW9uIChtdXRhdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbiAobXV0YXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcy5vblJlc2l6ZSh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgcy5lbWl0KCdvbk9ic2VydmVyVXBkYXRlJywgcywgbXV0YXRpb24pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZSh0YXJnZXQsIHtcbiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzOiB0eXBlb2Ygb3B0aW9ucy5hdHRyaWJ1dGVzID09PSAndW5kZWZpbmVkJyA/IHRydWUgOiBvcHRpb25zLmF0dHJpYnV0ZXMsXG4gICAgICAgICAgICAgICAgY2hpbGRMaXN0OiB0eXBlb2Ygb3B0aW9ucy5jaGlsZExpc3QgPT09ICd1bmRlZmluZWQnID8gdHJ1ZSA6IG9wdGlvbnMuY2hpbGRMaXN0LFxuICAgICAgICAgICAgICAgIGNoYXJhY3RlckRhdGE6IHR5cGVvZiBvcHRpb25zLmNoYXJhY3RlckRhdGEgPT09ICd1bmRlZmluZWQnID8gdHJ1ZSA6IG9wdGlvbnMuY2hhcmFjdGVyRGF0YVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgcy5vYnNlcnZlcnMucHVzaChvYnNlcnZlcik7XG4gICAgICAgIH1cbiAgICAgICAgcy5pbml0T2JzZXJ2ZXJzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLm9ic2VydmVQYXJlbnRzKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lclBhcmVudHMgPSBzLmNvbnRhaW5lci5wYXJlbnRzKCk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb250YWluZXJQYXJlbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGluaXRPYnNlcnZlcihjb250YWluZXJQYXJlbnRzW2ldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gT2JzZXJ2ZSBjb250YWluZXJcbiAgICAgICAgICAgIGluaXRPYnNlcnZlcihzLmNvbnRhaW5lclswXSwge2NoaWxkTGlzdDogZmFsc2V9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBPYnNlcnZlIHdyYXBwZXJcbiAgICAgICAgICAgIGluaXRPYnNlcnZlcihzLndyYXBwZXJbMF0sIHthdHRyaWJ1dGVzOiBmYWxzZX0pO1xuICAgICAgICB9O1xuICAgICAgICBzLmRpc2Nvbm5lY3RPYnNlcnZlcnMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHMub2JzZXJ2ZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgcy5vYnNlcnZlcnNbaV0uZGlzY29ubmVjdCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcy5vYnNlcnZlcnMgPSBbXTtcbiAgICAgICAgfTtcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgTG9vcFxuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIC8vIENyZWF0ZSBsb29wZWQgc2xpZGVzXG4gICAgICAgIHMuY3JlYXRlTG9vcCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVkIHNsaWRlc1xuICAgICAgICAgICAgcy53cmFwcGVyLmNoaWxkcmVuKCcuJyArIHMucGFyYW1zLnNsaWRlQ2xhc3MgKyAnLicgKyBzLnBhcmFtcy5zbGlkZUR1cGxpY2F0ZUNsYXNzKS5yZW1vdmUoKTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgc2xpZGVzID0gcy53cmFwcGVyLmNoaWxkcmVuKCcuJyArIHMucGFyYW1zLnNsaWRlQ2xhc3MpO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmKHMucGFyYW1zLnNsaWRlc1BlclZpZXcgPT09ICdhdXRvJyAmJiAhcy5wYXJhbXMubG9vcGVkU2xpZGVzKSBzLnBhcmFtcy5sb29wZWRTbGlkZXMgPSBzbGlkZXMubGVuZ3RoO1xuICAgICAgICBcbiAgICAgICAgICAgIHMubG9vcGVkU2xpZGVzID0gcGFyc2VJbnQocy5wYXJhbXMubG9vcGVkU2xpZGVzIHx8IHMucGFyYW1zLnNsaWRlc1BlclZpZXcsIDEwKTtcbiAgICAgICAgICAgIHMubG9vcGVkU2xpZGVzID0gcy5sb29wZWRTbGlkZXMgKyBzLnBhcmFtcy5sb29wQWRkaXRpb25hbFNsaWRlcztcbiAgICAgICAgICAgIGlmIChzLmxvb3BlZFNsaWRlcyA+IHNsaWRlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBzLmxvb3BlZFNsaWRlcyA9IHNsaWRlcy5sZW5ndGg7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHByZXBlbmRTbGlkZXMgPSBbXSwgYXBwZW5kU2xpZGVzID0gW10sIGk7XG4gICAgICAgICAgICBzbGlkZXMuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGVsKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNsaWRlID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCBzLmxvb3BlZFNsaWRlcykgYXBwZW5kU2xpZGVzLnB1c2goZWwpO1xuICAgICAgICAgICAgICAgIGlmIChpbmRleCA8IHNsaWRlcy5sZW5ndGggJiYgaW5kZXggPj0gc2xpZGVzLmxlbmd0aCAtIHMubG9vcGVkU2xpZGVzKSBwcmVwZW5kU2xpZGVzLnB1c2goZWwpO1xuICAgICAgICAgICAgICAgIHNsaWRlLmF0dHIoJ2RhdGEtc3dpcGVyLXNsaWRlLWluZGV4JywgaW5kZXgpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYXBwZW5kU2xpZGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgcy53cmFwcGVyLmFwcGVuZCgkKGFwcGVuZFNsaWRlc1tpXS5jbG9uZU5vZGUodHJ1ZSkpLmFkZENsYXNzKHMucGFyYW1zLnNsaWRlRHVwbGljYXRlQ2xhc3MpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZvciAoaSA9IHByZXBlbmRTbGlkZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgICAgICBzLndyYXBwZXIucHJlcGVuZCgkKHByZXBlbmRTbGlkZXNbaV0uY2xvbmVOb2RlKHRydWUpKS5hZGRDbGFzcyhzLnBhcmFtcy5zbGlkZUR1cGxpY2F0ZUNsYXNzKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHMuZGVzdHJveUxvb3AgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBzLndyYXBwZXIuY2hpbGRyZW4oJy4nICsgcy5wYXJhbXMuc2xpZGVDbGFzcyArICcuJyArIHMucGFyYW1zLnNsaWRlRHVwbGljYXRlQ2xhc3MpLnJlbW92ZSgpO1xuICAgICAgICAgICAgcy5zbGlkZXMucmVtb3ZlQXR0cignZGF0YS1zd2lwZXItc2xpZGUtaW5kZXgnKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5yZUxvb3AgPSBmdW5jdGlvbiAodXBkYXRlUG9zaXRpb24pIHtcbiAgICAgICAgICAgIHZhciBvbGRJbmRleCA9IHMuYWN0aXZlSW5kZXggLSBzLmxvb3BlZFNsaWRlcztcbiAgICAgICAgICAgIHMuZGVzdHJveUxvb3AoKTtcbiAgICAgICAgICAgIHMuY3JlYXRlTG9vcCgpO1xuICAgICAgICAgICAgcy51cGRhdGVTbGlkZXNTaXplKCk7XG4gICAgICAgICAgICBpZiAodXBkYXRlUG9zaXRpb24pIHtcbiAgICAgICAgICAgICAgICBzLnNsaWRlVG8ob2xkSW5kZXggKyBzLmxvb3BlZFNsaWRlcywgMCwgZmFsc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgfTtcbiAgICAgICAgcy5maXhMb29wID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIG5ld0luZGV4O1xuICAgICAgICAgICAgLy9GaXggRm9yIE5lZ2F0aXZlIE92ZXJzbGlkaW5nXG4gICAgICAgICAgICBpZiAocy5hY3RpdmVJbmRleCA8IHMubG9vcGVkU2xpZGVzKSB7XG4gICAgICAgICAgICAgICAgbmV3SW5kZXggPSBzLnNsaWRlcy5sZW5ndGggLSBzLmxvb3BlZFNsaWRlcyAqIDMgKyBzLmFjdGl2ZUluZGV4O1xuICAgICAgICAgICAgICAgIG5ld0luZGV4ID0gbmV3SW5kZXggKyBzLmxvb3BlZFNsaWRlcztcbiAgICAgICAgICAgICAgICBzLnNsaWRlVG8obmV3SW5kZXgsIDAsIGZhbHNlLCB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vRml4IEZvciBQb3NpdGl2ZSBPdmVyc2xpZGluZ1xuICAgICAgICAgICAgZWxzZSBpZiAoKHMucGFyYW1zLnNsaWRlc1BlclZpZXcgPT09ICdhdXRvJyAmJiBzLmFjdGl2ZUluZGV4ID49IHMubG9vcGVkU2xpZGVzICogMikgfHwgKHMuYWN0aXZlSW5kZXggPiBzLnNsaWRlcy5sZW5ndGggLSBzLnBhcmFtcy5zbGlkZXNQZXJWaWV3ICogMikpIHtcbiAgICAgICAgICAgICAgICBuZXdJbmRleCA9IC1zLnNsaWRlcy5sZW5ndGggKyBzLmFjdGl2ZUluZGV4ICsgcy5sb29wZWRTbGlkZXM7XG4gICAgICAgICAgICAgICAgbmV3SW5kZXggPSBuZXdJbmRleCArIHMubG9vcGVkU2xpZGVzO1xuICAgICAgICAgICAgICAgIHMuc2xpZGVUbyhuZXdJbmRleCwgMCwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBBcHBlbmQvUHJlcGVuZC9SZW1vdmUgU2xpZGVzXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgcy5hcHBlbmRTbGlkZSA9IGZ1bmN0aW9uIChzbGlkZXMpIHtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5sb29wKSB7XG4gICAgICAgICAgICAgICAgcy5kZXN0cm95TG9vcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHR5cGVvZiBzbGlkZXMgPT09ICdvYmplY3QnICYmIHNsaWRlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNsaWRlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2xpZGVzW2ldKSBzLndyYXBwZXIuYXBwZW5kKHNsaWRlc1tpXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcy53cmFwcGVyLmFwcGVuZChzbGlkZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICBzLmNyZWF0ZUxvb3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghKHMucGFyYW1zLm9ic2VydmVyICYmIHMuc3VwcG9ydC5vYnNlcnZlcikpIHtcbiAgICAgICAgICAgICAgICBzLnVwZGF0ZSh0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgcy5wcmVwZW5kU2xpZGUgPSBmdW5jdGlvbiAoc2xpZGVzKSB7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMubG9vcCkge1xuICAgICAgICAgICAgICAgIHMuZGVzdHJveUxvb3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBuZXdBY3RpdmVJbmRleCA9IHMuYWN0aXZlSW5kZXggKyAxO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBzbGlkZXMgPT09ICdvYmplY3QnICYmIHNsaWRlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNsaWRlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2xpZGVzW2ldKSBzLndyYXBwZXIucHJlcGVuZChzbGlkZXNbaV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBuZXdBY3RpdmVJbmRleCA9IHMuYWN0aXZlSW5kZXggKyBzbGlkZXMubGVuZ3RoO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcy53cmFwcGVyLnByZXBlbmQoc2xpZGVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5sb29wKSB7XG4gICAgICAgICAgICAgICAgcy5jcmVhdGVMb29wKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIShzLnBhcmFtcy5vYnNlcnZlciAmJiBzLnN1cHBvcnQub2JzZXJ2ZXIpKSB7XG4gICAgICAgICAgICAgICAgcy51cGRhdGUodHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzLnNsaWRlVG8obmV3QWN0aXZlSW5kZXgsIDAsIGZhbHNlKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5yZW1vdmVTbGlkZSA9IGZ1bmN0aW9uIChzbGlkZXNJbmRleGVzKSB7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMubG9vcCkge1xuICAgICAgICAgICAgICAgIHMuZGVzdHJveUxvb3AoKTtcbiAgICAgICAgICAgICAgICBzLnNsaWRlcyA9IHMud3JhcHBlci5jaGlsZHJlbignLicgKyBzLnBhcmFtcy5zbGlkZUNsYXNzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBuZXdBY3RpdmVJbmRleCA9IHMuYWN0aXZlSW5kZXgsXG4gICAgICAgICAgICAgICAgaW5kZXhUb1JlbW92ZTtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc2xpZGVzSW5kZXhlcyA9PT0gJ29iamVjdCcgJiYgc2xpZGVzSW5kZXhlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNsaWRlc0luZGV4ZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaW5kZXhUb1JlbW92ZSA9IHNsaWRlc0luZGV4ZXNbaV07XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnNsaWRlc1tpbmRleFRvUmVtb3ZlXSkgcy5zbGlkZXMuZXEoaW5kZXhUb1JlbW92ZSkucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmRleFRvUmVtb3ZlIDwgbmV3QWN0aXZlSW5kZXgpIG5ld0FjdGl2ZUluZGV4LS07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG5ld0FjdGl2ZUluZGV4ID0gTWF0aC5tYXgobmV3QWN0aXZlSW5kZXgsIDApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaW5kZXhUb1JlbW92ZSA9IHNsaWRlc0luZGV4ZXM7XG4gICAgICAgICAgICAgICAgaWYgKHMuc2xpZGVzW2luZGV4VG9SZW1vdmVdKSBzLnNsaWRlcy5lcShpbmRleFRvUmVtb3ZlKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXhUb1JlbW92ZSA8IG5ld0FjdGl2ZUluZGV4KSBuZXdBY3RpdmVJbmRleC0tO1xuICAgICAgICAgICAgICAgIG5ld0FjdGl2ZUluZGV4ID0gTWF0aC5tYXgobmV3QWN0aXZlSW5kZXgsIDApO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5sb29wKSB7XG4gICAgICAgICAgICAgICAgcy5jcmVhdGVMb29wKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKCEocy5wYXJhbXMub2JzZXJ2ZXIgJiYgcy5zdXBwb3J0Lm9ic2VydmVyKSkge1xuICAgICAgICAgICAgICAgIHMudXBkYXRlKHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICBzLnNsaWRlVG8obmV3QWN0aXZlSW5kZXggKyBzLmxvb3BlZFNsaWRlcywgMCwgZmFsc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcy5zbGlkZVRvKG5ld0FjdGl2ZUluZGV4LCAwLCBmYWxzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB9O1xuICAgICAgICBzLnJlbW92ZUFsbFNsaWRlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBzbGlkZXNJbmRleGVzID0gW107XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHMuc2xpZGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgc2xpZGVzSW5kZXhlcy5wdXNoKGkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcy5yZW1vdmVTbGlkZShzbGlkZXNJbmRleGVzKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIEVmZmVjdHNcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLmVmZmVjdHMgPSB7XG4gICAgICAgICAgICBmYWRlOiB7XG4gICAgICAgICAgICAgICAgc2V0VHJhbnNsYXRlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcy5zbGlkZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGlkZSA9IHMuc2xpZGVzLmVxKGkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9mZnNldCA9IHNsaWRlWzBdLnN3aXBlclNsaWRlT2Zmc2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHR4ID0gLW9mZnNldDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcy5wYXJhbXMudmlydHVhbFRyYW5zbGF0ZSkgdHggPSB0eCAtIHMudHJhbnNsYXRlO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHR5ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcy5pc0hvcml6b250YWwoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5ID0gdHg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHggPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRlT3BhY2l0eSA9IHMucGFyYW1zLmZhZGUuY3Jvc3NGYWRlID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTWF0aC5tYXgoMSAtIE1hdGguYWJzKHNsaWRlWzBdLnByb2dyZXNzKSwgMCkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxICsgTWF0aC5taW4oTWF0aC5tYXgoc2xpZGVbMF0ucHJvZ3Jlc3MsIC0xKSwgMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzbGlkZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiBzbGlkZU9wYWNpdHlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyB0eCArICdweCwgJyArIHR5ICsgJ3B4LCAwcHgpJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc2V0VHJhbnNpdGlvbjogZnVuY3Rpb24gKGR1cmF0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuc2xpZGVzLnRyYW5zaXRpb24oZHVyYXRpb24pO1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMudmlydHVhbFRyYW5zbGF0ZSAmJiBkdXJhdGlvbiAhPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGV2ZW50VHJpZ2dlcmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnNsaWRlcy50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnRUcmlnZ2VyZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXMpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudFRyaWdnZXJlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5hbmltYXRpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHJpZ2dlckV2ZW50cyA9IFsnd2Via2l0VHJhbnNpdGlvbkVuZCcsICd0cmFuc2l0aW9uZW5kJywgJ29UcmFuc2l0aW9uRW5kJywgJ01TVHJhbnNpdGlvbkVuZCcsICdtc1RyYW5zaXRpb25FbmQnXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRyaWdnZXJFdmVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcy53cmFwcGVyLnRyaWdnZXIodHJpZ2dlckV2ZW50c1tpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZmxpcDoge1xuICAgICAgICAgICAgICAgIHNldFRyYW5zbGF0ZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHMuc2xpZGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGUgPSBzLnNsaWRlcy5lcShpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcm9ncmVzcyA9IHNsaWRlWzBdLnByb2dyZXNzO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmZsaXAubGltaXRSb3RhdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzID0gTWF0aC5tYXgoTWF0aC5taW4oc2xpZGVbMF0ucHJvZ3Jlc3MsIDEpLCAtMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2Zmc2V0ID0gc2xpZGVbMF0uc3dpcGVyU2xpZGVPZmZzZXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm90YXRlID0gLTE4MCAqIHByb2dyZXNzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0ZVkgPSByb3RhdGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRlWCA9IDAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHggPSAtb2Zmc2V0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcy5pc0hvcml6b250YWwoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5ID0gdHg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHggPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0ZVggPSAtcm90YXRlWTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3RhdGVZID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHMucnRsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRlWSA9IC1yb3RhdGVZO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlWzBdLnN0eWxlLnpJbmRleCA9IC1NYXRoLmFicyhNYXRoLnJvdW5kKHByb2dyZXNzKSkgKyBzLnNsaWRlcy5sZW5ndGg7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmZsaXAuc2xpZGVTaGFkb3dzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9TZXQgc2hhZG93c1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzaGFkb3dCZWZvcmUgPSBzLmlzSG9yaXpvbnRhbCgpID8gc2xpZGUuZmluZCgnLnN3aXBlci1zbGlkZS1zaGFkb3ctbGVmdCcpIDogc2xpZGUuZmluZCgnLnN3aXBlci1zbGlkZS1zaGFkb3ctdG9wJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNoYWRvd0FmdGVyID0gcy5pc0hvcml6b250YWwoKSA/IHNsaWRlLmZpbmQoJy5zd2lwZXItc2xpZGUtc2hhZG93LXJpZ2h0JykgOiBzbGlkZS5maW5kKCcuc3dpcGVyLXNsaWRlLXNoYWRvdy1ib3R0b20nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hhZG93QmVmb3JlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFkb3dCZWZvcmUgPSAkKCc8ZGl2IGNsYXNzPVwic3dpcGVyLXNsaWRlLXNoYWRvdy0nICsgKHMuaXNIb3Jpem9udGFsKCkgPyAnbGVmdCcgOiAndG9wJykgKyAnXCI+PC9kaXY+Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlLmFwcGVuZChzaGFkb3dCZWZvcmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hhZG93QWZ0ZXIubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRvd0FmdGVyID0gJCgnPGRpdiBjbGFzcz1cInN3aXBlci1zbGlkZS1zaGFkb3ctJyArIChzLmlzSG9yaXpvbnRhbCgpID8gJ3JpZ2h0JyA6ICdib3R0b20nKSArICdcIj48L2Rpdj4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGUuYXBwZW5kKHNoYWRvd0FmdGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNoYWRvd0JlZm9yZS5sZW5ndGgpIHNoYWRvd0JlZm9yZVswXS5zdHlsZS5vcGFjaXR5ID0gTWF0aC5tYXgoLXByb2dyZXNzLCAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hhZG93QWZ0ZXIubGVuZ3RoKSBzaGFkb3dBZnRlclswXS5zdHlsZS5vcGFjaXR5ID0gTWF0aC5tYXgocHJvZ3Jlc3MsIDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHR4ICsgJ3B4LCAnICsgdHkgKyAncHgsIDBweCkgcm90YXRlWCgnICsgcm90YXRlWCArICdkZWcpIHJvdGF0ZVkoJyArIHJvdGF0ZVkgKyAnZGVnKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzZXRUcmFuc2l0aW9uOiBmdW5jdGlvbiAoZHVyYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcy5zbGlkZXMudHJhbnNpdGlvbihkdXJhdGlvbikuZmluZCgnLnN3aXBlci1zbGlkZS1zaGFkb3ctdG9wLCAuc3dpcGVyLXNsaWRlLXNoYWRvdy1yaWdodCwgLnN3aXBlci1zbGlkZS1zaGFkb3ctYm90dG9tLCAuc3dpcGVyLXNsaWRlLXNoYWRvdy1sZWZ0JykudHJhbnNpdGlvbihkdXJhdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy52aXJ0dWFsVHJhbnNsYXRlICYmIGR1cmF0aW9uICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUcmlnZ2VyZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuc2xpZGVzLmVxKHMuYWN0aXZlSW5kZXgpLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudFRyaWdnZXJlZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcykgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghJCh0aGlzKS5oYXNDbGFzcyhzLnBhcmFtcy5zbGlkZUFjdGl2ZUNsYXNzKSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50VHJpZ2dlcmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLmFuaW1hdGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmlnZ2VyRXZlbnRzID0gWyd3ZWJraXRUcmFuc2l0aW9uRW5kJywgJ3RyYW5zaXRpb25lbmQnLCAnb1RyYW5zaXRpb25FbmQnLCAnTVNUcmFuc2l0aW9uRW5kJywgJ21zVHJhbnNpdGlvbkVuZCddO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHJpZ2dlckV2ZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLndyYXBwZXIudHJpZ2dlcih0cmlnZ2VyRXZlbnRzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjdWJlOiB7XG4gICAgICAgICAgICAgICAgc2V0VHJhbnNsYXRlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB3cmFwcGVyUm90YXRlID0gMCwgY3ViZVNoYWRvdztcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmN1YmUuc2hhZG93KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5pc0hvcml6b250YWwoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1YmVTaGFkb3cgPSBzLndyYXBwZXIuZmluZCgnLnN3aXBlci1jdWJlLXNoYWRvdycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdWJlU2hhZG93Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdWJlU2hhZG93ID0gJCgnPGRpdiBjbGFzcz1cInN3aXBlci1jdWJlLXNoYWRvd1wiPjwvZGl2PicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLndyYXBwZXIuYXBwZW5kKGN1YmVTaGFkb3cpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdWJlU2hhZG93LmNzcyh7aGVpZ2h0OiBzLndpZHRoICsgJ3B4J30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3ViZVNoYWRvdyA9IHMuY29udGFpbmVyLmZpbmQoJy5zd2lwZXItY3ViZS1zaGFkb3cnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3ViZVNoYWRvdy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3ViZVNoYWRvdyA9ICQoJzxkaXYgY2xhc3M9XCJzd2lwZXItY3ViZS1zaGFkb3dcIj48L2Rpdj4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5jb250YWluZXIuYXBwZW5kKGN1YmVTaGFkb3cpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHMuc2xpZGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGUgPSBzLnNsaWRlcy5lcShpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGlkZUFuZ2xlID0gaSAqIDkwO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvdW5kID0gTWF0aC5mbG9vcihzbGlkZUFuZ2xlIC8gMzYwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLnJ0bCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlQW5nbGUgPSAtc2xpZGVBbmdsZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3VuZCA9IE1hdGguZmxvb3IoLXNsaWRlQW5nbGUgLyAzNjApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb2dyZXNzID0gTWF0aC5tYXgoTWF0aC5taW4oc2xpZGVbMF0ucHJvZ3Jlc3MsIDEpLCAtMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHggPSAwLCB0eSA9IDAsIHR6ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpICUgNCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4ID0gLSByb3VuZCAqIDQgKiBzLnNpemU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHogPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoKGkgLSAxKSAlIDQgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eCA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHogPSAtIHJvdW5kICogNCAqIHMuc2l6ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKChpIC0gMikgJSA0ID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHggPSBzLnNpemUgKyByb3VuZCAqIDQgKiBzLnNpemU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHogPSBzLnNpemU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICgoaSAtIDMpICUgNCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4ID0gLSBzLnNpemU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHogPSAzICogcy5zaXplICsgcy5zaXplICogNCAqIHJvdW5kO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMucnRsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHggPSAtdHg7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzLmlzSG9yaXpvbnRhbCgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHkgPSB0eDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eCA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRyYW5zZm9ybSA9ICdyb3RhdGVYKCcgKyAocy5pc0hvcml6b250YWwoKSA/IDAgOiAtc2xpZGVBbmdsZSkgKyAnZGVnKSByb3RhdGVZKCcgKyAocy5pc0hvcml6b250YWwoKSA/IHNsaWRlQW5nbGUgOiAwKSArICdkZWcpIHRyYW5zbGF0ZTNkKCcgKyB0eCArICdweCwgJyArIHR5ICsgJ3B4LCAnICsgdHogKyAncHgpJztcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcm9ncmVzcyA8PSAxICYmIHByb2dyZXNzID4gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3cmFwcGVyUm90YXRlID0gaSAqIDkwICsgcHJvZ3Jlc3MgKiA5MDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5ydGwpIHdyYXBwZXJSb3RhdGUgPSAtaSAqIDkwIC0gcHJvZ3Jlc3MgKiA5MDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlLnRyYW5zZm9ybSh0cmFuc2Zvcm0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmN1YmUuc2xpZGVTaGFkb3dzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9TZXQgc2hhZG93c1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzaGFkb3dCZWZvcmUgPSBzLmlzSG9yaXpvbnRhbCgpID8gc2xpZGUuZmluZCgnLnN3aXBlci1zbGlkZS1zaGFkb3ctbGVmdCcpIDogc2xpZGUuZmluZCgnLnN3aXBlci1zbGlkZS1zaGFkb3ctdG9wJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNoYWRvd0FmdGVyID0gcy5pc0hvcml6b250YWwoKSA/IHNsaWRlLmZpbmQoJy5zd2lwZXItc2xpZGUtc2hhZG93LXJpZ2h0JykgOiBzbGlkZS5maW5kKCcuc3dpcGVyLXNsaWRlLXNoYWRvdy1ib3R0b20nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hhZG93QmVmb3JlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFkb3dCZWZvcmUgPSAkKCc8ZGl2IGNsYXNzPVwic3dpcGVyLXNsaWRlLXNoYWRvdy0nICsgKHMuaXNIb3Jpem9udGFsKCkgPyAnbGVmdCcgOiAndG9wJykgKyAnXCI+PC9kaXY+Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlLmFwcGVuZChzaGFkb3dCZWZvcmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hhZG93QWZ0ZXIubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRvd0FmdGVyID0gJCgnPGRpdiBjbGFzcz1cInN3aXBlci1zbGlkZS1zaGFkb3ctJyArIChzLmlzSG9yaXpvbnRhbCgpID8gJ3JpZ2h0JyA6ICdib3R0b20nKSArICdcIj48L2Rpdj4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGUuYXBwZW5kKHNoYWRvd0FmdGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNoYWRvd0JlZm9yZS5sZW5ndGgpIHNoYWRvd0JlZm9yZVswXS5zdHlsZS5vcGFjaXR5ID0gTWF0aC5tYXgoLXByb2dyZXNzLCAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hhZG93QWZ0ZXIubGVuZ3RoKSBzaGFkb3dBZnRlclswXS5zdHlsZS5vcGFjaXR5ID0gTWF0aC5tYXgocHJvZ3Jlc3MsIDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHMud3JhcHBlci5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgJy13ZWJraXQtdHJhbnNmb3JtLW9yaWdpbic6ICc1MCUgNTAlIC0nICsgKHMuc2l6ZSAvIDIpICsgJ3B4JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICctbW96LXRyYW5zZm9ybS1vcmlnaW4nOiAnNTAlIDUwJSAtJyArIChzLnNpemUgLyAyKSArICdweCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAnLW1zLXRyYW5zZm9ybS1vcmlnaW4nOiAnNTAlIDUwJSAtJyArIChzLnNpemUgLyAyKSArICdweCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAndHJhbnNmb3JtLW9yaWdpbic6ICc1MCUgNTAlIC0nICsgKHMuc2l6ZSAvIDIpICsgJ3B4J1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5jdWJlLnNoYWRvdykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMuaXNIb3Jpem9udGFsKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdWJlU2hhZG93LnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMHB4LCAnICsgKHMud2lkdGggLyAyICsgcy5wYXJhbXMuY3ViZS5zaGFkb3dPZmZzZXQpICsgJ3B4LCAnICsgKC1zLndpZHRoIC8gMikgKyAncHgpIHJvdGF0ZVgoOTBkZWcpIHJvdGF0ZVooMGRlZykgc2NhbGUoJyArIChzLnBhcmFtcy5jdWJlLnNoYWRvd1NjYWxlKSArICcpJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2hhZG93QW5nbGUgPSBNYXRoLmFicyh3cmFwcGVyUm90YXRlKSAtIE1hdGguZmxvb3IoTWF0aC5hYnMod3JhcHBlclJvdGF0ZSkgLyA5MCkgKiA5MDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbXVsdGlwbGllciA9IDEuNSAtIChNYXRoLnNpbihzaGFkb3dBbmdsZSAqIDIgKiBNYXRoLlBJIC8gMzYwKSAvIDIgKyBNYXRoLmNvcyhzaGFkb3dBbmdsZSAqIDIgKiBNYXRoLlBJIC8gMzYwKSAvIDIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzY2FsZTEgPSBzLnBhcmFtcy5jdWJlLnNoYWRvd1NjYWxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2FsZTIgPSBzLnBhcmFtcy5jdWJlLnNoYWRvd1NjYWxlIC8gbXVsdGlwbGllcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb2Zmc2V0ID0gcy5wYXJhbXMuY3ViZS5zaGFkb3dPZmZzZXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3ViZVNoYWRvdy50cmFuc2Zvcm0oJ3NjYWxlM2QoJyArIHNjYWxlMSArICcsIDEsICcgKyBzY2FsZTIgKyAnKSB0cmFuc2xhdGUzZCgwcHgsICcgKyAocy5oZWlnaHQgLyAyICsgb2Zmc2V0KSArICdweCwgJyArICgtcy5oZWlnaHQgLyAyIC8gc2NhbGUyKSArICdweCkgcm90YXRlWCgtOTBkZWcpJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIHpGYWN0b3IgPSAocy5pc1NhZmFyaSB8fCBzLmlzVWlXZWJWaWV3KSA/ICgtcy5zaXplIC8gMikgOiAwO1xuICAgICAgICAgICAgICAgICAgICBzLndyYXBwZXIudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwcHgsMCwnICsgekZhY3RvciArICdweCkgcm90YXRlWCgnICsgKHMuaXNIb3Jpem9udGFsKCkgPyAwIDogd3JhcHBlclJvdGF0ZSkgKyAnZGVnKSByb3RhdGVZKCcgKyAocy5pc0hvcml6b250YWwoKSA/IC13cmFwcGVyUm90YXRlIDogMCkgKyAnZGVnKScpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc2V0VHJhbnNpdGlvbjogZnVuY3Rpb24gKGR1cmF0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuc2xpZGVzLnRyYW5zaXRpb24oZHVyYXRpb24pLmZpbmQoJy5zd2lwZXItc2xpZGUtc2hhZG93LXRvcCwgLnN3aXBlci1zbGlkZS1zaGFkb3ctcmlnaHQsIC5zd2lwZXItc2xpZGUtc2hhZG93LWJvdHRvbSwgLnN3aXBlci1zbGlkZS1zaGFkb3ctbGVmdCcpLnRyYW5zaXRpb24oZHVyYXRpb24pO1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuY3ViZS5zaGFkb3cgJiYgIXMuaXNIb3Jpem9udGFsKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuY29udGFpbmVyLmZpbmQoJy5zd2lwZXItY3ViZS1zaGFkb3cnKS50cmFuc2l0aW9uKGR1cmF0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjb3ZlcmZsb3c6IHtcbiAgICAgICAgICAgICAgICBzZXRUcmFuc2xhdGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRyYW5zZm9ybSA9IHMudHJhbnNsYXRlO1xuICAgICAgICAgICAgICAgICAgICB2YXIgY2VudGVyID0gcy5pc0hvcml6b250YWwoKSA/IC10cmFuc2Zvcm0gKyBzLndpZHRoIC8gMiA6IC10cmFuc2Zvcm0gKyBzLmhlaWdodCAvIDI7XG4gICAgICAgICAgICAgICAgICAgIHZhciByb3RhdGUgPSBzLmlzSG9yaXpvbnRhbCgpID8gcy5wYXJhbXMuY292ZXJmbG93LnJvdGF0ZTogLXMucGFyYW1zLmNvdmVyZmxvdy5yb3RhdGU7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2xhdGUgPSBzLnBhcmFtcy5jb3ZlcmZsb3cuZGVwdGg7XG4gICAgICAgICAgICAgICAgICAgIC8vRWFjaCBzbGlkZSBvZmZzZXQgZnJvbSBjZW50ZXJcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbmd0aCA9IHMuc2xpZGVzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGUgPSBzLnNsaWRlcy5lcShpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGlkZVNpemUgPSBzLnNsaWRlc1NpemVzR3JpZFtpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGlkZU9mZnNldCA9IHNsaWRlWzBdLnN3aXBlclNsaWRlT2Zmc2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9mZnNldE11bHRpcGxpZXIgPSAoY2VudGVyIC0gc2xpZGVPZmZzZXQgLSBzbGlkZVNpemUgLyAyKSAvIHNsaWRlU2l6ZSAqIHMucGFyYW1zLmNvdmVyZmxvdy5tb2RpZmllcjtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm90YXRlWSA9IHMuaXNIb3Jpem9udGFsKCkgPyByb3RhdGUgKiBvZmZzZXRNdWx0aXBsaWVyIDogMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByb3RhdGVYID0gcy5pc0hvcml6b250YWwoKSA/IDAgOiByb3RhdGUgKiBvZmZzZXRNdWx0aXBsaWVyO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdmFyIHJvdGF0ZVogPSAwXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHJhbnNsYXRlWiA9IC10cmFuc2xhdGUgKiBNYXRoLmFicyhvZmZzZXRNdWx0aXBsaWVyKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHJhbnNsYXRlWSA9IHMuaXNIb3Jpem9udGFsKCkgPyAwIDogcy5wYXJhbXMuY292ZXJmbG93LnN0cmV0Y2ggKiAob2Zmc2V0TXVsdGlwbGllcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHJhbnNsYXRlWCA9IHMuaXNIb3Jpem9udGFsKCkgPyBzLnBhcmFtcy5jb3ZlcmZsb3cuc3RyZXRjaCAqIChvZmZzZXRNdWx0aXBsaWVyKSA6IDA7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgLy9GaXggZm9yIHVsdHJhIHNtYWxsIHZhbHVlc1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRyYW5zbGF0ZVgpIDwgMC4wMDEpIHRyYW5zbGF0ZVggPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRyYW5zbGF0ZVkpIDwgMC4wMDEpIHRyYW5zbGF0ZVkgPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRyYW5zbGF0ZVopIDwgMC4wMDEpIHRyYW5zbGF0ZVogPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHJvdGF0ZVkpIDwgMC4wMDEpIHJvdGF0ZVkgPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHJvdGF0ZVgpIDwgMC4wMDEpIHJvdGF0ZVggPSAwO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGlkZVRyYW5zZm9ybSA9ICd0cmFuc2xhdGUzZCgnICsgdHJhbnNsYXRlWCArICdweCwnICsgdHJhbnNsYXRlWSArICdweCwnICsgdHJhbnNsYXRlWiArICdweCkgIHJvdGF0ZVgoJyArIHJvdGF0ZVggKyAnZGVnKSByb3RhdGVZKCcgKyByb3RhdGVZICsgJ2RlZyknO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlLnRyYW5zZm9ybShzbGlkZVRyYW5zZm9ybSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzbGlkZVswXS5zdHlsZS56SW5kZXggPSAtTWF0aC5hYnMoTWF0aC5yb3VuZChvZmZzZXRNdWx0aXBsaWVyKSkgKyAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmNvdmVyZmxvdy5zbGlkZVNoYWRvd3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL1NldCBzaGFkb3dzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNoYWRvd0JlZm9yZSA9IHMuaXNIb3Jpem9udGFsKCkgPyBzbGlkZS5maW5kKCcuc3dpcGVyLXNsaWRlLXNoYWRvdy1sZWZ0JykgOiBzbGlkZS5maW5kKCcuc3dpcGVyLXNsaWRlLXNoYWRvdy10b3AnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2hhZG93QWZ0ZXIgPSBzLmlzSG9yaXpvbnRhbCgpID8gc2xpZGUuZmluZCgnLnN3aXBlci1zbGlkZS1zaGFkb3ctcmlnaHQnKSA6IHNsaWRlLmZpbmQoJy5zd2lwZXItc2xpZGUtc2hhZG93LWJvdHRvbScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGFkb3dCZWZvcmUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRvd0JlZm9yZSA9ICQoJzxkaXYgY2xhc3M9XCJzd2lwZXItc2xpZGUtc2hhZG93LScgKyAocy5pc0hvcml6b250YWwoKSA/ICdsZWZ0JyA6ICd0b3AnKSArICdcIj48L2Rpdj4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGUuYXBwZW5kKHNoYWRvd0JlZm9yZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGFkb3dBZnRlci5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhZG93QWZ0ZXIgPSAkKCc8ZGl2IGNsYXNzPVwic3dpcGVyLXNsaWRlLXNoYWRvdy0nICsgKHMuaXNIb3Jpem9udGFsKCkgPyAncmlnaHQnIDogJ2JvdHRvbScpICsgJ1wiPjwvZGl2PicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGlkZS5hcHBlbmQoc2hhZG93QWZ0ZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hhZG93QmVmb3JlLmxlbmd0aCkgc2hhZG93QmVmb3JlWzBdLnN0eWxlLm9wYWNpdHkgPSBvZmZzZXRNdWx0aXBsaWVyID4gMCA/IG9mZnNldE11bHRpcGxpZXIgOiAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGFkb3dBZnRlci5sZW5ndGgpIHNoYWRvd0FmdGVyWzBdLnN0eWxlLm9wYWNpdHkgPSAoLW9mZnNldE11bHRpcGxpZXIpID4gMCA/IC1vZmZzZXRNdWx0aXBsaWVyIDogMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy9TZXQgY29ycmVjdCBwZXJzcGVjdGl2ZSBmb3IgSUUxMFxuICAgICAgICAgICAgICAgICAgICBpZiAocy5icm93c2VyLmllKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgd3MgPSBzLndyYXBwZXJbMF0uc3R5bGU7XG4gICAgICAgICAgICAgICAgICAgICAgICB3cy5wZXJzcGVjdGl2ZU9yaWdpbiA9IGNlbnRlciArICdweCA1MCUnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzZXRUcmFuc2l0aW9uOiBmdW5jdGlvbiAoZHVyYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcy5zbGlkZXMudHJhbnNpdGlvbihkdXJhdGlvbikuZmluZCgnLnN3aXBlci1zbGlkZS1zaGFkb3ctdG9wLCAuc3dpcGVyLXNsaWRlLXNoYWRvdy1yaWdodCwgLnN3aXBlci1zbGlkZS1zaGFkb3ctYm90dG9tLCAuc3dpcGVyLXNsaWRlLXNoYWRvdy1sZWZ0JykudHJhbnNpdGlvbihkdXJhdGlvbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBJbWFnZXMgTGF6eSBMb2FkaW5nXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgcy5sYXp5ID0ge1xuICAgICAgICAgICAgaW5pdGlhbEltYWdlTG9hZGVkOiBmYWxzZSxcbiAgICAgICAgICAgIGxvYWRJbWFnZUluU2xpZGU6IGZ1bmN0aW9uIChpbmRleCwgbG9hZEluRHVwbGljYXRlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGxvYWRJbkR1cGxpY2F0ZSA9PT0gJ3VuZGVmaW5lZCcpIGxvYWRJbkR1cGxpY2F0ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgaWYgKHMuc2xpZGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgc2xpZGUgPSBzLnNsaWRlcy5lcShpbmRleCk7XG4gICAgICAgICAgICAgICAgdmFyIGltZyA9IHNsaWRlLmZpbmQoJy5zd2lwZXItbGF6eTpub3QoLnN3aXBlci1sYXp5LWxvYWRlZCk6bm90KC5zd2lwZXItbGF6eS1sb2FkaW5nKScpO1xuICAgICAgICAgICAgICAgIGlmIChzbGlkZS5oYXNDbGFzcygnc3dpcGVyLWxhenknKSAmJiAhc2xpZGUuaGFzQ2xhc3MoJ3N3aXBlci1sYXp5LWxvYWRlZCcpICYmICFzbGlkZS5oYXNDbGFzcygnc3dpcGVyLWxhenktbG9hZGluZycpKSB7XG4gICAgICAgICAgICAgICAgICAgIGltZyA9IGltZy5hZGQoc2xpZGVbMF0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaW1nLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpbWcuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBfaW1nID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgX2ltZy5hZGRDbGFzcygnc3dpcGVyLWxhenktbG9hZGluZycpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgYmFja2dyb3VuZCA9IF9pbWcuYXR0cignZGF0YS1iYWNrZ3JvdW5kJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzcmMgPSBfaW1nLmF0dHIoJ2RhdGEtc3JjJyksXG4gICAgICAgICAgICAgICAgICAgICAgICBzcmNzZXQgPSBfaW1nLmF0dHIoJ2RhdGEtc3Jjc2V0Jyk7XG4gICAgICAgICAgICAgICAgICAgIHMubG9hZEltYWdlKF9pbWdbMF0sIChzcmMgfHwgYmFja2dyb3VuZCksIHNyY3NldCwgZmFsc2UsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChiYWNrZ3JvdW5kKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX2ltZy5jc3MoJ2JhY2tncm91bmQtaW1hZ2UnLCAndXJsKFwiJyArIGJhY2tncm91bmQgKyAnXCIpJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgX2ltZy5yZW1vdmVBdHRyKCdkYXRhLWJhY2tncm91bmQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcmNzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2ltZy5hdHRyKCdzcmNzZXQnLCBzcmNzZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfaW1nLnJlbW92ZUF0dHIoJ2RhdGEtc3Jjc2V0Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcmMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX2ltZy5hdHRyKCdzcmMnLCBzcmMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfaW1nLnJlbW92ZUF0dHIoJ2RhdGEtc3JjJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBfaW1nLmFkZENsYXNzKCdzd2lwZXItbGF6eS1sb2FkZWQnKS5yZW1vdmVDbGFzcygnc3dpcGVyLWxhenktbG9hZGluZycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGUuZmluZCgnLnN3aXBlci1sYXp5LXByZWxvYWRlciwgLnByZWxvYWRlcicpLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3AgJiYgbG9hZEluRHVwbGljYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRlT3JpZ2luYWxJbmRleCA9IHNsaWRlLmF0dHIoJ2RhdGEtc3dpcGVyLXNsaWRlLWluZGV4Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNsaWRlLmhhc0NsYXNzKHMucGFyYW1zLnNsaWRlRHVwbGljYXRlQ2xhc3MpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbFNsaWRlID0gcy53cmFwcGVyLmNoaWxkcmVuKCdbZGF0YS1zd2lwZXItc2xpZGUtaW5kZXg9XCInICsgc2xpZGVPcmlnaW5hbEluZGV4ICsgJ1wiXTpub3QoLicgKyBzLnBhcmFtcy5zbGlkZUR1cGxpY2F0ZUNsYXNzICsgJyknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5sYXp5LmxvYWRJbWFnZUluU2xpZGUob3JpZ2luYWxTbGlkZS5pbmRleCgpLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgZHVwbGljYXRlZFNsaWRlID0gcy53cmFwcGVyLmNoaWxkcmVuKCcuJyArIHMucGFyYW1zLnNsaWRlRHVwbGljYXRlQ2xhc3MgKyAnW2RhdGEtc3dpcGVyLXNsaWRlLWluZGV4PVwiJyArIHNsaWRlT3JpZ2luYWxJbmRleCArICdcIl0nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5sYXp5LmxvYWRJbWFnZUluU2xpZGUoZHVwbGljYXRlZFNsaWRlLmluZGV4KCksIGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uTGF6eUltYWdlUmVhZHknLCBzLCBzbGlkZVswXSwgX2ltZ1swXSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgcy5lbWl0KCdvbkxhenlJbWFnZUxvYWQnLCBzLCBzbGlkZVswXSwgX2ltZ1swXSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGxvYWQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgaTtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMud2F0Y2hTbGlkZXNWaXNpYmlsaXR5KSB7XG4gICAgICAgICAgICAgICAgICAgIHMud3JhcHBlci5jaGlsZHJlbignLicgKyBzLnBhcmFtcy5zbGlkZVZpc2libGVDbGFzcykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmxhenkubG9hZEltYWdlSW5TbGlkZSgkKHRoaXMpLmluZGV4KCkpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zbGlkZXNQZXJWaWV3ID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gcy5hY3RpdmVJbmRleDsgaSA8IHMuYWN0aXZlSW5kZXggKyBzLnBhcmFtcy5zbGlkZXNQZXJWaWV3IDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMuc2xpZGVzW2ldKSBzLmxhenkubG9hZEltYWdlSW5TbGlkZShpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMubGF6eS5sb2FkSW1hZ2VJblNsaWRlKHMuYWN0aXZlSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5sYXp5TG9hZGluZ0luUHJldk5leHQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNsaWRlc1BlclZpZXcgPiAxIHx8IChzLnBhcmFtcy5sYXp5TG9hZGluZ0luUHJldk5leHRBbW91bnQgJiYgcy5wYXJhbXMubGF6eUxvYWRpbmdJblByZXZOZXh0QW1vdW50ID4gMSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhbW91bnQgPSBzLnBhcmFtcy5sYXp5TG9hZGluZ0luUHJldk5leHRBbW91bnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3B2ID0gcy5wYXJhbXMuc2xpZGVzUGVyVmlldztcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYXhJbmRleCA9IE1hdGgubWluKHMuYWN0aXZlSW5kZXggKyBzcHYgKyBNYXRoLm1heChhbW91bnQsIHNwdiksIHMuc2xpZGVzLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWluSW5kZXggPSBNYXRoLm1heChzLmFjdGl2ZUluZGV4IC0gTWF0aC5tYXgoc3B2LCBhbW91bnQpLCAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5leHQgU2xpZGVzXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSBzLmFjdGl2ZUluZGV4ICsgcy5wYXJhbXMuc2xpZGVzUGVyVmlldzsgaSA8IG1heEluZGV4OyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5zbGlkZXNbaV0pIHMubGF6eS5sb2FkSW1hZ2VJblNsaWRlKGkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUHJldiBTbGlkZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IG1pbkluZGV4OyBpIDwgcy5hY3RpdmVJbmRleCA7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLnNsaWRlc1tpXSkgcy5sYXp5LmxvYWRJbWFnZUluU2xpZGUoaSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dFNsaWRlID0gcy53cmFwcGVyLmNoaWxkcmVuKCcuJyArIHMucGFyYW1zLnNsaWRlTmV4dENsYXNzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXh0U2xpZGUubGVuZ3RoID4gMCkgcy5sYXp5LmxvYWRJbWFnZUluU2xpZGUobmV4dFNsaWRlLmluZGV4KCkpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmV2U2xpZGUgPSBzLndyYXBwZXIuY2hpbGRyZW4oJy4nICsgcy5wYXJhbXMuc2xpZGVQcmV2Q2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZTbGlkZS5sZW5ndGggPiAwKSBzLmxhenkubG9hZEltYWdlSW5TbGlkZShwcmV2U2xpZGUuaW5kZXgoKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25UcmFuc2l0aW9uU3RhcnQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMubGF6eUxvYWRpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxhenlMb2FkaW5nT25UcmFuc2l0aW9uU3RhcnQgfHwgKCFzLnBhcmFtcy5sYXp5TG9hZGluZ09uVHJhbnNpdGlvblN0YXJ0ICYmICFzLmxhenkuaW5pdGlhbEltYWdlTG9hZGVkKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5sYXp5LmxvYWQoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvblRyYW5zaXRpb25FbmQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMubGF6eUxvYWRpbmcgJiYgIXMucGFyYW1zLmxhenlMb2FkaW5nT25UcmFuc2l0aW9uU3RhcnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5sYXp5LmxvYWQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBTY3JvbGxiYXJcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLnNjcm9sbGJhciA9IHtcbiAgICAgICAgICAgIGlzVG91Y2hlZDogZmFsc2UsXG4gICAgICAgICAgICBzZXREcmFnUG9zaXRpb246IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNiID0gcy5zY3JvbGxiYXI7XG4gICAgICAgICAgICAgICAgdmFyIHggPSAwLCB5ID0gMDtcbiAgICAgICAgICAgICAgICB2YXIgdHJhbnNsYXRlO1xuICAgICAgICAgICAgICAgIHZhciBwb2ludGVyUG9zaXRpb24gPSBzLmlzSG9yaXpvbnRhbCgpID9cbiAgICAgICAgICAgICAgICAgICAgKChlLnR5cGUgPT09ICd0b3VjaHN0YXJ0JyB8fCBlLnR5cGUgPT09ICd0b3VjaG1vdmUnKSA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGUucGFnZVggfHwgZS5jbGllbnRYKSA6XG4gICAgICAgICAgICAgICAgICAgICgoZS50eXBlID09PSAndG91Y2hzdGFydCcgfHwgZS50eXBlID09PSAndG91Y2htb3ZlJykgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgOiBlLnBhZ2VZIHx8IGUuY2xpZW50WSkgO1xuICAgICAgICAgICAgICAgIHZhciBwb3NpdGlvbiA9IChwb2ludGVyUG9zaXRpb24pIC0gc2IudHJhY2sub2Zmc2V0KClbcy5pc0hvcml6b250YWwoKSA/ICdsZWZ0JyA6ICd0b3AnXSAtIHNiLmRyYWdTaXplIC8gMjtcbiAgICAgICAgICAgICAgICB2YXIgcG9zaXRpb25NaW4gPSAtcy5taW5UcmFuc2xhdGUoKSAqIHNiLm1vdmVEaXZpZGVyO1xuICAgICAgICAgICAgICAgIHZhciBwb3NpdGlvbk1heCA9IC1zLm1heFRyYW5zbGF0ZSgpICogc2IubW92ZURpdmlkZXI7XG4gICAgICAgICAgICAgICAgaWYgKHBvc2l0aW9uIDwgcG9zaXRpb25NaW4pIHtcbiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24gPSBwb3NpdGlvbk1pbjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAocG9zaXRpb24gPiBwb3NpdGlvbk1heCkge1xuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IHBvc2l0aW9uTWF4O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IC1wb3NpdGlvbiAvIHNiLm1vdmVEaXZpZGVyO1xuICAgICAgICAgICAgICAgIHMudXBkYXRlUHJvZ3Jlc3MocG9zaXRpb24pO1xuICAgICAgICAgICAgICAgIHMuc2V0V3JhcHBlclRyYW5zbGF0ZShwb3NpdGlvbiwgdHJ1ZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZHJhZ1N0YXJ0OiBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIHZhciBzYiA9IHMuc2Nyb2xsYmFyO1xuICAgICAgICAgICAgICAgIHNiLmlzVG91Y2hlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHNiLnNldERyYWdQb3NpdGlvbihlKTtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoc2IuZHJhZ1RpbWVvdXQpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBzYi50cmFjay50cmFuc2l0aW9uKDApO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zY3JvbGxiYXJIaWRlKSB7XG4gICAgICAgICAgICAgICAgICAgIHNiLnRyYWNrLmNzcygnb3BhY2l0eScsIDEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzLndyYXBwZXIudHJhbnNpdGlvbigxMDApO1xuICAgICAgICAgICAgICAgIHNiLmRyYWcudHJhbnNpdGlvbigxMDApO1xuICAgICAgICAgICAgICAgIHMuZW1pdCgnb25TY3JvbGxiYXJEcmFnU3RhcnQnLCBzKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkcmFnTW92ZTogZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgc2IgPSBzLnNjcm9sbGJhcjtcbiAgICAgICAgICAgICAgICBpZiAoIXNiLmlzVG91Y2hlZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmIChlLnByZXZlbnREZWZhdWx0KSBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgZWxzZSBlLnJldHVyblZhbHVlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgc2Iuc2V0RHJhZ1Bvc2l0aW9uKGUpO1xuICAgICAgICAgICAgICAgIHMud3JhcHBlci50cmFuc2l0aW9uKDApO1xuICAgICAgICAgICAgICAgIHNiLnRyYWNrLnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgc2IuZHJhZy50cmFuc2l0aW9uKDApO1xuICAgICAgICAgICAgICAgIHMuZW1pdCgnb25TY3JvbGxiYXJEcmFnTW92ZScsIHMpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGRyYWdFbmQ6IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNiID0gcy5zY3JvbGxiYXI7XG4gICAgICAgICAgICAgICAgaWYgKCFzYi5pc1RvdWNoZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICBzYi5pc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuc2Nyb2xsYmFySGlkZSkge1xuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoc2IuZHJhZ1RpbWVvdXQpO1xuICAgICAgICAgICAgICAgICAgICBzYi5kcmFnVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2IudHJhY2suY3NzKCdvcGFjaXR5JywgMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzYi50cmFjay50cmFuc2l0aW9uKDQwMCk7XG4gICAgICAgICAgICAgICAgICAgIH0sIDEwMDApO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcy5lbWl0KCdvblNjcm9sbGJhckRyYWdFbmQnLCBzKTtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuc2Nyb2xsYmFyU25hcE9uUmVsZWFzZSkge1xuICAgICAgICAgICAgICAgICAgICBzLnNsaWRlUmVzZXQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZW5hYmxlRHJhZ2dhYmxlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNiID0gcy5zY3JvbGxiYXI7XG4gICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IHMuc3VwcG9ydC50b3VjaCA/IHNiLnRyYWNrIDogZG9jdW1lbnQ7XG4gICAgICAgICAgICAgICAgJChzYi50cmFjaykub24ocy50b3VjaEV2ZW50cy5zdGFydCwgc2IuZHJhZ1N0YXJ0KTtcbiAgICAgICAgICAgICAgICAkKHRhcmdldCkub24ocy50b3VjaEV2ZW50cy5tb3ZlLCBzYi5kcmFnTW92ZSk7XG4gICAgICAgICAgICAgICAgJCh0YXJnZXQpLm9uKHMudG91Y2hFdmVudHMuZW5kLCBzYi5kcmFnRW5kKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkaXNhYmxlRHJhZ2dhYmxlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNiID0gcy5zY3JvbGxiYXI7XG4gICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IHMuc3VwcG9ydC50b3VjaCA/IHNiLnRyYWNrIDogZG9jdW1lbnQ7XG4gICAgICAgICAgICAgICAgJChzYi50cmFjaykub2ZmKHMudG91Y2hFdmVudHMuc3RhcnQsIHNiLmRyYWdTdGFydCk7XG4gICAgICAgICAgICAgICAgJCh0YXJnZXQpLm9mZihzLnRvdWNoRXZlbnRzLm1vdmUsIHNiLmRyYWdNb3ZlKTtcbiAgICAgICAgICAgICAgICAkKHRhcmdldCkub2ZmKHMudG91Y2hFdmVudHMuZW5kLCBzYi5kcmFnRW5kKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXMucGFyYW1zLnNjcm9sbGJhcikgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHZhciBzYiA9IHMuc2Nyb2xsYmFyO1xuICAgICAgICAgICAgICAgIHNiLnRyYWNrID0gJChzLnBhcmFtcy5zY3JvbGxiYXIpO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy51bmlxdWVOYXZFbGVtZW50cyAmJiB0eXBlb2Ygcy5wYXJhbXMuc2Nyb2xsYmFyID09PSAnc3RyaW5nJyAmJiBzYi50cmFjay5sZW5ndGggPiAxICYmIHMuY29udGFpbmVyLmZpbmQocy5wYXJhbXMuc2Nyb2xsYmFyKS5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgc2IudHJhY2sgPSBzLmNvbnRhaW5lci5maW5kKHMucGFyYW1zLnNjcm9sbGJhcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHNiLmRyYWcgPSBzYi50cmFjay5maW5kKCcuc3dpcGVyLXNjcm9sbGJhci1kcmFnJyk7XG4gICAgICAgICAgICAgICAgaWYgKHNiLmRyYWcubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHNiLmRyYWcgPSAkKCc8ZGl2IGNsYXNzPVwic3dpcGVyLXNjcm9sbGJhci1kcmFnXCI+PC9kaXY+Jyk7XG4gICAgICAgICAgICAgICAgICAgIHNiLnRyYWNrLmFwcGVuZChzYi5kcmFnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc2IuZHJhZ1swXS5zdHlsZS53aWR0aCA9ICcnO1xuICAgICAgICAgICAgICAgIHNiLmRyYWdbMF0uc3R5bGUuaGVpZ2h0ID0gJyc7XG4gICAgICAgICAgICAgICAgc2IudHJhY2tTaXplID0gcy5pc0hvcml6b250YWwoKSA/IHNiLnRyYWNrWzBdLm9mZnNldFdpZHRoIDogc2IudHJhY2tbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBzYi5kaXZpZGVyID0gcy5zaXplIC8gcy52aXJ0dWFsU2l6ZTtcbiAgICAgICAgICAgICAgICBzYi5tb3ZlRGl2aWRlciA9IHNiLmRpdmlkZXIgKiAoc2IudHJhY2tTaXplIC8gcy5zaXplKTtcbiAgICAgICAgICAgICAgICBzYi5kcmFnU2l6ZSA9IHNiLnRyYWNrU2l6ZSAqIHNiLmRpdmlkZXI7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChzLmlzSG9yaXpvbnRhbCgpKSB7XG4gICAgICAgICAgICAgICAgICAgIHNiLmRyYWdbMF0uc3R5bGUud2lkdGggPSBzYi5kcmFnU2l6ZSArICdweCc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzYi5kcmFnWzBdLnN0eWxlLmhlaWdodCA9IHNiLmRyYWdTaXplICsgJ3B4JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChzYi5kaXZpZGVyID49IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgc2IudHJhY2tbMF0uc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNiLnRyYWNrWzBdLnN0eWxlLmRpc3BsYXkgPSAnJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNjcm9sbGJhckhpZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgc2IudHJhY2tbMF0uc3R5bGUub3BhY2l0eSA9IDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNldFRyYW5zbGF0ZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmICghcy5wYXJhbXMuc2Nyb2xsYmFyKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIGRpZmY7XG4gICAgICAgICAgICAgICAgdmFyIHNiID0gcy5zY3JvbGxiYXI7XG4gICAgICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZSA9IHMudHJhbnNsYXRlIHx8IDA7XG4gICAgICAgICAgICAgICAgdmFyIG5ld1BvcztcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIG5ld1NpemUgPSBzYi5kcmFnU2l6ZTtcbiAgICAgICAgICAgICAgICBuZXdQb3MgPSAoc2IudHJhY2tTaXplIC0gc2IuZHJhZ1NpemUpICogcy5wcm9ncmVzcztcbiAgICAgICAgICAgICAgICBpZiAocy5ydGwgJiYgcy5pc0hvcml6b250YWwoKSkge1xuICAgICAgICAgICAgICAgICAgICBuZXdQb3MgPSAtbmV3UG9zO1xuICAgICAgICAgICAgICAgICAgICBpZiAobmV3UG9zID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3U2l6ZSA9IHNiLmRyYWdTaXplIC0gbmV3UG9zO1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3UG9zID0gMDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICgtbmV3UG9zICsgc2IuZHJhZ1NpemUgPiBzYi50cmFja1NpemUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1NpemUgPSBzYi50cmFja1NpemUgKyBuZXdQb3M7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChuZXdQb3MgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdTaXplID0gc2IuZHJhZ1NpemUgKyBuZXdQb3M7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdQb3MgPSAwO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG5ld1BvcyArIHNiLmRyYWdTaXplID4gc2IudHJhY2tTaXplKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdTaXplID0gc2IudHJhY2tTaXplIC0gbmV3UG9zO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzLmlzSG9yaXpvbnRhbCgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnN1cHBvcnQudHJhbnNmb3JtczNkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzYi5kcmFnLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIChuZXdQb3MpICsgJ3B4LCAwLCAwKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2IuZHJhZy50cmFuc2Zvcm0oJ3RyYW5zbGF0ZVgoJyArIChuZXdQb3MpICsgJ3B4KScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHNiLmRyYWdbMF0uc3R5bGUud2lkdGggPSBuZXdTaXplICsgJ3B4JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnN1cHBvcnQudHJhbnNmb3JtczNkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzYi5kcmFnLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMHB4LCAnICsgKG5ld1BvcykgKyAncHgsIDApJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzYi5kcmFnLnRyYW5zZm9ybSgndHJhbnNsYXRlWSgnICsgKG5ld1BvcykgKyAncHgpJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgc2IuZHJhZ1swXS5zdHlsZS5oZWlnaHQgPSBuZXdTaXplICsgJ3B4JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNjcm9sbGJhckhpZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHNiLnRpbWVvdXQpO1xuICAgICAgICAgICAgICAgICAgICBzYi50cmFja1swXS5zdHlsZS5vcGFjaXR5ID0gMTtcbiAgICAgICAgICAgICAgICAgICAgc2IudGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc2IudHJhY2tbMF0uc3R5bGUub3BhY2l0eSA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICBzYi50cmFjay50cmFuc2l0aW9uKDQwMCk7XG4gICAgICAgICAgICAgICAgICAgIH0sIDEwMDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZXRUcmFuc2l0aW9uOiBmdW5jdGlvbiAoZHVyYXRpb24pIHtcbiAgICAgICAgICAgICAgICBpZiAoIXMucGFyYW1zLnNjcm9sbGJhcikgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHMuc2Nyb2xsYmFyLmRyYWcudHJhbnNpdGlvbihkdXJhdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIENvbnRyb2xsZXJcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLmNvbnRyb2xsZXIgPSB7XG4gICAgICAgICAgICBMaW5lYXJTcGxpbmU6IGZ1bmN0aW9uICh4LCB5KSB7XG4gICAgICAgICAgICAgICAgdGhpcy54ID0geDtcbiAgICAgICAgICAgICAgICB0aGlzLnkgPSB5O1xuICAgICAgICAgICAgICAgIHRoaXMubGFzdEluZGV4ID0geC5sZW5ndGggLSAxO1xuICAgICAgICAgICAgICAgIC8vIEdpdmVuIGFuIHggdmFsdWUgKHgyKSwgcmV0dXJuIHRoZSBleHBlY3RlZCB5MiB2YWx1ZTpcbiAgICAgICAgICAgICAgICAvLyAoeDEseTEpIGlzIHRoZSBrbm93biBwb2ludCBiZWZvcmUgZ2l2ZW4gdmFsdWUsXG4gICAgICAgICAgICAgICAgLy8gKHgzLHkzKSBpcyB0aGUga25vd24gcG9pbnQgYWZ0ZXIgZ2l2ZW4gdmFsdWUuXG4gICAgICAgICAgICAgICAgdmFyIGkxLCBpMztcbiAgICAgICAgICAgICAgICB2YXIgbCA9IHRoaXMueC5sZW5ndGg7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHRoaXMuaW50ZXJwb2xhdGUgPSBmdW5jdGlvbiAoeDIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF4MikgcmV0dXJuIDA7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIGluZGV4ZXMgb2YgeDEgYW5kIHgzICh0aGUgYXJyYXkgaW5kZXhlcyBiZWZvcmUgYW5kIGFmdGVyIGdpdmVuIHgyKTpcbiAgICAgICAgICAgICAgICAgICAgaTMgPSBiaW5hcnlTZWFyY2godGhpcy54LCB4Mik7XG4gICAgICAgICAgICAgICAgICAgIGkxID0gaTMgLSAxO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gV2UgaGF2ZSBvdXIgaW5kZXhlcyBpMSAmIGkzLCBzbyB3ZSBjYW4gY2FsY3VsYXRlIGFscmVhZHk6XG4gICAgICAgICAgICAgICAgICAgIC8vIHkyIDo9ICgoeDLiiJJ4MSkgw5cgKHkz4oiSeTEpKSDDtyAoeDPiiJJ4MSkgKyB5MVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gKCh4MiAtIHRoaXMueFtpMV0pICogKHRoaXMueVtpM10gLSB0aGlzLnlbaTFdKSkgLyAodGhpcy54W2kzXSAtIHRoaXMueFtpMV0pICsgdGhpcy55W2kxXTtcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgYmluYXJ5U2VhcmNoID0gKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbWF4SW5kZXgsIG1pbkluZGV4LCBndWVzcztcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGFycmF5LCB2YWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1pbkluZGV4ID0gLTE7XG4gICAgICAgICAgICAgICAgICAgICAgICBtYXhJbmRleCA9IGFycmF5Lmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIChtYXhJbmRleCAtIG1pbkluZGV4ID4gMSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJyYXlbZ3Vlc3MgPSBtYXhJbmRleCArIG1pbkluZGV4ID4+IDFdIDw9IHZhbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5JbmRleCA9IGd1ZXNzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heEluZGV4ID0gZ3Vlc3M7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1heEluZGV4O1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH0pKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgLy94eHg6IGZvciBub3cgaSB3aWxsIGp1c3Qgc2F2ZSBvbmUgc3BsaW5lIGZ1bmN0aW9uIHRvIHRvXG4gICAgICAgICAgICBnZXRJbnRlcnBvbGF0ZUZ1bmN0aW9uOiBmdW5jdGlvbihjKXtcbiAgICAgICAgICAgICAgICBpZighcy5jb250cm9sbGVyLnNwbGluZSkgcy5jb250cm9sbGVyLnNwbGluZSA9IHMucGFyYW1zLmxvb3AgP1xuICAgICAgICAgICAgICAgICAgICBuZXcgcy5jb250cm9sbGVyLkxpbmVhclNwbGluZShzLnNsaWRlc0dyaWQsIGMuc2xpZGVzR3JpZCkgOlxuICAgICAgICAgICAgICAgICAgICBuZXcgcy5jb250cm9sbGVyLkxpbmVhclNwbGluZShzLnNuYXBHcmlkLCBjLnNuYXBHcmlkKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZXRUcmFuc2xhdGU6IGZ1bmN0aW9uICh0cmFuc2xhdGUsIGJ5Q29udHJvbGxlcikge1xuICAgICAgICAgICAgICAgdmFyIGNvbnRyb2xsZWQgPSBzLnBhcmFtcy5jb250cm9sO1xuICAgICAgICAgICAgICAgdmFyIG11bHRpcGxpZXIsIGNvbnRyb2xsZWRUcmFuc2xhdGU7XG4gICAgICAgICAgICAgICBmdW5jdGlvbiBzZXRDb250cm9sbGVkVHJhbnNsYXRlKGMpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcyB3aWxsIGNyZWF0ZSBhbiBJbnRlcnBvbGF0ZSBmdW5jdGlvbiBiYXNlZCBvbiB0aGUgc25hcEdyaWRzXG4gICAgICAgICAgICAgICAgICAgIC8vIHggaXMgdGhlIEdyaWQgb2YgdGhlIHNjcm9sbGVkIHNjcm9sbGVyIGFuZCB5IHdpbGwgYmUgdGhlIGNvbnRyb2xsZWQgc2Nyb2xsZXJcbiAgICAgICAgICAgICAgICAgICAgLy8gaXQgbWFrZXMgc2Vuc2UgdG8gY3JlYXRlIHRoaXMgb25seSBvbmNlIGFuZCByZWNhbGwgaXQgZm9yIHRoZSBpbnRlcnBvbGF0aW9uXG4gICAgICAgICAgICAgICAgICAgIC8vIHRoZSBmdW5jdGlvbiBkb2VzIGEgbG90IG9mIHZhbHVlIGNhY2hpbmcgZm9yIHBlcmZvcm1hbmNlXG4gICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZSA9IGMucnRsICYmIGMucGFyYW1zLmRpcmVjdGlvbiA9PT0gJ2hvcml6b250YWwnID8gLXMudHJhbnNsYXRlIDogcy50cmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5jb250cm9sQnkgPT09ICdzbGlkZScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuY29udHJvbGxlci5nZXRJbnRlcnBvbGF0ZUZ1bmN0aW9uKGMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gaSBhbSBub3Qgc3VyZSB3aHkgdGhlIHZhbHVlcyBoYXZlIHRvIGJlIG11bHRpcGxpY2F0ZWQgdGhpcyB3YXksIHRyaWVkIHRvIGludmVydCB0aGUgc25hcEdyaWRcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJ1dCBpdCBkaWQgbm90IHdvcmsgb3V0XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVkVHJhbnNsYXRlID0gLXMuY29udHJvbGxlci5zcGxpbmUuaW50ZXJwb2xhdGUoLXRyYW5zbGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmKCFjb250cm9sbGVkVHJhbnNsYXRlIHx8IHMucGFyYW1zLmNvbnRyb2xCeSA9PT0gJ2NvbnRhaW5lcicpe1xuICAgICAgICAgICAgICAgICAgICAgICAgbXVsdGlwbGllciA9IChjLm1heFRyYW5zbGF0ZSgpIC0gYy5taW5UcmFuc2xhdGUoKSkgLyAocy5tYXhUcmFuc2xhdGUoKSAtIHMubWluVHJhbnNsYXRlKCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlZFRyYW5zbGF0ZSA9ICh0cmFuc2xhdGUgLSBzLm1pblRyYW5zbGF0ZSgpKSAqIG11bHRpcGxpZXIgKyBjLm1pblRyYW5zbGF0ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuY29udHJvbEludmVyc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZWRUcmFuc2xhdGUgPSBjLm1heFRyYW5zbGF0ZSgpIC0gY29udHJvbGxlZFRyYW5zbGF0ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjLnVwZGF0ZVByb2dyZXNzKGNvbnRyb2xsZWRUcmFuc2xhdGUpO1xuICAgICAgICAgICAgICAgICAgICBjLnNldFdyYXBwZXJUcmFuc2xhdGUoY29udHJvbGxlZFRyYW5zbGF0ZSwgZmFsc2UsIHMpO1xuICAgICAgICAgICAgICAgICAgICBjLnVwZGF0ZUFjdGl2ZUluZGV4KCk7XG4gICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICBpZiAocy5pc0FycmF5KGNvbnRyb2xsZWQpKSB7XG4gICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb250cm9sbGVkLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sbGVkW2ldICE9PSBieUNvbnRyb2xsZXIgJiYgY29udHJvbGxlZFtpXSBpbnN0YW5jZW9mIFN3aXBlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0Q29udHJvbGxlZFRyYW5zbGF0ZShjb250cm9sbGVkW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgIGVsc2UgaWYgKGNvbnRyb2xsZWQgaW5zdGFuY2VvZiBTd2lwZXIgJiYgYnlDb250cm9sbGVyICE9PSBjb250cm9sbGVkKSB7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgIHNldENvbnRyb2xsZWRUcmFuc2xhdGUoY29udHJvbGxlZCk7XG4gICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2V0VHJhbnNpdGlvbjogZnVuY3Rpb24gKGR1cmF0aW9uLCBieUNvbnRyb2xsZXIpIHtcbiAgICAgICAgICAgICAgICB2YXIgY29udHJvbGxlZCA9IHMucGFyYW1zLmNvbnRyb2w7XG4gICAgICAgICAgICAgICAgdmFyIGk7XG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gc2V0Q29udHJvbGxlZFRyYW5zaXRpb24oYykge1xuICAgICAgICAgICAgICAgICAgICBjLnNldFdyYXBwZXJUcmFuc2l0aW9uKGR1cmF0aW9uLCBzKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGR1cmF0aW9uICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjLm9uVHJhbnNpdGlvblN0YXJ0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjLndyYXBwZXIudHJhbnNpdGlvbkVuZChmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY29udHJvbGxlZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjLnBhcmFtcy5sb29wICYmIHMucGFyYW1zLmNvbnRyb2xCeSA9PT0gJ3NsaWRlJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjLmZpeExvb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYy5vblRyYW5zaXRpb25FbmQoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocy5pc0FycmF5KGNvbnRyb2xsZWQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb250cm9sbGVkLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29udHJvbGxlZFtpXSAhPT0gYnlDb250cm9sbGVyICYmIGNvbnRyb2xsZWRbaV0gaW5zdGFuY2VvZiBTd2lwZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRDb250cm9sbGVkVHJhbnNpdGlvbihjb250cm9sbGVkW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChjb250cm9sbGVkIGluc3RhbmNlb2YgU3dpcGVyICYmIGJ5Q29udHJvbGxlciAhPT0gY29udHJvbGxlZCkge1xuICAgICAgICAgICAgICAgICAgICBzZXRDb250cm9sbGVkVHJhbnNpdGlvbihjb250cm9sbGVkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIFBhcmFsbGF4XG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgZnVuY3Rpb24gc2V0UGFyYWxsYXhUcmFuc2Zvcm0oZWwsIHByb2dyZXNzKSB7XG4gICAgICAgICAgICBlbCA9ICQoZWwpO1xuICAgICAgICAgICAgdmFyIHAsIHBYLCBwWTtcbiAgICAgICAgICAgIHZhciBydGxGYWN0b3IgPSBzLnJ0bCA/IC0xIDogMTtcbiAgICAgICAgXG4gICAgICAgICAgICBwID0gZWwuYXR0cignZGF0YS1zd2lwZXItcGFyYWxsYXgnKSB8fCAnMCc7XG4gICAgICAgICAgICBwWCA9IGVsLmF0dHIoJ2RhdGEtc3dpcGVyLXBhcmFsbGF4LXgnKTtcbiAgICAgICAgICAgIHBZID0gZWwuYXR0cignZGF0YS1zd2lwZXItcGFyYWxsYXgteScpO1xuICAgICAgICAgICAgaWYgKHBYIHx8IHBZKSB7XG4gICAgICAgICAgICAgICAgcFggPSBwWCB8fCAnMCc7XG4gICAgICAgICAgICAgICAgcFkgPSBwWSB8fCAnMCc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAocy5pc0hvcml6b250YWwoKSkge1xuICAgICAgICAgICAgICAgICAgICBwWCA9IHA7XG4gICAgICAgICAgICAgICAgICAgIHBZID0gJzAnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcFkgPSBwO1xuICAgICAgICAgICAgICAgICAgICBwWCA9ICcwJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKChwWCkuaW5kZXhPZignJScpID49IDApIHtcbiAgICAgICAgICAgICAgICBwWCA9IHBhcnNlSW50KHBYLCAxMCkgKiBwcm9ncmVzcyAqIHJ0bEZhY3RvciArICclJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHBYID0gcFggKiBwcm9ncmVzcyAqIHJ0bEZhY3RvciArICdweCcgO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKChwWSkuaW5kZXhPZignJScpID49IDApIHtcbiAgICAgICAgICAgICAgICBwWSA9IHBhcnNlSW50KHBZLCAxMCkgKiBwcm9ncmVzcyArICclJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHBZID0gcFkgKiBwcm9ncmVzcyArICdweCcgO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGVsLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHBYICsgJywgJyArIHBZICsgJywwcHgpJyk7XG4gICAgICAgIH1cbiAgICAgICAgcy5wYXJhbGxheCA9IHtcbiAgICAgICAgICAgIHNldFRyYW5zbGF0ZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHMuY29udGFpbmVyLmNoaWxkcmVuKCdbZGF0YS1zd2lwZXItcGFyYWxsYXhdLCBbZGF0YS1zd2lwZXItcGFyYWxsYXgteF0sIFtkYXRhLXN3aXBlci1wYXJhbGxheC15XScpLmVhY2goZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAgICAgc2V0UGFyYWxsYXhUcmFuc2Zvcm0odGhpcywgcy5wcm9ncmVzcyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHMuc2xpZGVzLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGUgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBzbGlkZS5maW5kKCdbZGF0YS1zd2lwZXItcGFyYWxsYXhdLCBbZGF0YS1zd2lwZXItcGFyYWxsYXgteF0sIFtkYXRhLXN3aXBlci1wYXJhbGxheC15XScpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb2dyZXNzID0gTWF0aC5taW4oTWF0aC5tYXgoc2xpZGVbMF0ucHJvZ3Jlc3MsIC0xKSwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRQYXJhbGxheFRyYW5zZm9ybSh0aGlzLCBwcm9ncmVzcyk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNldFRyYW5zaXRpb246IGZ1bmN0aW9uIChkdXJhdGlvbikge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZHVyYXRpb24gPT09ICd1bmRlZmluZWQnKSBkdXJhdGlvbiA9IHMucGFyYW1zLnNwZWVkO1xuICAgICAgICAgICAgICAgIHMuY29udGFpbmVyLmZpbmQoJ1tkYXRhLXN3aXBlci1wYXJhbGxheF0sIFtkYXRhLXN3aXBlci1wYXJhbGxheC14XSwgW2RhdGEtc3dpcGVyLXBhcmFsbGF4LXldJykuZWFjaChmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgICAgICB2YXIgZWwgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgcGFyYWxsYXhEdXJhdGlvbiA9IHBhcnNlSW50KGVsLmF0dHIoJ2RhdGEtc3dpcGVyLXBhcmFsbGF4LWR1cmF0aW9uJyksIDEwKSB8fCBkdXJhdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGR1cmF0aW9uID09PSAwKSBwYXJhbGxheER1cmF0aW9uID0gMDtcbiAgICAgICAgICAgICAgICAgICAgZWwudHJhbnNpdGlvbihwYXJhbGxheER1cmF0aW9uKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIFBsdWdpbnMgQVBJLiBDb2xsZWN0IGFsbCBhbmQgaW5pdCBhbGwgcGx1Z2luc1xuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMuX3BsdWdpbnMgPSBbXTtcbiAgICAgICAgZm9yICh2YXIgcGx1Z2luIGluIHMucGx1Z2lucykge1xuICAgICAgICAgICAgdmFyIHAgPSBzLnBsdWdpbnNbcGx1Z2luXShzLCBzLnBhcmFtc1twbHVnaW5dKTtcbiAgICAgICAgICAgIGlmIChwKSBzLl9wbHVnaW5zLnB1c2gocCk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gTWV0aG9kIHRvIGNhbGwgYWxsIHBsdWdpbnMgZXZlbnQvbWV0aG9kXG4gICAgICAgIHMuY2FsbFBsdWdpbnMgPSBmdW5jdGlvbiAoZXZlbnROYW1lKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHMuX3BsdWdpbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnROYW1lIGluIHMuX3BsdWdpbnNbaV0pIHtcbiAgICAgICAgICAgICAgICAgICAgcy5fcGx1Z2luc1tpXVtldmVudE5hbWVdKGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdLCBhcmd1bWVudHNbM10sIGFyZ3VtZW50c1s0XSwgYXJndW1lbnRzWzVdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIEV2ZW50cy9DYWxsYmFja3MvUGx1Z2lucyBFbWl0dGVyXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnROYW1lIChldmVudE5hbWUpIHtcbiAgICAgICAgICAgIGlmIChldmVudE5hbWUuaW5kZXhPZignb24nKSAhPT0gMCkge1xuICAgICAgICAgICAgICAgIGlmIChldmVudE5hbWVbMF0gIT09IGV2ZW50TmFtZVswXS50b1VwcGVyQ2FzZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50TmFtZSA9ICdvbicgKyBldmVudE5hbWVbMF0udG9VcHBlckNhc2UoKSArIGV2ZW50TmFtZS5zdWJzdHJpbmcoMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBldmVudE5hbWUgPSAnb24nICsgZXZlbnROYW1lO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBldmVudE5hbWU7XG4gICAgICAgIH1cbiAgICAgICAgcy5lbWl0dGVyRXZlbnRMaXN0ZW5lcnMgPSB7XG4gICAgICAgIFxuICAgICAgICB9O1xuICAgICAgICBzLmVtaXQgPSBmdW5jdGlvbiAoZXZlbnROYW1lKSB7XG4gICAgICAgICAgICAvLyBUcmlnZ2VyIGNhbGxiYWNrc1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zW2V2ZW50TmFtZV0pIHtcbiAgICAgICAgICAgICAgICBzLnBhcmFtc1tldmVudE5hbWVdKGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdLCBhcmd1bWVudHNbM10sIGFyZ3VtZW50c1s0XSwgYXJndW1lbnRzWzVdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBpO1xuICAgICAgICAgICAgLy8gVHJpZ2dlciBldmVudHNcbiAgICAgICAgICAgIGlmIChzLmVtaXR0ZXJFdmVudExpc3RlbmVyc1tldmVudE5hbWVdKSB7XG4gICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHMuZW1pdHRlckV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgcy5lbWl0dGVyRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXVtpXShhcmd1bWVudHNbMV0sIGFyZ3VtZW50c1syXSwgYXJndW1lbnRzWzNdLCBhcmd1bWVudHNbNF0sIGFyZ3VtZW50c1s1XSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gVHJpZ2dlciBwbHVnaW5zXG4gICAgICAgICAgICBpZiAocy5jYWxsUGx1Z2lucykgcy5jYWxsUGx1Z2lucyhldmVudE5hbWUsIGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdLCBhcmd1bWVudHNbM10sIGFyZ3VtZW50c1s0XSwgYXJndW1lbnRzWzVdKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5vbiA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGhhbmRsZXIpIHtcbiAgICAgICAgICAgIGV2ZW50TmFtZSA9IG5vcm1hbGl6ZUV2ZW50TmFtZShldmVudE5hbWUpO1xuICAgICAgICAgICAgaWYgKCFzLmVtaXR0ZXJFdmVudExpc3RlbmVyc1tldmVudE5hbWVdKSBzLmVtaXR0ZXJFdmVudExpc3RlbmVyc1tldmVudE5hbWVdID0gW107XG4gICAgICAgICAgICBzLmVtaXR0ZXJFdmVudExpc3RlbmVyc1tldmVudE5hbWVdLnB1c2goaGFuZGxlcik7XG4gICAgICAgICAgICByZXR1cm4gcztcbiAgICAgICAgfTtcbiAgICAgICAgcy5vZmYgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBoYW5kbGVyKSB7XG4gICAgICAgICAgICB2YXIgaTtcbiAgICAgICAgICAgIGV2ZW50TmFtZSA9IG5vcm1hbGl6ZUV2ZW50TmFtZShldmVudE5hbWUpO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBoYW5kbGVyID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBhbGwgaGFuZGxlcnMgZm9yIHN1Y2ggZXZlbnRcbiAgICAgICAgICAgICAgICBzLmVtaXR0ZXJFdmVudExpc3RlbmVyc1tldmVudE5hbWVdID0gW107XG4gICAgICAgICAgICAgICAgcmV0dXJuIHM7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXMuZW1pdHRlckV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0gfHwgcy5lbWl0dGVyRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXS5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzLmVtaXR0ZXJFdmVudExpc3RlbmVyc1tldmVudE5hbWVdLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYocy5lbWl0dGVyRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXVtpXSA9PT0gaGFuZGxlcikgcy5lbWl0dGVyRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXS5zcGxpY2UoaSwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcztcbiAgICAgICAgfTtcbiAgICAgICAgcy5vbmNlID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgaGFuZGxlcikge1xuICAgICAgICAgICAgZXZlbnROYW1lID0gbm9ybWFsaXplRXZlbnROYW1lKGV2ZW50TmFtZSk7XG4gICAgICAgICAgICB2YXIgX2hhbmRsZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaGFuZGxlcihhcmd1bWVudHNbMF0sIGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdLCBhcmd1bWVudHNbM10sIGFyZ3VtZW50c1s0XSk7XG4gICAgICAgICAgICAgICAgcy5vZmYoZXZlbnROYW1lLCBfaGFuZGxlcik7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcy5vbihldmVudE5hbWUsIF9oYW5kbGVyKTtcbiAgICAgICAgICAgIHJldHVybiBzO1xuICAgICAgICB9O1xuICAgIFxuICAgICAgICAvLyBBY2Nlc3NpYmlsaXR5IHRvb2xzXG4gICAgICAgIHMuYTExeSA9IHtcbiAgICAgICAgICAgIG1ha2VGb2N1c2FibGU6IGZ1bmN0aW9uICgkZWwpIHtcbiAgICAgICAgICAgICAgICAkZWwuYXR0cigndGFiSW5kZXgnLCAnMCcpO1xuICAgICAgICAgICAgICAgIHJldHVybiAkZWw7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYWRkUm9sZTogZnVuY3Rpb24gKCRlbCwgcm9sZSkge1xuICAgICAgICAgICAgICAgICRlbC5hdHRyKCdyb2xlJywgcm9sZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuICRlbDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIFxuICAgICAgICAgICAgYWRkTGFiZWw6IGZ1bmN0aW9uICgkZWwsIGxhYmVsKSB7XG4gICAgICAgICAgICAgICAgJGVsLmF0dHIoJ2FyaWEtbGFiZWwnLCBsYWJlbCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuICRlbDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIFxuICAgICAgICAgICAgZGlzYWJsZTogZnVuY3Rpb24gKCRlbCkge1xuICAgICAgICAgICAgICAgICRlbC5hdHRyKCdhcmlhLWRpc2FibGVkJywgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuICRlbDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIFxuICAgICAgICAgICAgZW5hYmxlOiBmdW5jdGlvbiAoJGVsKSB7XG4gICAgICAgICAgICAgICAgJGVsLmF0dHIoJ2FyaWEtZGlzYWJsZWQnLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuICRlbDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgIFxuICAgICAgICAgICAgb25FbnRlcktleTogZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LmtleUNvZGUgIT09IDEzKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKCQoZXZlbnQudGFyZ2V0KS5pcyhzLnBhcmFtcy5uZXh0QnV0dG9uKSkge1xuICAgICAgICAgICAgICAgICAgICBzLm9uQ2xpY2tOZXh0KGV2ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuaXNFbmQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuYTExeS5ub3RpZnkocy5wYXJhbXMubGFzdFNsaWRlTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmExMXkubm90aWZ5KHMucGFyYW1zLm5leHRTbGlkZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKCQoZXZlbnQudGFyZ2V0KS5pcyhzLnBhcmFtcy5wcmV2QnV0dG9uKSkge1xuICAgICAgICAgICAgICAgICAgICBzLm9uQ2xpY2tQcmV2KGV2ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuaXNCZWdpbm5pbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuYTExeS5ub3RpZnkocy5wYXJhbXMuZmlyc3RTbGlkZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5hMTF5Lm5vdGlmeShzLnBhcmFtcy5wcmV2U2xpZGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoJChldmVudC50YXJnZXQpLmlzKCcuJyArIHMucGFyYW1zLmJ1bGxldENsYXNzKSkge1xuICAgICAgICAgICAgICAgICAgICAkKGV2ZW50LnRhcmdldClbMF0uY2xpY2soKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICBcbiAgICAgICAgICAgIGxpdmVSZWdpb246ICQoJzxzcGFuIGNsYXNzPVwic3dpcGVyLW5vdGlmaWNhdGlvblwiIGFyaWEtbGl2ZT1cImFzc2VydGl2ZVwiIGFyaWEtYXRvbWljPVwidHJ1ZVwiPjwvc3Bhbj4nKSxcbiAgICAgICAgXG4gICAgICAgICAgICBub3RpZnk6IGZ1bmN0aW9uIChtZXNzYWdlKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5vdGlmaWNhdGlvbiA9IHMuYTExeS5saXZlUmVnaW9uO1xuICAgICAgICAgICAgICAgIGlmIChub3RpZmljYXRpb24ubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uLmh0bWwoJycpO1xuICAgICAgICAgICAgICAgIG5vdGlmaWNhdGlvbi5odG1sKG1lc3NhZ2UpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAvLyBTZXR1cCBhY2Nlc3NpYmlsaXR5XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLm5leHRCdXR0b24gJiYgcy5uZXh0QnV0dG9uICYmIHMubmV4dEJ1dHRvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuYTExeS5tYWtlRm9jdXNhYmxlKHMubmV4dEJ1dHRvbik7XG4gICAgICAgICAgICAgICAgICAgIHMuYTExeS5hZGRSb2xlKHMubmV4dEJ1dHRvbiwgJ2J1dHRvbicpO1xuICAgICAgICAgICAgICAgICAgICBzLmExMXkuYWRkTGFiZWwocy5uZXh0QnV0dG9uLCBzLnBhcmFtcy5uZXh0U2xpZGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnByZXZCdXR0b24gJiYgcy5wcmV2QnV0dG9uICYmIHMucHJldkJ1dHRvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuYTExeS5tYWtlRm9jdXNhYmxlKHMucHJldkJ1dHRvbik7XG4gICAgICAgICAgICAgICAgICAgIHMuYTExeS5hZGRSb2xlKHMucHJldkJ1dHRvbiwgJ2J1dHRvbicpO1xuICAgICAgICAgICAgICAgICAgICBzLmExMXkuYWRkTGFiZWwocy5wcmV2QnV0dG9uLCBzLnBhcmFtcy5wcmV2U2xpZGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICQocy5jb250YWluZXIpLmFwcGVuZChzLmExMXkubGl2ZVJlZ2lvbik7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaW5pdFBhZ2luYXRpb246IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucGFnaW5hdGlvbiAmJiBzLnBhcmFtcy5wYWdpbmF0aW9uQ2xpY2thYmxlICYmIHMuYnVsbGV0cyAmJiBzLmJ1bGxldHMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuYnVsbGV0cy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBidWxsZXQgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5hMTF5Lm1ha2VGb2N1c2FibGUoYnVsbGV0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuYTExeS5hZGRSb2xlKGJ1bGxldCwgJ2J1dHRvbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5hMTF5LmFkZExhYmVsKGJ1bGxldCwgcy5wYXJhbXMucGFnaW5hdGlvbkJ1bGxldE1lc3NhZ2UucmVwbGFjZSgve3tpbmRleH19LywgYnVsbGV0LmluZGV4KCkgKyAxKSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMuYTExeS5saXZlUmVnaW9uICYmIHMuYTExeS5saXZlUmVnaW9uLmxlbmd0aCA+IDApIHMuYTExeS5saXZlUmVnaW9uLnJlbW92ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgSW5pdC9EZXN0cm95XG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgcy5pbml0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIHMuY3JlYXRlTG9vcCgpO1xuICAgICAgICAgICAgcy51cGRhdGVDb250YWluZXJTaXplKCk7XG4gICAgICAgICAgICBzLnVwZGF0ZVNsaWRlc1NpemUoKTtcbiAgICAgICAgICAgIHMudXBkYXRlUGFnaW5hdGlvbigpO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNjcm9sbGJhciAmJiBzLnNjcm9sbGJhcikge1xuICAgICAgICAgICAgICAgIHMuc2Nyb2xsYmFyLnNldCgpO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zY3JvbGxiYXJEcmFnZ2FibGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5zY3JvbGxiYXIuZW5hYmxlRHJhZ2dhYmxlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmVmZmVjdCAhPT0gJ3NsaWRlJyAmJiBzLmVmZmVjdHNbcy5wYXJhbXMuZWZmZWN0XSkge1xuICAgICAgICAgICAgICAgIGlmICghcy5wYXJhbXMubG9vcCkgcy51cGRhdGVQcm9ncmVzcygpO1xuICAgICAgICAgICAgICAgIHMuZWZmZWN0c1tzLnBhcmFtcy5lZmZlY3RdLnNldFRyYW5zbGF0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICBzLnNsaWRlVG8ocy5wYXJhbXMuaW5pdGlhbFNsaWRlICsgcy5sb29wZWRTbGlkZXMsIDAsIHMucGFyYW1zLnJ1bkNhbGxiYWNrc09uSW5pdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzLnNsaWRlVG8ocy5wYXJhbXMuaW5pdGlhbFNsaWRlLCAwLCBzLnBhcmFtcy5ydW5DYWxsYmFja3NPbkluaXQpO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5pbml0aWFsU2xpZGUgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYWxsYXggJiYgcy5wYXJhbXMucGFyYWxsYXgpIHMucGFyYWxsYXguc2V0VHJhbnNsYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLmxhenkgJiYgcy5wYXJhbXMubGF6eUxvYWRpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMubGF6eS5sb2FkKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmxhenkuaW5pdGlhbEltYWdlTG9hZGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHMuYXR0YWNoRXZlbnRzKCk7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMub2JzZXJ2ZXIgJiYgcy5zdXBwb3J0Lm9ic2VydmVyKSB7XG4gICAgICAgICAgICAgICAgcy5pbml0T2JzZXJ2ZXJzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMucHJlbG9hZEltYWdlcyAmJiAhcy5wYXJhbXMubGF6eUxvYWRpbmcpIHtcbiAgICAgICAgICAgICAgICBzLnByZWxvYWRJbWFnZXMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5hdXRvcGxheSkge1xuICAgICAgICAgICAgICAgIHMuc3RhcnRBdXRvcGxheSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmtleWJvYXJkQ29udHJvbCkge1xuICAgICAgICAgICAgICAgIGlmIChzLmVuYWJsZUtleWJvYXJkQ29udHJvbCkgcy5lbmFibGVLZXlib2FyZENvbnRyb2woKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5tb3VzZXdoZWVsQ29udHJvbCkge1xuICAgICAgICAgICAgICAgIGlmIChzLmVuYWJsZU1vdXNld2hlZWxDb250cm9sKSBzLmVuYWJsZU1vdXNld2hlZWxDb250cm9sKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuaGFzaG5hdikge1xuICAgICAgICAgICAgICAgIGlmIChzLmhhc2huYXYpIHMuaGFzaG5hdi5pbml0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuYTExeSAmJiBzLmExMXkpIHMuYTExeS5pbml0KCk7XG4gICAgICAgICAgICBzLmVtaXQoJ29uSW5pdCcsIHMpO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLy8gQ2xlYW51cCBkeW5hbWljIHN0eWxlc1xuICAgICAgICBzLmNsZWFudXBTdHlsZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAvLyBDb250YWluZXJcbiAgICAgICAgICAgIHMuY29udGFpbmVyLnJlbW92ZUNsYXNzKHMuY2xhc3NOYW1lcy5qb2luKCcgJykpLnJlbW92ZUF0dHIoJ3N0eWxlJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gV3JhcHBlclxuICAgICAgICAgICAgcy53cmFwcGVyLnJlbW92ZUF0dHIoJ3N0eWxlJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2xpZGVzXG4gICAgICAgICAgICBpZiAocy5zbGlkZXMgJiYgcy5zbGlkZXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgcy5zbGlkZXNcbiAgICAgICAgICAgICAgICAgICAgLnJlbW92ZUNsYXNzKFtcbiAgICAgICAgICAgICAgICAgICAgICBzLnBhcmFtcy5zbGlkZVZpc2libGVDbGFzcyxcbiAgICAgICAgICAgICAgICAgICAgICBzLnBhcmFtcy5zbGlkZUFjdGl2ZUNsYXNzLFxuICAgICAgICAgICAgICAgICAgICAgIHMucGFyYW1zLnNsaWRlTmV4dENsYXNzLFxuICAgICAgICAgICAgICAgICAgICAgIHMucGFyYW1zLnNsaWRlUHJldkNsYXNzXG4gICAgICAgICAgICAgICAgICAgIF0uam9pbignICcpKVxuICAgICAgICAgICAgICAgICAgICAucmVtb3ZlQXR0cignc3R5bGUnKVxuICAgICAgICAgICAgICAgICAgICAucmVtb3ZlQXR0cignZGF0YS1zd2lwZXItY29sdW1uJylcbiAgICAgICAgICAgICAgICAgICAgLnJlbW92ZUF0dHIoJ2RhdGEtc3dpcGVyLXJvdycpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBhZ2luYXRpb24vQnVsbGV0c1xuICAgICAgICAgICAgaWYgKHMucGFnaW5hdGlvbkNvbnRhaW5lciAmJiBzLnBhZ2luYXRpb25Db250YWluZXIubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgcy5wYWdpbmF0aW9uQ29udGFpbmVyLnJlbW92ZUNsYXNzKHMucGFyYW1zLnBhZ2luYXRpb25IaWRkZW5DbGFzcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5idWxsZXRzICYmIHMuYnVsbGV0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBzLmJ1bGxldHMucmVtb3ZlQ2xhc3Mocy5wYXJhbXMuYnVsbGV0QWN0aXZlQ2xhc3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIEJ1dHRvbnNcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wcmV2QnV0dG9uKSAkKHMucGFyYW1zLnByZXZCdXR0b24pLnJlbW92ZUNsYXNzKHMucGFyYW1zLmJ1dHRvbkRpc2FibGVkQ2xhc3MpO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLm5leHRCdXR0b24pICQocy5wYXJhbXMubmV4dEJ1dHRvbikucmVtb3ZlQ2xhc3Mocy5wYXJhbXMuYnV0dG9uRGlzYWJsZWRDbGFzcyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2Nyb2xsYmFyXG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuc2Nyb2xsYmFyICYmIHMuc2Nyb2xsYmFyKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMuc2Nyb2xsYmFyLnRyYWNrICYmIHMuc2Nyb2xsYmFyLnRyYWNrLmxlbmd0aCkgcy5zY3JvbGxiYXIudHJhY2sucmVtb3ZlQXR0cignc3R5bGUnKTtcbiAgICAgICAgICAgICAgICBpZiAocy5zY3JvbGxiYXIuZHJhZyAmJiBzLnNjcm9sbGJhci5kcmFnLmxlbmd0aCkgcy5zY3JvbGxiYXIuZHJhZy5yZW1vdmVBdHRyKCdzdHlsZScpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLy8gRGVzdHJveVxuICAgICAgICBzLmRlc3Ryb3kgPSBmdW5jdGlvbiAoZGVsZXRlSW5zdGFuY2UsIGNsZWFudXBTdHlsZXMpIHtcbiAgICAgICAgICAgIC8vIERldGFjaCBldmVidHNcbiAgICAgICAgICAgIHMuZGV0YWNoRXZlbnRzKCk7XG4gICAgICAgICAgICAvLyBTdG9wIGF1dG9wbGF5XG4gICAgICAgICAgICBzLnN0b3BBdXRvcGxheSgpO1xuICAgICAgICAgICAgLy8gRGlzYWJsZSBkcmFnZ2FibGVcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zY3JvbGxiYXIgJiYgcy5zY3JvbGxiYXIpIHtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuc2Nyb2xsYmFyRHJhZ2dhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuc2Nyb2xsYmFyLmRpc2FibGVEcmFnZ2FibGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBEZXN0cm95IGxvb3BcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5sb29wKSB7XG4gICAgICAgICAgICAgICAgcy5kZXN0cm95TG9vcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gQ2xlYW51cCBzdHlsZXNcbiAgICAgICAgICAgIGlmIChjbGVhbnVwU3R5bGVzKSB7XG4gICAgICAgICAgICAgICAgcy5jbGVhbnVwU3R5bGVzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBEaXNjb25uZWN0IG9ic2VydmVyXG4gICAgICAgICAgICBzLmRpc2Nvbm5lY3RPYnNlcnZlcnMoKTtcbiAgICAgICAgICAgIC8vIERpc2FibGUga2V5Ym9hcmQvbW91c2V3aGVlbFxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmtleWJvYXJkQ29udHJvbCkge1xuICAgICAgICAgICAgICAgIGlmIChzLmRpc2FibGVLZXlib2FyZENvbnRyb2wpIHMuZGlzYWJsZUtleWJvYXJkQ29udHJvbCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLm1vdXNld2hlZWxDb250cm9sKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMuZGlzYWJsZU1vdXNld2hlZWxDb250cm9sKSBzLmRpc2FibGVNb3VzZXdoZWVsQ29udHJvbCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gRGlzYWJsZSBhMTF5XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuYTExeSAmJiBzLmExMXkpIHMuYTExeS5kZXN0cm95KCk7XG4gICAgICAgICAgICAvLyBEZXN0cm95IGNhbGxiYWNrXG4gICAgICAgICAgICBzLmVtaXQoJ29uRGVzdHJveScpO1xuICAgICAgICAgICAgLy8gRGVsZXRlIGluc3RhbmNlXG4gICAgICAgICAgICBpZiAoZGVsZXRlSW5zdGFuY2UgIT09IGZhbHNlKSBzID0gbnVsbDtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIHMuaW5pdCgpO1xuICAgICAgICBcbiAgICBcbiAgICBcbiAgICAgICAgLy8gUmV0dXJuIHN3aXBlciBpbnN0YW5jZVxuICAgICAgICByZXR1cm4gcztcbiAgICB9O1xuICAgIFxuICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgUHJvdG90eXBlXG4gICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgU3dpcGVyLnByb3RvdHlwZSA9IHtcbiAgICAgICAgaXNTYWZhcmk6IChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7XG4gICAgICAgICAgICByZXR1cm4gKHVhLmluZGV4T2YoJ3NhZmFyaScpID49IDAgJiYgdWEuaW5kZXhPZignY2hyb21lJykgPCAwICYmIHVhLmluZGV4T2YoJ2FuZHJvaWQnKSA8IDApO1xuICAgICAgICB9KSgpLFxuICAgICAgICBpc1VpV2ViVmlldzogLyhpUGhvbmV8aVBvZHxpUGFkKS4qQXBwbGVXZWJLaXQoPyEuKlNhZmFyaSkvaS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpLFxuICAgICAgICBpc0FycmF5OiBmdW5jdGlvbiAoYXJyKSB7XG4gICAgICAgICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5hcHBseShhcnIpID09PSAnW29iamVjdCBBcnJheV0nO1xuICAgICAgICB9LFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgIEJyb3dzZXJcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGJyb3dzZXI6IHtcbiAgICAgICAgICAgIGllOiB3aW5kb3cubmF2aWdhdG9yLnBvaW50ZXJFbmFibGVkIHx8IHdpbmRvdy5uYXZpZ2F0b3IubXNQb2ludGVyRW5hYmxlZCxcbiAgICAgICAgICAgIGllVG91Y2g6ICh3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQgJiYgd2luZG93Lm5hdmlnYXRvci5tc01heFRvdWNoUG9pbnRzID4gMSkgfHwgKHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQgJiYgd2luZG93Lm5hdmlnYXRvci5tYXhUb3VjaFBvaW50cyA+IDEpXG4gICAgICAgIH0sXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgRGV2aWNlc1xuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgZGV2aWNlOiAoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudDtcbiAgICAgICAgICAgIHZhciBhbmRyb2lkID0gdWEubWF0Y2goLyhBbmRyb2lkKTs/W1xcc1xcL10rKFtcXGQuXSspPy8pO1xuICAgICAgICAgICAgdmFyIGlwYWQgPSB1YS5tYXRjaCgvKGlQYWQpLipPU1xccyhbXFxkX10rKS8pO1xuICAgICAgICAgICAgdmFyIGlwb2QgPSB1YS5tYXRjaCgvKGlQb2QpKC4qT1NcXHMoW1xcZF9dKykpPy8pO1xuICAgICAgICAgICAgdmFyIGlwaG9uZSA9ICFpcGFkICYmIHVhLm1hdGNoKC8oaVBob25lXFxzT1MpXFxzKFtcXGRfXSspLyk7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGlvczogaXBhZCB8fCBpcGhvbmUgfHwgaXBvZCxcbiAgICAgICAgICAgICAgICBhbmRyb2lkOiBhbmRyb2lkXG4gICAgICAgICAgICB9O1xuICAgICAgICB9KSgpLFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgIEZlYXR1cmUgRGV0ZWN0aW9uXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzdXBwb3J0OiB7XG4gICAgICAgICAgICB0b3VjaCA6ICh3aW5kb3cuTW9kZXJuaXpyICYmIE1vZGVybml6ci50b3VjaCA9PT0gdHJ1ZSkgfHwgKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gISEoKCdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdykgfHwgd2luZG93LkRvY3VtZW50VG91Y2ggJiYgZG9jdW1lbnQgaW5zdGFuY2VvZiBEb2N1bWVudFRvdWNoKTtcbiAgICAgICAgICAgIH0pKCksXG4gICAgXG4gICAgICAgICAgICB0cmFuc2Zvcm1zM2QgOiAod2luZG93Lk1vZGVybml6ciAmJiBNb2Rlcm5penIuY3NzdHJhbnNmb3JtczNkID09PSB0cnVlKSB8fCAoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKS5zdHlsZTtcbiAgICAgICAgICAgICAgICByZXR1cm4gKCd3ZWJraXRQZXJzcGVjdGl2ZScgaW4gZGl2IHx8ICdNb3pQZXJzcGVjdGl2ZScgaW4gZGl2IHx8ICdPUGVyc3BlY3RpdmUnIGluIGRpdiB8fCAnTXNQZXJzcGVjdGl2ZScgaW4gZGl2IHx8ICdwZXJzcGVjdGl2ZScgaW4gZGl2KTtcbiAgICAgICAgICAgIH0pKCksXG4gICAgXG4gICAgICAgICAgICBmbGV4Ym94OiAoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKS5zdHlsZTtcbiAgICAgICAgICAgICAgICB2YXIgc3R5bGVzID0gKCdhbGlnbkl0ZW1zIHdlYmtpdEFsaWduSXRlbXMgd2Via2l0Qm94QWxpZ24gbXNGbGV4QWxpZ24gbW96Qm94QWxpZ24gd2Via2l0RmxleERpcmVjdGlvbiBtc0ZsZXhEaXJlY3Rpb24gbW96Qm94RGlyZWN0aW9uIG1vekJveE9yaWVudCB3ZWJraXRCb3hEaXJlY3Rpb24gd2Via2l0Qm94T3JpZW50Jykuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0eWxlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoc3R5bGVzW2ldIGluIGRpdikgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSkoKSxcbiAgICBcbiAgICAgICAgICAgIG9ic2VydmVyOiAoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAoJ011dGF0aW9uT2JzZXJ2ZXInIGluIHdpbmRvdyB8fCAnV2Via2l0TXV0YXRpb25PYnNlcnZlcicgaW4gd2luZG93KTtcbiAgICAgICAgICAgIH0pKClcbiAgICAgICAgfSxcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICBQbHVnaW5zXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBwbHVnaW5zOiB7fVxuICAgIH07XG5cbn0pKCk7XG5cbi8vIyBzb3VyY2VNYXBwaW5nVVJMPWZyYW1ld29yazcuanMubWFwXG4iXX0=
