(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
/*jslint browser: true*/
/*global console*/
var welcomescreen_p = require('./welcomescreen');

var myapp = myapp || {};
myapp.pages = myapp.pages || {};

myapp.pages.IndexPageController = function (myapp, $$) {
    'use strict';

    // Welcomscreen method
    (function () {
           var options = {
                'bgcolor': '#fff',
                'fontcolor': '#589001',

                'onOpened': function () {
                },
                'onClosed': function () {
                }
            },
            welcomescreen_slides,
            welcomescreen;

        welcomescreen_slides = [
            {
                id: 'slide0',
                picture: '<div class="welcome-icon"><i class="icon icon-welcome"></i></div>',
                text: '',
                title: ''
            }

        ];

        welcomescreen = welcomescreen_p.welcomescreen_plugin(welcomescreen_slides, options);
        $$(document).on('click', '.tutorial-close-btn', function () {
            welcomescreen.close();
        });

        $$('.tutorial-open-btn').click(function () {
            welcomescreen.open();
        });

        $$(document).on('click', '.tutorial-next-link', function (e) {
            welcomescreen.next();
        });

        $$(document).on('click', '.tutorial-previous-slide', function (e) {
            welcomescreen.previous();
        });

        // скрываем флеш скрин
        var welcom = $$('.welcomescreen-container');
        var hide_animation = function(){
            welcom.addClass('hideAnimation');
            var hide_welcomescreen = function(){
                welcomescreen.close();
            };
            delyed(hide_welcomescreen, 1000);
        };
        delyed(hide_animation,1500);


    }());



};
module.exports = {
    page_index : myapp.pages.IndexPageController
};
},{"./welcomescreen":4}],2:[function(require,module,exports){
/**
 * Created by user on 25.03.16.
 */
function createArrayStorage(){

}

function closeSettings(){

}

module.exports = {
    createArrayStorage: createArrayStorage,
    closeSettings: closeSettings
};




},{}],3:[function(require,module,exports){
'use strict';

/**
 * Created by user on 21.04.16.
 */
var f7 = require('framework7');
var my_app = require('./MyApp');
var pages = require('./IndexPageController');



var myapp = myapp || {};
var myApp = new Framework7(
    {
        //pushState:true,
        init:false,
        //tapHold: true, //enable tap hold events
        router: true,
        reloadPages:true,
        //animateNavBackIcon: true,
        swipeBackPage: false,
        // Enable templates auto precompilation
        precompileTemplates: true,
        // Enabled pages rendering using Template7
        template7Pages: true,
        // Specify Template7 data for pages
        modalButtonCancel: _w.global.buttons.cancel[LN]
});
// global
var n = {
    language:'en',
    platform: "iOS",
    JSAPI: null,
    free: false,
    settings: null,
    sounds:{},
    key_storage:{
        categories:"trip_obj",
        language:"trip_language"
    }
};

document.addEventListener("DOMContentLoaded", function(event) {
    //storageClear();
    // Init method
    if(!storageGet(n.key_storage.categories)){
        // заносим категории по умолчанию
        my_app.createArrayStorage();
    }
    else{
        console.log('init');

    }

    n.JSAPI = JSAPI;
    n.JSAPI.keepScreenOn();
    n.JSAPI.setStatusBarColor("black");


    if(n.free){
        addPaddingBunner();
    }
    //setInterval(updateData, 1000);

    console.log('end ready');
    // Initialize app
    var fw7App = myApp,
        $$ = Dom7,
        ipc = new pages.page_index(fw7App, $$);

    $$(document.body).on('click','.toolbar .link', function(e){
        closeSettings();
    });
});
window.addEventListener("deviceReadyEvent", function(event) {
    n.sounds.tap = new Sound('sounds/tap.mp3');
    n.sounds.tap.volume(0.5);
    $$(document.body).on('click', '.navbar .link, .toolbar .link, .subnavbar .tab-link', function(e){
        var that = $$(this);
        pointerEvent(that, 'none');
        playSound(n.sounds.tap);
        pointerEvent(that, 'auto', 300);
    });
});



},{"./IndexPageController":1,"./MyApp":2,"framework7":5}],4:[function(require,module,exports){
/*jslint browser: true*/
/*global console, Framework7, alert, Dom7, Swiper, Template7*/

/**
 * A plugin for Framework7 to show a slideable welcome screen
 *
 * @module Framework7/prototype/plugins/welcomescreen
 * @author www.timo-ernst.net
 * @license MIT
 */
Framework7.prototype.plugins.welcomescreen = function (app, globalPluginParams) {
    'use strict';

    // Variables in module scope
    var $$ = Dom7,
        t7 = Template7,
        Welcomescreen;

    // Click handler to close welcomescreen
    $$(document).on('click', '.close-welcomescreen', function (e) {
        e.preventDefault();
        var $wscreen = $$(this).parents('.welcomescreen-container');
        if ($wscreen.length > 0 && $wscreen[0].f7Welcomescreen) { $wscreen[0].f7Welcomescreen.close(); }
    });

    /**
     * Represents the welcome screen
     *
     * @class
     * @memberof module:Framework7/prototype/plugins/welcomescreen
     */
    Welcomescreen = function (slides, options) {

        // Private properties
        var self = this,
            defaultTemplate,
            template,
            container,
            swiper,
            swiperContainer,
            defaults = {
                closeButton: false,        // enabled/disable close button
                closeButtonText : 'Skip', // close button text
                cssClass: '',             // additional class on container
                pagination: false,         // swiper pagination
                loop: false,              // swiper loop
                open: true                // open welcome screen on init
            };

        /**
         * Initializes the swiper
         *
         * @private
         */
        function initSwiper() {
            swiper = new Swiper('.swiper-container', {
                direction: 'horizontal',
                loop: options.loop,
                pagination: options.pagination ? swiperContainer.find('.swiper-pagination') : undefined
            });
        }

        /**
         * Sets colors from options
         *
         * @private
         */
        function setColors() {
            if (options.bgcolor) {
                container.css({
                    'background-color': options.bgcolor,
                    'color': options.fontcolor
                });
            }
        }

        /**
         * Sets the default template
         *
         * @private
         */
        function defineDefaultTemplate() {
            defaultTemplate = '<div class="welcomescreen-container {{#if options.cssClass}}{{options.cssClass}}{{/if}}">' +
                '{{#if options.closeButton}}' +
                '<div class="welcomescreen-closebtn close-welcomescreen">{{options.closeButtonText}}</div>' +
                '{{/if}}' +
                '<div class="welcomescreen-swiper">' +
                '<div class="swiper-wrapper">' +
                '{{#each slides}}' +
                '<div class="swiper-slide flex-row align-main-start" {{#if id}}id="{{id}}"{{/if}}>' +
                '{{#if content}}' +
                '<div class="welcomescreen-content">{{content}}</div>' +
                '{{else}}' +
                '{{#if title}}' +
                '<div class="welcomescreen-title">{{title}}</div>' +
                '{{/if}}' +
                '{{#if picture}}' +
                '<div class="welcomescreen-picture">{{picture}}</div>' +
                '{{/if}}' +
                '{{#if text}}' +
                '<div class="welcomescreen-text">{{text}}</div>' +
                '{{/if}}' +
                '{{/if}}' +
                '</div>' +
                '{{/each}}' +
                '</div>' +
                '{{#if options.pagination}}' +
                '<div class="welcomescreen-pagination swiper-pagination"></div>' +
                '{{/if}}' +
                '</div>' +
                '</div>';
        }


        /**
         * Sets the options that were required
         *
         * @private
         */
        function applyOptions() {
            var def;
            options = options || {};
            for (def in defaults) {
                if (typeof options[def] === 'undefined') {
                    options[def] = defaults[def];
                }
            }
        }

        /**
         * Compiles the template
         *
         * @private
         */
        function compileTemplate() {
            if (!options.template) {
                // Cache compiled templates
                if (!app._compiledTemplates.welcomescreen) {
                    app._compiledTemplates.welcomescreen = t7.compile(defaultTemplate);
                }
                template = app._compiledTemplates.welcomescreen;
            } else {
                template = t7.compile(options.template);
            }
        }

        /**
         * Shows the welcome screen
         *
         * @public
         * @memberof module:Framework7/prototype/plugins/welcomescreen
         */
        self.open = function () {
            container = $$(template({options: options, slides: slides}));
            swiperContainer = container.find('.swiper-container');
            setColors();
            $$('body').append(container);
            //initSwiper();
            container[0].f7Welcomescreen = self;
            if (typeof options.onOpened === 'function') { options.onOpened(); }
        };

        /**
         * Hides the welcome screen
         *
         * @public
         * @memberof module:Framework7/prototype/plugins/welcomescreen
         */
        self.close = function () {
            if (swiper) {
                swiper.destroy(true); }
            if (container) { container.remove(); }
            container = swiperContainer = swiper = undefined;
            if (typeof options.onClosed === 'function') { options.onClosed(); }
        };

        /**
         * Shows the next slide
         *
         * @public
         * @memberof module:Framework7/prototype/plugins/welcomescreen
         */
        self.next = function () {
            if (swiper) { swiper.slideNext(); }
        };

        /**
         * Shows the previous slide
         *
         * @public
         * @memberof module:Framework7/prototype/plugins/welcomescreen
         */
        self.previous = function () {
            if (swiper) { swiper.slidePrev(); }
        };

        /**
         * Goes to the desired slide
         *
         * @param {number} index The slide to show
         * @public
         * @memberof module:Framework7/prototype/plugins/welcomescreen
         */
        self.slideTo = function (index) {
            if (swiper) { swiper.slideTo(index); }
        };

        /**
         * Initialize the instance
         *
         * @method init
         */
        (function () {
            defineDefaultTemplate();
            compileTemplate();
            applyOptions();

            // Open on init
            if (options.open) {
                self.open();
            }

        }());

        // Return instance
        return self;
    };

    app.welcomescreen = function (slides, options) {
        return new Welcomescreen(slides, options);
    };

};
module.exports = {
    welcomescreen_plugin : Framework7.prototype.plugins.welcomescreen
};
},{}],5:[function(require,module,exports){
/**
 * Framework7 1.4.2
 * Full Featured Mobile HTML Framework For Building iOS & Android Apps
 * 
 * http://www.idangero.us/framework7
 * 
 * Copyright 2016, Vladimir Kharlampidi
 * The iDangero.us
 * http://www.idangero.us/
 * 
 * Licensed under MIT
 * 
 * Released on: February 27, 2016
 */
(function () {

    'use strict';
    /*===========================
    Framework 7
    ===========================*/
    window.Framework7 = function (params) {
        // App
        var app = this;
    
        // Version
        app.version = '1.4.2';
    
        // Default Parameters
        app.params = {
            cache: true,
            cacheIgnore: [],
            cacheIgnoreGetParameters: false,
            cacheDuration: 1000 * 60 * 10, // Ten minutes
            preloadPreviousPage: true,
            uniqueHistory: false,
            uniqueHistoryIgnoreGetParameters: false,
            dynamicPageUrl: 'content-{{index}}',
            allowDuplicateUrls: false,
            router: true,
            // Push State
            pushState: false,
            pushStateRoot: undefined,
            pushStateNoAnimation: false,
            pushStateSeparator: '#!/',
            pushStateOnLoad: true,
            // Fast clicks
            fastClicks: true,
            fastClicksDistanceThreshold: 10,
            fastClicksDelayBetweenClicks: 50,
            // Tap Hold
            tapHold: false,
            tapHoldDelay: 750,
            tapHoldPreventClicks: true,
            // Active State
            activeState: true,
            activeStateElements: 'a, button, label, span',
            // Animate Nav Back Icon
            animateNavBackIcon: false,
            // Swipe Back
            swipeBackPage: true,
            swipeBackPageThreshold: 0,
            swipeBackPageActiveArea: 30,
            swipeBackPageAnimateShadow: true,
            swipeBackPageAnimateOpacity: true,
            // Ajax
            ajaxLinks: undefined, // or CSS selector
            // External Links
            externalLinks: '.external', // CSS selector
            // Sortable
            sortable: true,
            // Scroll toolbars
            hideNavbarOnPageScroll: false,
            hideToolbarOnPageScroll: false,
            hideTabbarOnPageScroll: false,
            showBarsOnPageScrollEnd: true,
            showBarsOnPageScrollTop: true,
            // Swipeout
            swipeout: true,
            swipeoutActionsNoFold: false,
            swipeoutNoFollow: false,
            // Smart Select Back link template
            smartSelectOpenIn: 'page', // or 'popup' or 'picker'
            smartSelectBackText: 'Back',
            smartSelectPopupCloseText: 'Close',
            smartSelectPickerCloseText: 'Done',
            smartSelectSearchbar: false,
            smartSelectBackOnSelect: false,
            // Tap Navbar or Statusbar to scroll to top
            scrollTopOnNavbarClick: false,
            scrollTopOnStatusbarClick: false,
            // Panels
            swipePanel: false, // or 'left' or 'right'
            swipePanelActiveArea: 0,
            swipePanelCloseOpposite: true,
            swipePanelOnlyClose: false,
            swipePanelNoFollow: false,
            swipePanelThreshold: 0,
            panelsCloseByOutside: true,
            // Modals
            modalButtonOk: 'OK',
            modalButtonCancel: 'Cancel',
            modalUsernamePlaceholder: 'Username',
            modalPasswordPlaceholder: 'Password',
            modalTitle: 'Framework7',
            modalCloseByOutside: false,
            actionsCloseByOutside: true,
            popupCloseByOutside: true,
            modalPreloaderTitle: 'Loading... ',
            modalStack: true,
            // Lazy Load
            imagesLazyLoadThreshold: 0,
            imagesLazyLoadSequential: true,
            // Name space
            viewClass: 'view',
            viewMainClass: 'view-main',
            viewsClass: 'views',
            // Notifications defaults
            notificationCloseOnClick: false,
            notificationCloseIcon: true,
            notificationCloseButtonText: 'Close',
            // Animate Pages
            animatePages: true,
            // Template7
            templates: {},
            template7Data: {},
            template7Pages: false,
            precompileTemplates: false,
            // Material
            material: false,
            materialPageLoadDelay: 0,
            materialPreloaderSvg: '<svg xmlns="http://www.w3.org/2000/svg" height="75" width="75" viewbox="0 0 75 75"><circle cx="37.5" cy="37.5" r="33.5" stroke-width="8"/></svg>',
            materialPreloaderHtml:
                '<span class="preloader-inner">' +
                    '<span class="preloader-inner-gap"></span>' +
                    '<span class="preloader-inner-left">' +
                        '<span class="preloader-inner-half-circle"></span>' +
                    '</span>' +
                    '<span class="preloader-inner-right">' +
                        '<span class="preloader-inner-half-circle"></span>' +
                    '</span>' +
                '</span>',
            materialRipple: true,
            materialRippleElements: '.ripple, a.link, a.item-link, .button, .modal-button, .tab-link, .label-radio, .label-checkbox, .actions-modal-button, a.searchbar-clear, a.floating-button, .floating-button > a, .speed-dial-buttons a',
            // Auto init
            init: true,
        };
    
        // Extend defaults with parameters
        for (var param in params) {
            app.params[param] = params[param];
        }
    
        // DOM lib
        var $ = Dom7;
    
        // Template7 lib
        var t7 = Template7;
        app._compiledTemplates = {};
    
        // Touch events
        app.touchEvents = {
            start: app.support.touch ? 'touchstart' : 'mousedown',
            move: app.support.touch ? 'touchmove' : 'mousemove',
            end: app.support.touch ? 'touchend' : 'mouseup'
        };
    
        // Link to local storage
        app.ls = window.localStorage;
    
        // RTL
        app.rtl = $('body').css('direction') === 'rtl';
        if (app.rtl) $('html').attr('dir', 'rtl');
    
        // Overwrite statusbar overlay
        if (typeof app.params.statusbarOverlay !== 'undefined') {
            if (app.params.statusbarOverlay) $('html').addClass('with-statusbar-overlay');
            else $('html').removeClass('with-statusbar-overlay');
        }
    
        
    

        /*======================================================
        ************   Views   ************
        ======================================================*/
        app.views = [];
        var View = function (selector, params) {
            var defaults = {
                dynamicNavbar: false,
                domCache: false,
                linksView: undefined,
                reloadPages: false,
                uniqueHistory: app.params.uniqueHistory,
                uniqueHistoryIgnoreGetParameters: app.params.uniqueHistoryIgnoreGetParameters,
                allowDuplicateUrls: app.params.allowDuplicateUrls,
                swipeBackPage: app.params.swipeBackPage,
                swipeBackPageAnimateShadow: app.params.swipeBackPageAnimateShadow,
                swipeBackPageAnimateOpacity: app.params.swipeBackPageAnimateOpacity,
                swipeBackPageActiveArea: app.params.swipeBackPageActiveArea,
                swipeBackPageThreshold: app.params.swipeBackPageThreshold,
                animatePages: app.params.animatePages,
                preloadPreviousPage: app.params.preloadPreviousPage
            };
            var i;
        
            // Params
            params = params || {};
        
            // Disable dynamic navbar for material theme
            if (params.dynamicNavbar && app.params.material) params.dynamicNavbar = false;
        
            // Extend params with defaults
            for (var def in defaults) {
                if (typeof params[def] === 'undefined') {
                    params[def] = defaults[def];
                }
            }
            // View
            var view = this;
            view.params = params;
        
            // Selector
            view.selector = selector;
        
            // Container
            var container = $(selector);
            view.container = container[0];
        
            // Fix Selector
        
            if (typeof selector !== 'string') {
                // Supposed to be HTMLElement or Dom7
                selector = (container.attr('id') ? '#' + container.attr('id') : '') + (container.attr('class') ? '.' + container.attr('class').replace(/ /g, '.').replace('.active', '') : '');
                view.selector = selector;
            }
        
            // Is main
            view.main = container.hasClass(app.params.viewMainClass);
        
            // Content cache
            view.contentCache = {};
        
            // Pages cache
            view.pagesCache = {};
        
            // Store View in element for easy access
            container[0].f7View = view;
        
            // Pages
            view.pagesContainer = container.find('.pages')[0];
            view.initialPages = [];
            view.initialPagesUrl = [];
            view.initialNavbars = [];
            if (view.params.domCache) {
                var initialPages = container.find('.page');
                for (i = 0; i < initialPages.length; i++) {
                    view.initialPages.push(initialPages[i]);
                    view.initialPagesUrl.push('#' + initialPages.eq(i).attr('data-page'));
                }
                if (view.params.dynamicNavbar) {
                    var initialNavbars = container.find('.navbar-inner');
                    for (i = 0; i < initialNavbars.length; i++) {
                        view.initialNavbars.push(initialNavbars[i]);
                    }
                }
        
            }
        
            view.allowPageChange = true;
        
            // Location
            var docLocation = document.location.href;
        
            // History
            view.history = [];
            var viewURL = docLocation;
            var pushStateSeparator = app.params.pushStateSeparator;
            var pushStateRoot = app.params.pushStateRoot;
            if (app.params.pushState && view.main) {
                if (pushStateRoot) {
                    viewURL = pushStateRoot;
                }
                else {
                    if (viewURL.indexOf(pushStateSeparator) >= 0 && viewURL.indexOf(pushStateSeparator + '#') < 0) viewURL = viewURL.split(pushStateSeparator)[0];
                }
        
            }
        
            // Active Page
            var currentPage, currentPageData;
            if (!view.activePage) {
                currentPage = $(view.pagesContainer).find('.page-on-center');
                if (currentPage.length === 0) {
                    currentPage = $(view.pagesContainer).find('.page:not(.cached)');
                    currentPage = currentPage.eq(currentPage.length - 1);
                }
                if (currentPage.length > 0) {
                    currentPageData = currentPage[0].f7PageData;
                }
            }
        
            // View startup URL
            if (view.params.domCache && currentPage) {
                view.url = container.attr('data-url') || view.params.url || '#' + currentPage.attr('data-page');   
                view.pagesCache[view.url] = currentPage.attr('data-page');
            }
            else view.url = container.attr('data-url') || view.params.url || viewURL;
        
            // Update current page Data
            if (currentPageData) {
                currentPageData.view = view;
                currentPageData.url = view.url;
                if (view.params.domCache && view.params.dynamicNavbar && !currentPageData.navbarInnerContainer) {
                    currentPageData.navbarInnerContainer = view.initialNavbars[view.initialPages.indexOf(currentPageData.container)];
                }
                view.activePage = currentPageData;
                currentPage[0].f7PageData = currentPageData;
            }
        
            // Store to history main view's url
            if (view.url) {
                view.history.push(view.url);
            }
        
            // Touch events
            var isTouched = false,
                isMoved = false,
                touchesStart = {},
                isScrolling,
                activePage = [],
                previousPage = [],
                viewContainerWidth,
                touchesDiff,
                allowViewTouchMove = true,
                touchStartTime,
                activeNavbar = [],
                previousNavbar = [],
                activeNavElements,
                previousNavElements,
                activeNavBackIcon,
                previousNavBackIcon,
                dynamicNavbar,
                pageShadow,
                el;
        
            view.handleTouchStart = function (e) {
                if (!allowViewTouchMove || !view.params.swipeBackPage || isTouched || app.swipeoutOpenedEl || !view.allowPageChange) return;
                isMoved = false;
                isTouched = true;
                isScrolling = undefined;
                touchesStart.x = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
                touchesStart.y = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                touchStartTime = (new Date()).getTime();
                dynamicNavbar = view.params.dynamicNavbar && container.find('.navbar-inner').length > 1;
            };
        
            view.handleTouchMove = function (e) {
                if (!isTouched) return;
                var pageX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                var pageY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                if (typeof isScrolling === 'undefined') {
                    isScrolling = !!(isScrolling || Math.abs(pageY - touchesStart.y) > Math.abs(pageX - touchesStart.x));
                }
                if (isScrolling || e.f7PreventSwipeBack || app.preventSwipeBack) {
                    isTouched = false;
                    return;
                }
                if (!isMoved) {
                    var cancel = false;
                    // Calc values during first move fired
                    viewContainerWidth = container.width();
                    var target = $(e.target);
                    var swipeout = target.hasClass('swipeout') ? target : target.parents('.swipeout');
                    if (swipeout.length > 0) {
                        if (!app.rtl && swipeout.find('.swipeout-actions-left').length > 0) cancel = true;
                        if (app.rtl && swipeout.find('.swipeout-actions-right').length > 0) cancel = true;
                    }
                    activePage = target.is('.page') ? target : target.parents('.page');
                    if (activePage.hasClass('no-swipeback')) cancel = true;
                    previousPage = container.find('.page-on-left:not(.cached)');
                    var notFromBorder = touchesStart.x - container.offset().left > view.params.swipeBackPageActiveArea;
                    if (app.rtl) {
                        notFromBorder = touchesStart.x < container.offset().left - container[0].scrollLeft + viewContainerWidth - view.params.swipeBackPageActiveArea;
                    }
                    else {
                        notFromBorder = touchesStart.x - container.offset().left > view.params.swipeBackPageActiveArea;
                    }
                    if (notFromBorder) cancel = true;
                    if (previousPage.length === 0 || activePage.length === 0) cancel = true;
                    if (cancel) {
                        isTouched = false;
                        return;
                    }
        
                    if (view.params.swipeBackPageAnimateShadow && !app.device.android) {
                        pageShadow = activePage.find('.swipeback-page-shadow');
                        if (pageShadow.length === 0) {
                            pageShadow = $('<div class="swipeback-page-shadow"></div>');
                            activePage.append(pageShadow);
                        }
                    }
        
                    if (dynamicNavbar) {
                        activeNavbar = container.find('.navbar-on-center:not(.cached)');
                        previousNavbar = container.find('.navbar-on-left:not(.cached)');
                        activeNavElements = activeNavbar.find('.left, .center, .right, .subnavbar, .fading');
                        previousNavElements = previousNavbar.find('.left, .center, .right, .subnavbar, .fading');
                        if (app.params.animateNavBackIcon) {
                            activeNavBackIcon = activeNavbar.find('.left.sliding .back .icon');
                            previousNavBackIcon = previousNavbar.find('.left.sliding .back .icon');
                        }
                    }
        
                    // Close/Hide Any Picker
                    if ($('.picker-modal.modal-in').length > 0) {
                        app.closeModal($('.picker-modal.modal-in'));
                    }
                }
                e.f7PreventPanelSwipe = true;
                isMoved = true;
                e.preventDefault();
        
                // RTL inverter
                var inverter = app.rtl ? -1 : 1;
        
                // Touches diff
                touchesDiff = (pageX - touchesStart.x - view.params.swipeBackPageThreshold) * inverter;
                if (touchesDiff < 0) touchesDiff = 0;
                var percentage = touchesDiff / viewContainerWidth;
        
                // Swipe Back Callback
                var callbackData = {
                    percentage: percentage,
                    activePage: activePage[0],
                    previousPage: previousPage[0],
                    activeNavbar: activeNavbar[0],
                    previousNavbar: previousNavbar[0]
                };
                if (view.params.onSwipeBackMove) {
                    view.params.onSwipeBackMove(callbackData);
                }
                container.trigger('swipeBackMove', callbackData);
        
                // Transform pages
                var activePageTranslate = touchesDiff * inverter;
                var previousPageTranslate = (touchesDiff / 5 - viewContainerWidth / 5) * inverter;
                if (app.device.pixelRatio === 1) {
                    activePageTranslate = Math.round(activePageTranslate);
                    previousPageTranslate = Math.round(previousPageTranslate);
                }
        
                activePage.transform('translate3d(' + activePageTranslate + 'px,0,0)');
                if (view.params.swipeBackPageAnimateShadow && !app.device.android) pageShadow[0].style.opacity = 1 - 1 * percentage;
        
                previousPage.transform('translate3d(' + previousPageTranslate + 'px,0,0)');
                if (view.params.swipeBackPageAnimateOpacity) previousPage[0].style.opacity = 0.9 + 0.1 * percentage;
        
                // Dynamic Navbars Animation
                if (dynamicNavbar) {
                    var i;
                    for (i = 0; i < activeNavElements.length; i++) {
                        el = $(activeNavElements[i]);
                        if (!el.is('.subnavbar.sliding')) el[0].style.opacity = (1 - percentage * 1.3);
                        if (el[0].className.indexOf('sliding') >= 0) {
                            var activeNavTranslate = percentage * el[0].f7NavbarRightOffset;
                            if (app.device.pixelRatio === 1) activeNavTranslate = Math.round(activeNavTranslate);
                            el.transform('translate3d(' + activeNavTranslate + 'px,0,0)');
                            if (app.params.animateNavBackIcon) {
                                if (el[0].className.indexOf('left') >= 0 && activeNavBackIcon.length > 0) {
                                    activeNavBackIcon.transform('translate3d(' + -activeNavTranslate + 'px,0,0)');
                                }
                            }
                        }
                    }
                    for (i = 0; i < previousNavElements.length; i++) {
                        el = $(previousNavElements[i]);
                        if (!el.is('.subnavbar.sliding')) el[0].style.opacity = percentage * 1.3 - 0.3;
                        if (el[0].className.indexOf('sliding') >= 0) {
                            var previousNavTranslate = el[0].f7NavbarLeftOffset * (1 - percentage);
                            if (app.device.pixelRatio === 1) previousNavTranslate = Math.round(previousNavTranslate);
                            el.transform('translate3d(' + previousNavTranslate + 'px,0,0)');
                            if (app.params.animateNavBackIcon) {
                                if (el[0].className.indexOf('left') >= 0 && previousNavBackIcon.length > 0) {
                                    previousNavBackIcon.transform('translate3d(' + -previousNavTranslate + 'px,0,0)');
                                }
                            }
                        }
                    }
                }
            };
        
            view.handleTouchEnd = function (e) {
                if (!isTouched || !isMoved) {
                    isTouched = false;
                    isMoved = false;
                    return;
                }
                isTouched = false;
                isMoved = false;
                if (touchesDiff === 0) {
                    $([activePage[0], previousPage[0]]).transform('').css({opacity: '', boxShadow: ''});
                    if (dynamicNavbar) {
                        activeNavElements.transform('').css({opacity: ''});
                        previousNavElements.transform('').css({opacity: ''});
                        if (activeNavBackIcon && activeNavBackIcon.length > 0) activeNavBackIcon.transform('');
                        if (previousNavBackIcon && activeNavBackIcon.length > 0) previousNavBackIcon.transform('');
                    }
                    return;
                }
                var timeDiff = (new Date()).getTime() - touchStartTime;
                var pageChanged = false;
                // Swipe back to previous page
                if (
                        timeDiff < 300 && touchesDiff > 10 ||
                        timeDiff >= 300 && touchesDiff > viewContainerWidth / 2
                    ) {
                    activePage.removeClass('page-on-center').addClass('page-on-right');
                    previousPage.removeClass('page-on-left').addClass('page-on-center');
                    if (dynamicNavbar) {
                        activeNavbar.removeClass('navbar-on-center').addClass('navbar-on-right');
                        previousNavbar.removeClass('navbar-on-left').addClass('navbar-on-center');
                    }
                    pageChanged = true;
                }
                // Reset custom styles
                // Add transitioning class for transition-duration
                $([activePage[0], previousPage[0]]).transform('').css({opacity: '', boxShadow: ''}).addClass('page-transitioning');
                if (dynamicNavbar) {
                    activeNavElements.css({opacity: ''})
                    .each(function () {
                        var translate = pageChanged ? this.f7NavbarRightOffset : 0;
                        var sliding = $(this);
                        sliding.transform('translate3d(' + translate + 'px,0,0)');
                        if (app.params.animateNavBackIcon) {
                            if (sliding.hasClass('left') && activeNavBackIcon.length > 0) {
                                activeNavBackIcon.addClass('page-transitioning').transform('translate3d(' + -translate + 'px,0,0)');
                            }
                        }
        
                    }).addClass('page-transitioning');
        
                    previousNavElements.transform('').css({opacity: ''}).each(function () {
                        var translate = pageChanged ? 0 : this.f7NavbarLeftOffset;
                        var sliding = $(this);
                        sliding.transform('translate3d(' + translate + 'px,0,0)');
                        if (app.params.animateNavBackIcon) {
                            if (sliding.hasClass('left') && previousNavBackIcon.length > 0) {
                                previousNavBackIcon.addClass('page-transitioning').transform('translate3d(' + -translate + 'px,0,0)');
                            }
                        }
                    }).addClass('page-transitioning');
                }
                allowViewTouchMove = false;
                view.allowPageChange = false;
                // Swipe Back Callback
                var callbackData = {
                    activePage: activePage[0],
                    previousPage: previousPage[0],
                    activeNavbar: activeNavbar[0],
                    previousNavbar: previousNavbar[0]
                };
                if (pageChanged) {
                    // Update View's URL
                    var url = view.history[view.history.length - 2];
                    view.url = url;
        
                    // Page before animation callback
                    app.pageBackCallback('before', view, {pageContainer: activePage[0], url: url, position: 'center', newPage: previousPage, oldPage: activePage, swipeBack: true});
                    app.pageAnimCallback('before', view, {pageContainer: previousPage[0], url: url, position: 'left', newPage: previousPage, oldPage: activePage, swipeBack: true});
        
                    if (view.params.onSwipeBackBeforeChange) {
                        view.params.onSwipeBackBeforeChange(callbackData);
                    }
                    container.trigger('swipeBackBeforeChange', callbackData);
                }
                else {
                    if (view.params.onSwipeBackBeforeReset) {
                        view.params.onSwipeBackBeforeReset(callbackData);
                    }
                    container.trigger('swipeBackBeforeReset', callbackData);
                }
        
                activePage.transitionEnd(function () {
                    $([activePage[0], previousPage[0]]).removeClass('page-transitioning');
                    if (dynamicNavbar) {
                        activeNavElements.removeClass('page-transitioning').css({opacity: ''});
                        previousNavElements.removeClass('page-transitioning').css({opacity: ''});
                        if (activeNavBackIcon && activeNavBackIcon.length > 0) activeNavBackIcon.removeClass('page-transitioning');
                        if (previousNavBackIcon && previousNavBackIcon.length > 0) previousNavBackIcon.removeClass('page-transitioning');
                    }
                    allowViewTouchMove = true;
                    view.allowPageChange = true;
                    if (pageChanged) {
                        if (app.params.pushState && view.main) history.back();
                        // Page after animation callback
                        app.pageBackCallback('after', view, {pageContainer: activePage[0], url: url, position: 'center', newPage: previousPage, oldPage: activePage, swipeBack: true});
                        app.pageAnimCallback('after', view, {pageContainer: previousPage[0], url: url, position: 'left', newPage: previousPage, oldPage: activePage, swipeBack: true});
                        app.router.afterBack(view, activePage, previousPage);
        
                        if (view.params.onSwipeBackAfterChange) {
                            view.params.onSwipeBackAfterChange(callbackData);
                        }
                        container.trigger('swipeBackAfterChange', callbackData);
                    }
                    else {
                        if (view.params.onSwipeBackAfterReset) {
                            view.params.onSwipeBackAfterReset(callbackData);
                        }
                        container.trigger('swipeBackAfterReset', callbackData);
                    }
                    if (pageShadow && pageShadow.length > 0) pageShadow.remove();
                });
            };
            view.attachEvents = function (detach) {
                var action = detach ? 'off' : 'on';
                container[action](app.touchEvents.start, view.handleTouchStart);
                container[action](app.touchEvents.move, view.handleTouchMove);
                container[action](app.touchEvents.end, view.handleTouchEnd);
            };
            view.detachEvents = function () {
                view.attachEvents(true);
            };
        
            // Init
            if (view.params.swipeBackPage && !app.params.material) {
                view.attachEvents();
            }
        
            // Add view to app
            app.views.push(view);
            if (view.main) app.mainView = view;
        
            // Router 
            view.router = {
                load: function (options) {
                    return app.router.load(view, options);
                },
                back: function (options) {
                    return app.router.back(view, options);  
                },
                // Shortcuts
                loadPage: function (options) {
                    options = options || {};
                    if (typeof options === 'string') {
                        var url = options;
                        options = {};
                        if (url && url.indexOf('#') === 0 && view.params.domCache) {
                            options.pageName = url.split('#')[1];
                        }
                        else options.url = url;
                    }
                    return app.router.load(view, options);
                },
                loadContent: function (content) {
                    return app.router.load(view, {content: content});
                },
                reloadPage: function (url) {
                    return app.router.load(view, {url: url, reload: true});
                },
                reloadContent: function (content) {
                    return app.router.load(view, {content: content, reload: true});
                },
                reloadPreviousPage: function (url) {
                    return app.router.load(view, {url: url, reloadPrevious: true, reload: true});
                },
                reloadPreviousContent: function (content) {
                    return app.router.load(view, {content: content, reloadPrevious: true, reload: true});
                },
                refreshPage: function () {
                    var options = {
                        url: view.url,
                        reload: true,
                        ignoreCache: true
                    };
                    if (options.url && options.url.indexOf('#') === 0) {
                        if (view.params.domCache && view.pagesCache[options.url]) {
                            options.pageName = view.pagesCache[options.url];
                            options.url = undefined;
                            delete options.url;
                        }
                        else if (view.contentCache[options.url]) {
                            options.content = view.contentCache[options.url];
                            options.url = undefined;
                            delete options.url;
                        }
                    }
                    return app.router.load(view, options);
                },
                refreshPreviousPage: function () {
                    var options = {
                        url: view.history[view.history.length - 2],
                        reload: true,
                        reloadPrevious: true,
                        ignoreCache: true
                    };
                    if (options.url && options.url.indexOf('#') === 0 && view.params.domCache && view.pagesCache[options.url]) {
                        options.pageName = view.pagesCache[options.url];
                        options.url = undefined;
                        delete options.url;
                    }
                    return app.router.load(view, options);
                }
            };
        
            // Aliases for temporary backward compatibility
            view.loadPage = view.router.loadPage;
            view.loadContent = view.router.loadContent;
            view.reloadPage = view.router.reloadPage;
            view.reloadContent = view.router.reloadContent;
            view.reloadPreviousPage = view.router.reloadPreviousPage;
            view.reloadPreviousContent = view.router.reloadPreviousContent;
            view.refreshPage = view.router.refreshPage;
            view.refreshPreviousPage = view.router.refreshPreviousPage;
            view.back = view.router.back;
        
            // Bars methods
            view.hideNavbar = function () {
                return app.hideNavbar(container.find('.navbar'));
            };
            view.showNavbar = function () {
                return app.showNavbar(container.find('.navbar'));
            };
            view.hideToolbar = function () {
                return app.hideToolbar(container.find('.toolbar'));
            };
            view.showToolbar = function () {
                return app.showToolbar(container.find('.toolbar'));
            };
        
            // Push State on load
            if (app.params.pushState && app.params.pushStateOnLoad && view.main) {
                var pushStateUrl;
                var pushStateUrlSplit = docLocation.split(pushStateSeparator)[1];
                if (pushStateRoot) {
                    pushStateUrl = docLocation.split(app.params.pushStateRoot + pushStateSeparator)[1];
                }
                else if (pushStateSeparator && docLocation.indexOf(pushStateSeparator) >= 0 && docLocation.indexOf(pushStateSeparator + '#') < 0) {
                    pushStateUrl = pushStateUrlSplit;
                }
                var pushStateAnimatePages = app.params.pushStateNoAnimation ? false : undefined;
                var historyState = history.state;
                if (pushStateUrl) {
                    if (pushStateUrl.indexOf('#') >= 0 && view.params.domCache && historyState && historyState.pageName && 'viewIndex' in historyState) {
                        app.router.load(view, {pageName: historyState.pageName, url: historyState.url, animatePages: pushStateAnimatePages, pushState: false});
                    }
                    else if (pushStateUrl.indexOf('#') >= 0 && view.params.domCache && view.initialPagesUrl.indexOf(pushStateUrl) >= 0) {
                        app.router.load(view, {pageName: pushStateUrl.replace('#',''), animatePages: pushStateAnimatePages, pushState: false});
                    }
                    else app.router.load(view, {url: pushStateUrl, animatePages: pushStateAnimatePages, pushState: false});
                }
                else if (view.params.domCache && docLocation.indexOf(pushStateSeparator + '#') >= 0) {
                    if (historyState && historyState.pageName && 'viewIndex' in historyState) {
                        app.router.load(view, {pageName: historyState.pageName, url: historyState.url, animatePages: pushStateAnimatePages, pushState: false});
                    }
                    else if (pushStateSeparator && pushStateUrlSplit.indexOf('#') === 0) {
                        if (view.initialPagesUrl.indexOf(pushStateUrlSplit)) {
                            app.router.load(view, {pageName: pushStateUrlSplit.replace('#', ''), animatePages: pushStateAnimatePages, pushState: false});
                        }
                    }
                }
            }
        
            // Destroy
            view.destroy = function () {
                view.detachEvents();
                view = undefined;
            };
        
            // Plugin hook
            app.pluginHook('addView', view);
        
            // Return view
            return view;
        };
        
        app.addView = function (selector, params) {
            return new View(selector, params);
        };
        
        app.getCurrentView = function (index) {
            var popoverView = $('.popover.modal-in .view');
            var popupView = $('.popup.modal-in .view');
            var panelView = $('.panel.active .view');
            var appViews = $('.views');
            // Find active view as tab
            var appView = appViews.children('.view');
            // Propably in tabs or split view
            if (appView.length > 1) {
                if (appView.hasClass('tab')) {
                    // Tabs
                    appView = appViews.children('.view.active');
                }
                else {
                    // Split View, leave appView intact
                }
            }
            if (popoverView.length > 0 && popoverView[0].f7View) return popoverView[0].f7View;
            if (popupView.length > 0 && popupView[0].f7View) return popupView[0].f7View;
            if (panelView.length > 0 && panelView[0].f7View) return panelView[0].f7View;
            if (appView.length > 0) {
                if (appView.length === 1 && appView[0].f7View) return appView[0].f7View;
                if (appView.length > 1) {
                    var currentViews = [];
                    for (var i = 0; i < appView.length; i++) {
                        if (appView[i].f7View) currentViews.push(appView[i].f7View);
                    }
                    if (currentViews.length > 0 && typeof index !== 'undefined') return currentViews[index];
                    if (currentViews.length > 1) return currentViews;
                    if (currentViews.length === 1) return currentViews[0];
                    return undefined;
                }
            }
            return undefined;
        };
        

        /*======================================================
        ************   Navbars && Toolbars   ************
        ======================================================*/
        // On Navbar Init Callback
        app.navbarInitCallback = function (view, pageContainer, navbarContainer, navbarInnerContainer) {
            if (!navbarContainer && navbarInnerContainer) navbarContainer = $(navbarInnerContainer).parent('.navbar')[0];
            if (navbarInnerContainer.f7NavbarInitialized && view && !view.params.domCache) return;
            var navbarData = {
                container: navbarContainer,
                innerContainer: navbarInnerContainer
            };
            var pageData = pageContainer && pageContainer.f7PageData;
        
            var eventData = {
                page: pageData,
                navbar: navbarData
            };
        
            if (navbarInnerContainer.f7NavbarInitialized && ((view && view.params.domCache) || (!view && $(navbarContainer).parents('.popup, .popover, .login-screen, .modal, .actions-modal, .picker-modal').length > 0))) {
                // Reinit Navbar
                app.reinitNavbar(navbarContainer, navbarInnerContainer);
        
                // Plugin hook
                app.pluginHook('navbarReinit', eventData);
        
                // Event
                $(navbarInnerContainer).trigger('navbarReinit', eventData);
                return;
            }
            navbarInnerContainer.f7NavbarInitialized = true;
            // Before Init
            app.pluginHook('navbarBeforeInit', navbarData, pageData);
            $(navbarInnerContainer).trigger('navbarBeforeInit', eventData);
        
            // Initialize Navbar
            app.initNavbar(navbarContainer, navbarInnerContainer);
        
            // On init
            app.pluginHook('navbarInit', navbarData, pageData);
            $(navbarInnerContainer).trigger('navbarInit', eventData);
        };
        // Navbar Remove Callback
        app.navbarRemoveCallback = function (view, pageContainer, navbarContainer, navbarInnerContainer) {
            if (!navbarContainer && navbarInnerContainer) navbarContainer = $(navbarInnerContainer).parent('.navbar')[0];
            var navbarData = {
                container: navbarContainer,
                innerContainer: navbarInnerContainer
            };
            var pageData = pageContainer.f7PageData;
        
            var eventData = {
                page: pageData,
                navbar: navbarData
            };
            app.pluginHook('navbarBeforeRemove', navbarData, pageData);
            $(navbarInnerContainer).trigger('navbarBeforeRemove', eventData);
        };
        app.initNavbar = function (navbarContainer, navbarInnerContainer) {
            // Init Subnavbar Searchbar
            if (app.initSearchbar) app.initSearchbar(navbarInnerContainer);
        };
        app.reinitNavbar = function (navbarContainer, navbarInnerContainer) {
            // Re init navbar methods
        };
        app.initNavbarWithCallback = function (navbarContainer) {
            navbarContainer = $(navbarContainer);
            var viewContainer = navbarContainer.parents('.' + app.params.viewClass);
            var view;
            if (viewContainer.length === 0) return;
            if (navbarContainer.parents('.navbar-through').length === 0 && viewContainer.find('.navbar-through').length === 0) return;
            view = viewContainer[0].f7View || undefined;
        
            navbarContainer.find('.navbar-inner').each(function () {
                var navbarInnerContainer = this;
                var pageContainer;
                if ($(navbarInnerContainer).attr('data-page')) {
                    // For dom cache
                    pageContainer = viewContainer.find('.page[data-page="' + $(navbarInnerContainer).attr('data-page') + '"]')[0];
                }
                if (!pageContainer) {
                    var pages = viewContainer.find('.page');
                    if (pages.length === 1) {
                        pageContainer = pages[0];
                    }
                    else {
                        viewContainer.find('.page').each(function () {
                            if (this.f7PageData && this.f7PageData.navbarInnerContainer === navbarInnerContainer) {
                                pageContainer = this;
                            }
                        });
                    }
                }
                app.navbarInitCallback(view, pageContainer, navbarContainer[0], navbarInnerContainer);
            });
        };
        
        // Size Navbars
        app.sizeNavbars = function (viewContainer) {
            if (app.params.material) return;
            var navbarInner = viewContainer ? $(viewContainer).find('.navbar .navbar-inner:not(.cached)') : $('.navbar .navbar-inner:not(.cached)');
            navbarInner.each(function () {
                var n = $(this);
                if (n.hasClass('cached')) return;
                var left = app.rtl ? n.find('.right') : n.find('.left'),
                    right = app.rtl ? n.find('.left') : n.find('.right'),
                    center = n.find('.center'),
                    subnavbar = n.find('.subnavbar'),
                    noLeft = left.length === 0,
                    noRight = right.length === 0,
                    leftWidth = noLeft ? 0 : left.outerWidth(true),
                    rightWidth = noRight ? 0 : right.outerWidth(true),
                    centerWidth = center.outerWidth(true),
                    navbarStyles = n.styles(),
                    navbarWidth = n[0].offsetWidth - parseInt(navbarStyles.paddingLeft, 10) - parseInt(navbarStyles.paddingRight, 10),
                    onLeft = n.hasClass('navbar-on-left'),
                    currLeft, diff;
        
                if (noRight) {
                    currLeft = navbarWidth - centerWidth;
                }
                if (noLeft) {
                    currLeft = 0;
                }
                if (!noLeft && !noRight) {
                    currLeft = (navbarWidth - rightWidth - centerWidth + leftWidth) / 2;
                }
                var requiredLeft = (navbarWidth - centerWidth) / 2;
                if (navbarWidth - leftWidth - rightWidth > centerWidth) {
                    if (requiredLeft < leftWidth) {
                        requiredLeft = leftWidth;
                    }
                    if (requiredLeft + centerWidth > navbarWidth - rightWidth) {
                        requiredLeft = navbarWidth - rightWidth - centerWidth;
                    }
                    diff = requiredLeft - currLeft;
                }
                else {
                    diff = 0;
                }
                // RTL inverter
                var inverter = app.rtl ? -1 : 1;
        
                if (center.hasClass('sliding')) {
                    center[0].f7NavbarLeftOffset = -(currLeft + diff) * inverter;
                    center[0].f7NavbarRightOffset = (navbarWidth - currLeft - diff - centerWidth) * inverter;
                    if (onLeft) {
                        if (app.params.animateNavBackIcon) {
                            var activeNavbarBackLink = n.parent().find('.navbar-on-center').find('.left.sliding .back .icon ~ span');
                            if (activeNavbarBackLink.length > 0) {
                                center[0].f7NavbarLeftOffset += activeNavbarBackLink[0].offsetLeft;
                            }
                        }
                        center.transform('translate3d(' + center[0].f7NavbarLeftOffset + 'px, 0, 0)');
                    }
                }
                if (!noLeft && left.hasClass('sliding')) {
                    if (app.rtl) {
                        left[0].f7NavbarLeftOffset = -(navbarWidth - left[0].offsetWidth) / 2 * inverter;
                        left[0].f7NavbarRightOffset = leftWidth * inverter;
                    }
                    else {
                        left[0].f7NavbarLeftOffset = -leftWidth;
                        left[0].f7NavbarRightOffset = (navbarWidth - left[0].offsetWidth) / 2;
                        if (app.params.animateNavBackIcon && left.find('.back .icon').length > 0) {
                            left[0].f7NavbarRightOffset -= left.find('.back .icon')[0].offsetWidth;
                        }
                    }
                    if (onLeft) left.transform('translate3d(' + left[0].f7NavbarLeftOffset + 'px, 0, 0)');
                }
                if (!noRight && right.hasClass('sliding')) {
                    if (app.rtl) {
                        right[0].f7NavbarLeftOffset = -rightWidth * inverter;
                        right[0].f7NavbarRightOffset = (navbarWidth - right[0].offsetWidth) / 2 * inverter;
                    }
                    else {
                        right[0].f7NavbarLeftOffset = -(navbarWidth - right[0].offsetWidth) / 2;
                        right[0].f7NavbarRightOffset = rightWidth;
                    }
                    if (onLeft) right.transform('translate3d(' + right[0].f7NavbarLeftOffset + 'px, 0, 0)');
                }
                if (subnavbar.length && subnavbar.hasClass('sliding')) {
                    subnavbar[0].f7NavbarLeftOffset = app.rtl ? subnavbar[0].offsetWidth : -subnavbar[0].offsetWidth;
                    subnavbar[0].f7NavbarRightOffset = -subnavbar[0].f7NavbarLeftOffset;
                }
        
                // Center left
                var centerLeft = diff;
                if (app.rtl && noLeft && noRight && center.length > 0) centerLeft = -centerLeft;
                center.css({left: centerLeft + 'px'});
                
            });
        };
        
        // Hide/Show Navbars/Toolbars
        app.hideNavbar = function (navbarContainer) {
            $(navbarContainer).addClass('navbar-hidden');
            return true;
        };
        app.showNavbar = function (navbarContainer) {
            var navbar = $(navbarContainer);
            navbar.addClass('navbar-hiding').removeClass('navbar-hidden').transitionEnd(function () {
                navbar.removeClass('navbar-hiding');
            });
            return true;
        };
        app.hideToolbar = function (toolbarContainer) {
            $(toolbarContainer).addClass('toolbar-hidden');
            return true;
        };
        app.showToolbar = function (toolbarContainer) {
            var toolbar = $(toolbarContainer);
            toolbar.addClass('toolbar-hiding').removeClass('toolbar-hidden').transitionEnd(function () {
                toolbar.removeClass('toolbar-hiding');
            });
        };
        

        /*======================================================
        ************   Searchbar   ************
        ======================================================*/
        var Searchbar = function (container, params) {
            var defaults = {
                input: null,
                clearButton: null,
                cancelButton: null,
                searchList: null,
                searchIn: '.item-title',
                searchBy: '',
                found: null,
                notFound: null,
                overlay: null,
                ignore: '.searchbar-ignore',
                customSearch: false,
                removeDiacritics: false,
                hideDividers: true,
                hideGroups: true,
                /* Callbacks
                onSearch
                onEnable
                onDisable
                onClear
                */
        
            };
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined' || params[def] === null) {
                    params[def] = defaults[def];
                }
            }
            
            // Instance
            var s = this;
        
            // Material
            s.material = app.params.material;
        
            // Params
            s.params = params;
        
            // Container
            container = $(container);
            s.container = container;
        
            // Active
            s.active = false;
        
            // Input
            s.input = s.params.input ? $(s.params.input) : s.container.find('input[type="search"]');
            s.clearButton = s.params.clearButton ? $(s.params.clearButton) : s.container.find('.searchbar-clear');
            s.cancelButton = s.params.cancelButton ? $(s.params.cancelButton) : s.container.find('.searchbar-cancel');
        
            // Search List
            s.searchList = $(s.params.searchList);
        
            // Is Virtual List
            s.isVirtualList = s.searchList.hasClass('virtual-list');
        
            // Is In Page
            s.pageContainer = s.container.parents('.page').eq(0);
        
            // Overlay
            if (!s.params.overlay) {
                s.overlay = s.pageContainer.length > 0 ? s.pageContainer.find('.searchbar-overlay') : $('.searchbar-overlay');
            }
            else {
                s.overlay = $(s.params.overlay);
            }
            // Found and not found
            if (!s.params.found) {
                s.found = s.pageContainer.length > 0 ? s.pageContainer.find('.searchbar-found') : $('.searchbar-found');
            }
            else {
                s.found = $(s.params.found);
            }
            if (!s.params.notFound) {
                s.notFound = s.pageContainer.length > 0 ? s.pageContainer.find('.searchbar-not-found') : $('.searchbar-not-found');
            }
            else {
                s.notFound = $(s.params.notFound);
            }
        
            
        
            // Diacritics
            var defaultDiacriticsRemovalap = [
                {base:'A', letters:'\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F'},
                {base:'AA',letters:'\uA732'},
                {base:'AE',letters:'\u00C6\u01FC\u01E2'},
                {base:'AO',letters:'\uA734'},
                {base:'AU',letters:'\uA736'},
                {base:'AV',letters:'\uA738\uA73A'},
                {base:'AY',letters:'\uA73C'},
                {base:'B', letters:'\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181'},
                {base:'C', letters:'\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E'},
                {base:'D', letters:'\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779'},
                {base:'DZ',letters:'\u01F1\u01C4'},
                {base:'Dz',letters:'\u01F2\u01C5'},
                {base:'E', letters:'\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E'},
                {base:'F', letters:'\u0046\u24BB\uFF26\u1E1E\u0191\uA77B'},
                {base:'G', letters:'\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E'},
                {base:'H', letters:'\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D'},
                {base:'I', letters:'\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197'},
                {base:'J', letters:'\u004A\u24BF\uFF2A\u0134\u0248'},
                {base:'K', letters:'\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2'},
                {base:'L', letters:'\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780'},
                {base:'LJ',letters:'\u01C7'},
                {base:'Lj',letters:'\u01C8'},
                {base:'M', letters:'\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C'},
                {base:'N', letters:'\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4'},
                {base:'NJ',letters:'\u01CA'},
                {base:'Nj',letters:'\u01CB'},
                {base:'O', letters:'\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C'},
                {base:'OI',letters:'\u01A2'},
                {base:'OO',letters:'\uA74E'},
                {base:'OU',letters:'\u0222'},
                {base:'OE',letters:'\u008C\u0152'},
                {base:'oe',letters:'\u009C\u0153'},
                {base:'P', letters:'\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754'},
                {base:'Q', letters:'\u0051\u24C6\uFF31\uA756\uA758\u024A'},
                {base:'R', letters:'\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782'},
                {base:'S', letters:'\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784'},
                {base:'T', letters:'\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786'},
                {base:'TZ',letters:'\uA728'},
                {base:'U', letters:'\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244'},
                {base:'V', letters:'\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245'},
                {base:'VY',letters:'\uA760'},
                {base:'W', letters:'\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72'},
                {base:'X', letters:'\u0058\u24CD\uFF38\u1E8A\u1E8C'},
                {base:'Y', letters:'\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE'},
                {base:'Z', letters:'\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762'},
                {base:'a', letters:'\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250'},
                {base:'aa',letters:'\uA733'},
                {base:'ae',letters:'\u00E6\u01FD\u01E3'},
                {base:'ao',letters:'\uA735'},
                {base:'au',letters:'\uA737'},
                {base:'av',letters:'\uA739\uA73B'},
                {base:'ay',letters:'\uA73D'},
                {base:'b', letters:'\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253'},
                {base:'c', letters:'\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184'},
                {base:'d', letters:'\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A'},
                {base:'dz',letters:'\u01F3\u01C6'},
                {base:'e', letters:'\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD'},
                {base:'f', letters:'\u0066\u24D5\uFF46\u1E1F\u0192\uA77C'},
                {base:'g', letters:'\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F'},
                {base:'h', letters:'\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265'},
                {base:'hv',letters:'\u0195'},
                {base:'i', letters:'\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131'},
                {base:'j', letters:'\u006A\u24D9\uFF4A\u0135\u01F0\u0249'},
                {base:'k', letters:'\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3'},
                {base:'l', letters:'\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747'},
                {base:'lj',letters:'\u01C9'},
                {base:'m', letters:'\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F'},
                {base:'n', letters:'\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5'},
                {base:'nj',letters:'\u01CC'},
                {base:'o', letters:'\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275'},
                {base:'oi',letters:'\u01A3'},
                {base:'ou',letters:'\u0223'},
                {base:'oo',letters:'\uA74F'},
                {base:'p',letters:'\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755'},
                {base:'q',letters:'\u0071\u24E0\uFF51\u024B\uA757\uA759'},
                {base:'r',letters:'\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783'},
                {base:'s',letters:'\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B'},
                {base:'t',letters:'\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787'},
                {base:'tz',letters:'\uA729'},
                {base:'u',letters: '\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289'},
                {base:'v',letters:'\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C'},
                {base:'vy',letters:'\uA761'},
                {base:'w',letters:'\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73'},
                {base:'x',letters:'\u0078\u24E7\uFF58\u1E8B\u1E8D'},
                {base:'y',letters:'\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF'},
                {base:'z',letters:'\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763'}
            ];
        
            var diacriticsMap = {};
            for (var i=0; i < defaultDiacriticsRemovalap.length; i++){
                var letters = defaultDiacriticsRemovalap[i].letters;
                for (var j=0; j < letters.length ; j++){
                    diacriticsMap[letters[j]] = defaultDiacriticsRemovalap[i].base;
                }
            }
        
            function removeDiacritics (str) {
                return str.replace(/[^\u0000-\u007E]/g, function(a){ 
                   return diacriticsMap[a] || a; 
                });
            }
        
            // Set Cancel button
            var cancelMarginProp = app.rtl ? 'margin-left' : 'margin-right';
            var cancelButtonHasMargin = false;
            s.setCancelButtonMargin = function () {
                s.cancelButton.transition(0).show();
                s.cancelButton.css(cancelMarginProp, -s.cancelButton[0].offsetWidth + 'px');
                var clientLeft = s.cancelButton[0].clientLeft;
                s.cancelButton.transition('');
                cancelButtonHasMargin = true;
            };
        
            // Trigger
            s.triggerEvent = function (eventName, callbackName, eventData) {
                s.container.trigger(eventName, eventData);
                if (s.searchList.length > 0) s.searchList.trigger(eventName, eventData);
                if (callbackName && s.params[callbackName]) s.params[callbackName](s, eventData);
            };
        
            // Enable/disalbe
            s.enable = function (e) {
                function _enable() {
                    if ((s.searchList.length || s.params.customSearch) && !s.container.hasClass('searchbar-active') && !s.query) s.overlay.addClass('searchbar-overlay-active');
                    s.container.addClass('searchbar-active');
                    if (s.cancelButton.length > 0 && !s.material) {
                        if (!cancelButtonHasMargin) {
                            s.setCancelButtonMargin();
                        }
                        s.cancelButton.css(cancelMarginProp, '0px');
                    }
                    s.triggerEvent('enableSearch', 'onEnable');
                    s.active = true;
                }
                if (app.device.ios && !app.params.material && e && e.type === 'focus') {
                    setTimeout(function () {
                        _enable();
                    }, 400);
                }
                else {
                    _enable();
                }
            };
        
            s.disable = function () {
                s.input.val('').trigger('change');
                s.container.removeClass('searchbar-active searchbar-not-empty');
                if (s.cancelButton.length > 0 && !s.material) s.cancelButton.css(cancelMarginProp, -s.cancelButton[0].offsetWidth + 'px');
        
                if (s.searchList.length || s.params.customSearch) s.overlay.removeClass('searchbar-overlay-active');
        
                s.active = false;
                function _disable() {
                    s.input.blur();
                }
                if (app.device.ios) {
                    setTimeout(function () {
                        _disable();
                    }, 400);
                }
                else {
                    _disable();
                }
                s.triggerEvent('disableSearch', 'onDisable');
            };
        
            // Clear
            s.clear = function (e) {
                if (!s.query && e && $(e.target).hasClass('searchbar-clear')) {
                    s.disable();
                    return;
                }
                s.input.val('').trigger('change').focus();
                s.triggerEvent('clearSearch', 'onClear');
            };
        
            // Search
            s.handleInput = function () {
                setTimeout(function () {
                    var value = s.input.val().trim();
                    if ((s.searchList.length > 0 || s.params.customSearch) && (s.params.searchIn || s.isVirtualList)) s.search(value, true);
                }, 0);
            };
        
            var previousQuery = '';
            var virtualList;
            s.search = function (query, internal) {
                if (query.trim() === previousQuery) return;
                previousQuery = query.trim();
        
                if (!internal) {
                    if (!s.active) {
                        s.enable();
                    }
                    s.input.val(query);
                }
                s.query = s.value = query;
                // Add active/inactive classes on overlay
                if (query.length === 0) {
                    s.container.removeClass('searchbar-not-empty');
                    if (s.searchList.length && s.container.hasClass('searchbar-active')) s.overlay.addClass('searchbar-overlay-active');
                }
                else {
                    s.container.addClass('searchbar-not-empty');
                    if (s.searchList.length && s.container.hasClass('searchbar-active')) s.overlay.removeClass('searchbar-overlay-active');
                }
        
                if (s.params.customSearch) {
                    s.triggerEvent('search', 'onSearch', {query: query});
                    return;
                }
                
                var foundItems = [];
                if (s.isVirtualList) {
                    virtualList = s.searchList[0].f7VirtualList;
                    if (query.trim() === '') {
                        virtualList.resetFilter();
                        s.notFound.hide();
                        s.found.show();
                        return;
                    }
                    if (virtualList.params.searchAll) {
                        foundItems = virtualList.params.searchAll(query, virtualList.items) || [];
                    }
                    else if (virtualList.params.searchByItem) {
                        for (var i = 0; i < virtualList.items.length; i++) {
                            if(virtualList.params.searchByItem(query, i, virtualList.params.items[i])) {
                                foundItems.push(i);
                            }
                        }
                    }
                }
                else {
                    var values;
                    if (s.params.removeDiacritics) values = removeDiacritics(query.trim().toLowerCase()).split(' ');
                    else {
                        values = query.trim().toLowerCase().split(' ');
                    }
                    s.searchList.find('li').removeClass('hidden-by-searchbar').each(function (index, el) {
                        el = $(el);
                        var compareWithText = [];
                        el.find(s.params.searchIn).each(function () {
                            var itemText = $(this).text().trim().toLowerCase();
                            if (s.params.removeDiacritics) itemText = removeDiacritics(itemText);
                            compareWithText.push(itemText);
                        });
                        compareWithText = compareWithText.join(' ');
                        var wordsMatch = 0;
                        for (var i = 0; i < values.length; i++) {
                            if (compareWithText.indexOf(values[i]) >= 0) wordsMatch++;
                        }
                        if (wordsMatch !== values.length && !(s.params.ignore && el.is(s.params.ignore))) {
                            el.addClass('hidden-by-searchbar');
                        }
                        else {
                            foundItems.push(el[0]);
                        }
                    });
        
                    if (s.params.hideDividers) {
                        s.searchList.find('.item-divider, .list-group-title').each(function () {
                            var title = $(this);
                            var nextElements = title.nextAll('li');
                            var hide = true;
                            for (var i = 0; i < nextElements.length; i++) {
                                var nextEl = $(nextElements[i]);
                                if (nextEl.hasClass('list-group-title') || nextEl.hasClass('item-divider')) break;
                                if (!nextEl.hasClass('hidden-by-searchbar')) {
                                    hide = false;
                                }
                            }
                            var ignore = s.params.ignore && title.is(s.params.ignore);
                            if (hide && !ignore) title.addClass('hidden-by-searchbar');
                            else title.removeClass('hidden-by-searchbar');
                        });
                    }
                    if (s.params.hideGroups) {
                        s.searchList.find('.list-group').each(function () {
                            var group = $(this);
                            var ignore = s.params.ignore && group.is(s.params.ignore);
                            var notHidden = group.find('li:not(.hidden-by-searchbar)');
                            if (notHidden.length === 0 && !ignore) {
                                group.addClass('hidden-by-searchbar');
                            }
                            else {
                                group.removeClass('hidden-by-searchbar');
                            }
                        });
                    }
                }
                s.triggerEvent('search', 'onSearch', {query: query, foundItems: foundItems});
                if (foundItems.length === 0) {
                    s.notFound.show();
                    s.found.hide();
                }
                else {
                    s.notFound.hide();
                    s.found.show();
                }
                if (s.isVirtualList) {
                    virtualList.filterItems(foundItems);
                }
            };
        
            // Events
            function preventSubmit(e) {
                e.preventDefault();
            }
        
            s.attachEvents = function (destroy) {
                var method = destroy ? 'off' : 'on';
                s.container[method]('submit', preventSubmit);
                if (!s.material) s.cancelButton[method]('click', s.disable);
                s.overlay[method]('click', s.disable);
                s.input[method]('focus', s.enable);
                s.input[method]('change keydown keypress keyup', s.handleInput);
                s.clearButton[method]('click', s.clear);
                    
            };
            s.detachEvents = function() {
                s.attachEvents(true);
            };
        
            // Init Destroy
            s.init = function () {
                s.attachEvents();
            };
            s.destroy = function () {
                if (!s) return;
                s.detachEvents();
                s = null;
            };
        
            // Init
            s.init();
        
            s.container[0].f7Searchbar = s;
            return s;
        
        };
        app.searchbar = function (container, params) {
            return new Searchbar(container, params);
        };
        app.initSearchbar = function (container) {
            container = $(container);
            var searchbar = container.hasClass('searchbar') ? container : container.find('.searchbar');
            if (searchbar.length === 0) return;
            if (!searchbar.hasClass('searchbar-init')) return;
        
            var sb = app.searchbar(searchbar, searchbar.dataset());
        
            function onBeforeRemove() {
                if (sb) sb.destroy();
            }
            if (container.hasClass('page')) {
                container.once('pageBeforeRemove', onBeforeRemove);   
            }
            else if (container.hasClass('navbar-inner')) {
                container.once('navbarBeforeRemove', onBeforeRemove);
            }
        };

        /*======================================================
        ************   Messagebar   ************
        ======================================================*/
        var Messagebar = function (container, params) {
            var defaults = {
                textarea: null,
                maxHeight: null,
            };
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined' || params[def] === null) {
                    params[def] = defaults[def];
                }
            }
            
            // Instance
            var m = this;
        
            // Params
            m.params = params;
        
            // Container
            m.container = $(container);
            if (m.container.length === 0) return;
        
            // Textarea
            m.textarea = m.params.textarea ? $(m.params.textarea) : m.container.find('textarea');
        
            // Is In Page
            m.pageContainer = m.container.parents('.page').eq(0);
            m.pageContent = m.pageContainer.find('.page-content');
        
            // Initial Sizes
            m.pageContentPadding = parseInt(m.pageContent.css('padding-bottom'));
            m.initialBarHeight = m.container[0].offsetHeight;
            m.initialAreaHeight = m.textarea[0].offsetHeight;
            
        
            // Resize textarea
            m.sizeTextarea = function () {
                // Reset
                m.textarea.css({'height': ''});
                
                var height = m.textarea[0].offsetHeight;
                var diff = height - m.textarea[0].clientHeight;
                var scrollHeight = m.textarea[0].scrollHeight;
        
                // Update
                if (scrollHeight + diff > height) {
                    var newAreaHeight = scrollHeight + diff;
                    var newBarHeight = m.initialBarHeight + (newAreaHeight - m.initialAreaHeight);
                    var maxBarHeight = m.params.maxHeight || m.container.parents('.view')[0].offsetHeight - 88;
                    if (newBarHeight > maxBarHeight) {
                        newBarHeight = parseInt(maxBarHeight, 10);
                        newAreaHeight = newBarHeight - m.initialBarHeight + m.initialAreaHeight;
                    }
                    m.textarea.css('height', newAreaHeight + 'px');
                    m.container.css('height', newBarHeight + 'px');
                    var onBottom = (m.pageContent[0].scrollTop === m.pageContent[0].scrollHeight - m.pageContent[0].offsetHeight);
                    if (m.pageContent.length > 0) {
                        m.pageContent.css('padding-bottom', newBarHeight + 'px');
                        if (m.pageContent.find('.messages-new-first').length === 0 && onBottom) {
                            m.pageContent.scrollTop(m.pageContent[0].scrollHeight - m.pageContent[0].offsetHeight);
                        }
                    }
                }
                else {
                    if (m.pageContent.length > 0) {
                        m.container.css({'height': '', 'bottom': ''});
                        m.pageContent.css({'padding-bottom': ''});
                    }
                }
            };
            
            // Clear
            m.clear = function () {
                m.textarea.val('').trigger('change');
            };
            m.value = function (value) {
                if (typeof value === 'undefined') return m.textarea.val();
                else m.textarea.val(value).trigger('change');  
            };
            
            // Handle textarea
            m.textareaTimeout = undefined;
            m.handleTextarea = function (e) {
                clearTimeout(m.textareaTimeout);
                m.textareaTimeout = setTimeout(function () {
                    m.sizeTextarea();
                }, 0);
            };
        
            //Events
            function preventSubmit(e) {
                e.preventDefault();
            }
        
            m.attachEvents = function (destroy) {
                var method = destroy ? 'off' : 'on';
                m.container[method]('submit', preventSubmit);
                m.textarea[method]('change keydown keypress keyup paste cut', m.handleTextarea);
            };
            m.detachEvents = function () {
                m.attachEvents(true);
            };
            
            // Init Destroy
            m.init = function () {
                m.attachEvents();
            };
            m.destroy = function () {
                m.detachEvents();
                m = null;
            };
        
            // Init
            m.init();
        
            m.container[0].f7Messagebar = m;
            return m;
        };
        app.messagebar = function (container, params) {
            return new Messagebar(container, params);
        };
        app.initPageMessagebar = function (pageContainer) {
            pageContainer = $(pageContainer);
            var messagebar = pageContainer.hasClass('messagebar') ? pageContainer : pageContainer.find('.messagebar');
            if (messagebar.length === 0) return;
            if (!messagebar.hasClass('messagebar-init')) return;
            var mb = app.messagebar(messagebar, messagebar.dataset());
        
            // Destroy on page remove
            function pageBeforeRemove() {
                mb.destroy();
                pageContainer.off('pageBeforeRemove', pageBeforeRemove);
            }
            if (pageContainer.hasClass('page')) {
                pageContainer.on('pageBeforeRemove', pageBeforeRemove);
            }
        };

        /*======================================================
        ************   XHR   ************
        ======================================================*/
        // XHR Caching
        app.cache = [];
        app.removeFromCache = function (url) {
            var index = false;
            for (var i = 0; i < app.cache.length; i++) {
                if (app.cache[i].url === url) index = i;
            }
            if (index !== false) app.cache.splice(index, 1);
        };
        
        // XHR
        app.xhr = false;
        app.get = function (url, view, ignoreCache, callback) {
            // should we ignore get params or not
            var _url = url;
            if (app.params.cacheIgnoreGetParameters && url.indexOf('?') >= 0) {
                _url = url.split('?')[0];
            }
            if (app.params.cache && !ignoreCache && url.indexOf('nocache') < 0 && app.params.cacheIgnore.indexOf(_url) < 0) {
                // Check is the url cached
                for (var i = 0; i < app.cache.length; i++) {
                    if (app.cache[i].url === _url) {
                        // Check expiration
                        if ((new Date()).getTime() - app.cache[i].time < app.params.cacheDuration) {
                            // Load from cache
                            callback(app.cache[i].content);
                            return false;
                        }
                    }
                }
            }
        
            app.xhr = $.ajax({
                url: url,
                method: 'GET',
                beforeSend: app.params.onAjaxStart,
                complete: function (xhr) {
                    if ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 0) {
                        if (app.params.cache) {
                            app.removeFromCache(_url);
                            app.cache.push({
                                url: _url,
                                time: (new Date()).getTime(),
                                content: xhr.responseText
                            });
                        }
                        callback(xhr.responseText, false);
                    }
                    else {
                        callback(xhr.responseText, true);
                    }
                    if (app.params.onAjaxComplete) app.params.onAjaxComplete(xhr);
                },
                error: function (xhr) {
                    callback(xhr.responseText, true);
                    if (app.params.onAjaxError) app.params.onAjaxError(xhr);
                }
            });
            if (view) view.xhr = app.xhr;
        
            return app.xhr;
        };
        

        /*======================================================
        ************   Pages   ************
        ======================================================*/
        // Page Callbacks API
        app.pageCallbacks = {};
        
        app.onPage = function (callbackName, pageName, callback) {
            if (pageName && pageName.split(' ').length > 1) {
                var pageNames = pageName.split(' ');
                var returnCallbacks = [];
                for (var i = 0; i < pageNames.length; i++) {
                    returnCallbacks.push(app.onPage(callbackName, pageNames[i], callback));
                }
                returnCallbacks.remove = function () {
                    for (var i = 0; i < returnCallbacks.length; i++) {
                        returnCallbacks[i].remove();
                    }
                };
                returnCallbacks.trigger = function () {
                    for (var i = 0; i < returnCallbacks.length; i++) {
                        returnCallbacks[i].trigger();
                    }
                };
                return returnCallbacks;
            }
            var callbacks = app.pageCallbacks[callbackName][pageName];
            if (!callbacks) {
                callbacks = app.pageCallbacks[callbackName][pageName] = [];
            }
            app.pageCallbacks[callbackName][pageName].push(callback);
            return {
                remove: function () {
                    var removeIndex;
                    for (var i = 0; i < callbacks.length; i++) {
                        if (callbacks[i].toString() === callback.toString()) {
                            removeIndex = i;
                        }
                    }
                    if (typeof removeIndex !== 'undefined') callbacks.splice(removeIndex, 1);
                },
                trigger: callback
            };
        };
        
        //Create callbacks methods dynamically
        function createPageCallback(callbackName) {
            var capitalized = callbackName.replace(/^./, function (match) {
                return match.toUpperCase();
            });
            app['onPage' + capitalized] = function (pageName, callback) {
                return app.onPage(callbackName, pageName, callback);
            };
        }
        
        var pageCallbacksNames = ('beforeInit init reinit beforeAnimation afterAnimation back afterBack beforeRemove').split(' ');
        for (var i = 0; i < pageCallbacksNames.length; i++) {
            app.pageCallbacks[pageCallbacksNames[i]] = {};
            createPageCallback(pageCallbacksNames[i]);
        }
        
        app.triggerPageCallbacks = function (callbackName, pageName, pageData) {
            var allPagesCallbacks = app.pageCallbacks[callbackName]['*'];
            if (allPagesCallbacks) {
                for (var j = 0; j < allPagesCallbacks.length; j++) {
                    allPagesCallbacks[j](pageData);
                }
            }
            var callbacks = app.pageCallbacks[callbackName][pageName];
            if (!callbacks || callbacks.length === 0) return;
            for (var i = 0; i < callbacks.length; i++) {
                callbacks[i](pageData);
            }
        };
        
        // On Page Init Callback
        app.pageInitCallback = function (view, params) {
            var pageContainer = params.pageContainer;
            if (pageContainer.f7PageInitialized && view && !view.params.domCache) return;
        
            var pageQuery = params.query;
            if (!pageQuery) {
                if (params.url && params.url.indexOf('?') > 0) {
                    pageQuery = $.parseUrlQuery(params.url || '');
                }
                else if (pageContainer.f7PageData && pageContainer.f7PageData.query) {
                    pageQuery = pageContainer.f7PageData.query;
                }
                else {
                    pageQuery = {};
                }
            }
        
            // Page Data
            var pageData = {
                container: pageContainer,
                url: params.url,
                query: pageQuery,
                name: $(pageContainer).attr('data-page'),
                view: view,
                from: params.position,
                context: params.context,
                navbarInnerContainer: params.navbarInnerContainer,
                fromPage: params.fromPage
            };
            if (params.fromPage && !params.fromPage.navbarInnerContainer && params.oldNavbarInnerContainer) {
                params.fromPage.navbarInnerContainer = params.oldNavbarInnerContainer;
            }
        
            if (pageContainer.f7PageInitialized && ((view && view.params.domCache) || (!view && $(pageContainer).parents('.popup, .popover, .login-screen, .modal, .actions-modal, .picker-modal').length > 0))) {
                // Reinit Page
                app.reinitPage(pageContainer);
        
                // Callbacks
                app.pluginHook('pageReinit', pageData);
                if (app.params.onPageReinit) app.params.onPageReinit(app, pageData);
                app.triggerPageCallbacks('reinit', pageData.name, pageData);
                $(pageData.container).trigger('pageReinit', {page: pageData});
                return;
            }
            pageContainer.f7PageInitialized = true;
        
            // Store pagedata in page
            pageContainer.f7PageData = pageData;
        
            // Update View's activePage
            if (view && !params.preloadOnly && !params.reloadPrevious) {
                // Add data-page on view
                $(view.container).attr('data-page', pageData.name);
                // Update View active page data
                view.activePage = pageData;
            }
        
            // Before Init Callbacks
            app.pluginHook('pageBeforeInit', pageData);
            if (app.params.onPageBeforeInit) app.params.onPageBeforeInit(app, pageData);
            app.triggerPageCallbacks('beforeInit', pageData.name, pageData);
            $(pageData.container).trigger('pageBeforeInit', {page: pageData});
        
            // Init page
            app.initPage(pageContainer);
        
            // Init Callback
            app.pluginHook('pageInit', pageData);
            if (app.params.onPageInit) app.params.onPageInit(app, pageData);
            app.triggerPageCallbacks('init', pageData.name, pageData);
            $(pageData.container).trigger('pageInit', {page: pageData});
        };
        app.pageRemoveCallback = function (view, pageContainer, position) {
            var pageContext;
            if (pageContainer.f7PageData) pageContext = pageContainer.f7PageData.context;
            // Page Data
            var pageData = {
                container: pageContainer,
                name: $(pageContainer).attr('data-page'),
                view: view,
                url: pageContainer.f7PageData && pageContainer.f7PageData.url,
                query: pageContainer.f7PageData && pageContainer.f7PageData.query,
                navbarInnerContainer: pageContainer.f7PageData && pageContainer.f7PageData.navbarInnerContainer,
                from: position,
                context: pageContext
            };
            // Before Init Callback
            app.pluginHook('pageBeforeRemove', pageData);
            if (app.params.onPageBeforeRemove) app.params.onPageBeforeRemove(app, pageData);
            app.triggerPageCallbacks('beforeRemove', pageData.name, pageData);
            $(pageData.container).trigger('pageBeforeRemove', {page: pageData});
        };
        app.pageBackCallback = function (callback, view, params) {
            // Page Data
            var pageContainer = params.pageContainer;
            var pageContext;
            if (pageContainer.f7PageData) pageContext = pageContainer.f7PageData.context;
        
            var pageData = {
                container: pageContainer,
                name: $(pageContainer).attr('data-page'),
                url: pageContainer.f7PageData && pageContainer.f7PageData.url,
                query: pageContainer.f7PageData && pageContainer.f7PageData.query,
                view: view,
                from: params.position,
                context: pageContext,
                navbarInnerContainer: pageContainer.f7PageData && pageContainer.f7PageData.navbarInnerContainer,
                swipeBack: params.swipeBack
            };
        
            if (callback === 'after') {
                app.pluginHook('pageAfterBack', pageData);
                if (app.params.onPageAfterBack) app.params.onPageAfterBack(app, pageData);
                app.triggerPageCallbacks('afterBack', pageData.name, pageData);
                $(pageContainer).trigger('pageAfterBack', {page: pageData});
        
            }
            if (callback === 'before') {
                app.pluginHook('pageBack', pageData);
                if (app.params.onPageBack) app.params.onPageBack(app, pageData);
                app.triggerPageCallbacks('back', pageData.name, pageData);
                $(pageData.container).trigger('pageBack', {page: pageData});
            }
        };
        app.pageAnimCallback = function (callback, view, params) {
            var pageContainer = params.pageContainer;
            var pageContext;
            if (pageContainer.f7PageData) pageContext = pageContainer.f7PageData.context;
        
            var pageQuery = params.query;
            if (!pageQuery) {
                if (params.url && params.url.indexOf('?') > 0) {
                    pageQuery = $.parseUrlQuery(params.url || '');
                }
                else if (pageContainer.f7PageData && pageContainer.f7PageData.query) {
                    pageQuery = pageContainer.f7PageData.query;
                }
                else {
                    pageQuery = {};
                }
            }
            // Page Data
            var pageData = {
                container: pageContainer,
                url: params.url,
                query: pageQuery,
                name: $(pageContainer).attr('data-page'),
                view: view,
                from: params.position,
                context: pageContext,
                swipeBack: params.swipeBack,
                navbarInnerContainer: pageContainer.f7PageData && pageContainer.f7PageData.navbarInnerContainer,
                fromPage: params.fromPage
            };
            var oldPage = params.oldPage,
                newPage = params.newPage;
        
            // Update page date
            pageContainer.f7PageData = pageData;
        
            if (callback === 'after') {
                app.pluginHook('pageAfterAnimation', pageData);
                if (app.params.onPageAfterAnimation) app.params.onPageAfterAnimation(app, pageData);
                app.triggerPageCallbacks('afterAnimation', pageData.name, pageData);
                $(pageData.container).trigger('pageAfterAnimation', {page: pageData});
        
            }
            if (callback === 'before') {
                // Add data-page on view
                $(view.container).attr('data-page', pageData.name);
        
                // Update View's activePage
                if (view) view.activePage = pageData;
        
                // Hide/show navbar dynamically
                if (newPage.hasClass('no-navbar') && !oldPage.hasClass('no-navbar')) {
                    view.hideNavbar();
                }
                if (!newPage.hasClass('no-navbar') && (oldPage.hasClass('no-navbar') || oldPage.hasClass('no-navbar-by-scroll'))) {
                    view.showNavbar();
                }
                // Hide/show navbar toolbar
                if (newPage.hasClass('no-toolbar') && !oldPage.hasClass('no-toolbar')) {
                    view.hideToolbar();
                }
                if (!newPage.hasClass('no-toolbar') && (oldPage.hasClass('no-toolbar') || oldPage.hasClass('no-toolbar-by-scroll'))) {
                    view.showToolbar();
                }
                // Hide/show tabbar
                var tabBar;
                if (newPage.hasClass('no-tabbar') && !oldPage.hasClass('no-tabbar')) {
                    tabBar = $(view.container).find('.tabbar');
                    if (tabBar.length === 0) tabBar = $(view.container).parents('.' + app.params.viewsClass).find('.tabbar');
                    app.hideToolbar(tabBar);
                }
                if (!newPage.hasClass('no-tabbar') && (oldPage.hasClass('no-tabbar') || oldPage.hasClass('no-tabbar-by-scroll'))) {
                    tabBar = $(view.container).find('.tabbar');
                    if (tabBar.length === 0) tabBar = $(view.container).parents('.' + app.params.viewsClass).find('.tabbar');
                    app.showToolbar(tabBar);
                }
        
                oldPage.removeClass('no-navbar-by-scroll no-toolbar-by-scroll');
                // Callbacks
                app.pluginHook('pageBeforeAnimation', pageData);
                if (app.params.onPageBeforeAnimation) app.params.onPageBeforeAnimation(app, pageData);
                app.triggerPageCallbacks('beforeAnimation', pageData.name, pageData);
                $(pageData.container).trigger('pageBeforeAnimation', {page: pageData});
            }
        };
        
        // Init Page Events and Manipulations
        app.initPage = function (pageContainer) {
            pageContainer = $(pageContainer);
            if (pageContainer.length === 0) return;
            // Size navbars on page load
            if (app.sizeNavbars) app.sizeNavbars(pageContainer.parents('.' + app.params.viewClass)[0]);
            // Init messages
            if (app.initPageMessages) app.initPageMessages(pageContainer);
            // Init forms storage
            if (app.initFormsStorage) app.initFormsStorage(pageContainer);
            // Init smart select
            if (app.initSmartSelects) app.initSmartSelects(pageContainer);
            // Init slider
            if (app.initPageSwiper) app.initPageSwiper(pageContainer);
            // Init pull to refres
            if (app.initPullToRefresh) app.initPullToRefresh(pageContainer);
            // Init infinite scroll
            if (app.initPageInfiniteScroll) app.initPageInfiniteScroll(pageContainer);
            // Init searchbar
            if (app.initSearchbar) app.initSearchbar(pageContainer);
            // Init message bar
            if (app.initPageMessagebar) app.initPageMessagebar(pageContainer);
            // Init scroll toolbars
            if (app.initPageScrollToolbars) app.initPageScrollToolbars(pageContainer);
            // Init lazy images
            if (app.initImagesLazyLoad) app.initImagesLazyLoad(pageContainer);
            // Init progress bars
            if (app.initPageProgressbar) app.initPageProgressbar(pageContainer);
            // Init resizeable textareas
            if (app.initPageResizableTextarea) app.initPageResizableTextarea(pageContainer);
            // Init Material Preloader
            if (app.params.material && app.initPageMaterialPreloader) app.initPageMaterialPreloader(pageContainer);
            // Init Material Inputs
            if (app.params.material && app.initPageMaterialInputs) app.initPageMaterialInputs(pageContainer);
            // Init Material Tabbar
            if (app.params.material && app.initPageMaterialTabbar) app.initPageMaterialTabbar(pageContainer);
        };
        app.reinitPage = function (pageContainer) {
            pageContainer = $(pageContainer);
            if (pageContainer.length === 0) return;
            // Size navbars on page reinit
            if (app.sizeNavbars) app.sizeNavbars(pageContainer.parents('.' + app.params.viewClass)[0]);
            // Reinit slider
            if (app.reinitPageSwiper) app.reinitPageSwiper(pageContainer);
            // Reinit lazy load
            if (app.reinitLazyLoad) app.reinitLazyLoad(pageContainer);
        };
        app.initPageWithCallback = function (pageContainer) {
            pageContainer = $(pageContainer);
            var viewContainer = pageContainer.parents('.' + app.params.viewClass);
            if (viewContainer.length === 0) return;
            var view = viewContainer[0].f7View || undefined;
            var url = view && view.url ? view.url : undefined;
            if (viewContainer && pageContainer.attr('data-page')) {
                viewContainer.attr('data-page', pageContainer.attr('data-page'));
            }
            app.pageInitCallback(view, {pageContainer: pageContainer[0], url: url, position: 'center'});
        };

        /*======================================================
        ************   Navigation / Router   ************
        ======================================================*/
        app.router = {
            // Temporary DOM Element
            temporaryDom: document.createElement('div'),
        
            // Find page or navbar in passed container which are related to View
            findElement: function (selector, container, view, notCached) {
                container = $(container);
                if (notCached) selector = selector + ':not(.cached)';
                var found = container.find(selector);
                if (found.length > 1) {
                    if (typeof view.selector === 'string') {
                        // Search in related view
                        found = container.find(view.selector + ' ' + selector);
                    }
                    if (found.length > 1) {
                        // Search in main view
                        found = container.find('.' + app.params.viewMainClass + ' ' + selector);
                    }
                }
                if (found.length === 1) return found;
                else {
                    // Try to find non cached
                    if (!notCached) found = app.router.findElement(selector, container, view, true);
                    if (found && found.length === 1) return found;
                    else return undefined;
                }
            },
        
            // Set pages classess for animationEnd
            animatePages: function (leftPage, rightPage, direction, view) {
                // Loading new page
                var removeClasses = 'page-on-center page-on-right page-on-left';
                if (direction === 'to-left') {
                    leftPage.removeClass(removeClasses).addClass('page-from-center-to-left');
                    rightPage.removeClass(removeClasses).addClass('page-from-right-to-center');
                }
                // Go back
                if (direction === 'to-right') {
                    leftPage.removeClass(removeClasses).addClass('page-from-left-to-center');
                    rightPage.removeClass(removeClasses).addClass('page-from-center-to-right');
        
                }
            },
        
            // Prepare navbar before animarion
            prepareNavbar: function (newNavbarInner, oldNavbarInner, newNavbarPosition) {
                $(newNavbarInner).find('.sliding').each(function () {
                    var sliding = $(this);
                    var slidingOffset = newNavbarPosition === 'right' ? this.f7NavbarRightOffset : this.f7NavbarLeftOffset;
        
                    if (app.params.animateNavBackIcon) {
                        if (sliding.hasClass('left') && sliding.find('.back .icon').length > 0) {
                            sliding.find('.back .icon').transform('translate3d(' + (-slidingOffset) + 'px,0,0)');
                        }
                    }
                    sliding.transform('translate3d(' + slidingOffset + 'px,0,0)');
                });
            },
        
            // Set navbars classess for animation
            animateNavbars: function (leftNavbarInner, rightNavbarInner, direction, view) {
                // Loading new page
                var removeClasses = 'navbar-on-right navbar-on-center navbar-on-left';
                if (direction === 'to-left') {
                    rightNavbarInner.removeClass(removeClasses).addClass('navbar-from-right-to-center');
                    rightNavbarInner.find('.sliding').each(function () {
                        var sliding = $(this);
                        sliding.transform('translate3d(0px,0,0)');
                        if (app.params.animateNavBackIcon) {
                            if (sliding.hasClass('left') && sliding.find('.back .icon').length > 0) {
                                sliding.find('.back .icon').transform('translate3d(0px,0,0)');
                            }
                        }
                    });
        
                    leftNavbarInner.removeClass(removeClasses).addClass('navbar-from-center-to-left');
                    leftNavbarInner.find('.sliding').each(function () {
                        var sliding = $(this);
                        var rightText;
                        if (app.params.animateNavBackIcon) {
                            if (sliding.hasClass('center') && rightNavbarInner.find('.sliding.left .back .icon').length > 0) {
                                rightText = rightNavbarInner.find('.sliding.left .back span');
                                if (rightText.length > 0) this.f7NavbarLeftOffset += rightText[0].offsetLeft;
                            }
                            if (sliding.hasClass('left') && sliding.find('.back .icon').length > 0) {
                                sliding.find('.back .icon').transform('translate3d(' + (-this.f7NavbarLeftOffset) + 'px,0,0)');
                            }
                        }
                        sliding.transform('translate3d(' + (this.f7NavbarLeftOffset) + 'px,0,0)');
                    });
                }
                // Go back
                if (direction === 'to-right') {
                    leftNavbarInner.removeClass(removeClasses).addClass('navbar-from-left-to-center');
                    leftNavbarInner.find('.sliding').each(function () {
                        var sliding = $(this);
                        sliding.transform('translate3d(0px,0,0)');
                        if (app.params.animateNavBackIcon) {
                            if (sliding.hasClass('left') && sliding.find('.back .icon').length > 0) {
                                sliding.find('.back .icon').transform('translate3d(0px,0,0)');
                            }
                        }
                    });
        
                    rightNavbarInner.removeClass(removeClasses).addClass('navbar-from-center-to-right');
                    rightNavbarInner.find('.sliding').each(function () {
                        var sliding = $(this);
                        if (app.params.animateNavBackIcon) {
                            if (sliding.hasClass('left') && sliding.find('.back .icon').length > 0) {
                                sliding.find('.back .icon').transform('translate3d(' + (-this.f7NavbarRightOffset) + 'px,0,0)');
                            }
                        }
                        sliding.transform('translate3d(' + (this.f7NavbarRightOffset) + 'px,0,0)');
                    });
                }
            },
        
            preprocess: function(view, content, url, next) {
                // Plugin hook
                app.pluginHook('routerPreprocess', view, content, url, next);
        
                // Preprocess by plugin
                content = app.pluginProcess('preprocess', content);
        
                if (view && view.params && view.params.preprocess) {
                    content = view.params.preprocess(content, url, next);
                    if (typeof content !== 'undefined') {
                        next(content);
                    }
                }
                else if (app.params.preprocess) {
                    content = app.params.preprocess(content, url, next);
                    if (typeof content !== 'undefined') {
                        next(content);
                    }
                }
                else {
                    next(content);
                }
            },
            preroute: function(view, options) {
                app.pluginHook('routerPreroute', view, options);
                if ((app.params.preroute && app.params.preroute(view, options) === false) || (view && view.params.preroute && view.params.preroute(view, options) === false)) {
                    return true;
                }
                else {
                    return false;
                }
            },
        
            template7Render: function (view, options) {
                var url = options.url,
                    content = options.content, //initial content
                    t7_rendered_content = options.content, // will be rendered using Template7
                    context = options.context, // Context data for Template7
                    contextName = options.contextName,
                    template = options.template, // Template 7 compiled template
                    pageName = options.pageName;
        
                var t7_ctx, t7_template;
                if (typeof content === 'string') {
                    if (url) {
                        if (app.template7Cache[url] && !options.ignoreCache) t7_template = t7.cache[url];
                        else {
                            t7_template = t7.compile(content);
                            t7.cache[url] = t7_template;
                        }
                    }
                    else t7_template = t7.compile(content);
                }
                else if (template) {
                    t7_template = template;
                }
        
                if (context) t7_ctx = context;
                else {
                    if (contextName) {
                        if (contextName.indexOf('.') >= 0) {
                            var _ctx_path = contextName.split('.');
                            var _ctx = t7.data[_ctx_path[0]];
                            for (var i = 1; i < _ctx_path.length; i++) {
                                if (_ctx_path[i]) _ctx = _ctx[_ctx_path[i]];
                            }
                            t7_ctx = _ctx;
                        }
                        else t7_ctx = t7.data[contextName];
                    }
                    if (!t7_ctx && url) {
                        t7_ctx = t7.data['url:' + url];
                    }
                    if (!t7_ctx && typeof content === 'string' && !template) {
                        //try to find by page name in content
                        var pageNameMatch = content.match(/(data-page=["'][^"^']*["'])/);
                        if (pageNameMatch) {
                            var page = pageNameMatch[0].split('data-page=')[1].replace(/['"]/g, '');
                            if (page) t7_ctx = t7.data['page:' + page];
                        }
                    }
                    if (!t7_ctx && template && t7.templates) {
                        // Try to find matched template name in t7.templates
                        for (var templateName in t7.templates) {
                            if (t7.templates[templateName] === template) t7_ctx = t7.data[templateName];
                        }
                    }
                    if (!t7_ctx) t7_ctx = {};
                }
        
                if (t7_template && t7_ctx) {
                    if (typeof t7_ctx === 'function') t7_ctx = t7_ctx();
                    if (url) {
                        // Extend data with URL query
                        var query = $.parseUrlQuery(url);
                        t7_ctx.url_query = {};
                        for (var key in query) {
                            t7_ctx.url_query[key] = query[key];
                        }
                    }
                    t7_rendered_content = t7_template(t7_ctx);
                }
        
                return {content: t7_rendered_content, context: t7_ctx};
            }
        };
        
        
        app.router._load = function (view, options) {
            options = options || {};
        
            var url = options.url,
                content = options.content, //initial content
                t7_rendered = {content: options.content},
                template = options.template, // Template 7 compiled template
                pageName = options.pageName,
                viewContainer = $(view.container),
                pagesContainer = $(view.pagesContainer),
                animatePages = options.animatePages,
                newPage, oldPage, pagesInView, i, oldNavbarInner, newNavbarInner, navbar, dynamicNavbar, reloadPosition,
                isDynamicPage = typeof url === 'undefined' && content || template,
                pushState = options.pushState;
        
            if (typeof animatePages === 'undefined') animatePages = view.params.animatePages;
        
            // Plugin hook
            app.pluginHook('routerLoad', view, options);
        
            // Render with Template7
            if (app.params.template7Pages && typeof content === 'string' || template) {
                t7_rendered = app.router.template7Render(view, options);
                if (t7_rendered.content && !content) {
                    content = t7_rendered.content;
                }
            }
        
            app.router.temporaryDom.innerHTML = '';
        
            // Parse DOM
            if (!pageName) {
                if ((typeof content === 'string') || (url && (typeof content === 'string'))) {
                    app.router.temporaryDom.innerHTML = t7_rendered.content;
                } else {
                    if ('length' in content && content.length > 1) {
                        for (var ci = 0; ci < content.length; ci++) {
                            $(app.router.temporaryDom).append(content[ci]);
                        }
                    } else {
                        $(app.router.temporaryDom).append(content);
                    }
                }
            }
        
            // Reload position
            reloadPosition = options.reload && (options.reloadPrevious ? 'left' : 'center');
        
            // Find new page
            if (pageName) newPage = pagesContainer.find('.page[data-page="' + pageName + '"]');
            else {
                newPage = app.router.findElement('.page', app.router.temporaryDom, view);
            }
        
            // If page not found exit
            if (!newPage || newPage.length === 0 || (pageName && view.activePage && view.activePage.name === pageName)) {
                view.allowPageChange = true;
                return;
            }
        
            newPage.addClass(options.reload ? 'page-on-' + reloadPosition : 'page-on-right');
        
            // Find old page (should be the last one) and remove older pages
            pagesInView = pagesContainer.children('.page:not(.cached)');
        
            if (options.reload && options.reloadPrevious && pagesInView.length === 1)  {
                view.allowPageChange = true;
                return;
            }
        
            if (options.reload) {
                oldPage = pagesInView.eq(pagesInView.length - 1);
            }
            else {
                if (pagesInView.length > 1) {
                    for (i = 0; i < pagesInView.length - 2; i++) {
                        if (!view.params.domCache) {
                            app.pageRemoveCallback(view, pagesInView[i], 'left');
                            $(pagesInView[i]).remove();
                        }
                        else {
                            $(pagesInView[i]).addClass('cached');
                        }
                    }
                    if (!view.params.domCache) {
                        app.pageRemoveCallback(view, pagesInView[i], 'left');
                        $(pagesInView[i]).remove();
                    }
                    else {
                        $(pagesInView[i]).addClass('cached');
                    }
                }
                oldPage = pagesContainer.children('.page:not(.cached)');
            }
            if(view.params.domCache) newPage.removeClass('cached');
        
            // Dynamic navbar
            if (view.params.dynamicNavbar) {
                dynamicNavbar = true;
                // Find navbar
                if (pageName) {
                    newNavbarInner = viewContainer.find('.navbar-inner[data-page="' + pageName + '"]');
                }
                else {
                    newNavbarInner = app.router.findElement('.navbar-inner', app.router.temporaryDom, view);
                }
                if (!newNavbarInner || newNavbarInner.length === 0) {
                    dynamicNavbar = false;
                }
                navbar = viewContainer.find('.navbar');
                if (options.reload) {
                    oldNavbarInner = navbar.find('.navbar-inner:not(.cached):last-child');
                }
                else {
                    oldNavbarInner = navbar.find('.navbar-inner:not(.cached)');
        
                    if (oldNavbarInner.length > 0) {
                        for (i = 0; i < oldNavbarInner.length - 1; i++) {
                            if (!view.params.domCache) {
                                app.navbarRemoveCallback(view, pagesInView[i], navbar[0], oldNavbarInner[i]);
                                $(oldNavbarInner[i]).remove();
                            }
                            else
                                $(oldNavbarInner[i]).addClass('cached');
                        }
                        if (!newNavbarInner && oldNavbarInner.length === 1) {
                            if (!view.params.domCache) {
                                app.navbarRemoveCallback(view, pagesInView[0], navbar[0], oldNavbarInner[0]);
                                $(oldNavbarInner[0]).remove();
                            }
                            else
                                $(oldNavbarInner[0]).addClass('cached');
                        }
                        oldNavbarInner = navbar.find('.navbar-inner:not(.cached)');
                    }
                }
            }
            if (dynamicNavbar) {
                newNavbarInner.addClass(options.reload ? 'navbar-on-' + reloadPosition : 'navbar-on-right');
                if(view.params.domCache) newNavbarInner.removeClass('cached');
                newPage[0].f7RelatedNavbar = newNavbarInner[0];
                newNavbarInner[0].f7RelatedPage = newPage[0];
            }
        
            // save content areas into view's cache
            if (!url) {
                var newPageName = pageName || newPage.attr('data-page');
                if (isDynamicPage) url = '#' + app.params.dynamicPageUrl.replace(/{{name}}/g, newPageName).replace(/{{index}}/g, view.history.length - (options.reload ? 1 : 0));
                else url = '#' + newPageName;
                if (!view.params.domCache) {
                    view.contentCache[url] = content;
                }
                if (view.params.domCache && pageName) {
                    view.pagesCache[url] = pageName;
                }
            }
        
            // Push State
            if (app.params.pushState && !options.reloadPrevious && view.main)  {
                if (typeof pushState === 'undefined') pushState = true;
                var pushStateRoot = app.params.pushStateRoot || '';
                var method = options.reload ? 'replaceState' : 'pushState';
                if (pushState) {
                    if (!isDynamicPage && !pageName) {
                        history[method]({url: url, viewIndex: app.views.indexOf(view)}, '', pushStateRoot + app.params.pushStateSeparator + url);
                    }
                    else if (isDynamicPage && content) {
                        history[method]({content: typeof content === 'string' ? content : '', url: url, viewIndex: app.views.indexOf(view)}, '', pushStateRoot + app.params.pushStateSeparator + url);
                    }
                    else if (pageName) {
                        history[method]({pageName: pageName, url: url, viewIndex: app.views.indexOf(view)}, '', pushStateRoot + app.params.pushStateSeparator + url);
                    }
                }
            }
        
            // Update View history
            view.url = url;
            if (options.reload) {
                var lastUrl = view.history[view.history.length - (options.reloadPrevious ? 2 : 1)];
                if (lastUrl &&
                    lastUrl.indexOf('#') === 0 &&
                    lastUrl in view.contentCache &&
                    lastUrl !== url &&
                    view.history.indexOf(lastUrl) === -1) {
                    view.contentCache[lastUrl] = null;
                    delete view.contentCache[lastUrl];
                }
                view.history[view.history.length - (options.reloadPrevious ? 2 : 1)] = url;
            }
            else {
                view.history.push(url);
            }
        
            // Unique history
            var historyBecameUnique = false;
            if (view.params.uniqueHistory) {
                var _history = view.history;
                var _url = url;
                if (view.params.uniqueHistoryIgnoreGetParameters) {
                    _history = [];
                    _url = url.split('?')[0];
                    for (i = 0; i < view.history.length; i++) {
                        _history.push(view.history[i].split('?')[0]);
                    }
                }
        
                if (_history.indexOf(_url) !== _history.lastIndexOf(_url)) {
                    view.history = view.history.slice(0, _history.indexOf(_url));
                    view.history.push(url);
                    historyBecameUnique = true;
                }
            }
            // Dom manipulations
            if (options.reloadPrevious) {
                oldPage = oldPage.prev('.page');
                newPage.insertBefore(oldPage);
                if (dynamicNavbar) {
                    oldNavbarInner = oldNavbarInner.prev('.navbar-inner');
                    newNavbarInner.insertAfter(oldNavbarInner);
                }
            }
            else {
                pagesContainer.append(newPage[0]);
                if (dynamicNavbar) navbar.append(newNavbarInner[0]);
            }
            // Remove Old Page And Navbar
            if (options.reload) {
                if (view.params.domCache && view.initialPages.indexOf(oldPage[0]) >= 0) {
                    oldPage.addClass('cached');
                    if (dynamicNavbar) oldNavbarInner.addClass('cached');
                }
                else {
                    app.pageRemoveCallback(view, oldPage[0], reloadPosition);
                    if (dynamicNavbar) app.navbarRemoveCallback(view, oldPage[0], navbar[0], oldNavbarInner[0]);
                    oldPage.remove();
                    if (dynamicNavbar) oldNavbarInner.remove();
                }
            }
        
            // Page Init Events
            app.pageInitCallback(view, {
                pageContainer: newPage[0],
                url: url,
                position: options.reload ? reloadPosition : 'right',
                navbarInnerContainer: dynamicNavbar ? newNavbarInner && newNavbarInner[0] : undefined,
                oldNavbarInnerContainer: dynamicNavbar ? oldNavbarInner && oldNavbarInner[0] : undefined,
                context: t7_rendered.context,
                query: options.query,
                fromPage: oldPage && oldPage.length && oldPage[0].f7PageData,
                reload: options.reload,
                reloadPrevious: options.reloadPrevious
            });
        
            // Navbar init event
            if (dynamicNavbar) {
                app.navbarInitCallback(view, newPage[0], navbar[0], newNavbarInner[0], url, options.reload ? reloadPosition : 'right');
            }
        
            if (options.reload) {
                view.allowPageChange = true;
                if (historyBecameUnique) view.refreshPreviousPage();
                return;
            }
        
            if (dynamicNavbar && animatePages) {
                app.router.prepareNavbar(newNavbarInner, oldNavbarInner, 'right');
            }
            // Force reLayout
            var clientLeft = newPage[0].clientLeft;
        
            // Before Anim Callback
            app.pageAnimCallback('before', view, {
                pageContainer: newPage[0],
                url: url,
                position: 'right',
                oldPage: oldPage,
                newPage: newPage,
                query: options.query,
                fromPage: oldPage && oldPage.length && oldPage[0].f7PageData
            });
        
            function afterAnimation() {
                view.allowPageChange = true;
                newPage.removeClass('page-from-right-to-center page-on-right page-on-left').addClass('page-on-center');
                oldPage.removeClass('page-from-center-to-left page-on-center page-on-right').addClass('page-on-left');
                if (dynamicNavbar) {
                    newNavbarInner.removeClass('navbar-from-right-to-center navbar-on-left navbar-on-right').addClass('navbar-on-center');
                    oldNavbarInner.removeClass('navbar-from-center-to-left navbar-on-center navbar-on-right').addClass('navbar-on-left');
                }
                app.pageAnimCallback('after', view, {
                    pageContainer: newPage[0],
                    url: url,
                    position: 'right',
                    oldPage: oldPage,
                    newPage: newPage,
                    query: options.query,
                    fromPage: oldPage && oldPage.length && oldPage[0].f7PageData
                });
                if (app.params.pushState && view.main) app.pushStateClearQueue();
                if (!(view.params.swipeBackPage || view.params.preloadPreviousPage)) {
                    if (view.params.domCache) {
                        oldPage.addClass('cached');
                        if (dynamicNavbar) oldNavbarInner.addClass('cached');
                    }
                    else {
                        if (!(url.indexOf('#') === 0 && newPage.attr('data-page').indexOf('smart-select-') === 0)) {
                            app.pageRemoveCallback(view, oldPage[0], 'left');
                            if (dynamicNavbar) app.navbarRemoveCallback(view, oldPage[0], navbar[0], oldNavbarInner[0]);
                            oldPage.remove();
                            if (dynamicNavbar) oldNavbarInner.remove();
                        }
                    }
                }
                if (view.params.uniqueHistory && historyBecameUnique) {
                    view.refreshPreviousPage();
                }
            }
            if (animatePages) {
                // Set pages before animation
                if (app.params.material && app.params.materialPageLoadDelay) {
                    setTimeout(function () {
                        app.router.animatePages(oldPage, newPage, 'to-left', view);
                    }, app.params.materialPageLoadDelay);
                }
                else {
                    app.router.animatePages(oldPage, newPage, 'to-left', view);
                }
        
                // Dynamic navbar animation
                if (dynamicNavbar) {
                    setTimeout(function() {
                        app.router.animateNavbars(oldNavbarInner, newNavbarInner, 'to-left', view);
                    }, 0);
                }
                newPage.animationEnd(function (e) {
                    afterAnimation();
                });
            }
            else {
                if (dynamicNavbar) newNavbarInner.find('.sliding, .sliding .back .icon').transform('');
                afterAnimation();
            }
        
        };
        
        app.router.load = function (view, options) {
            if (app.router.preroute(view, options)) {
                return false;
            }
            options = options || {};
            var url = options.url;
            var content = options.content;
            var pageName = options.pageName;
            if (pageName) {
                if (pageName.indexOf('?') > 0) {
                    options.query = $.parseUrlQuery(pageName);
                    options.pageName = pageName = pageName.split('?')[0];
                }
            }
            var template = options.template;
            if (view.params.reloadPages === true) options.reload = true;
        
            if (!view.allowPageChange) return false;
            if (url && view.url === url && !options.reload && !view.params.allowDuplicateUrls) return false;
            view.allowPageChange = false;
            if (app.xhr && view.xhr && view.xhr === app.xhr) {
                app.xhr.abort();
                app.xhr = false;
            }
            function proceed(content) {
                app.router.preprocess(view, content, url, function (content) {
                    options.content = content;
                    app.router._load(view, options);
                });
            }
            if (content || pageName) {
                proceed(content);
                return;
            }
            else if (template) {
                app.router._load(view, options);
                return;
            }
        
            if (!options.url || options.url === '#') {
                view.allowPageChange = true;
                return;
            }
            app.get(options.url, view, options.ignoreCache, function (content, error) {
                if (error) {
                    view.allowPageChange = true;
                    return;
                }
                proceed(content);
            });
        };
        
        app.router._back = function (view, options) {
            options = options || {};
            var url = options.url,
                content = options.content,
                t7_rendered = {content: options.content}, // will be rendered using Template7
                template = options.template, // Template 7 compiled template
                animatePages = options.animatePages,
                preloadOnly = options.preloadOnly,
                pushState = options.pushState,
                ignoreCache = options.ignoreCache,
                force = options.force,
                pageName = options.pageName;
        
            var viewContainer = $(view.container),
                pagesContainer = $(view.pagesContainer),
                pagesInView = pagesContainer.children('.page:not(.cached)'),
                oldPage, newPage, oldNavbarInner, newNavbarInner, navbar, navbarInners, dynamicNavbar, manipulateDom = true;
        
            if (typeof animatePages === 'undefined') animatePages = view.params.animatePages;
        
            app.pluginHook('routerBack', view, options);
        
            // Render with Template7
            if (app.params.template7Pages && typeof content === 'string' || template) {
                t7_rendered = app.router.template7Render(view, options);
                if (t7_rendered.content && !content) {
                    content = t7_rendered.content;
                }
            }
        
            // Animation
            function afterAnimation() {
                app.pageBackCallback('after', view, {
                    pageContainer: oldPage[0],
                    url: url,
                    position: 'center',
                    oldPage: oldPage,
                    newPage: newPage,
                });
                app.pageAnimCallback('after', view, {
                    pageContainer: newPage[0],
                    url: url,
                    position: 'left',
                    oldPage: oldPage,
                    newPage: newPage,
                    query: options.query,
                    fromPage: oldPage && oldPage.length && oldPage[0].f7PageData
                });
                app.router.afterBack(view, oldPage[0], newPage[0]);
            }
            function animateBack() {
                // Page before animation callback
                app.pageBackCallback('before', view, {
                    pageContainer: oldPage[0],
                    url: url,
                    position: 'center',
                    oldPage: oldPage,
                    newPage: newPage,
                });
                app.pageAnimCallback('before', view, {
                    pageContainer: newPage[0],
                    url: url,
                    position: 'left',
                    oldPage: oldPage,
                    newPage: newPage,
                    query: options.query,
                    fromPage: oldPage && oldPage.length && oldPage[0].f7PageData
                });
        
                if (animatePages) {
                    // Set pages before animation
                    app.router.animatePages(newPage, oldPage, 'to-right', view);
        
                    // Dynamic navbar animation
                    if (dynamicNavbar) {
                        setTimeout(function () {
                            app.router.animateNavbars(newNavbarInner, oldNavbarInner, 'to-right', view);
                        }, 0);
                    }
        
                    newPage.animationEnd(function () {
                        afterAnimation();
                    });
                }
                else {
                    if (dynamicNavbar) newNavbarInner.find('.sliding, .sliding .back .icon').transform('');
                    afterAnimation();
                }
            }
        
            function parseNewPage() {
                app.router.temporaryDom.innerHTML = '';
                // Parse DOM
                if ((typeof content === 'string') || (url && (typeof content === 'string'))) {
                    app.router.temporaryDom.innerHTML = t7_rendered.content;
                } else {
                    if ('length' in content && content.length > 1) {
                        for (var ci = 0; ci < content.length; ci++) {
                            $(app.router.temporaryDom).append(content[ci]);
                        }
                    } else {
                        $(app.router.temporaryDom).append(content);
                    }
                }
                newPage = app.router.findElement('.page', app.router.temporaryDom, view);
        
                if (view.params.dynamicNavbar) {
                    // Find navbar
                    newNavbarInner = app.router.findElement('.navbar-inner', app.router.temporaryDom, view);
                }
            }
            function setPages() {
                // If pages not found or there are still more than one, exit
                if (!newPage || newPage.length === 0) {
                    view.allowPageChange = true;
                    return;
                }
                if (view.params.dynamicNavbar && typeof dynamicNavbar === 'undefined') {
                    if (!newNavbarInner || newNavbarInner.length === 0) {
                        dynamicNavbar = false;
                    }
                    else {
                        dynamicNavbar = true;
                    }
                }
        
                newPage.addClass('page-on-left').removeClass('cached');
                if (dynamicNavbar) {
                    navbar = viewContainer.find('.navbar');
                    navbarInners = viewContainer.find('.navbar-inner:not(.cached)');
                    newNavbarInner.addClass('navbar-on-left').removeClass('cached');
                }
                // Remove/hide previous page in force mode
                if (force) {
                    var pageToRemove, navbarToRemove;
                    pageToRemove = $(pagesInView[pagesInView.length - 2]);
        
                    if (dynamicNavbar) navbarToRemove = $(pageToRemove[0] && pageToRemove[0].f7RelatedNavbar || navbarInners[navbarInners.length - 2]);
                    if (view.params.domCache && view.initialPages.indexOf(pageToRemove[0]) >= 0) {
                        if (pageToRemove.length && pageToRemove[0] !== newPage[0]) pageToRemove.addClass('cached');
                        if (dynamicNavbar && navbarToRemove.length && navbarToRemove[0] !== newNavbarInner[0]) {
                            navbarToRemove.addClass('cached');
                        }
                    }
                    else {
                        var removeNavbar = dynamicNavbar && navbarToRemove.length;
                        if (pageToRemove.length) {
                            app.pageRemoveCallback(view, pageToRemove[0], 'right');
                            if (removeNavbar) {
                                app.navbarRemoveCallback(view, pageToRemove[0], navbar[0], navbarToRemove[0]);
                            }
                            pageToRemove.remove();
                            if (removeNavbar) navbarToRemove.remove();
                        }
                        else if (removeNavbar) {
                            app.navbarRemoveCallback(view, pageToRemove[0], navbar[0], navbarToRemove[0]);
                            navbarToRemove.remove();
                        }
                    }
                    pagesInView = pagesContainer.children('.page:not(.cached)');
                    if (dynamicNavbar) {
                        navbarInners = viewContainer.find('.navbar-inner:not(.cached)');
                    }
                    if (view.history.indexOf(url) >= 0) {
                        view.history = view.history.slice(0, view.history.indexOf(url) + 2);
                    }
                    else {
                        if (view.history[[view.history.length - 2]]) {
                            view.history[view.history.length - 2] = url;
                        }
                        else {
                            view.history.unshift(url);
                        }
                    }
                }
        
                oldPage = $(pagesInView[pagesInView.length - 1]);
                if (view.params.domCache) {
                    if (oldPage[0] === newPage[0]) {
                        oldPage = pagesContainer.children('.page.page-on-center');
                        if (oldPage.length === 0 && view.activePage) oldPage = $(view.activePage.container);
                    }
                }
        
                if (dynamicNavbar && !oldNavbarInner) {
                    oldNavbarInner = $(navbarInners[navbarInners.length - 1]);
                    if (view.params.domCache) {
                        if (oldNavbarInner[0] === newNavbarInner[0]) {
                            oldNavbarInner = navbar.children('.navbar-inner.navbar-on-center:not(.cached)');
                        }
                        if (oldNavbarInner.length === 0) {
                            oldNavbarInner = navbar.children('.navbar-inner[data-page="'+oldPage.attr('data-page')+'"]');
                        }
                    }
                    if (oldNavbarInner.length === 0 || newNavbarInner[0] === oldNavbarInner[0]) dynamicNavbar = false;
                }
        
                if (dynamicNavbar) {
                    if (manipulateDom) newNavbarInner.insertBefore(oldNavbarInner);
                    newNavbarInner[0].f7RelatedPage = newPage[0];
                    newPage[0].f7RelatedNavbar = newNavbarInner[0];
                }
                if (manipulateDom) newPage.insertBefore(oldPage);
        
                // Page Init Events
                app.pageInitCallback(view, {
                    pageContainer: newPage[0],
                    url: url,
                    position: 'left',
                    navbarInnerContainer: dynamicNavbar ? newNavbarInner[0] : undefined,
                    oldNavbarInnerContainer: dynamicNavbar ? oldNavbarInner && oldNavbarInner[0] : undefined,
                    context: t7_rendered.context,
                    query: options.query,
                    fromPage: oldPage && oldPage.length && oldPage[0].f7PageData,
                    preloadOnly: preloadOnly
                });
                if (dynamicNavbar) {
                    app.navbarInitCallback(view, newPage[0], navbar[0], newNavbarInner[0], url, 'right');
                }
        
                if (dynamicNavbar && newNavbarInner.hasClass('navbar-on-left') && animatePages) {
                    app.router.prepareNavbar(newNavbarInner,  oldNavbarInner, 'left');
                }
        
                if (preloadOnly) {
                    view.allowPageChange = true;
                    return;
                }
        
                // Update View's URL
                view.url = url;
        
                // Force reLayout
                var clientLeft = newPage[0].clientLeft;
        
                animateBack();
        
                // Push state
                if (app.params.pushState && view.main)  {
                    if (typeof pushState === 'undefined') pushState = true;
                    if (!preloadOnly && history.state && pushState) {
                        history.back();
                    }
                }
                return;
            }
        
            // Simple go back when we have pages on left
            if (pagesInView.length > 1 && !force) {
                // Exit if only preloadOnly
                if (preloadOnly) {
                    view.allowPageChange = true;
                    return;
                }
                // Update View's URL
                view.url = view.history[view.history.length - 2];
                url = view.url;
        
                // Define old and new pages
                newPage = $(pagesInView[pagesInView.length - 2]);
                oldPage = $(pagesInView[pagesInView.length - 1]);
        
                // Dynamic navbar
                if (view.params.dynamicNavbar) {
                    dynamicNavbar = true;
                    // Find navbar
                    navbarInners = viewContainer.find('.navbar-inner:not(.cached)');
                    newNavbarInner = $(navbarInners[0]);
                    oldNavbarInner = $(navbarInners[1]);
                    if (newNavbarInner.length === 0 || oldNavbarInner.length === 0 || oldNavbarInner[0] === newNavbarInner[0]) {
                        dynamicNavbar = false;
                    }
                }
                manipulateDom = false;
                setPages();
                return;
            }
        
            if (!force) {
                // Go back when there is no pages on left
                if (!preloadOnly) {
                    view.url = view.history[view.history.length - 2];
                    url = view.url;
                }
        
                if (content) {
                    parseNewPage();
                    setPages();
                    return;
                }
                else if (pageName) {
                    // Get dom cached pages
                    newPage = $(viewContainer).find('.page[data-page="' + pageName + '"]');
                    if (view.params.dynamicNavbar) {
                        newNavbarInner = $(viewContainer).find('.navbar-inner[data-page="' + pageName + '"]');
                        if (newNavbarInner.length === 0 && newPage[0].f7RelatedNavbar) {
                            newNavbarInner = $(newPage[0].f7RelatedNavbar);
                        }
                        if (newNavbarInner.length === 0 && newPage[0].f7PageData) {
                            newNavbarInner = $(newPage[0].f7PageData.navbarInnerContainer);
                        }
                    }
                    setPages();
                    return;
                }
                else {
                    view.allowPageChange = true;
                    return;
                }
            }
            else {
                if (url && url === view.url || pageName && view.activePage && view.activePage.name === pageName) {
                    view.allowPageChange = true;
                    return;
                }
                // Go back with force url
                if (content) {
                    parseNewPage();
                    setPages();
                    return;
                }
                else if (pageName && view.params.domCache) {
                    if (pageName) url = '#' + pageName;
        
                    newPage = $(viewContainer).find('.page[data-page="' + pageName + '"]');
                    if (newPage[0].f7PageData && newPage[0].f7PageData.url) {
                        url = newPage[0].f7PageData.url;
                    }
                    if (view.params.dynamicNavbar) {
                        newNavbarInner = $(viewContainer).find('.navbar-inner[data-page="' + pageName + '"]');
                        if (newNavbarInner.length === 0 && newPage[0].f7RelatedNavbar) {
                            newNavbarInner = $(newPage[0].f7RelatedNavbar);
                        }
                        if (newNavbarInner.length === 0 && newPage[0].f7PageData) {
                            newNavbarInner = $(newPage[0].f7PageData.navbarInnerContainer);
                        }
                    }
                    setPages();
                    return;
                }
                else {
                    view.allowPageChange = true;
                    return;
                }
            }
        
        };
        app.router.back = function (view, options) {
            if (app.router.preroute(view, options)) {
                return false;
            }
            options = options || {};
            var url = options.url;
            var content = options.content;
            var pageName = options.pageName;
            if (pageName) {
                if (pageName.indexOf('?') > 0) {
                    options.query = $.parseUrlQuery(pageName);
                    options.pageName = pageName = pageName.split('?')[0];
                }
            }
            var force = options.force;
            if (!view.allowPageChange) return false;
            view.allowPageChange = false;
            if (app.xhr && view.xhr && view.xhr === app.xhr) {
                app.xhr.abort();
                app.xhr = false;
            }
            var pagesInView = $(view.pagesContainer).find('.page:not(.cached)');
        
            function proceed(content) {
                app.router.preprocess(view, content, url, function (content) {
                    options.content = content;
                    app.router._back(view, options);
                });
            }
            if (pagesInView.length > 1 && !force) {
                // Simple go back to previos page in view
                app.router._back(view, options);
                return;
            }
            if (!force) {
                url = options.url = view.history[view.history.length - 2];
                if (!url) {
                    view.allowPageChange = true;
                    return;
                }
                if (url.indexOf('#') === 0 && view.contentCache[url]) {
                    proceed(view.contentCache[url]);
                    return;
                }
                else if (url.indexOf('#') === 0 && view.params.domCache) {
                    if (!pageName) options.pageName = url.split('#')[1];
                    proceed();
                    return;
                }
                else if (url.indexOf('#') !== 0) {
                    // Load ajax page
                    app.get(options.url, view, options.ignoreCache, function (content, error) {
                        if (error) {
                            view.allowPageChange = true;
                            return;
                        }
                        proceed(content);
                    });
                    return;
                }
            }
            else {
                // Go back with force url
                if (!url && content) {
                    proceed(content);
                    return;
                }
                else if (!url && pageName) {
                    if (pageName) url = '#' + pageName;
                    proceed();
                    return;
                }
                else if (url) {
                    app.get(options.url, view, options.ignoreCache, function (content, error) {
                        if (error) {
                            view.allowPageChange = true;
                            return;
                        }
                        proceed(content);
                    });
                    return;
                }
            }
            view.allowPageChange = true;
            return;
        };
        
        app.router.afterBack = function (view, oldPage, newPage) {
            // Remove old page and set classes on new one
            oldPage = $(oldPage);
            newPage = $(newPage);
        
            if (view.params.domCache && view.initialPages.indexOf(oldPage[0]) >= 0) {
                oldPage.removeClass('page-from-center-to-right').addClass('cached');
            }
            else {
                app.pageRemoveCallback(view, oldPage[0], 'right');
                oldPage.remove();
            }
        
            newPage.removeClass('page-from-left-to-center page-on-left').addClass('page-on-center');
            view.allowPageChange = true;
        
            // Update View's History
            var previousURL = view.history.pop();
        
            var newNavbar;
        
            // Updated dynamic navbar
            if (view.params.dynamicNavbar) {
                var inners = $(view.container).find('.navbar-inner:not(.cached)');
                var oldNavbar = $(oldPage[0].f7RelatedNavbar || inners[1]);
                if (view.params.domCache && view.initialNavbars.indexOf(oldNavbar[0]) >= 0) {
                    oldNavbar.removeClass('navbar-from-center-to-right').addClass('cached');
                }
                else {
                    app.navbarRemoveCallback(view, oldPage[0], undefined, oldNavbar[0]);
                    oldNavbar.remove();
                }
                newNavbar = $(inners[0]).removeClass('navbar-on-left navbar-from-left-to-center').addClass('navbar-on-center');
            }
        
            // Remove pages in dom cache
            if (view.params.domCache) {
                $(view.container).find('.page.cached').each(function () {
                    var page = $(this);
                    var index = page.index();
                    var pageUrl = page[0].f7PageData && page[0].f7PageData.url;
                    if (pageUrl && view.history.indexOf(pageUrl) < 0 && view.initialPages.indexOf(this) < 0) {
                        app.pageRemoveCallback(view, page[0], 'right');
                        if (page[0].f7RelatedNavbar && view.params.dynamicNavbar) app.navbarRemoveCallback(view, page[0], undefined, page[0].f7RelatedNavbar);
                        page.remove();
                        if (page[0].f7RelatedNavbar && view.params.dynamicNavbar) $(page[0].f7RelatedNavbar).remove();
                    }
                });
            }
        
            // Check previous page is content based only and remove it from content cache
            if (!view.params.domCache &&
                previousURL &&
                previousURL.indexOf('#') > -1 &&
                (previousURL in view.contentCache) &&
                // If the same page is in the history multiple times, don't remove it.
                view.history.indexOf(previousURL) === -1) {
                view.contentCache[previousURL] = null;
                delete view.contentCache[previousURL];
            }
        
            if (app.params.pushState && view.main) app.pushStateClearQueue();
        
            // Preload previous page
            if (view.params.preloadPreviousPage) {
                if (view.params.domCache && view.history.length > 1) {
                    var preloadUrl = view.history[view.history.length - 2];
                    var previousPage;
                    var previousNavbar;
                    if (preloadUrl && view.pagesCache[preloadUrl]) {
                        // Load by page name
                        previousPage = $(view.container).find('.page[data-page="' + view.pagesCache[preloadUrl] + '"]');
                        if (previousPage.next('.page')[0] !== newPage[0]) previousPage.insertBefore(newPage);
                        if (newNavbar) {
                            previousNavbar = $(view.container).find('.navbar-inner[data-page="' + view.pagesCache[preloadUrl] + '"]');
                            if(!previousNavbar || previousNavbar.length === 0) previousNavbar = newNavbar.prev('.navbar-inner.cached');
                            if (previousNavbar.next('.navbar-inner')[0] !== newNavbar[0]) previousNavbar.insertBefore(newNavbar);
                        }
                    }
                    else {
                        // Just load previous page
                        previousPage = newPage.prev('.page.cached');
                        if (newNavbar) previousNavbar = newNavbar.prev('.navbar-inner.cached');
                    }
                    if (previousPage && previousPage.length > 0) previousPage.removeClass('cached page-on-right page-on-center').addClass('page-on-left');
                    if (previousNavbar && previousNavbar.length > 0) previousNavbar.removeClass('cached navbar-on-right navbar-on-center').addClass('navbar-on-left');
                }
                else {
                    app.router.back(view, {preloadOnly: true});
                }
            }
        };
        

        /*======================================================
        ************   Modals   ************
        ======================================================*/
        var _modalTemplateTempDiv = document.createElement('div');
        app.modalStack = [];
        app.modalStackClearQueue = function () {
            if (app.modalStack.length) {
                (app.modalStack.shift())();
            }
        };
        app.modal = function (params) {
            params = params || {};
            var modalHTML = '';
            if (app.params.modalTemplate) {
                if (!app._compiledTemplates.modal) app._compiledTemplates.modal = t7.compile(app.params.modalTemplate);
                modalHTML = app._compiledTemplates.modal(params);
            }
            else {
                var buttonsHTML = '';
                if (params.buttons && params.buttons.length > 0) {
                    for (var i = 0; i < params.buttons.length; i++) {
                        buttonsHTML += '<span class="modal-button' + (params.buttons[i].bold ? ' modal-button-bold' : '') + '">' + params.buttons[i].text + '</span>';
                    }
                }
                var titleHTML = params.title ? '<div class="modal-title">' + params.title + '</div>' : '';
                var textHTML = params.text ? '<div class="modal-text">' + params.text + '</div>' : '';
                var afterTextHTML = params.afterText ? params.afterText : '';
                var noButtons = !params.buttons || params.buttons.length === 0 ? 'modal-no-buttons' : '';
                var verticalButtons = params.verticalButtons ? 'modal-buttons-vertical': '';
                var modalButtonsHTML = params.buttons && params.buttons.length > 0 ? '<div class="modal-buttons modal-buttons-' + params.buttons.length + ' ' + verticalButtons + '">' + buttonsHTML + '</div>' : '';
                modalHTML = '<div class="modal ' + noButtons + ' ' + (params.cssClass || '') + '"><div class="modal-inner">' + (titleHTML + textHTML + afterTextHTML) + '</div>' + modalButtonsHTML + '</div>';
            }
        
            _modalTemplateTempDiv.innerHTML = modalHTML;
        
            var modal = $(_modalTemplateTempDiv).children();
        
            $('body').append(modal[0]);
        
            // Add events on buttons
            modal.find('.modal-button').each(function (index, el) {
                $(el).on('click', function (e) {
                    if (params.buttons[index].close !== false) app.closeModal(modal);
                    if (params.buttons[index].onClick) params.buttons[index].onClick(modal, e);
                    if (params.onClick) params.onClick(modal, index);
                });
            });
            app.openModal(modal);
            return modal[0];
        };
        app.alert = function (text, title, callbackOk) {
            if (typeof title === 'function') {
                callbackOk = arguments[1];
                title = undefined;
            }
            return app.modal({
                text: text || '',
                title: typeof title === 'undefined' ? app.params.modalTitle : title,
                buttons: [ {text: app.params.modalButtonOk, bold: true, onClick: callbackOk} ]
            });
        };
        app.confirm = function (text, title, callbackOk, callbackCancel) {
            if (typeof title === 'function') {
                callbackCancel = arguments[2];
                callbackOk = arguments[1];
                title = undefined;
            }
            return app.modal({
                text: text || '',
                title: typeof title === 'undefined' ? app.params.modalTitle : title,
                buttons: [
                    {text: app.params.modalButtonCancel, onClick: callbackCancel},
                    {text: app.params.modalButtonOk, bold: true, onClick: callbackOk}
                ]
            });
        };
        app.prompt = function (text, title, callbackOk, callbackCancel) {
            if (typeof title === 'function') {
                callbackCancel = arguments[2];
                callbackOk = arguments[1];
                title = undefined;
            }
            return app.modal({
                text: text || '',
                title: typeof title === 'undefined' ? app.params.modalTitle : title,
                afterText: '<div class="input-field"><input type="text" class="modal-text-input"></div>',
                buttons: [
                    {
                        text: app.params.modalButtonCancel
                    },
                    {
                        text: app.params.modalButtonOk,
                        bold: true
                    }
                ],
                onClick: function (modal, index) {
                    if (index === 0 && callbackCancel) callbackCancel($(modal).find('.modal-text-input').val());
                    if (index === 1 && callbackOk) callbackOk($(modal).find('.modal-text-input').val());
                }
            });
        };
        app.modalLogin = function (text, title, callbackOk, callbackCancel) {
            if (typeof title === 'function') {
                callbackCancel = arguments[2];
                callbackOk = arguments[1];
                title = undefined;
            }
            return app.modal({
                text: text || '',
                title: typeof title === 'undefined' ? app.params.modalTitle : title,
                afterText: '<div class="input-field modal-input-double"><input type="text" name="modal-username" placeholder="' + app.params.modalUsernamePlaceholder + '" class="modal-text-input"></div><div class="input-field modal-input-double"><input type="password" name="modal-password" placeholder="' + app.params.modalPasswordPlaceholder + '" class="modal-text-input"></div>',
                buttons: [
                    {
                        text: app.params.modalButtonCancel
                    },
                    {
                        text: app.params.modalButtonOk,
                        bold: true
                    }
                ],
                onClick: function (modal, index) {
                    var username = $(modal).find('.modal-text-input[name="modal-username"]').val();
                    var password = $(modal).find('.modal-text-input[name="modal-password"]').val();
                    if (index === 0 && callbackCancel) callbackCancel(username, password);
                    if (index === 1 && callbackOk) callbackOk(username, password);
                }
            });
        };
        app.modalPassword = function (text, title, callbackOk, callbackCancel) {
            if (typeof title === 'function') {
                callbackCancel = arguments[2];
                callbackOk = arguments[1];
                title = undefined;
            }
            return app.modal({
                text: text || '',
                title: typeof title === 'undefined' ? app.params.modalTitle : title,
                afterText: '<div class="input-field"><input type="password" name="modal-password" placeholder="' + app.params.modalPasswordPlaceholder + '" class="modal-text-input"></div>',
                buttons: [
                    {
                        text: app.params.modalButtonCancel
                    },
                    {
                        text: app.params.modalButtonOk,
                        bold: true
                    }
                ],
                onClick: function (modal, index) {
                    var password = $(modal).find('.modal-text-input[name="modal-password"]').val();
                    if (index === 0 && callbackCancel) callbackCancel(password);
                    if (index === 1 && callbackOk) callbackOk(password);
                }
            });
        };
        app.showPreloader = function (title) {
            return app.modal({
                title: title || app.params.modalPreloaderTitle,
                text: '<div class="preloader">' + (app.params.material ? app.params.materialPreloaderHtml : '') + '</div>',
                cssClass: 'modal-preloader'
            });
        };
        app.hidePreloader = function () {
            app.closeModal('.modal.modal-in');
        };
        app.showIndicator = function () {
            $('body').append('<div class="preloader-indicator-overlay"></div><div class="preloader-indicator-modal"><span class="preloader preloader-white">' + (app.params.material ? app.params.materialPreloaderHtml : '') + '</span></div>');
        };
        app.hideIndicator = function () {
            $('.preloader-indicator-overlay, .preloader-indicator-modal').remove();
        };
        // Action Sheet
        app.actions = function (target, params) {
            var toPopover = false, modal, groupSelector, buttonSelector;
            if (arguments.length === 1) {
                // Actions
                params = target;
            }
            else {
                // Popover
                if (app.device.ios) {
                    if (app.device.ipad) toPopover = true;
                }
                else {
                    if ($(window).width() >= 768) toPopover = true;
                }
            }
            params = params || [];
        
            if (params.length > 0 && !$.isArray(params[0])) {
                params = [params];
            }
            var modalHTML;
            if (toPopover) {
                var actionsToPopoverTemplate = app.params.modalActionsToPopoverTemplate ||
                    '<div class="popover actions-popover">' +
                      '<div class="popover-inner">' +
                        '{{#each this}}' +
                        '<div class="list-block">' +
                          '<ul>' +
                            '{{#each this}}' +
                            '{{#if label}}' +
                            '<li class="actions-popover-label {{#if color}}color-{{color}}{{/if}} {{#if bold}}actions-popover-bold{{/if}}">{{text}}</li>' +
                            '{{else}}' +
                            '<li><a href="#" class="item-link list-button {{#if color}}color-{{color}}{{/if}} {{#if bg}}bg-{{bg}}{{/if}} {{#if bold}}actions-popover-bold{{/if}} {{#if disabled}}disabled{{/if}}">{{text}}</a></li>' +
                            '{{/if}}' +
                            '{{/each}}' +
                          '</ul>' +
                        '</div>' +
                        '{{/each}}' +
                      '</div>' +
                    '</div>';
                if (!app._compiledTemplates.actionsToPopover) {
                    app._compiledTemplates.actionsToPopover = t7.compile(actionsToPopoverTemplate);
                }
                var popoverHTML = app._compiledTemplates.actionsToPopover(params);
                modal = $(app.popover(popoverHTML, target, true));
                groupSelector = '.list-block ul';
                buttonSelector = '.list-button';
            }
            else {
                if (app.params.modalActionsTemplate) {
                    if (!app._compiledTemplates.actions) app._compiledTemplates.actions = t7.compile(app.params.modalActionsTemplate);
                    modalHTML = app._compiledTemplates.actions(params);
                }
                else {
                    var buttonsHTML = '';
                    for (var i = 0; i < params.length; i++) {
                        for (var j = 0; j < params[i].length; j++) {
                            if (j === 0) buttonsHTML += '<div class="actions-modal-group">';
                            var button = params[i][j];
                            var buttonClass = button.label ? 'actions-modal-label' : 'actions-modal-button';
                            if (button.bold) buttonClass += ' actions-modal-button-bold';
                            if (button.color) buttonClass += ' color-' + button.color;
                            if (button.bg) buttonClass += ' bg-' + button.bg;
                            if (button.disabled) buttonClass += ' disabled';
                            buttonsHTML += '<div class="' + buttonClass + '">' + button.text + '</div>';
                            if (j === params[i].length - 1) buttonsHTML += '</div>';
                        }
                    }
                    modalHTML = '<div class="actions-modal">' + buttonsHTML + '</div>';
                }
                _modalTemplateTempDiv.innerHTML = modalHTML;
                modal = $(_modalTemplateTempDiv).children();
                $('body').append(modal[0]);
                groupSelector = '.actions-modal-group';
                buttonSelector = '.actions-modal-button';
            }
        
            var groups = modal.find(groupSelector);
            groups.each(function (index, el) {
                var groupIndex = index;
                $(el).children().each(function (index, el) {
                    var buttonIndex = index;
                    var buttonParams = params[groupIndex][buttonIndex];
                    var clickTarget;
                    if (!toPopover && $(el).is(buttonSelector)) clickTarget = $(el);
                    if (toPopover && $(el).find(buttonSelector).length > 0) clickTarget = $(el).find(buttonSelector);
        
                    if (clickTarget) {
                        clickTarget.on('click', function (e) {
                            if (buttonParams.close !== false) app.closeModal(modal);
                            if (buttonParams.onClick) buttonParams.onClick(modal, e);
                        });
                    }
                });
            });
            if (!toPopover) app.openModal(modal);
            return modal[0];
        };
        app.popover = function (modal, target, removeOnClose) {
            if (typeof removeOnClose === 'undefined') removeOnClose = true;
            if (typeof modal === 'string' && modal.indexOf('<') >= 0) {
                var _modal = document.createElement('div');
                _modal.innerHTML = modal.trim();
                if (_modal.childNodes.length > 0) {
                    modal = _modal.childNodes[0];
                    if (removeOnClose) modal.classList.add('remove-on-close');
                    $('body').append(modal);
                }
                else return false; //nothing found
            }
            modal = $(modal);
            target = $(target);
            if (modal.length === 0 || target.length === 0) return false;
            if (modal.parents('body').length === 0) {
                if (removeOnClose) modal.addClass('remove-on-close');
                $('body').append(modal[0]);
            }
            if (modal.find('.popover-angle').length === 0 && !app.params.material) {
                modal.append('<div class="popover-angle"></div>');
            }
            modal.show();
        
            var material = app.params.material;
        
            function sizePopover() {
                modal.css({left: '', top: ''});
                var modalWidth =  modal.width();
                var modalHeight =  modal.height(); // 13 - height of angle
                var modalAngle, modalAngleSize = 0, modalAngleLeft, modalAngleTop;
                if (!material) {
                    modalAngle = modal.find('.popover-angle');
                    modalAngleSize = modalAngle.width() / 2;
                    modalAngle.removeClass('on-left on-right on-top on-bottom').css({left: '', top: ''});
                }
                else {
                    modal.removeClass('popover-on-left popover-on-right popover-on-top popover-on-bottom').css({left: '', top: ''});
                }
        
                var targetWidth = target.outerWidth();
                var targetHeight = target.outerHeight();
                var targetOffset = target.offset();
                var targetParentPage = target.parents('.page');
                if (targetParentPage.length > 0) {
                    targetOffset.top = targetOffset.top - targetParentPage[0].scrollTop;
                }
        
                var windowHeight = $(window).height();
                var windowWidth = $(window).width();
        
                var modalTop = 0;
                var modalLeft = 0;
                var diff = 0;
                // Top Position
                var modalPosition = material ? 'bottom' : 'top';
                if (material) {
                    if (modalHeight < windowHeight - targetOffset.top - targetHeight) {
                        // On bottom
                        modalPosition = 'bottom';
                        modalTop = targetOffset.top;
                    }
                    else if (modalHeight < targetOffset.top) {
                        // On top
                        modalTop = targetOffset.top - modalHeight + targetHeight;
                        modalPosition = 'top';
                    }
                    else {
                        // On middle
                        modalPosition = 'bottom';
                        modalTop = targetOffset.top;
                    }
        
                    if (modalTop <= 0) {
                        modalTop = 8;
                    }
                    else if (modalTop + modalHeight >= windowHeight) {
                        modalTop = windowHeight - modalHeight - 8;
                    }
        
                    // Horizontal Position
                    modalLeft = targetOffset.left;
                    if (modalLeft + modalWidth >= windowWidth - 8) {
                        modalLeft = targetOffset.left + targetWidth - modalWidth - 8;
                    }
                    if (modalLeft < 8) {
                        modalLeft = 8;
                    }
                    if (modalPosition === 'top') {
                        modal.addClass('popover-on-top');
                    }
                    if (modalPosition === 'bottom') {
                        modal.addClass('popover-on-bottom');
                    }
                    if (target.hasClass('floating-button-to-popover') && !modal.hasClass('modal-in')) {
                        modal.addClass('popover-floating-button');
                        var diffX = (modalLeft + modalWidth / 2) - (targetOffset.left + targetWidth / 2),
                            diffY = (modalTop + modalHeight / 2) - (targetOffset.top + targetHeight / 2);
                        target
                            .addClass('floating-button-to-popover-in')
                            .transform('translate3d(' + diffX + 'px, ' + diffY + 'px,0)')
                            .transitionEnd(function (e) {
                                if (!target.hasClass('floating-button-to-popover-in')) return;
                                target
                                    .addClass('floating-button-to-popover-scale')
                                    .transform('translate3d(' + diffX + 'px, ' + diffY + 'px,0) scale(' + (modalWidth/targetWidth) + ', ' + (modalHeight/targetHeight) + ')');
                            });
        
                        modal.once('close', function () {
                            target
                                .removeClass('floating-button-to-popover-in floating-button-to-popover-scale')
                                .addClass('floating-button-to-popover-out')
                                .transform('')
                                .transitionEnd(function (e) {
                                    target.removeClass('floating-button-to-popover-out');
                                });
                        });
                        modal.once('closed', function () {
                            modal.removeClass('popover-floating-button');
                        });
                    }
        
                }
                else {
                    if ((modalHeight + modalAngleSize) < targetOffset.top) {
                        // On top
                        modalTop = targetOffset.top - modalHeight - modalAngleSize;
                    }
                    else if ((modalHeight + modalAngleSize) < windowHeight - targetOffset.top - targetHeight) {
                        // On bottom
                        modalPosition = 'bottom';
                        modalTop = targetOffset.top + targetHeight + modalAngleSize;
                    }
                    else {
                        // On middle
                        modalPosition = 'middle';
                        modalTop = targetHeight / 2 + targetOffset.top - modalHeight / 2;
                        diff = modalTop;
                        if (modalTop <= 0) {
                            modalTop = 5;
                        }
                        else if (modalTop + modalHeight >= windowHeight) {
                            modalTop = windowHeight - modalHeight - 5;
                        }
                        diff = diff - modalTop;
                    }
        
                    // Horizontal Position
                    if (modalPosition === 'top' || modalPosition === 'bottom') {
                        modalLeft = targetWidth / 2 + targetOffset.left - modalWidth / 2;
                        diff = modalLeft;
                        if (modalLeft < 5) modalLeft = 5;
                        if (modalLeft + modalWidth > windowWidth) modalLeft = windowWidth - modalWidth - 5;
                        if (modalPosition === 'top') {
                            modalAngle.addClass('on-bottom');
                        }
                        if (modalPosition === 'bottom') {
                            modalAngle.addClass('on-top');
                        }
                        diff = diff - modalLeft;
                        modalAngleLeft = (modalWidth / 2 - modalAngleSize + diff);
                        modalAngleLeft = Math.max(Math.min(modalAngleLeft, modalWidth - modalAngleSize * 2 - 13), 13);
                        modalAngle.css({left: modalAngleLeft + 'px'});
        
                    }
                    else if (modalPosition === 'middle') {
                        modalLeft = targetOffset.left - modalWidth - modalAngleSize;
                        modalAngle.addClass('on-right');
                        if (modalLeft < 5 || (modalLeft + modalWidth > windowWidth)) {
                            if (modalLeft < 5) modalLeft = targetOffset.left + targetWidth + modalAngleSize;
                            if (modalLeft + modalWidth > windowWidth) modalLeft = windowWidth - modalWidth - 5;
                            modalAngle.removeClass('on-right').addClass('on-left');
                        }
                        modalAngleTop = (modalHeight / 2 - modalAngleSize + diff);
                        modalAngleTop = Math.max(Math.min(modalAngleTop, modalHeight - modalAngleSize * 2 - 13), 13);
                        modalAngle.css({top: modalAngleTop + 'px'});
                    }
                }
        
        
                // Apply Styles
                modal.css({top: modalTop + 'px', left: modalLeft + 'px'});
            }
        
            sizePopover();
        
            $(window).on('resize', sizePopover);
        
            modal.on('close', function () {
                $(window).off('resize', sizePopover);
            });
        
            app.openModal(modal);
            return modal[0];
        };
        app.popup = function (modal, removeOnClose) {
            if (typeof removeOnClose === 'undefined') removeOnClose = true;
            if (typeof modal === 'string' && modal.indexOf('<') >= 0) {
                var _modal = document.createElement('div');
                _modal.innerHTML = modal.trim();
                if (_modal.childNodes.length > 0) {
                    modal = _modal.childNodes[0];
                    if (removeOnClose) modal.classList.add('remove-on-close');
                    $('body').append(modal);
                }
                else return false; //nothing found
            }
            modal = $(modal);
            if (modal.length === 0) return false;
            if (modal.parents('body').length === 0) {
                if (removeOnClose) modal.addClass('remove-on-close');
                $('body').append(modal[0]);
            }
            modal.show();
        
            app.openModal(modal);
            return modal[0];
        };
        app.pickerModal = function (modal, removeOnClose) {
            if (typeof removeOnClose === 'undefined') removeOnClose = true;
            if (typeof modal === 'string' && modal.indexOf('<') >= 0) {
                modal = $(modal);
                if (modal.length > 0) {
                    if (removeOnClose) modal.addClass('remove-on-close');
                    $('body').append(modal[0]);
                }
                else return false; //nothing found
            }
            modal = $(modal);
            if (modal.length === 0) return false;
            if (modal.parents('body').length === 0) {
                if (removeOnClose) modal.addClass('remove-on-close');
                $('body').append(modal[0]);
            }
            if ($('.picker-modal.modal-in:not(.modal-out)').length > 0 && !modal.hasClass('modal-in')) {
                app.closeModal('.picker-modal.modal-in:not(.modal-out)');
            }
            modal.show();
            app.openModal(modal);
            return modal[0];
        };
        app.loginScreen = function (modal) {
            if (!modal) modal = '.login-screen';
            modal = $(modal);
            if (modal.length === 0) return false;
            if ($('.login-screen.modal-in:not(.modal-out)').length > 0 && !modal.hasClass('modal-in')) {
                app.closeModal('.login-screen.modal-in:not(.modal-out)');
            }
            modal.show();
            
            app.openModal(modal);
            return modal[0];
        };
        app.openModal = function (modal) {
            modal = $(modal);
            var isModal = modal.hasClass('modal');
            if ($('.modal.modal-in:not(.modal-out)').length && app.params.modalStack && isModal) {
                app.modalStack.push(function () {
                    app.openModal(modal);
                });
                return;
            }
            // do nothing if this modal already shown
            if (true === modal.data('f7-modal-shown')) {
                return;
            }
            modal.data('f7-modal-shown', true);
            modal.once('close', function() {
               modal.removeData('f7-modal-shown');
            });
            var isPopover = modal.hasClass('popover');
            var isPopup = modal.hasClass('popup');
            var isLoginScreen = modal.hasClass('login-screen');
            var isPickerModal = modal.hasClass('picker-modal');
            if (isModal) {
                modal.show();
                modal.css({
                    marginTop: - Math.round(modal.outerHeight() / 2) + 'px'
                });
            }
        
            var overlay;
            if (!isLoginScreen && !isPickerModal) {
                if ($('.modal-overlay').length === 0 && !isPopup) {
                    $('body').append('<div class="modal-overlay"></div>');
                }
                if ($('.popup-overlay').length === 0 && isPopup) {
                    $('body').append('<div class="popup-overlay"></div>');
                }
                overlay = isPopup ? $('.popup-overlay') : $('.modal-overlay');
            }
            if (app.params.material && isPickerModal) {
                if (modal.hasClass('picker-calendar')) {
                    if ($('.picker-modal-overlay').length === 0 && !isPopup) {
                        $('body').append('<div class="picker-modal-overlay"></div>');
                    }
                    overlay = $('.picker-modal-overlay');
                }
            }
        
            //Make sure that styles are applied, trigger relayout;
            var clientLeft = modal[0].clientLeft;
        
            // Trugger open event
            modal.trigger('open');
        
            // Picker modal body class
            if (isPickerModal) {
                $('body').addClass('with-picker-modal');
            }
        
            // Init Pages and Navbars in modal
            if (modal.find('.' + app.params.viewClass).length > 0) {
                modal.find('.page').each(function () {
                    app.initPageWithCallback(this);
                });
                modal.find('.navbar').each(function () {
                    app.initNavbarWithCallback(this); 
                });
            }
        
            // Classes for transition in
            if (!isLoginScreen && !isPickerModal) overlay.addClass('modal-overlay-visible');
            if (app.params.material && isPickerModal && overlay) overlay.addClass('modal-overlay-visible');
            modal.removeClass('modal-out').addClass('modal-in').transitionEnd(function (e) {
                if (modal.hasClass('modal-out')) modal.trigger('closed');
                else modal.trigger('opened');
            });
            return true;
        };
        app.closeModal = function (modal) {
            modal = $(modal || '.modal-in');
            if (typeof modal !== 'undefined' && modal.length === 0) {
                return;
            }
            var isModal = modal.hasClass('modal');
            var isPopover = modal.hasClass('popover');
            var isPopup = modal.hasClass('popup');
            var isLoginScreen = modal.hasClass('login-screen');
            var isPickerModal = modal.hasClass('picker-modal');
        
            var removeOnClose = modal.hasClass('remove-on-close');
        
            var overlay;
            
            if (isPopup) overlay = $('.popup-overlay');
            else {
                if (isPickerModal && app.params.material) overlay = $('.picker-modal-overlay');
                else if (!isPickerModal) overlay = $('.modal-overlay');
            }
        
            if (isPopup){
                if (modal.length === $('.popup.modal-in').length) {
                    overlay.removeClass('modal-overlay-visible');
                }
            }
            else if (overlay && overlay.length > 0) {
                overlay.removeClass('modal-overlay-visible');
            }
        
            modal.trigger('close');
        
            // Picker modal body class
            if (isPickerModal) {
                $('body').removeClass('with-picker-modal');
                $('body').addClass('picker-modal-closing');
            }
        
            if (!(isPopover && !app.params.material)) {
                modal.removeClass('modal-in').addClass('modal-out').transitionEnd(function (e) {
                    if (modal.hasClass('modal-out')) modal.trigger('closed');
                    else {
                        modal.trigger('opened');
                        if (isPopover) return;
                    }
        
                    if (isPickerModal) {
                        $('body').removeClass('picker-modal-closing');
                    }
                    if (isPopup || isLoginScreen || isPickerModal || isPopover) {
                        modal.removeClass('modal-out').hide();
                        if (removeOnClose && modal.length > 0) {
                            modal.remove();
                        }
                    }
                    else {
                        modal.remove();
                    }
                });
                if (isModal && app.params.modalStack) {
                    app.modalStackClearQueue();
                }
            }
            else {
                modal.removeClass('modal-in modal-out').trigger('closed').hide();
                if (removeOnClose) {
                    modal.remove();
                }
            }
            return true;
        };
        

        /*===============================================================================
        ************   Progress Bar   ************
        ===============================================================================*/
        app.setProgressbar = function (container, progress, speed) {
            container = $(container || 'body');
            if (container.length === 0) return;
            if (progress) progress = Math.min(Math.max(progress, 0), 100);
            var progressbar;
            if (container.hasClass('progressbar')) progressbar = container;
            else {
                progressbar = container.children('.progressbar');
            }
            if (progressbar.length === 0 || progressbar.hasClass('progressbar-infinite')) return;
            var clientLeft = progressbar[0].clientLeft;
            progressbar.children('span').transform('translate3d(' + (-100 + progress) + '%,0,0)');
            if (typeof speed !== 'undefined') {
                progressbar.children('span').transition(speed);
            }
            else {
                progressbar.children('span').transition('');
            }
            return progressbar[0];
        };
        app.showProgressbar = function (container, progress, color) {
            if (typeof container === 'number') {
                container = 'body';
                progress = arguments[0];
                color = arguments[1];
            }
            if (progress && typeof progress === 'string' && parseFloat(progress) !== progress * 1) {
                color = progress;
                progress = undefined;
            }
            container = $(container || 'body');
            if (container.length === 0) return;
            var progressbar;
            if (container.hasClass('progressbar')) progressbar = container;
            else {
                progressbar = container.children('.progressbar:not(.progressbar-out), .progressbar-infinite:not(.progressbar-out)');
                if (progressbar.length === 0) {
                    // Create one
                    if (typeof progress !== 'undefined') {
                        // Determined
                        progressbar = $('<span class="progressbar progressbar-in' + (color ? ' color-' + color : '') + '"><span></span></span>');
                    }
                    else {
                        // Infinite
                        progressbar = $('<span class="progressbar-infinite progressbar-in' + (color ? ' color-' + color : '') + '"></span>');
                    }
                    container.append(progressbar);
                }
            }
            if (progress) app.setProgressbar(container, progress);
            return progressbar[0];
        };
        app.hideProgressbar = function (container) {
            container = $(container || 'body');
            if (container.length === 0) return;
            var progressbar;
            if (container.hasClass('progressbar')) progressbar = container;
            else {
                progressbar = container.children('.progressbar, .progressbar-infinite');
            }
            if (progressbar.length === 0 || !progressbar.hasClass('progressbar-in') || progressbar.hasClass('progressbar-out')) return;
            progressbar.removeClass('progressbar-in').addClass('progressbar-out').animationEnd(function () {
                progressbar.remove();
                progressbar = null;
            });
            return;
        };
        app.initPageProgressbar = function (pageContainer) {
            pageContainer = $(pageContainer);
            pageContainer.find('.progressbar').each(function () {
                var p = $(this);
                if (p.children('span').length === 0) p.append('<span></span>');
                if (p.attr('data-progress')) app.setProgressbar(p, p.attr('data-progress'));
            });
        };

        /*======================================================
        ************   Panels   ************
        ======================================================*/
        app.allowPanelOpen = true;
        app.openPanel = function (panelPosition) {
            if (!app.allowPanelOpen) return false;
            var panel = $('.panel-' + panelPosition);
            if (panel.length === 0 || panel.hasClass('active')) return false;
            app.closePanel(); // Close if some panel is opened
            app.allowPanelOpen = false;
            var effect = panel.hasClass('panel-reveal') ? 'reveal' : 'cover';
            panel.css({display: 'block'}).addClass('active');
            panel.trigger('open');
            if (app.params.material) {
                $('.panel-overlay').show();
            }
            if (panel.find('.' + app.params.viewClass).length > 0) {
                if (app.sizeNavbars) app.sizeNavbars(panel.find('.' + app.params.viewClass)[0]);
            }
        
            // Trigger reLayout
            var clientLeft = panel[0].clientLeft;
            
            // Transition End;
            var transitionEndTarget = effect === 'reveal' ? $('.' + app.params.viewsClass) : panel;
            var openedTriggered = false;
            
            function panelTransitionEnd() {
                transitionEndTarget.transitionEnd(function (e) {
                    if ($(e.target).is(transitionEndTarget)) {
                        if (panel.hasClass('active')) {
                            panel.trigger('opened');
                        }
                        else {
                            panel.trigger('closed');
                        }
                        if (app.params.material) $('.panel-overlay').css({display: ''});
                        app.allowPanelOpen = true;
                    }
                    else panelTransitionEnd();
                });
            }
            panelTransitionEnd();
        
            $('body').addClass('with-panel-' + panelPosition + '-' + effect);
            return true;
        };
        app.closePanel = function () {
            var activePanel = $('.panel.active');
            if (activePanel.length === 0) return false;
            var effect = activePanel.hasClass('panel-reveal') ? 'reveal' : 'cover';
            var panelPosition = activePanel.hasClass('panel-left') ? 'left' : 'right';
            activePanel.removeClass('active');
            var transitionEndTarget = effect === 'reveal' ? $('.' + app.params.viewsClass) : activePanel;
            activePanel.trigger('close');
            app.allowPanelOpen = false;
        
            transitionEndTarget.transitionEnd(function () {
                if (activePanel.hasClass('active')) return;
                activePanel.css({display: ''});
                activePanel.trigger('closed');
                $('body').removeClass('panel-closing');
                app.allowPanelOpen = true;
            });
        
            $('body').addClass('panel-closing').removeClass('with-panel-' + panelPosition + '-' + effect);
        };
        /*======================================================
        ************   Swipe panels   ************
        ======================================================*/
        app.initSwipePanels = function () {
            var panel, side;
            if (app.params.swipePanel) {
                panel = $('.panel.panel-' + app.params.swipePanel);
                side = app.params.swipePanel;
                if (panel.length === 0) return;
            }
            else {
                if (app.params.swipePanelOnlyClose) {
                    if ($('.panel').length === 0) return;
                }
                else return;
            }
            
            var panelOverlay = $('.panel-overlay');
            var isTouched, isMoved, isScrolling, touchesStart = {}, touchStartTime, touchesDiff, translate, overlayOpacity, opened, panelWidth, effect, direction;
            var views = $('.' + app.params.viewsClass);
        
            function handleTouchStart(e) {
                if (!app.allowPanelOpen || (!app.params.swipePanel && !app.params.swipePanelOnlyClose) || isTouched) return;
                if ($('.modal-in, .photo-browser-in').length > 0) return;
                if (!(app.params.swipePanelCloseOpposite || app.params.swipePanelOnlyClose)) {
                    if ($('.panel.active').length > 0 && !panel.hasClass('active')) return;
                }
                touchesStart.x = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
                touchesStart.y = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                if (app.params.swipePanelCloseOpposite || app.params.swipePanelOnlyClose) {
                    if ($('.panel.active').length > 0) {
                        side = $('.panel.active').hasClass('panel-left') ? 'left' : 'right';
                    }
                    else {
                        if (app.params.swipePanelOnlyClose) return;
                        side = app.params.swipePanel;
                    }
                    if (!side) return;
                }
                panel = $('.panel.panel-' + side);
                opened = panel.hasClass('active');
                if (app.params.swipePanelActiveArea && !opened) {
                    if (side === 'left') {
                        if (touchesStart.x > app.params.swipePanelActiveArea) return;
                    }
                    if (side === 'right') {
                        if (touchesStart.x < window.innerWidth - app.params.swipePanelActiveArea) return;
                    }
                }
                isMoved = false;
                isTouched = true;
                isScrolling = undefined;
                
                touchStartTime = (new Date()).getTime();
                direction = undefined;
            }
            function handleTouchMove(e) {
                if (!isTouched) return;
                if (e.f7PreventPanelSwipe) return;
                var pageX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                var pageY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                if (typeof isScrolling === 'undefined') {
                    isScrolling = !!(isScrolling || Math.abs(pageY - touchesStart.y) > Math.abs(pageX - touchesStart.x));
                }
                if (isScrolling) {
                    isTouched = false;
                    return;
                }
                if (!direction) {
                    if (pageX > touchesStart.x) {
                        direction = 'to-right';
                    }
                    else {
                        direction = 'to-left';
                    }
        
                    if (
                        side === 'left' &&
                        (
                            direction === 'to-left' && !panel.hasClass('active')
                        ) ||
                        side === 'right' &&
                        (
                            direction === 'to-right' && !panel.hasClass('active')
                        )
                    )
                    {
                        isTouched = false;
                        return;
                    }
                }
        
                if (app.params.swipePanelNoFollow) {
                    var timeDiff = (new Date()).getTime() - touchStartTime;
                    if (timeDiff < 300) {
                        if (direction === 'to-left') {
                            if (side === 'right') app.openPanel(side);
                            if (side === 'left' && panel.hasClass('active')) app.closePanel();
                        }
                        if (direction === 'to-right') {
                            if (side === 'left') app.openPanel(side);
                            if (side === 'right' && panel.hasClass('active')) app.closePanel();
                        }
                    }
                    isTouched = false;
                    isMoved = false;
                    return;
                }
        
                if (!isMoved) {
                    effect = panel.hasClass('panel-cover') ? 'cover' : 'reveal';
                    if (!opened) {
                        panel.show();
                        panelOverlay.show();
                    }
                    panelWidth = panel[0].offsetWidth;
                    panel.transition(0);
                    if (panel.find('.' + app.params.viewClass).length > 0) {
                        if (app.sizeNavbars) app.sizeNavbars(panel.find('.' + app.params.viewClass)[0]);
                    }
                }
        
                isMoved = true;
        
                e.preventDefault();
                var threshold = opened ? 0 : -app.params.swipePanelThreshold;
                if (side === 'right') threshold = -threshold;
                
                touchesDiff = pageX - touchesStart.x + threshold;
        
                if (side === 'right') {
                    translate = touchesDiff  - (opened ? panelWidth : 0);
                    if (translate > 0) translate = 0;
                    if (translate < -panelWidth) {
                        translate = -panelWidth;
                    }
                }
                else {
                    translate = touchesDiff  + (opened ? panelWidth : 0);
                    if (translate < 0) translate = 0;
                    if (translate > panelWidth) {
                        translate = panelWidth;
                    }
                }
                if (effect === 'reveal') {
                    views.transform('translate3d(' + translate + 'px,0,0)').transition(0);
                    panelOverlay.transform('translate3d(' + translate + 'px,0,0)').transition(0);
                    
                    app.pluginHook('swipePanelSetTransform', views[0], panel[0], Math.abs(translate / panelWidth));
                }
                else {
                    panel.transform('translate3d(' + translate + 'px,0,0)').transition(0);
                    if (app.params.material) {
                        panelOverlay.transition(0);
                        overlayOpacity = Math.abs(translate/panelWidth);
                        panelOverlay.css({opacity: overlayOpacity});
                    }
                    app.pluginHook('swipePanelSetTransform', views[0], panel[0], Math.abs(translate / panelWidth));
                }
            }
            function handleTouchEnd(e) {
                if (!isTouched || !isMoved) {
                    isTouched = false;
                    isMoved = false;
                    return;
                }
                isTouched = false;
                isMoved = false;
                var timeDiff = (new Date()).getTime() - touchStartTime;
                var action;
                var edge = (translate === 0 || Math.abs(translate) === panelWidth);
        
                if (!opened) {
                    if (translate === 0) {
                        action = 'reset';
                    }
                    else if (
                        timeDiff < 300 && Math.abs(translate) > 0 ||
                        timeDiff >= 300 && (Math.abs(translate) >= panelWidth / 2)
                    ) {
                        action = 'swap';
                    }
                    else {
                        action = 'reset';
                    }
                }
                else {
                    if (translate === -panelWidth) {
                        action = 'reset';
                    }
                    else if (
                        timeDiff < 300 && Math.abs(translate) >= 0 ||
                        timeDiff >= 300 && (Math.abs(translate) <= panelWidth / 2)
                    ) {
                        if (side === 'left' && translate === panelWidth) action = 'reset';
                        else action = 'swap';
                    }
                    else {
                        action = 'reset';
                    }
                }
                if (action === 'swap') {
                    app.allowPanelOpen = true;
                    if (opened) {
                        app.closePanel();
                        if (edge) {
                            panel.css({display: ''});
                            $('body').removeClass('panel-closing');
                        }
                    }
                    else {
                        app.openPanel(side);
                    }
                    if (edge) app.allowPanelOpen = true;
                }
                if (action === 'reset') {
                    if (opened) {
                        app.allowPanelOpen = true;
                        app.openPanel(side);
                    }
                    else {
                        app.closePanel();
                        if (edge) {
                            app.allowPanelOpen = true;
                            panel.css({display: ''});
                        }
                        else {
                            var target = effect === 'reveal' ? views : panel;
                            panel.trigger('close');
                            $('body').addClass('panel-closing');
                            target.transitionEnd(function () {
                                panel.trigger('closed');
                                panel.css({display: ''});
                                $('body').removeClass('panel-closing');
                                app.allowPanelOpen = true;
                            });
                        }
                    }
                }
                if (effect === 'reveal') {
                    views.transition('');
                    views.transform('');
                }
                panel.transition('').transform('');
                panelOverlay.css({display: ''}).transform('').transition('').css('opacity', '');
            }
            $(document).on(app.touchEvents.start, handleTouchStart);
            $(document).on(app.touchEvents.move, handleTouchMove);
            $(document).on(app.touchEvents.end, handleTouchEnd);
        };
        

        /*======================================================
        ************   Image Lazy Loading   ************
        ************   Based on solution by Marc Godard, https://github.com/MarcGodard   ************
        ======================================================*/
        app.initImagesLazyLoad = function (pageContainer) {
            pageContainer = $(pageContainer);
        
            // Lazy images
            var lazyLoadImages;
            if (pageContainer.hasClass('lazy')) {
                lazyLoadImages = pageContainer;
                pageContainer = lazyLoadImages.parents('.page');
            }
            else {
                lazyLoadImages = pageContainer.find('.lazy');
            }
            if (lazyLoadImages.length === 0) return;
        
            // Scrollable page content
            var pageContent;
            if (pageContainer.hasClass('page-content'))  {
                pageContent = pageContainer;
                pageContainer = pageContainer.parents('.page');
            }
            else  {
                pageContent = pageContainer.find('.page-content');
            }
            if (pageContent.length === 0) return;
        
            // Placeholder
            var placeholderSrc = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAA1BMVEXCwsK592mkAAAACklEQVQI12NgAAAAAgAB4iG8MwAAAABJRU5ErkJggg==';
            if (typeof app.params.imagesLazyLoadPlaceholder === 'string') {
                placeholderSrc = app.params.imagesLazyLoadPlaceholder;
            }
            if (app.params.imagesLazyLoadPlaceholder !== false) lazyLoadImages.each(function(){
                if ($(this).attr('data-src')) $(this).attr('src', placeholderSrc);
            });
        
            // load image
            var imagesSequence = [];
            var imageIsLoading = false;
            function loadImage(el) {
                el = $(el);
        
                var bg = el.attr('data-background');
                var src = bg ? bg : el.attr('data-src');
                if (!src) return;
        
                function onLoad() {
                    el.removeClass('lazy').addClass('lazy-loaded');
                    if (bg) {
                        el.css('background-image', 'url(' + src + ')');
                    }
                    else {
                        el.attr('src', src);
                    }
        
                    if (app.params.imagesLazyLoadSequential) {
                        imageIsLoading = false;
                        if (imagesSequence.length > 0) {
                            loadImage(imagesSequence.shift());
                        }
                    }
                }
        
                if (app.params.imagesLazyLoadSequential) {
                    if (imageIsLoading) {
                        if (imagesSequence.indexOf(el[0]) < 0) imagesSequence.push(el[0]);
                        return;
                    }
                }
        
                // Loading flag
                imageIsLoading = true;
                
                var image = new Image();
                image.onload = onLoad;
                image.onerror = onLoad;
                image.src =src;
            }
            function lazyHandler() {
                lazyLoadImages = pageContainer.find('.lazy');
                lazyLoadImages.each(function(index, el) {
                    el = $(el);
                    if (el.parents('.tab:not(.active)').length > 0) {
                        return;
                    }
                    if (isElementInViewport(el[0])) {
                        loadImage(el);
                    }
                });
            }
        
            function isElementInViewport (el) {
                var rect = el.getBoundingClientRect();
                var threshold = app.params.imagesLazyLoadThreshold || 0;
                return (
                    rect.top >= (0 - threshold) &&
                    rect.left >= (0 - threshold) &&
                    rect.top <= (window.innerHeight + threshold) &&
                    rect.left <= (window.innerWidth + threshold)
                );
            }
        
            function attachEvents(destroy) {
                var method = destroy ? 'off' : 'on';
                lazyLoadImages[method]('lazy', lazyHandler);
                lazyLoadImages.parents('.tab')[method]('show', lazyHandler);
                pageContainer[method]('lazy', lazyHandler);
                pageContent[method]('lazy', lazyHandler);
                pageContent[method]('scroll', lazyHandler);
                $(window)[method]('resize', lazyHandler);
            }
            function detachEvents() {
                attachEvents(true);
            }
        
            // Store detach function
            pageContainer[0].f7DestroyImagesLazyLoad = detachEvents;
        
            // Attach events
            attachEvents();
        
            // Destroy on page remove
            if (pageContainer.hasClass('page')) {
                pageContainer.once('pageBeforeRemove', detachEvents);
            }
        
            // Run loader on page load/init
            lazyHandler();
        
            // Run after page animation
            pageContainer.once('pageAfterAnimation', lazyHandler);
        };
        app.destroyImagesLazyLoad = function (pageContainer) {
            pageContainer = $(pageContainer);
            if (pageContainer.length > 0 && pageContainer[0].f7DestroyImagesLazyLoad) {
                pageContainer[0].f7DestroyImagesLazyLoad();
            }
        };
        app.reinitImagesLazyLoad = function (pageContainer) {
            pageContainer = $(pageContainer);
            if (pageContainer.length > 0) {
                pageContainer.trigger('lazy');
            }
        };

        /*======================================================
        ************   Material Preloader   ************
        ======================================================*/
        app.initPageMaterialPreloader = function (pageContainer) {
            $(pageContainer).find('.preloader').each(function () {
                if ($(this).children().length === 0) {
                    $(this).html(app.params.materialPreloaderHtml);
                }
            });
        };

        /*======================================================
        ************   Messages   ************
        ======================================================*/
        var Messages = function (container, params) {
            var defaults = {
                autoLayout: true,
                newMessagesFirst: false,
                messageTemplate: 
                    '{{#if day}}' +
                    '<div class="messages-date">{{day}} {{#if time}}, <span>{{time}}</span>{{/if}}</div>' +
                    '{{/if}}' +
                    '<div class="message message-{{type}} {{#if hasImage}}message-pic{{/if}} {{#if avatar}}message-with-avatar{{/if}} {{#if position}}message-appear-from-{{position}}{{/if}}">' +
                        '{{#if name}}<div class="message-name">{{name}}</div>{{/if}}' +
                        '<div class="message-text">{{text}}{{#if date}}<div class="message-date">{{date}}</div>{{/if}}</div>' +
                        '{{#if avatar}}<div class="message-avatar" style="background-image:url({{avatar}})"></div>{{/if}}' +
                        '{{#if label}}<div class="message-label">{{label}}</div>{{/if}}' +
                    '</div>'
            };
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined' || params[def] === null) {
                    params[def] = defaults[def];
                }
            }
        
            // Instance
            var m = this;
        
            // Params
            m.params = params;
        
            // Container
            m.container = $(container);
            if (m.container.length === 0) return;
        
            // Autolayout
            if (m.params.autoLayout) m.container.addClass('messages-auto-layout');
        
            // New messages first
            if (m.params.newMessagesFirst) m.container.addClass('messages-new-first');
        
            // Is In Page
            m.pageContainer = m.container.parents('.page').eq(0);
            m.pageContent = m.pageContainer.find('.page-content');
        
            // Compiled template
            m.template = Template7.compile(m.params.messageTemplate);
        
            // Auto Layout
            m.layout = function () {
                if (!m.container.hasClass('messages-auto-layout')) m.container.addClass('messages-auto-layout');
                m.container.find('.message').each(function () {
                    var message = $(this);
                    if (message.find('.message-text img').length > 0) message.addClass('message-pic');
                    if (message.find('.message-avatar').length > 0) message.addClass('message-with-avatar');
                });
                m.container.find('.message').each(function () {
                    var message = $(this);
                    var isSent = message.hasClass('message-sent');
                    var next = message.next('.message-' + (isSent ? 'sent' : 'received'));
                    var prev = message.prev('.message-' + (isSent ? 'sent' : 'received'));
                    if (next.length === 0) {
                        message.addClass('message-last message-with-tail');
                    }
                    else message.removeClass('message-last message-with-tail');
        
                    if (prev.length === 0) {
                        message.addClass('message-first');
                    }
                    else message.removeClass('message-first');
        
                    if (prev.length > 0 && prev.find('.message-name').length > 0 && message.find('.message-name').length > 0) {
                        if (prev.find('.message-name').text() !== message.find('.message-name').text()) {
                            prev.addClass('message-last message-with-tail');
                            message.addClass('message-first');
                        }
                    }
                });
                
            };
        
            // Add Message
            m.appendMessage = function (props, animate) {
                return m.addMessage(props, 'append', animate);
            };
            m.prependMessage = function (props, animate) {
                return m.addMessage(props, 'prepend', animate);
            };
            m.addMessage = function (props, method, animate) {
                return m.addMessages([props], method, animate);
            };
            m.addMessages = function (newMessages, method, animate) {
                if (typeof animate === 'undefined') {
                    animate = true;
                }
                if (typeof method === 'undefined') {
                    method = m.params.newMessagesFirst ? 'prepend' : 'append';
                }
                var newMessagesHTML = '', i;
                for (i = 0; i < newMessages.length; i++) {
                    var props = newMessages[i] || {};
                    props.type = props.type || 'sent';
                    if (!props.text) continue;
                    props.hasImage = props.text.indexOf('<img') >= 0;
                    if (animate) props.position = method === 'append' ? 'bottom' : 'top';
        
                    newMessagesHTML += m.template(props);
                }
                var heightBefore, scrollBefore;
                if (method === 'prepend') {
                    heightBefore = m.pageContent[0].scrollHeight;
                    scrollBefore = m.pageContent[0].scrollTop;
                }
                m.container[method](newMessagesHTML);
                if (m.params.autoLayout) m.layout();
                if (method === 'prepend') {
                    m.pageContent[0].scrollTop = scrollBefore + (m.pageContent[0].scrollHeight - heightBefore);
                }
                if ((method === 'append' && !m.params.newMessagesFirst) || (method === 'prepend' && m.params.newMessagesFirst)) {
                    m.scrollMessages(animate ? undefined : 0);
                }
                var messages = m.container.find('.message');
                if (newMessages.length === 1) {
                    return method === 'append' ? messages[messages.length - 1] : messages[0];
                }
                else {
                    var messagesToReturn = [];
                    if (method === 'append') {
                        for (i = messages.length - newMessages.length; i < messages.length; i++) {
                            messagesToReturn.push(messages[i]);
                        }
                    }
                    else {
                        for (i = 0; i < newMessages.length; i++) {
                            messagesToReturn.push(messages[i]);
                        }   
                    }
                    return messagesToReturn;
                }
                
            };
            m.removeMessage = function (message) {
                message = $(message);
                if (message.length === 0) {
                    return false;
                }
                else {
                    message.remove();
                    if (m.params.autoLayout) m.layout();
                    return true;
                }
            };
            m.removeMessages = function (messages) {
                m.removeMessage(messages);
            };
            m.clean = function () {
                m.container.html('');
            };
        
            // Scroll
            m.scrollMessages = function (duration, scrollTop) {
                if (typeof duration === 'undefined') duration = 400;
                var currentScroll = m.pageContent[0].scrollTop;
                var newScroll;
                if (typeof scrollTop !== 'undefined') newScroll = scrollTop;
                else {
                    newScroll = m.params.newMessagesFirst ? 0 : m.pageContent[0].scrollHeight - m.pageContent[0].offsetHeight;
                    if (newScroll === currentScroll) return;
                }
                m.pageContent.scrollTop(newScroll, duration);
            };
        
            // Init Destroy
            m.init = function () {
                if (m.params.messages) {
                    m.addMessages(m.params.messages, undefined, false);
                }
                else {
                    if (m.params.autoLayout) m.layout();    
                    m.scrollMessages(0);
                }
                
            };
            m.destroy = function () {
                m = null;
            };
        
            // Init
            m.init();
        
            m.container[0].f7Messages = m;
            return m;
        };
        app.messages = function (container, params) {
            return new Messages (container, params);
        };
        app.initPageMessages = function (pageContainer) {
            pageContainer = $(pageContainer);
            var messages = pageContainer.find('.messages');
            if (messages.length === 0) return;
            if (!messages.hasClass('messages-init')) {
                return;
            }
            var m = app.messages(messages, messages.dataset());
        
            // Destroy on page remove
            function pageBeforeRemove() {
                m.destroy();
                pageContainer.off('pageBeforeRemove', pageBeforeRemove);
            }
            if (pageContainer.hasClass('page')) {
                pageContainer.on('pageBeforeRemove', pageBeforeRemove);
            }
        };
        

        /*===============================================================================
        ************   Swipeout Actions (Swipe to delete)   ************
        ===============================================================================*/
        app.swipeoutOpenedEl = undefined;
        app.allowSwipeout = true;
        app.initSwipeout = function (swipeoutEl) {
            var isTouched, isMoved, isScrolling, touchesStart = {}, touchStartTime, touchesDiff, swipeOutEl, swipeOutContent, actionsRight, actionsLeft, actionsLeftWidth, actionsRightWidth, translate, opened, openedActions, buttonsLeft, buttonsRight, direction, overswipeLeftButton, overswipeRightButton, overswipeLeft, overswipeRight, noFoldLeft, noFoldRight;
            $(document).on(app.touchEvents.start, function (e) {
                if (app.swipeoutOpenedEl) {
                    var target = $(e.target);
                    if (!(
                        app.swipeoutOpenedEl.is(target[0]) ||
                        target.parents('.swipeout').is(app.swipeoutOpenedEl) ||
                        target.hasClass('modal-in') ||
                        target.hasClass('modal-overlay') ||
                        target.hasClass('actions-modal') || 
                        target.parents('.actions-modal.modal-in, .modal.modal-in').length > 0
                        )) {
                        app.swipeoutClose(app.swipeoutOpenedEl);
                    }
                }
            });
        
            function handleTouchStart(e) {
                if (!app.allowSwipeout) return;
                isMoved = false;
                isTouched = true;
                isScrolling = undefined;
                touchesStart.x = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
                touchesStart.y = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                touchStartTime = (new Date()).getTime();
            }
            function handleTouchMove(e) {
                if (!isTouched) return;
                var pageX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                var pageY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                if (typeof isScrolling === 'undefined') {
                    isScrolling = !!(isScrolling || Math.abs(pageY - touchesStart.y) > Math.abs(pageX - touchesStart.x));
                }
                if (isScrolling) {
                    isTouched = false;
                    return;
                }
        
                if (!isMoved) {
                    if ($('.list-block.sortable-opened').length > 0) return;
                    /*jshint validthis:true */
                    swipeOutEl = $(this);
                    swipeOutContent = swipeOutEl.find('.swipeout-content');
                    actionsRight = swipeOutEl.find('.swipeout-actions-right');
                    actionsLeft = swipeOutEl.find('.swipeout-actions-left');
                    actionsLeftWidth = actionsRightWidth = buttonsLeft = buttonsRight = overswipeRightButton = overswipeLeftButton = null;
                    noFoldLeft = actionsLeft.hasClass('swipeout-actions-no-fold') || app.params.swipeoutActionsNoFold;
                    noFoldRight = actionsRight.hasClass('swipeout-actions-no-fold') || app.params.swipeoutActionsNoFold;
                    if (actionsLeft.length > 0) {
                        actionsLeftWidth = actionsLeft.outerWidth();
                        buttonsLeft = actionsLeft.children('a');
                        overswipeLeftButton = actionsLeft.find('.swipeout-overswipe');
                    }
                    if (actionsRight.length > 0) {
                        actionsRightWidth = actionsRight.outerWidth();
                        buttonsRight = actionsRight.children('a');
                        overswipeRightButton = actionsRight.find('.swipeout-overswipe');
                    }
                    opened = swipeOutEl.hasClass('swipeout-opened');
                    if (opened) {
                        openedActions = swipeOutEl.find('.swipeout-actions-left.swipeout-actions-opened').length > 0 ? 'left' : 'right';
                    }
                    swipeOutEl.removeClass('transitioning');
                    if (!app.params.swipeoutNoFollow) {
                        swipeOutEl.find('.swipeout-actions-opened').removeClass('swipeout-actions-opened');
                        swipeOutEl.removeClass('swipeout-opened');
                    }
                }
                isMoved = true;
                e.preventDefault();
                
                touchesDiff = pageX - touchesStart.x;
                translate = touchesDiff;
        
                if (opened) {
                    if (openedActions === 'right') translate = translate - actionsRightWidth;
                    else translate = translate + actionsLeftWidth;
                }
        
                if (translate > 0 && actionsLeft.length === 0 || translate < 0 && actionsRight.length === 0) {
                    if (!opened) {
                        isTouched = isMoved = false;
                        swipeOutContent.transform('');
                        if (buttonsRight && buttonsRight.length > 0) {
                            buttonsRight.transform('');
                        }
                        if (buttonsLeft && buttonsLeft.length > 0) {
                            buttonsLeft.transform('');
                        }
                        return;
                    }
                    translate = 0;
                }
        
                if (translate < 0) direction = 'to-left';
                else if (translate > 0) direction = 'to-right';
                else {
                    if (direction) direction = direction;
                    else direction = 'to-left';
                }
                
                var i, buttonOffset, progress;
                
                e.f7PreventPanelSwipe = true;
                if (app.params.swipeoutNoFollow) {
                    if (opened) {
                        if (openedActions === 'right' && touchesDiff > 0) {
                            app.swipeoutClose(swipeOutEl);
                        }
                        if (openedActions === 'left' && touchesDiff < 0) {
                            app.swipeoutClose(swipeOutEl);
                        }
                    }
                    else {
                        if (touchesDiff < 0 && actionsRight.length > 0) {
                            app.swipeoutOpen(swipeOutEl, 'right');
                        }
                        if (touchesDiff > 0 && actionsLeft.length > 0) {
                            app.swipeoutOpen(swipeOutEl, 'left');
                        }
                    }
                    isTouched = false;
                    isMoved = false;
                    return;
                }
                overswipeLeft = false;
                overswipeRight = false;
                var $button;
                if (actionsRight.length > 0) {
                    // Show right actions
                    progress = translate / actionsRightWidth;
                    if (translate < -actionsRightWidth) {
                        translate = -actionsRightWidth - Math.pow(-translate - actionsRightWidth, 0.8);
                        if (overswipeRightButton.length > 0) {
                            overswipeRight = true;
                        }
                    }
                    for (i = 0; i < buttonsRight.length; i++) {
                        if (typeof buttonsRight[i]._buttonOffset === 'undefined') {
                            buttonsRight[i]._buttonOffset = buttonsRight[i].offsetLeft;
                        }
                        buttonOffset = buttonsRight[i]._buttonOffset;
                        $button = $(buttonsRight[i]);
                        if (overswipeRightButton.length > 0 && $button.hasClass('swipeout-overswipe')) {
                            $button.css({left: (overswipeRight ? -buttonOffset : 0) + 'px'});
                            if (overswipeRight) {
                                $button.addClass('swipeout-overswipe-active');
                            }
                            else {
                                $button.removeClass('swipeout-overswipe-active');   
                            }
                        }
                        $button.transform('translate3d(' + (translate - buttonOffset * (1 + Math.max(progress, -1))) + 'px,0,0)');
                    }
                }
                if (actionsLeft.length > 0) {
                    // Show left actions
                    progress = translate / actionsLeftWidth;
                    if (translate > actionsLeftWidth) {
                        translate = actionsLeftWidth + Math.pow(translate - actionsLeftWidth, 0.8);
                        if (overswipeLeftButton.length > 0) {
                            overswipeLeft = true;
                        }
                    }
                    for (i = 0; i < buttonsLeft.length; i++) {
                        if (typeof buttonsLeft[i]._buttonOffset === 'undefined') {
                            buttonsLeft[i]._buttonOffset = actionsLeftWidth - buttonsLeft[i].offsetLeft - buttonsLeft[i].offsetWidth;
                        }
                        buttonOffset = buttonsLeft[i]._buttonOffset;
                        $button = $(buttonsLeft[i]);
                        if (overswipeLeftButton.length > 0 && $button.hasClass('swipeout-overswipe')) {
                            $button.css({left: (overswipeLeft ? buttonOffset : 0) + 'px'});
                            if (overswipeLeft) {
                                $button.addClass('swipeout-overswipe-active');
                            }
                            else {
                                $button.removeClass('swipeout-overswipe-active');   
                            }
                        }
                        if (buttonsLeft.length > 1) {
                            $button.css('z-index', buttonsLeft.length - i); 
                        }
                        $button.transform('translate3d(' + (translate + buttonOffset * (1 - Math.min(progress, 1))) + 'px,0,0)');
                    }
                }
                swipeOutContent.transform('translate3d(' + translate + 'px,0,0)');
            }
            function handleTouchEnd(e) {
                if (!isTouched || !isMoved) {
                    isTouched = false;
                    isMoved = false;
                    return;
                }
        
                isTouched = false;
                isMoved = false;
                var timeDiff = (new Date()).getTime() - touchStartTime;
                var action, actionsWidth, actions, buttons, i, noFold;
                
                noFold = direction === 'to-left' ? noFoldRight : noFoldLeft;
                actions = direction === 'to-left' ? actionsRight : actionsLeft;
                actionsWidth = direction === 'to-left' ? actionsRightWidth : actionsLeftWidth;
        
                if (
                    timeDiff < 300 && (touchesDiff < -10 && direction === 'to-left' || touchesDiff > 10 && direction === 'to-right') ||
                    timeDiff >= 300 && Math.abs(translate) > actionsWidth / 2
                ) {
                    action = 'open';
                }
                else {
                    action = 'close';
                }
                if (timeDiff < 300) {
                    if (Math.abs(translate) === 0) action = 'close';
                    if (Math.abs(translate) === actionsWidth) action = 'open';
                }
                
                if (action === 'open') {
                    app.swipeoutOpenedEl = swipeOutEl;
                    swipeOutEl.trigger('open');
                    swipeOutEl.addClass('swipeout-opened transitioning');
                    var newTranslate = direction === 'to-left' ? -actionsWidth : actionsWidth;
                    swipeOutContent.transform('translate3d(' + newTranslate + 'px,0,0)');
                    actions.addClass('swipeout-actions-opened');
                    buttons = direction === 'to-left' ? buttonsRight : buttonsLeft;
                    if (buttons) {
                        for (i = 0; i < buttons.length; i++) {
                            $(buttons[i]).transform('translate3d(' + newTranslate + 'px,0,0)');
                        }
                    }
                    if (overswipeRight) {
                        actionsRight.find('.swipeout-overswipe')[0].click();
                    }
                    if (overswipeLeft) {
                        actionsLeft.find('.swipeout-overswipe')[0].click();
                    }
                }
                else {
                    swipeOutEl.trigger('close');
                    app.swipeoutOpenedEl = undefined;
                    swipeOutEl.addClass('transitioning').removeClass('swipeout-opened');
                    swipeOutContent.transform('');
                    actions.removeClass('swipeout-actions-opened');
                }
                
                var buttonOffset;
                if (buttonsLeft && buttonsLeft.length > 0 && buttonsLeft !== buttons) {
                    for (i = 0; i < buttonsLeft.length; i++) {
                        buttonOffset = buttonsLeft[i]._buttonOffset;
                        if (typeof buttonOffset === 'undefined') {
                            buttonsLeft[i]._buttonOffset = actionsLeftWidth - buttonsLeft[i].offsetLeft - buttonsLeft[i].offsetWidth;
                        }
                        $(buttonsLeft[i]).transform('translate3d(' + (buttonOffset) + 'px,0,0)');
                    }
                }
                if (buttonsRight && buttonsRight.length > 0 && buttonsRight !== buttons) {
                    for (i = 0; i < buttonsRight.length; i++) {
                        buttonOffset = buttonsRight[i]._buttonOffset;
                        if (typeof buttonOffset === 'undefined') {
                            buttonsRight[i]._buttonOffset = buttonsRight[i].offsetLeft;
                        }
                        $(buttonsRight[i]).transform('translate3d(' + (-buttonOffset) + 'px,0,0)');
                    }
                }
                swipeOutContent.transitionEnd(function (e) {
                    if (opened && action === 'open' || closed && action === 'close') return;
                    swipeOutEl.trigger(action === 'open' ? 'opened' : 'closed');
                    if (opened && action === 'close') {
                        if (actionsRight.length > 0) {
                            buttonsRight.transform('');
                        }
                        if (actionsLeft.length > 0) {
                            buttonsLeft.transform('');
                        }
                    }
                });
            }
            if (swipeoutEl) {
                $(swipeoutEl).on(app.touchEvents.start, handleTouchStart);
                $(swipeoutEl).on(app.touchEvents.move, handleTouchMove);
                $(swipeoutEl).on(app.touchEvents.end, handleTouchEnd);
            }
            else {
                $(document).on(app.touchEvents.start, '.list-block li.swipeout', handleTouchStart);
                $(document).on(app.touchEvents.move, '.list-block li.swipeout', handleTouchMove);
                $(document).on(app.touchEvents.end, '.list-block li.swipeout', handleTouchEnd);
            }
                
        };
        app.swipeoutOpen = function (el, dir, callback) {
            el = $(el);
            if (arguments.length === 2) {
                if (typeof arguments[1] === 'function') {
                    callback = dir;
                }
            }
        
            if (el.length === 0) return;
            if (el.length > 1) el = $(el[0]);
            if (!el.hasClass('swipeout') || el.hasClass('swipeout-opened')) return;
            if (!dir) {
                if (el.find('.swipeout-actions-right').length > 0) dir = 'right';
                else dir = 'left';
            }
            var swipeOutActions = el.find('.swipeout-actions-' + dir);
            if (swipeOutActions.length === 0) return;
            var noFold = swipeOutActions.hasClass('swipeout-actions-no-fold') || app.params.swipeoutActionsNoFold;
            el.trigger('open').addClass('swipeout-opened').removeClass('transitioning');
            swipeOutActions.addClass('swipeout-actions-opened');
            var buttons = swipeOutActions.children('a');
            var swipeOutActionsWidth = swipeOutActions.outerWidth();
            var translate = dir === 'right' ? -swipeOutActionsWidth : swipeOutActionsWidth;
            var i;
            if (buttons.length > 1) {
                for (i = 0; i < buttons.length; i++) {
                    if (dir === 'right') {
                        $(buttons[i]).transform('translate3d(' + (- buttons[i].offsetLeft) + 'px,0,0)');
                    }
                    else {
                        $(buttons[i]).css('z-index', buttons.length - i).transform('translate3d(' + (swipeOutActionsWidth - buttons[i].offsetWidth - buttons[i].offsetLeft) + 'px,0,0)');
                    }
                }
                var clientLeft = buttons[1].clientLeft;
            }
            el.addClass('transitioning');
            for (i = 0; i < buttons.length; i++) {
                $(buttons[i]).transform('translate3d(' + (translate) + 'px,0,0)');
            }
            el.find('.swipeout-content').transform('translate3d(' + translate + 'px,0,0)').transitionEnd(function () {
                el.trigger('opened');
                if (callback) callback.call(el[0]);
            });
            app.swipeoutOpenedEl = el;
        };
        app.swipeoutClose = function (el, callback) {
            el = $(el);
            if (el.length === 0) return;
            if (!el.hasClass('swipeout-opened')) return;
            var dir = el.find('.swipeout-actions-opened').hasClass('swipeout-actions-right') ? 'right' : 'left';
            var swipeOutActions = el.find('.swipeout-actions-opened').removeClass('swipeout-actions-opened');
            var noFold = swipeOutActions.hasClass('swipeout-actions-no-fold') || app.params.swipeoutActionsNoFold;
            var buttons = swipeOutActions.children('a');
            var swipeOutActionsWidth = swipeOutActions.outerWidth();
            app.allowSwipeout = false;
            el.trigger('close');
            el.removeClass('swipeout-opened').addClass('transitioning');
        
            var closeTO;
            function onSwipeoutClose() {
                app.allowSwipeout = true;
                if (el.hasClass('swipeout-opened')) return;
                el.removeClass('transitioning');
                buttons.transform('');
                el.trigger('closed');
                if (callback) callback.call(el[0]);
                if (closeTO) clearTimeout(closeTO);
            }
            el.find('.swipeout-content').transform('').transitionEnd(onSwipeoutClose);
            closeTO = setTimeout(onSwipeoutClose, 500);
            
            for (var i = 0; i < buttons.length; i++) {
                if (dir === 'right') {
                    $(buttons[i]).transform('translate3d(' + (-buttons[i].offsetLeft) + 'px,0,0)');
                }
                else {
                    $(buttons[i]).transform('translate3d(' + (swipeOutActionsWidth - buttons[i].offsetWidth - buttons[i].offsetLeft) + 'px,0,0)');
                }
                $(buttons[i]).css({left:0 + 'px'}).removeClass('swipeout-overswipe-active');
            }
            if (app.swipeoutOpenedEl && app.swipeoutOpenedEl[0] === el[0]) app.swipeoutOpenedEl = undefined;
        };
        app.swipeoutDelete = function (el, callback) {
            el = $(el);
            if (el.length === 0) return;
            if (el.length > 1) el = $(el[0]);
            app.swipeoutOpenedEl = undefined;
            el.trigger('delete');
            el.css({height: el.outerHeight() + 'px'});
            var clientLeft = el[0].clientLeft;
            el.css({height: 0 + 'px'}).addClass('deleting transitioning').transitionEnd(function () {
                el.trigger('deleted');
                if (callback) callback.call(el[0]);
                if (el.parents('.virtual-list').length > 0) {
                    var virtualList = el.parents('.virtual-list')[0].f7VirtualList;
                    var virtualIndex = el[0].f7VirtualListIndex;
                    if (virtualList && typeof virtualIndex !== 'undefined') virtualList.deleteItem(virtualIndex);
                }
                else {
                    el.remove();
                }
            });
            var translate = '-100%';
            el.find('.swipeout-content').transform('translate3d(' + translate + ',0,0)');
        };
        

        /*===============================================================================
        ************   Sortable   ************
        ===============================================================================*/
        app.sortableToggle = function (sortableContainer) {
            sortableContainer = $(sortableContainer);
            if (sortableContainer.length === 0) sortableContainer = $('.list-block.sortable');
            sortableContainer.toggleClass('sortable-opened');
            if (sortableContainer.hasClass('sortable-opened')) {
                sortableContainer.trigger('open');
            }
            else {
                sortableContainer.trigger('close');
            }
            return sortableContainer;
        };
        app.sortableOpen = function (sortableContainer) {
            sortableContainer = $(sortableContainer);
            if (sortableContainer.length === 0) sortableContainer = $('.list-block.sortable');
            sortableContainer.addClass('sortable-opened');
            sortableContainer.trigger('open');
            return sortableContainer;
        };
        app.sortableClose = function (sortableContainer) {
            sortableContainer = $(sortableContainer);
            if (sortableContainer.length === 0) sortableContainer = $('.list-block.sortable');
            sortableContainer.removeClass('sortable-opened');
            sortableContainer.trigger('close');
            return sortableContainer;
        };
        app.initSortable = function () {
            var isTouched, isMoved, touchStartY, touchesDiff, sortingEl, sortingElHeight, sortingItems, minTop, maxTop, insertAfter, insertBefore, sortableContainer;
            
            function handleTouchStart(e) {
                isMoved = false;
                isTouched = true;
                touchStartY = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                /*jshint validthis:true */
                sortingEl = $(this).parent();
                sortingItems = sortingEl.parent().find('li');
                sortableContainer = sortingEl.parents('.sortable');
                e.preventDefault();
                app.allowPanelOpen = app.allowSwipeout = false;
            }
            function handleTouchMove(e) {
                if (!isTouched || !sortingEl) return;
                var pageX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                var pageY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                if (!isMoved) {
                    sortingEl.addClass('sorting');
                    sortableContainer.addClass('sortable-sorting');
                    minTop = sortingEl[0].offsetTop;
                    maxTop = sortingEl.parent().height() - sortingEl[0].offsetTop - sortingEl.height();
                    sortingElHeight = sortingEl[0].offsetHeight;
                }
                isMoved = true;
        
                e.preventDefault();
                e.f7PreventPanelSwipe = true;
                touchesDiff = pageY - touchStartY;
                var translate = touchesDiff;
                if (translate < -minTop) translate = -minTop;
                if (translate > maxTop) translate = maxTop;
                sortingEl.transform('translate3d(0,' + translate + 'px,0)');
        
                insertBefore = insertAfter = undefined;
        
                sortingItems.each(function () {
                    var currentEl = $(this);
                    if (currentEl[0] === sortingEl[0]) return;
                    var currentElOffset = currentEl[0].offsetTop;
                    var currentElHeight = currentEl.height();
                    var sortingElOffset = sortingEl[0].offsetTop + translate;
        
                    if ((sortingElOffset >= currentElOffset - currentElHeight / 2) && sortingEl.index() < currentEl.index()) {
                        currentEl.transform('translate3d(0, '+(-sortingElHeight)+'px,0)');
                        insertAfter = currentEl;
                        insertBefore = undefined;
                    }
                    else if ((sortingElOffset <= currentElOffset + currentElHeight / 2) && sortingEl.index() > currentEl.index()) {
                        currentEl.transform('translate3d(0, '+(sortingElHeight)+'px,0)');
                        insertAfter = undefined;
                        if (!insertBefore) insertBefore = currentEl;
                    }
                    else {
                        $(this).transform('translate3d(0, 0%,0)');
                    }
                });
            }
            function handleTouchEnd(e) {
                app.allowPanelOpen = app.allowSwipeout = true;
                if (!isTouched || !isMoved) {
                    isTouched = false;
                    isMoved = false;
                    return;
                }
                e.preventDefault();
                sortingItems.transform('');
                sortingEl.removeClass('sorting');
                sortableContainer.removeClass('sortable-sorting');
                var virtualList, oldIndex, newIndex;
                if (insertAfter) {
                    sortingEl.insertAfter(insertAfter);
                    sortingEl.trigger('sort');
                }
                if (insertBefore) {
                    sortingEl.insertBefore(insertBefore);
                    sortingEl.trigger('sort');
                }
                if ((insertAfter || insertBefore) && sortableContainer.hasClass('virtual-list')) {
                    virtualList = sortableContainer[0].f7VirtualList;
                    oldIndex = sortingEl[0].f7VirtualListIndex;
                    newIndex = insertBefore ? insertBefore[0].f7VirtualListIndex : insertAfter[0].f7VirtualListIndex;
                    if (virtualList) virtualList.moveItem(oldIndex, newIndex);
                }
                insertAfter = insertBefore = undefined;
                isTouched = false;
                isMoved = false;
            }
            $(document).on(app.touchEvents.start, '.list-block.sortable .sortable-handler', handleTouchStart);
            if (app.support.touch) {
                $(document).on(app.touchEvents.move, '.list-block.sortable .sortable-handler', handleTouchMove);
                $(document).on(app.touchEvents.end, '.list-block.sortable .sortable-handler', handleTouchEnd);
            }
            else {
                $(document).on(app.touchEvents.move, handleTouchMove);
                $(document).on(app.touchEvents.end, handleTouchEnd);
            }
                
        };
        

        /*===============================================================================
        ************   Smart Select   ************
        ===============================================================================*/
        app.initSmartSelects = function (pageContainer) {
            pageContainer = $(pageContainer);
            var selects;
            if (pageContainer.is('.smart-select')) {
                selects = pageContainer;
            }
            else {
                selects = pageContainer.find('.smart-select');
            }
            if (selects.length === 0) return;
        
            selects.each(function () {
                var smartSelect = $(this);
        
                var $select = smartSelect.find('select');
                if ($select.length === 0) return;
        
                var select = $select[0];
                if (select.length === 0) return;
        
                var valueText = [];
                for (var i = 0; i < select.length; i++) {
                    if (select[i].selected) valueText.push(select[i].textContent.trim());
                }
        
                var itemAfter = smartSelect.find('.item-after');
                if (itemAfter.length === 0) {
                    smartSelect.find('.item-inner').append('<div class="item-after">' + valueText.join(', ') + '</div>');
                }
                else {
                    var selectedText = itemAfter.text();
                    if (itemAfter.hasClass('smart-select-value')) {
                        for (i = 0; i < select.length; i++) {
                            select[i].selected = select[i].textContent.trim() === selectedText.trim();
                        }
                    } else {
                        itemAfter.text(valueText.join(', '));
                    }
                }
                
            });
            
        };
        app.smartSelectAddOption = function (select, option, index) {
            select = $(select);
            var smartSelect = select.parents('.smart-select');
            if (typeof index === 'undefined') {
                select.append(option);
            }
            else {
                $(option).insertBefore(select.find('option').eq(index));
            }
            app.initSmartSelects(smartSelect);
            var selectName = smartSelect.find('select').attr('name');
            var opened = $('.page.smart-select-page[data-select-name="' + selectName + '"]').length > 0;
            if (opened) {
                app.smartSelectOpen(smartSelect, true);
            }
        };
        app.smartSelectOpen = function (smartSelect, reLayout) {
            smartSelect = $(smartSelect);
            if (smartSelect.length === 0) return;
        
            // Find related view
            var view = smartSelect.parents('.' + app.params.viewClass);
            if (view.length === 0) return;
            view = view[0].f7View;
        
            // Parameters
            var openIn = smartSelect.attr('data-open-in') || app.params.smartSelectOpenIn;
            if (openIn === 'popup') {
                if ($('.popup.smart-select-popup').length > 0) return;
            }
            else if (openIn === 'picker') {
                if ($('.picker-modal.modal-in').length > 0 && !reLayout){
                    if (smartSelect[0].f7SmartSelectPicker !== $('.picker-modal.modal-in:not(.modal-out)')[0]) app.closeModal($('.picker-modal.modal-in:not(.modal-out)'));
                    else return;
                }
            }
            else {
                if (!view) return;
            }
        
            var smartSelectData = smartSelect.dataset();
            var pageTitle = smartSelectData.pageTitle || smartSelect.find('.item-title').text();
            var backText = smartSelectData.backText || app.params.smartSelectBackText;
            var closeText;
            if (openIn === 'picker') {
                closeText = smartSelectData.pickerCloseText || smartSelectData.backText || app.params.smartSelectPickerCloseText ;   
            }
            else {
                closeText = smartSelectData.popupCloseText || smartSelectData.backText || app.params.smartSelectPopupCloseText ;      
            }
            var backOnSelect = smartSelectData.backOnSelect !== undefined ? smartSelectData.backOnSelect : app.params.smartSelectBackOnSelect;
            var formTheme = smartSelectData.formTheme || app.params.smartSelectFormTheme;
            var navbarTheme = smartSelectData.navbarTheme || app.params.smartSelectNavbarTheme;
            var toolbarTheme = smartSelectData.toolbarTheme || app.params.smartSelectToolbarTheme;
            var virtualList = smartSelectData.virtualList;
            var virtualListHeight = smartSelectData.virtualListHeight;
            var material = app.params.material;
            var pickerHeight = smartSelectData.pickerHeight || app.params.smartSelectPickerHeight;
        
            // Collect all options/values
            var select = smartSelect.find('select')[0];
            var $select = $(select);
            var $selectData = $select.dataset();
            if (select.disabled || smartSelect.hasClass('disabled') || $select.hasClass('disabled')) {
                return;
            }
            var values = [];
            var id = (new Date()).getTime();
            var inputType = select.multiple ? 'checkbox' : 'radio';
            var inputName = inputType + '-' + id;
            var maxLength = $select.attr('maxlength');
            var selectName = select.name;
            var option, optionHasMedia, optionImage, optionIcon, optionGroup, optionGroupLabel, optionPreviousGroup, optionIsLabel, previousGroup, optionColor, optionClassName, optionData;
            for (var i = 0; i < select.length; i++) {
                option = $(select[i]);
                optionData = option.dataset();
                optionImage = optionData.optionImage || $selectData.optionImage || smartSelectData.optionImage;
                optionIcon = optionData.optionIcon || $selectData.optionIcon || smartSelectData.optionIcon;
                optionHasMedia = optionImage || optionIcon || inputType === 'checkbox';
                if (material) optionHasMedia = optionImage || optionIcon;
                optionColor = optionData.optionColor;
                optionClassName = optionData.optionClass;
                if (option[0].disabled) optionClassName += ' disabled';
                optionGroup = option.parent('optgroup')[0];
                optionGroupLabel = optionGroup && optionGroup.label;
                optionIsLabel = false;
                if (optionGroup) {
                    if (optionGroup !== previousGroup) {
                        optionIsLabel = true;
                        previousGroup = optionGroup;
                        values.push({
                            groupLabel: optionGroupLabel,
                            isLabel: optionIsLabel
                        });
                    }
                }
                values.push({
                    value: option[0].value,
                    text: option[0].textContent.trim(),
                    selected: option[0].selected,
                    group: optionGroup,
                    groupLabel: optionGroupLabel,
                    image: optionImage,
                    icon: optionIcon,
                    color: optionColor,
                    className: optionClassName,
                    disabled: option[0].disabled,
                    inputType: inputType,
                    id: id,
                    hasMedia: optionHasMedia,
                    checkbox: inputType === 'checkbox',
                    inputName: inputName,
                    material: app.params.material
                });
            }
        
        
            // Item template/HTML
            if (!app._compiledTemplates.smartSelectItem) {
                app._compiledTemplates.smartSelectItem = t7.compile(app.params.smartSelectItemTemplate || 
                    '{{#if isLabel}}' +
                    '<li class="item-divider">{{groupLabel}}</li>' +
                    '{{else}}' +
                    '<li{{#if className}} class="{{className}}"{{/if}}>' +
                        '<label class="label-{{inputType}} item-content">' +
                            '<input type="{{inputType}}" name="{{inputName}}" value="{{value}}" {{#if selected}}checked{{/if}}>' +
                            '{{#if material}}' +
                                '{{#if hasMedia}}' +
                                '<div class="item-media">' +
                                    '{{#if icon}}<i class="icon {{icon}}"></i>{{/if}}' +
                                    '{{#if image}}<img src="{{image}}">{{/if}}' +
                                '</div>' +
                                '<div class="item-inner">' +
                                    '<div class="item-title{{#if color}} color-{{color}}{{/if}}">{{text}}</div>' +
                                '</div>' +
                                '<div class="item-after">' +
                                    '<i class="icon icon-form-{{inputType}}"></i>' +
                                '</div>' +
                                '{{else}}' +
                                '<div class="item-media">' +
                                    '<i class="icon icon-form-{{inputType}}"></i>' +
                                '</div>' +
                                '<div class="item-inner">' +
                                    '<div class="item-title{{#if color}} color-{{color}}{{/if}}">{{text}}</div>' +
                                '</div>' +
                                '{{/if}}' +
                            '{{else}}' +
                                '{{#if hasMedia}}' +
                                '<div class="item-media">' +
                                    '{{#if checkbox}}<i class="icon icon-form-checkbox"></i>{{/if}}' +
                                    '{{#if icon}}<i class="icon {{icon}}"></i>{{/if}}' +
                                    '{{#if image}}<img src="{{image}}">{{/if}}' +
                                '</div>' +
                                '{{/if}}' +
                                '<div class="item-inner">' +
                                    '<div class="item-title{{#if color}} color-{{color}}{{/if}}">{{text}}</div>' +
                                '</div>' +
                            '{{/if}}' +
                        '</label>' +
                    '</li>' +
                    '{{/if}}'
                );
            }
            var smartSelectItemTemplate = app._compiledTemplates.smartSelectItem;
            
            var inputsHTML = '';
            if (!virtualList) {
                for (var j = 0; j < values.length; j++) {
                    inputsHTML += smartSelectItemTemplate(values[j]);
                }
            }
        
            // Toolbar / Navbar
            var toolbarHTML = '', navbarHTML;
            var noNavbar = '', noToolbar = '', noTabbar = '', navbarLayout;
        
            if (openIn === 'picker') {
                if (!app._compiledTemplates.smartSelectToolbar) {
                    app._compiledTemplates.smartSelectToolbar = t7.compile(app.params.smartSelectToolbarTemplate || 
                        '<div class="toolbar {{#if toolbarTheme}}theme-{{toolbarTheme}}{{/if}}">' +
                          '<div class="toolbar-inner">' +
                            '<div class="left"></div>' +
                            '<div class="right"><a href="#" class="link close-picker"><span>{{closeText}}</span></a></div>' +
                        '</div>' +
                      '</div>'
                    );
                }
        
                toolbarHTML = app._compiledTemplates.smartSelectToolbar({
                    pageTitle: pageTitle,
                    closeText: closeText,
                    openIn: openIn,
                    toolbarTheme: toolbarTheme,
                    inPicker: openIn === 'picker'              
                });
            }
            else {
                // Navbar HTML
                if (!app._compiledTemplates.smartSelectNavbar) {
                    app._compiledTemplates.smartSelectNavbar = t7.compile(app.params.smartSelectNavbarTemplate || 
                        '<div class="navbar {{#if navbarTheme}}theme-{{navbarTheme}}{{/if}}">' +
                            '<div class="navbar-inner">' +
                                '{{leftTemplate}}' +
                                '<div class="center sliding">{{pageTitle}}</div>' +
                            '</div>' +
                        '</div>'
                    );
                }
                navbarHTML = app._compiledTemplates.smartSelectNavbar({
                    pageTitle: pageTitle,
                    backText: backText,
                    closeText: closeText,
                    openIn: openIn,
                    navbarTheme: navbarTheme,
                    inPopup: openIn === 'popup',
                    inPage: openIn === 'page',
                    leftTemplate: openIn === 'popup' ? 
                        (app.params.smartSelectPopupCloseTemplate || (material ? '<div class="left"><a href="#" class="link close-popup icon-only"><i class="icon icon-back"></i></a></div>' : '<div class="left"><a href="#" class="link close-popup"><i class="icon icon-back"></i><span>{{closeText}}</span></a></div>')).replace(/{{closeText}}/g, closeText) :
                        (app.params.smartSelectBackTemplate || (material ? '<div class="left"><a href="#" class="back link icon-only"><i class="icon icon-back"></i></a></div>' : '<div class="left sliding"><a href="#" class="back link"><i class="icon icon-back"></i><span>{{backText}}</span></a></div>')).replace(/{{backText}}/g, backText)
                });
                // Determine navbar layout type - static/fixed/through
                if (openIn === 'page') {
                    navbarLayout = 'static';
                    if (smartSelect.parents('.navbar-through').length > 0) navbarLayout = 'through';
                    if (smartSelect.parents('.navbar-fixed').length > 0) navbarLayout = 'fixed';
                    noToolbar = smartSelect.parents('.page').hasClass('no-toolbar') ? 'no-toolbar' : '';
                    noNavbar  = smartSelect.parents('.page').hasClass('no-navbar')  ? 'no-navbar'  : 'navbar-' + navbarLayout;
                    noTabbar = smartSelect.parents('.page').hasClass('no-tabbar') ? 'no-tabbar' : '';
                }
                else {
                    navbarLayout = 'fixed';
                }
            }
                
        
            // Page Layout
            var pageName = 'smart-select-' + inputName;
        
            var useSearchbar = typeof smartSelect.data('searchbar') === 'undefined' ? app.params.smartSelectSearchbar : (smartSelect.data('searchbar') === 'true' ? true : false);
            var searchbarPlaceholder, searchbarCancel;
                
            if (useSearchbar) {
                searchbarPlaceholder = smartSelect.data('searchbar-placeholder') || 'Search';
                searchbarCancel = smartSelect.data('searchbar-cancel') || 'Cancel';
            }
        
            var searchbarHTML =   '<form class="searchbar searchbar-init" data-search-list=".smart-select-list-' + id + '" data-search-in=".item-title">' +
                                    '<div class="searchbar-input">' +
                                        '<input type="search" placeholder="' + searchbarPlaceholder + '">' +
                                        '<a href="#" class="searchbar-clear"></a>' +
                                    '</div>' +
                                    (material ? '' : '<a href="#" class="searchbar-cancel">' + searchbarCancel + '</a>') +
                                  '</form>' +
                                  '<div class="searchbar-overlay"></div>';
        
            var pageHTML =
                (openIn !== 'picker' && navbarLayout === 'through' ? navbarHTML : '') +
                '<div class="pages">' +
                '  <div data-page="' + pageName + '" data-select-name="' + selectName + '" class="page smart-select-page ' + noNavbar + ' ' + noToolbar + ' ' + noTabbar + '">' +
                     (openIn !== 'picker' && navbarLayout === 'fixed' ? navbarHTML : '') +
                     (useSearchbar ? searchbarHTML : '') +
                '    <div class="page-content">' +
                       (openIn !== 'picker' && navbarLayout === 'static' ? navbarHTML : '') +
                '      <div class="list-block ' + (virtualList ? 'virtual-list' : '') + ' smart-select-list-' + id + ' ' + (formTheme ? 'theme-' + formTheme : '') + '">' +
                '        <ul>' +
                            (virtualList ? '' : inputsHTML) +
                '        </ul>' +
                '      </div>' +
                '    </div>' +
                '  </div>' +
                '</div>';
        
            // Define popup and picker
            var popup, picker;
        
            // Scroll SS Picker To Input
            function scrollToInput() {
                var pageContent = smartSelect.parents('.page-content');
                if (pageContent.length === 0) return;
                var paddingTop = parseInt(pageContent.css('padding-top'), 10),
                    paddingBottom = parseInt(pageContent.css('padding-bottom'), 10),
                    pageHeight = pageContent[0].offsetHeight - paddingTop - picker.height(),
                    pageScrollHeight = pageContent[0].scrollHeight - paddingTop - picker.height(),
                    newPaddingBottom;
                var inputTop = smartSelect.offset().top - paddingTop + smartSelect[0].offsetHeight;
                if (inputTop > pageHeight) {
                    var scrollTop = pageContent.scrollTop() + inputTop - pageHeight;
                    if (scrollTop + pageHeight > pageScrollHeight) {
                        newPaddingBottom = scrollTop + pageHeight - pageScrollHeight + paddingBottom;
                        if (pageHeight === pageScrollHeight) {
                            newPaddingBottom = picker.height();
                        }
                        pageContent.css({'padding-bottom': (newPaddingBottom) + 'px'});
                    }
                    pageContent.scrollTop(scrollTop, 300);
                }
            }
            // Close SS Picker on HTML Click
            function closeOnHTMLClick(e) {
                var close = true;
                if (e.target === smartSelect[0] || $(e.target).parents(smartSelect[0]).length > 0) {
                    close = false;
                }
                if ($(e.target).parents('.picker-modal').length > 0) {
                    close = false;
                }
                if (close) {
                    app.closeModal('.smart-select-picker.modal-in');   
                }
            }
        
            // Check max length
            function checkMaxLength(container) {
                if (select.selectedOptions.length >= maxLength) {
                    container.find('input[type="checkbox"]').each(function () {
                        if (!this.checked) {
                            $(this).parents('li').addClass('disabled');
                        }
                        else {
                            $(this).parents('li').removeClass('disabled');   
                        }
                    });
                }
                else {
                    container.find('.disabled').removeClass('disabled');
                }
            }
            // Event Listeners on new page
            function handleInputs(container) {
                container = $(container);
                if (virtualList) {
                    var virtualListInstance = app.virtualList(container.find('.virtual-list'), {
                        items: values,
                        template: smartSelectItemTemplate,
                        height: virtualListHeight || undefined,
                        searchByItem: function (query, index, item) {
                            if (item.text.toLowerCase().indexOf(query.trim().toLowerCase()) >=0 ) return true;
                            return false;
                        }
                    });
                    container.once(openIn === 'popup' || openIn === 'picker' ? 'closed': 'pageBeforeRemove', function () {
                        if (virtualListInstance && virtualListInstance.destroy) virtualListInstance.destroy();
                    });
                }
                if (maxLength) {
                    checkMaxLength(container);
                }
                container.on('change', 'input[name="' + inputName + '"]', function () {
                    var input = this;
                    var value = input.value;
                    var optionText = [];
                    if (input.type === 'checkbox') {
                        var values = [];
                        for (var i = 0; i < select.options.length; i++) {
                            var option = select.options[i];
                            if (option.value === value) {
                                option.selected = input.checked;
                            }
                            if (option.selected) {
                                optionText.push(option.textContent.trim());
                            }
                        }
                        if (maxLength) {
                            checkMaxLength(container);
                        }
                    }
                    else {
                        optionText = [smartSelect.find('option[value="' + value + '"]').text()];
                        select.value = value;
                    }
                        
                    $select.trigger('change');
                    smartSelect.find('.item-after').text(optionText.join(', '));
                    if (backOnSelect && inputType === 'radio') {
                        if (openIn === 'popup') app.closeModal(popup);
                        else if (openIn === 'picker') app.closeModal(picker);
                        else view.router.back();
                    }
                });
            }
            function pageInit(e) {
                var page = e.detail.page;
                if (page.name === pageName) {
                    handleInputs(page.container);
                }
            }
            if (openIn === 'popup') {
                if (reLayout) {
                    popup = $('.popup.smart-select-popup .view');
                    popup.html(pageHTML);
                }
                else {
                    popup = app.popup(
                        '<div class="popup smart-select-popup smart-select-popup-' + inputName + '">' +
                            '<div class="view navbar-fixed">' +
                                pageHTML +
                            '</div>' +
                        '</div>'
                        );
                    popup = $(popup);
                }
                app.initPage(popup.find('.page'));
                handleInputs(popup);
            }
            else if (openIn === 'picker') {
                if (reLayout) {
                    picker = $('.picker-modal.smart-select-picker .view');
                    picker.html(pageHTML);
                }
                else {
                    picker = app.pickerModal(
                        '<div class="picker-modal smart-select-picker smart-select-picker-' + inputName + '"' + (pickerHeight ? ' style="height:' + pickerHeight + '"' : '') + '>' +
                            toolbarHTML +
                            '<div class="picker-modal-inner">' +
                                '<div class="view">' +
                                    pageHTML +
                                '</div>' +
                            '</div>' +
                        '</div>'
                        );
                    picker = $(picker);
        
                    // Scroll To Input
                    scrollToInput();
        
                    // Close On Click
                    $('html').on('click', closeOnHTMLClick);
        
                    // On Close
                    picker.once('close', function () {
                        // Reset linked picker
                        smartSelect[0].f7SmartSelectPicker = undefined;
                        
                        // Detach html click
                        $('html').off('click', closeOnHTMLClick);    
                        
                        // Restore page padding bottom
                        smartSelect.parents('.page-content').css({paddingBottom: ''});
                    });
        
                    // Link Picker
                    smartSelect[0].f7SmartSelectPicker = picker[0];
                }
        
                // Init Page
                app.initPage(picker.find('.page'));
        
                // Attach events
                handleInputs(picker);
            }
            else {
                $(document).once('pageInit', '.smart-select-page', pageInit);
                view.router.load({
                    content: pageHTML,
                    reload: reLayout ? true : undefined
                });
            }
        };
        

        /*===============================================================================
        ************   Virtual List   ************
        ===============================================================================*/
        var VirtualList = function (listBlock, params) {
            var defaults = {
                cols: 1,
                height: app.params.material ? 48 : 44,
                cache: true,
                dynamicHeightBufferSize: 1,
                showFilteredItemsOnly: false
            };
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined') {
                    params[def] = defaults[def];
                }
            }
        
            // Preparation
            var vl = this;
            vl.listBlock = $(listBlock);
            vl.params = params;
            vl.items = vl.params.items;
            if (vl.params.showFilteredItemsOnly) {
                vl.filteredItems = [];
            }
            if (vl.params.template) {
                if (typeof vl.params.template === 'string') vl.template = t7.compile(vl.params.template);
                else if (typeof vl.params.template === 'function') vl.template = vl.params.template;
            }
            vl.pageContent = vl.listBlock.parents('.page-content');
        
            // Bad scroll
            var updatableScroll;
            if (typeof vl.params.updatableScroll !== 'undefined') {
                updatableScroll = vl.params.updatableScroll;
            }
            else {
                updatableScroll = true;
                if (app.device.ios && app.device.osVersion.split('.')[0] < 8) {
                    updatableScroll = false;
                }
            }
        
            // Append <ul>
            vl.ul = vl.params.ul ? $(vl.params.ul) : vl.listBlock.children('ul');
            if (vl.ul.length === 0) {
                vl.listBlock.append('<ul></ul>');
                vl.ul = vl.listBlock.children('ul');
            }
        
            // DOM cached items
            vl.domCache = {};
            vl.displayDomCache = {};
        
            // Temporary DOM Element
            vl.tempDomElement = document.createElement('ul');
        
            // Last repain position
            vl.lastRepaintY = null;
        
            // Fragment
            vl.fragment = document.createDocumentFragment();
        
            // Filter
            vl.filterItems = function (indexes, resetScrollTop) {
                vl.filteredItems = [];
                var firstIndex = indexes[0];
                var lastIndex = indexes[indexes.length - 1];
                for (var i = 0; i < indexes.length; i++) {
                    vl.filteredItems.push(vl.items[indexes[i]]);
                }
                if (typeof resetScrollTop === 'undefined') resetScrollTop = true;
                if (resetScrollTop) {
                    vl.pageContent[0].scrollTop = 0;
                }
                vl.update();
            };
            vl.resetFilter = function () {
                if (vl.params.showFilteredItemsOnly) {
                    vl.filteredItems = [];
                }
                else {
                    vl.filteredItems = null;
                    delete vl.filteredItems;    
                }
                vl.update();
            };
        
            var pageHeight, rowsPerScreen, rowsBefore, rowsAfter, rowsToRender, maxBufferHeight = 0, listHeight;
            var dynamicHeight = typeof vl.params.height === 'function';
        
            // Set list size
            vl.setListSize = function () {
                var items = vl.filteredItems || vl.items;
                pageHeight = vl.pageContent[0].offsetHeight;
                if (dynamicHeight) {
                    listHeight = 0;
                    vl.heights = [];
                    for (var i = 0; i < items.length; i++) {
                        var itemHeight = vl.params.height(items[i]);
                        listHeight += itemHeight;
                        vl.heights.push(itemHeight);
                    }
                }
                else {
                    listHeight = items.length * vl.params.height / vl.params.cols;
                    rowsPerScreen = Math.ceil(pageHeight / vl.params.height);
                    rowsBefore = vl.params.rowsBefore || rowsPerScreen * 2;
                    rowsAfter = vl.params.rowsAfter || rowsPerScreen;
                    rowsToRender = (rowsPerScreen + rowsBefore + rowsAfter);
                    maxBufferHeight = rowsBefore / 2 * vl.params.height;
                }
        
                if (updatableScroll) {
                    vl.ul.css({height: listHeight + 'px'});
                }
            };
        
            // Render items
            vl.render = function (force, forceScrollTop) {
                if (force) vl.lastRepaintY = null;
        
                var scrollTop = -(vl.listBlock[0].getBoundingClientRect().top - vl.pageContent[0].getBoundingClientRect().top);
        
                if (typeof forceScrollTop !== 'undefined') scrollTop = forceScrollTop;
        
                if (vl.lastRepaintY === null || Math.abs(scrollTop - vl.lastRepaintY) > maxBufferHeight || (!updatableScroll && (vl.pageContent[0].scrollTop + pageHeight >= vl.pageContent[0].scrollHeight))) {
                    vl.lastRepaintY = scrollTop;
                }
                else {
                    return;
                }
        
                var items = vl.filteredItems || vl.items, 
                    fromIndex, toIndex, heightBeforeFirstItem = 0, heightBeforeLastItem = 0;
                if (dynamicHeight) {
                    var itemTop = 0, j, itemHeight; 
                    maxBufferHeight = pageHeight;
        
                    for (j = 0; j < vl.heights.length; j++) {
                        itemHeight = vl.heights[j];
                        if (typeof fromIndex === 'undefined') {
                            if (itemTop + itemHeight >= scrollTop - pageHeight * 2 * vl.params.dynamicHeightBufferSize) fromIndex = j;
                            else heightBeforeFirstItem += itemHeight;
                        }
        
                        if (typeof toIndex === 'undefined') {
                            if (itemTop + itemHeight >= scrollTop + pageHeight * 2 * vl.params.dynamicHeightBufferSize || j === vl.heights.length - 1) toIndex = j + 1;
                            heightBeforeLastItem += itemHeight;
                        }
                        itemTop += itemHeight;
                    }
                    toIndex = Math.min(toIndex, items.length);
                }
                else {
                    fromIndex = (parseInt(scrollTop / vl.params.height) - rowsBefore) * vl.params.cols;
                    if (fromIndex < 0) {
                        fromIndex = 0;
                    }
                    toIndex = Math.min(fromIndex + rowsToRender * vl.params.cols, items.length);
                }
        
                var topPosition;
                vl.reachEnd = false;
                for (var i = fromIndex; i < toIndex; i++) {
                    var item, index;
                    // Define real item index
                    index = vl.items.indexOf(items[i]);
        
                    if (i === fromIndex) vl.currentFromIndex = index;
                    if (i === toIndex - 1) vl.currentToIndex = index;
                    if (index === vl.items.length - 1) vl.reachEnd = true;
        
                    // Find items
                    if (vl.domCache[index]) {
                        item = vl.domCache[index];
                    }
                    else {
                        if (vl.template) {
                            vl.tempDomElement.innerHTML = vl.template(items[i], {index: index}).trim();
                        }
                        else if (vl.params.renderItem) {
                            vl.tempDomElement.innerHTML = vl.params.renderItem(index, items[i]).trim();
                        }
                        else {
                            vl.tempDomElement.innerHTML = items[i].trim();
                        }
                        item = vl.tempDomElement.childNodes[0];
                        if (vl.params.cache) vl.domCache[index] = item;
                    }
                    item.f7VirtualListIndex = index;
        
                    // Set item top position
                    if (i === fromIndex) {
                        if (dynamicHeight) {
                            topPosition = heightBeforeFirstItem;
                        }
                        else {
                            topPosition = (i * vl.params.height / vl.params.cols);
                        }
                    }
                    item.style.top = topPosition + 'px';
        
                    // Before item insert
                    if (vl.params.onItemBeforeInsert) vl.params.onItemBeforeInsert(vl, item);
        
                    // Append item to fragment
                    vl.fragment.appendChild(item);
        
        
                }
        
                // Update list height with not updatable scroll
                if (!updatableScroll) {
                    if (dynamicHeight) {
                        vl.ul[0].style.height = heightBeforeLastItem + 'px';
                    }
                    else {
                        vl.ul[0].style.height = i * vl.params.height / vl.params.cols + 'px';
                    }
                }
        
        
                // Update list html
                if (vl.params.onBeforeClear) vl.params.onBeforeClear(vl, vl.fragment);
                vl.ul[0].innerHTML = '';
        
                if (vl.params.onItemsBeforeInsert) vl.params.onItemsBeforeInsert(vl, vl.fragment);
                vl.ul[0].appendChild(vl.fragment);
                if (vl.params.onItemsAfterInsert) vl.params.onItemsAfterInsert(vl, vl.fragment);
        
                if (typeof forceScrollTop !== 'undefined' && force) {
                    vl.pageContent.scrollTop(forceScrollTop, 0);
                }
            };
        
            vl.scrollToItem = function (index) {
                if (index > vl.items.length) return false;
        
                var itemTop = 0, listTop;
                if (dynamicHeight) {
                    for (var i = 0; i < index; i++) {
                        itemTop += vl.heights[i];
                    }
                }
                else {
                    itemTop = index * vl.params.height;
                }
                listTop = vl.listBlock[0].offsetTop;
                vl.render(true, listTop + itemTop - parseInt(vl.pageContent.css('padding-top'), 10));
                return true;
            };
        
            // Handle scroll event
            vl.handleScroll = function (e) {
                vl.render();
            };
            // Handle resize event
            vl.handleResize = function (e) {
                vl.setListSize();
                vl.render(true);
            };
        
            vl.attachEvents = function (detach) {
                var action = detach ? 'off' : 'on';
                vl.pageContent[action]('scroll', vl.handleScroll);
                vl.listBlock.parents('.tab').eq(0)[action]('show', vl.handleResize);
                $(window)[action]('resize', vl.handleResize);
            };
        
            // Init Virtual List
            vl.init = function () {
                vl.attachEvents();
                vl.setListSize();
                vl.render();
            };
        
            // Append
            vl.appendItems = function (items) {
                for (var i = 0; i < items.length; i++) {
                    vl.items.push(items[i]);
                }
                vl.update();
            };
            vl.appendItem = function (item) {
                vl.appendItems([item]);
            };
            // Replace
            vl.replaceAllItems = function (items) {
                vl.items = items;
                delete vl.filteredItems;
                vl.domCache = {};
                vl.update();
            };
            vl.replaceItem = function (index, item) {
                vl.items[index] = item;
                if (vl.params.cache) delete vl.domCache[index];
                vl.update();
            };
            // Prepend
            vl.prependItems = function (items) {
                for (var i = items.length - 1; i >= 0; i--) {
                    vl.items.unshift(items[i]);
                }
                if (vl.params.cache) {
                    var newCache = {};
                    for (var cached in vl.domCache) {
                        newCache[parseInt(cached, 10) + items.length] = vl.domCache[cached];
                    }
                    vl.domCache = newCache;
                }
                vl.update();
            };
            vl.prependItem = function (item) {
                vl.prependItems([item]);
            };
        
            // Move
            vl.moveItem = function (oldIndex, newIndex) {
                if (oldIndex === newIndex) return;
                // remove item from array
                var item = vl.items.splice(oldIndex, 1)[0];
                if (newIndex >= vl.items.length) {
                    // Add item to the end
                    vl.items.push(item);
                    newIndex = vl.items.length - 1;
                }
                else {
                    // Add item to new index
                    vl.items.splice(newIndex, 0, item);
                }
                // Update cache
                if (vl.params.cache) {
                    var newCache = {};
                    for (var cached in vl.domCache) {
                        var cachedIndex = parseInt(cached, 10);
                        var leftIndex = oldIndex < newIndex ? oldIndex : newIndex;
                        var rightIndex = oldIndex < newIndex ? newIndex : oldIndex;
                        var indexShift = oldIndex < newIndex ? -1 : 1;
                        if (cachedIndex < leftIndex || cachedIndex > rightIndex) newCache[cachedIndex] = vl.domCache[cachedIndex];
                        if (cachedIndex === leftIndex) newCache[rightIndex] = vl.domCache[cachedIndex];
                        if (cachedIndex > leftIndex && cachedIndex <= rightIndex) newCache[cachedIndex + indexShift] = vl.domCache[cachedIndex];
                    }
                    vl.domCache = newCache;
                }
                vl.update();
            };
            // Insert before
            vl.insertItemBefore = function (index, item) {
                if (index === 0) {
                    vl.prependItem(item);
                    return;
                }
                if (index >= vl.items.length) {
                    vl.appendItem(item);
                    return;
                }
                vl.items.splice(index, 0, item);
                // Update cache
                if (vl.params.cache) {
                    var newCache = {};
                    for (var cached in vl.domCache) {
                        var cachedIndex = parseInt(cached, 10);
                        if (cachedIndex >= index) {
                            newCache[cachedIndex + 1] = vl.domCache[cachedIndex];
                        }
                    }
                    vl.domCache = newCache;
                }
                vl.update();
            };
            // Delete
            vl.deleteItems = function (indexes) {
                var prevIndex, indexShift = 0;
                for (var i = 0; i < indexes.length; i++) {
                    var index = indexes[i];
                    if (typeof prevIndex !== 'undefined') {
                        if (index > prevIndex) {
                            indexShift = -i;
                        }
                    }
                    index = index + indexShift;
                    prevIndex = indexes[i];
                    // Delete item
                    var deletedItem = vl.items.splice(index, 1)[0];
        
                    // Delete from filtered
                    if (vl.filteredItems && vl.filteredItems.indexOf(deletedItem) >= 0) {
                        vl.filteredItems.splice(vl.filteredItems.indexOf(deletedItem), 1);
                    }
                    // Update cache
                    if (vl.params.cache) {
                        var newCache = {};
                        for (var cached in vl.domCache) {
                            var cachedIndex = parseInt(cached, 10);
                            if (cachedIndex === index) {
                                delete vl.domCache[index];
                            }
                            else if (parseInt(cached, 10) > index) {
                                newCache[cachedIndex - 1] = vl.domCache[cached];
                            }
                            else {
                                newCache[cachedIndex] = vl.domCache[cached];   
                            }
                        }
                        vl.domCache = newCache;
                    }
                }
                vl.update();
            };
            vl.deleteAllItems = function () {
                vl.items = [];
                delete vl.filteredItems;
                if (vl.params.cache) vl.domCache = {};
                vl.update();
            };
            vl.deleteItem = function (index) {
                vl.deleteItems([index]);
            };
        
            // Clear cache
            vl.clearCache = function () {
                vl.domCache = {};
            };
        
            // Update Virtual List
            vl.update = function () {
                vl.setListSize();
                vl.render(true);
            };
        
            // Destroy
            vl.destroy = function () {
                vl.attachEvents(true);
                delete vl.items;
                delete vl.domCache;
            };
        
            // Init Virtual List
            vl.init();
        
            // Store vl in container
            vl.listBlock[0].f7VirtualList = vl;
            return vl;
        };
        
        // App Method
        app.virtualList = function (listBlock, params) {
            return new VirtualList(listBlock, params);
        };
        
        app.reinitVirtualList = function (pageContainer) {
            var page = $(pageContainer);
            var vlists = page.find('.virtual-list');
            if (vlists.length === 0) return;
            for (var i = 0; i < vlists.length; i++) {
                var vlistInstance = vlists[i].f7VirtualList;
                if (vlistInstance) {
                    vlistInstance.update();
                }
            }
        };

        /*======================================================
        ************   Pull To Refresh   ************
        ======================================================*/
        app.initPullToRefresh = function (pageContainer) {
            var eventsTarget = $(pageContainer);
            if (!eventsTarget.hasClass('pull-to-refresh-content')) {
                eventsTarget = eventsTarget.find('.pull-to-refresh-content');
            }
            if (!eventsTarget || eventsTarget.length === 0) return;
        
            var touchId, isTouched, isMoved, touchesStart = {}, isScrolling, touchesDiff, touchStartTime, container, refresh = false, useTranslate = false, startTranslate = 0, translate, scrollTop, wasScrolled, layer, triggerDistance, dynamicTriggerDistance, pullStarted;
            var page = eventsTarget.hasClass('page') ? eventsTarget : eventsTarget.parents('.page');
            var hasNavbar = false;
            if (page.find('.navbar').length > 0 || page.parents('.navbar-fixed, .navbar-through').length > 0 || page.hasClass('navbar-fixed') || page.hasClass('navbar-through')) hasNavbar = true;
            if (page.hasClass('no-navbar')) hasNavbar = false;
            if (!hasNavbar) eventsTarget.addClass('pull-to-refresh-no-navbar');
        
            container = eventsTarget;
        
            // Define trigger distance
            if (container.attr('data-ptr-distance')) {
                dynamicTriggerDistance = true;
            }
            else {
                triggerDistance = 44;   
            }
            
            function handleTouchStart(e) {
                if (isTouched) {
                    if (app.device.os === 'android') {
                        if ('targetTouches' in e && e.targetTouches.length > 1) return;
                    }
                    else return;
                }
                
                /*jshint validthis:true */
                container = $(this);
                if (container.hasClass('refreshing')) {
                    return;
                }
                
                isMoved = false;
                pullStarted = false;
                isTouched = true;
                isScrolling = undefined;
                wasScrolled = undefined;
                if (e.type === 'touchstart') touchId = e.targetTouches[0].identifier;
                touchesStart.x = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
                touchesStart.y = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                touchStartTime = (new Date()).getTime();
                
            }
            
            function handleTouchMove(e) {
                if (!isTouched) return;
                var pageX, pageY, touch;
                if (e.type === 'touchmove') {
                    if (touchId && e.touches) {
                        for (var i = 0; i < e.touches.length; i++) {
                            if (e.touches[i].identifier === touchId) {
                                touch = e.touches[i];
                            }
                        }
                    }
                    if (!touch) touch = e.targetTouches[0];
                    pageX = touch.pageX;
                    pageY = touch.pageY;
                }
                else {
                    pageX = e.pageX;
                    pageY = e.pageY;
                }
                if (!pageX || !pageY) return;
                    
        
                if (typeof isScrolling === 'undefined') {
                    isScrolling = !!(isScrolling || Math.abs(pageY - touchesStart.y) > Math.abs(pageX - touchesStart.x));
                }
                if (!isScrolling) {
                    isTouched = false;
                    return;
                }
        
                scrollTop = container[0].scrollTop;
                if (typeof wasScrolled === 'undefined' && scrollTop !== 0) wasScrolled = true; 
        
                if (!isMoved) {
                    /*jshint validthis:true */
                    container.removeClass('transitioning');
                    if (scrollTop > container[0].offsetHeight) {
                        isTouched = false;
                        return;
                    }
                    if (dynamicTriggerDistance) {
                        triggerDistance = container.attr('data-ptr-distance');
                        if (triggerDistance.indexOf('%') >= 0) triggerDistance = container[0].offsetHeight * parseInt(triggerDistance, 10) / 100;
                    }
                    startTranslate = container.hasClass('refreshing') ? triggerDistance : 0;
                    if (container[0].scrollHeight === container[0].offsetHeight || app.device.os !== 'ios') {
                        useTranslate = true;
                    }
                    else {
                        useTranslate = false;
                    }
                }
                isMoved = true;
                touchesDiff = pageY - touchesStart.y;
                
                if (touchesDiff > 0 && scrollTop <= 0 || scrollTop < 0) {
                    // iOS 8 fix
                    if (app.device.os === 'ios' && parseInt(app.device.osVersion.split('.')[0], 10) > 7 && scrollTop === 0 && !wasScrolled) useTranslate = true;
        
                    if (useTranslate) {
                        e.preventDefault();
                        translate = (Math.pow(touchesDiff, 0.85) + startTranslate);
                        container.transform('translate3d(0,' + translate + 'px,0)');
                    }
                    if ((useTranslate && Math.pow(touchesDiff, 0.85) > triggerDistance) || (!useTranslate && touchesDiff >= triggerDistance * 2)) {
                        refresh = true;
                        container.addClass('pull-up').removeClass('pull-down');
                    }
                    else {
                        refresh = false;
                        container.removeClass('pull-up').addClass('pull-down');
                    }
                    if (!pullStarted) {
                        container.trigger('pullstart');
                        pullStarted = true;
                    }
                    container.trigger('pullmove', {
                        event: e,
                        scrollTop: scrollTop,
                        translate: translate,
                        touchesDiff: touchesDiff
                    });
                }
                else {
                    pullStarted = false;
                    container.removeClass('pull-up pull-down');
                    refresh = false;
                    return;
                }
            }
            function handleTouchEnd(e) {
                if (e.type === 'touchend' && e.changedTouches && e.changedTouches.length > 0 && touchId) {
                    if (e.changedTouches[0].identifier !== touchId) return;
                }
                if (!isTouched || !isMoved) {
                    isTouched = false;
                    isMoved = false;
                    return;
                }
                if (translate) {
                    container.addClass('transitioning');
                    translate = 0;
                }
                container.transform('');
                if (refresh) {
                    container.addClass('refreshing');
                    container.trigger('refresh', {
                        done: function () {
                            app.pullToRefreshDone(container);
                        }
                    });
                }
                else {
                    container.removeClass('pull-down');
                }
                isTouched = false;
                isMoved = false;
                if (pullStarted) container.trigger('pullend');
            }
        
            // Attach Events
            eventsTarget.on(app.touchEvents.start, handleTouchStart);
            eventsTarget.on(app.touchEvents.move, handleTouchMove);
            eventsTarget.on(app.touchEvents.end, handleTouchEnd);
        
            // Detach Events on page remove
            if (page.length === 0) return;
            function destroyPullToRefresh() {
                eventsTarget.off(app.touchEvents.start, handleTouchStart);
                eventsTarget.off(app.touchEvents.move, handleTouchMove);
                eventsTarget.off(app.touchEvents.end, handleTouchEnd);
            }
            eventsTarget[0].f7DestroyPullToRefresh = destroyPullToRefresh;
            function detachEvents() {
                destroyPullToRefresh();
                page.off('pageBeforeRemove', detachEvents);
            }
            page.on('pageBeforeRemove', detachEvents);
        
        };
        
        app.pullToRefreshDone = function (container) {
            container = $(container);
            if (container.length === 0) container = $('.pull-to-refresh-content.refreshing');
            container.removeClass('refreshing').addClass('transitioning');
            container.transitionEnd(function () {
                container.removeClass('transitioning pull-up pull-down');
                container.trigger('refreshdone');
            });
        };
        app.pullToRefreshTrigger = function (container) {
            container = $(container);
            if (container.length === 0) container = $('.pull-to-refresh-content');
            if (container.hasClass('refreshing')) return;
            container.addClass('transitioning refreshing');
            container.trigger('refresh', {
                done: function () {
                    app.pullToRefreshDone(container);
                }
            });
        };
        
        app.destroyPullToRefresh = function (pageContainer) {
            pageContainer = $(pageContainer);
            var pullToRefreshContent = pageContainer.hasClass('pull-to-refresh-content') ? pageContainer : pageContainer.find('.pull-to-refresh-content');
            if (pullToRefreshContent.length === 0) return;
            if (pullToRefreshContent[0].f7DestroyPullToRefresh) pullToRefreshContent[0].f7DestroyPullToRefresh();
        };
        

        /* ===============================================================================
        ************   Infinite Scroll   ************
        =============================================================================== */
        function handleInfiniteScroll() {
            /*jshint validthis:true */
            var inf = $(this);
            var scrollTop = inf[0].scrollTop;
            var scrollHeight = inf[0].scrollHeight;
            var height = inf[0].offsetHeight;
            var distance = inf[0].getAttribute('data-distance');
            var virtualListContainer = inf.find('.virtual-list');
            var virtualList;
            var onTop = inf.hasClass('infinite-scroll-top');
            if (!distance) distance = 50;
            if (typeof distance === 'string' && distance.indexOf('%') >= 0) {
                distance = parseInt(distance, 10) / 100 * height;
            }
            if (distance > height) distance = height;
            if (onTop) {
                if (scrollTop < distance) {
                    inf.trigger('infinite');
                }
            }
            else {
                if (scrollTop + height >= scrollHeight - distance) {
                    if (virtualListContainer.length > 0) {
                        virtualList = virtualListContainer[0].f7VirtualList;
                        if (virtualList && !virtualList.reachEnd) return;
                    }
                    inf.trigger('infinite');
                }
            }
        
        }
        app.attachInfiniteScroll = function (infiniteContent) {
            $(infiniteContent).on('scroll', handleInfiniteScroll);
        };
        app.detachInfiniteScroll = function (infiniteContent) {
            $(infiniteContent).off('scroll', handleInfiniteScroll);
        };
        
        app.initPageInfiniteScroll = function (pageContainer) {
            pageContainer = $(pageContainer);
            var infiniteContent = pageContainer.find('.infinite-scroll');
            if (infiniteContent.length === 0) return;
            app.attachInfiniteScroll(infiniteContent);
            function detachEvents() {
                app.detachInfiniteScroll(infiniteContent);
                pageContainer.off('pageBeforeRemove', detachEvents);
            }
            pageContainer.on('pageBeforeRemove', detachEvents);
        };

        /*=============================================================
        ************   Hide/show Toolbar/Navbar on scroll   ************
        =============================================================*/
        app.initPageScrollToolbars = function (pageContainer) {
            pageContainer = $(pageContainer);
            var scrollContent = pageContainer.find('.page-content');
            if (scrollContent.length === 0) return;
            var hideNavbar = (app.params.hideNavbarOnPageScroll || scrollContent.hasClass('hide-navbar-on-scroll') || scrollContent.hasClass('hide-bars-on-scroll')) && !(scrollContent.hasClass('keep-navbar-on-scroll') || scrollContent.hasClass('keep-bars-on-scroll'));
            var hideToolbar = (app.params.hideToolbarOnPageScroll || scrollContent.hasClass('hide-toolbar-on-scroll') || scrollContent.hasClass('hide-bars-on-scroll')) && !(scrollContent.hasClass('keep-toolbar-on-scroll') || scrollContent.hasClass('keep-bars-on-scroll'));
            var hideTabbar = (app.params.hideTabbarOnPageScroll || scrollContent.hasClass('hide-tabbar-on-scroll')) && !(scrollContent.hasClass('keep-tabbar-on-scroll'));
        
            if (!(hideNavbar || hideToolbar || hideTabbar)) return;
            
            var viewContainer = scrollContent.parents('.' + app.params.viewClass);
            if (viewContainer.length === 0) return;
        
            var navbar = viewContainer.find('.navbar'), 
                toolbar = viewContainer.find('.toolbar'), 
                tabbar;
            if (hideTabbar) {
                tabbar = viewContainer.find('.tabbar');
                if (tabbar.length === 0) tabbar = viewContainer.parents('.' + app.params.viewsClass).find('.tabbar');
            }
        
            var hasNavbar = navbar.length > 0,
                hasToolbar = toolbar.length > 0,
                hasTabbar = tabbar && tabbar.length > 0;
        
            var previousScroll, currentScroll;
                previousScroll = currentScroll = scrollContent[0].scrollTop;
        
            var scrollHeight, offsetHeight, reachEnd, action, navbarHidden, toolbarHidden, tabbarHidden;
        
            var toolbarHeight = (hasToolbar && hideToolbar) ? toolbar[0].offsetHeight : 0;
            var tabbarHeight = (hasTabbar && hideTabbar) ? tabbar[0].offsetHeight : 0;
            var bottomBarHeight = tabbarHeight || toolbarHeight;
        
            function handleScroll(e) {
                if (pageContainer.hasClass('page-on-left')) return;
                currentScroll = scrollContent[0].scrollTop;
                scrollHeight = scrollContent[0].scrollHeight;
                offsetHeight = scrollContent[0].offsetHeight;
                reachEnd =  currentScroll + offsetHeight >= scrollHeight - bottomBarHeight;
                navbarHidden = navbar.hasClass('navbar-hidden');
                toolbarHidden = toolbar.hasClass('toolbar-hidden');
                tabbarHidden = tabbar && tabbar.hasClass('toolbar-hidden');
        
                if (reachEnd) {
                    if (app.params.showBarsOnPageScrollEnd) {
                        action = 'show';
                    }
                }
                else if (previousScroll > currentScroll) {
                    if (app.params.showBarsOnPageScrollTop || currentScroll <= 44) {
                        action = 'show';
                    }
                    else {
                        action = 'hide';
                    }
                }
                else {
                    if (currentScroll > 44) {
                        action = 'hide';
                    }
                    else {
                        action = 'show';
                    }
                }
        
                if (action === 'show') {
                    if (hasNavbar && hideNavbar && navbarHidden) {
                        app.showNavbar(navbar);
                        pageContainer.removeClass('no-navbar-by-scroll'); 
                        navbarHidden = false;
                    }
                    if (hasToolbar && hideToolbar && toolbarHidden) {
                        app.showToolbar(toolbar);
                        pageContainer.removeClass('no-toolbar-by-scroll'); 
                        toolbarHidden = false;
                    }
                    if (hasTabbar && hideTabbar && tabbarHidden) {
                        app.showToolbar(tabbar);
                        pageContainer.removeClass('no-tabbar-by-scroll'); 
                        tabbarHidden = false;
                    }
                }
                else {
                    if (hasNavbar && hideNavbar && !navbarHidden) {
                        app.hideNavbar(navbar);
                        pageContainer.addClass('no-navbar-by-scroll'); 
                        navbarHidden = true;
                    }
                    if (hasToolbar && hideToolbar && !toolbarHidden) {
                        app.hideToolbar(toolbar);
                        pageContainer.addClass('no-toolbar-by-scroll'); 
                        toolbarHidden = true;
                    }
                    if (hasTabbar && hideTabbar && !tabbarHidden) {
                        app.hideToolbar(tabbar);
                        pageContainer.addClass('no-tabbar-by-scroll'); 
                        tabbarHidden = true;
                    }
                }
                    
                previousScroll = currentScroll;
            }
            scrollContent.on('scroll', handleScroll);
            scrollContent[0].f7ScrollToolbarsHandler = handleScroll;
        };
        app.destroyScrollToolbars = function (pageContainer) {
            pageContainer = $(pageContainer);
            var scrollContent = pageContainer.find('.page-content');
            if (scrollContent.length === 0) return;
            var handler = scrollContent[0].f7ScrollToolbarsHandler;
            if (!handler) return;
            scrollContent.off('scroll', scrollContent[0].f7ScrollToolbarsHandler);
        };

        /*======================================================
        ************   Material Tabbar   ************
        ======================================================*/
        app.materialTabbarSetHighlight = function (tabbar, activeLink) {
            tabbar = $(tabbar);
            activeLink = activeLink || tabbar.find('.tab-link.active');
        
            var tabLinkWidth, highlightTranslate;
            if (tabbar.hasClass('tabbar-scrollable')) {
                tabLinkWidth = activeLink[0].offsetWidth + 'px';
                highlightTranslate = (app.rtl ? - activeLink[0].offsetLeft: activeLink[0].offsetLeft) + 'px';
            }
            else {
                tabLinkWidth = 1 / tabbar.find('.tab-link').length * 100 + '%';
                highlightTranslate = (app.rtl ? - activeLink.index(): activeLink.index()) * 100 + '%';
            }
        
            tabbar.find('.tab-link-highlight')
                .css({width: tabLinkWidth})
                .transform('translate3d(' + highlightTranslate + ',0,0)');
        };
        app.initPageMaterialTabbar = function (pageContainer) {
            pageContainer = $(pageContainer);
            var tabbar = $(pageContainer).find('.tabbar');
        
            function tabbarSetHighlight() {
                app.materialTabbarSetHighlight(tabbar);
            }
            if (tabbar.length > 0) {
                if (tabbar.find('.tab-link-highlight').length === 0) {
                    tabbar.find('.toolbar-inner').append('<span class="tab-link-highlight"></span>');
                }
        
                tabbarSetHighlight();
                $(window).on('resize', tabbarSetHighlight);
                pageContainer.once('pageBeforeRemove', function () {
                    $(window).off('resize', tabbarSetHighlight);
                });
            }
        };

        /* ===============================================================================
        ************   Tabs   ************
        =============================================================================== */
        app.showTab = function (tab, tabLink, force) {
            var newTab = $(tab);
            if (arguments.length === 2) {
                if (typeof tabLink === 'boolean') {
                    force = tabLink;
                }
            }
            if (newTab.length === 0) return false;
            if (newTab.hasClass('active')) {
                if (force) newTab.trigger('show');
                return false;
            }
            var tabs = newTab.parent('.tabs');
            if (tabs.length === 0) return false;
        
            // Return swipeouts in hidden tabs
            app.allowSwipeout = true;
        
            // Animated tabs
            var isAnimatedTabs = tabs.parent().hasClass('tabs-animated-wrap');
            if (isAnimatedTabs) {
                var tabTranslate = (app.rtl ? newTab.index() : -newTab.index()) * 100;
                tabs.transform('translate3d(' + tabTranslate + '%,0,0)');
            }
        
            // Swipeable tabs
            var isSwipeableTabs = tabs.parent().hasClass('tabs-swipeable-wrap'), swiper;
            if (isSwipeableTabs) {
                swiper = tabs.parent()[0].swiper;
                if (swiper.activeIndex !== newTab.index()) swiper.slideTo(newTab.index(), undefined, false);
            }
        
            // Remove active class from old tabs
            var oldTab = tabs.children('.tab.active').removeClass('active');
            // Add active class to new tab
            newTab.addClass('active');
            // Trigger 'show' event on new tab
            newTab.trigger('show');
        
            // Update navbars in new tab
            if (!isAnimatedTabs && !isSwipeableTabs && newTab.find('.navbar').length > 0) {
                // Find tab's view
                var viewContainer;
                if (newTab.hasClass(app.params.viewClass)) viewContainer = newTab[0];
                else viewContainer = newTab.parents('.' + app.params.viewClass)[0];
                app.sizeNavbars(viewContainer);
            }
        
            // Find related link for new tab
            if (tabLink) tabLink = $(tabLink);
            else {
                // Search by id
                if (typeof tab === 'string') tabLink = $('.tab-link[href="' + tab + '"]');
                else tabLink = $('.tab-link[href="#' + newTab.attr('id') + '"]');
                // Search by data-tab
                if (!tabLink || tabLink && tabLink.length === 0) {
                    $('[data-tab]').each(function () {
                        if (newTab.is($(this).attr('data-tab'))) tabLink = $(this);
                    });
                }
            }
            if (tabLink.length === 0) return;
        
            // Find related link for old tab
            var oldTabLink;
            if (oldTab && oldTab.length > 0) {
                // Search by id
                var oldTabId = oldTab.attr('id');
                if (oldTabId) oldTabLink = $('.tab-link[href="#' + oldTabId + '"]');
                // Search by data-tab
                if (!oldTabLink || oldTabLink && oldTabLink.length === 0) {
                    $('[data-tab]').each(function () {
                        if (oldTab.is($(this).attr('data-tab'))) oldTabLink = $(this);
                    });
                }
            }
        
            // Update links' classes
            if (tabLink && tabLink.length > 0) {
                tabLink.addClass('active');
                // Material Highlight
                if (app.params.material) {
                    var tabbar = tabLink.parents('.tabbar');
                    if (tabbar.length > 0) {
                        if (tabbar.find('.tab-link-highlight').length === 0) {
                            tabbar.find('.toolbar-inner').append('<span class="tab-link-highlight"></span>');
                        }
                        app.materialTabbarSetHighlight(tabbar, tabLink);
                    }
                }
            }
            if (oldTabLink && oldTabLink.length > 0) oldTabLink.removeClass('active');
        
            return true;
        };

        /*===============================================================================
        ************   Accordion   ************
        ===============================================================================*/
        app.accordionToggle = function (item) {
            item = $(item);
            if (item.length === 0) return;
            if (item.hasClass('accordion-item-expanded')) app.accordionClose(item);
            else app.accordionOpen(item);
        };
        app.accordionOpen = function (item) {
            item = $(item);
            var list = item.parents('.accordion-list').eq(0);
            var content = item.children('.accordion-item-content');
            if (content.length === 0) content = item.find('.accordion-item-content');
            var expandedItem = list.length > 0 && item.parent().children('.accordion-item-expanded');
            if (expandedItem.length > 0) {
                app.accordionClose(expandedItem);
            }
            content.css('height', content[0].scrollHeight + 'px').transitionEnd(function () {
                if (item.hasClass('accordion-item-expanded')) {
                    content.transition(0);
                    content.css('height', 'auto');
                    var clientLeft = content[0].clientLeft;
                    content.transition('');
                    item.trigger('opened');
                }
                else {
                    content.css('height', '');
                    item.trigger('closed');
                }
            });
            item.trigger('open');
            item.addClass('accordion-item-expanded');
        };
        app.accordionClose = function (item) {
            item = $(item);
            var content = item.children('.accordion-item-content');
            if (content.length === 0) content = item.find('.accordion-item-content');
            item.removeClass('accordion-item-expanded');
            content.transition(0);
            content.css('height', content[0].scrollHeight + 'px');
            // Relayout
            var clientLeft = content[0].clientLeft;
            // Close
            content.transition('');
            content.css('height', '').transitionEnd(function () {
                if (item.hasClass('accordion-item-expanded')) {
                    content.transition(0);
                    content.css('height', 'auto');
                    var clientLeft = content[0].clientLeft;
                    content.transition('');
                    item.trigger('opened');
                }
                else {
                    content.css('height', '');
                    item.trigger('closed');
                }
            });
            item.trigger('close');
        };

        /*===============================================================================
        ************   Fast Clicks   ************
        ************   Inspired by https://github.com/ftlabs/fastclick   ************
        ===============================================================================*/
        app.initFastClicks = function () {
            if (app.params.activeState) {
                $('html').addClass('watch-active-state');
            }
            if (app.device.ios && app.device.webView) {
                // Strange hack required for iOS 8 webview to work on inputs
                window.addEventListener('touchstart', function () {});
            }
        
            var touchStartX, touchStartY, touchStartTime, targetElement, trackClick, activeSelection, scrollParent, lastClickTime, isMoved, tapHoldFired, tapHoldTimeout;
            var activableElement, activeTimeout, needsFastClick, needsFastClickTimeOut;
            var rippleWave, rippleTarget, rippleTransform, rippleTimeout;
            function findActivableElement(el) {
                var target = $(el);
                var parents = target.parents(app.params.activeStateElements);
                var activable;
                if (target.is(app.params.activeStateElements)) {
                    activable = target;
                }
                if (parents.length > 0) {
                    activable = activable ? activable.add(parents) : parents;
                }
                return activable ? activable : target;
            }
            function isInsideScrollableView(el) {
                var pageContent = el.parents('.page-content, .panel');
        
                if (pageContent.length === 0) {
                    return false;
                }
        
                // This event handler covers the "tap to stop scrolling".
                if (pageContent.prop('scrollHandlerSet') !== 'yes') {
                    pageContent.on('scroll', function() {
                      clearTimeout(activeTimeout);
                      clearTimeout(rippleTimeout);
                    });
                    pageContent.prop('scrollHandlerSet', 'yes');
                }
        
                return true;
            }
            function addActive() {
                if (!activableElement) return;
                activableElement.addClass('active-state');
            }
            function removeActive(el) {
                if (!activableElement) return;
                activableElement.removeClass('active-state');
                activableElement = null;
            }
            function isFormElement(el) {
                var nodes = ('input select textarea label').split(' ');
                if (el.nodeName && nodes.indexOf(el.nodeName.toLowerCase()) >= 0) return true;
                return false;
            }
            function androidNeedsBlur(el) {
                var noBlur = ('button input textarea select').split(' ');
                if (document.activeElement && el !== document.activeElement && document.activeElement !== document.body) {
                    if (noBlur.indexOf(el.nodeName.toLowerCase()) >= 0) {
                        return false;
                    }
                    else {
                        return true;
                    }
                }
                else {
                    return false;
                }
            }
            function targetNeedsFastClick(el) {
                var $el = $(el);
                if (el.nodeName.toLowerCase() === 'input' && el.type === 'file') return false;
                if ($el.hasClass('no-fastclick') || $el.parents('.no-fastclick').length > 0) return false;
                return true;
            }
            function targetNeedsFocus(el) {
                if (document.activeElement === el) {
                    return false;
                }
                var tag = el.nodeName.toLowerCase();
                var skipInputs = ('button checkbox file image radio submit').split(' ');
                if (el.disabled || el.readOnly) return false;
                if (tag === 'textarea') return true;
                if (tag === 'select') {
                    if (app.device.android) return false;
                    else return true;
                }
                if (tag === 'input' && skipInputs.indexOf(el.type) < 0) return true;
            }
            function targetNeedsPrevent(el) {
                el = $(el);
                var prevent = true;
                if (el.is('label') || el.parents('label').length > 0) {
                    if (app.device.android) {
                        prevent = false;
                    }
                    else if (app.device.ios && el.is('input')) {
                        prevent = true;
                    }
                    else prevent = false;
                }
                return prevent;
            }
        
            // Mouse Handlers
            function handleMouseDown (e) {
                findActivableElement(e.target).addClass('active-state');
                if ('which' in e && e.which === 3) {
                    setTimeout(function () {
                        $('.active-state').removeClass('active-state');
                    }, 0);
                }
                if (app.params.material && app.params.materialRipple) {
                    touchStartX = e.pageX;
                    touchStartY = e.pageY;
                    rippleTouchStart(e.target, e.pageX, e.pageY);
                }
            }
            function handleMouseMove (e) {
                $('.active-state').removeClass('active-state');
                if (app.params.material && app.params.materialRipple) {
                    rippleTouchMove();
                }
            }
            function handleMouseUp (e) {
                $('.active-state').removeClass('active-state');
                if (app.params.material && app.params.materialRipple) {
                    rippleTouchEnd();
                }
            }
        
            // Material Touch Ripple Effect
            function findRippleElement(el) {
                var needsRipple = app.params.materialRippleElements;
                var $el = $(el);
                if ($el.is(needsRipple)) {
                    if ($el.hasClass('no-ripple')) {
                        return false;
                    }
                    return $el;
                }
                else if ($el.parents(needsRipple).length > 0) {
                    var rippleParent = $el.parents(needsRipple).eq(0);
                    if (rippleParent.hasClass('no-ripple')) {
                        return false;
                    }
                    return rippleParent;
                }
                else return false;
            }
            function createRipple(x, y, el) {
                var box = el[0].getBoundingClientRect();
                var center = {
                    x: x - box.left,
                    y: y - box.top
                },
                    height = box.height,
                    width = box.width;
                var diameter = Math.max(Math.pow((Math.pow(height, 2) + Math.pow(width, 2)), 0.5), 48);
        
                rippleWave = $(
                    '<div class="ripple-wave" style="width: ' + diameter + 'px; height: '+diameter+'px; margin-top:-'+diameter/2+'px; margin-left:-'+diameter/2+'px; left:'+center.x+'px; top:'+center.y+'px;"></div>'
                );
                el.prepend(rippleWave);
                var clientLeft = rippleWave[0].clientLeft;
                rippleTransform = 'translate3d('+(-center.x + width/2)+'px, '+(-center.y + height/2)+'px, 0) scale(1)';
                rippleWave.transform(rippleTransform);
            }
        
            function removeRipple() {
                if (!rippleWave) return;
                var toRemove = rippleWave;
        
                var removeTimeout = setTimeout(function () {
                    toRemove.remove();
                }, 400);
        
                rippleWave
                    .addClass('ripple-wave-fill')
                    .transform(rippleTransform.replace('scale(1)', 'scale(1.01)'))
                    .transitionEnd(function () {
                        clearTimeout(removeTimeout);
        
                        var rippleWave = $(this)
                            .addClass('ripple-wave-out')
                            .transform(rippleTransform.replace('scale(1)', 'scale(1.01)'));
        
                        removeTimeout = setTimeout(function () {
                            rippleWave.remove();
                        }, 700);
        
                        setTimeout(function () {
                            rippleWave.transitionEnd(function(){
                                clearTimeout(removeTimeout);
                                $(this).remove();
                            });
                        }, 0);
                    });
        
                rippleWave = rippleTarget = undefined;
            }
        
            function rippleTouchStart (el, x, y) {
                rippleTarget = findRippleElement(el);
                if (!rippleTarget || rippleTarget.length === 0) {
                    rippleTarget = undefined;
                    return;
                }
                if (!isInsideScrollableView(rippleTarget)) {
                    createRipple(touchStartX, touchStartY, rippleTarget);
                }
                else {
                    rippleTimeout = setTimeout(function () {
                        createRipple(touchStartX, touchStartY, rippleTarget);
                    }, 80);
                }
            }
            function rippleTouchMove() {
                clearTimeout(rippleTimeout);
                removeRipple();
            }
            function rippleTouchEnd() {
                if (rippleWave) {
                    removeRipple();
                }
                else if (rippleTarget && !isMoved) {
                    clearTimeout(rippleTimeout);
                    createRipple(touchStartX, touchStartY, rippleTarget);
                    setTimeout(removeRipple, 0);
                }
                else {
                    removeRipple();
                }
            }
        
            // Send Click
            function sendClick(e) {
                var touch = e.changedTouches[0];
                var evt = document.createEvent('MouseEvents');
                var eventType = 'click';
                if (app.device.android && targetElement.nodeName.toLowerCase() === 'select') {
                    eventType = 'mousedown';
                }
                evt.initMouseEvent(eventType, true, true, window, 1, touch.screenX, touch.screenY, touch.clientX, touch.clientY, false, false, false, false, 0, null);
                evt.forwardedTouchEvent = true;
                targetElement.dispatchEvent(evt);
            }
        
            // Touch Handlers
            function handleTouchStart(e) {
                isMoved = false;
                tapHoldFired = false;
                if (e.targetTouches.length > 1) {
                    if (activableElement) removeActive();
                    return true;
                }
                if (e.touches.length > 1 && activableElement) {
                    removeActive();
                }
                if (app.params.tapHold) {
                    if (tapHoldTimeout) clearTimeout(tapHoldTimeout);
                    tapHoldTimeout = setTimeout(function () {
                        if (e && e.touches && e.touches.length > 1) return;
                        tapHoldFired = true;
                        e.preventDefault();
                        $(e.target).trigger('taphold');
                    }, app.params.tapHoldDelay);
                }
                if (needsFastClickTimeOut) clearTimeout(needsFastClickTimeOut);
                needsFastClick = targetNeedsFastClick(e.target);
        
                if (!needsFastClick) {
                    trackClick = false;
                    return true;
                }
                if (app.device.ios) {
                    var selection = window.getSelection();
                    if (selection.rangeCount && selection.focusNode !== document.body && (!selection.isCollapsed || document.activeElement === selection.focusNode)) {
                        activeSelection = true;
                        return true;
                    }
                    else {
                        activeSelection = false;
                    }
                }
                if (app.device.android)  {
                    if (androidNeedsBlur(e.target)) {
                        document.activeElement.blur();
                    }
                }
        
                trackClick = true;
                targetElement = e.target;
                touchStartTime = (new Date()).getTime();
                touchStartX = e.targetTouches[0].pageX;
                touchStartY = e.targetTouches[0].pageY;
        
                // Detect scroll parent
                if (app.device.ios) {
                    scrollParent = undefined;
                    $(targetElement).parents().each(function () {
                        var parent = this;
                        if (parent.scrollHeight > parent.offsetHeight && !scrollParent) {
                            scrollParent = parent;
                            scrollParent.f7ScrollTop = scrollParent.scrollTop;
                        }
                    });
                }
                if ((e.timeStamp - lastClickTime) < app.params.fastClicksDelayBetweenClicks) {
                    e.preventDefault();
                }
        
                if (app.params.activeState) {
                    activableElement = findActivableElement(targetElement);
                    // If it's inside a scrollable view, we don't trigger active-state yet,
                    // because it can be a scroll instead. Based on the link:
                    // http://labnote.beedesk.com/click-scroll-and-pseudo-active-on-mobile-webk
                    if (!isInsideScrollableView(activableElement)) {
                        addActive();
                    } else {
                        activeTimeout = setTimeout(addActive, 80);
                    }
                }
                if (app.params.material && app.params.materialRipple) {
                    rippleTouchStart(targetElement, touchStartX, touchStartY);
                }
            }
            function handleTouchMove(e) {
                if (!trackClick) return;
                var _isMoved = false;
                var distance = app.params.fastClicksDistanceThreshold;
                if (distance) {
                    var pageX = e.targetTouches[0].pageX;
                    var pageY = e.targetTouches[0].pageY;
                    if (Math.abs(pageX - touchStartX) > distance ||  Math.abs(pageY - touchStartY) > distance) {
                        _isMoved = true;
                    }
                }
                else {
                    _isMoved = true;
                }
                if (_isMoved) {
                    trackClick = false;
                    targetElement = null;
                    isMoved = true;
                    if (app.params.tapHold) {
                        clearTimeout(tapHoldTimeout);
                    }
        			if (app.params.activeState) {
        				clearTimeout(activeTimeout);
        				removeActive();
        			}
                    if (app.params.material && app.params.materialRipple) {
                        rippleTouchMove();
                    }
                }
            }
            function handleTouchEnd(e) {
                clearTimeout(activeTimeout);
                clearTimeout(tapHoldTimeout);
        
                if (!trackClick) {
                    if (!activeSelection && needsFastClick) {
                        if (!(app.device.android && !e.cancelable)) {
                            e.preventDefault();
                        }
                    }
                    return true;
                }
        
                if (document.activeElement === e.target) {
                    if (app.params.activeState) removeActive();
                    if (app.params.material && app.params.materialRipple) {
                        rippleTouchEnd();
                    }
                    return true;
                }
        
                if (!activeSelection) {
                    e.preventDefault();
                }
        
                if ((e.timeStamp - lastClickTime) < app.params.fastClicksDelayBetweenClicks) {
                    setTimeout(removeActive, 0);
                    return true;
                }
        
                lastClickTime = e.timeStamp;
        
                trackClick = false;
        
                if (app.device.ios && scrollParent) {
                    if (scrollParent.scrollTop !== scrollParent.f7ScrollTop) {
                        return false;
                    }
                }
        
                // Add active-state here because, in a very fast tap, the timeout didn't
                // have the chance to execute. Removing active-state in a timeout gives
                // the chance to the animation execute.
                if (app.params.activeState) {
                    addActive();
                    setTimeout(removeActive, 0);
                }
                // Remove Ripple
                if (app.params.material && app.params.materialRipple) {
                    rippleTouchEnd();
                }
        
                // Trigger focus when required
                if (targetNeedsFocus(targetElement)) {
                    if (app.device.ios && app.device.webView) {
                        if ((event.timeStamp - touchStartTime) > 159) {
                            targetElement = null;
                            return false;
                        }
                        targetElement.focus();
                        return false;
                    }
                    else {
                        targetElement.focus();
                    }
                }
        
                // Blur active elements
                if (document.activeElement && targetElement !== document.activeElement && document.activeElement !== document.body && targetElement.nodeName.toLowerCase() !== 'label') {
                    document.activeElement.blur();
                }
        
                // Send click
                e.preventDefault();
                sendClick(e);
                return false;
            }
            function handleTouchCancel(e) {
                trackClick = false;
                targetElement = null;
        
                // Remove Active State
                clearTimeout(activeTimeout);
                clearTimeout(tapHoldTimeout);
                if (app.params.activeState) {
                    removeActive();
                }
        
                // Remove Ripple
                if (app.params.material && app.params.materialRipple) {
                    rippleTouchEnd();
                }
            }
        
            function handleClick(e) {
                var allowClick = false;
        
                if (trackClick) {
                    targetElement = null;
                    trackClick = false;
                    return true;
                }
                if (e.target.type === 'submit' && e.detail === 0) {
                    return true;
                }
                if (!targetElement) {
                    if (!isFormElement(e.target)) {
                        allowClick =  true;
                    }
                }
                if (!needsFastClick) {
                    allowClick = true;
                }
                if (document.activeElement === targetElement) {
                    allowClick =  true;
                }
                if (e.forwardedTouchEvent) {
                    allowClick =  true;
                }
                if (!e.cancelable) {
                    allowClick =  true;
                }
                if (app.params.tapHold && app.params.tapHoldPreventClicks && tapHoldFired) {
                    allowClick = false;
                }
                if (!allowClick) {
                    e.stopImmediatePropagation();
                    e.stopPropagation();
                    if (targetElement) {
                        if (targetNeedsPrevent(targetElement) || isMoved) {
                            e.preventDefault();
                        }
                    }
                    else {
                        e.preventDefault();
                    }
                    targetElement = null;
                }
                needsFastClickTimeOut = setTimeout(function () {
                    needsFastClick = false;
                }, (app.device.ios || app.device.androidChrome ? 100 : 400));
        
                if (app.params.tapHold) {
                    tapHoldTimeout = setTimeout(function () {
                        tapHoldFired = false;
                    }, (app.device.ios || app.device.androidChrome ? 100 : 400));
                }
        
                return allowClick;
            }
            if (app.support.touch) {
                document.addEventListener('click', handleClick, true);
        
                document.addEventListener('touchstart', handleTouchStart);
                document.addEventListener('touchmove', handleTouchMove);
                document.addEventListener('touchend', handleTouchEnd);
                document.addEventListener('touchcancel', handleTouchCancel);
            }
            else {
                if (app.params.activeState) {
                    document.addEventListener('mousedown', handleMouseDown);
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                }
            }
            if (app.params.material && app.params.materialRipple) {
                document.addEventListener('contextmenu', function (e) {
                    if (activableElement) removeActive();
                    rippleTouchEnd();
                });
            }
        
        };
        

        /*===============================================================================
        ************   Handle clicks and make them fast (on tap);   ************
        ===============================================================================*/
        app.initClickEvents = function () {
            function handleScrollTop(e) {
                /*jshint validthis:true */
                var clicked = $(this);
                var target = $(e.target);
                var isLink = clicked[0].nodeName.toLowerCase() === 'a' ||
                             clicked.parents('a').length > 0 ||
                             target[0].nodeName.toLowerCase() === 'a' ||
                             target.parents('a').length > 0;
        
                if (isLink) return;
                var pageContent, page;
                if (app.params.scrollTopOnNavbarClick && clicked.is('.navbar .center')) {
                    // Find active page
                    var navbar = clicked.parents('.navbar');
        
                    // Static Layout
                    pageContent = navbar.parents('.page-content');
        
                    if (pageContent.length === 0) {
                        // Fixed Layout
                        if (navbar.parents('.page').length > 0) {
                            pageContent = navbar.parents('.page').find('.page-content');
                        }
                        // Through Layout
                        if (pageContent.length === 0) {
                            if (navbar.nextAll('.pages').length > 0) {
                                pageContent = navbar.nextAll('.pages').find('.page:not(.page-on-left):not(.page-on-right):not(.cached)').find('.page-content');
                            }
                        }
                    }
                }
                if (app.params.scrollTopOnStatusbarClick && clicked.is('.statusbar-overlay')) {
                    if ($('.popup.modal-in').length > 0) {
                        // Check for opened popup
                        pageContent = $('.popup.modal-in').find('.page:not(.page-on-left):not(.page-on-right):not(.cached)').find('.page-content');
                    }
                    else if ($('.panel.active').length > 0) {
                        // Check for opened panel
                        pageContent = $('.panel.active').find('.page:not(.page-on-left):not(.page-on-right):not(.cached)').find('.page-content');
                    }
                    else if ($('.views > .view.active').length > 0) {
                        // View in tab bar app layout
                        pageContent = $('.views > .view.active').find('.page:not(.page-on-left):not(.page-on-right):not(.cached)').find('.page-content');
                    }
                    else {
                        // Usual case
                        pageContent = $('.views').find('.page:not(.page-on-left):not(.page-on-right):not(.cached)').find('.page-content');
                    }
                }
        
                if (pageContent && pageContent.length > 0) {
                    // Check for tab
                    if (pageContent.hasClass('tab')) {
                        pageContent = pageContent.parent('.tabs').children('.page-content.active');
                    }
                    if (pageContent.length > 0) pageContent.scrollTop(0, 300);
                }
            }
            function handleClicks(e) {
                /*jshint validthis:true */
                var clicked = $(this);
                var url = clicked.attr('href');
                var isLink = clicked[0].nodeName.toLowerCase() === 'a';
        
                // Check if link is external
                if (isLink) {
                    if (clicked.is(app.params.externalLinks) || (url && url.indexOf('javascript:') >= 0)) {
                        if(url && clicked.attr('target') === '_system') {
                            e.preventDefault();
                            window.open(url, '_system');
                        }
                        return;
                    }
                }
        
                // Collect Clicked data- attributes
                var clickedData = clicked.dataset();
        
                // Smart Select
                if (clicked.hasClass('smart-select')) {
                    if (app.smartSelectOpen) app.smartSelectOpen(clicked);
                }
        
                // Open Panel
                if (clicked.hasClass('open-panel')) {
                    if ($('.panel').length === 1) {
                        if ($('.panel').hasClass('panel-left')) app.openPanel('left');
                        else app.openPanel('right');
                    }
                    else {
                        if (clickedData.panel === 'right') app.openPanel('right');
                        else app.openPanel('left');
                    }
                }
                // Close Panel
                if (clicked.hasClass('close-panel')) {
                    app.closePanel();
                }
        
                if (clicked.hasClass('panel-overlay') && app.params.panelsCloseByOutside) {
                    app.closePanel();
                }
                // Popover
                if (clicked.hasClass('open-popover')) {
                    var popover;
                    if (clickedData.popover) {
                        popover = clickedData.popover;
                    }
                    else popover = '.popover';
                    app.popover(popover, clicked);
                }
                if (clicked.hasClass('close-popover')) {
                    app.closeModal('.popover.modal-in');
                }
                // Popup
                var popup;
                if (clicked.hasClass('open-popup')) {
                    if (clickedData.popup) {
                        popup = clickedData.popup;
                    }
                    else popup = '.popup';
                    app.popup(popup);
                }
                if (clicked.hasClass('close-popup')) {
                    if (clickedData.popup) {
                        popup = clickedData.popup;
                    }
                    else popup = '.popup.modal-in';
                    app.closeModal(popup);
                }
                // Login Screen
                var loginScreen;
                if (clicked.hasClass('open-login-screen')) {
                    if (clickedData.loginScreen) {
                        loginScreen = clickedData.loginScreen;
                    }
                    else loginScreen = '.login-screen';
                    app.loginScreen(loginScreen);
                }
                if (clicked.hasClass('close-login-screen')) {
                    app.closeModal('.login-screen.modal-in');
                }
                // Close Modal
                if (clicked.hasClass('modal-overlay')) {
                    if ($('.modal.modal-in').length > 0 && app.params.modalCloseByOutside)
                        app.closeModal('.modal.modal-in');
                    if ($('.actions-modal.modal-in').length > 0 && app.params.actionsCloseByOutside)
                        app.closeModal('.actions-modal.modal-in');
        
                    if ($('.popover.modal-in').length > 0) app.closeModal('.popover.modal-in');
                }
                if (clicked.hasClass('popup-overlay')) {
                    if ($('.popup.modal-in').length > 0 && app.params.popupCloseByOutside)
                        app.closeModal('.popup.modal-in');
                }
                if (clicked.hasClass('picker-modal-overlay')) {
                    if ($('.picker-modal.modal-in').length > 0)
                        app.closeModal('.picker-modal.modal-in');
                }
        
                // Picker
                if (clicked.hasClass('close-picker')) {
                    var pickerToClose = $('.picker-modal.modal-in');
                    if (pickerToClose.length > 0) {
                        app.closeModal(pickerToClose);
                    }
                    else {
                        pickerToClose = $('.popover.modal-in .picker-modal');
                        if (pickerToClose.length > 0) {
                            app.closeModal(pickerToClose.parents('.popover'));
                        }
                    }
                }
                if (clicked.hasClass('open-picker')) {
                    var pickerToOpen;
                    if (clickedData.picker) {
                        pickerToOpen = clickedData.picker;
                    }
                    else pickerToOpen = '.picker-modal';
                    app.pickerModal(pickerToOpen, clicked);
                }
        
                // Tabs
                var isTabLink;
                if (clicked.hasClass('tab-link')) {
                    isTabLink = true;
                    app.showTab(clickedData.tab || clicked.attr('href'), clicked);
                }
                // Swipeout Close
                if (clicked.hasClass('swipeout-close')) {
                    app.swipeoutClose(clicked.parents('.swipeout-opened'));
                }
                // Swipeout Delete
                if (clicked.hasClass('swipeout-delete')) {
                    if (clickedData.confirm) {
                        var text = clickedData.confirm;
                        var title = clickedData.confirmTitle;
                        if (title) {
                            app.confirm(text, title, function () {
                                app.swipeoutDelete(clicked.parents('.swipeout'));
                            }, function () {
                                if (clickedData.closeOnCancel) app.swipeoutClose(clicked.parents('.swipeout'));
                            });
                        }
                        else {
                            app.confirm(text, function () {
                                app.swipeoutDelete(clicked.parents('.swipeout'));
                            }, function () {
                                if (clickedData.closeOnCancel) app.swipeoutClose(clicked.parents('.swipeout'));
                            });
                        }
                    }
                    else {
                        app.swipeoutDelete(clicked.parents('.swipeout'));
                    }
        
                }
                // Sortable
                if (clicked.hasClass('toggle-sortable')) {
                    app.sortableToggle(clickedData.sortable);
                }
                if (clicked.hasClass('open-sortable')) {
                    app.sortableOpen(clickedData.sortable);
                }
                if (clicked.hasClass('close-sortable')) {
                    app.sortableClose(clickedData.sortable);
                }
                // Accordion
                if (clicked.hasClass('accordion-item-toggle') || (clicked.hasClass('item-link') && clicked.parent().hasClass('accordion-item'))) {
                    var accordionItem = clicked.parent('.accordion-item');
                    if (accordionItem.length === 0) accordionItem = clicked.parents('.accordion-item');
                    if (accordionItem.length === 0) accordionItem = clicked.parents('li');
                    app.accordionToggle(accordionItem);
                }
        
                // Speed Dial
                if (app.params.material) {
                    if (clicked.hasClass('floating-button') && clicked.parent().hasClass('speed-dial')) {
                        clicked.parent().toggleClass('speed-dial-opened');
                    }
                    if (clicked.hasClass('close-speed-dial')) {
                        $('.speed-dial-opened').removeClass('speed-dial-opened');
                    }
                }
        
                // Load Page
                if (app.params.ajaxLinks && !clicked.is(app.params.ajaxLinks) || !isLink || !app.params.router) {
                    return;
                }
                if (isLink) {
                    e.preventDefault();
                }
        
                var validUrl = url && url.length > 0 && url !== '#' && !isTabLink;
                var template = clickedData.template;
                if (validUrl || clicked.hasClass('back') || template) {
                    var view;
                    if (clickedData.view) {
                        view = $(clickedData.view)[0].f7View;
                    }
                    else {
                        view = clicked.parents('.' + app.params.viewClass)[0] && clicked.parents('.' + app.params.viewClass)[0].f7View;
                        if (view && view.params.linksView) {
                            if (typeof view.params.linksView === 'string') view = $(view.params.linksView)[0].f7View;
                            else if (view.params.linksView instanceof View) view = view.params.linksView;
                        }
                    }
                    if (!view) {
                        if (app.mainView) view = app.mainView;
                    }
                    if (!view) return;
        
                    var pageName;
                    if (!template) {
                        if (url.indexOf('#') === 0 && url !== '#')  {
                            if (view.params.domCache) {
                                pageName = url.split('#')[1];
                            }
                            else return;
                        }
                        if (url === '#' && !clicked.hasClass('back')) return;
                    }
                    else {
                        url = undefined;
                    }
        
                    var animatePages;
                    if (typeof clickedData.animatePages !== 'undefined') {
                        animatePages = clickedData.animatePages;
                    }
                    else {
                        if (clicked.hasClass('with-animation')) animatePages = true;
                        if (clicked.hasClass('no-animation')) animatePages = false;
                    }
        
                    var options = {
                        animatePages: animatePages,
                        ignoreCache: clickedData.ignoreCache,
                        force: clickedData.force,
                        reload: clickedData.reload,
                        reloadPrevious: clickedData.reloadPrevious,
                        pageName: pageName,
                        pushState: clickedData.pushState,
                        url: url
                    };
        
                    if (app.params.template7Pages) {
                        options.contextName = clickedData.contextName;
                        var context = clickedData.context;
                        if (context) {
                            options.context = JSON.parse(context);
                        }
                    }
                    if (template && template in t7.templates) {
                        options.template = t7.templates[template];
                    }
        
                    if (clicked.hasClass('back')) view.router.back(options);
                    else view.router.load(options);
                }
            }
            $(document).on('click', 'a, .open-panel, .close-panel, .panel-overlay, .modal-overlay, .popup-overlay, .swipeout-delete, .swipeout-close, .close-popup, .open-popup, .open-popover, .open-login-screen, .close-login-screen .smart-select, .toggle-sortable, .open-sortable, .close-sortable, .accordion-item-toggle, .close-picker, .picker-modal-overlay', handleClicks);
            if (app.params.scrollTopOnNavbarClick || app.params.scrollTopOnStatusbarClick) {
                $(document).on('click', '.statusbar-overlay, .navbar .center', handleScrollTop);
            }
        
            // Prevent scrolling on overlays
            function preventScrolling(e) {
                e.preventDefault();
            }
            if (app.support.touch && !app.device.android) {
                $(document).on((app.params.fastClicks ? 'touchstart' : 'touchmove'), '.panel-overlay, .modal-overlay, .preloader-indicator-overlay, .popup-overlay, .searchbar-overlay', preventScrolling);
            }
        };
        

        /*======================================================
        ************   App Resize Actions   ************
        ======================================================*/
        // Prevent iPad horizontal body scrolling when soft keyboard is opened
        function _fixIpadBodyScrolLeft() {
            if (app.device.ipad) {
                document.body.scrollLeft = 0;
                setTimeout(function () {
                    document.body.scrollLeft = 0;
                }, 0);
            }
        }
        app.initResize = function () {
            $(window).on('resize', app.resize);
            $(window).on('orientationchange', app.orientationchange);
        };
        app.resize = function () {
            if (app.sizeNavbars) app.sizeNavbars();
            _fixIpadBodyScrolLeft();
            
        };
        app.orientationchange = function () {
            if (app.device && app.device.minimalUi) {
                if (window.orientation === 90 || window.orientation === -90) document.body.scrollTop = 0;
            }
            _fixIpadBodyScrolLeft();
        };
        

        /*===============================================================================
        ************   Store and parse forms data   ************
        ===============================================================================*/
        app.formsData = {};
        app.formStoreData = function (formId, formJSON) {
            // Store form data in app.formsData
            app.formsData[formId] = formJSON;
        
            // Store form data in local storage also
            app.ls['f7form-' + formId] = JSON.stringify(formJSON);
        };
        app.formDeleteData = function (formId) {
            // Delete form data from app.formsData
            if (app.formsData[formId]) {
                app.formsData[formId] = '';
                delete app.formsData[formId];
            }
        
            // Delete form data from local storage also
            if (app.ls['f7form-' + formId]) {
                app.ls['f7form-' + formId] = '';
                app.ls.removeItem('f7form-' + formId);
            }
        };
        app.formGetData = function (formId) {
            // First of all check in local storage
            if (app.ls['f7form-' + formId]) {
                return JSON.parse(app.ls['f7form-' + formId]);
            }
            // Try to get it from formsData obj
            else if (app.formsData[formId]) return app.formsData[formId];
        };
        app.formToJSON = function (form) {
            form = $(form);
            if (form.length !== 1) return false;
        
            // Form data
            var formData = {};
        
            // Skip input types
            var skipTypes = ['submit', 'image', 'button', 'file'];
            var skipNames = [];
            form.find('input, select, textarea').each(function () {
                var input = $(this);
                var name = input.attr('name');
                var type = input.attr('type');
                var tag = this.nodeName.toLowerCase();
                if (skipTypes.indexOf(type) >= 0) return;
                if (skipNames.indexOf(name) >= 0 || !name) return;
                if (tag === 'select' && input.prop('multiple')) {
                    skipNames.push(name);
                    formData[name] = [];
                    form.find('select[name="' + name + '"] option').each(function () {
                        if (this.selected) formData[name].push(this.value);
                    });
                }
                else {
                    switch (type) {
                        case 'checkbox' :
                            skipNames.push(name);
                            formData[name] = [];
                            form.find('input[name="' + name + '"]').each(function () {
                                if (this.checked) formData[name].push(this.value);
                            });
                            break;
                        case 'radio' :
                            skipNames.push(name);
                            form.find('input[name="' + name + '"]').each(function () {
                                if (this.checked) formData[name] = this.value;
                            });
                            break;
                        default :
                            formData[name] = input.val();
                            break;
                    }
                }
                    
            });
            form.trigger('formToJSON', {formData: formData});
        
            return formData;
        };
        app.formFromJSON = function (form, formData) {
            form = $(form);
            if (form.length !== 1) return false;
        
            // Skip input types
            var skipTypes = ['submit', 'image', 'button', 'file'];
            var skipNames = [];
        
            form.find('input, select, textarea').each(function () {
                var input = $(this);
                var name = input.attr('name');
                var type = input.attr('type');
                var tag = this.nodeName.toLowerCase();
                if (!formData[name]) return;
                if (skipTypes.indexOf(type) >= 0) return;
                if (skipNames.indexOf(name) >= 0 || !name) return;
                if (tag === 'select' && input.prop('multiple')) {
                    skipNames.push(name);
                    form.find('select[name="' + name + '"] option').each(function () {
                        if (formData[name].indexOf(this.value) >= 0) this.selected = true;
                        else this.selected = false;
                    });
                }
                else {
                    switch (type) {
                        case 'checkbox' :
                            skipNames.push(name);
                            form.find('input[name="' + name + '"]').each(function () {
                                if (formData[name].indexOf(this.value) >= 0) this.checked = true;
                                else this.checked = false;
                            });
                            break;
                        case 'radio' :
                            skipNames.push(name);
                            form.find('input[name="' + name + '"]').each(function () {
                                if (formData[name] === this.value) this.checked = true;
                                else this.checked = false;
                            });
                            break;
                        default :
                            input.val(formData[name]);
                            break;
                    }
                }
                    
            });
            form.trigger('formFromJSON', {formData: formData});
        };
        app.initFormsStorage = function (pageContainer) {
            pageContainer = $(pageContainer);
            var forms = pageContainer.find('form.store-data');
            if (forms.length === 0) return;
            
            // Parse forms data and fill form if there is such data
            forms.each(function () {
                var id = this.getAttribute('id');
                if (!id) return;
                var formData = app.formGetData(id);
                if (formData) app.formFromJSON(this, formData);
            });
            // Update forms data on inputs change
            function storeForm() {
                /*jshint validthis:true */
                var form = $(this);
                var formId = form[0].id;
                if (!formId) return;
                var formJSON = app.formToJSON(form);
                if (!formJSON) return;
                app.formStoreData(formId, formJSON);
                form.trigger('store', {data: formJSON});
            }
            forms.on('change submit', storeForm);
        
            // Detach Listeners
            function pageBeforeRemove() {
                forms.off('change submit', storeForm);
                pageContainer.off('pageBeforeRemove', pageBeforeRemove);
            }
            pageContainer.on('pageBeforeRemove', pageBeforeRemove);
        };

        /*===============================================================================
        ************   Ajax submit for forms   ************
        ===============================================================================*/
        // Ajax submit on forms
        $(document).on('submit change', 'form.ajax-submit, form.ajax-submit-onchange', function (e) {
            var form = $(this);
            if (e.type === 'change' && !form.hasClass('ajax-submit-onchange')) return;
            if (e.type === 'submit') e.preventDefault();
            
            var method = form.attr('method') || 'GET';
            var contentType = form.prop('enctype') || form.attr('enctype');
        
            var url = form.attr('action');
            if (!url) return;
        
            var data;
            if (method === 'POST') data = new FormData(form[0]);
            else data = $.serializeObject(app.formToJSON(form[0]));
        
            var xhr = $.ajax({
                method: method,
                url: url,
                contentType: contentType,
                data: data,
                beforeSend: function (xhr) {
                    form.trigger('beforeSubmit', {data:data, xhr: xhr});
                },
                error: function (xhr) {
                    form.trigger('submitError', {data:data, xhr: xhr});  
                },
                success: function (data) {
                    form.trigger('submitted', {data: data, xhr: xhr});
                }
            });
        });
        
        

        /*===============================================================================
        ************   Resizable textarea   ************
        ===============================================================================*/
        app.resizeTextarea = function (textarea) {
            textarea = $(textarea);
            if (!textarea.hasClass('resizable')) {
                return;
            }
            textarea.css({'height': ''});
            var height = textarea[0].offsetHeight;
            var diff = height - textarea[0].clientHeight;
            var scrollHeight = textarea[0].scrollHeight;
        
            if (scrollHeight + diff > height) {
                var newAreaHeight = scrollHeight + diff;
                textarea.css('height', newAreaHeight + 'px');
            }
        };
        app.resizableTextarea = function (textarea) {
            textarea = $(textarea);
            if (textarea.length === 0) return;
            var textareaTimeout;
            function handleTextarea() {
                clearTimeout(textareaTimeout);
                textareaTimeout = setTimeout(function () {
                    app.resizeTextarea(textarea);
                }, 0);
            }
            textarea[0].f7DestroyResizableTextarea = function () {
                textarea.off('change keydown keypress keyup paste cut', handleTextarea);
            };
            return textarea.on('change keydown keypress keyup paste cut', handleTextarea);
        };
        app.destroyResizableTextarea = function (pageContainer) {
            pageContainer = $(pageContainer);
            if (pageContainer.length > 0 && pageContainer.is('textarea') && pageContainer[0].f7DestroyResizableTextarea) {
                pageContainer[0].f7DestroyResizableTextarea();
            }
            else if (pageContainer.length > 0) {
                pageContainer.find('textarea.resiable').each(function () {
                    var textarea = this;
                    if (textarea.f7DestroyResizableTextarea) {
                        textarea.f7DestroyResizableTextarea ();
                    }
                });
            }
        };
        app.initPageResizableTextarea = function (pageContainer) {
            pageContainer = $(pageContainer);
            var textareas = pageContainer.find('textarea.resizable');
            textareas.each(function () {
                app.resizableTextarea(this);
            });
        };

        /*======================================================
        ************   Material Text Inputs   ************
        ======================================================*/
        app.initPageMaterialInputs = function (pageContainer) {
            pageContainer = $(pageContainer);
            var textareas = pageContainer.find('textarea.resizable');
            pageContainer.find('.item-input').each(function () {
                var itemInput = $(this);
                var notInputs = ['checkbox', 'button', 'submit', 'range', 'radio', 'image'];
                itemInput.find('input, select, textarea').each(function () {
                    var input = $(this);
                    if (notInputs.indexOf(input.attr('type')) < 0) {
                        itemInput.addClass('item-input-field');
                        if (input.val().trim() !== '') {
                            input.parents('.item-input, .input-field').add(input.parents('.item-inner')).addClass('not-empty-state');
                        }
                    }
                });
                if (itemInput.parents('.input-item, .inputs-list').length > 0) return;
                itemInput.parents('.list-block').eq(0).addClass('inputs-list');
            });
        };
        /*======================================================
        ************   Material Focus Inputs   ************
        ======================================================*/
        app.initMaterialWatchInputs = function () {
            var notInputs = ['checkbox', 'button', 'submit', 'range', 'radio', 'image'];
            function addFocusState(e) {
                /*jshint validthis:true*/
                var i = $(this);
                var type = i.attr('type');
                if (notInputs.indexOf(type) >= 0) return;
                var els = i.add(i.parents('.item-input, .input-field')).add(i.parents('.item-inner').eq(0));
                els.addClass('focus-state');
            }
            function removeFocusState(e) {
                /*jshint validthis:true*/
                var i = $(this), value = i.val();
                var type = i.attr('type');
                if (notInputs.indexOf(type) >= 0) return;
                var els = i.add(i.parents('.item-input, .input-field')).add(i.parents('.item-inner').eq(0));
                els.removeClass('focus-state');
                if (value && value.trim() !== '') {
                    els.addClass('not-empty-state');
                }
                else {
                    els.removeClass('not-empty-state');
                }
            }
            function watchChangeState(e) {
                /*jshint validthis:true*/
                var i = $(this), value = i.val();
                var type = i.attr('type');
                if (notInputs.indexOf(type) >= 0) return;
                var els = i.add(i.parents('.item-input, .input-field')).add(i.parents('.item-inner').eq(0));
                if (value && value.trim() !== '') {
                    els.addClass('not-empty-state');
                }
                else {
                    els.removeClass('not-empty-state');
                }
            }
            $(document).on('change', '.item-input input, .item-input select, .item-input textarea, input, textarea, select', watchChangeState, true);
            $(document).on('focus', '.item-input input, .item-input select, .item-input textarea, input, textarea, select', addFocusState, true);
            $(document).on('blur', '.item-input input, .item-input select, .item-input textarea, input, textarea, select', removeFocusState, true);
        };

        /*======================================================
        ************   Handle Browser's History   ************
        ======================================================*/
        app.pushStateQueue = [];
        app.pushStateClearQueue = function () {
            if (app.pushStateQueue.length === 0) return;
            var queue = app.pushStateQueue.pop();
            var animatePages;
            if (app.params.pushStateNoAnimation === true) animatePages = false;
            if (queue.action === 'back') {
                app.router.back(queue.view, {animatePages: animatePages});
            }
            if (queue.action === 'loadPage') {
                app.router.load(queue.view, {url: queue.stateUrl, animatePages: animatePages, pushState: false});
            }
            if (queue.action === 'loadContent') {
                app.router.load(queue.view, {content: queue.stateContent, animatePages: animatePages, pushState: false});
            }
            if (queue.action === 'loadPageName') {
                app.router.load(queue.view, {pageName: queue.statePageName, url: queue.stateUrl, animatePages: animatePages, pushState: false});
            }
        };
        
        app.initPushState = function () {
            var blockPopstate = true;
            $(window).on('load', function () {
                setTimeout(function () {
                    blockPopstate = false;
                }, 0);
            });
        
            if (document.readyState && document.readyState === 'complete') {
                blockPopstate = false;
            }
        
            function handlePopState(e) {
                if (blockPopstate) return;
                var mainView = app.mainView;
                if (!mainView) return;
                var state = e.state;
                if (!state) {
                    state = {
                        viewIndex: app.views.indexOf(mainView),
                        url : mainView.history[0]
                    };
                }
                if (state.viewIndex < 0) return;
                var view = app.views[state.viewIndex];
                var stateUrl = state && state.url || undefined;
                var stateContent = state && state.content || undefined;
                var statePageName = state && state.pageName || undefined;
                var animatePages;
        
                if (app.params.pushStateNoAnimation === true) animatePages = false;
        
                if (stateUrl !== view.url) {
                    if (view.history.indexOf(stateUrl) >= 0) {
                        // Go Back
                        if (view.allowPageChange) {
                            app.router.back(view, {url:undefined, animatePages: animatePages, pushState: false, preloadOnly:false});
                        }
                        else {
                            app.pushStateQueue.push({
                                action: 'back',
                                view: view
                            });
                        }
                    }
                    else if (stateContent) {
                        // Load Page
                        if (view.allowPageChange) {
                            app.router.load(view, {content:stateContent, animatePages: animatePages, pushState: false});
                        }
                        else {
                            app.pushStateQueue.unshift({
                                action: 'loadContent',
                                stateContent: stateContent,
                                view: view
                            });
                        }
        
                    }
                    else if (statePageName) {
                        // Load Page by page name with Dom Cache
                        if (view.allowPageChange) {
                            app.router.load(view, {pageName:statePageName, url: stateUrl, animatePages: animatePages, pushState: false});
                        }
                        else {
                            app.pushStateQueue.unshift({
                                action: 'loadPageName',
                                statePageName: statePageName,
                                view: view
                            });
                        }
                    }
                    else  {
                        // Load Page
                        if (view.allowPageChange) {
                            app.router.load(view, {url:stateUrl, animatePages: animatePages, pushState: false});
                        }
                        else {
                            app.pushStateQueue.unshift({
                                action: 'loadPage',
                                stateUrl: stateUrl,
                                view: view
                            });
                        }
                    }
                }
            }
            $(window).on('popstate', handlePopState);
        };
        

        /*===========================
        Framework7 Swiper Additions
        ===========================*/
        app.swiper = function (container, params) {
            return new Swiper(container, params);
        };
        app.initPageSwiper = function (pageContainer) {
            pageContainer = $(pageContainer);
            var swipers = pageContainer.find('.swiper-init, .tabs-swipeable-wrap');
            if (swipers.length === 0) return;
            function destroySwiperOnRemove(slider) {
                function destroySwiper() {
                    slider.destroy();
                    pageContainer.off('pageBeforeRemove', destroySwiper);
                }
                pageContainer.on('pageBeforeRemove', destroySwiper);
            }
            swipers.each(function () {
                var swiper = $(this);
                if (swiper.hasClass('tabs-swipeable-wrap')) {
                    swiper.addClass('swiper-container').children('.tabs').addClass('swiper-wrapper').children('.tab').addClass('swiper-slide');
                }
                var params;
                if (swiper.data('swiper')) {
                    params = JSON.parse(swiper.data('swiper'));
                }
                else {
                    params = swiper.dataset();
                }
                if (swiper.hasClass('tabs-swipeable-wrap')) {
                    params.onSlideChangeStart = function (s) {
                        app.showTab(s.slides.eq(s.activeIndex));
                    };
                }
                var _slider = app.swiper(swiper[0], params);
                destroySwiperOnRemove(_slider);
            });
        };
        app.reinitPageSwiper = function (pageContainer) {
            pageContainer = $(pageContainer);
            var sliders = pageContainer.find('.swiper-init, .tabs-swipeable-wrap');
            if (sliders.length === 0) return;
            for (var i = 0; i < sliders.length; i++) {
                var sliderInstance = sliders[0].swiper;
                if (sliderInstance) {
                    sliderInstance.update(true);
                }
            }
        };
        

        /*======================================================
        ************   Photo Browser   ************
        ======================================================*/
        var PhotoBrowser = function (params) {
            var pb = this, i;
        
            var defaults = {
                photos : [],
                initialSlide: 0,
                spaceBetween: 20,
                speed: 300,
                zoom: true,
                maxZoom: 3,
                minZoom: 1,
                exposition: true,
                expositionHideCaptions: false,
                type: 'standalone',
                navbar: true,
                toolbar: true,
                theme: 'light',
                swipeToClose: true,
                backLinkText: 'Close',
                ofText: 'of',
                loop: false,
                lazyLoading: false,
                lazyLoadingInPrevNext: false,
                lazyLoadingOnTransitionStart: false,
                material: app.params.material,
                materialPreloaderSvg: app.params.materialPreloaderSvg,
                materialPreloaderHtml: app.params.materialPreloaderHtml,
                /*
                Callbacks:
                onLazyImageLoad(pb, slide, img)
                onLazyImageReady(pb, slide, img)
                onOpen(pb)
                onClose(pb)
                onTransitionStart(swiper)
                onTransitionEnd(swiper)
                onSlideChangeStart(swiper)
                onSlideChangeEnd(swiper)
                onTap(swiper, e)
                onClick(swiper, e)
                onDoubleTap(swiper, e)
                onSwipeToClose(pb)
                */
            };
            
            params = params || {};
            if (!params.backLinkText && app.params.material) defaults.backLinkText = '';
            for (var def in defaults) {
                if (typeof params[def] === 'undefined') {
                    params[def] = defaults[def];
                }
            }
        
            pb.params = params;
            pb.params.iconsColorClass = pb.params.iconsColor ? 'color-' + pb.params.iconsColor : (pb.params.theme === 'dark' ? 'color-white' : '');
            pb.params.preloaderColorClass = pb.params.theme === 'dark' ? 'preloader-white' : '';
        
            // Templates
            var photoTemplate = pb.params.photoTemplate || 
                '<div class="photo-browser-slide swiper-slide">' +
                    '<span class="photo-browser-zoom-container">' +
                        '<img src="{{js "this.url || this"}}">' +
                    '</span>' +
                '</div>';
            var photoLazyTemplate = pb.params.lazyPhotoTemplate ||
                '<div class="photo-browser-slide photo-browser-slide-lazy swiper-slide">' +
                    '<div class="preloader {{@root.preloaderColorClass}}">{{#if @root.material}}{{@root.materialPreloaderHtml}}{{/if}}</div>' +
                    '<span class="photo-browser-zoom-container">' +
                        '<img data-src="{{js "this.url || this"}}" class="swiper-lazy">' +
                    '</span>' +
                '</div>';
            var objectTemplate = pb.params.objectTemplate ||
                '<div class="photo-browser-slide photo-browser-object-slide swiper-slide">{{js "this.html || this"}}</div>';
            var captionTemplate = pb.params.captionTemplate ||
                '<div class="photo-browser-caption" data-caption-index="{{@index}}">' +
                    '{{caption}}' +
                '</div>';
            var navbarTemplate = pb.params.navbarTemplate ||
                '<div class="navbar">' +
                    '<div class="navbar-inner">' +
                        '<div class="left sliding">' +
                            '<a href="#" class="link close-popup photo-browser-close-link {{#unless backLinkText}}icon-only{{/unless}} {{js "this.type === \'page\' ? \'back\' : \'\'"}}">' +
                                '<i class="icon icon-back {{iconsColorClass}}"></i>' +
                                '{{#if backLinkText}}<span>{{backLinkText}}</span>{{/if}}' +
                            '</a>' +
                        '</div>' +
                        '<div class="center sliding">' +
                            '<span class="photo-browser-current"></span> ' +
                            '<span class="photo-browser-of">{{ofText}}</span> ' +
                            '<span class="photo-browser-total"></span>' +
                        '</div>' +
                        '<div class="right"></div>' +
                    '</div>' +
                '</div>';
            var toolbarTemplate = pb.params.toolbarTemplate ||
                '<div class="toolbar tabbar">' +
                    '<div class="toolbar-inner">' +
                        '<a href="#" class="link photo-browser-prev">' +
                            '<i class="icon icon-prev {{iconsColorClass}}"></i>' +
                        '</a>' +
                        '<a href="#" class="link photo-browser-next">' +
                            '<i class="icon icon-next {{iconsColorClass}}"></i>' +
                        '</a>' +
                    '</div>' +
                '</div>';
        
            var htmlTemplate = t7.compile('<div class="photo-browser photo-browser-{{theme}}">' +
                    '<div class="view navbar-fixed toolbar-fixed">' +
                        '{{#unless material}}{{#if navbar}}' +
                        navbarTemplate +
                        '{{/if}}{{/unless}}' +
                        '<div class="page no-toolbar {{#unless navbar}}no-navbar{{/unless}} toolbar-fixed navbar-fixed" data-page="photo-browser-slides">' +
                            '{{#if material}}{{#if navbar}}' +
                            navbarTemplate +
                            '{{/if}}{{/if}}' +
                            '{{#if toolbar}}' +
                            toolbarTemplate +
                            '{{/if}}' +
                            '<div class="photo-browser-captions photo-browser-captions-{{js "this.captionsTheme || this.theme"}}">' +
                                '{{#each photos}}{{#if caption}}' +
                                captionTemplate +
                                '{{/if}}{{/each}}' +
                            '</div>' +
                            '<div class="photo-browser-swiper-container swiper-container">' +
                                '<div class="photo-browser-swiper-wrapper swiper-wrapper">' +
                                    '{{#each photos}}' +
                                    '{{#js_compare "this.html || ((typeof this === \'string\' || this instanceof String) && (this.indexOf(\'<\') >= 0 || this.indexOf(\'>\') >= 0))"}}' +
                                        objectTemplate +
                                    '{{else}}' +
                                        '{{#if @root.lazyLoading}}' +
                                        photoLazyTemplate +
                                        '{{else}}' +
                                        photoTemplate +
                                        '{{/if}}' +
                                    '{{/js_compare}}' +
                                    '{{/each}}' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>')(pb.params);
        
            pb.activeIndex = pb.params.initialSlide;
            pb.openIndex = pb.activeIndex;
            pb.opened = false;
        
            pb.open = function (index) {
                if (typeof index === 'undefined') index = pb.activeIndex;
                index = parseInt(index, 10);
                if (pb.opened && pb.swiper) {
                    pb.swiper.slideTo(index);
                    return;
                }
                pb.opened = true;
                pb.openIndex = index;
                if (pb.params.type === 'standalone') {
                    $('body').append(htmlTemplate);
                }
                if (pb.params.type === 'popup') {
                    pb.popup = app.popup('<div class="popup photo-browser-popup">' + htmlTemplate + '</div>');
                    $(pb.popup).on('closed', pb.onPopupClose);
                }
                if (pb.params.type === 'page') {
                    $(document).on('pageBeforeInit', pb.onPageBeforeInit);
                    $(document).on('pageBeforeRemove', pb.onPageBeforeRemove);
                    if (!pb.params.view) pb.params.view = app.mainView;
                    pb.params.view.loadContent(htmlTemplate);
                    return;
                }
                pb.layout(pb.openIndex);
                if (pb.params.onOpen) {
                    pb.params.onOpen(pb);
                }
        
            };
            pb.close = function () {
                pb.opened = false;
                if (!pb.swiperContainer || pb.swiperContainer.length === 0) {
                    return;
                }
                if (pb.params.onClose) {
                    pb.params.onClose(pb);
                }
                // Detach events
                pb.attachEvents(true);
                // Delete from DOM
                if (pb.params.type === 'standalone') {
                    pb.container.removeClass('photo-browser-in').addClass('photo-browser-out').animationEnd(function () {
                        pb.container.remove();
                    });
                }
                // Destroy slider
                pb.swiper.destroy();
                // Delete references
                pb.swiper = pb.swiperContainer = pb.swiperWrapper = pb.slides = gestureSlide = gestureImg = gestureImgWrap = undefined;
            };
        
            pb.onPopupClose = function (e) {
                pb.close();
                $(pb.popup).off('pageBeforeInit', pb.onPopupClose);
            };
            pb.onPageBeforeInit = function (e) {
                if (e.detail.page.name === 'photo-browser-slides') {
                    pb.layout(pb.openIndex);
                }
                $(document).off('pageBeforeInit', pb.onPageBeforeInit);
            };
            pb.onPageBeforeRemove = function (e) {
                if (e.detail.page.name === 'photo-browser-slides') {
                    pb.close();
                }
                $(document).off('pageBeforeRemove', pb.onPageBeforeRemove);
            };
        
            pb.onSliderTransitionStart = function (swiper) {
                pb.activeIndex = swiper.activeIndex;
        
                var current = swiper.activeIndex + 1;
                var total = swiper.slides.length;
                if (pb.params.loop) {
                    total = total - 2;
                    current = current - swiper.loopedSlides;
                    if (current < 1) current = total + current;
                    if (current > total) current = current - total;
                }
                pb.container.find('.photo-browser-current').text(current);
                pb.container.find('.photo-browser-total').text(total);
        
                $('.photo-browser-prev, .photo-browser-next').removeClass('photo-browser-link-inactive');
                
                if (swiper.isBeginning && !pb.params.loop) {
                    $('.photo-browser-prev').addClass('photo-browser-link-inactive');
                }
                if (swiper.isEnd && !pb.params.loop) {
                    $('.photo-browser-next').addClass('photo-browser-link-inactive');
                }
        
                // Update captions
                if (pb.captions.length > 0) {
                    pb.captionsContainer.find('.photo-browser-caption-active').removeClass('photo-browser-caption-active');
                    var captionIndex = pb.params.loop ? swiper.slides.eq(swiper.activeIndex).attr('data-swiper-slide-index') : pb.activeIndex;
                    pb.captionsContainer.find('[data-caption-index="' + captionIndex + '"]').addClass('photo-browser-caption-active');
                }
        
        
                // Stop Video
                var previousSlideVideo = swiper.slides.eq(swiper.previousIndex).find('video');
                if (previousSlideVideo.length > 0) {
                    if ('pause' in previousSlideVideo[0]) previousSlideVideo[0].pause();
                }
                // Callback
                if (pb.params.onTransitionStart) pb.params.onTransitionStart(swiper);
            };
            pb.onSliderTransitionEnd = function (swiper) {
                // Reset zoom
                if (pb.params.zoom && gestureSlide && swiper.previousIndex !== swiper.activeIndex) {
                    gestureImg.transform('translate3d(0,0,0) scale(1)');
                    gestureImgWrap.transform('translate3d(0,0,0)');
                    gestureSlide = gestureImg = gestureImgWrap = undefined;
                    scale = currentScale = 1;
                }
                if (pb.params.onTransitionEnd) pb.params.onTransitionEnd(swiper);
            };
            
            pb.layout = function (index) {
                if (pb.params.type === 'page') {
                    pb.container = $('.photo-browser-swiper-container').parents('.view');
                }
                else {
                    pb.container = $('.photo-browser');
                }
                if (pb.params.type === 'standalone') {
                    pb.container.addClass('photo-browser-in');
                    app.sizeNavbars(pb.container);
                }
                pb.swiperContainer = pb.container.find('.photo-browser-swiper-container');
                pb.swiperWrapper = pb.container.find('.photo-browser-swiper-wrapper');
                pb.slides = pb.container.find('.photo-browser-slide');
                pb.captionsContainer = pb.container.find('.photo-browser-captions');
                pb.captions = pb.container.find('.photo-browser-caption');
                
                var sliderSettings = {
                    nextButton: pb.params.nextButton || '.photo-browser-next',
                    prevButton: pb.params.prevButton || '.photo-browser-prev',
                    indexButton: pb.params.indexButton,
                    initialSlide: index,
                    spaceBetween: pb.params.spaceBetween,
                    speed: pb.params.speed,
                    loop: pb.params.loop,
                    lazyLoading: pb.params.lazyLoading,
                    lazyLoadingInPrevNext: pb.params.lazyLoadingInPrevNext,
                    lazyLoadingOnTransitionStart: pb.params.lazyLoadingOnTransitionStart,
                    preloadImages: pb.params.lazyLoading ? false : true,
                    onTap: function (swiper, e) {
                        if (pb.params.onTap) pb.params.onTap(swiper, e);
                    },
                    onClick: function (swiper, e) {
                        if (pb.params.exposition) pb.toggleExposition();
                        if (pb.params.onClick) pb.params.onClick(swiper, e);
                    },
                    onDoubleTap: function (swiper, e) {
                        pb.toggleZoom(e);
                        if (pb.params.onDoubleTap) pb.params.onDoubleTap(swiper, e);
                    },
                    onTransitionStart: function (swiper) {
                        pb.onSliderTransitionStart(swiper);
                    },
                    onTransitionEnd: function (swiper) {
                        pb.onSliderTransitionEnd(swiper);  
                    },
                    onSlideChangeStart: pb.params.onSlideChangeStart,
                    onSlideChangeEnd: pb.params.onSlideChangeEnd,
                    onLazyImageLoad: function (swiper, slide, img) {
                        if (pb.params.onLazyImageLoad) pb.params.onLazyImageLoad(pb, slide, img);
                    },
                    onLazyImageReady: function (swiper, slide, img) {
                        $(slide).removeClass('photo-browser-slide-lazy');
                        if (pb.params.onLazyImageReady) pb.params.onLazyImageReady(pb, slide, img);
                    }
                };
        
                if (pb.params.swipeToClose && pb.params.type !== 'page') {
                    sliderSettings.onTouchStart = pb.swipeCloseTouchStart;
                    sliderSettings.onTouchMoveOpposite = pb.swipeCloseTouchMove;
                    sliderSettings.onTouchEnd = pb.swipeCloseTouchEnd;
                }
        
                pb.swiper = app.swiper(pb.swiperContainer, sliderSettings);
                if (index === 0) {
                    pb.onSliderTransitionStart(pb.swiper);
                }
                pb.attachEvents();
            };
            pb.attachEvents = function (detach) {
                var action = detach ? 'off' : 'on';
                // Slide between photos
        
                if (pb.params.zoom) {
                    var target = pb.params.loop ? pb.swiper.slides : pb.slides;
                    // Scale image
                    target[action]('gesturestart', pb.onSlideGestureStart);
                    target[action]('gesturechange', pb.onSlideGestureChange);
                    target[action]('gestureend', pb.onSlideGestureEnd);
        
                    // Move image
                    target[action](app.touchEvents.start, pb.onSlideTouchStart);
                    target[action](app.touchEvents.move, pb.onSlideTouchMove);
                    target[action](app.touchEvents.end, pb.onSlideTouchEnd);
                }
                pb.container.find('.photo-browser-close-link')[action]('click', pb.close);
            };
        
            var isTouched, isMoved, touchesStart = {}, touchesCurrent = {}, touchStartTime, isScrolling, animating = false, currentTranslate;
            var allowClick = true;
        
            // Expose
            pb.exposed = false;
            pb.toggleExposition = function () {
                if (pb.container) pb.container.toggleClass('photo-browser-exposed');
                if (pb.params.expositionHideCaptions) pb.captionsContainer.toggleClass('photo-browser-captions-exposed');
                pb.exposed = !pb.exposed;
            };
            pb.enableExposition = function () {
                if (pb.container) pb.container.addClass('photo-browser-exposed');
                if (pb.params.expositionHideCaptions) pb.captionsContainer.addClass('photo-browser-captions-exposed');
                pb.exposed = true;
            };
            pb.disableExposition = function () {
                if (pb.container) pb.container.removeClass('photo-browser-exposed');
                if (pb.params.expositionHideCaptions) pb.captionsContainer.removeClass('photo-browser-captions-exposed');
                pb.exposed = false;
            };
            
            // Gestures
            var gestureSlide, gestureImg, gestureImgWrap, scale = 1, currentScale = 1, isScaling = false;
            pb.onSlideGestureStart = function (e) {
                if (!gestureSlide || !gestureSlide.length) {
                    gestureSlide = $(this);
                    if (gestureSlide.length === 0) gestureSlide = pb.swiper.slides.eq(pb.swiper.activeIndex);
                    gestureImg = gestureSlide.find('img, svg, canvas');
                    gestureImgWrap = gestureImg.parent('.photo-browser-zoom-container');
                    if (gestureImgWrap.length === 0) {
                        gestureImg = undefined;
                        return;
                    }
                }
                gestureImg.transition(0);
                isScaling = true;
            };
            pb.onSlideGestureChange = function (e) {
                if (!gestureImg || gestureImg.length === 0) return;
                scale = e.scale * currentScale;
                if (scale > pb.params.maxZoom) {
                    scale = pb.params.maxZoom - 1 + Math.pow((scale - pb.params.maxZoom + 1), 0.5);
                }
                if (scale < pb.params.minZoom) {
                    scale =  pb.params.minZoom + 1 - Math.pow((pb.params.minZoom - scale + 1), 0.5);
                }
                gestureImg.transform('translate3d(0,0,0) scale(' + scale + ')');
            };
            pb.onSlideGestureEnd = function (e) {
                if (!gestureImg || gestureImg.length === 0) return;
                scale = Math.max(Math.min(scale, pb.params.maxZoom), pb.params.minZoom);
                gestureImg.transition(pb.params.speed).transform('translate3d(0,0,0) scale(' + scale + ')');
                currentScale = scale;
                isScaling = false;
                if (scale === 1) gestureSlide = undefined;
            };
            pb.toggleZoom = function (e) {
                if (!gestureSlide) {
                    gestureSlide = pb.swiper.slides.eq(pb.swiper.activeIndex);
                    gestureImg = gestureSlide.find('img, svg, canvas');
                    gestureImgWrap = gestureImg.parent('.photo-browser-zoom-container');
                }
                if (!gestureImg || gestureImg.length === 0) return;
                
                var touchX, touchY, offsetX, offsetY, diffX, diffY, translateX, translateY, imageWidth, imageHeight, scaledWidth, scaledHeight, translateMinX, translateMinY, translateMaxX, translateMaxY;
        
                if (typeof imageTouchesStart.x === 'undefined' && e) {
                    touchX = e.type === 'touchend' ? e.changedTouches[0].pageX : e.pageX;
                    touchY = e.type === 'touchend' ? e.changedTouches[0].pageY : e.pageY;
                }
                else {
                    touchX = imageTouchesStart.x;
                    touchY = imageTouchesStart.y;
                }
                
                if (scale && scale !== 1) {
                    // Zoom Out
                    scale = currentScale = 1;
                    gestureImgWrap.transition(300).transform('translate3d(0,0,0)');
                    gestureImg.transition(300).transform('translate3d(0,0,0) scale(1)');
                    gestureSlide = undefined;
                }
                else {
                    // Zoom In
                    scale = currentScale = pb.params.maxZoom;
                    if (e) {
                        offsetX = pb.container.offset().left;
                        offsetY = pb.container.offset().top;
                        diffX = offsetX + pb.container[0].offsetWidth/2 - touchX;
                        diffY = offsetY + pb.container[0].offsetHeight/2 - touchY;
        
                        imageWidth = gestureImg[0].offsetWidth;
                        imageHeight = gestureImg[0].offsetHeight;
                        scaledWidth = imageWidth * scale;
                        scaledHeight = imageHeight * scale;
        
                        translateMinX = Math.min((pb.swiper.width / 2 - scaledWidth / 2), 0);
                        translateMinY = Math.min((pb.swiper.height / 2 - scaledHeight / 2), 0);
                        translateMaxX = -translateMinX;
                        translateMaxY = -translateMinY;
        
                        translateX = diffX * scale;
                        translateY = diffY * scale;
                        
                        if (translateX < translateMinX) {
                            translateX =  translateMinX;
                        }
                        if (translateX > translateMaxX) {
                            translateX = translateMaxX;
                        }
                        
                        if (translateY < translateMinY) {
                            translateY =  translateMinY;
                        }
                        if (translateY > translateMaxY) {
                            translateY = translateMaxY;
                        }
                    }
                    else {
                        translateX = 0;
                        translateY = 0;
                    }
                    gestureImgWrap.transition(300).transform('translate3d(' + translateX + 'px, ' + translateY + 'px,0)');
                    gestureImg.transition(300).transform('translate3d(0,0,0) scale(' + scale + ')');
                }
            };
        
            var imageIsTouched, imageIsMoved, imageCurrentX, imageCurrentY, imageMinX, imageMinY, imageMaxX, imageMaxY, imageWidth, imageHeight, imageTouchesStart = {}, imageTouchesCurrent = {}, imageStartX, imageStartY, velocityPrevPositionX, velocityPrevTime, velocityX, velocityPrevPositionY, velocityY;
        
            pb.onSlideTouchStart = function (e) {
                if (!gestureImg || gestureImg.length === 0) return;
                if (imageIsTouched) return;
                if (app.device.os === 'android') e.preventDefault();
                imageIsTouched = true;
                imageTouchesStart.x = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
                imageTouchesStart.y = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
            };
            pb.onSlideTouchMove = function (e) {
                if (!gestureImg || gestureImg.length === 0) return;
                pb.swiper.allowClick = false;
                if (!imageIsTouched || !gestureSlide) return;
        
                if (!imageIsMoved) {
                    imageWidth = gestureImg[0].offsetWidth;
                    imageHeight = gestureImg[0].offsetHeight;
                    imageStartX = $.getTranslate(gestureImgWrap[0], 'x') || 0;
                    imageStartY = $.getTranslate(gestureImgWrap[0], 'y') || 0;
                    gestureImgWrap.transition(0);
                }
                // Define if we need image drag
                var scaledWidth = imageWidth * scale;
                var scaledHeight = imageHeight * scale;
        
                if (scaledWidth < pb.swiper.width && scaledHeight < pb.swiper.height) return;
        
                imageMinX = Math.min((pb.swiper.width / 2 - scaledWidth / 2), 0);
                imageMaxX = -imageMinX;
                imageMinY = Math.min((pb.swiper.height / 2 - scaledHeight / 2), 0);
                imageMaxY = -imageMinY;
                
                imageTouchesCurrent.x = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                imageTouchesCurrent.y = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
        
                if (!imageIsMoved && !isScaling) {
                    if (
                        (Math.floor(imageMinX) === Math.floor(imageStartX) && imageTouchesCurrent.x < imageTouchesStart.x) ||
                        (Math.floor(imageMaxX) === Math.floor(imageStartX) && imageTouchesCurrent.x > imageTouchesStart.x)
                        ) {
                        imageIsTouched = false;
                        return;
                    }
                }
                e.preventDefault();
                e.stopPropagation();
                imageIsMoved = true;
                imageCurrentX = imageTouchesCurrent.x - imageTouchesStart.x + imageStartX;
                imageCurrentY = imageTouchesCurrent.y - imageTouchesStart.y + imageStartY;
                
                if (imageCurrentX < imageMinX) {
                    imageCurrentX =  imageMinX + 1 - Math.pow((imageMinX - imageCurrentX + 1), 0.8);
                }
                if (imageCurrentX > imageMaxX) {
                    imageCurrentX = imageMaxX - 1 + Math.pow((imageCurrentX - imageMaxX + 1), 0.8);
                }
                
                if (imageCurrentY < imageMinY) {
                    imageCurrentY =  imageMinY + 1 - Math.pow((imageMinY - imageCurrentY + 1), 0.8);
                }
                if (imageCurrentY > imageMaxY) {
                    imageCurrentY = imageMaxY - 1 + Math.pow((imageCurrentY - imageMaxY + 1), 0.8);
                }
        
                //Velocity
                if (!velocityPrevPositionX) velocityPrevPositionX = imageTouchesCurrent.x;
                if (!velocityPrevPositionY) velocityPrevPositionY = imageTouchesCurrent.y;
                if (!velocityPrevTime) velocityPrevTime = Date.now();
                velocityX = (imageTouchesCurrent.x - velocityPrevPositionX) / (Date.now() - velocityPrevTime) / 2;
                velocityY = (imageTouchesCurrent.y - velocityPrevPositionY) / (Date.now() - velocityPrevTime) / 2;
                if (Math.abs(imageTouchesCurrent.x - velocityPrevPositionX) < 2) velocityX = 0;
                if (Math.abs(imageTouchesCurrent.y - velocityPrevPositionY) < 2) velocityY = 0;
                velocityPrevPositionX = imageTouchesCurrent.x;
                velocityPrevPositionY = imageTouchesCurrent.y;
                velocityPrevTime = Date.now();
        
                gestureImgWrap.transform('translate3d(' + imageCurrentX + 'px, ' + imageCurrentY + 'px,0)');
            };
            pb.onSlideTouchEnd = function (e) {
                if (!gestureImg || gestureImg.length === 0) return;
                if (!imageIsTouched || !imageIsMoved) {
                    imageIsTouched = false;
                    imageIsMoved = false;
                    return;
                }
                imageIsTouched = false;
                imageIsMoved = false;
                var momentumDurationX = 300;
                var momentumDurationY = 300;
                var momentumDistanceX = velocityX * momentumDurationX;
                var newPositionX = imageCurrentX + momentumDistanceX;
                var momentumDistanceY = velocityY * momentumDurationY;
                var newPositionY = imageCurrentY + momentumDistanceY;
        
                //Fix duration
                if (velocityX !== 0) momentumDurationX = Math.abs((newPositionX - imageCurrentX) / velocityX);
                if (velocityY !== 0) momentumDurationY = Math.abs((newPositionY - imageCurrentY) / velocityY);
                var momentumDuration = Math.max(momentumDurationX, momentumDurationY);
        
                imageCurrentX = newPositionX;
                imageCurrentY = newPositionY;
        
                // Define if we need image drag
                var scaledWidth = imageWidth * scale;
                var scaledHeight = imageHeight * scale;
                imageMinX = Math.min((pb.swiper.width / 2 - scaledWidth / 2), 0);
                imageMaxX = -imageMinX;
                imageMinY = Math.min((pb.swiper.height / 2 - scaledHeight / 2), 0);
                imageMaxY = -imageMinY;
                imageCurrentX = Math.max(Math.min(imageCurrentX, imageMaxX), imageMinX);
                imageCurrentY = Math.max(Math.min(imageCurrentY, imageMaxY), imageMinY);
        
                gestureImgWrap.transition(momentumDuration).transform('translate3d(' + imageCurrentX + 'px, ' + imageCurrentY + 'px,0)');
            };
        
            // Swipe Up To Close
            var swipeToCloseIsTouched = false;
            var allowSwipeToClose = true;
            var swipeToCloseDiff, swipeToCloseStart, swipeToCloseCurrent, swipeToCloseStarted = false, swipeToCloseActiveSlide, swipeToCloseTimeStart;
            pb.swipeCloseTouchStart = function (swiper, e) {
                if (!allowSwipeToClose) return;
                swipeToCloseIsTouched = true;
            };
            pb.swipeCloseTouchMove = function (swiper, e) {
                if (!swipeToCloseIsTouched) return;
                if (!swipeToCloseStarted) {
                    swipeToCloseStarted = true;
                    swipeToCloseStart = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                    swipeToCloseActiveSlide = pb.swiper.slides.eq(pb.swiper.activeIndex);
                    swipeToCloseTimeStart = (new Date()).getTime();
                }
                e.preventDefault();
                swipeToCloseCurrent = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                swipeToCloseDiff = swipeToCloseStart - swipeToCloseCurrent;
                var opacity = 1 - Math.abs(swipeToCloseDiff) / 300;
                swipeToCloseActiveSlide.transform('translate3d(0,' + (-swipeToCloseDiff) + 'px,0)');
                pb.swiper.container.css('opacity', opacity).transition(0);
            };
            pb.swipeCloseTouchEnd = function (swiper, e) {
                swipeToCloseIsTouched = false;
                if (!swipeToCloseStarted) {
                    swipeToCloseStarted = false;
                    return;
                }
                swipeToCloseStarted = false;
                allowSwipeToClose = false;
                var diff = Math.abs(swipeToCloseDiff);
                var timeDiff = (new Date()).getTime() - swipeToCloseTimeStart;
                if ((timeDiff < 300 && diff > 20) || (timeDiff >= 300 && diff > 100)) {
                    setTimeout(function () {
                        if (pb.params.type === 'standalone') {
                            pb.close();
                        }
                        if (pb.params.type === 'popup') {
                            app.closeModal(pb.popup);
                        }
                        if (pb.params.onSwipeToClose) {
                            pb.params.onSwipeToClose(pb);
                        }
                        allowSwipeToClose = true;
                    }, 0);
                    return;
                }
                if (diff !== 0) {
                    swipeToCloseActiveSlide.addClass('transitioning').transitionEnd(function () {
                        allowSwipeToClose = true;
                        swipeToCloseActiveSlide.removeClass('transitioning');
                    });
                }
                else {
                    allowSwipeToClose = true;
                }
                pb.swiper.container.css('opacity', '').transition('');
                swipeToCloseActiveSlide.transform('');
            };
        
            return pb;
        };
        
        app.photoBrowser = function (params) {
            return new PhotoBrowser(params);
        };
        

        /*===============================================================================
        ************   Autocomplete   ************
        ===============================================================================*/
        var Autocomplete = function (params) {
            var a = this;
        
            // Params
            var defaults = {
                // Standalone Options
                /*
                opener: undefined,
                */
                popupCloseText: 'Close',
                backText: 'Back',
                searchbarPlaceholderText: 'Search...',
                searchbarCancelText: 'Cancel',
                openIn: 'page',
                backOnSelect: false,
                notFoundText: 'Nothing found',
                /*
                pageTitle: undefined,
                */
        
                // Handle Data
                /*
                source: undefined,
                limit: undefined,
                */
                valueProperty: 'id',
                textProperty: 'text',
        
                // Dropdown Options
                /*
                dropdownPlaceholderText: 'Type anything...',
                */
                updateInputValueOnSelect: true,
                expandInput: false,
        
                // Preloader
                preloaderColor: false,
                preloader: false,
        
                // Templates
                /*
                itemTemplate: undefined,
                navbarTemplate: undefined,
                dropdownTemplate: undefined
                dropdownItemTemplate: undefined,
                dropdownPlaceholderTemplate: undefined
                */
        
                // Color themes
                /*
                navbarTheme: undefined,
                formTheme: undefined,
                */
        
                // Callbacks
                /*
                onChange: function (a, value) - for not dropdown
                onOpen: function (a)
                onClose: function (a)
                */
            };
        
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined') {
                    params[def] = defaults[def];
                }
            }
            a.params = params;
        
            // Opener Link & View
            if (a.params.opener) {
                a.opener = $(a.params.opener);
            }
            var view = a.params.view;
            if (!a.params.view && a.opener && a.opener.length) {
                // Find related view
                view = a.opener.parents('.' + app.params.viewClass);
                if (view.length === 0) return;
                view = view[0].f7View;
            }
        
            // Input
            if (a.params.input) {
                a.input = $(a.params.input);
                if (a.input.length === 0 && a.params.openIn === 'dropdown') return;
            }
        
            // Array with selected items
            a.value = a.params.value || [];
        
            // ID & Inputs
            a.id = (new Date()).getTime();
            a.inputType = a.params.multiple ? 'checkbox' : 'radio';
            a.inputName = a.inputType + '-' + a.id;
        
            // Is Material
            var material = app.params.material;
        
            // Back On Select
            var backOnSelect = a.params.backOnSelect;
        
            if (a.params.openIn !== 'dropdown') {
                // Item Template
                a.itemTemplate = t7.compile(a.params.itemTemplate ||
                    '<li>' +
                        '<label class="label-{{inputType}} item-content">' +
                            '<input type="{{inputType}}" name="{{inputName}}" value="{{value}}" {{#if selected}}checked{{/if}}>' +
                            '{{#if material}}' +
                                '<div class="item-media">' +
                                    '<i class="icon icon-form-{{inputType}}"></i>' +
                                '</div>' +
                                '<div class="item-inner">' +
                                    '<div class="item-title">{{text}}</div>' +
                                '</div>' +
                            '{{else}}' +
                                '{{#if checkbox}}' +
                                '<div class="item-media">' +
                                    '<i class="icon icon-form-checkbox"></i>' +
                                '</div>' +
                                '{{/if}}' +
                                '<div class="item-inner">' +
                                    '<div class="item-title">{{text}}</div>' +
                                '</div>' +
                            '{{/if}}' +
                        '</label>' +
                    '</li>'
                );
                // Page Layout
                var pageTitle = a.params.pageTitle || '';
                if (!pageTitle && a.opener && a.opener.length) {
                    pageTitle = a.opener.find('.item-title').text();
                }
                var pageName = 'autocomplete-' + a.inputName;
        
                var navbarTheme = a.params.navbarTheme,
                    formTheme = a.params.formTheme;
        
                // Navbar HTML
                var navbarHTML;
                var noNavbar = '', noToolbar = '', navbarLayout;
        
                a.navbarTemplate = t7.compile(a.params.navbarTemplate ||
                    '<div class="navbar {{#if navbarTheme}}theme-{{navbarTheme}}{{/if}}">' +
                        '<div class="navbar-inner">' +
                            '<div class="left sliding">' +
                                '{{#if material}}' +
                                '<a href="#" class="link {{#if inPopup}}close-popup{{else}}back{{/if}} icon-only"><i class="icon icon-back"></i></a>' +
                                '{{else}}' +
                                '<a href="#" class="link {{#if inPopup}}close-popup{{else}}back{{/if}}">' +
                                    '<i class="icon icon-back"></i>' +
                                    '{{#if inPopup}}' +
                                    '<span>{{popupCloseText}}</span>' +
                                    '{{else}}' +
                                    '<span>{{backText}}</span>' +
                                    '{{/if}}' +
                                '</a>' +
                                '{{/if}}' +
                            '</div>' +
                            '<div class="center sliding">{{pageTitle}}</div>' +
                            '{{#if preloader}}' +
                            '<div class="right">' +
                                '<div class="autocomplete-preloader preloader {{#if preloaderColor}}preloader-{{preloaderColor}}{{/if}}"></div>' +
                            '</div>' +
                            '{{/if}}' +
                        '</div>' +
                    '</div>'
                );
                navbarHTML = a.navbarTemplate({
                    pageTitle: pageTitle,
                    backText: a.params.backText,
                    popupCloseText: a.params.popupCloseText,
                    openIn: a.params.openIn,
                    navbarTheme: navbarTheme,
                    inPopup: a.params.openIn === 'popup',
                    inPage: a.params.openIn === 'page',
                    material: material,
                    preloader: a.params.preloader,
                    preloaderColor: a.params.preloaderColor,
                });
        
                // Determine navbar layout type - static/fixed/through
                if (a.params.openIn === 'page') {
                    navbarLayout = 'static';
                    if (a.opener) {
                        if (a.opener.parents('.navbar-through').length > 0) navbarLayout = 'through';
                        if (a.opener.parents('.navbar-fixed').length > 0) navbarLayout = 'fixed';
                        noToolbar = a.opener.parents('.page').hasClass('no-toolbar') ? 'no-toolbar' : '';
                        noNavbar  = a.opener.parents('.page').hasClass('no-navbar')  ? 'no-navbar'  : 'navbar-' + navbarLayout;
                    }
                    else if (view.container) {
                        if ($(view.container).hasClass('navbar-through') || $(view.container).find('.navbar-through').length > 0) navbarLayout = 'through';
                        if ($(view.container).hasClass('navbar-fixed') || $(view.container).find('.navbar-fixed').length > 0) navbarLayout = 'fixed';
                        noToolbar = $(view.activePage.container).hasClass('no-toolbar') ? 'no-toolbar' : '';
                        noNavbar  = $(view.activePage.container).hasClass('no-navbar')  ? 'no-navbar'  : 'navbar-' + navbarLayout;
                    }
                }
                else {
                    navbarLayout = 'fixed';
                }
                var searchbarHTML =
                    '<form class="searchbar">' +
                        '<div class="searchbar-input">' +
                            '<input type="search" placeholder="' + a.params.searchbarPlaceholderText + '">' +
                            '<a href="#" class="searchbar-clear"></a>' +
                        '</div>' +
                        (material ? '' : '<a href="#" class="searchbar-cancel">' + a.params.searchbarCancelText + '</a>') +
                    '</form>' +
                    '<div class="searchbar-overlay"></div>';
                var pageHTML =
                    (navbarLayout === 'through' ? navbarHTML : '') +
                    '<div class="pages">' +
                        '<div data-page="' + pageName + '" class="page autocomplete-page ' + noNavbar + ' ' + noToolbar + '">' +
                            (navbarLayout === 'fixed' ? navbarHTML : '') +
                            searchbarHTML +
                            '<div class="page-content">' +
                                (navbarLayout === 'static' ? navbarHTML : '') +
                                '<div class="list-block autocomplete-found autocomplete-list-' + a.id + ' ' + (formTheme ? 'theme-' + formTheme : '') + '">' +
                                    '<ul></ul>' +
                                '</div>' +
                                '<div class="list-block autocomplete-not-found">' +
                                    '<ul><li class="item-content"><div class="item-inner"><div class="item-title">' + a.params.notFoundText + '</div></div></li></ul>' +
                                '</div>' +
                                '<div class="list-block autocomplete-values">' +
                                    '<ul></ul>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
            }
            else {
                a.dropdownItemTemplate = t7.compile(a.params.dropdownItemTemplate ||
                    '<li>' +
                        '<label class="{{#unless placeholder}}label-radio{{/unless}} item-content" data-value="{{value}}">' +
                            '<div class="item-inner">' +
                                '<div class="item-title">{{text}}</div>' +
                            '</div>' +
                        '</label>' +
                    '</li>'
                );
                a.dropdownPlaceholderTemplate = t7.compile(a.params.dropdownPlaceholderTemplate ||
                    '<li class="autocomplete-dropdown-placeholder">' +
                        '<div class="item-content">' +
                            '<div class="item-inner">' +
                                '<div class="item-title">{{text}}</div>' +
                            '</div>' +
                        '</label>' +
                    '</li>'
                );
                a.dropdownTemplate = t7.compile(a.params.dropdownTemplate ||
                    '<div class="autocomplete-dropdown">' +
                        '<div class="autocomplete-dropdown-inner">' +
                            '<div class="list-block">' +
                                '<ul></ul>' +
                            '</div>' +
                        '</div>' +
                        '{{#if preloader}}' +
                        '<div class="autocomplete-preloader preloader {{#if preloaderColor}}preloader-{{preloaderColor}}{{/if}}">{{#if material}}{{materialPreloaderHtml}}{{/if}}</div>' +
                        '{{/if}}' +
                    '</div>'
                );
            }
        
            // Define popup
            a.popup = undefined;
        
            // Define Dropdown
            a.dropdown = undefined;
        
            // Handle Input Value Change
            function handleInputValue (e) {
                var query = a.input.val();
                if (a.params.source) {
                    a.params.source(a, query, function (items) {
                        var itemsHTML = '';
                        var limit = a.params.limit ? Math.min(a.params.limit, items.length) : items.length;
                        a.items = items;
                        var i, j;
                        var regExp = new RegExp('('+query+')', 'i');
                        for (i = 0; i < limit; i++) {
                            var itemValue = typeof items[i] === 'object' ? items[i][a.params.valueProperty] : items[i];
                            itemsHTML += a.dropdownItemTemplate({
                                value: itemValue,
                                text: (typeof items[i] !== 'object' ? items[i] : items[i][a.params.textProperty]).replace(regExp, '<b>$1</b>')
                            });
                        }
                        if (itemsHTML === '' && query === '' && a.params.dropdownPlaceholderText) {
                            itemsHTML += a.dropdownPlaceholderTemplate({
                                text: a.params.dropdownPlaceholderText,
                            });
                        }
                        a.dropdown.find('ul').html(itemsHTML);
                    });
                }
            }
            // Handle Drop Down Click
            function handleDropdownClick (e) {
                /*jshint validthis:true */
                var clicked = $(this);
                var clickedItem;
                for (var i = 0; i < a.items.length; i++) {
                    var itemValue = typeof a.items[i] === 'object' ? a.items[i][a.params.valueProperty] : a.items[i];
                    var value = clicked.attr('data-value');
                    if (itemValue === value || itemValue * 1 === value * 1) {
                        clickedItem = a.items[i];
                    }
                }
                if (a.params.updateInputValueOnSelect) {
                    a.input.val(typeof clickedItem === 'object' ? clickedItem[a.params.textProperty] : clickedItem);
                    a.input.trigger('input change');
                }
        
                if (a.params.onChange) {
                    a.params.onChange(a, clickedItem);
                }
        
                a.close();
            }
        
            // Handle HTML Click to close Dropdown
            function closeOnHTMLClick (e) {
                var target = $(e.target);
                if (!(target.is(a.input[0]) || a.dropdown && target.parents(a.dropdown[0]).length > 0)) {
                    a.close();
                }
            }
        
            a.positionDropDown = function () {
                var listBlock = a.input.parents('.list-block'),
                    pageContent = a.input.parents('.page-content'),
                    paddingTop = parseInt(pageContent.css('padding-top'), 10),
                    paddingBottom = parseInt(pageContent.css('padding-top'), 10),
                    inputOffset = a.input.offset(),
                    listBlockOffset = listBlock.length > 0 ? listBlock.offset() : 0,
                    maxHeight = pageContent[0].scrollHeight - paddingBottom - (inputOffset.top + pageContent[0].scrollTop) - a.input[0].offsetHeight;
        
                a.dropdown.css({
                    left: (listBlock.length > 0 ? listBlockOffset.left : inputOffset.left) + 'px',
                    top: inputOffset.top + pageContent[0].scrollTop + a.input[0].offsetHeight + 'px',
                    width: (listBlock.length > 0 ? listBlock[0].offsetWidth : a.input[0].offsetWidth) + 'px'
                });
                a.dropdown.children('.autocomplete-dropdown-inner').css({
                    maxHeight: maxHeight + 'px',
                    paddingLeft: listBlock.length > 0 && !a.params.expandInput ? inputOffset.left - (material ? 16 : 15) + 'px' : ''
                });
            };
        
            // Event Listeners on new page
            a.pageInit = function (e) {
                var page = e.detail.page;
                a.page = $(page.container);
                a.pageData = page;
                if (page.name !== pageName) {
                    return;
                }
                var container = $(page.container);
                // Init Search Bar
                var searchbar = app.searchbar(container.find('.searchbar'), {
                    customSearch: true,
                    onSearch: function (searchbar, data) {
                        if (data.query.length === 0 && searchbar.active) {
                            searchbar.overlay.addClass('searchbar-overlay-active');
                        }
                        else {
                            searchbar.overlay.removeClass('searchbar-overlay-active');
                        }
        
                        var i, j, k;
        
                        if (a.params.source) {
                            a.params.source(a, data.query, function(items) {
                                var itemsHTML = '';
                                var limit = a.params.limit ? Math.min(a.params.limit, items.length) : items.length;
                                a.items = items;
                                for (i = 0; i < limit; i++) {
                                    var selected = false;
                                    var itemValue = typeof items[i] === 'object' ? items[i][a.params.valueProperty] : items[i];
                                    for (j = 0; j < a.value.length; j++) {
                                        var aValue = typeof a.value[j] === 'object' ? a.value[j][a.params.valueProperty] : a.value[j];
                                        if (aValue === itemValue || aValue * 1 === itemValue * 1) selected = true;
                                    }
                                    itemsHTML += a.itemTemplate({
                                        value: itemValue,
                                        text: typeof items[i] !== 'object' ? items[i] : items[i][a.params.textProperty],
                                        inputType: a.inputType,
                                        id: a.id,
                                        inputName: a.inputName,
                                        selected: selected,
                                        checkbox: a.inputType === 'checkbox',
                                        material: material
                                    });
                                }
                                container.find('.autocomplete-found ul').html(itemsHTML);
                                if (items.length === 0) {
                                    if (data.query.length !== 0) {
                                        container.find('.autocomplete-not-found').show();
                                        container.find('.autocomplete-found, .autocomplete-values').hide();
                                    }
                                    else {
                                        container.find('.autocomplete-values').show();
                                        container.find('.autocomplete-found, .autocomplete-not-found').hide();
                                    }
                                }
                                else {
                                    container.find('.autocomplete-found').show();
                                    container.find('.autocomplete-not-found, .autocomplete-values').hide();
                                }
                            });
                        }
                    }
                });
        
                // Save searchbar instance
                a.searchbar = searchbar;
        
                // Update values
                function updateValues() {
                    var valuesHTML = '';
                    var i;
                    for (i = 0; i < a.value.length; i++) {
        
                        valuesHTML += a.itemTemplate({
                            value: typeof a.value[i] === 'object' ? a.value[i][a.params.valueProperty] : a.value[i],
                            text: typeof a.value[i] === 'object' ? a.value[i][a.params.textProperty]: a.value[i],
                            inputType: a.inputType,
                            id: a.id,
                            inputName: a.inputName + '-checked',
                            checkbox: a.inputType === 'checkbox',
                            material: material,
                            selected: true
                        });
                    }
                    container.find('.autocomplete-values ul').html(valuesHTML);
                }
        
                // Handle Inputs
                container.on('change', 'input[type="radio"], input[type="checkbox"]', function () {
                    var i;
                    var input = this;
                    var value = input.value;
                    var text = $(input).parents('li').find('.item-title').text();
                    var isValues = $(input).parents('.autocomplete-values').length > 0;
                    var item, itemValue, aValue;
                    if (isValues) {
                        if (a.inputType === 'checkbox' && !input.checked) {
                            for (i = 0; i < a.value.length; i++) {
                                aValue = typeof a.value[i] === 'string' ? a.value[i] : a.value[i][a.params.valueProperty];
                                if (aValue === value || aValue * 1 === value * 1) {
                                    a.value.splice(i, 1);
                                }
                            }
                            updateValues();
                            if (a.params.onChange) a.params.onChange(a, a.value);
                        }
                        return;
                    }
        
                    // Find Related Item
                    for (i = 0; i < a.items.length; i++) {
                        itemValue = typeof a.items[i] === 'string' ? a.items[i] : a.items[i][a.params.valueProperty];
                        if (itemValue === value || itemValue * 1 === value * 1) item = a.items[i];
                    }
                    // Update Selected Value
                    if (a.inputType === 'radio') {
                        a.value = [item];
                    }
                    else {
                        if (input.checked) {
                            a.value.push(item);
                        }
                        else {
                            for (i = 0; i < a.value.length; i++) {
                                aValue = typeof a.value[i] === 'string' ? a.value[i] : a.value[i][a.params.valueProperty];
                                if (aValue === value || aValue * 1 === value * 1) {
                                    a.value.splice(i, 1);
                                }
                            }
                        }
                    }
        
                    // Update Values Block
                    updateValues();
        
                    // On Select Callback
                    if ((a.inputType === 'radio' && input.checked || a.inputType === 'checkbox') && a.params.onChange ) {
                        a.params.onChange(a, a.value);
                    }
                    if (backOnSelect && a.inputType === 'radio') {
                        if (a.params.openIn === 'popup') app.closeModal(a.popup);
                        else view.router.back();
                    }
                });
        
                // Update Values On Page Init
                updateValues();
        
                if (a.params.onOpen) a.params.onOpen(a);
            };
        
            // Show Hide Preloader
            a.showPreloader = function () {
                if (a.params.openIn === 'dropdown') {
                    if (a.dropdown) a.dropdown.find('.autocomplete-preloader').addClass('autocomplete-preloader-visible');
                }
                else $('.autocomplete-preloader').addClass('autocomplete-preloader-visible');
            };
        
            a.hidePreloader = function () {
                if (a.params.openIn === 'dropdown') {
                    if (a.dropdown) a.dropdown.find('.autocomplete-preloader').removeClass('autocomplete-preloader-visible');
                }
                else $('.autocomplete-preloader').removeClass('autocomplete-preloader-visible');
            };
        
            // Open Autocomplete Page/Popup
            a.open = function () {
                if (a.opened) return;
                a.opened = true;
                if (a.params.openIn === 'dropdown') {
                    if (!a.dropdown) {
                        a.dropdown = $(a.dropdownTemplate({
                            preloader: a.params.preloader,
                            preloaderColor: a.params.preloaderColor,
                            material: material,
                            materialPreloaderHtml: app.params.materialPreloaderHtml
                        }));
                        a.dropdown.on('click', 'label', handleDropdownClick);
        
                    }
                    var listBlock = a.input.parents('.list-block');
                    if (listBlock.length && a.input.parents('.item-content').length > 0 && a.params.expandInput) {
                        a.input.parents('.item-content').addClass('item-content-dropdown-expand');
                    }
                    a.positionDropDown();
                    a.input.parents('.page-content').append(a.dropdown);
                    a.dropdown.addClass('autocomplete-dropdown-in');
                    a.input.trigger('input');
                    $(window).on('resize', a.positionDropDown);
                    if (a.params.onOpen) a.params.onOpen(a);
                }
                else {
                    $(document).once('pageInit', '.autocomplete-page', a.pageInit);
                    if (a.params.openIn === 'popup') {
                        a.popup = app.popup(
                            '<div class="popup autocomplete-popup autocomplete-popup-' + a.inputName + '">' +
                                '<div class="view navbar-fixed">' +
                                    pageHTML +
                                '</div>' +
                            '</div>'
                            );
                        a.popup = $(a.popup);
                        a.popup.once('closed', function () {
                            a.popup = undefined;
                            a.opened = false;
                            if (a.params.onClose) a.params.onClose(a);
                        });
                    }
                    else {
                        view.router.load({
                            content: pageHTML
                        });
                        $(document).once('pageBack', '.autocomplete-page', function () {
                            a.opened = false;
                            if (a.params.onClose) a.params.onClose(a);
                        });
                    }
                }
            };
            a.close = function (e) {
                if (!a.opened) return;
                if (a.params.openIn === 'dropdown') {
                    if (e && e.type === 'blur' && a.dropdown.find('label.active-state').length > 0) return;
                    a.dropdown.removeClass('autocomplete-dropdown-in').remove();
                    a.input.parents('.item-content-dropdown-expand').removeClass('item-content-dropdown-expand');
                    a.opened = false;
                    $(window).off('resize', a.positionDropDown);
                    if (a.params.onClose) a.params.onClose(a);
                }
                if (a.params.openIn === 'popup') {
                    if (a.popup) app.closeModal(a.popup);
                }
            };
        
            // Init Events
            a.initEvents = function (detach) {
                var method = detach ? 'off' : 'on';
                if (a.params.openIn !== 'dropdown' && a.opener) {
                    a.opener[method]('click', a.open);
                }
                if (a.params.openIn === 'dropdown' && a.input) {
                    a.input[method]('focus', a.open);
                    a.input[method]('input', handleInputValue);
                    if (app.device.android) {
                        $('html')[method]('click', closeOnHTMLClick);
                    }
                    else {
                        a.input[method]('blur', a.close);
                    }
                }
                if (detach && a.dropdown) {
                    a.dropdown = null;
                }
            };
        
            // Init/Destroy Methods
            a.init = function () {
                a.initEvents();
            };
            a.destroy = function () {
                a.initEvents(true);
                a = null;
            };
        
            // Init
            a.init();
        
            return a;
        };
        app.autocomplete = function (params) {
            return new Autocomplete(params);
        };

        /*======================================================
        ************   Picker   ************
        ======================================================*/
        var Picker = function (params) {
            var p = this;
            var defaults = {
                updateValuesOnMomentum: false,
                updateValuesOnTouchmove: true,
                rotateEffect: false,
                momentumRatio: 7,
                freeMode: false,
                // Common settings
                closeByOutsideClick: true,
                scrollToInput: true,
                inputReadOnly: true,
                convertToPopover: true,
                onlyInPopover: false,
                toolbar: true,
                toolbarCloseText: 'Done',
                toolbarTemplate: 
                    '<div class="toolbar">' +
                        '<div class="toolbar-inner">' +
                            '<div class="left"></div>' +
                            '<div class="right">' +
                                '<a href="#" class="link close-picker">{{closeText}}</a>' +
                            '</div>' +
                        '</div>' +
                    '</div>'
            };
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined') {
                    params[def] = defaults[def];
                }
            }
            p.params = params;
            p.cols = [];
            p.initialized = false;
            
            // Inline flag
            p.inline = p.params.container ? true : false;
        
            // 3D Transforms origin bug, only on safari
            var originBug = app.device.ios || (navigator.userAgent.toLowerCase().indexOf('safari') >= 0 && navigator.userAgent.toLowerCase().indexOf('chrome') < 0) && !app.device.android;
        
            // Should be converted to popover
            function isPopover() {
                var toPopover = false;
                if (!p.params.convertToPopover && !p.params.onlyInPopover) return toPopover;
                if (!p.inline && p.params.input) {
                    if (p.params.onlyInPopover) toPopover = true;
                    else {
                        if (app.device.ios) {
                            toPopover = app.device.ipad ? true : false;
                        }
                        else {
                            if ($(window).width() >= 768) toPopover = true;
                        }
                    }
                } 
                return toPopover; 
            }
            function inPopover() {
                if (p.opened && p.container && p.container.length > 0 && p.container.parents('.popover').length > 0) return true;
                else return false;
            }
        
            // Value
            p.setValue = function (arrValues, transition) {
                var valueIndex = 0;
                if (p.cols.length === 0) {
                    p.value = arrValues;
                    p.updateValue(arrValues);
                    return;
                }
                for (var i = 0; i < p.cols.length; i++) {
                    if (p.cols[i] && !p.cols[i].divider) {
                        p.cols[i].setValue(arrValues[valueIndex], transition);
                        valueIndex++;
                    }
                }
            };
            p.updateValue = function (forceValues) {
                var newValue = forceValues || [];
                var newDisplayValue = [];
                for (var i = 0; i < p.cols.length; i++) {
                    if (!p.cols[i].divider) {
                        newValue.push(p.cols[i].value);
                        newDisplayValue.push(p.cols[i].displayValue);
                    }
                }
                if (newValue.indexOf(undefined) >= 0) {
                    return;
                }
                p.value = newValue;
                p.displayValue = newDisplayValue;
                if (p.params.onChange) {
                    p.params.onChange(p, p.value, p.displayValue);
                }
                if (p.input && p.input.length > 0) {
                    $(p.input).val(p.params.formatValue ? p.params.formatValue(p, p.value, p.displayValue) : p.value.join(' '));
                    $(p.input).trigger('change');
                }
            };
        
            // Columns Handlers
            p.initPickerCol = function (colElement, updateItems) {
                var colContainer = $(colElement);
                var colIndex = colContainer.index();
                var col = p.cols[colIndex];
                if (col.divider) return;
                col.container = colContainer;
                col.wrapper = col.container.find('.picker-items-col-wrapper');
                col.items = col.wrapper.find('.picker-item');
                
                var i, j;
                var wrapperHeight, itemHeight, itemsHeight, minTranslate, maxTranslate;
                col.replaceValues = function (values, displayValues) {
                    col.destroyEvents();
                    col.values = values;
                    col.displayValues = displayValues;
                    var newItemsHTML = p.columnHTML(col, true);
                    col.wrapper.html(newItemsHTML);
                    col.items = col.wrapper.find('.picker-item');
                    col.calcSize();
                    col.setValue(col.values[0], 0, true);
                    col.initEvents();
                };
                col.calcSize = function () {
                    if (p.params.rotateEffect) {
                        col.container.removeClass('picker-items-col-absolute');
                        if (!col.width) col.container.css({width:''});
                    }
                    var colWidth, colHeight;
                    colWidth = 0;
                    colHeight = col.container[0].offsetHeight;
                    wrapperHeight = col.wrapper[0].offsetHeight;
                    itemHeight = col.items[0].offsetHeight;
                    itemsHeight = itemHeight * col.items.length;
                    minTranslate = colHeight / 2 - itemsHeight + itemHeight / 2;
                    maxTranslate = colHeight / 2 - itemHeight / 2;    
                    if (col.width) {
                        colWidth = col.width;
                        if (parseInt(colWidth, 10) === colWidth) colWidth = colWidth + 'px';
                        col.container.css({width: colWidth});
                    }
                    if (p.params.rotateEffect) {
                        if (!col.width) {
                            col.items.each(function () {
                                var item = $(this);
                                item.css({width:'auto'});
                                colWidth = Math.max(colWidth, item[0].offsetWidth);
                                item.css({width:''});
                            });
                            col.container.css({width: (colWidth + 2) + 'px'});
                        }
                        col.container.addClass('picker-items-col-absolute');
                    }
                };
                col.calcSize();
                
                col.wrapper.transform('translate3d(0,' + maxTranslate + 'px,0)').transition(0);
        
        
                var activeIndex = 0;
                var animationFrameId;
        
                // Set Value Function
                col.setValue = function (newValue, transition, valueCallbacks) {
                    if (typeof transition === 'undefined') transition = '';
                    var newActiveIndex = col.wrapper.find('.picker-item[data-picker-value="' + newValue + '"]').index();
                    if(typeof newActiveIndex === 'undefined' || newActiveIndex === -1) {
                        return;
                    }
                    var newTranslate = -newActiveIndex * itemHeight + maxTranslate;
                    // Update wrapper
                    col.wrapper.transition(transition);
                    col.wrapper.transform('translate3d(0,' + (newTranslate) + 'px,0)');
                        
                    // Watch items
                    if (p.params.updateValuesOnMomentum && col.activeIndex && col.activeIndex !== newActiveIndex ) {
                        $.cancelAnimationFrame(animationFrameId);
                        col.wrapper.transitionEnd(function(){
                            $.cancelAnimationFrame(animationFrameId);
                        });
                        updateDuringScroll();
                    }
        
                    // Update items
                    col.updateItems(newActiveIndex, newTranslate, transition, valueCallbacks);
                };
        
                col.updateItems = function (activeIndex, translate, transition, valueCallbacks) {
                    if (typeof translate === 'undefined') {
                        translate = $.getTranslate(col.wrapper[0], 'y');
                    }
                    if(typeof activeIndex === 'undefined') activeIndex = -Math.round((translate - maxTranslate)/itemHeight);
                    if (activeIndex < 0) activeIndex = 0;
                    if (activeIndex >= col.items.length) activeIndex = col.items.length - 1;
                    var previousActiveIndex = col.activeIndex;
                    col.activeIndex = activeIndex;
                    col.wrapper.find('.picker-selected').removeClass('picker-selected');
        
                    col.items.transition(transition);
                    
                    var selectedItem = col.items.eq(activeIndex).addClass('picker-selected').transform('');
                        
                    // Set 3D rotate effect
                    if (p.params.rotateEffect) {
                        var percentage = (translate - (Math.floor((translate - maxTranslate)/itemHeight) * itemHeight + maxTranslate)) / itemHeight;
                        
                        col.items.each(function () {
                            var item = $(this);
                            var itemOffsetTop = item.index() * itemHeight;
                            var translateOffset = maxTranslate - translate;
                            var itemOffset = itemOffsetTop - translateOffset;
                            var percentage = itemOffset / itemHeight;
        
                            var itemsFit = Math.ceil(col.height / itemHeight / 2) + 1;
                            
                            var angle = (-18*percentage);
                            if (angle > 180) angle = 180;
                            if (angle < -180) angle = -180;
                            // Far class
                            if (Math.abs(percentage) > itemsFit) item.addClass('picker-item-far');
                            else item.removeClass('picker-item-far');
                            // Set transform
                            item.transform('translate3d(0, ' + (-translate + maxTranslate) + 'px, ' + (originBug ? -110 : 0) + 'px) rotateX(' + angle + 'deg)');
                        });
                    }
        
                    if (valueCallbacks || typeof valueCallbacks === 'undefined') {
                        // Update values
                        col.value = selectedItem.attr('data-picker-value');
                        col.displayValue = col.displayValues ? col.displayValues[activeIndex] : col.value;
                        // On change callback
                        if (previousActiveIndex !== activeIndex) {
                            if (col.onChange) {
                                col.onChange(p, col.value, col.displayValue);
                            }
                            p.updateValue();
                        }
                    }
                };
        
                function updateDuringScroll() {
                    animationFrameId = $.requestAnimationFrame(function () {
                        col.updateItems(undefined, undefined, 0);
                        updateDuringScroll();
                    });
                }
        
                // Update items on init
                if (updateItems) col.updateItems(0, maxTranslate, 0);
        
                var allowItemClick = true;
                var isTouched, isMoved, touchStartY, touchCurrentY, touchStartTime, touchEndTime, startTranslate, returnTo, currentTranslate, prevTranslate, velocityTranslate, velocityTime;
                function handleTouchStart (e) {
                    if (isMoved || isTouched) return;
                    e.preventDefault();
                    isTouched = true;
                    touchStartY = touchCurrentY = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                    touchStartTime = (new Date()).getTime();
                    
                    allowItemClick = true;
                    startTranslate = currentTranslate = $.getTranslate(col.wrapper[0], 'y');
                }
                function handleTouchMove (e) {
                    if (!isTouched) return;
                    e.preventDefault();
                    allowItemClick = false;
                    touchCurrentY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                    if (!isMoved) {
                        // First move
                        $.cancelAnimationFrame(animationFrameId);
                        isMoved = true;
                        startTranslate = currentTranslate = $.getTranslate(col.wrapper[0], 'y');
                        col.wrapper.transition(0);
                    }
                    e.preventDefault();
        
                    var diff = touchCurrentY - touchStartY;
                    currentTranslate = startTranslate + diff;
                    returnTo = undefined;
        
                    // Normalize translate
                    if (currentTranslate < minTranslate) {
                        currentTranslate = minTranslate - Math.pow(minTranslate - currentTranslate, 0.8);
                        returnTo = 'min';
                    }
                    if (currentTranslate > maxTranslate) {
                        currentTranslate = maxTranslate + Math.pow(currentTranslate - maxTranslate, 0.8);
                        returnTo = 'max';
                    }
                    // Transform wrapper
                    col.wrapper.transform('translate3d(0,' + currentTranslate + 'px,0)');
        
                    // Update items
                    col.updateItems(undefined, currentTranslate, 0, p.params.updateValuesOnTouchmove);
                    
                    // Calc velocity
                    velocityTranslate = currentTranslate - prevTranslate || currentTranslate;
                    velocityTime = (new Date()).getTime();
                    prevTranslate = currentTranslate;
                }
                function handleTouchEnd (e) {
                    if (!isTouched || !isMoved) {
                        isTouched = isMoved = false;
                        return;
                    }
                    isTouched = isMoved = false;
                    col.wrapper.transition('');
                    if (returnTo) {
                        if (returnTo === 'min') {
                            col.wrapper.transform('translate3d(0,' + minTranslate + 'px,0)');
                        }
                        else col.wrapper.transform('translate3d(0,' + maxTranslate + 'px,0)');
                    }
                    touchEndTime = new Date().getTime();
                    var velocity, newTranslate;
                    if (touchEndTime - touchStartTime > 300) {
                        newTranslate = currentTranslate;
                    }
                    else {
                        velocity = Math.abs(velocityTranslate / (touchEndTime - velocityTime));
                        newTranslate = currentTranslate + velocityTranslate * p.params.momentumRatio;
                    }
        
                    newTranslate = Math.max(Math.min(newTranslate, maxTranslate), minTranslate);
        
                    // Active Index
                    var activeIndex = -Math.floor((newTranslate - maxTranslate)/itemHeight);
        
                    // Normalize translate
                    if (!p.params.freeMode) newTranslate = -activeIndex * itemHeight + maxTranslate;
        
                    // Transform wrapper
                    col.wrapper.transform('translate3d(0,' + (parseInt(newTranslate,10)) + 'px,0)');
        
                    // Update items
                    col.updateItems(activeIndex, newTranslate, '', true);
        
                    // Watch items
                    if (p.params.updateValuesOnMomentum) {
                        updateDuringScroll();
                        col.wrapper.transitionEnd(function(){
                            $.cancelAnimationFrame(animationFrameId);
                        });
                    }
        
                    // Allow click
                    setTimeout(function () {
                        allowItemClick = true;
                    }, 100);
                }
        
                function handleClick(e) {
                    if (!allowItemClick) return;
                    $.cancelAnimationFrame(animationFrameId);
                    /*jshint validthis:true */
                    var value = $(this).attr('data-picker-value');
                    col.setValue(value);
                }
        
                col.initEvents = function (detach) {
                    var method = detach ? 'off' : 'on';
                    col.container[method](app.touchEvents.start, handleTouchStart);
                    col.container[method](app.touchEvents.move, handleTouchMove);
                    col.container[method](app.touchEvents.end, handleTouchEnd);
                    col.items[method]('click', handleClick);
                };
                col.destroyEvents = function () {
                    col.initEvents(true);
                };
        
                col.container[0].f7DestroyPickerCol = function () {
                    col.destroyEvents();
                };
        
                col.initEvents();
        
            };
            p.destroyPickerCol = function (colContainer) {
                colContainer = $(colContainer);
                if ('f7DestroyPickerCol' in colContainer[0]) colContainer[0].f7DestroyPickerCol();
            };
            // Resize cols
            function resizeCols() {
                if (!p.opened) return;
                for (var i = 0; i < p.cols.length; i++) {
                    if (!p.cols[i].divider) {
                        p.cols[i].calcSize();
                        p.cols[i].setValue(p.cols[i].value, 0, false);
                    }
                }
            }
            $(window).on('resize', resizeCols);
        
            // HTML Layout
            p.columnHTML = function (col, onlyItems) {
                var columnItemsHTML = '';
                var columnHTML = '';
                if (col.divider) {
                    columnHTML += '<div class="picker-items-col picker-items-col-divider ' + (col.textAlign ? 'picker-items-col-' + col.textAlign : '') + ' ' + (col.cssClass || '') + '">' + col.content + '</div>';
                }
                else {
                    for (var j = 0; j < col.values.length; j++) {
                        columnItemsHTML += '<div class="picker-item" data-picker-value="' + col.values[j] + '">' + (col.displayValues ? col.displayValues[j] : col.values[j]) + '</div>';
                    }
                    columnHTML += '<div class="picker-items-col ' + (col.textAlign ? 'picker-items-col-' + col.textAlign : '') + ' ' + (col.cssClass || '') + '"><div class="picker-items-col-wrapper">' + columnItemsHTML + '</div></div>';
                }
                return onlyItems ? columnItemsHTML : columnHTML;
            };
            p.layout = function () {
                var pickerHTML = '';
                var pickerClass = '';
                var i;
                p.cols = [];
                var colsHTML = '';
                for (i = 0; i < p.params.cols.length; i++) {
                    var col = p.params.cols[i];
                    colsHTML += p.columnHTML(p.params.cols[i]);
                    p.cols.push(col);
                }
                pickerClass = 'picker-modal picker-columns ' + (p.params.cssClass || '') + (p.params.rotateEffect ? ' picker-3d' : '');
                pickerHTML =
                    '<div class="' + (pickerClass) + '">' +
                        (p.params.toolbar ? p.params.toolbarTemplate.replace(/{{closeText}}/g, p.params.toolbarCloseText) : '') +
                        '<div class="picker-modal-inner picker-items">' +
                            colsHTML +
                            '<div class="picker-center-highlight"></div>' +
                        '</div>' +
                    '</div>';
                    
                p.pickerHTML = pickerHTML;    
            };
        
            // Input Events
            function openOnInput(e) {
                e.preventDefault();
                if (p.opened) return;
                p.open();
                if (p.params.scrollToInput && !isPopover()) {
                    var pageContent = p.input.parents('.page-content');
                    if (pageContent.length === 0) return;
        
                    var paddingTop = parseInt(pageContent.css('padding-top'), 10),
                        paddingBottom = parseInt(pageContent.css('padding-bottom'), 10),
                        pageHeight = pageContent[0].offsetHeight - paddingTop - p.container.height(),
                        pageScrollHeight = pageContent[0].scrollHeight - paddingTop - p.container.height(),
                        newPaddingBottom;
                    var inputTop = p.input.offset().top - paddingTop + p.input[0].offsetHeight;
                    if (inputTop > pageHeight) {
                        var scrollTop = pageContent.scrollTop() + inputTop - pageHeight;
                        if (scrollTop + pageHeight > pageScrollHeight) {
                            newPaddingBottom = scrollTop + pageHeight - pageScrollHeight + paddingBottom;
                            if (pageHeight === pageScrollHeight) {
                                newPaddingBottom = p.container.height();
                            }
                            pageContent.css({'padding-bottom': (newPaddingBottom) + 'px'});
                        }
                        pageContent.scrollTop(scrollTop, 300);
                    }
                }
            }
            function closeOnHTMLClick(e) {
                if (inPopover()) return;
                if (p.input && p.input.length > 0) {
                    if (e.target !== p.input[0] && $(e.target).parents('.picker-modal').length === 0) p.close();
                }
                else {
                    if ($(e.target).parents('.picker-modal').length === 0) p.close();   
                }
            }
        
            if (p.params.input) {
                p.input = $(p.params.input);
                if (p.input.length > 0) {
                    if (p.params.inputReadOnly) p.input.prop('readOnly', true);
                    if (!p.inline) {
                        p.input.on('click', openOnInput);    
                    }
                    if (p.params.inputReadOnly) {
                        p.input.on('focus mousedown', function (e) {
                            e.preventDefault();
                        });
                    }
                }
                    
            }
            
            if (!p.inline && p.params.closeByOutsideClick) $('html').on('click', closeOnHTMLClick);
        
            // Open
            function onPickerClose() {
                p.opened = false;
                if (p.input && p.input.length > 0) {
                    p.input.parents('.page-content').css({'padding-bottom': ''});
                    if (app.params.material) p.input.trigger('blur');
                }
                if (p.params.onClose) p.params.onClose(p);
        
                // Destroy events
                p.container.find('.picker-items-col').each(function () {
                    p.destroyPickerCol(this);
                });
            }
        
            p.opened = false;
            p.open = function () {
                var toPopover = isPopover();
        
                if (!p.opened) {
        
                    // Layout
                    p.layout();
        
                    // Append
                    if (toPopover) {
                        p.pickerHTML = '<div class="popover popover-picker-columns"><div class="popover-inner">' + p.pickerHTML + '</div></div>';
                        p.popover = app.popover(p.pickerHTML, p.params.input, true);
                        p.container = $(p.popover).find('.picker-modal');
                        $(p.popover).on('close', function () {
                            onPickerClose();
                        });
                    }
                    else if (p.inline) {
                        p.container = $(p.pickerHTML);
                        p.container.addClass('picker-modal-inline');
                        $(p.params.container).append(p.container);
                    }
                    else {
                        p.container = $(app.pickerModal(p.pickerHTML));
                        $(p.container)
                        .on('close', function () {
                            onPickerClose();
                        });
                    }
        
                    // Store picker instance
                    p.container[0].f7Picker = p;
        
                    // Init Events
                    p.container.find('.picker-items-col').each(function () {
                        var updateItems = true;
                        if ((!p.initialized && p.params.value) || (p.initialized && p.value)) updateItems = false;
                        p.initPickerCol(this, updateItems);
                    });
                    
                    // Set value
                    if (!p.initialized) {
                        if (p.value) p.setValue(p.value, 0);
                        else if (p.params.value) {
                            p.setValue(p.params.value, 0);
                        }
                    }
                    else {
                        if (p.value) p.setValue(p.value, 0);
                    }
        
                    // Material Focus
                    if (p.input && p.input.length > 0 && app.params.material) {
                        p.input.trigger('focus');
                    }
                }
        
                // Set flag
                p.opened = true;
                p.initialized = true;
        
                if (p.params.onOpen) p.params.onOpen(p);
            };
        
            // Close
            p.close = function () {
                if (!p.opened || p.inline) return;
                if (inPopover()) {
                    app.closeModal(p.popover);
                    return;
                }
                else {
                    app.closeModal(p.container);
                    return;
                }
            };
        
            // Destroy
            p.destroy = function () {
                p.close();
                if (p.params.input && p.input.length > 0) {
                    p.input.off('click focus', openOnInput);
                }
                $('html').off('click', closeOnHTMLClick);
                $(window).off('resize', resizeCols);
            };
        
            if (p.inline) {
                p.open();
            }
            else {
                if (!p.initialized && p.params.value) p.setValue(p.params.value);
            }
        
            return p;
        };
        app.picker = function (params) {
            return new Picker(params);
        };

        /*======================================================
        ************   Calendar   ************
        ======================================================*/
        var Calendar = function (params) {
            var p = this;
            var defaults = {
                monthNames: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August' , 'September' , 'October', 'November', 'December'],
                monthNamesShort: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                dayNames: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                dayNamesShort: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                firstDay: 1, // First day of the week, Monday
                weekendDays: [0, 6], // Sunday and Saturday
                multiple: false,
                rangePicker: false,
                dateFormat: 'yyyy-mm-dd',
                direction: 'horizontal', // or 'vertical'
                minDate: null,
                maxDate: null,
                disabled: null, // dates range of disabled days
                events: null, // dates range of days with events
                rangesClasses: null, //array with custom classes date ranges
                touchMove: true,
                animate: true,
                closeOnSelect: false,
                monthPicker: true,
                monthPickerTemplate:
                    '<div class="picker-calendar-month-picker">' +
                        '<a href="#" class="link icon-only picker-calendar-prev-month"><i class="icon icon-prev"></i></a>' +
                        '<span class="current-month-value"></span>' +
                        '<a href="#" class="link icon-only picker-calendar-next-month"><i class="icon icon-next"></i></a>' +
                    '</div>',
                yearPicker: true,
                yearPickerTemplate:
                    '<div class="picker-calendar-year-picker">' +
                        '<a href="#" class="link icon-only picker-calendar-prev-year"><i class="icon icon-prev"></i></a>' +
                        '<span class="current-year-value"></span>' +
                        '<a href="#" class="link icon-only picker-calendar-next-year"><i class="icon icon-next"></i></a>' +
                    '</div>',
                weekHeader: true,
                // Common settings
                closeByOutsideClick: true,
                scrollToInput: true,
                inputReadOnly: true,
                convertToPopover: true,
                onlyInPopover: false,
                toolbar: true,
                toolbarCloseText: 'Done',
                headerPlaceholder: 'Select date',
                header: app.params.material,
                footer: app.params.material,
                toolbarTemplate:
                    '<div class="toolbar">' +
                        '<div class="toolbar-inner">' +
                            '{{monthPicker}}' +
                            '{{yearPicker}}' +
                        '</div>' +
                    '</div>',
                headerTemplate:
                    '<div class="picker-header">' +
                        '<div class="picker-calendar-selected-date">{{placeholder}}</div>' +
                    '</div>',
                footerTemplate:
                    '<div class="picker-footer">' +
                        '<a href="#" class="button close-picker">{{closeText}}</a>' +
                    '</div>',
        
                /* Callbacks
                onMonthAdd
                onChange
                onOpen
                onClose
                onDayClick
                onMonthYearChangeStart
                onMonthYearChangeEnd
                */
            };
            params = params || {};
            for (var def in defaults) {
                if (typeof params[def] === 'undefined') {
                    params[def] = defaults[def];
                }
            }
            p.params = params;
            p.initialized = false;
        
            // Inline flag
            p.inline = p.params.container ? true : false;
        
            // Is horizontal
            p.isH = p.params.direction === 'horizontal';
        
            // RTL inverter
            var inverter = p.isH ? (app.rtl ? -1 : 1) : 1;
        
            // Animating flag
            p.animating = false;
        
            // Should be converted to popover
            function isPopover() {
                var toPopover = false;
                if (!p.params.convertToPopover && !p.params.onlyInPopover) return toPopover;
                if (!p.inline && p.params.input) {
                    if (p.params.onlyInPopover) toPopover = true;
                    else {
                        if (app.device.ios) {
                            toPopover = app.device.ipad ? true : false;
                        }
                        else {
                            if ($(window).width() >= 768) toPopover = true;
                        }
                    }
                }
                return toPopover;
            }
            function inPopover() {
                if (p.opened && p.container && p.container.length > 0 && p.container.parents('.popover').length > 0) return true;
                else return false;
            }
        
            // Format date
            function formatDate(date) {
                date = new Date(date);
                var year = date.getFullYear();
                var month = date.getMonth();
                var month1 = month + 1;
                var day = date.getDate();
                var weekDay = date.getDay();
        
                return p.params.dateFormat
                    .replace(/yyyy/g, year)
                    .replace(/yy/g, (year + '').substring(2))
                    .replace(/mm/g, month1 < 10 ? '0' + month1 : month1)
                    .replace(/m(\W+)/g, month1 + '$1')
                    .replace(/MM/g, p.params.monthNames[month])
                    .replace(/M(\W+)/g, p.params.monthNamesShort[month] + '$1')
                    .replace(/dd/g, day < 10 ? '0' + day : day)
                    .replace(/d(\W+)/g, day + '$1')
                    .replace(/DD/g, p.params.dayNames[weekDay])
                    .replace(/D(\W+)/g, p.params.dayNamesShort[weekDay] + '$1');
            }
        
        
            // Value
            p.addValue = function (value) {
                if (p.params.multiple) {
                    if (!p.value) p.value = [];
                    var inValuesIndex;
                    for (var i = 0; i < p.value.length; i++) {
                        if (new Date(value).getTime() === new Date(p.value[i]).getTime()) {
                            inValuesIndex = i;
                        }
                    }
                    if (typeof inValuesIndex === 'undefined') {
                        p.value.push(value);
                    }
                    else {
                        p.value.splice(inValuesIndex, 1);
                    }
                    p.updateValue();
                }
                else if (p.params.rangePicker) {
                    if (!p.value) p.value = [];
                    if (p.value.length === 2 || p.value.length === 0) {
                        p.value = [];
                    }
                    if (p.value[0] !== value) p.value.push(value);
                    else p.value = [];
                    p.value.sort(function (a,b) {
                        return a - b;
                    });
                    p.updateValue();
                }
                else {
                    p.value = [value];
                    p.updateValue();
                }
            };
            p.setValue = function (arrValues) {
                p.value = arrValues;
                p.updateValue();
            };
            p.updateValue = function (onlyHeader) {
                var i, inputValue;
                if (p.container && p.container.length > 0) {
                    p.wrapper.find('.picker-calendar-day-selected').removeClass('picker-calendar-day-selected');
                    var valueDate;
                    if (p.params.rangePicker && p.value.length === 2) {
                        for (i = p.value[0]; i <= p.value[1]; i += 24*60*60*1000) {
                            valueDate = new Date(i);
                            p.wrapper.find('.picker-calendar-day[data-date="' + valueDate.getFullYear() + '-' + valueDate.getMonth() + '-' + valueDate.getDate() + '"]').addClass('picker-calendar-day-selected');
                        }
                    }
                    else {
                        for (i = 0; i < p.value.length; i++) {
                            valueDate = new Date(p.value[i]);
                            p.wrapper.find('.picker-calendar-day[data-date="' + valueDate.getFullYear() + '-' + valueDate.getMonth() + '-' + valueDate.getDate() + '"]').addClass('picker-calendar-day-selected');
                        }
                    }
                }
        
                if (p.params.onChange) {
                    p.params.onChange(p, p.value);
                }
                if ((p.input && p.input.length > 0) || (app.params.material && p.params.header)) {
                    if (p.params.formatValue) inputValue = p.params.formatValue(p, p.value);
                    else {
                        inputValue = [];
                        for (i = 0; i < p.value.length; i++) {
                            inputValue.push(formatDate(p.value[i]));
                        }
                        inputValue = inputValue.join(p.params.rangePicker ? ' - ' : ', ');
                    }
                    if (app.params.material && p.params.header && p.container && p.container.length > 0) {
                        p.container.find('.picker-calendar-selected-date').text(inputValue);
                    }
                    if (p.input && p.input.length > 0 && !onlyHeader) {
                        $(p.input).val(inputValue);
                        $(p.input).trigger('change');
                    }
        
                }
            };
        
            // Columns Handlers
            p.initCalendarEvents = function () {
                var col;
                var allowItemClick = true;
                var isTouched, isMoved, touchStartX, touchStartY, touchCurrentX, touchCurrentY, touchStartTime, touchEndTime, startTranslate, currentTranslate, wrapperWidth, wrapperHeight, percentage, touchesDiff, isScrolling;
                function handleTouchStart (e) {
                    if (isMoved || isTouched) return;
                    // e.preventDefault();
                    isTouched = true;
                    touchStartX = touchCurrentY = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
                    touchStartY = touchCurrentY = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
                    touchStartTime = (new Date()).getTime();
                    percentage = 0;
                    allowItemClick = true;
                    isScrolling = undefined;
                    startTranslate = currentTranslate = p.monthsTranslate;
                }
                function handleTouchMove (e) {
                    if (!isTouched) return;
        
                    touchCurrentX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                    touchCurrentY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                    if (typeof isScrolling === 'undefined') {
                        isScrolling = !!(isScrolling || Math.abs(touchCurrentY - touchStartY) > Math.abs(touchCurrentX - touchStartX));
                    }
                    if (p.isH && isScrolling) {
                        isTouched = false;
                        return;
                    }
                    e.preventDefault();
                    if (p.animating) {
                        isTouched = false;
                        return;
                    }
                    allowItemClick = false;
                    if (!isMoved) {
                        // First move
                        isMoved = true;
                        wrapperWidth = p.wrapper[0].offsetWidth;
                        wrapperHeight = p.wrapper[0].offsetHeight;
                        p.wrapper.transition(0);
                    }
                    e.preventDefault();
        
                    touchesDiff = p.isH ? touchCurrentX - touchStartX : touchCurrentY - touchStartY;
                    percentage = touchesDiff/(p.isH ? wrapperWidth : wrapperHeight);
                    currentTranslate = (p.monthsTranslate * inverter + percentage) * 100;
        
                    // Transform wrapper
                    p.wrapper.transform('translate3d(' + (p.isH ? currentTranslate : 0) + '%, ' + (p.isH ? 0 : currentTranslate) + '%, 0)');
        
                }
                function handleTouchEnd (e) {
                    if (!isTouched || !isMoved) {
                        isTouched = isMoved = false;
                        return;
                    }
                    isTouched = isMoved = false;
        
                    touchEndTime = new Date().getTime();
                    if (touchEndTime - touchStartTime < 300) {
                        if (Math.abs(touchesDiff) < 10) {
                            p.resetMonth();
                        }
                        else if (touchesDiff >= 10) {
                            if (app.rtl) p.nextMonth();
                            else p.prevMonth();
                        }
                        else {
                            if (app.rtl) p.prevMonth();
                            else p.nextMonth();
                        }
                    }
                    else {
                        if (percentage <= -0.5) {
                            if (app.rtl) p.prevMonth();
                            else p.nextMonth();
                        }
                        else if (percentage >= 0.5) {
                            if (app.rtl) p.nextMonth();
                            else p.prevMonth();
                        }
                        else {
                            p.resetMonth();
                        }
                    }
        
                    // Allow click
                    setTimeout(function () {
                        allowItemClick = true;
                    }, 100);
                }
        
                function handleDayClick(e) {
                    if (!allowItemClick) return;
                    var day = $(e.target).parents('.picker-calendar-day');
                    if (day.length === 0 && $(e.target).hasClass('picker-calendar-day')) {
                        day = $(e.target);
                    }
                    if (day.length === 0) return;
                    if (day.hasClass('picker-calendar-day-selected') && !(p.params.multiple || p.params.rangePicker)) return;
                    if (day.hasClass('picker-calendar-day-disabled')) return;
                    if (!p.params.rangePicker) {
                        if (day.hasClass('picker-calendar-day-next')) p.nextMonth();
                        if (day.hasClass('picker-calendar-day-prev')) p.prevMonth();
                    }
                    var dateYear = day.attr('data-year');
                    var dateMonth = day.attr('data-month');
                    var dateDay = day.attr('data-day');
                    if (p.params.onDayClick) {
                        p.params.onDayClick(p, day[0], dateYear, dateMonth, dateDay);
                    }
                    p.addValue(new Date(dateYear, dateMonth, dateDay).getTime());
                    if (p.params.closeOnSelect) {
                        if (p.params.rangePicker && p.value.length === 2 || !p.params.rangePicker) p.close();
                    }
                }
        
                p.container.find('.picker-calendar-prev-month').on('click', p.prevMonth);
                p.container.find('.picker-calendar-next-month').on('click', p.nextMonth);
                p.container.find('.picker-calendar-prev-year').on('click', p.prevYear);
                p.container.find('.picker-calendar-next-year').on('click', p.nextYear);
                p.wrapper.on('click', handleDayClick);
                if (p.params.touchMove) {
                    p.wrapper.on(app.touchEvents.start, handleTouchStart);
                    p.wrapper.on(app.touchEvents.move, handleTouchMove);
                    p.wrapper.on(app.touchEvents.end, handleTouchEnd);
                }
        
                p.container[0].f7DestroyCalendarEvents = function () {
                    p.container.find('.picker-calendar-prev-month').off('click', p.prevMonth);
                    p.container.find('.picker-calendar-next-month').off('click', p.nextMonth);
                    p.container.find('.picker-calendar-prev-year').off('click', p.prevYear);
                    p.container.find('.picker-calendar-next-year').off('click', p.nextYear);
                    p.wrapper.off('click', handleDayClick);
                    if (p.params.touchMove) {
                        p.wrapper.off(app.touchEvents.start, handleTouchStart);
                        p.wrapper.off(app.touchEvents.move, handleTouchMove);
                        p.wrapper.off(app.touchEvents.end, handleTouchEnd);
                    }
                };
        
        
            };
            p.destroyCalendarEvents = function (colContainer) {
                if ('f7DestroyCalendarEvents' in p.container[0]) p.container[0].f7DestroyCalendarEvents();
            };
        
            // Scan Dates Range
            p.dateInRange = function (dayDate, range) {
                var match = false;
                var i;
                if (!range) return false;
                if ($.isArray(range)) {
                    for (i = 0; i < range.length; i ++) {
                        if (range[i].from || range[i].to) {
                            if (range[i].from && range[i].to) {
                                if ((dayDate <= new Date(range[i].to).getTime()) && (dayDate >= new Date(range[i].from).getTime())) {
                                    match = true;
                                }
                            }
                            else if (range[i].from) {
                                if (dayDate >= new Date(range[i].from).getTime()) {
                                    match = true;
                                }
                            }
                            else if (range[i].to) {
                                if (dayDate <= new Date(range[i].to).getTime()) {
                                    match = true;
                                }
                            }
                        } else if (dayDate === new Date(range[i]).getTime()) {
                            match = true;
                        }
                    }
                }
                else if (range.from || range.to) {
                    if (range.from && range.to) {
                        if ((dayDate <= new Date(range.to).getTime()) && (dayDate >= new Date(range.from).getTime())) {
                            match = true;
                        }
                    }
                    else if (range.from) {
                        if (dayDate >= new Date(range.from).getTime()) {
                            match = true;
                        }
                    }
                    else if (range.to) {
                        if (dayDate <= new Date(range.to).getTime()) {
                            match = true;
                        }
                    }
                }
                else if (typeof range === 'function') {
                    match = range(new Date(dayDate));
                }
                return match;
            };
            // Calendar Methods
            p.daysInMonth = function (date) {
                var d = new Date(date);
                return new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
            };
            p.monthHTML = function (date, offset) {
                date = new Date(date);
                var year = date.getFullYear(),
                    month = date.getMonth(),
                    day = date.getDate();
                if (offset === 'next') {
                    if (month === 11) date = new Date(year + 1, 0);
                    else date = new Date(year, month + 1, 1);
                }
                if (offset === 'prev') {
                    if (month === 0) date = new Date(year - 1, 11);
                    else date = new Date(year, month - 1, 1);
                }
                if (offset === 'next' || offset === 'prev') {
                    month = date.getMonth();
                    year = date.getFullYear();
                }
                var daysInPrevMonth = p.daysInMonth(new Date(date.getFullYear(), date.getMonth()).getTime() - 10 * 24 * 60 * 60 * 1000),
                    daysInMonth = p.daysInMonth(date),
                    firstDayOfMonthIndex = new Date(date.getFullYear(), date.getMonth()).getDay();
                if (firstDayOfMonthIndex === 0) firstDayOfMonthIndex = 7;
        
                var dayDate, currentValues = [], i, j, k,
                    rows = 6, cols = 7,
                    monthHTML = '',
                    dayIndex = 0 + (p.params.firstDay - 1),
                    today = new Date().setHours(0,0,0,0),
                    minDate = p.params.minDate ? new Date(p.params.minDate).getTime() : null,
                    maxDate = p.params.maxDate ? new Date(p.params.maxDate).getTime() : null,
                    disabled,
                    hasEvent;
        
                if (p.value && p.value.length) {
                    for (i = 0; i < p.value.length; i++) {
                        currentValues.push(new Date(p.value[i]).setHours(0,0,0,0));
                    }
                }
        
                for (i = 1; i <= rows; i++) {
                    var rowHTML = '';
                    var row = i;
                    for (j = 1; j <= cols; j++) {
                        var col = j;
                        dayIndex ++;
                        var dayNumber = dayIndex - firstDayOfMonthIndex;
                        var weekDayIndex = (col - 1 + p.params.firstDay > 6) ? (col - 1 - 7 + p.params.firstDay) : (col - 1 + p.params.firstDay);
                        var addClass = '';
                        if (dayNumber < 0) {
                            dayNumber = daysInPrevMonth + dayNumber + 1;
                            addClass += ' picker-calendar-day-prev';
                            dayDate = new Date(month - 1 < 0 ? year - 1 : year, month - 1 < 0 ? 11 : month - 1, dayNumber).getTime();
                        }
                        else {
                            dayNumber = dayNumber + 1;
                            if (dayNumber > daysInMonth) {
                                dayNumber = dayNumber - daysInMonth;
                                addClass += ' picker-calendar-day-next';
                                dayDate = new Date(month + 1 > 11 ? year + 1 : year, month + 1 > 11 ? 0 : month + 1, dayNumber).getTime();
                            }
                            else {
                                dayDate = new Date(year, month, dayNumber).getTime();
                            }
                        }
                        // Today
                        if (dayDate === today) addClass += ' picker-calendar-day-today';
                        // Selected
                        if (p.params.rangePicker && currentValues.length === 2) {
                            if (dayDate >= currentValues[0] && dayDate <= currentValues[1]) addClass += ' picker-calendar-day-selected';
                        }
                        else {
                            if (currentValues.indexOf(dayDate) >= 0) addClass += ' picker-calendar-day-selected';
                        }
                        // Weekend
                        if (p.params.weekendDays.indexOf(weekDayIndex) >= 0) {
                            addClass += ' picker-calendar-day-weekend';
                        }
                        // Has Events
                        hasEvent = false;
                        if (p.params.events) {
                            if (p.dateInRange(dayDate, p.params.events)) {
                                hasEvent = true;
                            }
                        }
                        if (hasEvent) {
                            addClass += ' picker-calendar-day-has-events';
                        }
                        // Custom Ranges
                        if (p.params.rangesClasses) {
                            for (k = 0; k < p.params.rangesClasses.length; k++) {
                                if (p.dateInRange(dayDate, p.params.rangesClasses[k].range)) {
                                    addClass += ' ' + p.params.rangesClasses[k].cssClass;
                                }
                            }
                        }
                        // Disabled
                        disabled = false;
                        if ((minDate && dayDate < minDate) || (maxDate && dayDate > maxDate)) {
                            disabled = true;
                        }
                        if (p.params.disabled) {
                            if (p.dateInRange(dayDate, p.params.disabled)) {
                                disabled = true;
                            }
                        }
                        if (disabled) {
                            addClass += ' picker-calendar-day-disabled';
                        }
        
        
                        dayDate = new Date(dayDate);
                        var dayYear = dayDate.getFullYear();
                        var dayMonth = dayDate.getMonth();
                        rowHTML += '<div data-year="' + dayYear + '" data-month="' + dayMonth + '" data-day="' + dayNumber + '" class="picker-calendar-day' + (addClass) + '" data-date="' + (dayYear + '-' + dayMonth + '-' + dayNumber) + '"><span>'+dayNumber+'</span></div>';
                    }
                    monthHTML += '<div class="picker-calendar-row">' + rowHTML + '</div>';
                }
                monthHTML = '<div class="picker-calendar-month" data-year="' + year + '" data-month="' + month + '">' + monthHTML + '</div>';
                return monthHTML;
            };
            p.animating = false;
            p.updateCurrentMonthYear = function (dir) {
                if (typeof dir === 'undefined') {
                    p.currentMonth = parseInt(p.months.eq(1).attr('data-month'), 10);
                    p.currentYear = parseInt(p.months.eq(1).attr('data-year'), 10);
                }
                else {
                    p.currentMonth = parseInt(p.months.eq(dir === 'next' ? (p.months.length - 1) : 0).attr('data-month'), 10);
                    p.currentYear = parseInt(p.months.eq(dir === 'next' ? (p.months.length - 1) : 0).attr('data-year'), 10);
                }
                p.container.find('.current-month-value').text(p.params.monthNames[p.currentMonth]);
                p.container.find('.current-year-value').text(p.currentYear);
        
            };
            p.onMonthChangeStart = function (dir) {
                p.updateCurrentMonthYear(dir);
                p.months.removeClass('picker-calendar-month-current picker-calendar-month-prev picker-calendar-month-next');
                var currentIndex = dir === 'next' ? p.months.length - 1 : 0;
        
                p.months.eq(currentIndex).addClass('picker-calendar-month-current');
                p.months.eq(dir === 'next' ? currentIndex - 1 : currentIndex + 1).addClass(dir === 'next' ? 'picker-calendar-month-prev' : 'picker-calendar-month-next');
        
                if (p.params.onMonthYearChangeStart) {
                    p.params.onMonthYearChangeStart(p, p.currentYear, p.currentMonth);
                }
            };
            p.onMonthChangeEnd = function (dir, rebuildBoth) {
                p.animating = false;
                var nextMonthHTML, prevMonthHTML, newMonthHTML;
                p.wrapper.find('.picker-calendar-month:not(.picker-calendar-month-prev):not(.picker-calendar-month-current):not(.picker-calendar-month-next)').remove();
        
                if (typeof dir === 'undefined') {
                    dir = 'next';
                    rebuildBoth = true;
                }
                if (!rebuildBoth) {
                    newMonthHTML = p.monthHTML(new Date(p.currentYear, p.currentMonth), dir);
                }
                else {
                    p.wrapper.find('.picker-calendar-month-next, .picker-calendar-month-prev').remove();
                    prevMonthHTML = p.monthHTML(new Date(p.currentYear, p.currentMonth), 'prev');
                    nextMonthHTML = p.monthHTML(new Date(p.currentYear, p.currentMonth), 'next');
                }
                if (dir === 'next' || rebuildBoth) {
                    p.wrapper.append(newMonthHTML || nextMonthHTML);
                }
                if (dir === 'prev' || rebuildBoth) {
                    p.wrapper.prepend(newMonthHTML || prevMonthHTML);
                }
                p.months = p.wrapper.find('.picker-calendar-month');
                p.setMonthsTranslate(p.monthsTranslate);
                if (p.params.onMonthAdd) {
                    p.params.onMonthAdd(p, dir === 'next' ? p.months.eq(p.months.length - 1)[0] : p.months.eq(0)[0]);
                }
                if (p.params.onMonthYearChangeEnd) {
                    p.params.onMonthYearChangeEnd(p, p.currentYear, p.currentMonth);
                }
            };
            p.setMonthsTranslate = function (translate) {
                translate = translate || p.monthsTranslate || 0;
                if (typeof p.monthsTranslate === 'undefined') p.monthsTranslate = translate;
                p.months.removeClass('picker-calendar-month-current picker-calendar-month-prev picker-calendar-month-next');
                var prevMonthTranslate = -(translate + 1) * 100 * inverter;
                var currentMonthTranslate = -translate * 100 * inverter;
                var nextMonthTranslate = -(translate - 1) * 100 * inverter;
                p.months.eq(0).transform('translate3d(' + (p.isH ? prevMonthTranslate : 0) + '%, ' + (p.isH ? 0 : prevMonthTranslate) + '%, 0)').addClass('picker-calendar-month-prev');
                p.months.eq(1).transform('translate3d(' + (p.isH ? currentMonthTranslate : 0) + '%, ' + (p.isH ? 0 : currentMonthTranslate) + '%, 0)').addClass('picker-calendar-month-current');
                p.months.eq(2).transform('translate3d(' + (p.isH ? nextMonthTranslate : 0) + '%, ' + (p.isH ? 0 : nextMonthTranslate) + '%, 0)').addClass('picker-calendar-month-next');
            };
            p.nextMonth = function (transition) {
                if (typeof transition === 'undefined' || typeof transition === 'object') {
                    transition = '';
                    if (!p.params.animate) transition = 0;
                }
                var nextMonth = parseInt(p.months.eq(p.months.length - 1).attr('data-month'), 10);
                var nextYear = parseInt(p.months.eq(p.months.length - 1).attr('data-year'), 10);
                var nextDate = new Date(nextYear, nextMonth);
                var nextDateTime = nextDate.getTime();
                var transitionEndCallback = p.animating ? false : true;
                if (p.params.maxDate) {
                    if (nextDateTime > new Date(p.params.maxDate).getTime()) {
                        return p.resetMonth();
                    }
                }
                p.monthsTranslate --;
                if (nextMonth === p.currentMonth) {
                    var nextMonthTranslate = -(p.monthsTranslate) * 100 * inverter;
                    var nextMonthHTML = $(p.monthHTML(nextDateTime, 'next')).transform('translate3d(' + (p.isH ? nextMonthTranslate : 0) + '%, ' + (p.isH ? 0 : nextMonthTranslate) + '%, 0)').addClass('picker-calendar-month-next');
                    p.wrapper.append(nextMonthHTML[0]);
                    p.months = p.wrapper.find('.picker-calendar-month');
                    if (p.params.onMonthAdd) {
                        p.params.onMonthAdd(p, p.months.eq(p.months.length - 1)[0]);
                    }
                }
                p.animating = true;
                p.onMonthChangeStart('next');
                var translate = (p.monthsTranslate * 100) * inverter;
        
                p.wrapper.transition(transition).transform('translate3d(' + (p.isH ? translate : 0) + '%, ' + (p.isH ? 0 : translate) + '%, 0)');
                if (transitionEndCallback) {
                    p.wrapper.transitionEnd(function () {
                        p.onMonthChangeEnd('next');
                    });
                }
                if (!p.params.animate) {
                    p.onMonthChangeEnd('next');
                }
            };
            p.prevMonth = function (transition) {
                if (typeof transition === 'undefined' || typeof transition === 'object') {
                    transition = '';
                    if (!p.params.animate) transition = 0;
                }
                var prevMonth = parseInt(p.months.eq(0).attr('data-month'), 10);
                var prevYear = parseInt(p.months.eq(0).attr('data-year'), 10);
                var prevDate = new Date(prevYear, prevMonth + 1, -1);
                var prevDateTime = prevDate.getTime();
                var transitionEndCallback = p.animating ? false : true;
                if (p.params.minDate) {
                    if (prevDateTime < new Date(p.params.minDate).getTime()) {
                        return p.resetMonth();
                    }
                }
                p.monthsTranslate ++;
                if (prevMonth === p.currentMonth) {
                    var prevMonthTranslate = -(p.monthsTranslate) * 100 * inverter;
                    var prevMonthHTML = $(p.monthHTML(prevDateTime, 'prev')).transform('translate3d(' + (p.isH ? prevMonthTranslate : 0) + '%, ' + (p.isH ? 0 : prevMonthTranslate) + '%, 0)').addClass('picker-calendar-month-prev');
                    p.wrapper.prepend(prevMonthHTML[0]);
                    p.months = p.wrapper.find('.picker-calendar-month');
                    if (p.params.onMonthAdd) {
                        p.params.onMonthAdd(p, p.months.eq(0)[0]);
                    }
                }
                p.animating = true;
                p.onMonthChangeStart('prev');
                var translate = (p.monthsTranslate * 100) * inverter;
                p.wrapper.transition(transition).transform('translate3d(' + (p.isH ? translate : 0) + '%, ' + (p.isH ? 0 : translate) + '%, 0)');
                if (transitionEndCallback) {
                    p.wrapper.transitionEnd(function () {
                        p.onMonthChangeEnd('prev');
                    });
                }
                if (!p.params.animate) {
                    p.onMonthChangeEnd('prev');
                }
            };
            p.resetMonth = function (transition) {
                if (typeof transition === 'undefined') transition = '';
                var translate = (p.monthsTranslate * 100) * inverter;
                p.wrapper.transition(transition).transform('translate3d(' + (p.isH ? translate : 0) + '%, ' + (p.isH ? 0 : translate) + '%, 0)');
            };
            p.setYearMonth = function (year, month, transition) {
                if (typeof year === 'undefined') year = p.currentYear;
                if (typeof month === 'undefined') month = p.currentMonth;
                if (typeof transition === 'undefined' || typeof transition === 'object') {
                    transition = '';
                    if (!p.params.animate) transition = 0;
                }
                var targetDate;
                if (year < p.currentYear) {
                    targetDate = new Date(year, month + 1, -1).getTime();
                }
                else {
                    targetDate = new Date(year, month).getTime();
                }
                if (p.params.maxDate && targetDate > new Date(p.params.maxDate).getTime()) {
                    return false;
                }
                if (p.params.minDate && targetDate < new Date(p.params.minDate).getTime()) {
                    return false;
                }
                var currentDate = new Date(p.currentYear, p.currentMonth).getTime();
                var dir = targetDate > currentDate ? 'next' : 'prev';
                var newMonthHTML = p.monthHTML(new Date(year, month));
                p.monthsTranslate = p.monthsTranslate || 0;
                var prevTranslate = p.monthsTranslate;
                var monthTranslate, wrapperTranslate;
                var transitionEndCallback = p.animating ? false : true;
                if (targetDate > currentDate) {
                    // To next
                    p.monthsTranslate --;
                    if (!p.animating) p.months.eq(p.months.length - 1).remove();
                    p.wrapper.append(newMonthHTML);
                    p.months = p.wrapper.find('.picker-calendar-month');
                    monthTranslate = -(prevTranslate - 1) * 100 * inverter;
                    p.months.eq(p.months.length - 1).transform('translate3d(' + (p.isH ? monthTranslate : 0) + '%, ' + (p.isH ? 0 : monthTranslate) + '%, 0)').addClass('picker-calendar-month-next');
                }
                else {
                    // To prev
                    p.monthsTranslate ++;
                    if (!p.animating) p.months.eq(0).remove();
                    p.wrapper.prepend(newMonthHTML);
                    p.months = p.wrapper.find('.picker-calendar-month');
                    monthTranslate = -(prevTranslate + 1) * 100 * inverter;
                    p.months.eq(0).transform('translate3d(' + (p.isH ? monthTranslate : 0) + '%, ' + (p.isH ? 0 : monthTranslate) + '%, 0)').addClass('picker-calendar-month-prev');
                }
                if (p.params.onMonthAdd) {
                    p.params.onMonthAdd(p, dir === 'next' ? p.months.eq(p.months.length - 1)[0] : p.months.eq(0)[0]);
                }
                p.animating = true;
                p.onMonthChangeStart(dir);
                wrapperTranslate = (p.monthsTranslate * 100) * inverter;
                p.wrapper.transition(transition).transform('translate3d(' + (p.isH ? wrapperTranslate : 0) + '%, ' + (p.isH ? 0 : wrapperTranslate) + '%, 0)');
                if (transitionEndCallback) {
                   p.wrapper.transitionEnd(function () {
                        p.onMonthChangeEnd(dir, true);
                    });
                }
                if (!p.params.animate) {
                    p.onMonthChangeEnd(dir);
                }
            };
            p.nextYear = function () {
                p.setYearMonth(p.currentYear + 1);
            };
            p.prevYear = function () {
                p.setYearMonth(p.currentYear - 1);
            };
        
        
            // HTML Layout
            p.layout = function () {
                var pickerHTML = '';
                var pickerClass = '';
                var i;
        
                var layoutDate = p.value && p.value.length ? p.value[0] : new Date().setHours(0,0,0,0);
                var prevMonthHTML = p.monthHTML(layoutDate, 'prev');
                var currentMonthHTML = p.monthHTML(layoutDate);
                var nextMonthHTML = p.monthHTML(layoutDate, 'next');
                var monthsHTML = '<div class="picker-calendar-months"><div class="picker-calendar-months-wrapper">' + (prevMonthHTML + currentMonthHTML + nextMonthHTML) + '</div></div>';
                // Week days header
                var weekHeaderHTML = '';
                if (p.params.weekHeader) {
                    for (i = 0; i < 7; i++) {
                        var weekDayIndex = (i + p.params.firstDay > 6) ? (i - 7 + p.params.firstDay) : (i + p.params.firstDay);
                        var dayName = p.params.dayNamesShort[weekDayIndex];
                        weekHeaderHTML += '<div class="picker-calendar-week-day ' + ((p.params.weekendDays.indexOf(weekDayIndex) >= 0) ? 'picker-calendar-week-day-weekend' : '') + '"> ' + dayName + '</div>';
        
                    }
                    weekHeaderHTML = '<div class="picker-calendar-week-days">' + weekHeaderHTML + '</div>';
                }
                pickerClass = 'picker-modal picker-calendar' +
                            (p.params.rangePicker ? ' picker-calendar-range' : '') +
                            (p.params.cssClass ? ' ' + p.params.cssClass : '');
                var toolbarHTML = p.params.toolbar ? p.params.toolbarTemplate.replace(/{{closeText}}/g, p.params.toolbarCloseText) : '';
                if (p.params.toolbar) {
                    toolbarHTML = p.params.toolbarTemplate
                        .replace(/{{closeText}}/g, p.params.toolbarCloseText)
                        .replace(/{{monthPicker}}/g, (p.params.monthPicker ? p.params.monthPickerTemplate : ''))
                        .replace(/{{yearPicker}}/g, (p.params.yearPicker ? p.params.yearPickerTemplate : ''));
                }
                var headerHTML = p.params.header ? p.params.headerTemplate.replace(/{{closeText}}/g, p.params.toolbarCloseText).replace(/{{placeholder}}/g, p.params.headerPlaceholder) : '';
                var footerHTML = p.params.footer ? p.params.footerTemplate.replace(/{{closeText}}/g, p.params.toolbarCloseText) : '';
        
                pickerHTML =
                    '<div class="' + (pickerClass) + '">' +
                        headerHTML +
                        footerHTML +
                        toolbarHTML +
                        '<div class="picker-modal-inner">' +
                            weekHeaderHTML +
                            monthsHTML +
                        '</div>' +
                    '</div>';
        
        
                p.pickerHTML = pickerHTML;
            };
        
            // Input Events
            function openOnInput(e) {
                e.preventDefault();
                if (p.opened) return;
                p.open();
                if (p.params.scrollToInput && !isPopover() && !app.params.material) {
                    var pageContent = p.input.parents('.page-content');
                    if (pageContent.length === 0) return;
        
                    var paddingTop = parseInt(pageContent.css('padding-top'), 10),
                        paddingBottom = parseInt(pageContent.css('padding-bottom'), 10),
                        pageHeight = pageContent[0].offsetHeight - paddingTop - p.container.height(),
                        pageScrollHeight = pageContent[0].scrollHeight - paddingTop - p.container.height(),
                        newPaddingBottom;
        
                    var inputTop = p.input.offset().top - paddingTop + p.input[0].offsetHeight;
                    if (inputTop > pageHeight) {
                        var scrollTop = pageContent.scrollTop() + inputTop - pageHeight;
                        if (scrollTop + pageHeight > pageScrollHeight) {
                            newPaddingBottom = scrollTop + pageHeight - pageScrollHeight + paddingBottom;
                            if (pageHeight === pageScrollHeight) {
                                newPaddingBottom = p.container.height();
                            }
                            pageContent.css({'padding-bottom': (newPaddingBottom) + 'px'});
                        }
                        pageContent.scrollTop(scrollTop, 300);
                    }
                }
            }
            function closeOnHTMLClick(e) {
                if (inPopover()) return;
                if (p.input && p.input.length > 0) {
                    if (e.target !== p.input[0] && $(e.target).parents('.picker-modal').length === 0) p.close();
                }
                else {
                    if ($(e.target).parents('.picker-modal').length === 0) p.close();
                }
            }
        
            if (p.params.input) {
                p.input = $(p.params.input);
                if (p.input.length > 0) {
                    if (p.params.inputReadOnly) p.input.prop('readOnly', true);
                    if (!p.inline) {
                        p.input.on('click', openOnInput);
                    }
                    if (p.params.inputReadOnly) {
                        p.input.on('focus mousedown', function (e) {
                            e.preventDefault();
                        });
                    }
                }
        
            }
        
            if (!p.inline && p.params.closeByOutsideClick) $('html').on('click', closeOnHTMLClick);
        
            // Open
            function onPickerClose() {
                p.opened = false;
                if (p.input && p.input.length > 0) {
                    p.input.parents('.page-content').css({'padding-bottom': ''});
                    if (app.params.material) p.input.trigger('blur');
                }
                if (p.params.onClose) p.params.onClose(p);
        
                // Destroy events
                p.destroyCalendarEvents();
            }
        
            p.opened = false;
            p.open = function () {
                var toPopover = isPopover();
                var updateValue = false;
                if (!p.opened) {
                    // Set date value
                    if (!p.value) {
                        if (p.params.value) {
                            p.value = p.params.value;
                            updateValue = true;
                        }
                    }
        
                    // Layout
                    p.layout();
        
                    // Append
                    if (toPopover) {
                        p.pickerHTML = '<div class="popover popover-picker-calendar"><div class="popover-inner">' + p.pickerHTML + '</div></div>';
                        p.popover = app.popover(p.pickerHTML, p.params.input, true);
                        p.container = $(p.popover).find('.picker-modal');
                        $(p.popover).on('close', function () {
                            onPickerClose();
                        });
                    }
                    else if (p.inline) {
                        p.container = $(p.pickerHTML);
                        p.container.addClass('picker-modal-inline');
                        $(p.params.container).append(p.container);
                    }
                    else {
                        p.container = $(app.pickerModal(p.pickerHTML));
                        $(p.container)
                        .on('close', function () {
                            onPickerClose();
                        });
                    }
        
                    // Store calendar instance
                    p.container[0].f7Calendar = p;
                    p.wrapper = p.container.find('.picker-calendar-months-wrapper');
        
                    // Months
                    p.months = p.wrapper.find('.picker-calendar-month');
        
                    // Update current month and year
                    p.updateCurrentMonthYear();
        
                    // Set initial translate
                    p.monthsTranslate = 0;
                    p.setMonthsTranslate();
        
                    // Init events
                    p.initCalendarEvents();
        
                    // Update input value
                    if (updateValue) p.updateValue();
                    else if (app.params.material && p.value) p.updateValue(true);
        
                    // Material Focus
                    if (p.input && p.input.length > 0 && app.params.material) {
                        p.input.trigger('focus');
                    }
        
                }
        
                // Set flag
                p.opened = true;
                p.initialized = true;
                if (p.params.onMonthAdd) {
                    p.months.each(function () {
                        p.params.onMonthAdd(p, this);
                    });
                }
                if (p.params.onOpen) p.params.onOpen(p);
            };
        
            // Close
            p.close = function () {
                if (!p.opened || p.inline) return;
                if (inPopover()) {
                    app.closeModal(p.popover);
                    return;
                }
                else {
                    app.closeModal(p.container);
                    return;
                }
            };
        
            // Destroy
            p.destroy = function () {
                p.close();
                if (p.params.input && p.input.length > 0) {
                    p.input.off('click focus', openOnInput);
                }
                $('html').off('click', closeOnHTMLClick);
            };
        
            if (p.inline) {
                p.open();
            }
            else {
                if (!p.initialized && p.params.value) p.setValue(p.params.value);
            }
        
            return p;
        };
        app.calendar = function (params) {
            return new Calendar(params);
        };
        

        /*======================================================
        ************   Notifications   ************
        ======================================================*/
        var _tempNotificationElement;
        app.addNotification = function (params) {
            if (!params) return;
            
            if (typeof params.media === 'undefined') params.media = app.params.notificationMedia;
            if (typeof params.title === 'undefined') params.title = app.params.notificationTitle;
            if (typeof params.subtitle === 'undefined') params.subtitle = app.params.notificationSubtitle;
            if (typeof params.closeIcon === 'undefined') params.closeIcon = app.params.notificationCloseIcon;
            if (typeof params.hold === 'undefined') params.hold = app.params.notificationHold;
            if (typeof params.closeOnClick === 'undefined') params.closeOnClick = app.params.notificationCloseOnClick;
            if (typeof params.button === 'undefined') params.button = app.params.notificationCloseButtonText && {
                text: app.params.notificationCloseButtonText,
                close: true
            };
        
            if (!_tempNotificationElement) _tempNotificationElement = document.createElement('div');
        
            params.material = app.params.material;
        
            var container = $('.notifications');
            if (container.length === 0) {
                $('body').append('<div class="notifications list-block' + (params.material ? '' : ' media-list') + '"><ul></ul></div>');
                container = $('.notifications');
            }
            var list = container.children('ul');
            
            var notificationTemplate = app.params.notificationTemplate || 
                '{{#if custom}}' +
                '<li>{{custom}}</li>' +
                '{{else}}' +
                '<li class="notification-item notification-hidden">' +
                    '<div class="item-content">' +
                        '{{#if material}}' +
                            '<div class="item-inner">' +
                                '<div class="item-title">{{js "this.message || this.title || this.subtitle"}}</div>' +
                                '{{#if ../button}}{{#button}}' +
                                '<div class="item-after">' +
                                    '<a href="#" class="button {{#if color}}color-{{color}}{{/if}} {{#js_compare "this.close !== false"}}close-notification{{/js_compare}}">{{text}}</a>' +
                                '</div>' +
                                '{{/button}}{{/if}}' +
                            '</div>' +
                        '{{else}}' +
                            '{{#if media}}' +
                            '<div class="item-media">{{media}}</div>' +
                            '{{/if}}' +
                            '<div class="item-inner">' +
                                '<div class="item-title-row">' +
                                    '{{#if title}}' +
                                    '<div class="item-title">{{title}}</div>' +
                                    '{{/if}}' +
                                    '{{#if closeIcon}}' +
                                    '<div class="item-after"><a href="#" class="close-notification"><span></span></a></div>' +
                                    '{{/if}}' +
                                '</div>' +
                                '{{#if subtitle}}' +
                                '<div class="item-subtitle">{{subtitle}}</div>' +
                                '{{/if}}' +
                                '{{#if message}}' +
                                '<div class="item-text">{{message}}</div>' +
                                '</div>' +
                            '{{/if}}' +
                        '{{/if}}' +
                    '</div>' +
                '</li>' +
                '{{/if}}';
            if (!app._compiledTemplates.notification) {
                app._compiledTemplates.notification = t7.compile(notificationTemplate);
            }
            _tempNotificationElement.innerHTML = app._compiledTemplates.notification(params);
        
            var item = $(_tempNotificationElement).children();
        
            item.on('click', function (e) {
                var close = false;
                var target = $(e.target);
                if (params.material && target.hasClass('button')) {
                    if (params.button && params.button.onClick) params.button.onClick.call(target[0], e, item[0]);
                }
                if (target.is('.close-notification') || $(e.target).parents('.close-notification').length > 0) {
                    close = true;
                }
                else {
                    if (params.onClick) params.onClick(e, item[0]);
                    if (params.closeOnClick) close = true;
                }
                if (close) app.closeNotification(item[0]);
            });
            if (params.onClose) {
                item.data('f7NotificationOnClose', function () {
                    params.onClose(item[0]);
                });
            }
            if (params.additionalClass) {
                item.addClass(params.additionalClass);
            }
            if (params.hold) {
                setTimeout(function () {
                    if (item.length > 0) app.closeNotification(item[0]);
                }, params.hold);
            }
        
            list[params.material ? 'append' : 'prepend'](item[0]);
            container.show();
        
            var itemHeight = item.outerHeight(), clientLeft;
            if (params.material) {
                container.transform('translate3d(0, '+itemHeight+'px, 0)');
                container.transition(0);
        
                clientLeft = item[0].clientLeft;
        
                container.transform('translate3d(0, 0, 0)');
                container.transition('');
            }
            else {
                item.css('marginTop', -itemHeight + 'px');
                item.transition(0);
        
                clientLeft = item[0].clientLeft;
        
                item.transition('');
                item.css('marginTop', '0px');
            }
        
            container.transform('translate3d(0, 0,0)');
            item.removeClass('notification-hidden');
        
            return item[0];
        };
        app.closeNotification = function (item) {
            item = $(item);
            if (item.length === 0) return;
            if (item.hasClass('notification-item-removing')) return;
            var container = $('.notifications');
        
            var itemHeight = item.outerHeight();
            item.css('height', itemHeight + 'px').transition(0).addClass('notification-item-removing');
            var clientLeft = item[0].clientLeft;
        
            item.css('height', '0px').transition('');
            if (item.data('f7NotificationOnClose')) item.data('f7NotificationOnClose')();
        
            if (container.find('.notification-item:not(.notification-item-removing)').length === 0) {
                container.transform('');
            }
        
            item.addClass('notification-hidden').transitionEnd(function () {
                item.remove();
                if (container.find('.notification-item').length === 0) {
                    container.hide();
                }
            });
        };

        /*===========================
        Compile Template7 Templates On App Init
        ===========================*/
        app.initTemplate7Templates = function () {
            if (!window.Template7) return;
            Template7.templates = Template7.templates || app.params.templates || {};
            Template7.data = Template7.data || app.params.template7Data || {};
            Template7.cache = Template7.cache || {};
        
            app.templates = Template7.templates;
            app.template7Data = Template7.data;
            app.template7Cache = Template7.cache;
        
            // Precompile templates on app init
            if (!app.params.precompileTemplates) return;
            $('script[type="text/template7"]').each(function () {
                var id = $(this).attr('id');
                if (!id) return;
                Template7.templates[id] = Template7.compile($(this).html());
            });
        };
        

        /*=======================================
        ************   Plugins API   ************
        =======================================*/
        var _plugins = [];
        app.initPlugins = function () {
            // Initialize plugins
            for (var plugin in app.plugins) {
                var p = app.plugins[plugin](app, app.params[plugin]);
                if (p) _plugins.push(p);
            }
        };
        // Plugin Hooks
        app.pluginHook = function (hook) {
            for (var i = 0; i < _plugins.length; i++) {
                if (_plugins[i].hooks && hook in _plugins[i].hooks) {
                    _plugins[i].hooks[hook](arguments[1], arguments[2], arguments[3], arguments[4], arguments[5]);
                }
            }
        };
        // Prevented by plugin
        app.pluginPrevent = function (action) {
            var prevent = false;
            for (var i = 0; i < _plugins.length; i++) {
                if (_plugins[i].prevents && action in _plugins[i].prevents) {
                    if (_plugins[i].prevents[action](arguments[1], arguments[2], arguments[3], arguments[4], arguments[5])) prevent = true;
                }
            }
            return prevent;
        };
        // Preprocess content by plugin
        app.pluginProcess = function (process, data) {
            var processed = data;
            for (var i = 0; i < _plugins.length; i++) {
                if (_plugins[i].preprocess && process in _plugins[i].preprocess) {
                    processed = _plugins[i].preprocess[process](data, arguments[2], arguments[3], arguments[4], arguments[5], arguments[6]);
                }
            }
            return processed;
        };
        
        

        /*======================================================
        ************   App Init   ************
        ======================================================*/
        app.init = function () {
            // Compile Template7 templates on app load
            if (app.initTemplate7Templates) app.initTemplate7Templates();
            
            // Init Plugins
            if (app.initPlugins) app.initPlugins();
            
            // Init Device
            if (app.getDeviceInfo) app.getDeviceInfo();
            
            // Init Click events
            if (app.initFastClicks && app.params.fastClicks) app.initFastClicks();
            if (app.initClickEvents) app.initClickEvents();
        
            // Init each page callbacks
            $('.page:not(.cached)').each(function () {
                app.initPageWithCallback(this);
            });
        
            // Init each navbar callbacks
            $('.navbar:not(.cached)').each(function () {
                app.initNavbarWithCallback(this); 
            });
            
            // Init resize events
            if (app.initResize) app.initResize();
        
            // Init push state
            if (app.initPushState && app.params.pushState) app.initPushState();
        
            // Init Live Swipeouts events
            if (app.initSwipeout && app.params.swipeout) app.initSwipeout();
        
            // Init Live Sortable events
            if (app.initSortable && app.params.sortable) app.initSortable();
        
            // Init Live Swipe Panels
            if (app.initSwipePanels && (app.params.swipePanel || app.params.swipePanelOnlyClose)) app.initSwipePanels();
            
            // Init Material Inputs
            if (app.params.material && app.initMaterialWatchInputs) app.initMaterialWatchInputs();
            
            // App Init callback
            if (app.params.onAppInit) app.params.onAppInit();
        
            // Plugin app init hook
            app.pluginHook('appInit');
        };
        if (app.params.init) app.init();
        

        //Return instance        
        return app;
    };
    

    /*===========================
    Dom7 Library
    ===========================*/
    var Dom7 = (function () {
        var Dom7 = function (arr) {
            var _this = this, i = 0;
            // Create array-like object
            for (i = 0; i < arr.length; i++) {
                _this[i] = arr[i];
            }
            _this.length = arr.length;
            // Return collection with methods
            return this;
        };
        var $ = function (selector, context) {
            var arr = [], i = 0;
            if (selector && !context) {
                if (selector instanceof Dom7) {
                    return selector;
                }
            }
            if (selector) {
                // String
                if (typeof selector === 'string') {
                    var els, tempParent, html;
                    selector = html = selector.trim();
                    if (html.indexOf('<') >= 0 && html.indexOf('>') >= 0) {
                        var toCreate = 'div';
                        if (html.indexOf('<li') === 0) toCreate = 'ul';
                        if (html.indexOf('<tr') === 0) toCreate = 'tbody';
                        if (html.indexOf('<td') === 0 || html.indexOf('<th') === 0) toCreate = 'tr';
                        if (html.indexOf('<tbody') === 0) toCreate = 'table';
                        if (html.indexOf('<option') === 0) toCreate = 'select';
                        tempParent = document.createElement(toCreate);
                        tempParent.innerHTML = html;
                        for (i = 0; i < tempParent.childNodes.length; i++) {
                            arr.push(tempParent.childNodes[i]);
                        }
                    }
                    else {
                        if (!context && selector[0] === '#' && !selector.match(/[ .<>:~]/)) {
                            // Pure ID selector
                            els = [document.getElementById(selector.split('#')[1])];
                        }
                        else {
                            // Other selectors
                            els = (context || document).querySelectorAll(selector);
                        }
                        for (i = 0; i < els.length; i++) {
                            if (els[i]) arr.push(els[i]);
                        }
                    }
                }
                // Node/element
                else if (selector.nodeType || selector === window || selector === document) {
                    arr.push(selector);
                }
                //Array of elements or instance of Dom
                else if (selector.length > 0 && selector[0].nodeType) {
                    for (i = 0; i < selector.length; i++) {
                        arr.push(selector[i]);
                    }
                }
            }
            return new Dom7(arr);
        };

        Dom7.prototype = {
            // Classes and attriutes
            addClass: function (className) {
                if (typeof className === 'undefined') {
                    return this;
                }
                var classes = className.split(' ');
                for (var i = 0; i < classes.length; i++) {
                    for (var j = 0; j < this.length; j++) {
                        if (typeof this[j].classList !== 'undefined') this[j].classList.add(classes[i]);
                    }
                }
                return this;
            },
            removeClass: function (className) {
                var classes = className.split(' ');
                for (var i = 0; i < classes.length; i++) {
                    for (var j = 0; j < this.length; j++) {
                        if (typeof this[j].classList !== 'undefined') this[j].classList.remove(classes[i]);
                    }
                }
                return this;
            },
            hasClass: function (className) {
                if (!this[0]) return false;
                else return this[0].classList.contains(className);
            },
            toggleClass: function (className) {
                var classes = className.split(' ');
                for (var i = 0; i < classes.length; i++) {
                    for (var j = 0; j < this.length; j++) {
                        if (typeof this[j].classList !== 'undefined') this[j].classList.toggle(classes[i]);
                    }
                }
                return this;
            },
            attr: function (attrs, value) {
                if (arguments.length === 1 && typeof attrs === 'string') {
                    // Get attr
                    if (this[0]) return this[0].getAttribute(attrs);
                    else return undefined;
                }
                else {
                    // Set attrs
                    for (var i = 0; i < this.length; i++) {
                        if (arguments.length === 2) {
                            // String
                            this[i].setAttribute(attrs, value);
                        }
                        else {
                            // Object
                            for (var attrName in attrs) {
                                this[i][attrName] = attrs[attrName];
                                this[i].setAttribute(attrName, attrs[attrName]);
                            }
                        }
                    }
                    return this;
                }
            },
            removeAttr: function (attr) {
                for (var i = 0; i < this.length; i++) {
                    this[i].removeAttribute(attr);
                }
                return this;
            },
            prop: function (props, value) {
                if (arguments.length === 1 && typeof props === 'string') {
                    // Get prop
                    if (this[0]) return this[0][props];
                    else return undefined;
                }
                else {
                    // Set props
                    for (var i = 0; i < this.length; i++) {
                        if (arguments.length === 2) {
                            // String
                            this[i][props] = value;
                        }
                        else {
                            // Object
                            for (var propName in props) {
                                this[i][propName] = props[propName];
                            }
                        }
                    }
                    return this;
                }
            },
            data: function (key, value) {
                if (typeof value === 'undefined') {
                    // Get value
                    if (this[0]) {
                        if (this[0].dom7ElementDataStorage && (key in this[0].dom7ElementDataStorage)) {
                            return this[0].dom7ElementDataStorage[key];
                        }
                        else {
                            var dataKey = this[0].getAttribute('data-' + key);    
                            if (dataKey) {
                                return dataKey;
                            }
                            else return undefined;
                        }
                    }
                    else return undefined;
                }
                else {
                    // Set value
                    for (var i = 0; i < this.length; i++) {
                        var el = this[i];
                        if (!el.dom7ElementDataStorage) el.dom7ElementDataStorage = {};
                        el.dom7ElementDataStorage[key] = value;
                    }
                    return this;
                }
            },
            removeData: function(key) {
                for (var i = 0; i < this.length; i++) {
                    var el = this[i];
                    if (el.dom7ElementDataStorage && el.dom7ElementDataStorage[key]) {
                        el.dom7ElementDataStorage[key] = null;
                        delete el.dom7ElementDataStorage[key];
                    }
                }
            },
            dataset: function () {
                var el = this[0];
                if (el) {
                    var dataset = {};
                    if (el.dataset) {
                        for (var dataKey in el.dataset) {
                            dataset[dataKey] = el.dataset[dataKey];
                        }
                    }
                    else {
                        for (var i = 0; i < el.attributes.length; i++) {
                            var attr = el.attributes[i];
                            if (attr.name.indexOf('data-') >= 0) {
                                dataset[$.toCamelCase(attr.name.split('data-')[1])] = attr.value;
                            }
                        }
                    }
                    for (var key in dataset) {
                        if (dataset[key] === 'false') dataset[key] = false;
                        else if (dataset[key] === 'true') dataset[key] = true;
                        else if (parseFloat(dataset[key]) === dataset[key] * 1) dataset[key] = dataset[key] * 1;
                    }
                    return dataset;
                }
                else return undefined;
            },
            val: function (value) {
                if (typeof value === 'undefined') {
                    if (this[0]) return this[0].value;
                    else return undefined;
                }
                else {
                    for (var i = 0; i < this.length; i++) {
                        this[i].value = value;
                    }
                    return this;
                }
            },
            // Transforms
            transform : function (transform) {
                for (var i = 0; i < this.length; i++) {
                    var elStyle = this[i].style;
                    elStyle.webkitTransform = elStyle.MsTransform = elStyle.msTransform = elStyle.MozTransform = elStyle.OTransform = elStyle.transform = transform;
                }
                return this;
            },
            transition: function (duration) {
                if (typeof duration !== 'string') {
                    duration = duration + 'ms';
                }
                for (var i = 0; i < this.length; i++) {
                    var elStyle = this[i].style;
                    elStyle.webkitTransitionDuration = elStyle.MsTransitionDuration = elStyle.msTransitionDuration = elStyle.MozTransitionDuration = elStyle.OTransitionDuration = elStyle.transitionDuration = duration;
                }
                return this;
            },
            //Events
            on: function (eventName, targetSelector, listener, capture) {
                function handleLiveEvent(e) {
                    var target = e.target;
                    if ($(target).is(targetSelector)) listener.call(target, e);
                    else {
                        var parents = $(target).parents();
                        for (var k = 0; k < parents.length; k++) {
                            if ($(parents[k]).is(targetSelector)) listener.call(parents[k], e);
                        }
                    }
                }
                var events = eventName.split(' ');
                var i, j;
                for (i = 0; i < this.length; i++) {
                    if (typeof targetSelector === 'function' || targetSelector === false) {
                        // Usual events
                        if (typeof targetSelector === 'function') {
                            listener = arguments[1];
                            capture = arguments[2] || false;
                        }
                        for (j = 0; j < events.length; j++) {
                            this[i].addEventListener(events[j], listener, capture);
                        }
                    }
                    else {
                        //Live events
                        for (j = 0; j < events.length; j++) {
                            if (!this[i].dom7LiveListeners) this[i].dom7LiveListeners = [];
                            this[i].dom7LiveListeners.push({listener: listener, liveListener: handleLiveEvent});
                            this[i].addEventListener(events[j], handleLiveEvent, capture);
                        }
                    }
                }
        
                return this;
            },
            off: function (eventName, targetSelector, listener, capture) {
                var events = eventName.split(' ');
                for (var i = 0; i < events.length; i++) {
                    for (var j = 0; j < this.length; j++) {
                        if (typeof targetSelector === 'function' || targetSelector === false) {
                            // Usual events
                            if (typeof targetSelector === 'function') {
                                listener = arguments[1];
                                capture = arguments[2] || false;
                            }
                            this[j].removeEventListener(events[i], listener, capture);
                        }
                        else {
                            // Live event
                            if (this[j].dom7LiveListeners) {
                                for (var k = 0; k < this[j].dom7LiveListeners.length; k++) {
                                    if (this[j].dom7LiveListeners[k].listener === listener) {
                                        this[j].removeEventListener(events[i], this[j].dom7LiveListeners[k].liveListener, capture);
                                    }
                                }
                            }
                        }
                    }
                }
                return this;
            },
            once: function (eventName, targetSelector, listener, capture) {
                var dom = this;
                if (typeof targetSelector === 'function') {
                    listener = arguments[1];
                    capture = arguments[2];
                    targetSelector = false;
                }
                function proxy(e) {
                    listener.call(e.target, e);
                    dom.off(eventName, targetSelector, proxy, capture);
                }
                return dom.on(eventName, targetSelector, proxy, capture);
            },
            trigger: function (eventName, eventData) {
                var events = eventName.split(' ');
                for (var i = 0; i < events.length; i++) {
                    for (var j = 0; j < this.length; j++) {
                        var evt;
                        try {
                            evt = new CustomEvent(events[i], {detail: eventData, bubbles: true, cancelable: true});
                        }
                        catch (e) {
                            evt = document.createEvent('Event');
                            evt.initEvent(events[i], true, true);
                            evt.detail = eventData;
                        }
                        this[j].dispatchEvent(evt);
                    }
                }
                return this;
            },
            transitionEnd: function (callback) {
                var events = ['webkitTransitionEnd', 'transitionend', 'oTransitionEnd', 'MSTransitionEnd', 'msTransitionEnd'],
                    i, j, dom = this;
                function fireCallBack(e) {
                    /*jshint validthis:true */
                    if (e.target !== this) return;
                    callback.call(this, e);
                    for (i = 0; i < events.length; i++) {
                        dom.off(events[i], fireCallBack);
                    }
                }
                if (callback) {
                    for (i = 0; i < events.length; i++) {
                        dom.on(events[i], fireCallBack);
                    }
                }
                return this;
            },
            animationEnd: function (callback) {
                var events = ['webkitAnimationEnd', 'OAnimationEnd', 'MSAnimationEnd', 'animationend'],
                    i, j, dom = this;
                function fireCallBack(e) {
                    callback(e);
                    for (i = 0; i < events.length; i++) {
                        dom.off(events[i], fireCallBack);
                    }
                }
                if (callback) {
                    for (i = 0; i < events.length; i++) {
                        dom.on(events[i], fireCallBack);
                    }
                }
                return this;
            },
            // Sizing/Styles
            width: function () {
                if (this[0] === window) {
                    return window.innerWidth;
                }
                else {
                    if (this.length > 0) {
                        return parseFloat(this.css('width'));
                    }
                    else {
                        return null;
                    }
                }
            },
            outerWidth: function (includeMargins) {
                if (this.length > 0) {
                    if (includeMargins) {
                        var styles = this.styles();
                        return this[0].offsetWidth + parseFloat(styles.getPropertyValue('margin-right')) + parseFloat(styles.getPropertyValue('margin-left'));    
                    }
                    else
                        return this[0].offsetWidth;
                }
                else return null;
            },
            height: function () {
                if (this[0] === window) {
                    return window.innerHeight;
                }
                else {
                    if (this.length > 0) {
                        return parseFloat(this.css('height'));
                    }
                    else {
                        return null;
                    }
                }
            },
            outerHeight: function (includeMargins) {
                if (this.length > 0) {
                    if (includeMargins) {
                        var styles = this.styles();
                        return this[0].offsetHeight + parseFloat(styles.getPropertyValue('margin-top')) + parseFloat(styles.getPropertyValue('margin-bottom'));    
                    }
                    else
                        return this[0].offsetHeight;
                }
                else return null;
            },
            offset: function () {
                if (this.length > 0) {
                    var el = this[0];
                    var box = el.getBoundingClientRect();
                    var body = document.body;
                    var clientTop  = el.clientTop  || body.clientTop  || 0;
                    var clientLeft = el.clientLeft || body.clientLeft || 0;
                    var scrollTop  = window.pageYOffset || el.scrollTop;
                    var scrollLeft = window.pageXOffset || el.scrollLeft;
                    return {
                        top: box.top  + scrollTop  - clientTop,
                        left: box.left + scrollLeft - clientLeft
                    };
                }
                else {
                    return null;
                }
            },
            hide: function () {
                for (var i = 0; i < this.length; i++) {
                    this[i].style.display = 'none';
                }
                return this;
            },
            show: function () {
                for (var i = 0; i < this.length; i++) {
                    this[i].style.display = 'block';
                }
                return this;
            },
            styles: function () {
                var i, styles;
                if (this[0]) return window.getComputedStyle(this[0], null);
                else return undefined;
            },
            css: function (props, value) {
                var i;
                if (arguments.length === 1) {
                    if (typeof props === 'string') {
                        if (this[0]) return window.getComputedStyle(this[0], null).getPropertyValue(props);
                    }
                    else {
                        for (i = 0; i < this.length; i++) {
                            for (var prop in props) {
                                this[i].style[prop] = props[prop];
                            }
                        }
                        return this;
                    }
                }
                if (arguments.length === 2 && typeof props === 'string') {
                    for (i = 0; i < this.length; i++) {
                        this[i].style[props] = value;
                    }
                    return this;
                }
                return this;
            },
        
            //Dom manipulation
            each: function (callback) {
                for (var i = 0; i < this.length; i++) {
                    callback.call(this[i], i, this[i]);
                }
                return this;
            },
            filter: function (callback) {
                var matchedItems = [];
                var dom = this;
                for (var i = 0; i < dom.length; i++) {
                    if (callback.call(dom[i], i, dom[i])) matchedItems.push(dom[i]);
                }
                return new Dom7(matchedItems);
            },
            html: function (html) {
                if (typeof html === 'undefined') {
                    return this[0] ? this[0].innerHTML : undefined;
                }
                else {
                    for (var i = 0; i < this.length; i++) {
                        this[i].innerHTML = html;
                    }
                    return this;
                }
            },
            text: function (text) {
                if (typeof text === 'undefined') {
                    if (this[0]) {
                        return this[0].textContent.trim();
                    }
                    else return null;
                }
                else {
                    for (var i = 0; i < this.length; i++) {
                        this[i].textContent = text;
                    }
                    return this;
                }
            },
            is: function (selector) {
                if (!this[0] || typeof selector === 'undefined') return false;
                var compareWith, i;
                if (typeof selector === 'string') {
                    var el = this[0];
                    if (el === document) return selector === document;
                    if (el === window) return selector === window;
        
                    if (el.matches) return el.matches(selector);
                    else if (el.webkitMatchesSelector) return el.webkitMatchesSelector(selector);
                    else if (el.mozMatchesSelector) return el.mozMatchesSelector(selector);
                    else if (el.msMatchesSelector) return el.msMatchesSelector(selector);
                    else {
                        compareWith = $(selector);
                        for (i = 0; i < compareWith.length; i++) {
                            if (compareWith[i] === this[0]) return true;
                        }
                        return false;
                    }
                }
                else if (selector === document) return this[0] === document;
                else if (selector === window) return this[0] === window;
                else {
                    if (selector.nodeType || selector instanceof Dom7) {
                        compareWith = selector.nodeType ? [selector] : selector;
                        for (i = 0; i < compareWith.length; i++) {
                            if (compareWith[i] === this[0]) return true;
                        }
                        return false;
                    }
                    return false;
                }
        
            },
            indexOf: function (el) {
                for (var i = 0; i < this.length; i++) {
                    if (this[i] === el) return i;
                }
            },
            index: function () {
                if (this[0]) {
                    var child = this[0];
                    var i = 0;
                    while ((child = child.previousSibling) !== null) {
                        if (child.nodeType === 1) i++;
                    }
                    return i;
                }
                else return undefined;
            },
            eq: function (index) {
                if (typeof index === 'undefined') return this;
                var length = this.length;
                var returnIndex;
                if (index > length - 1) {
                    return new Dom7([]);
                }
                if (index < 0) {
                    returnIndex = length + index;
                    if (returnIndex < 0) return new Dom7([]);
                    else return new Dom7([this[returnIndex]]);
                }
                return new Dom7([this[index]]);
            },
            append: function (newChild) {
                var i, j;
                for (i = 0; i < this.length; i++) {
                    if (typeof newChild === 'string') {
                        var tempDiv = document.createElement('div');
                        tempDiv.innerHTML = newChild;
                        while (tempDiv.firstChild) {
                            this[i].appendChild(tempDiv.firstChild);
                        }
                    }
                    else if (newChild instanceof Dom7) {
                        for (j = 0; j < newChild.length; j++) {
                            this[i].appendChild(newChild[j]);
                        }
                    }
                    else {
                        this[i].appendChild(newChild);
                    }
                }
                return this;
            },
            appendTo: function (parent) {
                $(parent).append(this);
                return this;
            },
            prepend: function (newChild) {
                var i, j;
                for (i = 0; i < this.length; i++) {
                    if (typeof newChild === 'string') {
                        var tempDiv = document.createElement('div');
                        tempDiv.innerHTML = newChild;
                        for (j = tempDiv.childNodes.length - 1; j >= 0; j--) {
                            this[i].insertBefore(tempDiv.childNodes[j], this[i].childNodes[0]);
                        }
                        // this[i].insertAdjacentHTML('afterbegin', newChild);
                    }
                    else if (newChild instanceof Dom7) {
                        for (j = 0; j < newChild.length; j++) {
                            this[i].insertBefore(newChild[j], this[i].childNodes[0]);
                        }
                    }
                    else {
                        this[i].insertBefore(newChild, this[i].childNodes[0]);
                    }
                }
                return this;
            },
            prependTo: function (parent) {
                $(parent).prepend(this);
                return this;
            },
            insertBefore: function (selector) {
                var before = $(selector);
                for (var i = 0; i < this.length; i++) {
                    if (before.length === 1) {
                        before[0].parentNode.insertBefore(this[i], before[0]);
                    }
                    else if (before.length > 1) {
                        for (var j = 0; j < before.length; j++) {
                            before[j].parentNode.insertBefore(this[i].cloneNode(true), before[j]);
                        }
                    }
                }
            },
            insertAfter: function (selector) {
                var after = $(selector);
                for (var i = 0; i < this.length; i++) {
                    if (after.length === 1) {
                        after[0].parentNode.insertBefore(this[i], after[0].nextSibling);
                    }
                    else if (after.length > 1) {
                        for (var j = 0; j < after.length; j++) {
                            after[j].parentNode.insertBefore(this[i].cloneNode(true), after[j].nextSibling);
                        }
                    }
                }
            },
            next: function (selector) {
                if (this.length > 0) {
                    if (selector) {
                        if (this[0].nextElementSibling && $(this[0].nextElementSibling).is(selector)) return new Dom7([this[0].nextElementSibling]);
                        else return new Dom7([]);
                    }
                    else {
                        if (this[0].nextElementSibling) return new Dom7([this[0].nextElementSibling]);
                        else return new Dom7([]);
                    }
                }
                else return new Dom7([]);
            },
            nextAll: function (selector) {
                var nextEls = [];
                var el = this[0];
                if (!el) return new Dom7([]);
                while (el.nextElementSibling) {
                    var next = el.nextElementSibling;
                    if (selector) {
                        if($(next).is(selector)) nextEls.push(next);
                    }
                    else nextEls.push(next);
                    el = next;
                }
                return new Dom7(nextEls);
            },
            prev: function (selector) {
                if (this.length > 0) {
                    if (selector) {
                        if (this[0].previousElementSibling && $(this[0].previousElementSibling).is(selector)) return new Dom7([this[0].previousElementSibling]);
                        else return new Dom7([]);
                    }
                    else {
                        if (this[0].previousElementSibling) return new Dom7([this[0].previousElementSibling]);
                        else return new Dom7([]);
                    }
                }
                else return new Dom7([]);
            },
            prevAll: function (selector) {
                var prevEls = [];
                var el = this[0];
                if (!el) return new Dom7([]);
                while (el.previousElementSibling) {
                    var prev = el.previousElementSibling;
                    if (selector) {
                        if($(prev).is(selector)) prevEls.push(prev);
                    }
                    else prevEls.push(prev);
                    el = prev;
                }
                return new Dom7(prevEls);
            },
            parent: function (selector) {
                var parents = [];
                for (var i = 0; i < this.length; i++) {
                    if (this[i].parentNode !== null) {
                        if (selector) {
                            if ($(this[i].parentNode).is(selector)) parents.push(this[i].parentNode);
                        }
                        else {
                           parents.push(this[i].parentNode);
                        }
                    }
                }
                return $($.unique(parents));
            },
            parents: function (selector) {
                var parents = [];
                for (var i = 0; i < this.length; i++) {
                    var parent = this[i].parentNode;
                    while (parent) {
                        if (selector) {
                            if ($(parent).is(selector)) parents.push(parent);
                        }
                        else {
                            parents.push(parent);
                        }
                        parent = parent.parentNode;
                    }
                }
                return $($.unique(parents));
            },
            closest: function (selector) {
                var closest = this;
                if (typeof selector === 'undefined') {
                    return new Dom7([]);
                }
                if (!closest.is(selector)) {
                    closest = closest.parents(selector).eq(0);
                }
                return closest;
            },
            find : function (selector) {
                var foundElements = [];
                for (var i = 0; i < this.length; i++) {
                    var found = this[i].querySelectorAll(selector);
                    for (var j = 0; j < found.length; j++) {
                        foundElements.push(found[j]);
                    }
                }
                return new Dom7(foundElements);
            },
            children: function (selector) {
                var children = [];
                for (var i = 0; i < this.length; i++) {
                    var childNodes = this[i].childNodes;
        
                    for (var j = 0; j < childNodes.length; j++) {
                        if (!selector) {
                            if (childNodes[j].nodeType === 1) children.push(childNodes[j]);
                        }
                        else {
                            if (childNodes[j].nodeType === 1 && $(childNodes[j]).is(selector)) children.push(childNodes[j]);
                        }
                    }
                }
                return new Dom7($.unique(children));
            },
            remove: function () {
                for (var i = 0; i < this.length; i++) {
                    if (this[i].parentNode) this[i].parentNode.removeChild(this[i]);
                }
                return this;
            },
            detach: function () {
                return this.remove();
            },
            add: function () {
                var dom = this;
                var i, j;
                for (i = 0; i < arguments.length; i++) {
                    var toAdd = $(arguments[i]);
                    for (j = 0; j < toAdd.length; j++) {
                        dom[dom.length] = toAdd[j];
                        dom.length++;
                    }
                }
                return dom;
            }
        };
        
        // Shortcuts
        (function () {
            var shortcuts = ('click blur focus focusin focusout keyup keydown keypress submit change mousedown mousemove mouseup mouseenter mouseleave mouseout mouseover touchstart touchend touchmove resize scroll').split(' ');
            var notTrigger = ('resize scroll').split(' ');
            function createMethod(name) {
                Dom7.prototype[name] = function (targetSelector, listener, capture) {
                    var i;
                    if (typeof targetSelector === 'undefined') {
                        for (i = 0; i < this.length; i++) {
                            if (notTrigger.indexOf(name) < 0) {
                                if (name in this[i]) this[i][name]();
                                else {
                                    $(this[i]).trigger(name);
                                }
                            }
                        }
                        return this;
                    }
                    else {
                        return this.on(name, targetSelector, listener, capture);
                    }
                };
            }
            for (var i = 0; i < shortcuts.length; i++) {
                createMethod(shortcuts[i]);
            }
        })();
        

        // Global Ajax Setup
        var globalAjaxOptions = {};
        $.ajaxSetup = function (options) {
            if (options.type) options.method = options.type;
            $.each(options, function (optionName, optionValue) {
                globalAjaxOptions[optionName]  = optionValue;
            });
        };
        
        // Ajax
        var _jsonpRequests = 0;
        $.ajax = function (options) {
            var defaults = {
                method: 'GET',
                data: false,
                async: true,
                cache: true,
                user: '',
                password: '',
                headers: {},
                xhrFields: {},
                statusCode: {},
                processData: true,
                dataType: 'text',
                contentType: 'application/x-www-form-urlencoded',
                timeout: 0
            };
            var callbacks = ['beforeSend', 'error', 'complete', 'success', 'statusCode'];
        
        
            //For jQuery guys
            if (options.type) options.method = options.type;
        
            // Merge global and defaults
            $.each(globalAjaxOptions, function (globalOptionName, globalOptionValue) {
                if (callbacks.indexOf(globalOptionName) < 0) defaults[globalOptionName] = globalOptionValue;
            });
        
            // Function to run XHR callbacks and events
            function fireAjaxCallback (eventName, eventData, callbackName) {
                var a = arguments;
                if (eventName) $(document).trigger(eventName, eventData);
                if (callbackName) {
                    // Global callback
                    if (callbackName in globalAjaxOptions) globalAjaxOptions[callbackName](a[3], a[4], a[5], a[6]);
                    // Options callback
                    if (options[callbackName]) options[callbackName](a[3], a[4], a[5], a[6]);
                }
            }
        
            // Merge options and defaults
            $.each(defaults, function (prop, defaultValue) {
                if (!(prop in options)) options[prop] = defaultValue;
            });
        
            // Default URL
            if (!options.url) {
                options.url = window.location.toString();
            }
            // Parameters Prefix
            var paramsPrefix = options.url.indexOf('?') >= 0 ? '&' : '?';
        
            // UC method
            var _method = options.method.toUpperCase();
            // Data to modify GET URL
            if ((_method === 'GET' || _method === 'HEAD' || _method === 'OPTIONS' || _method === 'DELETE') && options.data) {
                var stringData;
                if (typeof options.data === 'string') {
                    // Should be key=value string
                    if (options.data.indexOf('?') >= 0) stringData = options.data.split('?')[1];
                    else stringData = options.data;
                }
                else {
                    // Should be key=value object
                    stringData = $.serializeObject(options.data);
                }
                if (stringData.length) {
                    options.url += paramsPrefix + stringData;
                    if (paramsPrefix === '?') paramsPrefix = '&';
                }
            }
            // JSONP
            if (options.dataType === 'json' && options.url.indexOf('callback=') >= 0) {
        
                var callbackName = 'f7jsonp_' + Date.now() + (_jsonpRequests++);
                var abortTimeout;
                var callbackSplit = options.url.split('callback=');
                var requestUrl = callbackSplit[0] + 'callback=' + callbackName;
                if (callbackSplit[1].indexOf('&') >= 0) {
                    var addVars = callbackSplit[1].split('&').filter(function (el) { return el.indexOf('=') > 0; }).join('&');
                    if (addVars.length > 0) requestUrl += '&' + addVars;
                }
        
                // Create script
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script.onerror = function() {
                    clearTimeout(abortTimeout);
                    fireAjaxCallback(undefined, undefined, 'error', null, 'scripterror');
                };
                script.src = requestUrl;
        
                // Handler
                window[callbackName] = function (data) {
                    clearTimeout(abortTimeout);
                    fireAjaxCallback(undefined, undefined, 'success', data);
                    script.parentNode.removeChild(script);
                    script = null;
                    delete window[callbackName];
                };
                document.querySelector('head').appendChild(script);
        
                if (options.timeout > 0) {
                    abortTimeout = setTimeout(function () {
                        script.parentNode.removeChild(script);
                        script = null;
                        fireAjaxCallback(undefined, undefined, 'error', null, 'timeout');
                    }, options.timeout);
                }
        
                return;
            }
        
            // Cache for GET/HEAD requests
            if (_method === 'GET' || _method === 'HEAD' || _method === 'OPTIONS' || _method === 'DELETE') {
                if (options.cache === false) {
                    options.url += (paramsPrefix + '_nocache=' + Date.now());
                }
            }
        
            // Create XHR
            var xhr = new XMLHttpRequest();
        
            // Save Request URL
            xhr.requestUrl = options.url;
            xhr.requestParameters = options;
        
            // Open XHR
            xhr.open(_method, options.url, options.async, options.user, options.password);
        
            // Create POST Data
            var postData = null;
        
            if ((_method === 'POST' || _method === 'PUT' || _method === 'PATCH') && options.data) {
                if (options.processData) {
                    var postDataInstances = [ArrayBuffer, Blob, Document, FormData];
                    // Post Data
                    if (postDataInstances.indexOf(options.data.constructor) >= 0) {
                        postData = options.data;
                    }
                    else {
                        // POST Headers
                        var boundary = '---------------------------' + Date.now().toString(16);
        
                        if (options.contentType === 'multipart\/form-data') {
                            xhr.setRequestHeader('Content-Type', 'multipart\/form-data; boundary=' + boundary);
                        }
                        else {
                            xhr.setRequestHeader('Content-Type', options.contentType);
                        }
                        postData = '';
                        var _data = $.serializeObject(options.data);
                        if (options.contentType === 'multipart\/form-data') {
                            boundary = '---------------------------' + Date.now().toString(16);
                            _data = _data.split('&');
                            var _newData = [];
                            for (var i = 0; i < _data.length; i++) {
                                _newData.push('Content-Disposition: form-data; name="' + _data[i].split('=')[0] + '"\r\n\r\n' + _data[i].split('=')[1] + '\r\n');
                            }
                            postData = '--' + boundary + '\r\n' + _newData.join('--' + boundary + '\r\n') + '--' + boundary + '--\r\n';
                        }
                        else {
                            postData = options.contentType === 'application/x-www-form-urlencoded' ? _data : _data.replace(/&/g, '\r\n');
                        }
                    }
                }
                else {
                    postData = options.data;
                }
        
            }
        
            // Additional headers
            if (options.headers) {
                $.each(options.headers, function (headerName, headerCallback) {
                    xhr.setRequestHeader(headerName, headerCallback);
                });
            }
        
            // Check for crossDomain
            if (typeof options.crossDomain === 'undefined') {
                options.crossDomain = /^([\w-]+:)?\/\/([^\/]+)/.test(options.url) && RegExp.$2 !== window.location.host;
            }
        
            if (!options.crossDomain) {
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            }
        
            if (options.xhrFields) {
                $.each(options.xhrFields, function (fieldName, fieldValue) {
                    xhr[fieldName] = fieldValue;
                });
            }
        
            var xhrTimeout;
            // Handle XHR
            xhr.onload = function (e) {
                if (xhrTimeout) clearTimeout(xhrTimeout);
                if ((xhr.status >= 200 && xhr.status < 300) || xhr.status === 0) {
                    var responseData;
                    if (options.dataType === 'json') {
                        try {
                            responseData = JSON.parse(xhr.responseText);
                            fireAjaxCallback('ajaxSuccess', {xhr: xhr}, 'success', responseData, xhr.status, xhr);
                        }
                        catch (err) {
                            fireAjaxCallback('ajaxError', {xhr: xhr, parseerror: true}, 'error', xhr, 'parseerror');
                        }
                    }
                    else {
                        responseData = xhr.responseType === 'text' || xhr.responseType === '' ? xhr.responseText : xhr.response;
                        fireAjaxCallback('ajaxSuccess', {xhr: xhr}, 'success', responseData, xhr.status, xhr);
                    }
                }
                else {
                    fireAjaxCallback('ajaxError', {xhr: xhr}, 'error', xhr, xhr.status);
                }
                if (options.statusCode) {
                    if (globalAjaxOptions.statusCode && globalAjaxOptions.statusCode[xhr.status]) globalAjaxOptions.statusCode[xhr.status](xhr);
                    if (options.statusCode[xhr.status]) options.statusCode[xhr.status](xhr);
                }
                fireAjaxCallback('ajaxComplete', {xhr: xhr}, 'complete', xhr, xhr.status);
            };
        
            xhr.onerror = function (e) {
                if (xhrTimeout) clearTimeout(xhrTimeout);
                fireAjaxCallback('ajaxError', {xhr: xhr}, 'error', xhr, xhr.status);
            };
        
            // Ajax start callback
            fireAjaxCallback('ajaxStart', {xhr: xhr}, 'start', xhr);
            fireAjaxCallback(undefined, undefined, 'beforeSend', xhr);
        
        
            // Send XHR
            xhr.send(postData);
        
            // Timeout
            if (options.timeout > 0) {
                xhr.onabort = function () {
                    if (xhrTimeout) clearTimeout(xhrTimeout);
                };
                xhrTimeout = setTimeout(function () {
                    xhr.abort();
                    fireAjaxCallback('ajaxError', {xhr: xhr, timeout: true}, 'error', xhr, 'timeout');
                    fireAjaxCallback('ajaxComplete', {xhr: xhr, timeout: true}, 'complete', xhr, 'timeout');
                }, options.timeout);
            }
        
            // Return XHR object
            return xhr;
        };
        // Shrotcuts
        (function () {
            var methods = ('get post getJSON').split(' ');
            function createMethod(method) {
                $[method] = function (url, data, success) {
                    return $.ajax({
                        url: url,
                        method: method === 'post' ? 'POST' : 'GET',
                        data: typeof data === 'function' ? undefined : data,
                        success: typeof data === 'function' ? data : success,
                        dataType: method === 'getJSON' ? 'json' : undefined
                    });
                };
            }
            for (var i = 0; i < methods.length; i++) {
                createMethod(methods[i]);
            }
        })();
        

        // DOM Library Utilites
        $.parseUrlQuery = function (url) {
            var query = {}, i, params, param;
            if (url.indexOf('?') >= 0) url = url.split('?')[1];
            else return query;
            params = url.split('&');
            for (i = 0; i < params.length; i++) {
                param = params[i].split('=');
                query[param[0]] = param[1];
            }
            return query;
        };
        $.isArray = function (arr) {
            if (Object.prototype.toString.apply(arr) === '[object Array]') return true;
            else return false;
        };
        $.each = function (obj, callback) {
            if (typeof obj !== 'object') return;
            if (!callback) return;
            var i, prop;
            if ($.isArray(obj) || obj instanceof Dom7) {
                // Array
                for (i = 0; i < obj.length; i++) {
                    callback(i, obj[i]);
                }
            }
            else {
                // Object
                for (prop in obj) {
                    if (obj.hasOwnProperty(prop)) {
                        callback(prop, obj[prop]);
                    }
                }
            }
        };
        $.unique = function (arr) {
            var unique = [];
            for (var i = 0; i < arr.length; i++) {
                if (unique.indexOf(arr[i]) === -1) unique.push(arr[i]);
            }
            return unique;
        };
        $.serializeObject = $.param = function (obj, parents) {
            if (typeof obj === 'string') return obj;
            var resultArray = [];
            var separator = '&';
            parents = parents || [];
            var newParents;
            function var_name(name) {
                if (parents.length > 0) {
                    var _parents = '';
                    for (var j = 0; j < parents.length; j++) {
                        if (j === 0) _parents += parents[j];
                        else _parents += '[' + encodeURIComponent(parents[j]) + ']';
                    }
                    return _parents + '[' + encodeURIComponent(name) + ']';
                }
                else {
                    return encodeURIComponent(name);
                }
            }
            function var_value(value) {
                return encodeURIComponent(value);
            }
            for (var prop in obj) {
                if (obj.hasOwnProperty(prop)) {
                    var toPush;
                    if ($.isArray(obj[prop])) {
                        toPush = [];
                        for (var i = 0; i < obj[prop].length; i ++) {
                            if (!$.isArray(obj[prop][i]) && typeof obj[prop][i] === 'object') {
                                newParents = parents.slice();
                                newParents.push(prop);
                                newParents.push(i + '');
                                toPush.push($.serializeObject(obj[prop][i], newParents));
                            }
                            else {
                                toPush.push(var_name(prop) + '[]=' + var_value(obj[prop][i]));
                            }
                            
                        }
                        if (toPush.length > 0) resultArray.push(toPush.join(separator));
                    }
                    else if (typeof obj[prop] === 'object') {
                        // Object, convert to named array
                        newParents = parents.slice();
                        newParents.push(prop);
                        toPush = $.serializeObject(obj[prop], newParents);
                        if (toPush !== '') resultArray.push(toPush);
                    }
                    else if (typeof obj[prop] !== 'undefined' && obj[prop] !== '') {
                        // Should be string or plain value
                        resultArray.push(var_name(prop) + '=' + var_value(obj[prop]));
                    }
                }
            }
            return resultArray.join(separator);
        };
        $.toCamelCase = function (string) {
            return string.toLowerCase().replace(/-(.)/g, function(match, group1) {
                return group1.toUpperCase();
            });
        };
        $.dataset = function (el) {
            return $(el).dataset();
        };
        $.getTranslate = function (el, axis) {
            var matrix, curTransform, curStyle, transformMatrix;
        
            // automatic axis detection
            if (typeof axis === 'undefined') {
                axis = 'x';
            }
        
            curStyle = window.getComputedStyle(el, null);
            if (window.WebKitCSSMatrix) {
                curTransform = curStyle.transform || curStyle.webkitTransform;
                if (curTransform.split(',').length > 6) {
                    curTransform = curTransform.split(', ').map(function(a){
                        return a.replace(',','.');
                    }).join(', ');
                }
                // Some old versions of Webkit choke when 'none' is passed; pass
                // empty string instead in this case
                transformMatrix = new WebKitCSSMatrix(curTransform === 'none' ? '' : curTransform);
            }
            else {
                transformMatrix = curStyle.MozTransform || curStyle.OTransform || curStyle.MsTransform || curStyle.msTransform  || curStyle.transform || curStyle.getPropertyValue('transform').replace('translate(', 'matrix(1, 0, 0, 1,');
                matrix = transformMatrix.toString().split(',');
            }
        
            if (axis === 'x') {
                //Latest Chrome and webkits Fix
                if (window.WebKitCSSMatrix)
                    curTransform = transformMatrix.m41;
                //Crazy IE10 Matrix
                else if (matrix.length === 16)
                    curTransform = parseFloat(matrix[12]);
                //Normal Browsers
                else
                    curTransform = parseFloat(matrix[4]);
            }
            if (axis === 'y') {
                //Latest Chrome and webkits Fix
                if (window.WebKitCSSMatrix)
                    curTransform = transformMatrix.m42;
                //Crazy IE10 Matrix
                else if (matrix.length === 16)
                    curTransform = parseFloat(matrix[13]);
                //Normal Browsers
                else
                    curTransform = parseFloat(matrix[5]);
            }
            
            return curTransform || 0;
        };
        
        $.requestAnimationFrame = function (callback) {
            if (window.requestAnimationFrame) return window.requestAnimationFrame(callback);
            else if (window.webkitRequestAnimationFrame) return window.webkitRequestAnimationFrame(callback);
            else if (window.mozRequestAnimationFrame) return window.mozRequestAnimationFrame(callback);
            else {
                return window.setTimeout(callback, 1000 / 60);
            }
        };
        $.cancelAnimationFrame = function (id) {
            if (window.cancelAnimationFrame) return window.cancelAnimationFrame(id);
            else if (window.webkitCancelAnimationFrame) return window.webkitCancelAnimationFrame(id);
            else if (window.mozCancelAnimationFrame) return window.mozCancelAnimationFrame(id);
            else {
                return window.clearTimeout(id);
            }  
        };
        $.supportTouch = !!(('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch);
        
        // Link to prototype
        $.fn = Dom7.prototype;
        
        // Plugins
        $.fn.scrollTo = function (left, top, duration, easing, callback) {
            if (arguments.length === 4 && typeof easing === 'function') {
                callback = easing;
                easing = undefined;
            }
            return this.each(function () {
                var el = this;
                var currentTop, currentLeft, maxTop, maxLeft, newTop, newLeft, scrollTop, scrollLeft;
                var animateTop = top > 0 || top === 0;
                var animateLeft = left > 0 || left === 0;
                if (typeof easing === 'undefined') {
                    easing = 'swing';
                }
                if (animateTop) {
                    currentTop = el.scrollTop;
                    if (!duration) {
                        el.scrollTop = top;
                    }
                }
                if (animateLeft) {
                    currentLeft = el.scrollLeft;
                    if (!duration) {
                        el.scrollLeft = left;
                    }
                }
                if (!duration) return;
                if (animateTop) {
                    maxTop = el.scrollHeight - el.offsetHeight;
                    newTop = Math.max(Math.min(top, maxTop), 0);
                }
                if (animateLeft) {
                    maxLeft = el.scrollWidth - el.offsetWidth;
                    newLeft = Math.max(Math.min(left, maxLeft), 0);
                }
                var startTime = null;
                if (animateTop && newTop === currentTop) animateTop = false;
                if (animateLeft && newLeft === currentLeft) animateLeft = false;
                function render(time) {
                    if (time === undefined) {
                        time = new Date().getTime();
                    }
                    if (startTime === null) {
                        startTime = time;
                    }
                    var doneLeft, doneTop, done;
                    var progress = Math.max(Math.min((time - startTime) / duration, 1), 0);
                    var easeProgress = easing === 'linear' ? progress : (0.5 - Math.cos( progress * Math.PI ) / 2);
                    if (animateTop) scrollTop = currentTop + (easeProgress * (newTop - currentTop));
                    if (animateLeft) scrollLeft = currentLeft + (easeProgress * (newLeft - currentLeft));
                    if (animateTop && newTop > currentTop && scrollTop >= newTop)  {
                        el.scrollTop = newTop;
                        done = true;
                    }
                    if (animateTop && newTop < currentTop && scrollTop <= newTop)  {
                        el.scrollTop = newTop;
                        done = true;
                    }
        
                    if (animateLeft && newLeft > currentLeft && scrollLeft >= newLeft)  {
                        el.scrollLeft = newLeft;
                        done = true;
                    }
                    if (animateLeft && newLeft < currentLeft && scrollLeft <= newLeft)  {
                        el.scrollLeft = newLeft;
                        done = true;
                    }
        
                    if (done) {
                        if (callback) callback();
                        return;
                    }
                    if (animateTop) el.scrollTop = scrollTop;
                    if (animateLeft) el.scrollLeft = scrollLeft;
                    $.requestAnimationFrame(render);
                }
                $.requestAnimationFrame(render);
            });
        };
        $.fn.scrollTop = function (top, duration, easing, callback) {
            if (arguments.length === 3 && typeof easing === 'function') {
                callback = easing;
                easing = undefined;
            }
            var dom = this;
            if (typeof top === 'undefined') {
                if (dom.length > 0) return dom[0].scrollTop;
                else return null;
            }
            return dom.scrollTo(undefined, top, duration, easing, callback);
        };
        $.fn.scrollLeft = function (left, duration, easing, callback) {
            if (arguments.length === 3 && typeof easing === 'function') {
                callback = easing;
                easing = undefined;
            }
            var dom = this;
            if (typeof left === 'undefined') {
                if (dom.length > 0) return dom[0].scrollLeft;
                else return null;
            }
            return dom.scrollTo(left, undefined, duration, easing, callback);
        };

        return $;
    })();
    
    // Export Dom7 to Framework7
    Framework7.$ = Dom7;
    
    // Export to local scope
    var $ = Dom7;
    
    // Export to Window
    window.Dom7 = Dom7;
    

    /*===========================
    Features Support Detection
    ===========================*/
    Framework7.prototype.support = (function () {
        var support = {
            touch: !!(('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch)
        };
    
        // Export object
        return support;
    })();
    

    /*===========================
    Device/OS Detection
    ===========================*/
    Framework7.prototype.device = (function () {
        var device = {};
        var ua = navigator.userAgent;
        var $ = Dom7;
    
        var android = ua.match(/(Android);?[\s\/]+([\d.]+)?/);
        var ipad = ua.match(/(iPad).*OS\s([\d_]+)/);
        var ipod = ua.match(/(iPod)(.*OS\s([\d_]+))?/);
        var iphone = !ipad && ua.match(/(iPhone\sOS)\s([\d_]+)/);
    
        device.ios = device.android = device.iphone = device.ipad = device.androidChrome = false;
        
        // Android
        if (android) {
            device.os = 'android';
            device.osVersion = android[2];
            device.android = true;
            device.androidChrome = ua.toLowerCase().indexOf('chrome') >= 0;
        }
        if (ipad || iphone || ipod) {
            device.os = 'ios';
            device.ios = true;
        }
        // iOS
        if (iphone && !ipod) {
            device.osVersion = iphone[2].replace(/_/g, '.');
            device.iphone = true;
        }
        if (ipad) {
            device.osVersion = ipad[2].replace(/_/g, '.');
            device.ipad = true;
        }
        if (ipod) {
            device.osVersion = ipod[3] ? ipod[3].replace(/_/g, '.') : null;
            device.iphone = true;
        }
        // iOS 8+ changed UA
        if (device.ios && device.osVersion && ua.indexOf('Version/') >= 0) {
            if (device.osVersion.split('.')[0] === '10') {
                device.osVersion = ua.toLowerCase().split('version/')[1].split(' ')[0];
            }
        }
    
        // Webview
        device.webView = (iphone || ipad || ipod) && ua.match(/.*AppleWebKit(?!.*Safari)/i);
            
        // Minimal UI
        if (device.os && device.os === 'ios') {
            var osVersionArr = device.osVersion.split('.');
            device.minimalUi = !device.webView &&
                                (ipod || iphone) &&
                                (osVersionArr[0] * 1 === 7 ? osVersionArr[1] * 1 >= 1 : osVersionArr[0] * 1 > 7) &&
                                $('meta[name="viewport"]').length > 0 && $('meta[name="viewport"]').attr('content').indexOf('minimal-ui') >= 0;
        }
    
        // Check for status bar and fullscreen app mode
        var windowWidth = $(window).width();
        var windowHeight = $(window).height();
        device.statusBar = false;
        if (device.webView && (windowWidth * windowHeight === screen.width * screen.height)) {
            device.statusBar = true;
        }
        else {
            device.statusBar = false;
        }
    
        // Classes
        var classNames = [];
    
        // Pixel Ratio
        device.pixelRatio = window.devicePixelRatio || 1;
        classNames.push('pixel-ratio-' + Math.floor(device.pixelRatio));
        if (device.pixelRatio >= 2) {
            classNames.push('retina');
        }
    
        // OS classes
        if (device.os) {
            classNames.push(device.os, device.os + '-' + device.osVersion.split('.')[0], device.os + '-' + device.osVersion.replace(/\./g, '-'));
            if (device.os === 'ios') {
                var major = parseInt(device.osVersion.split('.')[0], 10);
                for (var i = major - 1; i >= 6; i--) {
                    classNames.push('ios-gt-' + i);
                }
            }
            
        }
        // Status bar classes
        if (device.statusBar) {
            classNames.push('with-statusbar-overlay');
        }
        else {
            $('html').removeClass('with-statusbar-overlay');
        }
    
        // Add html classes
        if (classNames.length > 0) $('html').addClass(classNames.join(' '));
    
        // Export object
        return device;
    })();
    

    /*===========================
    Plugins prototype
    ===========================*/
    Framework7.prototype.plugins = {};
    

    /*===========================
    Template7 Template engine
    ===========================*/
    window.Template7 = (function () {
        function isArray(arr) {
            return Object.prototype.toString.apply(arr) === '[object Array]';
        }
        function isObject(obj) {
            return obj instanceof Object;
        }
        function isFunction(func) {
            return typeof func === 'function';
        }
        var cache = {};
        function helperToSlices(string) {
            var helperParts = string.replace(/[{}#}]/g, '').split(' ');
            var slices = [];
            var shiftIndex, i, j;
            for (i = 0; i < helperParts.length; i++) {
                var part = helperParts[i];
                if (i === 0) slices.push(part);
                else {
                    if (part.indexOf('"') === 0) {
                        // Plain String
                        if (part.match(/"/g).length === 2) {
                            // One word string
                            slices.push(part);
                        }
                        else {
                            // Find closed Index
                            shiftIndex = 0;
                            for (j = i + 1; j < helperParts.length; j++) {
                                part += ' ' + helperParts[j];
                                if (helperParts[j].indexOf('"') >= 0) {
                                    shiftIndex = j;
                                    slices.push(part);
                                    break;
                                }
                            }
                            if (shiftIndex) i = shiftIndex;
                        }
                    }
                    else {
                        if (part.indexOf('=') > 0) {
                            // Hash
                            var hashParts = part.split('=');
                            var hashName = hashParts[0];
                            var hashContent = hashParts[1];
                            if (hashContent.match(/"/g).length !== 2) {
                                shiftIndex = 0;
                                for (j = i + 1; j < helperParts.length; j++) {
                                    hashContent += ' ' + helperParts[j];
                                    if (helperParts[j].indexOf('"') >= 0) {
                                        shiftIndex = j;
                                        break;
                                    }
                                }
                                if (shiftIndex) i = shiftIndex;
                            }
                            var hash = [hashName, hashContent.replace(/"/g,'')];
                            slices.push(hash);
                        }
                        else {
                            // Plain variable
                            slices.push(part);
                        }
                    }
                }
            }
            return slices;
        }
        function stringToBlocks(string) {
            var blocks = [], i, j, k;
            if (!string) return [];
            var _blocks = string.split(/({{[^{^}]*}})/);
            for (i = 0; i < _blocks.length; i++) {
                var block = _blocks[i];
                if (block === '') continue;
                if (block.indexOf('{{') < 0) {
                    blocks.push({
                        type: 'plain',
                        content: block
                    });
                }
                else {
                    if (block.indexOf('{/') >= 0) {
                        continue;
                    }
                    if (block.indexOf('{#') < 0 && block.indexOf(' ') < 0 && block.indexOf('else') < 0) {
                        // Simple variable
                        blocks.push({
                            type: 'variable',
                            contextName: block.replace(/[{}]/g, '')
                        });
                        continue;
                    }
                    // Helpers
                    var helperSlices = helperToSlices(block);
                    var helperName = helperSlices[0];
                    var isPartial = helperName === '>';
                    var helperContext = [];
                    var helperHash = {};
                    for (j = 1; j < helperSlices.length; j++) {
                        var slice = helperSlices[j];
                        if (isArray(slice)) {
                            // Hash
                            helperHash[slice[0]] = slice[1] === 'false' ? false : slice[1];
                        }
                        else {
                            helperContext.push(slice);
                        }
                    }
                    
                    if (block.indexOf('{#') >= 0) {
                        // Condition/Helper
                        var helperStartIndex = i;
                        var helperContent = '';
                        var elseContent = '';
                        var toSkip = 0;
                        var shiftIndex;
                        var foundClosed = false, foundElse = false, foundClosedElse = false, depth = 0;
                        for (j = i + 1; j < _blocks.length; j++) {
                            if (_blocks[j].indexOf('{{#') >= 0) {
                                depth ++;
                            }
                            if (_blocks[j].indexOf('{{/') >= 0) {
                                depth --;
                            }
                            if (_blocks[j].indexOf('{{#' + helperName) >= 0) {
                                helperContent += _blocks[j];
                                if (foundElse) elseContent += _blocks[j];
                                toSkip ++;
                            }
                            else if (_blocks[j].indexOf('{{/' + helperName) >= 0) {
                                if (toSkip > 0) {
                                    toSkip--;
                                    helperContent += _blocks[j];
                                    if (foundElse) elseContent += _blocks[j];
                                }
                                else {
                                    shiftIndex = j;
                                    foundClosed = true;
                                    break;
                                }
                            }
                            else if (_blocks[j].indexOf('else') >= 0 && depth === 0) {
                                foundElse = true;
                            }
                            else {
                                if (!foundElse) helperContent += _blocks[j];
                                if (foundElse) elseContent += _blocks[j];
                            }
    
                        }
                        if (foundClosed) {
                            if (shiftIndex) i = shiftIndex;
                            blocks.push({
                                type: 'helper',
                                helperName: helperName,
                                contextName: helperContext,
                                content: helperContent,
                                inverseContent: elseContent,
                                hash: helperHash
                            });
                        }
                    }
                    else if (block.indexOf(' ') > 0) {
                        if (isPartial) {
                            helperName = '_partial';
                            if (helperContext[0]) helperContext[0] = '"' + helperContext[0].replace(/"|'/g, '') + '"';
                        }
                        blocks.push({
                            type: 'helper',
                            helperName: helperName,
                            contextName: helperContext,
                            hash: helperHash
                        });
                    }
                }
            }
            return blocks;
        }
        var Template7 = function (template) {
            var t = this;
            t.template = template;
            
            function getCompileFn(block, depth) {
                if (block.content) return compile(block.content, depth);
                else return function () {return ''; };
            }
            function getCompileInverse(block, depth) {
                if (block.inverseContent) return compile(block.inverseContent, depth);
                else return function () {return ''; };
            }
            function getCompileVar(name, ctx) {
                var variable, parts, levelsUp = 0, initialCtx = ctx;
                if (name.indexOf('../') === 0) {
                    levelsUp = name.split('../').length - 1;
                    var newDepth = ctx.split('_')[1] - levelsUp;
                    ctx = 'ctx_' + (newDepth >= 1 ? newDepth : 1);
                    parts = name.split('../')[levelsUp].split('.');
                }
                else if (name.indexOf('@global') === 0) {
                    ctx = 'Template7.global';
                    parts = name.split('@global.')[1].split('.');
                }
                else if (name.indexOf('@root') === 0) {
                    ctx = 'root';
                    parts = name.split('@root.')[1].split('.');
                }
                else {
                    parts = name.split('.');
                }
                variable = ctx;
                for (var i = 0; i < parts.length; i++) {
                    var part = parts[i];
                    if (part.indexOf('@') === 0) {
                        if (i > 0) {
                            variable += '[(data && data.' + part.replace('@', '') + ')]';
                        }
                        else {
                            variable = '(data && data.' + name.replace('@', '') + ')';
                        }
                    }
                    else {
                        if (isFinite(part)) {
                            variable += '[' + part + ']';
                        }
                        else {
                            if (part.indexOf('this') === 0) {
                                variable = part.replace('this', ctx);
                            }
                            else {
                                variable += '.' + part;       
                            }
                        }
                    }
                }
    
                return variable;
            }
            function getCompiledArguments(contextArray, ctx) {
                var arr = [];
                for (var i = 0; i < contextArray.length; i++) {
                    if (contextArray[i].indexOf('"') === 0) arr.push(contextArray[i]);
                    else {
                        arr.push(getCompileVar(contextArray[i], ctx));
                    }
                }
    
                return arr.join(', ');
            }
            function compile(template, depth) {
                depth = depth || 1;
                template = template || t.template;
                if (typeof template !== 'string') {
                    throw new Error('Template7: Template must be a string');
                }
                var blocks = stringToBlocks(template);
                if (blocks.length === 0) {
                    return function () { return ''; };
                }
                var ctx = 'ctx_' + depth;
                var resultString = '';
                if (depth === 1) {
                    resultString += '(function (' + ctx + ', data, root) {\n';
                }
                else {
                    resultString += '(function (' + ctx + ', data) {\n';
                }
                if (depth === 1) {
                    resultString += 'function isArray(arr){return Object.prototype.toString.apply(arr) === \'[object Array]\';}\n';
                    resultString += 'function isFunction(func){return (typeof func === \'function\');}\n';
                    resultString += 'function c(val, ctx) {if (typeof val !== "undefined" && val !== null) {if (isFunction(val)) {return val.call(ctx);} else return val;} else return "";}\n';
                    resultString += 'root = root || ctx_1 || {};\n';
                }
                resultString += 'var r = \'\';\n';
                var i, j, context;
                for (i = 0; i < blocks.length; i++) {
                    var block = blocks[i];
                    // Plain block
                    if (block.type === 'plain') {
                        resultString += 'r +=\'' + (block.content).replace(/\r/g, '\\r').replace(/\n/g, '\\n').replace(/'/g, '\\' + '\'') + '\';';
                        continue;
                    }
                    var variable, compiledArguments;
                    // Variable block
                    if (block.type === 'variable') {
                        variable = getCompileVar(block.contextName, ctx);
                        resultString += 'r += c(' + variable + ', ' + ctx + ');';
                    }
                    // Helpers block
                    if (block.type === 'helper') {
                        if (block.helperName in t.helpers) {
                            compiledArguments = getCompiledArguments(block.contextName, ctx);
                            
                            resultString += 'r += (Template7.helpers.' + block.helperName + ').call(' + ctx + ', ' + (compiledArguments && (compiledArguments + ', ')) +'{hash:' + JSON.stringify(block.hash) + ', data: data || {}, fn: ' + getCompileFn(block, depth + 1) + ', inverse: ' + getCompileInverse(block, depth + 1) + ', root: root});';
                            
                        }
                        else {
                            if (block.contextName.length > 0) {
                                throw new Error('Template7: Missing helper: "' + block.helperName + '"');
                            }
                            else {
                                variable = getCompileVar(block.helperName, ctx);
                                resultString += 'if (' + variable + ') {';
                                resultString += 'if (isArray(' + variable + ')) {';
                                resultString += 'r += (Template7.helpers.each).call(' + ctx + ', ' + variable + ', {hash:' + JSON.stringify(block.hash) + ', data: data || {}, fn: ' + getCompileFn(block, depth+1) + ', inverse: ' + getCompileInverse(block, depth+1) + ', root: root});';
                                resultString += '}else {';
                                resultString += 'r += (Template7.helpers.with).call(' + ctx + ', ' + variable + ', {hash:' + JSON.stringify(block.hash) + ', data: data || {}, fn: ' + getCompileFn(block, depth+1) + ', inverse: ' + getCompileInverse(block, depth+1) + ', root: root});';
                                resultString += '}}';
                            }
                        }
                    }
                }
                resultString += '\nreturn r;})';
                return eval.call(window, resultString);
            }
            t.compile = function (template) {
                if (!t.compiled) {
                    t.compiled = compile(template);
                }
                return t.compiled;
            };
        };
        Template7.prototype = {
            options: {},
            partials: {},
            helpers: {
                '_partial' : function (partialName, options) {
                    var p = Template7.prototype.partials[partialName];
                    if (!p || (p && !p.template)) return '';
                    if (!p.compiled) {
                        p.compiled = t7.compile(p.template);
                    }
                    var ctx = this;
                    for (var hashName in options.hash) {
                        ctx[hashName] = options.hash[hashName];
                    }
                    return p.compiled(ctx, options.data, options.root);
                },
                'escape': function (context, options) {
                    if (typeof context !== 'string') {
                        throw new Error('Template7: Passed context to "escape" helper should be a string');
                    }
                    return context
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;');
                },
                'if': function (context, options) {
                    if (isFunction(context)) { context = context.call(this); }
                    if (context) {
                        return options.fn(this, options.data);
                    }
                    else {
                        return options.inverse(this, options.data);
                    }
                },
                'unless': function (context, options) {
                    if (isFunction(context)) { context = context.call(this); }
                    if (!context) {
                        return options.fn(this, options.data);
                    }
                    else {
                        return options.inverse(this, options.data);
                    }
                },
                'each': function (context, options) {
                    var ret = '', i = 0;
                    if (isFunction(context)) { context = context.call(this); }
                    if (isArray(context)) {
                        if (options.hash.reverse) {
                            context = context.reverse();
                        }
                        for (i = 0; i < context.length; i++) {
                            ret += options.fn(context[i], {first: i === 0, last: i === context.length - 1, index: i});
                        }
                        if (options.hash.reverse) {
                            context = context.reverse();
                        }
                    }
                    else {
                        for (var key in context) {
                            i++;
                            ret += options.fn(context[key], {key: key});
                        }
                    }
                    if (i > 0) return ret;
                    else return options.inverse(this);
                },
                'with': function (context, options) {
                    if (isFunction(context)) { context = context.call(this); }
                    return options.fn(context);
                },
                'join': function (context, options) {
                    if (isFunction(context)) { context = context.call(this); }
                    return context.join(options.hash.delimiter || options.hash.delimeter);
                },
                'js': function (expression, options) {
                    var func;
                    if (expression.indexOf('return')>=0) {
                        func = '(function(){'+expression+'})';
                    }
                    else {
                        func = '(function(){return ('+expression+')})';
                    }
                    return eval.call(this, func).call(this);
                },
                'js_compare': function (expression, options) {
                    var func;
                    if (expression.indexOf('return')>=0) {
                        func = '(function(){'+expression+'})';
                    }
                    else {
                        func = '(function(){return ('+expression+')})';
                    }
                    var condition = eval.call(this, func).call(this);
                    if (condition) {
                        return options.fn(this, options.data);
                    }
                    else {
                        return options.inverse(this, options.data);   
                    }
                }
            }
        };
        var t7 = function (template, data) {
            if (arguments.length === 2) {
                var instance = new Template7(template);
                var rendered = instance.compile()(data);
                instance = null;
                return (rendered);
            }
            else return new Template7(template);
        };
        t7.registerHelper = function (name, fn) {
            Template7.prototype.helpers[name] = fn;
        };
        t7.unregisterHelper = function (name) {
            Template7.prototype.helpers[name] = undefined;  
            delete Template7.prototype.helpers[name];
        };
        t7.registerPartial = function (name, template) {
            Template7.prototype.partials[name] = {template: template};
        };
        t7.unregisterPartial = function (name, template) {
            if (Template7.prototype.partials[name]) {
                Template7.prototype.partials[name] = undefined;
                delete Template7.prototype.partials[name];
            }
        };
        
        t7.compile = function (template, options) {
            var instance = new Template7(template, options);
            return instance.compile();
        };
        
        t7.options = Template7.prototype.options;
        t7.helpers = Template7.prototype.helpers;
        t7.partials = Template7.prototype.partials;
        return t7;
    })();

    /*===========================
    Swiper
    ===========================*/
    window.Swiper = function (container, params) {
        if (!(this instanceof Swiper)) return new Swiper(container, params);
        var defaults = {
            direction: 'horizontal',
            touchEventsTarget: 'container',
            initialSlide: 0,
            speed: 300,
            // autoplay
            autoplay: false,
            autoplayDisableOnInteraction: true,
            autoplayStopOnLast: false,
            // To support iOS's swipe-to-go-back gesture (when being used in-app, with UIWebView).
            iOSEdgeSwipeDetection: false,
            iOSEdgeSwipeThreshold: 20,
            // Free mode
            freeMode: false,
            freeModeMomentum: true,
            freeModeMomentumRatio: 1,
            freeModeMomentumBounce: true,
            freeModeMomentumBounceRatio: 1,
            freeModeSticky: false,
            freeModeMinimumVelocity: 0.02,
            // Autoheight
            autoHeight: false,
            // Set wrapper width
            setWrapperSize: false,
            // Virtual Translate
            virtualTranslate: false,
            // Effects
            effect: 'slide', // 'slide' or 'fade' or 'cube' or 'coverflow' or 'flip'
            coverflow: {
                rotate: 50,
                stretch: 0,
                depth: 100,
                modifier: 1,
                slideShadows : true
            },
            flip: {
                slideShadows : true,
                limitRotation: true
            },
            cube: {
                slideShadows: true,
                shadow: true,
                shadowOffset: 20,
                shadowScale: 0.94
            },
            fade: {
                crossFade: false
            },
            // Parallax
            parallax: false,
            // Scrollbar
            scrollbar: null,
            scrollbarHide: true,
            scrollbarDraggable: false,
            scrollbarSnapOnRelease: false,
            // Keyboard Mousewheel
            keyboardControl: false,
            mousewheelControl: false,
            mousewheelReleaseOnEdges: false,
            mousewheelInvert: false,
            mousewheelForceToAxis: false,
            mousewheelSensitivity: 1,
            // Hash Navigation
            hashnav: false,
            // Breakpoints
            breakpoints: undefined,
            // Slides grid
            spaceBetween: 0,
            slidesPerView: 1,
            slidesPerColumn: 1,
            slidesPerColumnFill: 'column',
            slidesPerGroup: 1,
            centeredSlides: false,
            slidesOffsetBefore: 0, // in px
            slidesOffsetAfter: 0, // in px
            // Round length
            roundLengths: false,
            // Touches
            touchRatio: 1,
            touchAngle: 45,
            simulateTouch: true,
            shortSwipes: true,
            longSwipes: true,
            longSwipesRatio: 0.5,
            longSwipesMs: 300,
            followFinger: true,
            onlyExternal: false,
            threshold: 0,
            touchMoveStopPropagation: true,
            // Unique Navigation Elements
            uniqueNavElements: true,
            // Pagination
            pagination: null,
            paginationElement: 'span',
            paginationClickable: false,
            paginationHide: false,
            paginationBulletRender: null,
            paginationProgressRender: null,
            paginationFractionRender: null,
            paginationCustomRender: null,
            paginationType: 'bullets', // 'bullets' or 'progress' or 'fraction' or 'custom'
            // Resistance
            resistance: true,
            resistanceRatio: 0.85,
            // Next/prev buttons
            nextButton: null,
            prevButton: null,
            // Progress
            watchSlidesProgress: false,
            watchSlidesVisibility: false,
            // Cursor
            grabCursor: false,
            // Clicks
            preventClicks: true,
            preventClicksPropagation: true,
            slideToClickedSlide: false,
            // Lazy Loading
            lazyLoading: false,
            lazyLoadingInPrevNext: false,
            lazyLoadingInPrevNextAmount: 1,
            lazyLoadingOnTransitionStart: false,
            // Images
            preloadImages: true,
            updateOnImagesReady: true,
            // loop
            loop: false,
            loopAdditionalSlides: 0,
            loopedSlides: null,
            // Control
            control: undefined,
            controlInverse: false,
            controlBy: 'slide', //or 'container'
            // Swiping/no swiping
            allowSwipeToPrev: true,
            allowSwipeToNext: true,
            swipeHandler: null, //'.swipe-handler',
            noSwiping: true,
            noSwipingClass: 'swiper-no-swiping',
            // NS
            slideClass: 'swiper-slide',
            slideActiveClass: 'swiper-slide-active',
            slideVisibleClass: 'swiper-slide-visible',
            slideDuplicateClass: 'swiper-slide-duplicate',
            slideNextClass: 'swiper-slide-next',
            slidePrevClass: 'swiper-slide-prev',
            wrapperClass: 'swiper-wrapper',
            bulletClass: 'swiper-pagination-bullet',
            bulletActiveClass: 'swiper-pagination-bullet-active',
            buttonDisabledClass: 'swiper-button-disabled',
            paginationCurrentClass: 'swiper-pagination-current',
            paginationTotalClass: 'swiper-pagination-total',
            paginationHiddenClass: 'swiper-pagination-hidden',
            paginationProgressbarClass: 'swiper-pagination-progressbar',
            // Observer
            observer: false,
            observeParents: false,
            // Accessibility
            a11y: false,
            prevSlideMessage: 'Previous slide',
            nextSlideMessage: 'Next slide',
            firstSlideMessage: 'This is the first slide',
            lastSlideMessage: 'This is the last slide',
            paginationBulletMessage: 'Go to slide {{index}}',
            // Callbacks
            runCallbacksOnInit: true
            /*
            Callbacks:
            onInit: function (swiper)
            onDestroy: function (swiper)
            onClick: function (swiper, e)
            onTap: function (swiper, e)
            onDoubleTap: function (swiper, e)
            onSliderMove: function (swiper, e)
            onSlideChangeStart: function (swiper)
            onSlideChangeEnd: function (swiper)
            onTransitionStart: function (swiper)
            onTransitionEnd: function (swiper)
            onImagesReady: function (swiper)
            onProgress: function (swiper, progress)
            onTouchStart: function (swiper, e)
            onTouchMove: function (swiper, e)
            onTouchMoveOpposite: function (swiper, e)
            onTouchEnd: function (swiper, e)
            onReachBeginning: function (swiper)
            onReachEnd: function (swiper)
            onSetTransition: function (swiper, duration)
            onSetTranslate: function (swiper, translate)
            onAutoplayStart: function (swiper)
            onAutoplayStop: function (swiper),
            onLazyImageLoad: function (swiper, slide, image)
            onLazyImageReady: function (swiper, slide, image)
            */
        
        };
        var initialVirtualTranslate = params && params.virtualTranslate;
        
        params = params || {};
        var originalParams = {};
        for (var param in params) {
            if (typeof params[param] === 'object' && params[param] !== null && !(params[param].nodeType || params[param] === window || params[param] === document || (typeof Dom7 !== 'undefined' && params[param] instanceof Dom7) || (typeof jQuery !== 'undefined' && params[param] instanceof jQuery))) {
                originalParams[param] = {};
                for (var deepParam in params[param]) {
                    originalParams[param][deepParam] = params[param][deepParam];
                }
            }
            else {
                originalParams[param] = params[param];
            }
        }
        for (var def in defaults) {
            if (typeof params[def] === 'undefined') {
                params[def] = defaults[def];
            }
            else if (typeof params[def] === 'object') {
                for (var deepDef in defaults[def]) {
                    if (typeof params[def][deepDef] === 'undefined') {
                        params[def][deepDef] = defaults[def][deepDef];
                    }
                }
            }
        }
        
        // Swiper
        var s = this;
        
        // Params
        s.params = params;
        s.originalParams = originalParams;
        
        // Classname
        s.classNames = [];
        /*=========================
          Dom Library and plugins
          ===========================*/
        if (typeof $ !== 'undefined' && typeof Dom7 !== 'undefined'){
            $ = Dom7;
        }
        if (typeof $ === 'undefined') {
            if (typeof Dom7 === 'undefined') {
                $ = window.Dom7 || window.Zepto || window.jQuery;
            }
            else {
                $ = Dom7;
            }
            if (!$) return;
        }
        // Export it to Swiper instance
        s.$ = $;
        
        /*=========================
          Breakpoints
          ===========================*/
        s.currentBreakpoint = undefined;
        s.getActiveBreakpoint = function () {
            //Get breakpoint for window width
            if (!s.params.breakpoints) return false;
            var breakpoint = false;
            var points = [], point;
            for ( point in s.params.breakpoints ) {
                if (s.params.breakpoints.hasOwnProperty(point)) {
                    points.push(point);
                }
            }
            points.sort(function (a, b) {
                return parseInt(a, 10) > parseInt(b, 10);
            });
            for (var i = 0; i < points.length; i++) {
                point = points[i];
                if (point >= window.innerWidth && !breakpoint) {
                    breakpoint = point;
                }
            }
            return breakpoint || 'max';
        };
        s.setBreakpoint = function () {
            //Set breakpoint for window width and update parameters
            var breakpoint = s.getActiveBreakpoint();
            if (breakpoint && s.currentBreakpoint !== breakpoint) {
                var breakPointsParams = breakpoint in s.params.breakpoints ? s.params.breakpoints[breakpoint] : s.originalParams;
                var needsReLoop = s.params.loop && (breakPointsParams.slidesPerView !== s.params.slidesPerView);
                for ( var param in breakPointsParams ) {
                    s.params[param] = breakPointsParams[param];
                }
                s.currentBreakpoint = breakpoint;
                if(needsReLoop && s.destroyLoop) {
                    s.reLoop(true);
                }
            }
        };
        // Set breakpoint on load
        if (s.params.breakpoints) {
            s.setBreakpoint();
        }
        
        /*=========================
          Preparation - Define Container, Wrapper and Pagination
          ===========================*/
        s.container = $(container);
        if (s.container.length === 0) return;
        if (s.container.length > 1) {
            var swipers = [];
            s.container.each(function () {
                var container = this;
                swipers.push(new Swiper(this, params));
            });
            return swipers;
        }
        
        // Save instance in container HTML Element and in data
        s.container[0].swiper = s;
        s.container.data('swiper', s);
        
        s.classNames.push('swiper-container-' + s.params.direction);
        
        if (s.params.freeMode) {
            s.classNames.push('swiper-container-free-mode');
        }
        if (!s.support.flexbox) {
            s.classNames.push('swiper-container-no-flexbox');
            s.params.slidesPerColumn = 1;
        }
        if (s.params.autoHeight) {
            s.classNames.push('swiper-container-autoheight');
        }
        // Enable slides progress when required
        if (s.params.parallax || s.params.watchSlidesVisibility) {
            s.params.watchSlidesProgress = true;
        }
        // Coverflow / 3D
        if (['cube', 'coverflow', 'flip'].indexOf(s.params.effect) >= 0) {
            if (s.support.transforms3d) {
                s.params.watchSlidesProgress = true;
                s.classNames.push('swiper-container-3d');
            }
            else {
                s.params.effect = 'slide';
            }
        }
        if (s.params.effect !== 'slide') {
            s.classNames.push('swiper-container-' + s.params.effect);
        }
        if (s.params.effect === 'cube') {
            s.params.resistanceRatio = 0;
            s.params.slidesPerView = 1;
            s.params.slidesPerColumn = 1;
            s.params.slidesPerGroup = 1;
            s.params.centeredSlides = false;
            s.params.spaceBetween = 0;
            s.params.virtualTranslate = true;
            s.params.setWrapperSize = false;
        }
        if (s.params.effect === 'fade' || s.params.effect === 'flip') {
            s.params.slidesPerView = 1;
            s.params.slidesPerColumn = 1;
            s.params.slidesPerGroup = 1;
            s.params.watchSlidesProgress = true;
            s.params.spaceBetween = 0;
            s.params.setWrapperSize = false;
            if (typeof initialVirtualTranslate === 'undefined') {
                s.params.virtualTranslate = true;
            }
        }
        
        // Grab Cursor
        if (s.params.grabCursor && s.support.touch) {
            s.params.grabCursor = false;
        }
        
        // Wrapper
        s.wrapper = s.container.children('.' + s.params.wrapperClass);
        
        // Pagination
        if (s.params.pagination) {
            s.paginationContainer = $(s.params.pagination);
            if (s.params.uniqueNavElements && typeof s.params.pagination === 'string' && s.paginationContainer.length > 1 && s.container.find(s.params.pagination).length === 1) {
                s.paginationContainer = s.container.find(s.params.pagination);
            }
        
            if (s.params.paginationType === 'bullets' && s.params.paginationClickable) {
                s.paginationContainer.addClass('swiper-pagination-clickable');
            }
            else {
                s.params.paginationClickable = false;
            }
            s.paginationContainer.addClass('swiper-pagination-' + s.params.paginationType);
        }
        // Next/Prev Buttons
        if (s.params.nextButton || s.params.prevButton) {
            if (s.params.nextButton) {
                s.nextButton = $(s.params.nextButton);
                if (s.params.uniqueNavElements && typeof s.params.nextButton === 'string' && s.nextButton.length > 1 && s.container.find(s.params.nextButton).length === 1) {
                    s.nextButton = s.container.find(s.params.nextButton);
                }
            }
            if (s.params.prevButton) {
                s.prevButton = $(s.params.prevButton);
                if (s.params.uniqueNavElements && typeof s.params.prevButton === 'string' && s.prevButton.length > 1 && s.container.find(s.params.prevButton).length === 1) {
                    s.prevButton = s.container.find(s.params.prevButton);
                }
            }
        }
        
        // Is Horizontal
        s.isHorizontal = function () {
            return s.params.direction === 'horizontal';
        };
        // s.isH = isH;
        
        // RTL
        s.rtl = s.isHorizontal() && (s.container[0].dir.toLowerCase() === 'rtl' || s.container.css('direction') === 'rtl');
        if (s.rtl) {
            s.classNames.push('swiper-container-rtl');
        }
        
        // Wrong RTL support
        if (s.rtl) {
            s.wrongRTL = s.wrapper.css('display') === '-webkit-box';
        }
        
        // Columns
        if (s.params.slidesPerColumn > 1) {
            s.classNames.push('swiper-container-multirow');
        }
        
        // Check for Android
        if (s.device.android) {
            s.classNames.push('swiper-container-android');
        }
        
        // Add classes
        s.container.addClass(s.classNames.join(' '));
        
        // Translate
        s.translate = 0;
        
        // Progress
        s.progress = 0;
        
        // Velocity
        s.velocity = 0;
        
        /*=========================
          Locks, unlocks
          ===========================*/
        s.lockSwipeToNext = function () {
            s.params.allowSwipeToNext = false;
        };
        s.lockSwipeToPrev = function () {
            s.params.allowSwipeToPrev = false;
        };
        s.lockSwipes = function () {
            s.params.allowSwipeToNext = s.params.allowSwipeToPrev = false;
        };
        s.unlockSwipeToNext = function () {
            s.params.allowSwipeToNext = true;
        };
        s.unlockSwipeToPrev = function () {
            s.params.allowSwipeToPrev = true;
        };
        s.unlockSwipes = function () {
            s.params.allowSwipeToNext = s.params.allowSwipeToPrev = true;
        };
        
        /*=========================
          Round helper
          ===========================*/
        function round(a) {
            return Math.floor(a);
        }
        /*=========================
          Set grab cursor
          ===========================*/
        if (s.params.grabCursor) {
            s.container[0].style.cursor = 'move';
            s.container[0].style.cursor = '-webkit-grab';
            s.container[0].style.cursor = '-moz-grab';
            s.container[0].style.cursor = 'grab';
        }
        /*=========================
          Update on Images Ready
          ===========================*/
        s.imagesToLoad = [];
        s.imagesLoaded = 0;
        
        s.loadImage = function (imgElement, src, srcset, checkForComplete, callback) {
            var image;
            function onReady () {
                if (callback) callback();
            }
            if (!imgElement.complete || !checkForComplete) {
                if (src) {
                    image = new window.Image();
                    image.onload = onReady;
                    image.onerror = onReady;
                    if (srcset) {
                        image.srcset = srcset;
                    }
                    if (src) {
                        image.src = src;
                    }
                } else {
                    onReady();
                }
        
            } else {//image already loaded...
                onReady();
            }
        };
        s.preloadImages = function () {
            s.imagesToLoad = s.container.find('img');
            function _onReady() {
                if (typeof s === 'undefined' || s === null) return;
                if (s.imagesLoaded !== undefined) s.imagesLoaded++;
                if (s.imagesLoaded === s.imagesToLoad.length) {
                    if (s.params.updateOnImagesReady) s.update();
                    s.emit('onImagesReady', s);
                }
            }
            for (var i = 0; i < s.imagesToLoad.length; i++) {
                s.loadImage(s.imagesToLoad[i], (s.imagesToLoad[i].currentSrc || s.imagesToLoad[i].getAttribute('src')), (s.imagesToLoad[i].srcset || s.imagesToLoad[i].getAttribute('srcset')), true, _onReady);
            }
        };
        
        /*=========================
          Autoplay
          ===========================*/
        s.autoplayTimeoutId = undefined;
        s.autoplaying = false;
        s.autoplayPaused = false;
        function autoplay() {
            s.autoplayTimeoutId = setTimeout(function () {
                if (s.params.loop) {
                    s.fixLoop();
                    s._slideNext();
                    s.emit('onAutoplay', s);
                }
                else {
                    if (!s.isEnd) {
                        s._slideNext();
                        s.emit('onAutoplay', s);
                    }
                    else {
                        if (!params.autoplayStopOnLast) {
                            s._slideTo(0);
                            s.emit('onAutoplay', s);
                        }
                        else {
                            s.stopAutoplay();
                        }
                    }
                }
            }, s.params.autoplay);
        }
        s.startAutoplay = function () {
            if (typeof s.autoplayTimeoutId !== 'undefined') return false;
            if (!s.params.autoplay) return false;
            if (s.autoplaying) return false;
            s.autoplaying = true;
            s.emit('onAutoplayStart', s);
            autoplay();
        };
        s.stopAutoplay = function (internal) {
            if (!s.autoplayTimeoutId) return;
            if (s.autoplayTimeoutId) clearTimeout(s.autoplayTimeoutId);
            s.autoplaying = false;
            s.autoplayTimeoutId = undefined;
            s.emit('onAutoplayStop', s);
        };
        s.pauseAutoplay = function (speed) {
            if (s.autoplayPaused) return;
            if (s.autoplayTimeoutId) clearTimeout(s.autoplayTimeoutId);
            s.autoplayPaused = true;
            if (speed === 0) {
                s.autoplayPaused = false;
                autoplay();
            }
            else {
                s.wrapper.transitionEnd(function () {
                    if (!s) return;
                    s.autoplayPaused = false;
                    if (!s.autoplaying) {
                        s.stopAutoplay();
                    }
                    else {
                        autoplay();
                    }
                });
            }
        };
        /*=========================
          Min/Max Translate
          ===========================*/
        s.minTranslate = function () {
            return (-s.snapGrid[0]);
        };
        s.maxTranslate = function () {
            return (-s.snapGrid[s.snapGrid.length - 1]);
        };
        /*=========================
          Slider/slides sizes
          ===========================*/
        s.updateAutoHeight = function () {
            // Update Height
            var slide = s.slides.eq(s.activeIndex)[0];
            if (typeof slide !== 'undefined') {
                var newHeight = slide.offsetHeight;
                if (newHeight) s.wrapper.css('height', newHeight + 'px');
            }
        };
        s.updateContainerSize = function () {
            var width, height;
            if (typeof s.params.width !== 'undefined') {
                width = s.params.width;
            }
            else {
                width = s.container[0].clientWidth;
            }
            if (typeof s.params.height !== 'undefined') {
                height = s.params.height;
            }
            else {
                height = s.container[0].clientHeight;
            }
            if (width === 0 && s.isHorizontal() || height === 0 && !s.isHorizontal()) {
                return;
            }
        
            //Subtract paddings
            width = width - parseInt(s.container.css('padding-left'), 10) - parseInt(s.container.css('padding-right'), 10);
            height = height - parseInt(s.container.css('padding-top'), 10) - parseInt(s.container.css('padding-bottom'), 10);
        
            // Store values
            s.width = width;
            s.height = height;
            s.size = s.isHorizontal() ? s.width : s.height;
        };
        
        s.updateSlidesSize = function () {
            s.slides = s.wrapper.children('.' + s.params.slideClass);
            s.snapGrid = [];
            s.slidesGrid = [];
            s.slidesSizesGrid = [];
        
            var spaceBetween = s.params.spaceBetween,
                slidePosition = -s.params.slidesOffsetBefore,
                i,
                prevSlideSize = 0,
                index = 0;
            if (typeof s.size === 'undefined') return;
            if (typeof spaceBetween === 'string' && spaceBetween.indexOf('%') >= 0) {
                spaceBetween = parseFloat(spaceBetween.replace('%', '')) / 100 * s.size;
            }
        
            s.virtualSize = -spaceBetween;
            // reset margins
            if (s.rtl) s.slides.css({marginLeft: '', marginTop: ''});
            else s.slides.css({marginRight: '', marginBottom: ''});
        
            var slidesNumberEvenToRows;
            if (s.params.slidesPerColumn > 1) {
                if (Math.floor(s.slides.length / s.params.slidesPerColumn) === s.slides.length / s.params.slidesPerColumn) {
                    slidesNumberEvenToRows = s.slides.length;
                }
                else {
                    slidesNumberEvenToRows = Math.ceil(s.slides.length / s.params.slidesPerColumn) * s.params.slidesPerColumn;
                }
                if (s.params.slidesPerView !== 'auto' && s.params.slidesPerColumnFill === 'row') {
                    slidesNumberEvenToRows = Math.max(slidesNumberEvenToRows, s.params.slidesPerView * s.params.slidesPerColumn);
                }
            }
        
            // Calc slides
            var slideSize;
            var slidesPerColumn = s.params.slidesPerColumn;
            var slidesPerRow = slidesNumberEvenToRows / slidesPerColumn;
            var numFullColumns = slidesPerRow - (s.params.slidesPerColumn * slidesPerRow - s.slides.length);
            for (i = 0; i < s.slides.length; i++) {
                slideSize = 0;
                var slide = s.slides.eq(i);
                if (s.params.slidesPerColumn > 1) {
                    // Set slides order
                    var newSlideOrderIndex;
                    var column, row;
                    if (s.params.slidesPerColumnFill === 'column') {
                        column = Math.floor(i / slidesPerColumn);
                        row = i - column * slidesPerColumn;
                        if (column > numFullColumns || (column === numFullColumns && row === slidesPerColumn-1)) {
                            if (++row >= slidesPerColumn) {
                                row = 0;
                                column++;
                            }
                        }
                        newSlideOrderIndex = column + row * slidesNumberEvenToRows / slidesPerColumn;
                        slide
                            .css({
                                '-webkit-box-ordinal-group': newSlideOrderIndex,
                                '-moz-box-ordinal-group': newSlideOrderIndex,
                                '-ms-flex-order': newSlideOrderIndex,
                                '-webkit-order': newSlideOrderIndex,
                                'order': newSlideOrderIndex
                            });
                    }
                    else {
                        row = Math.floor(i / slidesPerRow);
                        column = i - row * slidesPerRow;
                    }
                    slide
                        .css({
                            'margin-top': (row !== 0 && s.params.spaceBetween) && (s.params.spaceBetween + 'px')
                        })
                        .attr('data-swiper-column', column)
                        .attr('data-swiper-row', row);
        
                }
                if (slide.css('display') === 'none') continue;
                if (s.params.slidesPerView === 'auto') {
                    slideSize = s.isHorizontal() ? slide.outerWidth(true) : slide.outerHeight(true);
                    if (s.params.roundLengths) slideSize = round(slideSize);
                }
                else {
                    slideSize = (s.size - (s.params.slidesPerView - 1) * spaceBetween) / s.params.slidesPerView;
                    if (s.params.roundLengths) slideSize = round(slideSize);
        
                    if (s.isHorizontal()) {
                        s.slides[i].style.width = slideSize + 'px';
                    }
                    else {
                        s.slides[i].style.height = slideSize + 'px';
                    }
                }
                s.slides[i].swiperSlideSize = slideSize;
                s.slidesSizesGrid.push(slideSize);
        
        
                if (s.params.centeredSlides) {
                    slidePosition = slidePosition + slideSize / 2 + prevSlideSize / 2 + spaceBetween;
                    if (i === 0) slidePosition = slidePosition - s.size / 2 - spaceBetween;
                    if (Math.abs(slidePosition) < 1 / 1000) slidePosition = 0;
                    if ((index) % s.params.slidesPerGroup === 0) s.snapGrid.push(slidePosition);
                    s.slidesGrid.push(slidePosition);
                }
                else {
                    if ((index) % s.params.slidesPerGroup === 0) s.snapGrid.push(slidePosition);
                    s.slidesGrid.push(slidePosition);
                    slidePosition = slidePosition + slideSize + spaceBetween;
                }
        
                s.virtualSize += slideSize + spaceBetween;
        
                prevSlideSize = slideSize;
        
                index ++;
            }
            s.virtualSize = Math.max(s.virtualSize, s.size) + s.params.slidesOffsetAfter;
            var newSlidesGrid;
        
            if (
                s.rtl && s.wrongRTL && (s.params.effect === 'slide' || s.params.effect === 'coverflow')) {
                s.wrapper.css({width: s.virtualSize + s.params.spaceBetween + 'px'});
            }
            if (!s.support.flexbox || s.params.setWrapperSize) {
                if (s.isHorizontal()) s.wrapper.css({width: s.virtualSize + s.params.spaceBetween + 'px'});
                else s.wrapper.css({height: s.virtualSize + s.params.spaceBetween + 'px'});
            }
        
            if (s.params.slidesPerColumn > 1) {
                s.virtualSize = (slideSize + s.params.spaceBetween) * slidesNumberEvenToRows;
                s.virtualSize = Math.ceil(s.virtualSize / s.params.slidesPerColumn) - s.params.spaceBetween;
                s.wrapper.css({width: s.virtualSize + s.params.spaceBetween + 'px'});
                if (s.params.centeredSlides) {
                    newSlidesGrid = [];
                    for (i = 0; i < s.snapGrid.length; i++) {
                        if (s.snapGrid[i] < s.virtualSize + s.snapGrid[0]) newSlidesGrid.push(s.snapGrid[i]);
                    }
                    s.snapGrid = newSlidesGrid;
                }
            }
        
            // Remove last grid elements depending on width
            if (!s.params.centeredSlides) {
                newSlidesGrid = [];
                for (i = 0; i < s.snapGrid.length; i++) {
                    if (s.snapGrid[i] <= s.virtualSize - s.size) {
                        newSlidesGrid.push(s.snapGrid[i]);
                    }
                }
                s.snapGrid = newSlidesGrid;
                if (Math.floor(s.virtualSize - s.size) - Math.floor(s.snapGrid[s.snapGrid.length - 1]) > 1) {
                    s.snapGrid.push(s.virtualSize - s.size);
                }
            }
            if (s.snapGrid.length === 0) s.snapGrid = [0];
        
            if (s.params.spaceBetween !== 0) {
                if (s.isHorizontal()) {
                    if (s.rtl) s.slides.css({marginLeft: spaceBetween + 'px'});
                    else s.slides.css({marginRight: spaceBetween + 'px'});
                }
                else s.slides.css({marginBottom: spaceBetween + 'px'});
            }
            if (s.params.watchSlidesProgress) {
                s.updateSlidesOffset();
            }
        };
        s.updateSlidesOffset = function () {
            for (var i = 0; i < s.slides.length; i++) {
                s.slides[i].swiperSlideOffset = s.isHorizontal() ? s.slides[i].offsetLeft : s.slides[i].offsetTop;
            }
        };
        
        /*=========================
          Slider/slides progress
          ===========================*/
        s.updateSlidesProgress = function (translate) {
            if (typeof translate === 'undefined') {
                translate = s.translate || 0;
            }
            if (s.slides.length === 0) return;
            if (typeof s.slides[0].swiperSlideOffset === 'undefined') s.updateSlidesOffset();
        
            var offsetCenter = -translate;
            if (s.rtl) offsetCenter = translate;
        
            // Visible Slides
            s.slides.removeClass(s.params.slideVisibleClass);
            for (var i = 0; i < s.slides.length; i++) {
                var slide = s.slides[i];
                var slideProgress = (offsetCenter - slide.swiperSlideOffset) / (slide.swiperSlideSize + s.params.spaceBetween);
                if (s.params.watchSlidesVisibility) {
                    var slideBefore = -(offsetCenter - slide.swiperSlideOffset);
                    var slideAfter = slideBefore + s.slidesSizesGrid[i];
                    var isVisible =
                        (slideBefore >= 0 && slideBefore < s.size) ||
                        (slideAfter > 0 && slideAfter <= s.size) ||
                        (slideBefore <= 0 && slideAfter >= s.size);
                    if (isVisible) {
                        s.slides.eq(i).addClass(s.params.slideVisibleClass);
                    }
                }
                slide.progress = s.rtl ? -slideProgress : slideProgress;
            }
        };
        s.updateProgress = function (translate) {
            if (typeof translate === 'undefined') {
                translate = s.translate || 0;
            }
            var translatesDiff = s.maxTranslate() - s.minTranslate();
            var wasBeginning = s.isBeginning;
            var wasEnd = s.isEnd;
            if (translatesDiff === 0) {
                s.progress = 0;
                s.isBeginning = s.isEnd = true;
            }
            else {
                s.progress = (translate - s.minTranslate()) / (translatesDiff);
                s.isBeginning = s.progress <= 0;
                s.isEnd = s.progress >= 1;
            }
            if (s.isBeginning && !wasBeginning) s.emit('onReachBeginning', s);
            if (s.isEnd && !wasEnd) s.emit('onReachEnd', s);
        
            if (s.params.watchSlidesProgress) s.updateSlidesProgress(translate);
            s.emit('onProgress', s, s.progress);
        };
        s.updateActiveIndex = function () {
            var translate = s.rtl ? s.translate : -s.translate;
            var newActiveIndex, i, snapIndex;
            for (i = 0; i < s.slidesGrid.length; i ++) {
                if (typeof s.slidesGrid[i + 1] !== 'undefined') {
                    if (translate >= s.slidesGrid[i] && translate < s.slidesGrid[i + 1] - (s.slidesGrid[i + 1] - s.slidesGrid[i]) / 2) {
                        newActiveIndex = i;
                    }
                    else if (translate >= s.slidesGrid[i] && translate < s.slidesGrid[i + 1]) {
                        newActiveIndex = i + 1;
                    }
                }
                else {
                    if (translate >= s.slidesGrid[i]) {
                        newActiveIndex = i;
                    }
                }
            }
            // Normalize slideIndex
            if (newActiveIndex < 0 || typeof newActiveIndex === 'undefined') newActiveIndex = 0;
            // for (i = 0; i < s.slidesGrid.length; i++) {
                // if (- translate >= s.slidesGrid[i]) {
                    // newActiveIndex = i;
                // }
            // }
            snapIndex = Math.floor(newActiveIndex / s.params.slidesPerGroup);
            if (snapIndex >= s.snapGrid.length) snapIndex = s.snapGrid.length - 1;
        
            if (newActiveIndex === s.activeIndex) {
                return;
            }
            s.snapIndex = snapIndex;
            s.previousIndex = s.activeIndex;
            s.activeIndex = newActiveIndex;
            s.updateClasses();
        };
        
        /*=========================
          Classes
          ===========================*/
        s.updateClasses = function () {
            s.slides.removeClass(s.params.slideActiveClass + ' ' + s.params.slideNextClass + ' ' + s.params.slidePrevClass);
            var activeSlide = s.slides.eq(s.activeIndex);
            // Active classes
            activeSlide.addClass(s.params.slideActiveClass);
            // Next Slide
            var nextSlide = activeSlide.next('.' + s.params.slideClass).addClass(s.params.slideNextClass);
            if (s.params.loop && nextSlide.length === 0) {
                s.slides.eq(0).addClass(s.params.slideNextClass);
            }
            // Prev Slide
            var prevSlide = activeSlide.prev('.' + s.params.slideClass).addClass(s.params.slidePrevClass);
            if (s.params.loop && prevSlide.length === 0) {
                s.slides.eq(-1).addClass(s.params.slidePrevClass);
            }
        
            // Pagination
            if (s.paginationContainer && s.paginationContainer.length > 0) {
                // Current/Total
                var current,
                    total = s.params.loop ? Math.ceil((s.slides.length - s.loopedSlides * 2) / s.params.slidesPerGroup) : s.snapGrid.length;
                if (s.params.loop) {
                    current = Math.ceil((s.activeIndex - s.loopedSlides)/s.params.slidesPerGroup);
                    if (current > s.slides.length - 1 - s.loopedSlides * 2) {
                        current = current - (s.slides.length - s.loopedSlides * 2);
                    }
                    if (current > total - 1) current = current - total;
                    if (current < 0 && s.params.paginationType !== 'bullets') current = total + current;
                }
                else {
                    if (typeof s.snapIndex !== 'undefined') {
                        current = s.snapIndex;
                    }
                    else {
                        current = s.activeIndex || 0;
                    }
                }
                // Types
                if (s.params.paginationType === 'bullets' && s.bullets && s.bullets.length > 0) {
                    s.bullets.removeClass(s.params.bulletActiveClass);
                    if (s.paginationContainer.length > 1) {
                        s.bullets.each(function () {
                            if ($(this).index() === current) $(this).addClass(s.params.bulletActiveClass);
                        });
                    }
                    else {
                        s.bullets.eq(current).addClass(s.params.bulletActiveClass);
                    }
                }
                if (s.params.paginationType === 'fraction') {
                    s.paginationContainer.find('.' + s.params.paginationCurrentClass).text(current + 1);
                    s.paginationContainer.find('.' + s.params.paginationTotalClass).text(total);
                }
                if (s.params.paginationType === 'progress') {
                    var scale = (current + 1) / total,
                        scaleX = scale,
                        scaleY = 1;
                    if (!s.isHorizontal()) {
                        scaleY = scale;
                        scaleX = 1;
                    }
                    s.paginationContainer.find('.' + s.params.paginationProgressbarClass).transform('translate3d(0,0,0) scaleX(' + scaleX + ') scaleY(' + scaleY + ')').transition(s.params.speed);
                }
                if (s.params.paginationType === 'custom' && s.params.paginationCustomRender) {
                    s.paginationContainer.html(s.params.paginationCustomRender(s, current + 1, total));
                    s.emit('onPaginationRendered', s, s.paginationContainer[0]);
                }
            }
        
            // Next/active buttons
            if (!s.params.loop) {
                if (s.params.prevButton && s.prevButton && s.prevButton.length > 0) {
                    if (s.isBeginning) {
                        s.prevButton.addClass(s.params.buttonDisabledClass);
                        if (s.params.a11y && s.a11y) s.a11y.disable(s.prevButton);
                    }
                    else {
                        s.prevButton.removeClass(s.params.buttonDisabledClass);
                        if (s.params.a11y && s.a11y) s.a11y.enable(s.prevButton);
                    }
                }
                if (s.params.nextButton && s.nextButton && s.nextButton.length > 0) {
                    if (s.isEnd) {
                        s.nextButton.addClass(s.params.buttonDisabledClass);
                        if (s.params.a11y && s.a11y) s.a11y.disable(s.nextButton);
                    }
                    else {
                        s.nextButton.removeClass(s.params.buttonDisabledClass);
                        if (s.params.a11y && s.a11y) s.a11y.enable(s.nextButton);
                    }
                }
            }
        };
        
        /*=========================
          Pagination
          ===========================*/
        s.updatePagination = function () {
            if (!s.params.pagination) return;
            if (s.paginationContainer && s.paginationContainer.length > 0) {
                var paginationHTML = '';
                if (s.params.paginationType === 'bullets') {
                    var numberOfBullets = s.params.loop ? Math.ceil((s.slides.length - s.loopedSlides * 2) / s.params.slidesPerGroup) : s.snapGrid.length;
                    for (var i = 0; i < numberOfBullets; i++) {
                        if (s.params.paginationBulletRender) {
                            paginationHTML += s.params.paginationBulletRender(i, s.params.bulletClass);
                        }
                        else {
                            paginationHTML += '<' + s.params.paginationElement+' class="' + s.params.bulletClass + '"></' + s.params.paginationElement + '>';
                        }
                    }
                    s.paginationContainer.html(paginationHTML);
                    s.bullets = s.paginationContainer.find('.' + s.params.bulletClass);
                    if (s.params.paginationClickable && s.params.a11y && s.a11y) {
                        s.a11y.initPagination();
                    }
                }
                if (s.params.paginationType === 'fraction') {
                    if (s.params.paginationFractionRender) {
                        paginationHTML = s.params.paginationFractionRender(s, s.params.paginationCurrentClass, s.params.paginationTotalClass);
                    }
                    else {
                        paginationHTML =
                            '<span class="' + s.params.paginationCurrentClass + '"></span>' +
                            ' / ' +
                            '<span class="' + s.params.paginationTotalClass+'"></span>';
                    }
                    s.paginationContainer.html(paginationHTML);
                }
                if (s.params.paginationType === 'progress') {
                    if (s.params.paginationProgressRender) {
                        paginationHTML = s.params.paginationProgressRender(s, s.params.paginationProgressbarClass);
                    }
                    else {
                        paginationHTML = '<span class="' + s.params.paginationProgressbarClass + '"></span>';
                    }
                    s.paginationContainer.html(paginationHTML);
                }
                if (s.params.paginationType !== 'custom') {
                    s.emit('onPaginationRendered', s, s.paginationContainer[0]);
                }
            }
        };
        /*=========================
          Common update method
          ===========================*/
        s.update = function (updateTranslate) {
            s.updateContainerSize();
            s.updateSlidesSize();
            s.updateProgress();
            s.updatePagination();
            s.updateClasses();
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.set();
            }
            function forceSetTranslate() {
                newTranslate = Math.min(Math.max(s.translate, s.maxTranslate()), s.minTranslate());
                s.setWrapperTranslate(newTranslate);
                s.updateActiveIndex();
                s.updateClasses();
            }
            if (updateTranslate) {
                var translated, newTranslate;
                if (s.controller && s.controller.spline) {
                    s.controller.spline = undefined;
                }
                if (s.params.freeMode) {
                    forceSetTranslate();
                    if (s.params.autoHeight) {
                        s.updateAutoHeight();
                    }
                }
                else {
                    if ((s.params.slidesPerView === 'auto' || s.params.slidesPerView > 1) && s.isEnd && !s.params.centeredSlides) {
                        translated = s.slideTo(s.slides.length - 1, 0, false, true);
                    }
                    else {
                        translated = s.slideTo(s.activeIndex, 0, false, true);
                    }
                    if (!translated) {
                        forceSetTranslate();
                    }
                }
            }
            else if (s.params.autoHeight) {
                s.updateAutoHeight();
            }
        };
        
        /*=========================
          Resize Handler
          ===========================*/
        s.onResize = function (forceUpdatePagination) {
            //Breakpoints
            if (s.params.breakpoints) {
                s.setBreakpoint();
            }
        
            // Disable locks on resize
            var allowSwipeToPrev = s.params.allowSwipeToPrev;
            var allowSwipeToNext = s.params.allowSwipeToNext;
            s.params.allowSwipeToPrev = s.params.allowSwipeToNext = true;
        
            s.updateContainerSize();
            s.updateSlidesSize();
            if (s.params.slidesPerView === 'auto' || s.params.freeMode || forceUpdatePagination) s.updatePagination();
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.set();
            }
            if (s.controller && s.controller.spline) {
                s.controller.spline = undefined;
            }
            var slideChangedBySlideTo = false;
            if (s.params.freeMode) {
                var newTranslate = Math.min(Math.max(s.translate, s.maxTranslate()), s.minTranslate());
                s.setWrapperTranslate(newTranslate);
                s.updateActiveIndex();
                s.updateClasses();
        
                if (s.params.autoHeight) {
                    s.updateAutoHeight();
                }
            }
            else {
                s.updateClasses();
                if ((s.params.slidesPerView === 'auto' || s.params.slidesPerView > 1) && s.isEnd && !s.params.centeredSlides) {
                    slideChangedBySlideTo = s.slideTo(s.slides.length - 1, 0, false, true);
                }
                else {
                    slideChangedBySlideTo = s.slideTo(s.activeIndex, 0, false, true);
                }
            }
            if (s.params.lazyLoading && !slideChangedBySlideTo && s.lazy) {
                s.lazy.load();
            }
            // Return locks after resize
            s.params.allowSwipeToPrev = allowSwipeToPrev;
            s.params.allowSwipeToNext = allowSwipeToNext;
        };
        
        /*=========================
          Events
          ===========================*/
        
        //Define Touch Events
        var desktopEvents = ['mousedown', 'mousemove', 'mouseup'];
        if (window.navigator.pointerEnabled) desktopEvents = ['pointerdown', 'pointermove', 'pointerup'];
        else if (window.navigator.msPointerEnabled) desktopEvents = ['MSPointerDown', 'MSPointerMove', 'MSPointerUp'];
        s.touchEvents = {
            start : s.support.touch || !s.params.simulateTouch  ? 'touchstart' : desktopEvents[0],
            move : s.support.touch || !s.params.simulateTouch ? 'touchmove' : desktopEvents[1],
            end : s.support.touch || !s.params.simulateTouch ? 'touchend' : desktopEvents[2]
        };
        
        
        // WP8 Touch Events Fix
        if (window.navigator.pointerEnabled || window.navigator.msPointerEnabled) {
            (s.params.touchEventsTarget === 'container' ? s.container : s.wrapper).addClass('swiper-wp8-' + s.params.direction);
        }
        
        // Attach/detach events
        s.initEvents = function (detach) {
            var actionDom = detach ? 'off' : 'on';
            var action = detach ? 'removeEventListener' : 'addEventListener';
            var touchEventsTarget = s.params.touchEventsTarget === 'container' ? s.container[0] : s.wrapper[0];
            var target = s.support.touch ? touchEventsTarget : document;
        
            var moveCapture = s.params.nested ? true : false;
        
            //Touch Events
            if (s.browser.ie) {
                touchEventsTarget[action](s.touchEvents.start, s.onTouchStart, false);
                target[action](s.touchEvents.move, s.onTouchMove, moveCapture);
                target[action](s.touchEvents.end, s.onTouchEnd, false);
            }
            else {
                if (s.support.touch) {
                    touchEventsTarget[action](s.touchEvents.start, s.onTouchStart, false);
                    touchEventsTarget[action](s.touchEvents.move, s.onTouchMove, moveCapture);
                    touchEventsTarget[action](s.touchEvents.end, s.onTouchEnd, false);
                }
                if (params.simulateTouch && !s.device.ios && !s.device.android) {
                    touchEventsTarget[action]('mousedown', s.onTouchStart, false);
                    document[action]('mousemove', s.onTouchMove, moveCapture);
                    document[action]('mouseup', s.onTouchEnd, false);
                }
            }
            window[action]('resize', s.onResize);
        
            // Next, Prev, Index
            if (s.params.nextButton && s.nextButton && s.nextButton.length > 0) {
                s.nextButton[actionDom]('click', s.onClickNext);
                if (s.params.a11y && s.a11y) s.nextButton[actionDom]('keydown', s.a11y.onEnterKey);
            }
            if (s.params.prevButton && s.prevButton && s.prevButton.length > 0) {
                s.prevButton[actionDom]('click', s.onClickPrev);
                if (s.params.a11y && s.a11y) s.prevButton[actionDom]('keydown', s.a11y.onEnterKey);
            }
            if (s.params.pagination && s.params.paginationClickable) {
                s.paginationContainer[actionDom]('click', '.' + s.params.bulletClass, s.onClickIndex);
                if (s.params.a11y && s.a11y) s.paginationContainer[actionDom]('keydown', '.' + s.params.bulletClass, s.a11y.onEnterKey);
            }
        
            // Prevent Links Clicks
            if (s.params.preventClicks || s.params.preventClicksPropagation) touchEventsTarget[action]('click', s.preventClicks, true);
        };
        s.attachEvents = function () {
            s.initEvents();
        };
        s.detachEvents = function () {
            s.initEvents(true);
        };
        
        /*=========================
          Handle Clicks
          ===========================*/
        // Prevent Clicks
        s.allowClick = true;
        s.preventClicks = function (e) {
            if (!s.allowClick) {
                if (s.params.preventClicks) e.preventDefault();
                if (s.params.preventClicksPropagation && s.animating) {
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                }
            }
        };
        // Clicks
        s.onClickNext = function (e) {
            e.preventDefault();
            if (s.isEnd && !s.params.loop) return;
            s.slideNext();
        };
        s.onClickPrev = function (e) {
            e.preventDefault();
            if (s.isBeginning && !s.params.loop) return;
            s.slidePrev();
        };
        s.onClickIndex = function (e) {
            e.preventDefault();
            var index = $(this).index() * s.params.slidesPerGroup;
            if (s.params.loop) index = index + s.loopedSlides;
            s.slideTo(index);
        };
        
        /*=========================
          Handle Touches
          ===========================*/
        function findElementInEvent(e, selector) {
            var el = $(e.target);
            if (!el.is(selector)) {
                if (typeof selector === 'string') {
                    el = el.parents(selector);
                }
                else if (selector.nodeType) {
                    var found;
                    el.parents().each(function (index, _el) {
                        if (_el === selector) found = selector;
                    });
                    if (!found) return undefined;
                    else return selector;
                }
            }
            if (el.length === 0) {
                return undefined;
            }
            return el[0];
        }
        s.updateClickedSlide = function (e) {
            var slide = findElementInEvent(e, '.' + s.params.slideClass);
            var slideFound = false;
            if (slide) {
                for (var i = 0; i < s.slides.length; i++) {
                    if (s.slides[i] === slide) slideFound = true;
                }
            }
        
            if (slide && slideFound) {
                s.clickedSlide = slide;
                s.clickedIndex = $(slide).index();
            }
            else {
                s.clickedSlide = undefined;
                s.clickedIndex = undefined;
                return;
            }
            if (s.params.slideToClickedSlide && s.clickedIndex !== undefined && s.clickedIndex !== s.activeIndex) {
                var slideToIndex = s.clickedIndex,
                    realIndex,
                    duplicatedSlides;
                if (s.params.loop) {
                    if (s.animating) return;
                    realIndex = $(s.clickedSlide).attr('data-swiper-slide-index');
                    if (s.params.centeredSlides) {
                        if ((slideToIndex < s.loopedSlides - s.params.slidesPerView/2) || (slideToIndex > s.slides.length - s.loopedSlides + s.params.slidesPerView/2)) {
                            s.fixLoop();
                            slideToIndex = s.wrapper.children('.' + s.params.slideClass + '[data-swiper-slide-index="' + realIndex + '"]:not(.swiper-slide-duplicate)').eq(0).index();
                            setTimeout(function () {
                                s.slideTo(slideToIndex);
                            }, 0);
                        }
                        else {
                            s.slideTo(slideToIndex);
                        }
                    }
                    else {
                        if (slideToIndex > s.slides.length - s.params.slidesPerView) {
                            s.fixLoop();
                            slideToIndex = s.wrapper.children('.' + s.params.slideClass + '[data-swiper-slide-index="' + realIndex + '"]:not(.swiper-slide-duplicate)').eq(0).index();
                            setTimeout(function () {
                                s.slideTo(slideToIndex);
                            }, 0);
                        }
                        else {
                            s.slideTo(slideToIndex);
                        }
                    }
                }
                else {
                    s.slideTo(slideToIndex);
                }
            }
        };
        
        var isTouched,
            isMoved,
            allowTouchCallbacks,
            touchStartTime,
            isScrolling,
            currentTranslate,
            startTranslate,
            allowThresholdMove,
            // Form elements to match
            formElements = 'input, select, textarea, button',
            // Last click time
            lastClickTime = Date.now(), clickTimeout,
            //Velocities
            velocities = [],
            allowMomentumBounce;
        
        // Animating Flag
        s.animating = false;
        
        // Touches information
        s.touches = {
            startX: 0,
            startY: 0,
            currentX: 0,
            currentY: 0,
            diff: 0
        };
        
        // Touch handlers
        var isTouchEvent, startMoving;
        s.onTouchStart = function (e) {
            if (e.originalEvent) e = e.originalEvent;
            isTouchEvent = e.type === 'touchstart';
            if (!isTouchEvent && 'which' in e && e.which === 3) return;
            if (s.params.noSwiping && findElementInEvent(e, '.' + s.params.noSwipingClass)) {
                s.allowClick = true;
                return;
            }
            if (s.params.swipeHandler) {
                if (!findElementInEvent(e, s.params.swipeHandler)) return;
            }
        
            var startX = s.touches.currentX = e.type === 'touchstart' ? e.targetTouches[0].pageX : e.pageX;
            var startY = s.touches.currentY = e.type === 'touchstart' ? e.targetTouches[0].pageY : e.pageY;
        
            // Do NOT start if iOS edge swipe is detected. Otherwise iOS app (UIWebView) cannot swipe-to-go-back anymore
            if(s.device.ios && s.params.iOSEdgeSwipeDetection && startX <= s.params.iOSEdgeSwipeThreshold) {
                return;
            }
        
            isTouched = true;
            isMoved = false;
            allowTouchCallbacks = true;
            isScrolling = undefined;
            startMoving = undefined;
            s.touches.startX = startX;
            s.touches.startY = startY;
            touchStartTime = Date.now();
            s.allowClick = true;
            s.updateContainerSize();
            s.swipeDirection = undefined;
            if (s.params.threshold > 0) allowThresholdMove = false;
            if (e.type !== 'touchstart') {
                var preventDefault = true;
                if ($(e.target).is(formElements)) preventDefault = false;
                if (document.activeElement && $(document.activeElement).is(formElements)) {
                    document.activeElement.blur();
                }
                if (preventDefault) {
                    e.preventDefault();
                }
            }
            s.emit('onTouchStart', s, e);
        };
        
        s.onTouchMove = function (e) {
            if (e.originalEvent) e = e.originalEvent;
            if (isTouchEvent && e.type === 'mousemove') return;
            if (e.preventedByNestedSwiper) {
                s.touches.startX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                s.touches.startY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                return;
            }
            if (s.params.onlyExternal) {
                // isMoved = true;
                s.allowClick = false;
                if (isTouched) {
                    s.touches.startX = s.touches.currentX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
                    s.touches.startY = s.touches.currentY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
                    touchStartTime = Date.now();
                }
                return;
            }
            if (isTouchEvent && document.activeElement) {
                if (e.target === document.activeElement && $(e.target).is(formElements)) {
                    isMoved = true;
                    s.allowClick = false;
                    return;
                }
            }
            if (allowTouchCallbacks) {
                s.emit('onTouchMove', s, e);
            }
            if (e.targetTouches && e.targetTouches.length > 1) return;
        
            s.touches.currentX = e.type === 'touchmove' ? e.targetTouches[0].pageX : e.pageX;
            s.touches.currentY = e.type === 'touchmove' ? e.targetTouches[0].pageY : e.pageY;
        
            if (typeof isScrolling === 'undefined') {
                var touchAngle = Math.atan2(Math.abs(s.touches.currentY - s.touches.startY), Math.abs(s.touches.currentX - s.touches.startX)) * 180 / Math.PI;
                isScrolling = s.isHorizontal() ? touchAngle > s.params.touchAngle : (90 - touchAngle > s.params.touchAngle);
            }
            if (isScrolling) {
                s.emit('onTouchMoveOpposite', s, e);
            }
            if (typeof startMoving === 'undefined' && s.browser.ieTouch) {
                if (s.touches.currentX !== s.touches.startX || s.touches.currentY !== s.touches.startY) {
                    startMoving = true;
                }
            }
            if (!isTouched) return;
            if (isScrolling)  {
                isTouched = false;
                return;
            }
            if (!startMoving && s.browser.ieTouch) {
                return;
            }
            s.allowClick = false;
            s.emit('onSliderMove', s, e);
            e.preventDefault();
            if (s.params.touchMoveStopPropagation && !s.params.nested) {
                e.stopPropagation();
            }
        
            if (!isMoved) {
                if (params.loop) {
                    s.fixLoop();
                }
                startTranslate = s.getWrapperTranslate();
                s.setWrapperTransition(0);
                if (s.animating) {
                    s.wrapper.trigger('webkitTransitionEnd transitionend oTransitionEnd MSTransitionEnd msTransitionEnd');
                }
                if (s.params.autoplay && s.autoplaying) {
                    if (s.params.autoplayDisableOnInteraction) {
                        s.stopAutoplay();
                    }
                    else {
                        s.pauseAutoplay();
                    }
                }
                allowMomentumBounce = false;
                //Grab Cursor
                if (s.params.grabCursor) {
                    s.container[0].style.cursor = 'move';
                    s.container[0].style.cursor = '-webkit-grabbing';
                    s.container[0].style.cursor = '-moz-grabbin';
                    s.container[0].style.cursor = 'grabbing';
                }
            }
            isMoved = true;
        
            var diff = s.touches.diff = s.isHorizontal() ? s.touches.currentX - s.touches.startX : s.touches.currentY - s.touches.startY;
        
            diff = diff * s.params.touchRatio;
            if (s.rtl) diff = -diff;
        
            s.swipeDirection = diff > 0 ? 'prev' : 'next';
            currentTranslate = diff + startTranslate;
        
            var disableParentSwiper = true;
            if ((diff > 0 && currentTranslate > s.minTranslate())) {
                disableParentSwiper = false;
                if (s.params.resistance) currentTranslate = s.minTranslate() - 1 + Math.pow(-s.minTranslate() + startTranslate + diff, s.params.resistanceRatio);
            }
            else if (diff < 0 && currentTranslate < s.maxTranslate()) {
                disableParentSwiper = false;
                if (s.params.resistance) currentTranslate = s.maxTranslate() + 1 - Math.pow(s.maxTranslate() - startTranslate - diff, s.params.resistanceRatio);
            }
        
            if (disableParentSwiper) {
                e.preventedByNestedSwiper = true;
            }
        
            // Directions locks
            if (!s.params.allowSwipeToNext && s.swipeDirection === 'next' && currentTranslate < startTranslate) {
                currentTranslate = startTranslate;
            }
            if (!s.params.allowSwipeToPrev && s.swipeDirection === 'prev' && currentTranslate > startTranslate) {
                currentTranslate = startTranslate;
            }
        
            if (!s.params.followFinger) return;
        
            // Threshold
            if (s.params.threshold > 0) {
                if (Math.abs(diff) > s.params.threshold || allowThresholdMove) {
                    if (!allowThresholdMove) {
                        allowThresholdMove = true;
                        s.touches.startX = s.touches.currentX;
                        s.touches.startY = s.touches.currentY;
                        currentTranslate = startTranslate;
                        s.touches.diff = s.isHorizontal() ? s.touches.currentX - s.touches.startX : s.touches.currentY - s.touches.startY;
                        return;
                    }
                }
                else {
                    currentTranslate = startTranslate;
                    return;
                }
            }
            // Update active index in free mode
            if (s.params.freeMode || s.params.watchSlidesProgress) {
                s.updateActiveIndex();
            }
            if (s.params.freeMode) {
                //Velocity
                if (velocities.length === 0) {
                    velocities.push({
                        position: s.touches[s.isHorizontal() ? 'startX' : 'startY'],
                        time: touchStartTime
                    });
                }
                velocities.push({
                    position: s.touches[s.isHorizontal() ? 'currentX' : 'currentY'],
                    time: (new window.Date()).getTime()
                });
            }
            // Update progress
            s.updateProgress(currentTranslate);
            // Update translate
            s.setWrapperTranslate(currentTranslate);
        };
        s.onTouchEnd = function (e) {
            if (e.originalEvent) e = e.originalEvent;
            if (allowTouchCallbacks) {
                s.emit('onTouchEnd', s, e);
            }
            allowTouchCallbacks = false;
            if (!isTouched) return;
            //Return Grab Cursor
            if (s.params.grabCursor && isMoved && isTouched) {
                s.container[0].style.cursor = 'move';
                s.container[0].style.cursor = '-webkit-grab';
                s.container[0].style.cursor = '-moz-grab';
                s.container[0].style.cursor = 'grab';
            }
        
            // Time diff
            var touchEndTime = Date.now();
            var timeDiff = touchEndTime - touchStartTime;
        
            // Tap, doubleTap, Click
            if (s.allowClick) {
                s.updateClickedSlide(e);
                s.emit('onTap', s, e);
                if (timeDiff < 300 && (touchEndTime - lastClickTime) > 300) {
                    if (clickTimeout) clearTimeout(clickTimeout);
                    clickTimeout = setTimeout(function () {
                        if (!s) return;
                        if (s.params.paginationHide && s.paginationContainer.length > 0 && !$(e.target).hasClass(s.params.bulletClass)) {
                            s.paginationContainer.toggleClass(s.params.paginationHiddenClass);
                        }
                        s.emit('onClick', s, e);
                    }, 300);
        
                }
                if (timeDiff < 300 && (touchEndTime - lastClickTime) < 300) {
                    if (clickTimeout) clearTimeout(clickTimeout);
                    s.emit('onDoubleTap', s, e);
                }
            }
        
            lastClickTime = Date.now();
            setTimeout(function () {
                if (s) s.allowClick = true;
            }, 0);
        
            if (!isTouched || !isMoved || !s.swipeDirection || s.touches.diff === 0 || currentTranslate === startTranslate) {
                isTouched = isMoved = false;
                return;
            }
            isTouched = isMoved = false;
        
            var currentPos;
            if (s.params.followFinger) {
                currentPos = s.rtl ? s.translate : -s.translate;
            }
            else {
                currentPos = -currentTranslate;
            }
            if (s.params.freeMode) {
                if (currentPos < -s.minTranslate()) {
                    s.slideTo(s.activeIndex);
                    return;
                }
                else if (currentPos > -s.maxTranslate()) {
                    if (s.slides.length < s.snapGrid.length) {
                        s.slideTo(s.snapGrid.length - 1);
                    }
                    else {
                        s.slideTo(s.slides.length - 1);
                    }
                    return;
                }
        
                if (s.params.freeModeMomentum) {
                    if (velocities.length > 1) {
                        var lastMoveEvent = velocities.pop(), velocityEvent = velocities.pop();
        
                        var distance = lastMoveEvent.position - velocityEvent.position;
                        var time = lastMoveEvent.time - velocityEvent.time;
                        s.velocity = distance / time;
                        s.velocity = s.velocity / 2;
                        if (Math.abs(s.velocity) < s.params.freeModeMinimumVelocity) {
                            s.velocity = 0;
                        }
                        // this implies that the user stopped moving a finger then released.
                        // There would be no events with distance zero, so the last event is stale.
                        if (time > 150 || (new window.Date().getTime() - lastMoveEvent.time) > 300) {
                            s.velocity = 0;
                        }
                    } else {
                        s.velocity = 0;
                    }
        
                    velocities.length = 0;
                    var momentumDuration = 1000 * s.params.freeModeMomentumRatio;
                    var momentumDistance = s.velocity * momentumDuration;
        
                    var newPosition = s.translate + momentumDistance;
                    if (s.rtl) newPosition = - newPosition;
                    var doBounce = false;
                    var afterBouncePosition;
                    var bounceAmount = Math.abs(s.velocity) * 20 * s.params.freeModeMomentumBounceRatio;
                    if (newPosition < s.maxTranslate()) {
                        if (s.params.freeModeMomentumBounce) {
                            if (newPosition + s.maxTranslate() < -bounceAmount) {
                                newPosition = s.maxTranslate() - bounceAmount;
                            }
                            afterBouncePosition = s.maxTranslate();
                            doBounce = true;
                            allowMomentumBounce = true;
                        }
                        else {
                            newPosition = s.maxTranslate();
                        }
                    }
                    else if (newPosition > s.minTranslate()) {
                        if (s.params.freeModeMomentumBounce) {
                            if (newPosition - s.minTranslate() > bounceAmount) {
                                newPosition = s.minTranslate() + bounceAmount;
                            }
                            afterBouncePosition = s.minTranslate();
                            doBounce = true;
                            allowMomentumBounce = true;
                        }
                        else {
                            newPosition = s.minTranslate();
                        }
                    }
                    else if (s.params.freeModeSticky) {
                        var j = 0,
                            nextSlide;
                        for (j = 0; j < s.snapGrid.length; j += 1) {
                            if (s.snapGrid[j] > -newPosition) {
                                nextSlide = j;
                                break;
                            }
        
                        }
                        if (Math.abs(s.snapGrid[nextSlide] - newPosition) < Math.abs(s.snapGrid[nextSlide - 1] - newPosition) || s.swipeDirection === 'next') {
                            newPosition = s.snapGrid[nextSlide];
                        } else {
                            newPosition = s.snapGrid[nextSlide - 1];
                        }
                        if (!s.rtl) newPosition = - newPosition;
                    }
                    //Fix duration
                    if (s.velocity !== 0) {
                        if (s.rtl) {
                            momentumDuration = Math.abs((-newPosition - s.translate) / s.velocity);
                        }
                        else {
                            momentumDuration = Math.abs((newPosition - s.translate) / s.velocity);
                        }
                    }
                    else if (s.params.freeModeSticky) {
                        s.slideReset();
                        return;
                    }
        
                    if (s.params.freeModeMomentumBounce && doBounce) {
                        s.updateProgress(afterBouncePosition);
                        s.setWrapperTransition(momentumDuration);
                        s.setWrapperTranslate(newPosition);
                        s.onTransitionStart();
                        s.animating = true;
                        s.wrapper.transitionEnd(function () {
                            if (!s || !allowMomentumBounce) return;
                            s.emit('onMomentumBounce', s);
        
                            s.setWrapperTransition(s.params.speed);
                            s.setWrapperTranslate(afterBouncePosition);
                            s.wrapper.transitionEnd(function () {
                                if (!s) return;
                                s.onTransitionEnd();
                            });
                        });
                    } else if (s.velocity) {
                        s.updateProgress(newPosition);
                        s.setWrapperTransition(momentumDuration);
                        s.setWrapperTranslate(newPosition);
                        s.onTransitionStart();
                        if (!s.animating) {
                            s.animating = true;
                            s.wrapper.transitionEnd(function () {
                                if (!s) return;
                                s.onTransitionEnd();
                            });
                        }
        
                    } else {
                        s.updateProgress(newPosition);
                    }
        
                    s.updateActiveIndex();
                }
                if (!s.params.freeModeMomentum || timeDiff >= s.params.longSwipesMs) {
                    s.updateProgress();
                    s.updateActiveIndex();
                }
                return;
            }
        
            // Find current slide
            var i, stopIndex = 0, groupSize = s.slidesSizesGrid[0];
            for (i = 0; i < s.slidesGrid.length; i += s.params.slidesPerGroup) {
                if (typeof s.slidesGrid[i + s.params.slidesPerGroup] !== 'undefined') {
                    if (currentPos >= s.slidesGrid[i] && currentPos < s.slidesGrid[i + s.params.slidesPerGroup]) {
                        stopIndex = i;
                        groupSize = s.slidesGrid[i + s.params.slidesPerGroup] - s.slidesGrid[i];
                    }
                }
                else {
                    if (currentPos >= s.slidesGrid[i]) {
                        stopIndex = i;
                        groupSize = s.slidesGrid[s.slidesGrid.length - 1] - s.slidesGrid[s.slidesGrid.length - 2];
                    }
                }
            }
        
            // Find current slide size
            var ratio = (currentPos - s.slidesGrid[stopIndex]) / groupSize;
        
            if (timeDiff > s.params.longSwipesMs) {
                // Long touches
                if (!s.params.longSwipes) {
                    s.slideTo(s.activeIndex);
                    return;
                }
                if (s.swipeDirection === 'next') {
                    if (ratio >= s.params.longSwipesRatio) s.slideTo(stopIndex + s.params.slidesPerGroup);
                    else s.slideTo(stopIndex);
        
                }
                if (s.swipeDirection === 'prev') {
                    if (ratio > (1 - s.params.longSwipesRatio)) s.slideTo(stopIndex + s.params.slidesPerGroup);
                    else s.slideTo(stopIndex);
                }
            }
            else {
                // Short swipes
                if (!s.params.shortSwipes) {
                    s.slideTo(s.activeIndex);
                    return;
                }
                if (s.swipeDirection === 'next') {
                    s.slideTo(stopIndex + s.params.slidesPerGroup);
        
                }
                if (s.swipeDirection === 'prev') {
                    s.slideTo(stopIndex);
                }
            }
        };
        /*=========================
          Transitions
          ===========================*/
        s._slideTo = function (slideIndex, speed) {
            return s.slideTo(slideIndex, speed, true, true);
        };
        s.slideTo = function (slideIndex, speed, runCallbacks, internal) {
            if (typeof runCallbacks === 'undefined') runCallbacks = true;
            if (typeof slideIndex === 'undefined') slideIndex = 0;
            if (slideIndex < 0) slideIndex = 0;
            s.snapIndex = Math.floor(slideIndex / s.params.slidesPerGroup);
            if (s.snapIndex >= s.snapGrid.length) s.snapIndex = s.snapGrid.length - 1;
        
            var translate = - s.snapGrid[s.snapIndex];
            // Stop autoplay
            if (s.params.autoplay && s.autoplaying) {
                if (internal || !s.params.autoplayDisableOnInteraction) {
                    s.pauseAutoplay(speed);
                }
                else {
                    s.stopAutoplay();
                }
            }
            // Update progress
            s.updateProgress(translate);
        
            // Normalize slideIndex
            for (var i = 0; i < s.slidesGrid.length; i++) {
                if (- Math.floor(translate * 100) >= Math.floor(s.slidesGrid[i] * 100)) {
                    slideIndex = i;
                }
            }
        
            // Directions locks
            if (!s.params.allowSwipeToNext && translate < s.translate && translate < s.minTranslate()) {
                return false;
            }
            if (!s.params.allowSwipeToPrev && translate > s.translate && translate > s.maxTranslate()) {
                if ((s.activeIndex || 0) !== slideIndex ) return false;
            }
        
            // Update Index
            if (typeof speed === 'undefined') speed = s.params.speed;
            s.previousIndex = s.activeIndex || 0;
            s.activeIndex = slideIndex;
        
            if ((s.rtl && -translate === s.translate) || (!s.rtl && translate === s.translate)) {
                // Update Height
                if (s.params.autoHeight) {
                    s.updateAutoHeight();
                }
                s.updateClasses();
                if (s.params.effect !== 'slide') {
                    s.setWrapperTranslate(translate);
                }
                return false;
            }
            s.updateClasses();
            s.onTransitionStart(runCallbacks);
        
            if (speed === 0) {
                s.setWrapperTranslate(translate);
                s.setWrapperTransition(0);
                s.onTransitionEnd(runCallbacks);
            }
            else {
                s.setWrapperTranslate(translate);
                s.setWrapperTransition(speed);
                if (!s.animating) {
                    s.animating = true;
                    s.wrapper.transitionEnd(function () {
                        if (!s) return;
                        s.onTransitionEnd(runCallbacks);
                    });
                }
        
            }
        
            return true;
        };
        
        s.onTransitionStart = function (runCallbacks) {
            if (typeof runCallbacks === 'undefined') runCallbacks = true;
            if (s.params.autoHeight) {
                s.updateAutoHeight();
            }
            if (s.lazy) s.lazy.onTransitionStart();
            if (runCallbacks) {
                s.emit('onTransitionStart', s);
                if (s.activeIndex !== s.previousIndex) {
                    s.emit('onSlideChangeStart', s);
                    if (s.activeIndex > s.previousIndex) {
                        s.emit('onSlideNextStart', s);
                    }
                    else {
                        s.emit('onSlidePrevStart', s);
                    }
                }
        
            }
        };
        s.onTransitionEnd = function (runCallbacks) {
            s.animating = false;
            s.setWrapperTransition(0);
            if (typeof runCallbacks === 'undefined') runCallbacks = true;
            if (s.lazy) s.lazy.onTransitionEnd();
            if (runCallbacks) {
                s.emit('onTransitionEnd', s);
                if (s.activeIndex !== s.previousIndex) {
                    s.emit('onSlideChangeEnd', s);
                    if (s.activeIndex > s.previousIndex) {
                        s.emit('onSlideNextEnd', s);
                    }
                    else {
                        s.emit('onSlidePrevEnd', s);
                    }
                }
            }
            if (s.params.hashnav && s.hashnav) {
                s.hashnav.setHash();
            }
        
        };
        s.slideNext = function (runCallbacks, speed, internal) {
            if (s.params.loop) {
                if (s.animating) return false;
                s.fixLoop();
                var clientLeft = s.container[0].clientLeft;
                return s.slideTo(s.activeIndex + s.params.slidesPerGroup, speed, runCallbacks, internal);
            }
            else return s.slideTo(s.activeIndex + s.params.slidesPerGroup, speed, runCallbacks, internal);
        };
        s._slideNext = function (speed) {
            return s.slideNext(true, speed, true);
        };
        s.slidePrev = function (runCallbacks, speed, internal) {
            if (s.params.loop) {
                if (s.animating) return false;
                s.fixLoop();
                var clientLeft = s.container[0].clientLeft;
                return s.slideTo(s.activeIndex - 1, speed, runCallbacks, internal);
            }
            else return s.slideTo(s.activeIndex - 1, speed, runCallbacks, internal);
        };
        s._slidePrev = function (speed) {
            return s.slidePrev(true, speed, true);
        };
        s.slideReset = function (runCallbacks, speed, internal) {
            return s.slideTo(s.activeIndex, speed, runCallbacks);
        };
        
        /*=========================
          Translate/transition helpers
          ===========================*/
        s.setWrapperTransition = function (duration, byController) {
            s.wrapper.transition(duration);
            if (s.params.effect !== 'slide' && s.effects[s.params.effect]) {
                s.effects[s.params.effect].setTransition(duration);
            }
            if (s.params.parallax && s.parallax) {
                s.parallax.setTransition(duration);
            }
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.setTransition(duration);
            }
            if (s.params.control && s.controller) {
                s.controller.setTransition(duration, byController);
            }
            s.emit('onSetTransition', s, duration);
        };
        s.setWrapperTranslate = function (translate, updateActiveIndex, byController) {
            var x = 0, y = 0, z = 0;
            if (s.isHorizontal()) {
                x = s.rtl ? -translate : translate;
            }
            else {
                y = translate;
            }
        
            if (s.params.roundLengths) {
                x = round(x);
                y = round(y);
            }
        
            if (!s.params.virtualTranslate) {
                if (s.support.transforms3d) s.wrapper.transform('translate3d(' + x + 'px, ' + y + 'px, ' + z + 'px)');
                else s.wrapper.transform('translate(' + x + 'px, ' + y + 'px)');
            }
        
            s.translate = s.isHorizontal() ? x : y;
        
            // Check if we need to update progress
            var progress;
            var translatesDiff = s.maxTranslate() - s.minTranslate();
            if (translatesDiff === 0) {
                progress = 0;
            }
            else {
                progress = (translate - s.minTranslate()) / (translatesDiff);
            }
            if (progress !== s.progress) {
                s.updateProgress(translate);
            }
        
            if (updateActiveIndex) s.updateActiveIndex();
            if (s.params.effect !== 'slide' && s.effects[s.params.effect]) {
                s.effects[s.params.effect].setTranslate(s.translate);
            }
            if (s.params.parallax && s.parallax) {
                s.parallax.setTranslate(s.translate);
            }
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.setTranslate(s.translate);
            }
            if (s.params.control && s.controller) {
                s.controller.setTranslate(s.translate, byController);
            }
            s.emit('onSetTranslate', s, s.translate);
        };
        
        s.getTranslate = function (el, axis) {
            var matrix, curTransform, curStyle, transformMatrix;
        
            // automatic axis detection
            if (typeof axis === 'undefined') {
                axis = 'x';
            }
        
            if (s.params.virtualTranslate) {
                return s.rtl ? -s.translate : s.translate;
            }
        
            curStyle = window.getComputedStyle(el, null);
            if (window.WebKitCSSMatrix) {
                curTransform = curStyle.transform || curStyle.webkitTransform;
                if (curTransform.split(',').length > 6) {
                    curTransform = curTransform.split(', ').map(function(a){
                        return a.replace(',','.');
                    }).join(', ');
                }
                // Some old versions of Webkit choke when 'none' is passed; pass
                // empty string instead in this case
                transformMatrix = new window.WebKitCSSMatrix(curTransform === 'none' ? '' : curTransform);
            }
            else {
                transformMatrix = curStyle.MozTransform || curStyle.OTransform || curStyle.MsTransform || curStyle.msTransform  || curStyle.transform || curStyle.getPropertyValue('transform').replace('translate(', 'matrix(1, 0, 0, 1,');
                matrix = transformMatrix.toString().split(',');
            }
        
            if (axis === 'x') {
                //Latest Chrome and webkits Fix
                if (window.WebKitCSSMatrix)
                    curTransform = transformMatrix.m41;
                //Crazy IE10 Matrix
                else if (matrix.length === 16)
                    curTransform = parseFloat(matrix[12]);
                //Normal Browsers
                else
                    curTransform = parseFloat(matrix[4]);
            }
            if (axis === 'y') {
                //Latest Chrome and webkits Fix
                if (window.WebKitCSSMatrix)
                    curTransform = transformMatrix.m42;
                //Crazy IE10 Matrix
                else if (matrix.length === 16)
                    curTransform = parseFloat(matrix[13]);
                //Normal Browsers
                else
                    curTransform = parseFloat(matrix[5]);
            }
            if (s.rtl && curTransform) curTransform = -curTransform;
            return curTransform || 0;
        };
        s.getWrapperTranslate = function (axis) {
            if (typeof axis === 'undefined') {
                axis = s.isHorizontal() ? 'x' : 'y';
            }
            return s.getTranslate(s.wrapper[0], axis);
        };
        
        /*=========================
          Observer
          ===========================*/
        s.observers = [];
        function initObserver(target, options) {
            options = options || {};
            // create an observer instance
            var ObserverFunc = window.MutationObserver || window.WebkitMutationObserver;
            var observer = new ObserverFunc(function (mutations) {
                mutations.forEach(function (mutation) {
                    s.onResize(true);
                    s.emit('onObserverUpdate', s, mutation);
                });
            });
        
            observer.observe(target, {
                attributes: typeof options.attributes === 'undefined' ? true : options.attributes,
                childList: typeof options.childList === 'undefined' ? true : options.childList,
                characterData: typeof options.characterData === 'undefined' ? true : options.characterData
            });
        
            s.observers.push(observer);
        }
        s.initObservers = function () {
            if (s.params.observeParents) {
                var containerParents = s.container.parents();
                for (var i = 0; i < containerParents.length; i++) {
                    initObserver(containerParents[i]);
                }
            }
        
            // Observe container
            initObserver(s.container[0], {childList: false});
        
            // Observe wrapper
            initObserver(s.wrapper[0], {attributes: false});
        };
        s.disconnectObservers = function () {
            for (var i = 0; i < s.observers.length; i++) {
                s.observers[i].disconnect();
            }
            s.observers = [];
        };
        /*=========================
          Loop
          ===========================*/
        // Create looped slides
        s.createLoop = function () {
            // Remove duplicated slides
            s.wrapper.children('.' + s.params.slideClass + '.' + s.params.slideDuplicateClass).remove();
        
            var slides = s.wrapper.children('.' + s.params.slideClass);
        
            if(s.params.slidesPerView === 'auto' && !s.params.loopedSlides) s.params.loopedSlides = slides.length;
        
            s.loopedSlides = parseInt(s.params.loopedSlides || s.params.slidesPerView, 10);
            s.loopedSlides = s.loopedSlides + s.params.loopAdditionalSlides;
            if (s.loopedSlides > slides.length) {
                s.loopedSlides = slides.length;
            }
        
            var prependSlides = [], appendSlides = [], i;
            slides.each(function (index, el) {
                var slide = $(this);
                if (index < s.loopedSlides) appendSlides.push(el);
                if (index < slides.length && index >= slides.length - s.loopedSlides) prependSlides.push(el);
                slide.attr('data-swiper-slide-index', index);
            });
            for (i = 0; i < appendSlides.length; i++) {
                s.wrapper.append($(appendSlides[i].cloneNode(true)).addClass(s.params.slideDuplicateClass));
            }
            for (i = prependSlides.length - 1; i >= 0; i--) {
                s.wrapper.prepend($(prependSlides[i].cloneNode(true)).addClass(s.params.slideDuplicateClass));
            }
        };
        s.destroyLoop = function () {
            s.wrapper.children('.' + s.params.slideClass + '.' + s.params.slideDuplicateClass).remove();
            s.slides.removeAttr('data-swiper-slide-index');
        };
        s.reLoop = function (updatePosition) {
            var oldIndex = s.activeIndex - s.loopedSlides;
            s.destroyLoop();
            s.createLoop();
            s.updateSlidesSize();
            if (updatePosition) {
                s.slideTo(oldIndex + s.loopedSlides, 0, false);
            }
        
        };
        s.fixLoop = function () {
            var newIndex;
            //Fix For Negative Oversliding
            if (s.activeIndex < s.loopedSlides) {
                newIndex = s.slides.length - s.loopedSlides * 3 + s.activeIndex;
                newIndex = newIndex + s.loopedSlides;
                s.slideTo(newIndex, 0, false, true);
            }
            //Fix For Positive Oversliding
            else if ((s.params.slidesPerView === 'auto' && s.activeIndex >= s.loopedSlides * 2) || (s.activeIndex > s.slides.length - s.params.slidesPerView * 2)) {
                newIndex = -s.slides.length + s.activeIndex + s.loopedSlides;
                newIndex = newIndex + s.loopedSlides;
                s.slideTo(newIndex, 0, false, true);
            }
        };
        /*=========================
          Append/Prepend/Remove Slides
          ===========================*/
        s.appendSlide = function (slides) {
            if (s.params.loop) {
                s.destroyLoop();
            }
            if (typeof slides === 'object' && slides.length) {
                for (var i = 0; i < slides.length; i++) {
                    if (slides[i]) s.wrapper.append(slides[i]);
                }
            }
            else {
                s.wrapper.append(slides);
            }
            if (s.params.loop) {
                s.createLoop();
            }
            if (!(s.params.observer && s.support.observer)) {
                s.update(true);
            }
        };
        s.prependSlide = function (slides) {
            if (s.params.loop) {
                s.destroyLoop();
            }
            var newActiveIndex = s.activeIndex + 1;
            if (typeof slides === 'object' && slides.length) {
                for (var i = 0; i < slides.length; i++) {
                    if (slides[i]) s.wrapper.prepend(slides[i]);
                }
                newActiveIndex = s.activeIndex + slides.length;
            }
            else {
                s.wrapper.prepend(slides);
            }
            if (s.params.loop) {
                s.createLoop();
            }
            if (!(s.params.observer && s.support.observer)) {
                s.update(true);
            }
            s.slideTo(newActiveIndex, 0, false);
        };
        s.removeSlide = function (slidesIndexes) {
            if (s.params.loop) {
                s.destroyLoop();
                s.slides = s.wrapper.children('.' + s.params.slideClass);
            }
            var newActiveIndex = s.activeIndex,
                indexToRemove;
            if (typeof slidesIndexes === 'object' && slidesIndexes.length) {
                for (var i = 0; i < slidesIndexes.length; i++) {
                    indexToRemove = slidesIndexes[i];
                    if (s.slides[indexToRemove]) s.slides.eq(indexToRemove).remove();
                    if (indexToRemove < newActiveIndex) newActiveIndex--;
                }
                newActiveIndex = Math.max(newActiveIndex, 0);
            }
            else {
                indexToRemove = slidesIndexes;
                if (s.slides[indexToRemove]) s.slides.eq(indexToRemove).remove();
                if (indexToRemove < newActiveIndex) newActiveIndex--;
                newActiveIndex = Math.max(newActiveIndex, 0);
            }
        
            if (s.params.loop) {
                s.createLoop();
            }
        
            if (!(s.params.observer && s.support.observer)) {
                s.update(true);
            }
            if (s.params.loop) {
                s.slideTo(newActiveIndex + s.loopedSlides, 0, false);
            }
            else {
                s.slideTo(newActiveIndex, 0, false);
            }
        
        };
        s.removeAllSlides = function () {
            var slidesIndexes = [];
            for (var i = 0; i < s.slides.length; i++) {
                slidesIndexes.push(i);
            }
            s.removeSlide(slidesIndexes);
        };
        
    
        /*=========================
          Effects
          ===========================*/
        s.effects = {
            fade: {
                setTranslate: function () {
                    for (var i = 0; i < s.slides.length; i++) {
                        var slide = s.slides.eq(i);
                        var offset = slide[0].swiperSlideOffset;
                        var tx = -offset;
                        if (!s.params.virtualTranslate) tx = tx - s.translate;
                        var ty = 0;
                        if (!s.isHorizontal()) {
                            ty = tx;
                            tx = 0;
                        }
                        var slideOpacity = s.params.fade.crossFade ?
                                Math.max(1 - Math.abs(slide[0].progress), 0) :
                                1 + Math.min(Math.max(slide[0].progress, -1), 0);
                        slide
                            .css({
                                opacity: slideOpacity
                            })
                            .transform('translate3d(' + tx + 'px, ' + ty + 'px, 0px)');
        
                    }
        
                },
                setTransition: function (duration) {
                    s.slides.transition(duration);
                    if (s.params.virtualTranslate && duration !== 0) {
                        var eventTriggered = false;
                        s.slides.transitionEnd(function () {
                            if (eventTriggered) return;
                            if (!s) return;
                            eventTriggered = true;
                            s.animating = false;
                            var triggerEvents = ['webkitTransitionEnd', 'transitionend', 'oTransitionEnd', 'MSTransitionEnd', 'msTransitionEnd'];
                            for (var i = 0; i < triggerEvents.length; i++) {
                                s.wrapper.trigger(triggerEvents[i]);
                            }
                        });
                    }
                }
            },
            flip: {
                setTranslate: function () {
                    for (var i = 0; i < s.slides.length; i++) {
                        var slide = s.slides.eq(i);
                        var progress = slide[0].progress;
                        if (s.params.flip.limitRotation) {
                            progress = Math.max(Math.min(slide[0].progress, 1), -1);
                        }
                        var offset = slide[0].swiperSlideOffset;
                        var rotate = -180 * progress,
                            rotateY = rotate,
                            rotateX = 0,
                            tx = -offset,
                            ty = 0;
                        if (!s.isHorizontal()) {
                            ty = tx;
                            tx = 0;
                            rotateX = -rotateY;
                            rotateY = 0;
                        }
                        else if (s.rtl) {
                            rotateY = -rotateY;
                        }
        
                        slide[0].style.zIndex = -Math.abs(Math.round(progress)) + s.slides.length;
        
                        if (s.params.flip.slideShadows) {
                            //Set shadows
                            var shadowBefore = s.isHorizontal() ? slide.find('.swiper-slide-shadow-left') : slide.find('.swiper-slide-shadow-top');
                            var shadowAfter = s.isHorizontal() ? slide.find('.swiper-slide-shadow-right') : slide.find('.swiper-slide-shadow-bottom');
                            if (shadowBefore.length === 0) {
                                shadowBefore = $('<div class="swiper-slide-shadow-' + (s.isHorizontal() ? 'left' : 'top') + '"></div>');
                                slide.append(shadowBefore);
                            }
                            if (shadowAfter.length === 0) {
                                shadowAfter = $('<div class="swiper-slide-shadow-' + (s.isHorizontal() ? 'right' : 'bottom') + '"></div>');
                                slide.append(shadowAfter);
                            }
                            if (shadowBefore.length) shadowBefore[0].style.opacity = Math.max(-progress, 0);
                            if (shadowAfter.length) shadowAfter[0].style.opacity = Math.max(progress, 0);
                        }
        
                        slide
                            .transform('translate3d(' + tx + 'px, ' + ty + 'px, 0px) rotateX(' + rotateX + 'deg) rotateY(' + rotateY + 'deg)');
                    }
                },
                setTransition: function (duration) {
                    s.slides.transition(duration).find('.swiper-slide-shadow-top, .swiper-slide-shadow-right, .swiper-slide-shadow-bottom, .swiper-slide-shadow-left').transition(duration);
                    if (s.params.virtualTranslate && duration !== 0) {
                        var eventTriggered = false;
                        s.slides.eq(s.activeIndex).transitionEnd(function () {
                            if (eventTriggered) return;
                            if (!s) return;
                            if (!$(this).hasClass(s.params.slideActiveClass)) return;
                            eventTriggered = true;
                            s.animating = false;
                            var triggerEvents = ['webkitTransitionEnd', 'transitionend', 'oTransitionEnd', 'MSTransitionEnd', 'msTransitionEnd'];
                            for (var i = 0; i < triggerEvents.length; i++) {
                                s.wrapper.trigger(triggerEvents[i]);
                            }
                        });
                    }
                }
            },
            cube: {
                setTranslate: function () {
                    var wrapperRotate = 0, cubeShadow;
                    if (s.params.cube.shadow) {
                        if (s.isHorizontal()) {
                            cubeShadow = s.wrapper.find('.swiper-cube-shadow');
                            if (cubeShadow.length === 0) {
                                cubeShadow = $('<div class="swiper-cube-shadow"></div>');
                                s.wrapper.append(cubeShadow);
                            }
                            cubeShadow.css({height: s.width + 'px'});
                        }
                        else {
                            cubeShadow = s.container.find('.swiper-cube-shadow');
                            if (cubeShadow.length === 0) {
                                cubeShadow = $('<div class="swiper-cube-shadow"></div>');
                                s.container.append(cubeShadow);
                            }
                        }
                    }
                    for (var i = 0; i < s.slides.length; i++) {
                        var slide = s.slides.eq(i);
                        var slideAngle = i * 90;
                        var round = Math.floor(slideAngle / 360);
                        if (s.rtl) {
                            slideAngle = -slideAngle;
                            round = Math.floor(-slideAngle / 360);
                        }
                        var progress = Math.max(Math.min(slide[0].progress, 1), -1);
                        var tx = 0, ty = 0, tz = 0;
                        if (i % 4 === 0) {
                            tx = - round * 4 * s.size;
                            tz = 0;
                        }
                        else if ((i - 1) % 4 === 0) {
                            tx = 0;
                            tz = - round * 4 * s.size;
                        }
                        else if ((i - 2) % 4 === 0) {
                            tx = s.size + round * 4 * s.size;
                            tz = s.size;
                        }
                        else if ((i - 3) % 4 === 0) {
                            tx = - s.size;
                            tz = 3 * s.size + s.size * 4 * round;
                        }
                        if (s.rtl) {
                            tx = -tx;
                        }
        
                        if (!s.isHorizontal()) {
                            ty = tx;
                            tx = 0;
                        }
        
                        var transform = 'rotateX(' + (s.isHorizontal() ? 0 : -slideAngle) + 'deg) rotateY(' + (s.isHorizontal() ? slideAngle : 0) + 'deg) translate3d(' + tx + 'px, ' + ty + 'px, ' + tz + 'px)';
                        if (progress <= 1 && progress > -1) {
                            wrapperRotate = i * 90 + progress * 90;
                            if (s.rtl) wrapperRotate = -i * 90 - progress * 90;
                        }
                        slide.transform(transform);
                        if (s.params.cube.slideShadows) {
                            //Set shadows
                            var shadowBefore = s.isHorizontal() ? slide.find('.swiper-slide-shadow-left') : slide.find('.swiper-slide-shadow-top');
                            var shadowAfter = s.isHorizontal() ? slide.find('.swiper-slide-shadow-right') : slide.find('.swiper-slide-shadow-bottom');
                            if (shadowBefore.length === 0) {
                                shadowBefore = $('<div class="swiper-slide-shadow-' + (s.isHorizontal() ? 'left' : 'top') + '"></div>');
                                slide.append(shadowBefore);
                            }
                            if (shadowAfter.length === 0) {
                                shadowAfter = $('<div class="swiper-slide-shadow-' + (s.isHorizontal() ? 'right' : 'bottom') + '"></div>');
                                slide.append(shadowAfter);
                            }
                            if (shadowBefore.length) shadowBefore[0].style.opacity = Math.max(-progress, 0);
                            if (shadowAfter.length) shadowAfter[0].style.opacity = Math.max(progress, 0);
                        }
                    }
                    s.wrapper.css({
                        '-webkit-transform-origin': '50% 50% -' + (s.size / 2) + 'px',
                        '-moz-transform-origin': '50% 50% -' + (s.size / 2) + 'px',
                        '-ms-transform-origin': '50% 50% -' + (s.size / 2) + 'px',
                        'transform-origin': '50% 50% -' + (s.size / 2) + 'px'
                    });
        
                    if (s.params.cube.shadow) {
                        if (s.isHorizontal()) {
                            cubeShadow.transform('translate3d(0px, ' + (s.width / 2 + s.params.cube.shadowOffset) + 'px, ' + (-s.width / 2) + 'px) rotateX(90deg) rotateZ(0deg) scale(' + (s.params.cube.shadowScale) + ')');
                        }
                        else {
                            var shadowAngle = Math.abs(wrapperRotate) - Math.floor(Math.abs(wrapperRotate) / 90) * 90;
                            var multiplier = 1.5 - (Math.sin(shadowAngle * 2 * Math.PI / 360) / 2 + Math.cos(shadowAngle * 2 * Math.PI / 360) / 2);
                            var scale1 = s.params.cube.shadowScale,
                                scale2 = s.params.cube.shadowScale / multiplier,
                                offset = s.params.cube.shadowOffset;
                            cubeShadow.transform('scale3d(' + scale1 + ', 1, ' + scale2 + ') translate3d(0px, ' + (s.height / 2 + offset) + 'px, ' + (-s.height / 2 / scale2) + 'px) rotateX(-90deg)');
                        }
                    }
                    var zFactor = (s.isSafari || s.isUiWebView) ? (-s.size / 2) : 0;
                    s.wrapper.transform('translate3d(0px,0,' + zFactor + 'px) rotateX(' + (s.isHorizontal() ? 0 : wrapperRotate) + 'deg) rotateY(' + (s.isHorizontal() ? -wrapperRotate : 0) + 'deg)');
                },
                setTransition: function (duration) {
                    s.slides.transition(duration).find('.swiper-slide-shadow-top, .swiper-slide-shadow-right, .swiper-slide-shadow-bottom, .swiper-slide-shadow-left').transition(duration);
                    if (s.params.cube.shadow && !s.isHorizontal()) {
                        s.container.find('.swiper-cube-shadow').transition(duration);
                    }
                }
            },
            coverflow: {
                setTranslate: function () {
                    var transform = s.translate;
                    var center = s.isHorizontal() ? -transform + s.width / 2 : -transform + s.height / 2;
                    var rotate = s.isHorizontal() ? s.params.coverflow.rotate: -s.params.coverflow.rotate;
                    var translate = s.params.coverflow.depth;
                    //Each slide offset from center
                    for (var i = 0, length = s.slides.length; i < length; i++) {
                        var slide = s.slides.eq(i);
                        var slideSize = s.slidesSizesGrid[i];
                        var slideOffset = slide[0].swiperSlideOffset;
                        var offsetMultiplier = (center - slideOffset - slideSize / 2) / slideSize * s.params.coverflow.modifier;
        
                        var rotateY = s.isHorizontal() ? rotate * offsetMultiplier : 0;
                        var rotateX = s.isHorizontal() ? 0 : rotate * offsetMultiplier;
                        // var rotateZ = 0
                        var translateZ = -translate * Math.abs(offsetMultiplier);
        
                        var translateY = s.isHorizontal() ? 0 : s.params.coverflow.stretch * (offsetMultiplier);
                        var translateX = s.isHorizontal() ? s.params.coverflow.stretch * (offsetMultiplier) : 0;
        
                        //Fix for ultra small values
                        if (Math.abs(translateX) < 0.001) translateX = 0;
                        if (Math.abs(translateY) < 0.001) translateY = 0;
                        if (Math.abs(translateZ) < 0.001) translateZ = 0;
                        if (Math.abs(rotateY) < 0.001) rotateY = 0;
                        if (Math.abs(rotateX) < 0.001) rotateX = 0;
        
                        var slideTransform = 'translate3d(' + translateX + 'px,' + translateY + 'px,' + translateZ + 'px)  rotateX(' + rotateX + 'deg) rotateY(' + rotateY + 'deg)';
        
                        slide.transform(slideTransform);
                        slide[0].style.zIndex = -Math.abs(Math.round(offsetMultiplier)) + 1;
                        if (s.params.coverflow.slideShadows) {
                            //Set shadows
                            var shadowBefore = s.isHorizontal() ? slide.find('.swiper-slide-shadow-left') : slide.find('.swiper-slide-shadow-top');
                            var shadowAfter = s.isHorizontal() ? slide.find('.swiper-slide-shadow-right') : slide.find('.swiper-slide-shadow-bottom');
                            if (shadowBefore.length === 0) {
                                shadowBefore = $('<div class="swiper-slide-shadow-' + (s.isHorizontal() ? 'left' : 'top') + '"></div>');
                                slide.append(shadowBefore);
                            }
                            if (shadowAfter.length === 0) {
                                shadowAfter = $('<div class="swiper-slide-shadow-' + (s.isHorizontal() ? 'right' : 'bottom') + '"></div>');
                                slide.append(shadowAfter);
                            }
                            if (shadowBefore.length) shadowBefore[0].style.opacity = offsetMultiplier > 0 ? offsetMultiplier : 0;
                            if (shadowAfter.length) shadowAfter[0].style.opacity = (-offsetMultiplier) > 0 ? -offsetMultiplier : 0;
                        }
                    }
        
                    //Set correct perspective for IE10
                    if (s.browser.ie) {
                        var ws = s.wrapper[0].style;
                        ws.perspectiveOrigin = center + 'px 50%';
                    }
                },
                setTransition: function (duration) {
                    s.slides.transition(duration).find('.swiper-slide-shadow-top, .swiper-slide-shadow-right, .swiper-slide-shadow-bottom, .swiper-slide-shadow-left').transition(duration);
                }
            }
        };
    
        /*=========================
          Images Lazy Loading
          ===========================*/
        s.lazy = {
            initialImageLoaded: false,
            loadImageInSlide: function (index, loadInDuplicate) {
                if (typeof index === 'undefined') return;
                if (typeof loadInDuplicate === 'undefined') loadInDuplicate = true;
                if (s.slides.length === 0) return;
        
                var slide = s.slides.eq(index);
                var img = slide.find('.swiper-lazy:not(.swiper-lazy-loaded):not(.swiper-lazy-loading)');
                if (slide.hasClass('swiper-lazy') && !slide.hasClass('swiper-lazy-loaded') && !slide.hasClass('swiper-lazy-loading')) {
                    img = img.add(slide[0]);
                }
                if (img.length === 0) return;
        
                img.each(function () {
                    var _img = $(this);
                    _img.addClass('swiper-lazy-loading');
                    var background = _img.attr('data-background');
                    var src = _img.attr('data-src'),
                        srcset = _img.attr('data-srcset');
                    s.loadImage(_img[0], (src || background), srcset, false, function () {
                        if (background) {
                            _img.css('background-image', 'url("' + background + '")');
                            _img.removeAttr('data-background');
                        }
                        else {
                            if (srcset) {
                                _img.attr('srcset', srcset);
                                _img.removeAttr('data-srcset');
                            }
                            if (src) {
                                _img.attr('src', src);
                                _img.removeAttr('data-src');
                            }
        
                        }
        
                        _img.addClass('swiper-lazy-loaded').removeClass('swiper-lazy-loading');
                        slide.find('.swiper-lazy-preloader, .preloader').remove();
                        if (s.params.loop && loadInDuplicate) {
                            var slideOriginalIndex = slide.attr('data-swiper-slide-index');
                            if (slide.hasClass(s.params.slideDuplicateClass)) {
                                var originalSlide = s.wrapper.children('[data-swiper-slide-index="' + slideOriginalIndex + '"]:not(.' + s.params.slideDuplicateClass + ')');
                                s.lazy.loadImageInSlide(originalSlide.index(), false);
                            }
                            else {
                                var duplicatedSlide = s.wrapper.children('.' + s.params.slideDuplicateClass + '[data-swiper-slide-index="' + slideOriginalIndex + '"]');
                                s.lazy.loadImageInSlide(duplicatedSlide.index(), false);
                            }
                        }
                        s.emit('onLazyImageReady', s, slide[0], _img[0]);
                    });
        
                    s.emit('onLazyImageLoad', s, slide[0], _img[0]);
                });
        
            },
            load: function () {
                var i;
                if (s.params.watchSlidesVisibility) {
                    s.wrapper.children('.' + s.params.slideVisibleClass).each(function () {
                        s.lazy.loadImageInSlide($(this).index());
                    });
                }
                else {
                    if (s.params.slidesPerView > 1) {
                        for (i = s.activeIndex; i < s.activeIndex + s.params.slidesPerView ; i++) {
                            if (s.slides[i]) s.lazy.loadImageInSlide(i);
                        }
                    }
                    else {
                        s.lazy.loadImageInSlide(s.activeIndex);
                    }
                }
                if (s.params.lazyLoadingInPrevNext) {
                    if (s.params.slidesPerView > 1 || (s.params.lazyLoadingInPrevNextAmount && s.params.lazyLoadingInPrevNextAmount > 1)) {
                        var amount = s.params.lazyLoadingInPrevNextAmount;
                        var spv = s.params.slidesPerView;
                        var maxIndex = Math.min(s.activeIndex + spv + Math.max(amount, spv), s.slides.length);
                        var minIndex = Math.max(s.activeIndex - Math.max(spv, amount), 0);
                        // Next Slides
                        for (i = s.activeIndex + s.params.slidesPerView; i < maxIndex; i++) {
                            if (s.slides[i]) s.lazy.loadImageInSlide(i);
                        }
                        // Prev Slides
                        for (i = minIndex; i < s.activeIndex ; i++) {
                            if (s.slides[i]) s.lazy.loadImageInSlide(i);
                        }
                    }
                    else {
                        var nextSlide = s.wrapper.children('.' + s.params.slideNextClass);
                        if (nextSlide.length > 0) s.lazy.loadImageInSlide(nextSlide.index());
        
                        var prevSlide = s.wrapper.children('.' + s.params.slidePrevClass);
                        if (prevSlide.length > 0) s.lazy.loadImageInSlide(prevSlide.index());
                    }
                }
            },
            onTransitionStart: function () {
                if (s.params.lazyLoading) {
                    if (s.params.lazyLoadingOnTransitionStart || (!s.params.lazyLoadingOnTransitionStart && !s.lazy.initialImageLoaded)) {
                        s.lazy.load();
                    }
                }
            },
            onTransitionEnd: function () {
                if (s.params.lazyLoading && !s.params.lazyLoadingOnTransitionStart) {
                    s.lazy.load();
                }
            }
        };
        
    
        /*=========================
          Scrollbar
          ===========================*/
        s.scrollbar = {
            isTouched: false,
            setDragPosition: function (e) {
                var sb = s.scrollbar;
                var x = 0, y = 0;
                var translate;
                var pointerPosition = s.isHorizontal() ?
                    ((e.type === 'touchstart' || e.type === 'touchmove') ? e.targetTouches[0].pageX : e.pageX || e.clientX) :
                    ((e.type === 'touchstart' || e.type === 'touchmove') ? e.targetTouches[0].pageY : e.pageY || e.clientY) ;
                var position = (pointerPosition) - sb.track.offset()[s.isHorizontal() ? 'left' : 'top'] - sb.dragSize / 2;
                var positionMin = -s.minTranslate() * sb.moveDivider;
                var positionMax = -s.maxTranslate() * sb.moveDivider;
                if (position < positionMin) {
                    position = positionMin;
                }
                else if (position > positionMax) {
                    position = positionMax;
                }
                position = -position / sb.moveDivider;
                s.updateProgress(position);
                s.setWrapperTranslate(position, true);
            },
            dragStart: function (e) {
                var sb = s.scrollbar;
                sb.isTouched = true;
                e.preventDefault();
                e.stopPropagation();
        
                sb.setDragPosition(e);
                clearTimeout(sb.dragTimeout);
        
                sb.track.transition(0);
                if (s.params.scrollbarHide) {
                    sb.track.css('opacity', 1);
                }
                s.wrapper.transition(100);
                sb.drag.transition(100);
                s.emit('onScrollbarDragStart', s);
            },
            dragMove: function (e) {
                var sb = s.scrollbar;
                if (!sb.isTouched) return;
                if (e.preventDefault) e.preventDefault();
                else e.returnValue = false;
                sb.setDragPosition(e);
                s.wrapper.transition(0);
                sb.track.transition(0);
                sb.drag.transition(0);
                s.emit('onScrollbarDragMove', s);
            },
            dragEnd: function (e) {
                var sb = s.scrollbar;
                if (!sb.isTouched) return;
                sb.isTouched = false;
                if (s.params.scrollbarHide) {
                    clearTimeout(sb.dragTimeout);
                    sb.dragTimeout = setTimeout(function () {
                        sb.track.css('opacity', 0);
                        sb.track.transition(400);
                    }, 1000);
        
                }
                s.emit('onScrollbarDragEnd', s);
                if (s.params.scrollbarSnapOnRelease) {
                    s.slideReset();
                }
            },
            enableDraggable: function () {
                var sb = s.scrollbar;
                var target = s.support.touch ? sb.track : document;
                $(sb.track).on(s.touchEvents.start, sb.dragStart);
                $(target).on(s.touchEvents.move, sb.dragMove);
                $(target).on(s.touchEvents.end, sb.dragEnd);
            },
            disableDraggable: function () {
                var sb = s.scrollbar;
                var target = s.support.touch ? sb.track : document;
                $(sb.track).off(s.touchEvents.start, sb.dragStart);
                $(target).off(s.touchEvents.move, sb.dragMove);
                $(target).off(s.touchEvents.end, sb.dragEnd);
            },
            set: function () {
                if (!s.params.scrollbar) return;
                var sb = s.scrollbar;
                sb.track = $(s.params.scrollbar);
                if (s.params.uniqueNavElements && typeof s.params.scrollbar === 'string' && sb.track.length > 1 && s.container.find(s.params.scrollbar).length === 1) {
                    sb.track = s.container.find(s.params.scrollbar);
                }
                sb.drag = sb.track.find('.swiper-scrollbar-drag');
                if (sb.drag.length === 0) {
                    sb.drag = $('<div class="swiper-scrollbar-drag"></div>');
                    sb.track.append(sb.drag);
                }
                sb.drag[0].style.width = '';
                sb.drag[0].style.height = '';
                sb.trackSize = s.isHorizontal() ? sb.track[0].offsetWidth : sb.track[0].offsetHeight;
        
                sb.divider = s.size / s.virtualSize;
                sb.moveDivider = sb.divider * (sb.trackSize / s.size);
                sb.dragSize = sb.trackSize * sb.divider;
        
                if (s.isHorizontal()) {
                    sb.drag[0].style.width = sb.dragSize + 'px';
                }
                else {
                    sb.drag[0].style.height = sb.dragSize + 'px';
                }
        
                if (sb.divider >= 1) {
                    sb.track[0].style.display = 'none';
                }
                else {
                    sb.track[0].style.display = '';
                }
                if (s.params.scrollbarHide) {
                    sb.track[0].style.opacity = 0;
                }
            },
            setTranslate: function () {
                if (!s.params.scrollbar) return;
                var diff;
                var sb = s.scrollbar;
                var translate = s.translate || 0;
                var newPos;
        
                var newSize = sb.dragSize;
                newPos = (sb.trackSize - sb.dragSize) * s.progress;
                if (s.rtl && s.isHorizontal()) {
                    newPos = -newPos;
                    if (newPos > 0) {
                        newSize = sb.dragSize - newPos;
                        newPos = 0;
                    }
                    else if (-newPos + sb.dragSize > sb.trackSize) {
                        newSize = sb.trackSize + newPos;
                    }
                }
                else {
                    if (newPos < 0) {
                        newSize = sb.dragSize + newPos;
                        newPos = 0;
                    }
                    else if (newPos + sb.dragSize > sb.trackSize) {
                        newSize = sb.trackSize - newPos;
                    }
                }
                if (s.isHorizontal()) {
                    if (s.support.transforms3d) {
                        sb.drag.transform('translate3d(' + (newPos) + 'px, 0, 0)');
                    }
                    else {
                        sb.drag.transform('translateX(' + (newPos) + 'px)');
                    }
                    sb.drag[0].style.width = newSize + 'px';
                }
                else {
                    if (s.support.transforms3d) {
                        sb.drag.transform('translate3d(0px, ' + (newPos) + 'px, 0)');
                    }
                    else {
                        sb.drag.transform('translateY(' + (newPos) + 'px)');
                    }
                    sb.drag[0].style.height = newSize + 'px';
                }
                if (s.params.scrollbarHide) {
                    clearTimeout(sb.timeout);
                    sb.track[0].style.opacity = 1;
                    sb.timeout = setTimeout(function () {
                        sb.track[0].style.opacity = 0;
                        sb.track.transition(400);
                    }, 1000);
                }
            },
            setTransition: function (duration) {
                if (!s.params.scrollbar) return;
                s.scrollbar.drag.transition(duration);
            }
        };
    
        /*=========================
          Controller
          ===========================*/
        s.controller = {
            LinearSpline: function (x, y) {
                this.x = x;
                this.y = y;
                this.lastIndex = x.length - 1;
                // Given an x value (x2), return the expected y2 value:
                // (x1,y1) is the known point before given value,
                // (x3,y3) is the known point after given value.
                var i1, i3;
                var l = this.x.length;
        
                this.interpolate = function (x2) {
                    if (!x2) return 0;
        
                    // Get the indexes of x1 and x3 (the array indexes before and after given x2):
                    i3 = binarySearch(this.x, x2);
                    i1 = i3 - 1;
        
                    // We have our indexes i1 & i3, so we can calculate already:
                    // y2 := ((x2−x1) × (y3−y1)) ÷ (x3−x1) + y1
                    return ((x2 - this.x[i1]) * (this.y[i3] - this.y[i1])) / (this.x[i3] - this.x[i1]) + this.y[i1];
                };
        
                var binarySearch = (function() {
                    var maxIndex, minIndex, guess;
                    return function(array, val) {
                        minIndex = -1;
                        maxIndex = array.length;
                        while (maxIndex - minIndex > 1)
                            if (array[guess = maxIndex + minIndex >> 1] <= val) {
                                minIndex = guess;
                            } else {
                                maxIndex = guess;
                            }
                        return maxIndex;
                    };
                })();
            },
            //xxx: for now i will just save one spline function to to
            getInterpolateFunction: function(c){
                if(!s.controller.spline) s.controller.spline = s.params.loop ?
                    new s.controller.LinearSpline(s.slidesGrid, c.slidesGrid) :
                    new s.controller.LinearSpline(s.snapGrid, c.snapGrid);
            },
            setTranslate: function (translate, byController) {
               var controlled = s.params.control;
               var multiplier, controlledTranslate;
               function setControlledTranslate(c) {
                    // this will create an Interpolate function based on the snapGrids
                    // x is the Grid of the scrolled scroller and y will be the controlled scroller
                    // it makes sense to create this only once and recall it for the interpolation
                    // the function does a lot of value caching for performance
                    translate = c.rtl && c.params.direction === 'horizontal' ? -s.translate : s.translate;
                    if (s.params.controlBy === 'slide') {
                        s.controller.getInterpolateFunction(c);
                        // i am not sure why the values have to be multiplicated this way, tried to invert the snapGrid
                        // but it did not work out
                        controlledTranslate = -s.controller.spline.interpolate(-translate);
                    }
        
                    if(!controlledTranslate || s.params.controlBy === 'container'){
                        multiplier = (c.maxTranslate() - c.minTranslate()) / (s.maxTranslate() - s.minTranslate());
                        controlledTranslate = (translate - s.minTranslate()) * multiplier + c.minTranslate();
                    }
        
                    if (s.params.controlInverse) {
                        controlledTranslate = c.maxTranslate() - controlledTranslate;
                    }
                    c.updateProgress(controlledTranslate);
                    c.setWrapperTranslate(controlledTranslate, false, s);
                    c.updateActiveIndex();
               }
               if (s.isArray(controlled)) {
                   for (var i = 0; i < controlled.length; i++) {
                       if (controlled[i] !== byController && controlled[i] instanceof Swiper) {
                           setControlledTranslate(controlled[i]);
                       }
                   }
               }
               else if (controlled instanceof Swiper && byController !== controlled) {
        
                   setControlledTranslate(controlled);
               }
            },
            setTransition: function (duration, byController) {
                var controlled = s.params.control;
                var i;
                function setControlledTransition(c) {
                    c.setWrapperTransition(duration, s);
                    if (duration !== 0) {
                        c.onTransitionStart();
                        c.wrapper.transitionEnd(function(){
                            if (!controlled) return;
                            if (c.params.loop && s.params.controlBy === 'slide') {
                                c.fixLoop();
                            }
                            c.onTransitionEnd();
        
                        });
                    }
                }
                if (s.isArray(controlled)) {
                    for (i = 0; i < controlled.length; i++) {
                        if (controlled[i] !== byController && controlled[i] instanceof Swiper) {
                            setControlledTransition(controlled[i]);
                        }
                    }
                }
                else if (controlled instanceof Swiper && byController !== controlled) {
                    setControlledTransition(controlled);
                }
            }
        };
    
        /*=========================
          Parallax
          ===========================*/
        function setParallaxTransform(el, progress) {
            el = $(el);
            var p, pX, pY;
            var rtlFactor = s.rtl ? -1 : 1;
        
            p = el.attr('data-swiper-parallax') || '0';
            pX = el.attr('data-swiper-parallax-x');
            pY = el.attr('data-swiper-parallax-y');
            if (pX || pY) {
                pX = pX || '0';
                pY = pY || '0';
            }
            else {
                if (s.isHorizontal()) {
                    pX = p;
                    pY = '0';
                }
                else {
                    pY = p;
                    pX = '0';
                }
            }
        
            if ((pX).indexOf('%') >= 0) {
                pX = parseInt(pX, 10) * progress * rtlFactor + '%';
            }
            else {
                pX = pX * progress * rtlFactor + 'px' ;
            }
            if ((pY).indexOf('%') >= 0) {
                pY = parseInt(pY, 10) * progress + '%';
            }
            else {
                pY = pY * progress + 'px' ;
            }
        
            el.transform('translate3d(' + pX + ', ' + pY + ',0px)');
        }
        s.parallax = {
            setTranslate: function () {
                s.container.children('[data-swiper-parallax], [data-swiper-parallax-x], [data-swiper-parallax-y]').each(function(){
                    setParallaxTransform(this, s.progress);
        
                });
                s.slides.each(function () {
                    var slide = $(this);
                    slide.find('[data-swiper-parallax], [data-swiper-parallax-x], [data-swiper-parallax-y]').each(function () {
                        var progress = Math.min(Math.max(slide[0].progress, -1), 1);
                        setParallaxTransform(this, progress);
                    });
                });
            },
            setTransition: function (duration) {
                if (typeof duration === 'undefined') duration = s.params.speed;
                s.container.find('[data-swiper-parallax], [data-swiper-parallax-x], [data-swiper-parallax-y]').each(function(){
                    var el = $(this);
                    var parallaxDuration = parseInt(el.attr('data-swiper-parallax-duration'), 10) || duration;
                    if (duration === 0) parallaxDuration = 0;
                    el.transition(parallaxDuration);
                });
            }
        };
        
    
        /*=========================
          Plugins API. Collect all and init all plugins
          ===========================*/
        s._plugins = [];
        for (var plugin in s.plugins) {
            var p = s.plugins[plugin](s, s.params[plugin]);
            if (p) s._plugins.push(p);
        }
        // Method to call all plugins event/method
        s.callPlugins = function (eventName) {
            for (var i = 0; i < s._plugins.length; i++) {
                if (eventName in s._plugins[i]) {
                    s._plugins[i][eventName](arguments[1], arguments[2], arguments[3], arguments[4], arguments[5]);
                }
            }
        };
    
        /*=========================
          Events/Callbacks/Plugins Emitter
          ===========================*/
        function normalizeEventName (eventName) {
            if (eventName.indexOf('on') !== 0) {
                if (eventName[0] !== eventName[0].toUpperCase()) {
                    eventName = 'on' + eventName[0].toUpperCase() + eventName.substring(1);
                }
                else {
                    eventName = 'on' + eventName;
                }
            }
            return eventName;
        }
        s.emitterEventListeners = {
        
        };
        s.emit = function (eventName) {
            // Trigger callbacks
            if (s.params[eventName]) {
                s.params[eventName](arguments[1], arguments[2], arguments[3], arguments[4], arguments[5]);
            }
            var i;
            // Trigger events
            if (s.emitterEventListeners[eventName]) {
                for (i = 0; i < s.emitterEventListeners[eventName].length; i++) {
                    s.emitterEventListeners[eventName][i](arguments[1], arguments[2], arguments[3], arguments[4], arguments[5]);
                }
            }
            // Trigger plugins
            if (s.callPlugins) s.callPlugins(eventName, arguments[1], arguments[2], arguments[3], arguments[4], arguments[5]);
        };
        s.on = function (eventName, handler) {
            eventName = normalizeEventName(eventName);
            if (!s.emitterEventListeners[eventName]) s.emitterEventListeners[eventName] = [];
            s.emitterEventListeners[eventName].push(handler);
            return s;
        };
        s.off = function (eventName, handler) {
            var i;
            eventName = normalizeEventName(eventName);
            if (typeof handler === 'undefined') {
                // Remove all handlers for such event
                s.emitterEventListeners[eventName] = [];
                return s;
            }
            if (!s.emitterEventListeners[eventName] || s.emitterEventListeners[eventName].length === 0) return;
            for (i = 0; i < s.emitterEventListeners[eventName].length; i++) {
                if(s.emitterEventListeners[eventName][i] === handler) s.emitterEventListeners[eventName].splice(i, 1);
            }
            return s;
        };
        s.once = function (eventName, handler) {
            eventName = normalizeEventName(eventName);
            var _handler = function () {
                handler(arguments[0], arguments[1], arguments[2], arguments[3], arguments[4]);
                s.off(eventName, _handler);
            };
            s.on(eventName, _handler);
            return s;
        };
    
        // Accessibility tools
        s.a11y = {
            makeFocusable: function ($el) {
                $el.attr('tabIndex', '0');
                return $el;
            },
            addRole: function ($el, role) {
                $el.attr('role', role);
                return $el;
            },
        
            addLabel: function ($el, label) {
                $el.attr('aria-label', label);
                return $el;
            },
        
            disable: function ($el) {
                $el.attr('aria-disabled', true);
                return $el;
            },
        
            enable: function ($el) {
                $el.attr('aria-disabled', false);
                return $el;
            },
        
            onEnterKey: function (event) {
                if (event.keyCode !== 13) return;
                if ($(event.target).is(s.params.nextButton)) {
                    s.onClickNext(event);
                    if (s.isEnd) {
                        s.a11y.notify(s.params.lastSlideMessage);
                    }
                    else {
                        s.a11y.notify(s.params.nextSlideMessage);
                    }
                }
                else if ($(event.target).is(s.params.prevButton)) {
                    s.onClickPrev(event);
                    if (s.isBeginning) {
                        s.a11y.notify(s.params.firstSlideMessage);
                    }
                    else {
                        s.a11y.notify(s.params.prevSlideMessage);
                    }
                }
                if ($(event.target).is('.' + s.params.bulletClass)) {
                    $(event.target)[0].click();
                }
            },
        
            liveRegion: $('<span class="swiper-notification" aria-live="assertive" aria-atomic="true"></span>'),
        
            notify: function (message) {
                var notification = s.a11y.liveRegion;
                if (notification.length === 0) return;
                notification.html('');
                notification.html(message);
            },
            init: function () {
                // Setup accessibility
                if (s.params.nextButton && s.nextButton && s.nextButton.length > 0) {
                    s.a11y.makeFocusable(s.nextButton);
                    s.a11y.addRole(s.nextButton, 'button');
                    s.a11y.addLabel(s.nextButton, s.params.nextSlideMessage);
                }
                if (s.params.prevButton && s.prevButton && s.prevButton.length > 0) {
                    s.a11y.makeFocusable(s.prevButton);
                    s.a11y.addRole(s.prevButton, 'button');
                    s.a11y.addLabel(s.prevButton, s.params.prevSlideMessage);
                }
        
                $(s.container).append(s.a11y.liveRegion);
            },
            initPagination: function () {
                if (s.params.pagination && s.params.paginationClickable && s.bullets && s.bullets.length) {
                    s.bullets.each(function () {
                        var bullet = $(this);
                        s.a11y.makeFocusable(bullet);
                        s.a11y.addRole(bullet, 'button');
                        s.a11y.addLabel(bullet, s.params.paginationBulletMessage.replace(/{{index}}/, bullet.index() + 1));
                    });
                }
            },
            destroy: function () {
                if (s.a11y.liveRegion && s.a11y.liveRegion.length > 0) s.a11y.liveRegion.remove();
            }
        };
        
    
        /*=========================
          Init/Destroy
          ===========================*/
        s.init = function () {
            if (s.params.loop) s.createLoop();
            s.updateContainerSize();
            s.updateSlidesSize();
            s.updatePagination();
            if (s.params.scrollbar && s.scrollbar) {
                s.scrollbar.set();
                if (s.params.scrollbarDraggable) {
                    s.scrollbar.enableDraggable();
                }
            }
            if (s.params.effect !== 'slide' && s.effects[s.params.effect]) {
                if (!s.params.loop) s.updateProgress();
                s.effects[s.params.effect].setTranslate();
            }
            if (s.params.loop) {
                s.slideTo(s.params.initialSlide + s.loopedSlides, 0, s.params.runCallbacksOnInit);
            }
            else {
                s.slideTo(s.params.initialSlide, 0, s.params.runCallbacksOnInit);
                if (s.params.initialSlide === 0) {
                    if (s.parallax && s.params.parallax) s.parallax.setTranslate();
                    if (s.lazy && s.params.lazyLoading) {
                        s.lazy.load();
                        s.lazy.initialImageLoaded = true;
                    }
                }
            }
            s.attachEvents();
            if (s.params.observer && s.support.observer) {
                s.initObservers();
            }
            if (s.params.preloadImages && !s.params.lazyLoading) {
                s.preloadImages();
            }
            if (s.params.autoplay) {
                s.startAutoplay();
            }
            if (s.params.keyboardControl) {
                if (s.enableKeyboardControl) s.enableKeyboardControl();
            }
            if (s.params.mousewheelControl) {
                if (s.enableMousewheelControl) s.enableMousewheelControl();
            }
            if (s.params.hashnav) {
                if (s.hashnav) s.hashnav.init();
            }
            if (s.params.a11y && s.a11y) s.a11y.init();
            s.emit('onInit', s);
        };
        
        // Cleanup dynamic styles
        s.cleanupStyles = function () {
            // Container
            s.container.removeClass(s.classNames.join(' ')).removeAttr('style');
        
            // Wrapper
            s.wrapper.removeAttr('style');
        
            // Slides
            if (s.slides && s.slides.length) {
                s.slides
                    .removeClass([
                      s.params.slideVisibleClass,
                      s.params.slideActiveClass,
                      s.params.slideNextClass,
                      s.params.slidePrevClass
                    ].join(' '))
                    .removeAttr('style')
                    .removeAttr('data-swiper-column')
                    .removeAttr('data-swiper-row');
            }
        
            // Pagination/Bullets
            if (s.paginationContainer && s.paginationContainer.length) {
                s.paginationContainer.removeClass(s.params.paginationHiddenClass);
            }
            if (s.bullets && s.bullets.length) {
                s.bullets.removeClass(s.params.bulletActiveClass);
            }
        
            // Buttons
            if (s.params.prevButton) $(s.params.prevButton).removeClass(s.params.buttonDisabledClass);
            if (s.params.nextButton) $(s.params.nextButton).removeClass(s.params.buttonDisabledClass);
        
            // Scrollbar
            if (s.params.scrollbar && s.scrollbar) {
                if (s.scrollbar.track && s.scrollbar.track.length) s.scrollbar.track.removeAttr('style');
                if (s.scrollbar.drag && s.scrollbar.drag.length) s.scrollbar.drag.removeAttr('style');
            }
        };
        
        // Destroy
        s.destroy = function (deleteInstance, cleanupStyles) {
            // Detach evebts
            s.detachEvents();
            // Stop autoplay
            s.stopAutoplay();
            // Disable draggable
            if (s.params.scrollbar && s.scrollbar) {
                if (s.params.scrollbarDraggable) {
                    s.scrollbar.disableDraggable();
                }
            }
            // Destroy loop
            if (s.params.loop) {
                s.destroyLoop();
            }
            // Cleanup styles
            if (cleanupStyles) {
                s.cleanupStyles();
            }
            // Disconnect observer
            s.disconnectObservers();
            // Disable keyboard/mousewheel
            if (s.params.keyboardControl) {
                if (s.disableKeyboardControl) s.disableKeyboardControl();
            }
            if (s.params.mousewheelControl) {
                if (s.disableMousewheelControl) s.disableMousewheelControl();
            }
            // Disable a11y
            if (s.params.a11y && s.a11y) s.a11y.destroy();
            // Destroy callback
            s.emit('onDestroy');
            // Delete instance
            if (deleteInstance !== false) s = null;
        };
        
        s.init();
        
    
    
        // Return swiper instance
        return s;
    };
    
    /*==================================================
        Prototype
    ====================================================*/
    Swiper.prototype = {
        isSafari: (function () {
            var ua = navigator.userAgent.toLowerCase();
            return (ua.indexOf('safari') >= 0 && ua.indexOf('chrome') < 0 && ua.indexOf('android') < 0);
        })(),
        isUiWebView: /(iPhone|iPod|iPad).*AppleWebKit(?!.*Safari)/i.test(navigator.userAgent),
        isArray: function (arr) {
            return Object.prototype.toString.apply(arr) === '[object Array]';
        },
        /*==================================================
        Browser
        ====================================================*/
        browser: {
            ie: window.navigator.pointerEnabled || window.navigator.msPointerEnabled,
            ieTouch: (window.navigator.msPointerEnabled && window.navigator.msMaxTouchPoints > 1) || (window.navigator.pointerEnabled && window.navigator.maxTouchPoints > 1)
        },
        /*==================================================
        Devices
        ====================================================*/
        device: (function () {
            var ua = navigator.userAgent;
            var android = ua.match(/(Android);?[\s\/]+([\d.]+)?/);
            var ipad = ua.match(/(iPad).*OS\s([\d_]+)/);
            var ipod = ua.match(/(iPod)(.*OS\s([\d_]+))?/);
            var iphone = !ipad && ua.match(/(iPhone\sOS)\s([\d_]+)/);
            return {
                ios: ipad || iphone || ipod,
                android: android
            };
        })(),
        /*==================================================
        Feature Detection
        ====================================================*/
        support: {
            touch : (window.Modernizr && Modernizr.touch === true) || (function () {
                return !!(('ontouchstart' in window) || window.DocumentTouch && document instanceof DocumentTouch);
            })(),
    
            transforms3d : (window.Modernizr && Modernizr.csstransforms3d === true) || (function () {
                var div = document.createElement('div').style;
                return ('webkitPerspective' in div || 'MozPerspective' in div || 'OPerspective' in div || 'MsPerspective' in div || 'perspective' in div);
            })(),
    
            flexbox: (function () {
                var div = document.createElement('div').style;
                var styles = ('alignItems webkitAlignItems webkitBoxAlign msFlexAlign mozBoxAlign webkitFlexDirection msFlexDirection mozBoxDirection mozBoxOrient webkitBoxDirection webkitBoxOrient').split(' ');
                for (var i = 0; i < styles.length; i++) {
                    if (styles[i] in div) return true;
                }
            })(),
    
            observer: (function () {
                return ('MutationObserver' in window || 'WebkitMutationObserver' in window);
            })()
        },
        /*==================================================
        Plugins
        ====================================================*/
        plugins: {}
    };

})();



},{}]},{},[3])
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm5vZGVfbW9kdWxlcy9icm93c2VyLXBhY2svX3ByZWx1ZGUuanMiLCJhcHAvanMvc2NyaXB0cy9JbmRleFBhZ2VDb250cm9sbGVyLmpzIiwiYXBwL2pzL3NjcmlwdHMvTXlBcHAuanMiLCJhcHAvanMvc2NyaXB0cy9pbml0LmpzIiwiYXBwL2pzL3NjcmlwdHMvd2VsY29tZXNjcmVlbi5qcyIsIm5vZGVfbW9kdWxlcy9mcmFtZXdvcms3L2Rpc3QvanMvZnJhbWV3b3JrNy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQ0FBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDdEVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2xCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDdEZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDM09BO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXNDb250ZW50IjpbIihmdW5jdGlvbiBlKHQsbixyKXtmdW5jdGlvbiBzKG8sdSl7aWYoIW5bb10pe2lmKCF0W29dKXt2YXIgYT10eXBlb2YgcmVxdWlyZT09XCJmdW5jdGlvblwiJiZyZXF1aXJlO2lmKCF1JiZhKXJldHVybiBhKG8sITApO2lmKGkpcmV0dXJuIGkobywhMCk7dmFyIGY9bmV3IEVycm9yKFwiQ2Fubm90IGZpbmQgbW9kdWxlICdcIitvK1wiJ1wiKTt0aHJvdyBmLmNvZGU9XCJNT0RVTEVfTk9UX0ZPVU5EXCIsZn12YXIgbD1uW29dPXtleHBvcnRzOnt9fTt0W29dWzBdLmNhbGwobC5leHBvcnRzLGZ1bmN0aW9uKGUpe3ZhciBuPXRbb11bMV1bZV07cmV0dXJuIHMobj9uOmUpfSxsLGwuZXhwb3J0cyxlLHQsbixyKX1yZXR1cm4gbltvXS5leHBvcnRzfXZhciBpPXR5cGVvZiByZXF1aXJlPT1cImZ1bmN0aW9uXCImJnJlcXVpcmU7Zm9yKHZhciBvPTA7bzxyLmxlbmd0aDtvKyspcyhyW29dKTtyZXR1cm4gc30pIiwiLypqc2xpbnQgYnJvd3NlcjogdHJ1ZSovXHJcbi8qZ2xvYmFsIGNvbnNvbGUqL1xyXG52YXIgd2VsY29tZXNjcmVlbl9wID0gcmVxdWlyZSgnLi93ZWxjb21lc2NyZWVuJyk7XHJcblxyXG52YXIgbXlhcHAgPSBteWFwcCB8fCB7fTtcclxubXlhcHAucGFnZXMgPSBteWFwcC5wYWdlcyB8fCB7fTtcclxuXHJcbm15YXBwLnBhZ2VzLkluZGV4UGFnZUNvbnRyb2xsZXIgPSBmdW5jdGlvbiAobXlhcHAsICQkKSB7XHJcbiAgICAndXNlIHN0cmljdCc7XHJcblxyXG4gICAgLy8gV2VsY29tc2NyZWVuIG1ldGhvZFxyXG4gICAgKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgICdiZ2NvbG9yJzogJyNmZmYnLFxyXG4gICAgICAgICAgICAgICAgJ2ZvbnRjb2xvcic6ICcjNTg5MDAxJyxcclxuXHJcbiAgICAgICAgICAgICAgICAnb25PcGVuZWQnOiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgJ29uQ2xvc2VkJzogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB3ZWxjb21lc2NyZWVuX3NsaWRlcyxcclxuICAgICAgICAgICAgd2VsY29tZXNjcmVlbjtcclxuXHJcbiAgICAgICAgd2VsY29tZXNjcmVlbl9zbGlkZXMgPSBbXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGlkOiAnc2xpZGUwJyxcclxuICAgICAgICAgICAgICAgIHBpY3R1cmU6ICc8ZGl2IGNsYXNzPVwid2VsY29tZS1pY29uXCI+PGkgY2xhc3M9XCJpY29uIGljb24td2VsY29tZVwiPjwvaT48L2Rpdj4nLFxyXG4gICAgICAgICAgICAgICAgdGV4dDogJycsXHJcbiAgICAgICAgICAgICAgICB0aXRsZTogJydcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICBdO1xyXG5cclxuICAgICAgICB3ZWxjb21lc2NyZWVuID0gd2VsY29tZXNjcmVlbl9wLndlbGNvbWVzY3JlZW5fcGx1Z2luKHdlbGNvbWVzY3JlZW5fc2xpZGVzLCBvcHRpb25zKTtcclxuICAgICAgICAkJChkb2N1bWVudCkub24oJ2NsaWNrJywgJy50dXRvcmlhbC1jbG9zZS1idG4nLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHdlbGNvbWVzY3JlZW4uY2xvc2UoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJCQoJy50dXRvcmlhbC1vcGVuLWJ0bicpLmNsaWNrKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgd2VsY29tZXNjcmVlbi5vcGVuKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICQkKGRvY3VtZW50KS5vbignY2xpY2snLCAnLnR1dG9yaWFsLW5leHQtbGluaycsIGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgIHdlbGNvbWVzY3JlZW4ubmV4dCgpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAkJChkb2N1bWVudCkub24oJ2NsaWNrJywgJy50dXRvcmlhbC1wcmV2aW91cy1zbGlkZScsIGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgICAgIHdlbGNvbWVzY3JlZW4ucHJldmlvdXMoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgLy8g0YHQutGA0YvQstCw0LXQvCDRhNC70LXRiCDRgdC60YDQuNC9XHJcbiAgICAgICAgdmFyIHdlbGNvbSA9ICQkKCcud2VsY29tZXNjcmVlbi1jb250YWluZXInKTtcclxuICAgICAgICB2YXIgaGlkZV9hbmltYXRpb24gPSBmdW5jdGlvbigpe1xyXG4gICAgICAgICAgICB3ZWxjb20uYWRkQ2xhc3MoJ2hpZGVBbmltYXRpb24nKTtcclxuICAgICAgICAgICAgdmFyIGhpZGVfd2VsY29tZXNjcmVlbiA9IGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgICAgICAgICB3ZWxjb21lc2NyZWVuLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGRlbHllZChoaWRlX3dlbGNvbWVzY3JlZW4sIDEwMDApO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgZGVseWVkKGhpZGVfYW5pbWF0aW9uLDE1MDApO1xyXG5cclxuXHJcbiAgICB9KCkpO1xyXG5cclxuXHJcblxyXG59O1xyXG5tb2R1bGUuZXhwb3J0cyA9IHtcclxuICAgIHBhZ2VfaW5kZXggOiBteWFwcC5wYWdlcy5JbmRleFBhZ2VDb250cm9sbGVyXHJcbn07IiwiLyoqXHJcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyNS4wMy4xNi5cclxuICovXHJcbmZ1bmN0aW9uIGNyZWF0ZUFycmF5U3RvcmFnZSgpe1xyXG5cclxufVxyXG5cclxuZnVuY3Rpb24gY2xvc2VTZXR0aW5ncygpe1xyXG5cclxufVxyXG5cclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgICBjcmVhdGVBcnJheVN0b3JhZ2U6IGNyZWF0ZUFycmF5U3RvcmFnZSxcclxuICAgIGNsb3NlU2V0dGluZ3M6IGNsb3NlU2V0dGluZ3NcclxufTtcclxuXHJcblxyXG5cclxuIiwiJ3VzZSBzdHJpY3QnO1xyXG5cclxuLyoqXHJcbiAqIENyZWF0ZWQgYnkgdXNlciBvbiAyMS4wNC4xNi5cclxuICovXHJcbnZhciBmNyA9IHJlcXVpcmUoJ2ZyYW1ld29yazcnKTtcclxudmFyIG15X2FwcCA9IHJlcXVpcmUoJy4vTXlBcHAnKTtcclxudmFyIHBhZ2VzID0gcmVxdWlyZSgnLi9JbmRleFBhZ2VDb250cm9sbGVyJyk7XHJcblxyXG5cclxuXHJcbnZhciBteWFwcCA9IG15YXBwIHx8IHt9O1xyXG52YXIgbXlBcHAgPSBuZXcgRnJhbWV3b3JrNyhcclxuICAgIHtcclxuICAgICAgICAvL3B1c2hTdGF0ZTp0cnVlLFxyXG4gICAgICAgIGluaXQ6ZmFsc2UsXHJcbiAgICAgICAgLy90YXBIb2xkOiB0cnVlLCAvL2VuYWJsZSB0YXAgaG9sZCBldmVudHNcclxuICAgICAgICByb3V0ZXI6IHRydWUsXHJcbiAgICAgICAgcmVsb2FkUGFnZXM6dHJ1ZSxcclxuICAgICAgICAvL2FuaW1hdGVOYXZCYWNrSWNvbjogdHJ1ZSxcclxuICAgICAgICBzd2lwZUJhY2tQYWdlOiBmYWxzZSxcclxuICAgICAgICAvLyBFbmFibGUgdGVtcGxhdGVzIGF1dG8gcHJlY29tcGlsYXRpb25cclxuICAgICAgICBwcmVjb21waWxlVGVtcGxhdGVzOiB0cnVlLFxyXG4gICAgICAgIC8vIEVuYWJsZWQgcGFnZXMgcmVuZGVyaW5nIHVzaW5nIFRlbXBsYXRlN1xyXG4gICAgICAgIHRlbXBsYXRlN1BhZ2VzOiB0cnVlLFxyXG4gICAgICAgIC8vIFNwZWNpZnkgVGVtcGxhdGU3IGRhdGEgZm9yIHBhZ2VzXHJcbiAgICAgICAgbW9kYWxCdXR0b25DYW5jZWw6IF93Lmdsb2JhbC5idXR0b25zLmNhbmNlbFtMTl1cclxufSk7XHJcbi8vIGdsb2JhbFxyXG52YXIgbiA9IHtcclxuICAgIGxhbmd1YWdlOidlbicsXHJcbiAgICBwbGF0Zm9ybTogXCJpT1NcIixcclxuICAgIEpTQVBJOiBudWxsLFxyXG4gICAgZnJlZTogZmFsc2UsXHJcbiAgICBzZXR0aW5nczogbnVsbCxcclxuICAgIHNvdW5kczp7fSxcclxuICAgIGtleV9zdG9yYWdlOntcclxuICAgICAgICBjYXRlZ29yaWVzOlwidHJpcF9vYmpcIixcclxuICAgICAgICBsYW5ndWFnZTpcInRyaXBfbGFuZ3VhZ2VcIlxyXG4gICAgfVxyXG59O1xyXG5cclxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcIkRPTUNvbnRlbnRMb2FkZWRcIiwgZnVuY3Rpb24oZXZlbnQpIHtcclxuICAgIC8vc3RvcmFnZUNsZWFyKCk7XHJcbiAgICAvLyBJbml0IG1ldGhvZFxyXG4gICAgaWYoIXN0b3JhZ2VHZXQobi5rZXlfc3RvcmFnZS5jYXRlZ29yaWVzKSl7XHJcbiAgICAgICAgLy8g0LfQsNC90L7RgdC40Lwg0LrQsNGC0LXQs9C+0YDQuNC4INC/0L4g0YPQvNC+0LvRh9Cw0L3QuNGOXHJcbiAgICAgICAgbXlfYXBwLmNyZWF0ZUFycmF5U3RvcmFnZSgpO1xyXG4gICAgfVxyXG4gICAgZWxzZXtcclxuICAgICAgICBjb25zb2xlLmxvZygnaW5pdCcpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBuLkpTQVBJID0gSlNBUEk7XHJcbiAgICBuLkpTQVBJLmtlZXBTY3JlZW5PbigpO1xyXG4gICAgbi5KU0FQSS5zZXRTdGF0dXNCYXJDb2xvcihcImJsYWNrXCIpO1xyXG5cclxuXHJcbiAgICBpZihuLmZyZWUpe1xyXG4gICAgICAgIGFkZFBhZGRpbmdCdW5uZXIoKTtcclxuICAgIH1cclxuICAgIC8vc2V0SW50ZXJ2YWwodXBkYXRlRGF0YSwgMTAwMCk7XHJcblxyXG4gICAgY29uc29sZS5sb2coJ2VuZCByZWFkeScpO1xyXG4gICAgLy8gSW5pdGlhbGl6ZSBhcHBcclxuICAgIHZhciBmdzdBcHAgPSBteUFwcCxcclxuICAgICAgICAkJCA9IERvbTcsXHJcbiAgICAgICAgaXBjID0gbmV3IHBhZ2VzLnBhZ2VfaW5kZXgoZnc3QXBwLCAkJCk7XHJcblxyXG4gICAgJCQoZG9jdW1lbnQuYm9keSkub24oJ2NsaWNrJywnLnRvb2xiYXIgLmxpbmsnLCBmdW5jdGlvbihlKXtcclxuICAgICAgICBjbG9zZVNldHRpbmdzKCk7XHJcbiAgICB9KTtcclxufSk7XHJcbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwiZGV2aWNlUmVhZHlFdmVudFwiLCBmdW5jdGlvbihldmVudCkge1xyXG4gICAgbi5zb3VuZHMudGFwID0gbmV3IFNvdW5kKCdzb3VuZHMvdGFwLm1wMycpO1xyXG4gICAgbi5zb3VuZHMudGFwLnZvbHVtZSgwLjUpO1xyXG4gICAgJCQoZG9jdW1lbnQuYm9keSkub24oJ2NsaWNrJywgJy5uYXZiYXIgLmxpbmssIC50b29sYmFyIC5saW5rLCAuc3VibmF2YmFyIC50YWItbGluaycsIGZ1bmN0aW9uKGUpe1xyXG4gICAgICAgIHZhciB0aGF0ID0gJCQodGhpcyk7XHJcbiAgICAgICAgcG9pbnRlckV2ZW50KHRoYXQsICdub25lJyk7XHJcbiAgICAgICAgcGxheVNvdW5kKG4uc291bmRzLnRhcCk7XHJcbiAgICAgICAgcG9pbnRlckV2ZW50KHRoYXQsICdhdXRvJywgMzAwKTtcclxuICAgIH0pO1xyXG59KTtcclxuXHJcblxyXG4iLCIvKmpzbGludCBicm93c2VyOiB0cnVlKi9cclxuLypnbG9iYWwgY29uc29sZSwgRnJhbWV3b3JrNywgYWxlcnQsIERvbTcsIFN3aXBlciwgVGVtcGxhdGU3Ki9cclxuXHJcbi8qKlxyXG4gKiBBIHBsdWdpbiBmb3IgRnJhbWV3b3JrNyB0byBzaG93IGEgc2xpZGVhYmxlIHdlbGNvbWUgc2NyZWVuXHJcbiAqXHJcbiAqIEBtb2R1bGUgRnJhbWV3b3JrNy9wcm90b3R5cGUvcGx1Z2lucy93ZWxjb21lc2NyZWVuXHJcbiAqIEBhdXRob3Igd3d3LnRpbW8tZXJuc3QubmV0XHJcbiAqIEBsaWNlbnNlIE1JVFxyXG4gKi9cclxuRnJhbWV3b3JrNy5wcm90b3R5cGUucGx1Z2lucy53ZWxjb21lc2NyZWVuID0gZnVuY3Rpb24gKGFwcCwgZ2xvYmFsUGx1Z2luUGFyYW1zKSB7XHJcbiAgICAndXNlIHN0cmljdCc7XHJcblxyXG4gICAgLy8gVmFyaWFibGVzIGluIG1vZHVsZSBzY29wZVxyXG4gICAgdmFyICQkID0gRG9tNyxcclxuICAgICAgICB0NyA9IFRlbXBsYXRlNyxcclxuICAgICAgICBXZWxjb21lc2NyZWVuO1xyXG5cclxuICAgIC8vIENsaWNrIGhhbmRsZXIgdG8gY2xvc2Ugd2VsY29tZXNjcmVlblxyXG4gICAgJCQoZG9jdW1lbnQpLm9uKCdjbGljaycsICcuY2xvc2Utd2VsY29tZXNjcmVlbicsIGZ1bmN0aW9uIChlKSB7XHJcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgIHZhciAkd3NjcmVlbiA9ICQkKHRoaXMpLnBhcmVudHMoJy53ZWxjb21lc2NyZWVuLWNvbnRhaW5lcicpO1xyXG4gICAgICAgIGlmICgkd3NjcmVlbi5sZW5ndGggPiAwICYmICR3c2NyZWVuWzBdLmY3V2VsY29tZXNjcmVlbikgeyAkd3NjcmVlblswXS5mN1dlbGNvbWVzY3JlZW4uY2xvc2UoKTsgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBSZXByZXNlbnRzIHRoZSB3ZWxjb21lIHNjcmVlblxyXG4gICAgICpcclxuICAgICAqIEBjbGFzc1xyXG4gICAgICogQG1lbWJlcm9mIG1vZHVsZTpGcmFtZXdvcms3L3Byb3RvdHlwZS9wbHVnaW5zL3dlbGNvbWVzY3JlZW5cclxuICAgICAqL1xyXG4gICAgV2VsY29tZXNjcmVlbiA9IGZ1bmN0aW9uIChzbGlkZXMsIG9wdGlvbnMpIHtcclxuXHJcbiAgICAgICAgLy8gUHJpdmF0ZSBwcm9wZXJ0aWVzXHJcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzLFxyXG4gICAgICAgICAgICBkZWZhdWx0VGVtcGxhdGUsXHJcbiAgICAgICAgICAgIHRlbXBsYXRlLFxyXG4gICAgICAgICAgICBjb250YWluZXIsXHJcbiAgICAgICAgICAgIHN3aXBlcixcclxuICAgICAgICAgICAgc3dpcGVyQ29udGFpbmVyLFxyXG4gICAgICAgICAgICBkZWZhdWx0cyA9IHtcclxuICAgICAgICAgICAgICAgIGNsb3NlQnV0dG9uOiBmYWxzZSwgICAgICAgIC8vIGVuYWJsZWQvZGlzYWJsZSBjbG9zZSBidXR0b25cclxuICAgICAgICAgICAgICAgIGNsb3NlQnV0dG9uVGV4dCA6ICdTa2lwJywgLy8gY2xvc2UgYnV0dG9uIHRleHRcclxuICAgICAgICAgICAgICAgIGNzc0NsYXNzOiAnJywgICAgICAgICAgICAgLy8gYWRkaXRpb25hbCBjbGFzcyBvbiBjb250YWluZXJcclxuICAgICAgICAgICAgICAgIHBhZ2luYXRpb246IGZhbHNlLCAgICAgICAgIC8vIHN3aXBlciBwYWdpbmF0aW9uXHJcbiAgICAgICAgICAgICAgICBsb29wOiBmYWxzZSwgICAgICAgICAgICAgIC8vIHN3aXBlciBsb29wXHJcbiAgICAgICAgICAgICAgICBvcGVuOiB0cnVlICAgICAgICAgICAgICAgIC8vIG9wZW4gd2VsY29tZSBzY3JlZW4gb24gaW5pdFxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBJbml0aWFsaXplcyB0aGUgc3dpcGVyXHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGZ1bmN0aW9uIGluaXRTd2lwZXIoKSB7XHJcbiAgICAgICAgICAgIHN3aXBlciA9IG5ldyBTd2lwZXIoJy5zd2lwZXItY29udGFpbmVyJywge1xyXG4gICAgICAgICAgICAgICAgZGlyZWN0aW9uOiAnaG9yaXpvbnRhbCcsXHJcbiAgICAgICAgICAgICAgICBsb29wOiBvcHRpb25zLmxvb3AsXHJcbiAgICAgICAgICAgICAgICBwYWdpbmF0aW9uOiBvcHRpb25zLnBhZ2luYXRpb24gPyBzd2lwZXJDb250YWluZXIuZmluZCgnLnN3aXBlci1wYWdpbmF0aW9uJykgOiB1bmRlZmluZWRcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBTZXRzIGNvbG9ycyBmcm9tIG9wdGlvbnNcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIEBwcml2YXRlXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZnVuY3Rpb24gc2V0Q29sb3JzKCkge1xyXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5iZ2NvbG9yKSB7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXIuY3NzKHtcclxuICAgICAgICAgICAgICAgICAgICAnYmFja2dyb3VuZC1jb2xvcic6IG9wdGlvbnMuYmdjb2xvcixcclxuICAgICAgICAgICAgICAgICAgICAnY29sb3InOiBvcHRpb25zLmZvbnRjb2xvclxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFNldHMgdGhlIGRlZmF1bHQgdGVtcGxhdGVcclxuICAgICAgICAgKlxyXG4gICAgICAgICAqIEBwcml2YXRlXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgZnVuY3Rpb24gZGVmaW5lRGVmYXVsdFRlbXBsYXRlKCkge1xyXG4gICAgICAgICAgICBkZWZhdWx0VGVtcGxhdGUgPSAnPGRpdiBjbGFzcz1cIndlbGNvbWVzY3JlZW4tY29udGFpbmVyIHt7I2lmIG9wdGlvbnMuY3NzQ2xhc3N9fXt7b3B0aW9ucy5jc3NDbGFzc319e3svaWZ9fVwiPicgK1xyXG4gICAgICAgICAgICAgICAgJ3t7I2lmIG9wdGlvbnMuY2xvc2VCdXR0b259fScgK1xyXG4gICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJ3ZWxjb21lc2NyZWVuLWNsb3NlYnRuIGNsb3NlLXdlbGNvbWVzY3JlZW5cIj57e29wdGlvbnMuY2xvc2VCdXR0b25UZXh0fX08L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICd7ey9pZn19JyArXHJcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIndlbGNvbWVzY3JlZW4tc3dpcGVyXCI+JyArXHJcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInN3aXBlci13cmFwcGVyXCI+JyArXHJcbiAgICAgICAgICAgICAgICAne3sjZWFjaCBzbGlkZXN9fScgK1xyXG4gICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJzd2lwZXItc2xpZGUgZmxleC1yb3cgYWxpZ24tbWFpbi1zdGFydFwiIHt7I2lmIGlkfX1pZD1cInt7aWR9fVwie3svaWZ9fT4nICtcclxuICAgICAgICAgICAgICAgICd7eyNpZiBjb250ZW50fX0nICtcclxuICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwid2VsY29tZXNjcmVlbi1jb250ZW50XCI+e3tjb250ZW50fX08L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICd7e2Vsc2V9fScgK1xyXG4gICAgICAgICAgICAgICAgJ3t7I2lmIHRpdGxlfX0nICtcclxuICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwid2VsY29tZXNjcmVlbi10aXRsZVwiPnt7dGl0bGV9fTwvZGl2PicgK1xyXG4gICAgICAgICAgICAgICAgJ3t7L2lmfX0nICtcclxuICAgICAgICAgICAgICAgICd7eyNpZiBwaWN0dXJlfX0nICtcclxuICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwid2VsY29tZXNjcmVlbi1waWN0dXJlXCI+e3twaWN0dXJlfX08L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICd7ey9pZn19JyArXHJcbiAgICAgICAgICAgICAgICAne3sjaWYgdGV4dH19JyArXHJcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIndlbGNvbWVzY3JlZW4tdGV4dFwiPnt7dGV4dH19PC9kaXY+JyArXHJcbiAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xyXG4gICAgICAgICAgICAgICAgJ3t7L2lmfX0nICtcclxuICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICd7ey9lYWNofX0nICtcclxuICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICd7eyNpZiBvcHRpb25zLnBhZ2luYXRpb259fScgK1xyXG4gICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJ3ZWxjb21lc2NyZWVuLXBhZ2luYXRpb24gc3dpcGVyLXBhZ2luYXRpb25cIj48L2Rpdj4nICtcclxuICAgICAgICAgICAgICAgICd7ey9pZn19JyArXHJcbiAgICAgICAgICAgICAgICAnPC9kaXY+JyArXHJcbiAgICAgICAgICAgICAgICAnPC9kaXY+JztcclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBTZXRzIHRoZSBvcHRpb25zIHRoYXQgd2VyZSByZXF1aXJlZFxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogQHByaXZhdGVcclxuICAgICAgICAgKi9cclxuICAgICAgICBmdW5jdGlvbiBhcHBseU9wdGlvbnMoKSB7XHJcbiAgICAgICAgICAgIHZhciBkZWY7XHJcbiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xyXG4gICAgICAgICAgICBmb3IgKGRlZiBpbiBkZWZhdWx0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zW2RlZl0gPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9uc1tkZWZdID0gZGVmYXVsdHNbZGVmXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogQ29tcGlsZXMgdGhlIHRlbXBsYXRlXHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICAgICAqL1xyXG4gICAgICAgIGZ1bmN0aW9uIGNvbXBpbGVUZW1wbGF0ZSgpIHtcclxuICAgICAgICAgICAgaWYgKCFvcHRpb25zLnRlbXBsYXRlKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBDYWNoZSBjb21waWxlZCB0ZW1wbGF0ZXNcclxuICAgICAgICAgICAgICAgIGlmICghYXBwLl9jb21waWxlZFRlbXBsYXRlcy53ZWxjb21lc2NyZWVuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXBwLl9jb21waWxlZFRlbXBsYXRlcy53ZWxjb21lc2NyZWVuID0gdDcuY29tcGlsZShkZWZhdWx0VGVtcGxhdGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGVtcGxhdGUgPSBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLndlbGNvbWVzY3JlZW47XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZSA9IHQ3LmNvbXBpbGUob3B0aW9ucy50ZW1wbGF0ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFNob3dzIHRoZSB3ZWxjb21lIHNjcmVlblxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogQHB1YmxpY1xyXG4gICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6RnJhbWV3b3JrNy9wcm90b3R5cGUvcGx1Z2lucy93ZWxjb21lc2NyZWVuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2VsZi5vcGVuID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBjb250YWluZXIgPSAkJCh0ZW1wbGF0ZSh7b3B0aW9uczogb3B0aW9ucywgc2xpZGVzOiBzbGlkZXN9KSk7XHJcbiAgICAgICAgICAgIHN3aXBlckNvbnRhaW5lciA9IGNvbnRhaW5lci5maW5kKCcuc3dpcGVyLWNvbnRhaW5lcicpO1xyXG4gICAgICAgICAgICBzZXRDb2xvcnMoKTtcclxuICAgICAgICAgICAgJCQoJ2JvZHknKS5hcHBlbmQoY29udGFpbmVyKTtcclxuICAgICAgICAgICAgLy9pbml0U3dpcGVyKCk7XHJcbiAgICAgICAgICAgIGNvbnRhaW5lclswXS5mN1dlbGNvbWVzY3JlZW4gPSBzZWxmO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMub25PcGVuZWQgPT09ICdmdW5jdGlvbicpIHsgb3B0aW9ucy5vbk9wZW5lZCgpOyB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgICogSGlkZXMgdGhlIHdlbGNvbWUgc2NyZWVuXHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiBAcHVibGljXHJcbiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpGcmFtZXdvcms3L3Byb3RvdHlwZS9wbHVnaW5zL3dlbGNvbWVzY3JlZW5cclxuICAgICAgICAgKi9cclxuICAgICAgICBzZWxmLmNsb3NlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoc3dpcGVyKSB7XHJcbiAgICAgICAgICAgICAgICBzd2lwZXIuZGVzdHJveSh0cnVlKTsgfVxyXG4gICAgICAgICAgICBpZiAoY29udGFpbmVyKSB7IGNvbnRhaW5lci5yZW1vdmUoKTsgfVxyXG4gICAgICAgICAgICBjb250YWluZXIgPSBzd2lwZXJDb250YWluZXIgPSBzd2lwZXIgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5vbkNsb3NlZCA9PT0gJ2Z1bmN0aW9uJykgeyBvcHRpb25zLm9uQ2xvc2VkKCk7IH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBTaG93cyB0aGUgbmV4dCBzbGlkZVxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogQHB1YmxpY1xyXG4gICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6RnJhbWV3b3JrNy9wcm90b3R5cGUvcGx1Z2lucy93ZWxjb21lc2NyZWVuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2VsZi5uZXh0ID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICBpZiAoc3dpcGVyKSB7IHN3aXBlci5zbGlkZU5leHQoKTsgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8qKlxyXG4gICAgICAgICAqIFNob3dzIHRoZSBwcmV2aW91cyBzbGlkZVxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogQHB1YmxpY1xyXG4gICAgICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6RnJhbWV3b3JrNy9wcm90b3R5cGUvcGx1Z2lucy93ZWxjb21lc2NyZWVuXHJcbiAgICAgICAgICovXHJcbiAgICAgICAgc2VsZi5wcmV2aW91cyA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgaWYgKHN3aXBlcikgeyBzd2lwZXIuc2xpZGVQcmV2KCk7IH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBHb2VzIHRvIHRoZSBkZXNpcmVkIHNsaWRlXHJcbiAgICAgICAgICpcclxuICAgICAgICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggVGhlIHNsaWRlIHRvIHNob3dcclxuICAgICAgICAgKiBAcHVibGljXHJcbiAgICAgICAgICogQG1lbWJlcm9mIG1vZHVsZTpGcmFtZXdvcms3L3Byb3RvdHlwZS9wbHVnaW5zL3dlbGNvbWVzY3JlZW5cclxuICAgICAgICAgKi9cclxuICAgICAgICBzZWxmLnNsaWRlVG8gPSBmdW5jdGlvbiAoaW5kZXgpIHtcclxuICAgICAgICAgICAgaWYgKHN3aXBlcikgeyBzd2lwZXIuc2xpZGVUbyhpbmRleCk7IH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBJbml0aWFsaXplIHRoZSBpbnN0YW5jZVxyXG4gICAgICAgICAqXHJcbiAgICAgICAgICogQG1ldGhvZCBpbml0XHJcbiAgICAgICAgICovXHJcbiAgICAgICAgKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgZGVmaW5lRGVmYXVsdFRlbXBsYXRlKCk7XHJcbiAgICAgICAgICAgIGNvbXBpbGVUZW1wbGF0ZSgpO1xyXG4gICAgICAgICAgICBhcHBseU9wdGlvbnMoKTtcclxuXHJcbiAgICAgICAgICAgIC8vIE9wZW4gb24gaW5pdFxyXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5vcGVuKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLm9wZW4oKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9KCkpO1xyXG5cclxuICAgICAgICAvLyBSZXR1cm4gaW5zdGFuY2VcclxuICAgICAgICByZXR1cm4gc2VsZjtcclxuICAgIH07XHJcblxyXG4gICAgYXBwLndlbGNvbWVzY3JlZW4gPSBmdW5jdGlvbiAoc2xpZGVzLCBvcHRpb25zKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBXZWxjb21lc2NyZWVuKHNsaWRlcywgb3B0aW9ucyk7XHJcbiAgICB9O1xyXG5cclxufTtcclxubW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgICB3ZWxjb21lc2NyZWVuX3BsdWdpbiA6IEZyYW1ld29yazcucHJvdG90eXBlLnBsdWdpbnMud2VsY29tZXNjcmVlblxyXG59OyIsIi8qKlxuICogRnJhbWV3b3JrNyAxLjQuMlxuICogRnVsbCBGZWF0dXJlZCBNb2JpbGUgSFRNTCBGcmFtZXdvcmsgRm9yIEJ1aWxkaW5nIGlPUyAmIEFuZHJvaWQgQXBwc1xuICogXG4gKiBodHRwOi8vd3d3LmlkYW5nZXJvLnVzL2ZyYW1ld29yazdcbiAqIFxuICogQ29weXJpZ2h0IDIwMTYsIFZsYWRpbWlyIEtoYXJsYW1waWRpXG4gKiBUaGUgaURhbmdlcm8udXNcbiAqIGh0dHA6Ly93d3cuaWRhbmdlcm8udXMvXG4gKiBcbiAqIExpY2Vuc2VkIHVuZGVyIE1JVFxuICogXG4gKiBSZWxlYXNlZCBvbjogRmVicnVhcnkgMjcsIDIwMTZcbiAqL1xuKGZ1bmN0aW9uICgpIHtcblxuICAgICd1c2Ugc3RyaWN0JztcbiAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIEZyYW1ld29yayA3XG4gICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICB3aW5kb3cuRnJhbWV3b3JrNyA9IGZ1bmN0aW9uIChwYXJhbXMpIHtcbiAgICAgICAgLy8gQXBwXG4gICAgICAgIHZhciBhcHAgPSB0aGlzO1xuICAgIFxuICAgICAgICAvLyBWZXJzaW9uXG4gICAgICAgIGFwcC52ZXJzaW9uID0gJzEuNC4yJztcbiAgICBcbiAgICAgICAgLy8gRGVmYXVsdCBQYXJhbWV0ZXJzXG4gICAgICAgIGFwcC5wYXJhbXMgPSB7XG4gICAgICAgICAgICBjYWNoZTogdHJ1ZSxcbiAgICAgICAgICAgIGNhY2hlSWdub3JlOiBbXSxcbiAgICAgICAgICAgIGNhY2hlSWdub3JlR2V0UGFyYW1ldGVyczogZmFsc2UsXG4gICAgICAgICAgICBjYWNoZUR1cmF0aW9uOiAxMDAwICogNjAgKiAxMCwgLy8gVGVuIG1pbnV0ZXNcbiAgICAgICAgICAgIHByZWxvYWRQcmV2aW91c1BhZ2U6IHRydWUsXG4gICAgICAgICAgICB1bmlxdWVIaXN0b3J5OiBmYWxzZSxcbiAgICAgICAgICAgIHVuaXF1ZUhpc3RvcnlJZ25vcmVHZXRQYXJhbWV0ZXJzOiBmYWxzZSxcbiAgICAgICAgICAgIGR5bmFtaWNQYWdlVXJsOiAnY29udGVudC17e2luZGV4fX0nLFxuICAgICAgICAgICAgYWxsb3dEdXBsaWNhdGVVcmxzOiBmYWxzZSxcbiAgICAgICAgICAgIHJvdXRlcjogdHJ1ZSxcbiAgICAgICAgICAgIC8vIFB1c2ggU3RhdGVcbiAgICAgICAgICAgIHB1c2hTdGF0ZTogZmFsc2UsXG4gICAgICAgICAgICBwdXNoU3RhdGVSb290OiB1bmRlZmluZWQsXG4gICAgICAgICAgICBwdXNoU3RhdGVOb0FuaW1hdGlvbjogZmFsc2UsXG4gICAgICAgICAgICBwdXNoU3RhdGVTZXBhcmF0b3I6ICcjIS8nLFxuICAgICAgICAgICAgcHVzaFN0YXRlT25Mb2FkOiB0cnVlLFxuICAgICAgICAgICAgLy8gRmFzdCBjbGlja3NcbiAgICAgICAgICAgIGZhc3RDbGlja3M6IHRydWUsXG4gICAgICAgICAgICBmYXN0Q2xpY2tzRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLFxuICAgICAgICAgICAgZmFzdENsaWNrc0RlbGF5QmV0d2VlbkNsaWNrczogNTAsXG4gICAgICAgICAgICAvLyBUYXAgSG9sZFxuICAgICAgICAgICAgdGFwSG9sZDogZmFsc2UsXG4gICAgICAgICAgICB0YXBIb2xkRGVsYXk6IDc1MCxcbiAgICAgICAgICAgIHRhcEhvbGRQcmV2ZW50Q2xpY2tzOiB0cnVlLFxuICAgICAgICAgICAgLy8gQWN0aXZlIFN0YXRlXG4gICAgICAgICAgICBhY3RpdmVTdGF0ZTogdHJ1ZSxcbiAgICAgICAgICAgIGFjdGl2ZVN0YXRlRWxlbWVudHM6ICdhLCBidXR0b24sIGxhYmVsLCBzcGFuJyxcbiAgICAgICAgICAgIC8vIEFuaW1hdGUgTmF2IEJhY2sgSWNvblxuICAgICAgICAgICAgYW5pbWF0ZU5hdkJhY2tJY29uOiBmYWxzZSxcbiAgICAgICAgICAgIC8vIFN3aXBlIEJhY2tcbiAgICAgICAgICAgIHN3aXBlQmFja1BhZ2U6IHRydWUsXG4gICAgICAgICAgICBzd2lwZUJhY2tQYWdlVGhyZXNob2xkOiAwLFxuICAgICAgICAgICAgc3dpcGVCYWNrUGFnZUFjdGl2ZUFyZWE6IDMwLFxuICAgICAgICAgICAgc3dpcGVCYWNrUGFnZUFuaW1hdGVTaGFkb3c6IHRydWUsXG4gICAgICAgICAgICBzd2lwZUJhY2tQYWdlQW5pbWF0ZU9wYWNpdHk6IHRydWUsXG4gICAgICAgICAgICAvLyBBamF4XG4gICAgICAgICAgICBhamF4TGlua3M6IHVuZGVmaW5lZCwgLy8gb3IgQ1NTIHNlbGVjdG9yXG4gICAgICAgICAgICAvLyBFeHRlcm5hbCBMaW5rc1xuICAgICAgICAgICAgZXh0ZXJuYWxMaW5rczogJy5leHRlcm5hbCcsIC8vIENTUyBzZWxlY3RvclxuICAgICAgICAgICAgLy8gU29ydGFibGVcbiAgICAgICAgICAgIHNvcnRhYmxlOiB0cnVlLFxuICAgICAgICAgICAgLy8gU2Nyb2xsIHRvb2xiYXJzXG4gICAgICAgICAgICBoaWRlTmF2YmFyT25QYWdlU2Nyb2xsOiBmYWxzZSxcbiAgICAgICAgICAgIGhpZGVUb29sYmFyT25QYWdlU2Nyb2xsOiBmYWxzZSxcbiAgICAgICAgICAgIGhpZGVUYWJiYXJPblBhZ2VTY3JvbGw6IGZhbHNlLFxuICAgICAgICAgICAgc2hvd0JhcnNPblBhZ2VTY3JvbGxFbmQ6IHRydWUsXG4gICAgICAgICAgICBzaG93QmFyc09uUGFnZVNjcm9sbFRvcDogdHJ1ZSxcbiAgICAgICAgICAgIC8vIFN3aXBlb3V0XG4gICAgICAgICAgICBzd2lwZW91dDogdHJ1ZSxcbiAgICAgICAgICAgIHN3aXBlb3V0QWN0aW9uc05vRm9sZDogZmFsc2UsXG4gICAgICAgICAgICBzd2lwZW91dE5vRm9sbG93OiBmYWxzZSxcbiAgICAgICAgICAgIC8vIFNtYXJ0IFNlbGVjdCBCYWNrIGxpbmsgdGVtcGxhdGVcbiAgICAgICAgICAgIHNtYXJ0U2VsZWN0T3BlbkluOiAncGFnZScsIC8vIG9yICdwb3B1cCcgb3IgJ3BpY2tlcidcbiAgICAgICAgICAgIHNtYXJ0U2VsZWN0QmFja1RleHQ6ICdCYWNrJyxcbiAgICAgICAgICAgIHNtYXJ0U2VsZWN0UG9wdXBDbG9zZVRleHQ6ICdDbG9zZScsXG4gICAgICAgICAgICBzbWFydFNlbGVjdFBpY2tlckNsb3NlVGV4dDogJ0RvbmUnLFxuICAgICAgICAgICAgc21hcnRTZWxlY3RTZWFyY2hiYXI6IGZhbHNlLFxuICAgICAgICAgICAgc21hcnRTZWxlY3RCYWNrT25TZWxlY3Q6IGZhbHNlLFxuICAgICAgICAgICAgLy8gVGFwIE5hdmJhciBvciBTdGF0dXNiYXIgdG8gc2Nyb2xsIHRvIHRvcFxuICAgICAgICAgICAgc2Nyb2xsVG9wT25OYXZiYXJDbGljazogZmFsc2UsXG4gICAgICAgICAgICBzY3JvbGxUb3BPblN0YXR1c2JhckNsaWNrOiBmYWxzZSxcbiAgICAgICAgICAgIC8vIFBhbmVsc1xuICAgICAgICAgICAgc3dpcGVQYW5lbDogZmFsc2UsIC8vIG9yICdsZWZ0JyBvciAncmlnaHQnXG4gICAgICAgICAgICBzd2lwZVBhbmVsQWN0aXZlQXJlYTogMCxcbiAgICAgICAgICAgIHN3aXBlUGFuZWxDbG9zZU9wcG9zaXRlOiB0cnVlLFxuICAgICAgICAgICAgc3dpcGVQYW5lbE9ubHlDbG9zZTogZmFsc2UsXG4gICAgICAgICAgICBzd2lwZVBhbmVsTm9Gb2xsb3c6IGZhbHNlLFxuICAgICAgICAgICAgc3dpcGVQYW5lbFRocmVzaG9sZDogMCxcbiAgICAgICAgICAgIHBhbmVsc0Nsb3NlQnlPdXRzaWRlOiB0cnVlLFxuICAgICAgICAgICAgLy8gTW9kYWxzXG4gICAgICAgICAgICBtb2RhbEJ1dHRvbk9rOiAnT0snLFxuICAgICAgICAgICAgbW9kYWxCdXR0b25DYW5jZWw6ICdDYW5jZWwnLFxuICAgICAgICAgICAgbW9kYWxVc2VybmFtZVBsYWNlaG9sZGVyOiAnVXNlcm5hbWUnLFxuICAgICAgICAgICAgbW9kYWxQYXNzd29yZFBsYWNlaG9sZGVyOiAnUGFzc3dvcmQnLFxuICAgICAgICAgICAgbW9kYWxUaXRsZTogJ0ZyYW1ld29yazcnLFxuICAgICAgICAgICAgbW9kYWxDbG9zZUJ5T3V0c2lkZTogZmFsc2UsXG4gICAgICAgICAgICBhY3Rpb25zQ2xvc2VCeU91dHNpZGU6IHRydWUsXG4gICAgICAgICAgICBwb3B1cENsb3NlQnlPdXRzaWRlOiB0cnVlLFxuICAgICAgICAgICAgbW9kYWxQcmVsb2FkZXJUaXRsZTogJ0xvYWRpbmcuLi4gJyxcbiAgICAgICAgICAgIG1vZGFsU3RhY2s6IHRydWUsXG4gICAgICAgICAgICAvLyBMYXp5IExvYWRcbiAgICAgICAgICAgIGltYWdlc0xhenlMb2FkVGhyZXNob2xkOiAwLFxuICAgICAgICAgICAgaW1hZ2VzTGF6eUxvYWRTZXF1ZW50aWFsOiB0cnVlLFxuICAgICAgICAgICAgLy8gTmFtZSBzcGFjZVxuICAgICAgICAgICAgdmlld0NsYXNzOiAndmlldycsXG4gICAgICAgICAgICB2aWV3TWFpbkNsYXNzOiAndmlldy1tYWluJyxcbiAgICAgICAgICAgIHZpZXdzQ2xhc3M6ICd2aWV3cycsXG4gICAgICAgICAgICAvLyBOb3RpZmljYXRpb25zIGRlZmF1bHRzXG4gICAgICAgICAgICBub3RpZmljYXRpb25DbG9zZU9uQ2xpY2s6IGZhbHNlLFxuICAgICAgICAgICAgbm90aWZpY2F0aW9uQ2xvc2VJY29uOiB0cnVlLFxuICAgICAgICAgICAgbm90aWZpY2F0aW9uQ2xvc2VCdXR0b25UZXh0OiAnQ2xvc2UnLFxuICAgICAgICAgICAgLy8gQW5pbWF0ZSBQYWdlc1xuICAgICAgICAgICAgYW5pbWF0ZVBhZ2VzOiB0cnVlLFxuICAgICAgICAgICAgLy8gVGVtcGxhdGU3XG4gICAgICAgICAgICB0ZW1wbGF0ZXM6IHt9LFxuICAgICAgICAgICAgdGVtcGxhdGU3RGF0YToge30sXG4gICAgICAgICAgICB0ZW1wbGF0ZTdQYWdlczogZmFsc2UsXG4gICAgICAgICAgICBwcmVjb21waWxlVGVtcGxhdGVzOiBmYWxzZSxcbiAgICAgICAgICAgIC8vIE1hdGVyaWFsXG4gICAgICAgICAgICBtYXRlcmlhbDogZmFsc2UsXG4gICAgICAgICAgICBtYXRlcmlhbFBhZ2VMb2FkRGVsYXk6IDAsXG4gICAgICAgICAgICBtYXRlcmlhbFByZWxvYWRlclN2ZzogJzxzdmcgeG1sbnM9XCJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Z1wiIGhlaWdodD1cIjc1XCIgd2lkdGg9XCI3NVwiIHZpZXdib3g9XCIwIDAgNzUgNzVcIj48Y2lyY2xlIGN4PVwiMzcuNVwiIGN5PVwiMzcuNVwiIHI9XCIzMy41XCIgc3Ryb2tlLXdpZHRoPVwiOFwiLz48L3N2Zz4nLFxuICAgICAgICAgICAgbWF0ZXJpYWxQcmVsb2FkZXJIdG1sOlxuICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz1cInByZWxvYWRlci1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAnPHNwYW4gY2xhc3M9XCJwcmVsb2FkZXItaW5uZXItZ2FwXCI+PC9zcGFuPicgK1xuICAgICAgICAgICAgICAgICAgICAnPHNwYW4gY2xhc3M9XCJwcmVsb2FkZXItaW5uZXItbGVmdFwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPVwicHJlbG9hZGVyLWlubmVyLWhhbGYtY2lyY2xlXCI+PC9zcGFuPicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9zcGFuPicgK1xuICAgICAgICAgICAgICAgICAgICAnPHNwYW4gY2xhc3M9XCJwcmVsb2FkZXItaW5uZXItcmlnaHRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz1cInByZWxvYWRlci1pbm5lci1oYWxmLWNpcmNsZVwiPjwvc3Bhbj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvc3Bhbj4nICtcbiAgICAgICAgICAgICAgICAnPC9zcGFuPicsXG4gICAgICAgICAgICBtYXRlcmlhbFJpcHBsZTogdHJ1ZSxcbiAgICAgICAgICAgIG1hdGVyaWFsUmlwcGxlRWxlbWVudHM6ICcucmlwcGxlLCBhLmxpbmssIGEuaXRlbS1saW5rLCAuYnV0dG9uLCAubW9kYWwtYnV0dG9uLCAudGFiLWxpbmssIC5sYWJlbC1yYWRpbywgLmxhYmVsLWNoZWNrYm94LCAuYWN0aW9ucy1tb2RhbC1idXR0b24sIGEuc2VhcmNoYmFyLWNsZWFyLCBhLmZsb2F0aW5nLWJ1dHRvbiwgLmZsb2F0aW5nLWJ1dHRvbiA+IGEsIC5zcGVlZC1kaWFsLWJ1dHRvbnMgYScsXG4gICAgICAgICAgICAvLyBBdXRvIGluaXRcbiAgICAgICAgICAgIGluaXQ6IHRydWUsXG4gICAgICAgIH07XG4gICAgXG4gICAgICAgIC8vIEV4dGVuZCBkZWZhdWx0cyB3aXRoIHBhcmFtZXRlcnNcbiAgICAgICAgZm9yICh2YXIgcGFyYW0gaW4gcGFyYW1zKSB7XG4gICAgICAgICAgICBhcHAucGFyYW1zW3BhcmFtXSA9IHBhcmFtc1twYXJhbV07XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgLy8gRE9NIGxpYlxuICAgICAgICB2YXIgJCA9IERvbTc7XG4gICAgXG4gICAgICAgIC8vIFRlbXBsYXRlNyBsaWJcbiAgICAgICAgdmFyIHQ3ID0gVGVtcGxhdGU3O1xuICAgICAgICBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzID0ge307XG4gICAgXG4gICAgICAgIC8vIFRvdWNoIGV2ZW50c1xuICAgICAgICBhcHAudG91Y2hFdmVudHMgPSB7XG4gICAgICAgICAgICBzdGFydDogYXBwLnN1cHBvcnQudG91Y2ggPyAndG91Y2hzdGFydCcgOiAnbW91c2Vkb3duJyxcbiAgICAgICAgICAgIG1vdmU6IGFwcC5zdXBwb3J0LnRvdWNoID8gJ3RvdWNobW92ZScgOiAnbW91c2Vtb3ZlJyxcbiAgICAgICAgICAgIGVuZDogYXBwLnN1cHBvcnQudG91Y2ggPyAndG91Y2hlbmQnIDogJ21vdXNldXAnXG4gICAgICAgIH07XG4gICAgXG4gICAgICAgIC8vIExpbmsgdG8gbG9jYWwgc3RvcmFnZVxuICAgICAgICBhcHAubHMgPSB3aW5kb3cubG9jYWxTdG9yYWdlO1xuICAgIFxuICAgICAgICAvLyBSVExcbiAgICAgICAgYXBwLnJ0bCA9ICQoJ2JvZHknKS5jc3MoJ2RpcmVjdGlvbicpID09PSAncnRsJztcbiAgICAgICAgaWYgKGFwcC5ydGwpICQoJ2h0bWwnKS5hdHRyKCdkaXInLCAncnRsJyk7XG4gICAgXG4gICAgICAgIC8vIE92ZXJ3cml0ZSBzdGF0dXNiYXIgb3ZlcmxheVxuICAgICAgICBpZiAodHlwZW9mIGFwcC5wYXJhbXMuc3RhdHVzYmFyT3ZlcmxheSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnN0YXR1c2Jhck92ZXJsYXkpICQoJ2h0bWwnKS5hZGRDbGFzcygnd2l0aC1zdGF0dXNiYXItb3ZlcmxheScpO1xuICAgICAgICAgICAgZWxzZSAkKCdodG1sJykucmVtb3ZlQ2xhc3MoJ3dpdGgtc3RhdHVzYmFyLW92ZXJsYXknKTtcbiAgICAgICAgfVxuICAgIFxuICAgICAgICBcbiAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBWaWV3cyAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAudmlld3MgPSBbXTtcbiAgICAgICAgdmFyIFZpZXcgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIHBhcmFtcykge1xuICAgICAgICAgICAgdmFyIGRlZmF1bHRzID0ge1xuICAgICAgICAgICAgICAgIGR5bmFtaWNOYXZiYXI6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGRvbUNhY2hlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBsaW5rc1ZpZXc6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICByZWxvYWRQYWdlczogZmFsc2UsXG4gICAgICAgICAgICAgICAgdW5pcXVlSGlzdG9yeTogYXBwLnBhcmFtcy51bmlxdWVIaXN0b3J5LFxuICAgICAgICAgICAgICAgIHVuaXF1ZUhpc3RvcnlJZ25vcmVHZXRQYXJhbWV0ZXJzOiBhcHAucGFyYW1zLnVuaXF1ZUhpc3RvcnlJZ25vcmVHZXRQYXJhbWV0ZXJzLFxuICAgICAgICAgICAgICAgIGFsbG93RHVwbGljYXRlVXJsczogYXBwLnBhcmFtcy5hbGxvd0R1cGxpY2F0ZVVybHMsXG4gICAgICAgICAgICAgICAgc3dpcGVCYWNrUGFnZTogYXBwLnBhcmFtcy5zd2lwZUJhY2tQYWdlLFxuICAgICAgICAgICAgICAgIHN3aXBlQmFja1BhZ2VBbmltYXRlU2hhZG93OiBhcHAucGFyYW1zLnN3aXBlQmFja1BhZ2VBbmltYXRlU2hhZG93LFxuICAgICAgICAgICAgICAgIHN3aXBlQmFja1BhZ2VBbmltYXRlT3BhY2l0eTogYXBwLnBhcmFtcy5zd2lwZUJhY2tQYWdlQW5pbWF0ZU9wYWNpdHksXG4gICAgICAgICAgICAgICAgc3dpcGVCYWNrUGFnZUFjdGl2ZUFyZWE6IGFwcC5wYXJhbXMuc3dpcGVCYWNrUGFnZUFjdGl2ZUFyZWEsXG4gICAgICAgICAgICAgICAgc3dpcGVCYWNrUGFnZVRocmVzaG9sZDogYXBwLnBhcmFtcy5zd2lwZUJhY2tQYWdlVGhyZXNob2xkLFxuICAgICAgICAgICAgICAgIGFuaW1hdGVQYWdlczogYXBwLnBhcmFtcy5hbmltYXRlUGFnZXMsXG4gICAgICAgICAgICAgICAgcHJlbG9hZFByZXZpb3VzUGFnZTogYXBwLnBhcmFtcy5wcmVsb2FkUHJldmlvdXNQYWdlXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdmFyIGk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUGFyYW1zXG4gICAgICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGlzYWJsZSBkeW5hbWljIG5hdmJhciBmb3IgbWF0ZXJpYWwgdGhlbWVcbiAgICAgICAgICAgIGlmIChwYXJhbXMuZHluYW1pY05hdmJhciAmJiBhcHAucGFyYW1zLm1hdGVyaWFsKSBwYXJhbXMuZHluYW1pY05hdmJhciA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEV4dGVuZCBwYXJhbXMgd2l0aCBkZWZhdWx0c1xuICAgICAgICAgICAgZm9yICh2YXIgZGVmIGluIGRlZmF1bHRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXNbZGVmXSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zW2RlZl0gPSBkZWZhdWx0c1tkZWZdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIFZpZXdcbiAgICAgICAgICAgIHZhciB2aWV3ID0gdGhpcztcbiAgICAgICAgICAgIHZpZXcucGFyYW1zID0gcGFyYW1zO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNlbGVjdG9yXG4gICAgICAgICAgICB2aWV3LnNlbGVjdG9yID0gc2VsZWN0b3I7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ29udGFpbmVyXG4gICAgICAgICAgICB2YXIgY29udGFpbmVyID0gJChzZWxlY3Rvcik7XG4gICAgICAgICAgICB2aWV3LmNvbnRhaW5lciA9IGNvbnRhaW5lclswXTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBGaXggU2VsZWN0b3JcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAodHlwZW9mIHNlbGVjdG9yICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIC8vIFN1cHBvc2VkIHRvIGJlIEhUTUxFbGVtZW50IG9yIERvbTdcbiAgICAgICAgICAgICAgICBzZWxlY3RvciA9IChjb250YWluZXIuYXR0cignaWQnKSA/ICcjJyArIGNvbnRhaW5lci5hdHRyKCdpZCcpIDogJycpICsgKGNvbnRhaW5lci5hdHRyKCdjbGFzcycpID8gJy4nICsgY29udGFpbmVyLmF0dHIoJ2NsYXNzJykucmVwbGFjZSgvIC9nLCAnLicpLnJlcGxhY2UoJy5hY3RpdmUnLCAnJykgOiAnJyk7XG4gICAgICAgICAgICAgICAgdmlldy5zZWxlY3RvciA9IHNlbGVjdG9yO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIElzIG1haW5cbiAgICAgICAgICAgIHZpZXcubWFpbiA9IGNvbnRhaW5lci5oYXNDbGFzcyhhcHAucGFyYW1zLnZpZXdNYWluQ2xhc3MpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIENvbnRlbnQgY2FjaGVcbiAgICAgICAgICAgIHZpZXcuY29udGVudENhY2hlID0ge307XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUGFnZXMgY2FjaGVcbiAgICAgICAgICAgIHZpZXcucGFnZXNDYWNoZSA9IHt9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFN0b3JlIFZpZXcgaW4gZWxlbWVudCBmb3IgZWFzeSBhY2Nlc3NcbiAgICAgICAgICAgIGNvbnRhaW5lclswXS5mN1ZpZXcgPSB2aWV3O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBhZ2VzXG4gICAgICAgICAgICB2aWV3LnBhZ2VzQ29udGFpbmVyID0gY29udGFpbmVyLmZpbmQoJy5wYWdlcycpWzBdO1xuICAgICAgICAgICAgdmlldy5pbml0aWFsUGFnZXMgPSBbXTtcbiAgICAgICAgICAgIHZpZXcuaW5pdGlhbFBhZ2VzVXJsID0gW107XG4gICAgICAgICAgICB2aWV3LmluaXRpYWxOYXZiYXJzID0gW107XG4gICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuZG9tQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgaW5pdGlhbFBhZ2VzID0gY29udGFpbmVyLmZpbmQoJy5wYWdlJyk7XG4gICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGluaXRpYWxQYWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2aWV3LmluaXRpYWxQYWdlcy5wdXNoKGluaXRpYWxQYWdlc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuaW5pdGlhbFBhZ2VzVXJsLnB1c2goJyMnICsgaW5pdGlhbFBhZ2VzLmVxKGkpLmF0dHIoJ2RhdGEtcGFnZScpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGluaXRpYWxOYXZiYXJzID0gY29udGFpbmVyLmZpbmQoJy5uYXZiYXItaW5uZXInKTtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGluaXRpYWxOYXZiYXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2aWV3LmluaXRpYWxOYXZiYXJzLnB1c2goaW5pdGlhbE5hdmJhcnNbaV0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gTG9jYXRpb25cbiAgICAgICAgICAgIHZhciBkb2NMb2NhdGlvbiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSGlzdG9yeVxuICAgICAgICAgICAgdmlldy5oaXN0b3J5ID0gW107XG4gICAgICAgICAgICB2YXIgdmlld1VSTCA9IGRvY0xvY2F0aW9uO1xuICAgICAgICAgICAgdmFyIHB1c2hTdGF0ZVNlcGFyYXRvciA9IGFwcC5wYXJhbXMucHVzaFN0YXRlU2VwYXJhdG9yO1xuICAgICAgICAgICAgdmFyIHB1c2hTdGF0ZVJvb3QgPSBhcHAucGFyYW1zLnB1c2hTdGF0ZVJvb3Q7XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5wdXNoU3RhdGUgJiYgdmlldy5tYWluKSB7XG4gICAgICAgICAgICAgICAgaWYgKHB1c2hTdGF0ZVJvb3QpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlld1VSTCA9IHB1c2hTdGF0ZVJvb3Q7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAodmlld1VSTC5pbmRleE9mKHB1c2hTdGF0ZVNlcGFyYXRvcikgPj0gMCAmJiB2aWV3VVJMLmluZGV4T2YocHVzaFN0YXRlU2VwYXJhdG9yICsgJyMnKSA8IDApIHZpZXdVUkwgPSB2aWV3VVJMLnNwbGl0KHB1c2hTdGF0ZVNlcGFyYXRvcilbMF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBBY3RpdmUgUGFnZVxuICAgICAgICAgICAgdmFyIGN1cnJlbnRQYWdlLCBjdXJyZW50UGFnZURhdGE7XG4gICAgICAgICAgICBpZiAoIXZpZXcuYWN0aXZlUGFnZSkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRQYWdlID0gJCh2aWV3LnBhZ2VzQ29udGFpbmVyKS5maW5kKCcucGFnZS1vbi1jZW50ZXInKTtcbiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFBhZ2UubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRQYWdlID0gJCh2aWV3LnBhZ2VzQ29udGFpbmVyKS5maW5kKCcucGFnZTpub3QoLmNhY2hlZCknKTtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBhZ2UgPSBjdXJyZW50UGFnZS5lcShjdXJyZW50UGFnZS5sZW5ndGggLSAxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRQYWdlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudFBhZ2VEYXRhID0gY3VycmVudFBhZ2VbMF0uZjdQYWdlRGF0YTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVmlldyBzdGFydHVwIFVSTFxuICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlICYmIGN1cnJlbnRQYWdlKSB7XG4gICAgICAgICAgICAgICAgdmlldy51cmwgPSBjb250YWluZXIuYXR0cignZGF0YS11cmwnKSB8fCB2aWV3LnBhcmFtcy51cmwgfHwgJyMnICsgY3VycmVudFBhZ2UuYXR0cignZGF0YS1wYWdlJyk7ICAgXG4gICAgICAgICAgICAgICAgdmlldy5wYWdlc0NhY2hlW3ZpZXcudXJsXSA9IGN1cnJlbnRQYWdlLmF0dHIoJ2RhdGEtcGFnZScpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB2aWV3LnVybCA9IGNvbnRhaW5lci5hdHRyKCdkYXRhLXVybCcpIHx8IHZpZXcucGFyYW1zLnVybCB8fCB2aWV3VVJMO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFVwZGF0ZSBjdXJyZW50IHBhZ2UgRGF0YVxuICAgICAgICAgICAgaWYgKGN1cnJlbnRQYWdlRGF0YSkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRQYWdlRGF0YS52aWV3ID0gdmlldztcbiAgICAgICAgICAgICAgICBjdXJyZW50UGFnZURhdGEudXJsID0gdmlldy51cmw7XG4gICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlICYmIHZpZXcucGFyYW1zLmR5bmFtaWNOYXZiYXIgJiYgIWN1cnJlbnRQYWdlRGF0YS5uYXZiYXJJbm5lckNvbnRhaW5lcikge1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50UGFnZURhdGEubmF2YmFySW5uZXJDb250YWluZXIgPSB2aWV3LmluaXRpYWxOYXZiYXJzW3ZpZXcuaW5pdGlhbFBhZ2VzLmluZGV4T2YoY3VycmVudFBhZ2VEYXRhLmNvbnRhaW5lcildO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2aWV3LmFjdGl2ZVBhZ2UgPSBjdXJyZW50UGFnZURhdGE7XG4gICAgICAgICAgICAgICAgY3VycmVudFBhZ2VbMF0uZjdQYWdlRGF0YSA9IGN1cnJlbnRQYWdlRGF0YTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTdG9yZSB0byBoaXN0b3J5IG1haW4gdmlldydzIHVybFxuICAgICAgICAgICAgaWYgKHZpZXcudXJsKSB7XG4gICAgICAgICAgICAgICAgdmlldy5oaXN0b3J5LnB1c2godmlldy51cmwpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFRvdWNoIGV2ZW50c1xuICAgICAgICAgICAgdmFyIGlzVG91Y2hlZCA9IGZhbHNlLFxuICAgICAgICAgICAgICAgIGlzTW92ZWQgPSBmYWxzZSxcbiAgICAgICAgICAgICAgICB0b3VjaGVzU3RhcnQgPSB7fSxcbiAgICAgICAgICAgICAgICBpc1Njcm9sbGluZyxcbiAgICAgICAgICAgICAgICBhY3RpdmVQYWdlID0gW10sXG4gICAgICAgICAgICAgICAgcHJldmlvdXNQYWdlID0gW10sXG4gICAgICAgICAgICAgICAgdmlld0NvbnRhaW5lcldpZHRoLFxuICAgICAgICAgICAgICAgIHRvdWNoZXNEaWZmLFxuICAgICAgICAgICAgICAgIGFsbG93Vmlld1RvdWNoTW92ZSA9IHRydWUsXG4gICAgICAgICAgICAgICAgdG91Y2hTdGFydFRpbWUsXG4gICAgICAgICAgICAgICAgYWN0aXZlTmF2YmFyID0gW10sXG4gICAgICAgICAgICAgICAgcHJldmlvdXNOYXZiYXIgPSBbXSxcbiAgICAgICAgICAgICAgICBhY3RpdmVOYXZFbGVtZW50cyxcbiAgICAgICAgICAgICAgICBwcmV2aW91c05hdkVsZW1lbnRzLFxuICAgICAgICAgICAgICAgIGFjdGl2ZU5hdkJhY2tJY29uLFxuICAgICAgICAgICAgICAgIHByZXZpb3VzTmF2QmFja0ljb24sXG4gICAgICAgICAgICAgICAgZHluYW1pY05hdmJhcixcbiAgICAgICAgICAgICAgICBwYWdlU2hhZG93LFxuICAgICAgICAgICAgICAgIGVsO1xuICAgICAgICBcbiAgICAgICAgICAgIHZpZXcuaGFuZGxlVG91Y2hTdGFydCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFhbGxvd1ZpZXdUb3VjaE1vdmUgfHwgIXZpZXcucGFyYW1zLnN3aXBlQmFja1BhZ2UgfHwgaXNUb3VjaGVkIHx8IGFwcC5zd2lwZW91dE9wZW5lZEVsIHx8ICF2aWV3LmFsbG93UGFnZUNoYW5nZSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlzU2Nyb2xsaW5nID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHRvdWNoZXNTdGFydC54ID0gZS50eXBlID09PSAndG91Y2hzdGFydCcgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBlLnBhZ2VYO1xuICAgICAgICAgICAgICAgIHRvdWNoZXNTdGFydC55ID0gZS50eXBlID09PSAndG91Y2hzdGFydCcgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgOiBlLnBhZ2VZO1xuICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRUaW1lID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICBkeW5hbWljTmF2YmFyID0gdmlldy5wYXJhbXMuZHluYW1pY05hdmJhciAmJiBjb250YWluZXIuZmluZCgnLm5hdmJhci1pbm5lcicpLmxlbmd0aCA+IDE7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIHZpZXcuaGFuZGxlVG91Y2hNb3ZlID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWlzVG91Y2hlZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHZhciBwYWdlWCA9IGUudHlwZSA9PT0gJ3RvdWNobW92ZScgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBlLnBhZ2VYO1xuICAgICAgICAgICAgICAgIHZhciBwYWdlWSA9IGUudHlwZSA9PT0gJ3RvdWNobW92ZScgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgOiBlLnBhZ2VZO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaXNTY3JvbGxpbmcgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzU2Nyb2xsaW5nID0gISEoaXNTY3JvbGxpbmcgfHwgTWF0aC5hYnMocGFnZVkgLSB0b3VjaGVzU3RhcnQueSkgPiBNYXRoLmFicyhwYWdlWCAtIHRvdWNoZXNTdGFydC54KSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChpc1Njcm9sbGluZyB8fCBlLmY3UHJldmVudFN3aXBlQmFjayB8fCBhcHAucHJldmVudFN3aXBlQmFjaykge1xuICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWlzTW92ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNhbmNlbCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAvLyBDYWxjIHZhbHVlcyBkdXJpbmcgZmlyc3QgbW92ZSBmaXJlZFxuICAgICAgICAgICAgICAgICAgICB2aWV3Q29udGFpbmVyV2lkdGggPSBjb250YWluZXIud2lkdGgoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9ICQoZS50YXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgc3dpcGVvdXQgPSB0YXJnZXQuaGFzQ2xhc3MoJ3N3aXBlb3V0JykgPyB0YXJnZXQgOiB0YXJnZXQucGFyZW50cygnLnN3aXBlb3V0Jyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzd2lwZW91dC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWFwcC5ydGwgJiYgc3dpcGVvdXQuZmluZCgnLnN3aXBlb3V0LWFjdGlvbnMtbGVmdCcpLmxlbmd0aCA+IDApIGNhbmNlbCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnJ0bCAmJiBzd2lwZW91dC5maW5kKCcuc3dpcGVvdXQtYWN0aW9ucy1yaWdodCcpLmxlbmd0aCA+IDApIGNhbmNlbCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYWN0aXZlUGFnZSA9IHRhcmdldC5pcygnLnBhZ2UnKSA/IHRhcmdldCA6IHRhcmdldC5wYXJlbnRzKCcucGFnZScpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aXZlUGFnZS5oYXNDbGFzcygnbm8tc3dpcGViYWNrJykpIGNhbmNlbCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHByZXZpb3VzUGFnZSA9IGNvbnRhaW5lci5maW5kKCcucGFnZS1vbi1sZWZ0Om5vdCguY2FjaGVkKScpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbm90RnJvbUJvcmRlciA9IHRvdWNoZXNTdGFydC54IC0gY29udGFpbmVyLm9mZnNldCgpLmxlZnQgPiB2aWV3LnBhcmFtcy5zd2lwZUJhY2tQYWdlQWN0aXZlQXJlYTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5ydGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vdEZyb21Cb3JkZXIgPSB0b3VjaGVzU3RhcnQueCA8IGNvbnRhaW5lci5vZmZzZXQoKS5sZWZ0IC0gY29udGFpbmVyWzBdLnNjcm9sbExlZnQgKyB2aWV3Q29udGFpbmVyV2lkdGggLSB2aWV3LnBhcmFtcy5zd2lwZUJhY2tQYWdlQWN0aXZlQXJlYTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vdEZyb21Cb3JkZXIgPSB0b3VjaGVzU3RhcnQueCAtIGNvbnRhaW5lci5vZmZzZXQoKS5sZWZ0ID4gdmlldy5wYXJhbXMuc3dpcGVCYWNrUGFnZUFjdGl2ZUFyZWE7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKG5vdEZyb21Cb3JkZXIpIGNhbmNlbCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c1BhZ2UubGVuZ3RoID09PSAwIHx8IGFjdGl2ZVBhZ2UubGVuZ3RoID09PSAwKSBjYW5jZWwgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2FuY2VsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLnN3aXBlQmFja1BhZ2VBbmltYXRlU2hhZG93ICYmICFhcHAuZGV2aWNlLmFuZHJvaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VTaGFkb3cgPSBhY3RpdmVQYWdlLmZpbmQoJy5zd2lwZWJhY2stcGFnZS1zaGFkb3cnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYWdlU2hhZG93Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VTaGFkb3cgPSAkKCc8ZGl2IGNsYXNzPVwic3dpcGViYWNrLXBhZ2Utc2hhZG93XCI+PC9kaXY+Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlUGFnZS5hcHBlbmQocGFnZVNoYWRvdyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVOYXZiYXIgPSBjb250YWluZXIuZmluZCgnLm5hdmJhci1vbi1jZW50ZXI6bm90KC5jYWNoZWQpJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05hdmJhciA9IGNvbnRhaW5lci5maW5kKCcubmF2YmFyLW9uLWxlZnQ6bm90KC5jYWNoZWQpJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVOYXZFbGVtZW50cyA9IGFjdGl2ZU5hdmJhci5maW5kKCcubGVmdCwgLmNlbnRlciwgLnJpZ2h0LCAuc3VibmF2YmFyLCAuZmFkaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05hdkVsZW1lbnRzID0gcHJldmlvdXNOYXZiYXIuZmluZCgnLmxlZnQsIC5jZW50ZXIsIC5yaWdodCwgLnN1Ym5hdmJhciwgLmZhZGluZycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuYW5pbWF0ZU5hdkJhY2tJY29uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlTmF2QmFja0ljb24gPSBhY3RpdmVOYXZiYXIuZmluZCgnLmxlZnQuc2xpZGluZyAuYmFjayAuaWNvbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmF2QmFja0ljb24gPSBwcmV2aW91c05hdmJhci5maW5kKCcubGVmdC5zbGlkaW5nIC5iYWNrIC5pY29uJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIENsb3NlL0hpZGUgQW55IFBpY2tlclxuICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLnBpY2tlci1tb2RhbC5tb2RhbC1pbicpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKCQoJy5waWNrZXItbW9kYWwubW9kYWwtaW4nKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZS5mN1ByZXZlbnRQYW5lbFN3aXBlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpc01vdmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFJUTCBpbnZlcnRlclxuICAgICAgICAgICAgICAgIHZhciBpbnZlcnRlciA9IGFwcC5ydGwgPyAtMSA6IDE7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFRvdWNoZXMgZGlmZlxuICAgICAgICAgICAgICAgIHRvdWNoZXNEaWZmID0gKHBhZ2VYIC0gdG91Y2hlc1N0YXJ0LnggLSB2aWV3LnBhcmFtcy5zd2lwZUJhY2tQYWdlVGhyZXNob2xkKSAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgIGlmICh0b3VjaGVzRGlmZiA8IDApIHRvdWNoZXNEaWZmID0gMDtcbiAgICAgICAgICAgICAgICB2YXIgcGVyY2VudGFnZSA9IHRvdWNoZXNEaWZmIC8gdmlld0NvbnRhaW5lcldpZHRoO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBTd2lwZSBCYWNrIENhbGxiYWNrXG4gICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrRGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgICAgcGVyY2VudGFnZTogcGVyY2VudGFnZSxcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZlUGFnZTogYWN0aXZlUGFnZVswXSxcbiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNQYWdlOiBwcmV2aW91c1BhZ2VbMF0sXG4gICAgICAgICAgICAgICAgICAgIGFjdGl2ZU5hdmJhcjogYWN0aXZlTmF2YmFyWzBdLFxuICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05hdmJhcjogcHJldmlvdXNOYXZiYXJbMF1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5vblN3aXBlQmFja01vdmUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5wYXJhbXMub25Td2lwZUJhY2tNb3ZlKGNhbGxiYWNrRGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnRhaW5lci50cmlnZ2VyKCdzd2lwZUJhY2tNb3ZlJywgY2FsbGJhY2tEYXRhKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gVHJhbnNmb3JtIHBhZ2VzXG4gICAgICAgICAgICAgICAgdmFyIGFjdGl2ZVBhZ2VUcmFuc2xhdGUgPSB0b3VjaGVzRGlmZiAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgIHZhciBwcmV2aW91c1BhZ2VUcmFuc2xhdGUgPSAodG91Y2hlc0RpZmYgLyA1IC0gdmlld0NvbnRhaW5lcldpZHRoIC8gNSkgKiBpbnZlcnRlcjtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5waXhlbFJhdGlvID09PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIGFjdGl2ZVBhZ2VUcmFuc2xhdGUgPSBNYXRoLnJvdW5kKGFjdGl2ZVBhZ2VUcmFuc2xhdGUpO1xuICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1BhZ2VUcmFuc2xhdGUgPSBNYXRoLnJvdW5kKHByZXZpb3VzUGFnZVRyYW5zbGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBhY3RpdmVQYWdlLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIGFjdGl2ZVBhZ2VUcmFuc2xhdGUgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5zd2lwZUJhY2tQYWdlQW5pbWF0ZVNoYWRvdyAmJiAhYXBwLmRldmljZS5hbmRyb2lkKSBwYWdlU2hhZG93WzBdLnN0eWxlLm9wYWNpdHkgPSAxIC0gMSAqIHBlcmNlbnRhZ2U7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHByZXZpb3VzUGFnZS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyBwcmV2aW91c1BhZ2VUcmFuc2xhdGUgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5zd2lwZUJhY2tQYWdlQW5pbWF0ZU9wYWNpdHkpIHByZXZpb3VzUGFnZVswXS5zdHlsZS5vcGFjaXR5ID0gMC45ICsgMC4xICogcGVyY2VudGFnZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gRHluYW1pYyBOYXZiYXJzIEFuaW1hdGlvblxuICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYWN0aXZlTmF2RWxlbWVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsID0gJChhY3RpdmVOYXZFbGVtZW50c1tpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVsLmlzKCcuc3VibmF2YmFyLnNsaWRpbmcnKSkgZWxbMF0uc3R5bGUub3BhY2l0eSA9ICgxIC0gcGVyY2VudGFnZSAqIDEuMyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxbMF0uY2xhc3NOYW1lLmluZGV4T2YoJ3NsaWRpbmcnKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGl2ZU5hdlRyYW5zbGF0ZSA9IHBlcmNlbnRhZ2UgKiBlbFswXS5mN05hdmJhclJpZ2h0T2Zmc2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLnBpeGVsUmF0aW8gPT09IDEpIGFjdGl2ZU5hdlRyYW5zbGF0ZSA9IE1hdGgucm91bmQoYWN0aXZlTmF2VHJhbnNsYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyBhY3RpdmVOYXZUcmFuc2xhdGUgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmFuaW1hdGVOYXZCYWNrSWNvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxbMF0uY2xhc3NOYW1lLmluZGV4T2YoJ2xlZnQnKSA+PSAwICYmIGFjdGl2ZU5hdkJhY2tJY29uLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZU5hdkJhY2tJY29uLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIC1hY3RpdmVOYXZUcmFuc2xhdGUgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwcmV2aW91c05hdkVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbCA9ICQocHJldmlvdXNOYXZFbGVtZW50c1tpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWVsLmlzKCcuc3VibmF2YmFyLnNsaWRpbmcnKSkgZWxbMF0uc3R5bGUub3BhY2l0eSA9IHBlcmNlbnRhZ2UgKiAxLjMgLSAwLjM7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxbMF0uY2xhc3NOYW1lLmluZGV4T2YoJ3NsaWRpbmcnKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzTmF2VHJhbnNsYXRlID0gZWxbMF0uZjdOYXZiYXJMZWZ0T2Zmc2V0ICogKDEgLSBwZXJjZW50YWdlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5waXhlbFJhdGlvID09PSAxKSBwcmV2aW91c05hdlRyYW5zbGF0ZSA9IE1hdGgucm91bmQocHJldmlvdXNOYXZUcmFuc2xhdGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHByZXZpb3VzTmF2VHJhbnNsYXRlICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hbmltYXRlTmF2QmFja0ljb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsWzBdLmNsYXNzTmFtZS5pbmRleE9mKCdsZWZ0JykgPj0gMCAmJiBwcmV2aW91c05hdkJhY2tJY29uLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmF2QmFja0ljb24udHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgLXByZXZpb3VzTmF2VHJhbnNsYXRlICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgdmlldy5oYW5kbGVUb3VjaEVuZCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFpc1RvdWNoZWQgfHwgIWlzTW92ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKHRvdWNoZXNEaWZmID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICQoW2FjdGl2ZVBhZ2VbMF0sIHByZXZpb3VzUGFnZVswXV0pLnRyYW5zZm9ybSgnJykuY3NzKHtvcGFjaXR5OiAnJywgYm94U2hhZG93OiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlTmF2RWxlbWVudHMudHJhbnNmb3JtKCcnKS5jc3Moe29wYWNpdHk6ICcnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05hdkVsZW1lbnRzLnRyYW5zZm9ybSgnJykuY3NzKHtvcGFjaXR5OiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGl2ZU5hdkJhY2tJY29uICYmIGFjdGl2ZU5hdkJhY2tJY29uLmxlbmd0aCA+IDApIGFjdGl2ZU5hdkJhY2tJY29uLnRyYW5zZm9ybSgnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOYXZCYWNrSWNvbiAmJiBhY3RpdmVOYXZCYWNrSWNvbi5sZW5ndGggPiAwKSBwcmV2aW91c05hdkJhY2tJY29uLnRyYW5zZm9ybSgnJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgdGltZURpZmYgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpIC0gdG91Y2hTdGFydFRpbWU7XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2VDaGFuZ2VkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgLy8gU3dpcGUgYmFjayB0byBwcmV2aW91cyBwYWdlXG4gICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICAgICAgdGltZURpZmYgPCAzMDAgJiYgdG91Y2hlc0RpZmYgPiAxMCB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgdGltZURpZmYgPj0gMzAwICYmIHRvdWNoZXNEaWZmID4gdmlld0NvbnRhaW5lcldpZHRoIC8gMlxuICAgICAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZlUGFnZS5yZW1vdmVDbGFzcygncGFnZS1vbi1jZW50ZXInKS5hZGRDbGFzcygncGFnZS1vbi1yaWdodCcpO1xuICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1BhZ2UucmVtb3ZlQ2xhc3MoJ3BhZ2Utb24tbGVmdCcpLmFkZENsYXNzKCdwYWdlLW9uLWNlbnRlcicpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlTmF2YmFyLnJlbW92ZUNsYXNzKCduYXZiYXItb24tY2VudGVyJykuYWRkQ2xhc3MoJ25hdmJhci1vbi1yaWdodCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNOYXZiYXIucmVtb3ZlQ2xhc3MoJ25hdmJhci1vbi1sZWZ0JykuYWRkQ2xhc3MoJ25hdmJhci1vbi1jZW50ZXInKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBwYWdlQ2hhbmdlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIFJlc2V0IGN1c3RvbSBzdHlsZXNcbiAgICAgICAgICAgICAgICAvLyBBZGQgdHJhbnNpdGlvbmluZyBjbGFzcyBmb3IgdHJhbnNpdGlvbi1kdXJhdGlvblxuICAgICAgICAgICAgICAgICQoW2FjdGl2ZVBhZ2VbMF0sIHByZXZpb3VzUGFnZVswXV0pLnRyYW5zZm9ybSgnJykuY3NzKHtvcGFjaXR5OiAnJywgYm94U2hhZG93OiAnJ30pLmFkZENsYXNzKCdwYWdlLXRyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICBhY3RpdmVOYXZFbGVtZW50cy5jc3Moe29wYWNpdHk6ICcnfSlcbiAgICAgICAgICAgICAgICAgICAgLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZSA9IHBhZ2VDaGFuZ2VkID8gdGhpcy5mN05hdmJhclJpZ2h0T2Zmc2V0IDogMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGlkaW5nID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRpbmcudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgdHJhbnNsYXRlICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmFuaW1hdGVOYXZCYWNrSWNvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzbGlkaW5nLmhhc0NsYXNzKCdsZWZ0JykgJiYgYWN0aXZlTmF2QmFja0ljb24ubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVOYXZCYWNrSWNvbi5hZGRDbGFzcygncGFnZS10cmFuc2l0aW9uaW5nJykudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgLXRyYW5zbGF0ZSArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfSkuYWRkQ2xhc3MoJ3BhZ2UtdHJhbnNpdGlvbmluZycpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXNOYXZFbGVtZW50cy50cmFuc2Zvcm0oJycpLmNzcyh7b3BhY2l0eTogJyd9KS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2xhdGUgPSBwYWdlQ2hhbmdlZCA/IDAgOiB0aGlzLmY3TmF2YmFyTGVmdE9mZnNldDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGlkaW5nID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRpbmcudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgdHJhbnNsYXRlICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmFuaW1hdGVOYXZCYWNrSWNvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzbGlkaW5nLmhhc0NsYXNzKCdsZWZ0JykgJiYgcHJldmlvdXNOYXZCYWNrSWNvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmF2QmFja0ljb24uYWRkQ2xhc3MoJ3BhZ2UtdHJhbnNpdGlvbmluZycpLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIC10cmFuc2xhdGUgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSkuYWRkQ2xhc3MoJ3BhZ2UtdHJhbnNpdGlvbmluZycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBhbGxvd1ZpZXdUb3VjaE1vdmUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIC8vIFN3aXBlIEJhY2sgQ2FsbGJhY2tcbiAgICAgICAgICAgICAgICB2YXIgY2FsbGJhY2tEYXRhID0ge1xuICAgICAgICAgICAgICAgICAgICBhY3RpdmVQYWdlOiBhY3RpdmVQYWdlWzBdLFxuICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1BhZ2U6IHByZXZpb3VzUGFnZVswXSxcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZlTmF2YmFyOiBhY3RpdmVOYXZiYXJbMF0sXG4gICAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmF2YmFyOiBwcmV2aW91c05hdmJhclswXVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgaWYgKHBhZ2VDaGFuZ2VkKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBWaWV3J3MgVVJMXG4gICAgICAgICAgICAgICAgICAgIHZhciB1cmwgPSB2aWV3Lmhpc3Rvcnlbdmlldy5oaXN0b3J5Lmxlbmd0aCAtIDJdO1xuICAgICAgICAgICAgICAgICAgICB2aWV3LnVybCA9IHVybDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIFBhZ2UgYmVmb3JlIGFuaW1hdGlvbiBjYWxsYmFja1xuICAgICAgICAgICAgICAgICAgICBhcHAucGFnZUJhY2tDYWxsYmFjaygnYmVmb3JlJywgdmlldywge3BhZ2VDb250YWluZXI6IGFjdGl2ZVBhZ2VbMF0sIHVybDogdXJsLCBwb3NpdGlvbjogJ2NlbnRlcicsIG5ld1BhZ2U6IHByZXZpb3VzUGFnZSwgb2xkUGFnZTogYWN0aXZlUGFnZSwgc3dpcGVCYWNrOiB0cnVlfSk7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5wYWdlQW5pbUNhbGxiYWNrKCdiZWZvcmUnLCB2aWV3LCB7cGFnZUNvbnRhaW5lcjogcHJldmlvdXNQYWdlWzBdLCB1cmw6IHVybCwgcG9zaXRpb246ICdsZWZ0JywgbmV3UGFnZTogcHJldmlvdXNQYWdlLCBvbGRQYWdlOiBhY3RpdmVQYWdlLCBzd2lwZUJhY2s6IHRydWV9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5vblN3aXBlQmFja0JlZm9yZUNoYW5nZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmlldy5wYXJhbXMub25Td2lwZUJhY2tCZWZvcmVDaGFuZ2UoY2FsbGJhY2tEYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIudHJpZ2dlcignc3dpcGVCYWNrQmVmb3JlQ2hhbmdlJywgY2FsbGJhY2tEYXRhKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5vblN3aXBlQmFja0JlZm9yZVJlc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2aWV3LnBhcmFtcy5vblN3aXBlQmFja0JlZm9yZVJlc2V0KGNhbGxiYWNrRGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnRyaWdnZXIoJ3N3aXBlQmFja0JlZm9yZVJlc2V0JywgY2FsbGJhY2tEYXRhKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGFjdGl2ZVBhZ2UudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICQoW2FjdGl2ZVBhZ2VbMF0sIHByZXZpb3VzUGFnZVswXV0pLnJlbW92ZUNsYXNzKCdwYWdlLXRyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZU5hdkVsZW1lbnRzLnJlbW92ZUNsYXNzKCdwYWdlLXRyYW5zaXRpb25pbmcnKS5jc3Moe29wYWNpdHk6ICcnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c05hdkVsZW1lbnRzLnJlbW92ZUNsYXNzKCdwYWdlLXRyYW5zaXRpb25pbmcnKS5jc3Moe29wYWNpdHk6ICcnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aXZlTmF2QmFja0ljb24gJiYgYWN0aXZlTmF2QmFja0ljb24ubGVuZ3RoID4gMCkgYWN0aXZlTmF2QmFja0ljb24ucmVtb3ZlQ2xhc3MoJ3BhZ2UtdHJhbnNpdGlvbmluZycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmF2QmFja0ljb24gJiYgcHJldmlvdXNOYXZCYWNrSWNvbi5sZW5ndGggPiAwKSBwcmV2aW91c05hdkJhY2tJY29uLnJlbW92ZUNsYXNzKCdwYWdlLXRyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBhbGxvd1ZpZXdUb3VjaE1vdmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYWdlQ2hhbmdlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMucHVzaFN0YXRlICYmIHZpZXcubWFpbikgaGlzdG9yeS5iYWNrKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBQYWdlIGFmdGVyIGFuaW1hdGlvbiBjYWxsYmFja1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnBhZ2VCYWNrQ2FsbGJhY2soJ2FmdGVyJywgdmlldywge3BhZ2VDb250YWluZXI6IGFjdGl2ZVBhZ2VbMF0sIHVybDogdXJsLCBwb3NpdGlvbjogJ2NlbnRlcicsIG5ld1BhZ2U6IHByZXZpb3VzUGFnZSwgb2xkUGFnZTogYWN0aXZlUGFnZSwgc3dpcGVCYWNrOiB0cnVlfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAucGFnZUFuaW1DYWxsYmFjaygnYWZ0ZXInLCB2aWV3LCB7cGFnZUNvbnRhaW5lcjogcHJldmlvdXNQYWdlWzBdLCB1cmw6IHVybCwgcG9zaXRpb246ICdsZWZ0JywgbmV3UGFnZTogcHJldmlvdXNQYWdlLCBvbGRQYWdlOiBhY3RpdmVQYWdlLCBzd2lwZUJhY2s6IHRydWV9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIuYWZ0ZXJCYWNrKHZpZXcsIGFjdGl2ZVBhZ2UsIHByZXZpb3VzUGFnZSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLm9uU3dpcGVCYWNrQWZ0ZXJDaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWV3LnBhcmFtcy5vblN3aXBlQmFja0FmdGVyQ2hhbmdlKGNhbGxiYWNrRGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIudHJpZ2dlcignc3dpcGVCYWNrQWZ0ZXJDaGFuZ2UnLCBjYWxsYmFja0RhdGEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLm9uU3dpcGVCYWNrQWZ0ZXJSZXNldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZXcucGFyYW1zLm9uU3dpcGVCYWNrQWZ0ZXJSZXNldChjYWxsYmFja0RhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnRyaWdnZXIoJ3N3aXBlQmFja0FmdGVyUmVzZXQnLCBjYWxsYmFja0RhdGEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYWdlU2hhZG93ICYmIHBhZ2VTaGFkb3cubGVuZ3RoID4gMCkgcGFnZVNoYWRvdy5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB2aWV3LmF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uIChkZXRhY2gpIHtcbiAgICAgICAgICAgICAgICB2YXIgYWN0aW9uID0gZGV0YWNoID8gJ29mZicgOiAnb24nO1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lclthY3Rpb25dKGFwcC50b3VjaEV2ZW50cy5zdGFydCwgdmlldy5oYW5kbGVUb3VjaFN0YXJ0KTtcbiAgICAgICAgICAgICAgICBjb250YWluZXJbYWN0aW9uXShhcHAudG91Y2hFdmVudHMubW92ZSwgdmlldy5oYW5kbGVUb3VjaE1vdmUpO1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lclthY3Rpb25dKGFwcC50b3VjaEV2ZW50cy5lbmQsIHZpZXcuaGFuZGxlVG91Y2hFbmQpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZpZXcuZGV0YWNoRXZlbnRzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZpZXcuYXR0YWNoRXZlbnRzKHRydWUpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0XG4gICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuc3dpcGVCYWNrUGFnZSAmJiAhYXBwLnBhcmFtcy5tYXRlcmlhbCkge1xuICAgICAgICAgICAgICAgIHZpZXcuYXR0YWNoRXZlbnRzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQWRkIHZpZXcgdG8gYXBwXG4gICAgICAgICAgICBhcHAudmlld3MucHVzaCh2aWV3KTtcbiAgICAgICAgICAgIGlmICh2aWV3Lm1haW4pIGFwcC5tYWluVmlldyA9IHZpZXc7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUm91dGVyIFxuICAgICAgICAgICAgdmlldy5yb3V0ZXIgPSB7XG4gICAgICAgICAgICAgICAgbG9hZDogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFwcC5yb3V0ZXIubG9hZCh2aWV3LCBvcHRpb25zKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGJhY2s6IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhcHAucm91dGVyLmJhY2sodmlldywgb3B0aW9ucyk7ICBcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIC8vIFNob3J0Y3V0c1xuICAgICAgICAgICAgICAgIGxvYWRQYWdlOiBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVybCA9IG9wdGlvbnM7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zID0ge307XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodXJsICYmIHVybC5pbmRleE9mKCcjJykgPT09IDAgJiYgdmlldy5wYXJhbXMuZG9tQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnBhZ2VOYW1lID0gdXJsLnNwbGl0KCcjJylbMV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIG9wdGlvbnMudXJsID0gdXJsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBhcHAucm91dGVyLmxvYWQodmlldywgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBsb2FkQ29udGVudDogZnVuY3Rpb24gKGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFwcC5yb3V0ZXIubG9hZCh2aWV3LCB7Y29udGVudDogY29udGVudH0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcmVsb2FkUGFnZTogZnVuY3Rpb24gKHVybCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXBwLnJvdXRlci5sb2FkKHZpZXcsIHt1cmw6IHVybCwgcmVsb2FkOiB0cnVlfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICByZWxvYWRDb250ZW50OiBmdW5jdGlvbiAoY29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXBwLnJvdXRlci5sb2FkKHZpZXcsIHtjb250ZW50OiBjb250ZW50LCByZWxvYWQ6IHRydWV9KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHJlbG9hZFByZXZpb3VzUGFnZTogZnVuY3Rpb24gKHVybCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXBwLnJvdXRlci5sb2FkKHZpZXcsIHt1cmw6IHVybCwgcmVsb2FkUHJldmlvdXM6IHRydWUsIHJlbG9hZDogdHJ1ZX0pO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgcmVsb2FkUHJldmlvdXNDb250ZW50OiBmdW5jdGlvbiAoY29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXBwLnJvdXRlci5sb2FkKHZpZXcsIHtjb250ZW50OiBjb250ZW50LCByZWxvYWRQcmV2aW91czogdHJ1ZSwgcmVsb2FkOiB0cnVlfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICByZWZyZXNoUGFnZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdmlldy51cmwsXG4gICAgICAgICAgICAgICAgICAgICAgICByZWxvYWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBpZ25vcmVDYWNoZTogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy51cmwgJiYgb3B0aW9ucy51cmwuaW5kZXhPZignIycpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuZG9tQ2FjaGUgJiYgdmlldy5wYWdlc0NhY2hlW29wdGlvbnMudXJsXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMucGFnZU5hbWUgPSB2aWV3LnBhZ2VzQ2FjaGVbb3B0aW9ucy51cmxdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMudXJsID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLnVybDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHZpZXcuY29udGVudENhY2hlW29wdGlvbnMudXJsXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuY29udGVudCA9IHZpZXcuY29udGVudENhY2hlW29wdGlvbnMudXJsXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnVybCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgb3B0aW9ucy51cmw7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFwcC5yb3V0ZXIubG9hZCh2aWV3LCBvcHRpb25zKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHJlZnJlc2hQcmV2aW91c1BhZ2U6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cmw6IHZpZXcuaGlzdG9yeVt2aWV3Lmhpc3RvcnkubGVuZ3RoIC0gMl0sXG4gICAgICAgICAgICAgICAgICAgICAgICByZWxvYWQ6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICByZWxvYWRQcmV2aW91czogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlnbm9yZUNhY2hlOiB0cnVlXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnVybCAmJiBvcHRpb25zLnVybC5pbmRleE9mKCcjJykgPT09IDAgJiYgdmlldy5wYXJhbXMuZG9tQ2FjaGUgJiYgdmlldy5wYWdlc0NhY2hlW29wdGlvbnMudXJsXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5wYWdlTmFtZSA9IHZpZXcucGFnZXNDYWNoZVtvcHRpb25zLnVybF07XG4gICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnVybCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLnVybDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXBwLnJvdXRlci5sb2FkKHZpZXcsIG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQWxpYXNlcyBmb3IgdGVtcG9yYXJ5IGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgICAgICAgICAgIHZpZXcubG9hZFBhZ2UgPSB2aWV3LnJvdXRlci5sb2FkUGFnZTtcbiAgICAgICAgICAgIHZpZXcubG9hZENvbnRlbnQgPSB2aWV3LnJvdXRlci5sb2FkQ29udGVudDtcbiAgICAgICAgICAgIHZpZXcucmVsb2FkUGFnZSA9IHZpZXcucm91dGVyLnJlbG9hZFBhZ2U7XG4gICAgICAgICAgICB2aWV3LnJlbG9hZENvbnRlbnQgPSB2aWV3LnJvdXRlci5yZWxvYWRDb250ZW50O1xuICAgICAgICAgICAgdmlldy5yZWxvYWRQcmV2aW91c1BhZ2UgPSB2aWV3LnJvdXRlci5yZWxvYWRQcmV2aW91c1BhZ2U7XG4gICAgICAgICAgICB2aWV3LnJlbG9hZFByZXZpb3VzQ29udGVudCA9IHZpZXcucm91dGVyLnJlbG9hZFByZXZpb3VzQ29udGVudDtcbiAgICAgICAgICAgIHZpZXcucmVmcmVzaFBhZ2UgPSB2aWV3LnJvdXRlci5yZWZyZXNoUGFnZTtcbiAgICAgICAgICAgIHZpZXcucmVmcmVzaFByZXZpb3VzUGFnZSA9IHZpZXcucm91dGVyLnJlZnJlc2hQcmV2aW91c1BhZ2U7XG4gICAgICAgICAgICB2aWV3LmJhY2sgPSB2aWV3LnJvdXRlci5iYWNrO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEJhcnMgbWV0aG9kc1xuICAgICAgICAgICAgdmlldy5oaWRlTmF2YmFyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBhcHAuaGlkZU5hdmJhcihjb250YWluZXIuZmluZCgnLm5hdmJhcicpKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB2aWV3LnNob3dOYXZiYXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFwcC5zaG93TmF2YmFyKGNvbnRhaW5lci5maW5kKCcubmF2YmFyJykpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZpZXcuaGlkZVRvb2xiYXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFwcC5oaWRlVG9vbGJhcihjb250YWluZXIuZmluZCgnLnRvb2xiYXInKSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdmlldy5zaG93VG9vbGJhciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXBwLnNob3dUb29sYmFyKGNvbnRhaW5lci5maW5kKCcudG9vbGJhcicpKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUHVzaCBTdGF0ZSBvbiBsb2FkXG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5wdXNoU3RhdGUgJiYgYXBwLnBhcmFtcy5wdXNoU3RhdGVPbkxvYWQgJiYgdmlldy5tYWluKSB7XG4gICAgICAgICAgICAgICAgdmFyIHB1c2hTdGF0ZVVybDtcbiAgICAgICAgICAgICAgICB2YXIgcHVzaFN0YXRlVXJsU3BsaXQgPSBkb2NMb2NhdGlvbi5zcGxpdChwdXNoU3RhdGVTZXBhcmF0b3IpWzFdO1xuICAgICAgICAgICAgICAgIGlmIChwdXNoU3RhdGVSb290KSB7XG4gICAgICAgICAgICAgICAgICAgIHB1c2hTdGF0ZVVybCA9IGRvY0xvY2F0aW9uLnNwbGl0KGFwcC5wYXJhbXMucHVzaFN0YXRlUm9vdCArIHB1c2hTdGF0ZVNlcGFyYXRvcilbMV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHB1c2hTdGF0ZVNlcGFyYXRvciAmJiBkb2NMb2NhdGlvbi5pbmRleE9mKHB1c2hTdGF0ZVNlcGFyYXRvcikgPj0gMCAmJiBkb2NMb2NhdGlvbi5pbmRleE9mKHB1c2hTdGF0ZVNlcGFyYXRvciArICcjJykgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHB1c2hTdGF0ZVVybCA9IHB1c2hTdGF0ZVVybFNwbGl0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgcHVzaFN0YXRlQW5pbWF0ZVBhZ2VzID0gYXBwLnBhcmFtcy5wdXNoU3RhdGVOb0FuaW1hdGlvbiA/IGZhbHNlIDogdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHZhciBoaXN0b3J5U3RhdGUgPSBoaXN0b3J5LnN0YXRlO1xuICAgICAgICAgICAgICAgIGlmIChwdXNoU3RhdGVVcmwpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHB1c2hTdGF0ZVVybC5pbmRleE9mKCcjJykgPj0gMCAmJiB2aWV3LnBhcmFtcy5kb21DYWNoZSAmJiBoaXN0b3J5U3RhdGUgJiYgaGlzdG9yeVN0YXRlLnBhZ2VOYW1lICYmICd2aWV3SW5kZXgnIGluIGhpc3RvcnlTdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci5sb2FkKHZpZXcsIHtwYWdlTmFtZTogaGlzdG9yeVN0YXRlLnBhZ2VOYW1lLCB1cmw6IGhpc3RvcnlTdGF0ZS51cmwsIGFuaW1hdGVQYWdlczogcHVzaFN0YXRlQW5pbWF0ZVBhZ2VzLCBwdXNoU3RhdGU6IGZhbHNlfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocHVzaFN0YXRlVXJsLmluZGV4T2YoJyMnKSA+PSAwICYmIHZpZXcucGFyYW1zLmRvbUNhY2hlICYmIHZpZXcuaW5pdGlhbFBhZ2VzVXJsLmluZGV4T2YocHVzaFN0YXRlVXJsKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLmxvYWQodmlldywge3BhZ2VOYW1lOiBwdXNoU3RhdGVVcmwucmVwbGFjZSgnIycsJycpLCBhbmltYXRlUGFnZXM6IHB1c2hTdGF0ZUFuaW1hdGVQYWdlcywgcHVzaFN0YXRlOiBmYWxzZX0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgYXBwLnJvdXRlci5sb2FkKHZpZXcsIHt1cmw6IHB1c2hTdGF0ZVVybCwgYW5pbWF0ZVBhZ2VzOiBwdXNoU3RhdGVBbmltYXRlUGFnZXMsIHB1c2hTdGF0ZTogZmFsc2V9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodmlldy5wYXJhbXMuZG9tQ2FjaGUgJiYgZG9jTG9jYXRpb24uaW5kZXhPZihwdXNoU3RhdGVTZXBhcmF0b3IgKyAnIycpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGhpc3RvcnlTdGF0ZSAmJiBoaXN0b3J5U3RhdGUucGFnZU5hbWUgJiYgJ3ZpZXdJbmRleCcgaW4gaGlzdG9yeVN0YXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLmxvYWQodmlldywge3BhZ2VOYW1lOiBoaXN0b3J5U3RhdGUucGFnZU5hbWUsIHVybDogaGlzdG9yeVN0YXRlLnVybCwgYW5pbWF0ZVBhZ2VzOiBwdXNoU3RhdGVBbmltYXRlUGFnZXMsIHB1c2hTdGF0ZTogZmFsc2V9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChwdXNoU3RhdGVTZXBhcmF0b3IgJiYgcHVzaFN0YXRlVXJsU3BsaXQuaW5kZXhPZignIycpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5pbml0aWFsUGFnZXNVcmwuaW5kZXhPZihwdXNoU3RhdGVVcmxTcGxpdCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLmxvYWQodmlldywge3BhZ2VOYW1lOiBwdXNoU3RhdGVVcmxTcGxpdC5yZXBsYWNlKCcjJywgJycpLCBhbmltYXRlUGFnZXM6IHB1c2hTdGF0ZUFuaW1hdGVQYWdlcywgcHVzaFN0YXRlOiBmYWxzZX0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIERlc3Ryb3lcbiAgICAgICAgICAgIHZpZXcuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2aWV3LmRldGFjaEV2ZW50cygpO1xuICAgICAgICAgICAgICAgIHZpZXcgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBsdWdpbiBob29rXG4gICAgICAgICAgICBhcHAucGx1Z2luSG9vaygnYWRkVmlldycsIHZpZXcpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFJldHVybiB2aWV3XG4gICAgICAgICAgICByZXR1cm4gdmlldztcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGFwcC5hZGRWaWV3ID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBwYXJhbXMpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgVmlldyhzZWxlY3RvciwgcGFyYW1zKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGFwcC5nZXRDdXJyZW50VmlldyA9IGZ1bmN0aW9uIChpbmRleCkge1xuICAgICAgICAgICAgdmFyIHBvcG92ZXJWaWV3ID0gJCgnLnBvcG92ZXIubW9kYWwtaW4gLnZpZXcnKTtcbiAgICAgICAgICAgIHZhciBwb3B1cFZpZXcgPSAkKCcucG9wdXAubW9kYWwtaW4gLnZpZXcnKTtcbiAgICAgICAgICAgIHZhciBwYW5lbFZpZXcgPSAkKCcucGFuZWwuYWN0aXZlIC52aWV3Jyk7XG4gICAgICAgICAgICB2YXIgYXBwVmlld3MgPSAkKCcudmlld3MnKTtcbiAgICAgICAgICAgIC8vIEZpbmQgYWN0aXZlIHZpZXcgYXMgdGFiXG4gICAgICAgICAgICB2YXIgYXBwVmlldyA9IGFwcFZpZXdzLmNoaWxkcmVuKCcudmlldycpO1xuICAgICAgICAgICAgLy8gUHJvcGFibHkgaW4gdGFicyBvciBzcGxpdCB2aWV3XG4gICAgICAgICAgICBpZiAoYXBwVmlldy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgaWYgKGFwcFZpZXcuaGFzQ2xhc3MoJ3RhYicpKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFRhYnNcbiAgICAgICAgICAgICAgICAgICAgYXBwVmlldyA9IGFwcFZpZXdzLmNoaWxkcmVuKCcudmlldy5hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFNwbGl0IFZpZXcsIGxlYXZlIGFwcFZpZXcgaW50YWN0XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHBvcG92ZXJWaWV3Lmxlbmd0aCA+IDAgJiYgcG9wb3ZlclZpZXdbMF0uZjdWaWV3KSByZXR1cm4gcG9wb3ZlclZpZXdbMF0uZjdWaWV3O1xuICAgICAgICAgICAgaWYgKHBvcHVwVmlldy5sZW5ndGggPiAwICYmIHBvcHVwVmlld1swXS5mN1ZpZXcpIHJldHVybiBwb3B1cFZpZXdbMF0uZjdWaWV3O1xuICAgICAgICAgICAgaWYgKHBhbmVsVmlldy5sZW5ndGggPiAwICYmIHBhbmVsVmlld1swXS5mN1ZpZXcpIHJldHVybiBwYW5lbFZpZXdbMF0uZjdWaWV3O1xuICAgICAgICAgICAgaWYgKGFwcFZpZXcubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGlmIChhcHBWaWV3Lmxlbmd0aCA9PT0gMSAmJiBhcHBWaWV3WzBdLmY3VmlldykgcmV0dXJuIGFwcFZpZXdbMF0uZjdWaWV3O1xuICAgICAgICAgICAgICAgIGlmIChhcHBWaWV3Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRWaWV3cyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFwcFZpZXcubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHBWaWV3W2ldLmY3VmlldykgY3VycmVudFZpZXdzLnB1c2goYXBwVmlld1tpXS5mN1ZpZXcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Vmlld3MubGVuZ3RoID4gMCAmJiB0eXBlb2YgaW5kZXggIT09ICd1bmRlZmluZWQnKSByZXR1cm4gY3VycmVudFZpZXdzW2luZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRWaWV3cy5sZW5ndGggPiAxKSByZXR1cm4gY3VycmVudFZpZXdzO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudFZpZXdzLmxlbmd0aCA9PT0gMSkgcmV0dXJuIGN1cnJlbnRWaWV3c1swXTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9O1xuICAgICAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBOYXZiYXJzICYmIFRvb2xiYXJzICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIC8vIE9uIE5hdmJhciBJbml0IENhbGxiYWNrXG4gICAgICAgIGFwcC5uYXZiYXJJbml0Q2FsbGJhY2sgPSBmdW5jdGlvbiAodmlldywgcGFnZUNvbnRhaW5lciwgbmF2YmFyQ29udGFpbmVyLCBuYXZiYXJJbm5lckNvbnRhaW5lcikge1xuICAgICAgICAgICAgaWYgKCFuYXZiYXJDb250YWluZXIgJiYgbmF2YmFySW5uZXJDb250YWluZXIpIG5hdmJhckNvbnRhaW5lciA9ICQobmF2YmFySW5uZXJDb250YWluZXIpLnBhcmVudCgnLm5hdmJhcicpWzBdO1xuICAgICAgICAgICAgaWYgKG5hdmJhcklubmVyQ29udGFpbmVyLmY3TmF2YmFySW5pdGlhbGl6ZWQgJiYgdmlldyAmJiAhdmlldy5wYXJhbXMuZG9tQ2FjaGUpIHJldHVybjtcbiAgICAgICAgICAgIHZhciBuYXZiYXJEYXRhID0ge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lcjogbmF2YmFyQ29udGFpbmVyLFxuICAgICAgICAgICAgICAgIGlubmVyQ29udGFpbmVyOiBuYXZiYXJJbm5lckNvbnRhaW5lclxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZhciBwYWdlRGF0YSA9IHBhZ2VDb250YWluZXIgJiYgcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBldmVudERhdGEgPSB7XG4gICAgICAgICAgICAgICAgcGFnZTogcGFnZURhdGEsXG4gICAgICAgICAgICAgICAgbmF2YmFyOiBuYXZiYXJEYXRhXG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChuYXZiYXJJbm5lckNvbnRhaW5lci5mN05hdmJhckluaXRpYWxpemVkICYmICgodmlldyAmJiB2aWV3LnBhcmFtcy5kb21DYWNoZSkgfHwgKCF2aWV3ICYmICQobmF2YmFyQ29udGFpbmVyKS5wYXJlbnRzKCcucG9wdXAsIC5wb3BvdmVyLCAubG9naW4tc2NyZWVuLCAubW9kYWwsIC5hY3Rpb25zLW1vZGFsLCAucGlja2VyLW1vZGFsJykubGVuZ3RoID4gMCkpKSB7XG4gICAgICAgICAgICAgICAgLy8gUmVpbml0IE5hdmJhclxuICAgICAgICAgICAgICAgIGFwcC5yZWluaXROYXZiYXIobmF2YmFyQ29udGFpbmVyLCBuYXZiYXJJbm5lckNvbnRhaW5lcik7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFBsdWdpbiBob29rXG4gICAgICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ25hdmJhclJlaW5pdCcsIGV2ZW50RGF0YSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIEV2ZW50XG4gICAgICAgICAgICAgICAgJChuYXZiYXJJbm5lckNvbnRhaW5lcikudHJpZ2dlcignbmF2YmFyUmVpbml0JywgZXZlbnREYXRhKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBuYXZiYXJJbm5lckNvbnRhaW5lci5mN05hdmJhckluaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgICAgICAgIC8vIEJlZm9yZSBJbml0XG4gICAgICAgICAgICBhcHAucGx1Z2luSG9vaygnbmF2YmFyQmVmb3JlSW5pdCcsIG5hdmJhckRhdGEsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICQobmF2YmFySW5uZXJDb250YWluZXIpLnRyaWdnZXIoJ25hdmJhckJlZm9yZUluaXQnLCBldmVudERhdGEpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgTmF2YmFyXG4gICAgICAgICAgICBhcHAuaW5pdE5hdmJhcihuYXZiYXJDb250YWluZXIsIG5hdmJhcklubmVyQ29udGFpbmVyKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBPbiBpbml0XG4gICAgICAgICAgICBhcHAucGx1Z2luSG9vaygnbmF2YmFySW5pdCcsIG5hdmJhckRhdGEsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICQobmF2YmFySW5uZXJDb250YWluZXIpLnRyaWdnZXIoJ25hdmJhckluaXQnLCBldmVudERhdGEpO1xuICAgICAgICB9O1xuICAgICAgICAvLyBOYXZiYXIgUmVtb3ZlIENhbGxiYWNrXG4gICAgICAgIGFwcC5uYXZiYXJSZW1vdmVDYWxsYmFjayA9IGZ1bmN0aW9uICh2aWV3LCBwYWdlQ29udGFpbmVyLCBuYXZiYXJDb250YWluZXIsIG5hdmJhcklubmVyQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBpZiAoIW5hdmJhckNvbnRhaW5lciAmJiBuYXZiYXJJbm5lckNvbnRhaW5lcikgbmF2YmFyQ29udGFpbmVyID0gJChuYXZiYXJJbm5lckNvbnRhaW5lcikucGFyZW50KCcubmF2YmFyJylbMF07XG4gICAgICAgICAgICB2YXIgbmF2YmFyRGF0YSA9IHtcbiAgICAgICAgICAgICAgICBjb250YWluZXI6IG5hdmJhckNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICBpbm5lckNvbnRhaW5lcjogbmF2YmFySW5uZXJDb250YWluZXJcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB2YXIgcGFnZURhdGEgPSBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGE7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIGV2ZW50RGF0YSA9IHtcbiAgICAgICAgICAgICAgICBwYWdlOiBwYWdlRGF0YSxcbiAgICAgICAgICAgICAgICBuYXZiYXI6IG5hdmJhckRhdGFcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBhcHAucGx1Z2luSG9vaygnbmF2YmFyQmVmb3JlUmVtb3ZlJywgbmF2YmFyRGF0YSwgcGFnZURhdGEpO1xuICAgICAgICAgICAgJChuYXZiYXJJbm5lckNvbnRhaW5lcikudHJpZ2dlcignbmF2YmFyQmVmb3JlUmVtb3ZlJywgZXZlbnREYXRhKTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmluaXROYXZiYXIgPSBmdW5jdGlvbiAobmF2YmFyQ29udGFpbmVyLCBuYXZiYXJJbm5lckNvbnRhaW5lcikge1xuICAgICAgICAgICAgLy8gSW5pdCBTdWJuYXZiYXIgU2VhcmNoYmFyXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRTZWFyY2hiYXIpIGFwcC5pbml0U2VhcmNoYmFyKG5hdmJhcklubmVyQ29udGFpbmVyKTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnJlaW5pdE5hdmJhciA9IGZ1bmN0aW9uIChuYXZiYXJDb250YWluZXIsIG5hdmJhcklubmVyQ29udGFpbmVyKSB7XG4gICAgICAgICAgICAvLyBSZSBpbml0IG5hdmJhciBtZXRob2RzXG4gICAgICAgIH07XG4gICAgICAgIGFwcC5pbml0TmF2YmFyV2l0aENhbGxiYWNrID0gZnVuY3Rpb24gKG5hdmJhckNvbnRhaW5lcikge1xuICAgICAgICAgICAgbmF2YmFyQ29udGFpbmVyID0gJChuYXZiYXJDb250YWluZXIpO1xuICAgICAgICAgICAgdmFyIHZpZXdDb250YWluZXIgPSBuYXZiYXJDb250YWluZXIucGFyZW50cygnLicgKyBhcHAucGFyYW1zLnZpZXdDbGFzcyk7XG4gICAgICAgICAgICB2YXIgdmlldztcbiAgICAgICAgICAgIGlmICh2aWV3Q29udGFpbmVyLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKG5hdmJhckNvbnRhaW5lci5wYXJlbnRzKCcubmF2YmFyLXRocm91Z2gnKS5sZW5ndGggPT09IDAgJiYgdmlld0NvbnRhaW5lci5maW5kKCcubmF2YmFyLXRocm91Z2gnKS5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIHZpZXcgPSB2aWV3Q29udGFpbmVyWzBdLmY3VmlldyB8fCB1bmRlZmluZWQ7XG4gICAgICAgIFxuICAgICAgICAgICAgbmF2YmFyQ29udGFpbmVyLmZpbmQoJy5uYXZiYXItaW5uZXInKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgbmF2YmFySW5uZXJDb250YWluZXIgPSB0aGlzO1xuICAgICAgICAgICAgICAgIHZhciBwYWdlQ29udGFpbmVyO1xuICAgICAgICAgICAgICAgIGlmICgkKG5hdmJhcklubmVyQ29udGFpbmVyKS5hdHRyKCdkYXRhLXBhZ2UnKSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBGb3IgZG9tIGNhY2hlXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSB2aWV3Q29udGFpbmVyLmZpbmQoJy5wYWdlW2RhdGEtcGFnZT1cIicgKyAkKG5hdmJhcklubmVyQ29udGFpbmVyKS5hdHRyKCdkYXRhLXBhZ2UnKSArICdcIl0nKVswXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwYWdlcyA9IHZpZXdDb250YWluZXIuZmluZCgnLnBhZ2UnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2VzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9IHBhZ2VzWzBdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmlld0NvbnRhaW5lci5maW5kKCcucGFnZScpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmY3UGFnZURhdGEgJiYgdGhpcy5mN1BhZ2VEYXRhLm5hdmJhcklubmVyQ29udGFpbmVyID09PSBuYXZiYXJJbm5lckNvbnRhaW5lcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gdGhpcztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBhcHAubmF2YmFySW5pdENhbGxiYWNrKHZpZXcsIHBhZ2VDb250YWluZXIsIG5hdmJhckNvbnRhaW5lclswXSwgbmF2YmFySW5uZXJDb250YWluZXIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvLyBTaXplIE5hdmJhcnNcbiAgICAgICAgYXBwLnNpemVOYXZiYXJzID0gZnVuY3Rpb24gKHZpZXdDb250YWluZXIpIHtcbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsKSByZXR1cm47XG4gICAgICAgICAgICB2YXIgbmF2YmFySW5uZXIgPSB2aWV3Q29udGFpbmVyID8gJCh2aWV3Q29udGFpbmVyKS5maW5kKCcubmF2YmFyIC5uYXZiYXItaW5uZXI6bm90KC5jYWNoZWQpJykgOiAkKCcubmF2YmFyIC5uYXZiYXItaW5uZXI6bm90KC5jYWNoZWQpJyk7XG4gICAgICAgICAgICBuYXZiYXJJbm5lci5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgbiA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgaWYgKG4uaGFzQ2xhc3MoJ2NhY2hlZCcpKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIGxlZnQgPSBhcHAucnRsID8gbi5maW5kKCcucmlnaHQnKSA6IG4uZmluZCgnLmxlZnQnKSxcbiAgICAgICAgICAgICAgICAgICAgcmlnaHQgPSBhcHAucnRsID8gbi5maW5kKCcubGVmdCcpIDogbi5maW5kKCcucmlnaHQnKSxcbiAgICAgICAgICAgICAgICAgICAgY2VudGVyID0gbi5maW5kKCcuY2VudGVyJyksXG4gICAgICAgICAgICAgICAgICAgIHN1Ym5hdmJhciA9IG4uZmluZCgnLnN1Ym5hdmJhcicpLFxuICAgICAgICAgICAgICAgICAgICBub0xlZnQgPSBsZWZ0Lmxlbmd0aCA9PT0gMCxcbiAgICAgICAgICAgICAgICAgICAgbm9SaWdodCA9IHJpZ2h0Lmxlbmd0aCA9PT0gMCxcbiAgICAgICAgICAgICAgICAgICAgbGVmdFdpZHRoID0gbm9MZWZ0ID8gMCA6IGxlZnQub3V0ZXJXaWR0aCh0cnVlKSxcbiAgICAgICAgICAgICAgICAgICAgcmlnaHRXaWR0aCA9IG5vUmlnaHQgPyAwIDogcmlnaHQub3V0ZXJXaWR0aCh0cnVlKSxcbiAgICAgICAgICAgICAgICAgICAgY2VudGVyV2lkdGggPSBjZW50ZXIub3V0ZXJXaWR0aCh0cnVlKSxcbiAgICAgICAgICAgICAgICAgICAgbmF2YmFyU3R5bGVzID0gbi5zdHlsZXMoKSxcbiAgICAgICAgICAgICAgICAgICAgbmF2YmFyV2lkdGggPSBuWzBdLm9mZnNldFdpZHRoIC0gcGFyc2VJbnQobmF2YmFyU3R5bGVzLnBhZGRpbmdMZWZ0LCAxMCkgLSBwYXJzZUludChuYXZiYXJTdHlsZXMucGFkZGluZ1JpZ2h0LCAxMCksXG4gICAgICAgICAgICAgICAgICAgIG9uTGVmdCA9IG4uaGFzQ2xhc3MoJ25hdmJhci1vbi1sZWZ0JyksXG4gICAgICAgICAgICAgICAgICAgIGN1cnJMZWZ0LCBkaWZmO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAobm9SaWdodCkge1xuICAgICAgICAgICAgICAgICAgICBjdXJyTGVmdCA9IG5hdmJhcldpZHRoIC0gY2VudGVyV2lkdGg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChub0xlZnQpIHtcbiAgICAgICAgICAgICAgICAgICAgY3VyckxlZnQgPSAwO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIW5vTGVmdCAmJiAhbm9SaWdodCkge1xuICAgICAgICAgICAgICAgICAgICBjdXJyTGVmdCA9IChuYXZiYXJXaWR0aCAtIHJpZ2h0V2lkdGggLSBjZW50ZXJXaWR0aCArIGxlZnRXaWR0aCkgLyAyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgcmVxdWlyZWRMZWZ0ID0gKG5hdmJhcldpZHRoIC0gY2VudGVyV2lkdGgpIC8gMjtcbiAgICAgICAgICAgICAgICBpZiAobmF2YmFyV2lkdGggLSBsZWZ0V2lkdGggLSByaWdodFdpZHRoID4gY2VudGVyV2lkdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcXVpcmVkTGVmdCA8IGxlZnRXaWR0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWRMZWZ0ID0gbGVmdFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXF1aXJlZExlZnQgKyBjZW50ZXJXaWR0aCA+IG5hdmJhcldpZHRoIC0gcmlnaHRXaWR0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWlyZWRMZWZ0ID0gbmF2YmFyV2lkdGggLSByaWdodFdpZHRoIC0gY2VudGVyV2lkdGg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZGlmZiA9IHJlcXVpcmVkTGVmdCAtIGN1cnJMZWZ0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZGlmZiA9IDA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIFJUTCBpbnZlcnRlclxuICAgICAgICAgICAgICAgIHZhciBpbnZlcnRlciA9IGFwcC5ydGwgPyAtMSA6IDE7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChjZW50ZXIuaGFzQ2xhc3MoJ3NsaWRpbmcnKSkge1xuICAgICAgICAgICAgICAgICAgICBjZW50ZXJbMF0uZjdOYXZiYXJMZWZ0T2Zmc2V0ID0gLShjdXJyTGVmdCArIGRpZmYpICogaW52ZXJ0ZXI7XG4gICAgICAgICAgICAgICAgICAgIGNlbnRlclswXS5mN05hdmJhclJpZ2h0T2Zmc2V0ID0gKG5hdmJhcldpZHRoIC0gY3VyckxlZnQgLSBkaWZmIC0gY2VudGVyV2lkdGgpICogaW52ZXJ0ZXI7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvbkxlZnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmFuaW1hdGVOYXZCYWNrSWNvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhY3RpdmVOYXZiYXJCYWNrTGluayA9IG4ucGFyZW50KCkuZmluZCgnLm5hdmJhci1vbi1jZW50ZXInKS5maW5kKCcubGVmdC5zbGlkaW5nIC5iYWNrIC5pY29uIH4gc3BhbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhY3RpdmVOYXZiYXJCYWNrTGluay5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNlbnRlclswXS5mN05hdmJhckxlZnRPZmZzZXQgKz0gYWN0aXZlTmF2YmFyQmFja0xpbmtbMF0ub2Zmc2V0TGVmdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBjZW50ZXIudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgY2VudGVyWzBdLmY3TmF2YmFyTGVmdE9mZnNldCArICdweCwgMCwgMCknKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIW5vTGVmdCAmJiBsZWZ0Lmhhc0NsYXNzKCdzbGlkaW5nJykpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5ydGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxlZnRbMF0uZjdOYXZiYXJMZWZ0T2Zmc2V0ID0gLShuYXZiYXJXaWR0aCAtIGxlZnRbMF0ub2Zmc2V0V2lkdGgpIC8gMiAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgICAgICAgICAgbGVmdFswXS5mN05hdmJhclJpZ2h0T2Zmc2V0ID0gbGVmdFdpZHRoICogaW52ZXJ0ZXI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZWZ0WzBdLmY3TmF2YmFyTGVmdE9mZnNldCA9IC1sZWZ0V2lkdGg7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZWZ0WzBdLmY3TmF2YmFyUmlnaHRPZmZzZXQgPSAobmF2YmFyV2lkdGggLSBsZWZ0WzBdLm9mZnNldFdpZHRoKSAvIDI7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hbmltYXRlTmF2QmFja0ljb24gJiYgbGVmdC5maW5kKCcuYmFjayAuaWNvbicpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0WzBdLmY3TmF2YmFyUmlnaHRPZmZzZXQgLT0gbGVmdC5maW5kKCcuYmFjayAuaWNvbicpWzBdLm9mZnNldFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChvbkxlZnQpIGxlZnQudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgbGVmdFswXS5mN05hdmJhckxlZnRPZmZzZXQgKyAncHgsIDAsIDApJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghbm9SaWdodCAmJiByaWdodC5oYXNDbGFzcygnc2xpZGluZycpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHAucnRsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodFswXS5mN05hdmJhckxlZnRPZmZzZXQgPSAtcmlnaHRXaWR0aCAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRbMF0uZjdOYXZiYXJSaWdodE9mZnNldCA9IChuYXZiYXJXaWR0aCAtIHJpZ2h0WzBdLm9mZnNldFdpZHRoKSAvIDIgKiBpbnZlcnRlcjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0WzBdLmY3TmF2YmFyTGVmdE9mZnNldCA9IC0obmF2YmFyV2lkdGggLSByaWdodFswXS5vZmZzZXRXaWR0aCkgLyAyO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRbMF0uZjdOYXZiYXJSaWdodE9mZnNldCA9IHJpZ2h0V2lkdGg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKG9uTGVmdCkgcmlnaHQudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgcmlnaHRbMF0uZjdOYXZiYXJMZWZ0T2Zmc2V0ICsgJ3B4LCAwLCAwKScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoc3VibmF2YmFyLmxlbmd0aCAmJiBzdWJuYXZiYXIuaGFzQ2xhc3MoJ3NsaWRpbmcnKSkge1xuICAgICAgICAgICAgICAgICAgICBzdWJuYXZiYXJbMF0uZjdOYXZiYXJMZWZ0T2Zmc2V0ID0gYXBwLnJ0bCA/IHN1Ym5hdmJhclswXS5vZmZzZXRXaWR0aCA6IC1zdWJuYXZiYXJbMF0ub2Zmc2V0V2lkdGg7XG4gICAgICAgICAgICAgICAgICAgIHN1Ym5hdmJhclswXS5mN05hdmJhclJpZ2h0T2Zmc2V0ID0gLXN1Ym5hdmJhclswXS5mN05hdmJhckxlZnRPZmZzZXQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBDZW50ZXIgbGVmdFxuICAgICAgICAgICAgICAgIHZhciBjZW50ZXJMZWZ0ID0gZGlmZjtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnJ0bCAmJiBub0xlZnQgJiYgbm9SaWdodCAmJiBjZW50ZXIubGVuZ3RoID4gMCkgY2VudGVyTGVmdCA9IC1jZW50ZXJMZWZ0O1xuICAgICAgICAgICAgICAgIGNlbnRlci5jc3Moe2xlZnQ6IGNlbnRlckxlZnQgKyAncHgnfSk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8vIEhpZGUvU2hvdyBOYXZiYXJzL1Rvb2xiYXJzXG4gICAgICAgIGFwcC5oaWRlTmF2YmFyID0gZnVuY3Rpb24gKG5hdmJhckNvbnRhaW5lcikge1xuICAgICAgICAgICAgJChuYXZiYXJDb250YWluZXIpLmFkZENsYXNzKCduYXZiYXItaGlkZGVuJyk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnNob3dOYXZiYXIgPSBmdW5jdGlvbiAobmF2YmFyQ29udGFpbmVyKSB7XG4gICAgICAgICAgICB2YXIgbmF2YmFyID0gJChuYXZiYXJDb250YWluZXIpO1xuICAgICAgICAgICAgbmF2YmFyLmFkZENsYXNzKCduYXZiYXItaGlkaW5nJykucmVtb3ZlQ2xhc3MoJ25hdmJhci1oaWRkZW4nKS50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBuYXZiYXIucmVtb3ZlQ2xhc3MoJ25hdmJhci1oaWRpbmcnKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5oaWRlVG9vbGJhciA9IGZ1bmN0aW9uICh0b29sYmFyQ29udGFpbmVyKSB7XG4gICAgICAgICAgICAkKHRvb2xiYXJDb250YWluZXIpLmFkZENsYXNzKCd0b29sYmFyLWhpZGRlbicpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5zaG93VG9vbGJhciA9IGZ1bmN0aW9uICh0b29sYmFyQ29udGFpbmVyKSB7XG4gICAgICAgICAgICB2YXIgdG9vbGJhciA9ICQodG9vbGJhckNvbnRhaW5lcik7XG4gICAgICAgICAgICB0b29sYmFyLmFkZENsYXNzKCd0b29sYmFyLWhpZGluZycpLnJlbW92ZUNsYXNzKCd0b29sYmFyLWhpZGRlbicpLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHRvb2xiYXIucmVtb3ZlQ2xhc3MoJ3Rvb2xiYXItaGlkaW5nJyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgXG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgU2VhcmNoYmFyICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHZhciBTZWFyY2hiYXIgPSBmdW5jdGlvbiAoY29udGFpbmVyLCBwYXJhbXMpIHtcbiAgICAgICAgICAgIHZhciBkZWZhdWx0cyA9IHtcbiAgICAgICAgICAgICAgICBpbnB1dDogbnVsbCxcbiAgICAgICAgICAgICAgICBjbGVhckJ1dHRvbjogbnVsbCxcbiAgICAgICAgICAgICAgICBjYW5jZWxCdXR0b246IG51bGwsXG4gICAgICAgICAgICAgICAgc2VhcmNoTGlzdDogbnVsbCxcbiAgICAgICAgICAgICAgICBzZWFyY2hJbjogJy5pdGVtLXRpdGxlJyxcbiAgICAgICAgICAgICAgICBzZWFyY2hCeTogJycsXG4gICAgICAgICAgICAgICAgZm91bmQ6IG51bGwsXG4gICAgICAgICAgICAgICAgbm90Rm91bmQ6IG51bGwsXG4gICAgICAgICAgICAgICAgb3ZlcmxheTogbnVsbCxcbiAgICAgICAgICAgICAgICBpZ25vcmU6ICcuc2VhcmNoYmFyLWlnbm9yZScsXG4gICAgICAgICAgICAgICAgY3VzdG9tU2VhcmNoOiBmYWxzZSxcbiAgICAgICAgICAgICAgICByZW1vdmVEaWFjcml0aWNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBoaWRlRGl2aWRlcnM6IHRydWUsXG4gICAgICAgICAgICAgICAgaGlkZUdyb3VwczogdHJ1ZSxcbiAgICAgICAgICAgICAgICAvKiBDYWxsYmFja3NcbiAgICAgICAgICAgICAgICBvblNlYXJjaFxuICAgICAgICAgICAgICAgIG9uRW5hYmxlXG4gICAgICAgICAgICAgICAgb25EaXNhYmxlXG4gICAgICAgICAgICAgICAgb25DbGVhclxuICAgICAgICAgICAgICAgICovXG4gICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcbiAgICAgICAgICAgIGZvciAodmFyIGRlZiBpbiBkZWZhdWx0cykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW2RlZl0gPT09ICd1bmRlZmluZWQnIHx8IHBhcmFtc1tkZWZdID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtc1tkZWZdID0gZGVmYXVsdHNbZGVmXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEluc3RhbmNlXG4gICAgICAgICAgICB2YXIgcyA9IHRoaXM7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gTWF0ZXJpYWxcbiAgICAgICAgICAgIHMubWF0ZXJpYWwgPSBhcHAucGFyYW1zLm1hdGVyaWFsO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBhcmFtc1xuICAgICAgICAgICAgcy5wYXJhbXMgPSBwYXJhbXM7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ29udGFpbmVyXG4gICAgICAgICAgICBjb250YWluZXIgPSAkKGNvbnRhaW5lcik7XG4gICAgICAgICAgICBzLmNvbnRhaW5lciA9IGNvbnRhaW5lcjtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBBY3RpdmVcbiAgICAgICAgICAgIHMuYWN0aXZlID0gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5wdXRcbiAgICAgICAgICAgIHMuaW5wdXQgPSBzLnBhcmFtcy5pbnB1dCA/ICQocy5wYXJhbXMuaW5wdXQpIDogcy5jb250YWluZXIuZmluZCgnaW5wdXRbdHlwZT1cInNlYXJjaFwiXScpO1xuICAgICAgICAgICAgcy5jbGVhckJ1dHRvbiA9IHMucGFyYW1zLmNsZWFyQnV0dG9uID8gJChzLnBhcmFtcy5jbGVhckJ1dHRvbikgOiBzLmNvbnRhaW5lci5maW5kKCcuc2VhcmNoYmFyLWNsZWFyJyk7XG4gICAgICAgICAgICBzLmNhbmNlbEJ1dHRvbiA9IHMucGFyYW1zLmNhbmNlbEJ1dHRvbiA/ICQocy5wYXJhbXMuY2FuY2VsQnV0dG9uKSA6IHMuY29udGFpbmVyLmZpbmQoJy5zZWFyY2hiYXItY2FuY2VsJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2VhcmNoIExpc3RcbiAgICAgICAgICAgIHMuc2VhcmNoTGlzdCA9ICQocy5wYXJhbXMuc2VhcmNoTGlzdCk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSXMgVmlydHVhbCBMaXN0XG4gICAgICAgICAgICBzLmlzVmlydHVhbExpc3QgPSBzLnNlYXJjaExpc3QuaGFzQ2xhc3MoJ3ZpcnR1YWwtbGlzdCcpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIElzIEluIFBhZ2VcbiAgICAgICAgICAgIHMucGFnZUNvbnRhaW5lciA9IHMuY29udGFpbmVyLnBhcmVudHMoJy5wYWdlJykuZXEoMCk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gT3ZlcmxheVxuICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5vdmVybGF5KSB7XG4gICAgICAgICAgICAgICAgcy5vdmVybGF5ID0gcy5wYWdlQ29udGFpbmVyLmxlbmd0aCA+IDAgPyBzLnBhZ2VDb250YWluZXIuZmluZCgnLnNlYXJjaGJhci1vdmVybGF5JykgOiAkKCcuc2VhcmNoYmFyLW92ZXJsYXknKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHMub3ZlcmxheSA9ICQocy5wYXJhbXMub3ZlcmxheSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBGb3VuZCBhbmQgbm90IGZvdW5kXG4gICAgICAgICAgICBpZiAoIXMucGFyYW1zLmZvdW5kKSB7XG4gICAgICAgICAgICAgICAgcy5mb3VuZCA9IHMucGFnZUNvbnRhaW5lci5sZW5ndGggPiAwID8gcy5wYWdlQ29udGFpbmVyLmZpbmQoJy5zZWFyY2hiYXItZm91bmQnKSA6ICQoJy5zZWFyY2hiYXItZm91bmQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHMuZm91bmQgPSAkKHMucGFyYW1zLmZvdW5kKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghcy5wYXJhbXMubm90Rm91bmQpIHtcbiAgICAgICAgICAgICAgICBzLm5vdEZvdW5kID0gcy5wYWdlQ29udGFpbmVyLmxlbmd0aCA+IDAgPyBzLnBhZ2VDb250YWluZXIuZmluZCgnLnNlYXJjaGJhci1ub3QtZm91bmQnKSA6ICQoJy5zZWFyY2hiYXItbm90LWZvdW5kJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzLm5vdEZvdW5kID0gJChzLnBhcmFtcy5ub3RGb3VuZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGlhY3JpdGljc1xuICAgICAgICAgICAgdmFyIGRlZmF1bHREaWFjcml0aWNzUmVtb3ZhbGFwID0gW1xuICAgICAgICAgICAgICAgIHtiYXNlOidBJywgbGV0dGVyczonXFx1MDA0MVxcdTI0QjZcXHVGRjIxXFx1MDBDMFxcdTAwQzFcXHUwMEMyXFx1MUVBNlxcdTFFQTRcXHUxRUFBXFx1MUVBOFxcdTAwQzNcXHUwMTAwXFx1MDEwMlxcdTFFQjBcXHUxRUFFXFx1MUVCNFxcdTFFQjJcXHUwMjI2XFx1MDFFMFxcdTAwQzRcXHUwMURFXFx1MUVBMlxcdTAwQzVcXHUwMUZBXFx1MDFDRFxcdTAyMDBcXHUwMjAyXFx1MUVBMFxcdTFFQUNcXHUxRUI2XFx1MUUwMFxcdTAxMDRcXHUwMjNBXFx1MkM2Rid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidBQScsbGV0dGVyczonXFx1QTczMid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidBRScsbGV0dGVyczonXFx1MDBDNlxcdTAxRkNcXHUwMUUyJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0FPJyxsZXR0ZXJzOidcXHVBNzM0J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0FVJyxsZXR0ZXJzOidcXHVBNzM2J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0FWJyxsZXR0ZXJzOidcXHVBNzM4XFx1QTczQSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidBWScsbGV0dGVyczonXFx1QTczQyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidCJywgbGV0dGVyczonXFx1MDA0MlxcdTI0QjdcXHVGRjIyXFx1MUUwMlxcdTFFMDRcXHUxRTA2XFx1MDI0M1xcdTAxODJcXHUwMTgxJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0MnLCBsZXR0ZXJzOidcXHUwMDQzXFx1MjRCOFxcdUZGMjNcXHUwMTA2XFx1MDEwOFxcdTAxMEFcXHUwMTBDXFx1MDBDN1xcdTFFMDhcXHUwMTg3XFx1MDIzQlxcdUE3M0UnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonRCcsIGxldHRlcnM6J1xcdTAwNDRcXHUyNEI5XFx1RkYyNFxcdTFFMEFcXHUwMTBFXFx1MUUwQ1xcdTFFMTBcXHUxRTEyXFx1MUUwRVxcdTAxMTBcXHUwMThCXFx1MDE4QVxcdTAxODlcXHVBNzc5J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0RaJyxsZXR0ZXJzOidcXHUwMUYxXFx1MDFDNCd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidEeicsbGV0dGVyczonXFx1MDFGMlxcdTAxQzUnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonRScsIGxldHRlcnM6J1xcdTAwNDVcXHUyNEJBXFx1RkYyNVxcdTAwQzhcXHUwMEM5XFx1MDBDQVxcdTFFQzBcXHUxRUJFXFx1MUVDNFxcdTFFQzJcXHUxRUJDXFx1MDExMlxcdTFFMTRcXHUxRTE2XFx1MDExNFxcdTAxMTZcXHUwMENCXFx1MUVCQVxcdTAxMUFcXHUwMjA0XFx1MDIwNlxcdTFFQjhcXHUxRUM2XFx1MDIyOFxcdTFFMUNcXHUwMTE4XFx1MUUxOFxcdTFFMUFcXHUwMTkwXFx1MDE4RSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidGJywgbGV0dGVyczonXFx1MDA0NlxcdTI0QkJcXHVGRjI2XFx1MUUxRVxcdTAxOTFcXHVBNzdCJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0cnLCBsZXR0ZXJzOidcXHUwMDQ3XFx1MjRCQ1xcdUZGMjdcXHUwMUY0XFx1MDExQ1xcdTFFMjBcXHUwMTFFXFx1MDEyMFxcdTAxRTZcXHUwMTIyXFx1MDFFNFxcdTAxOTNcXHVBN0EwXFx1QTc3RFxcdUE3N0UnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonSCcsIGxldHRlcnM6J1xcdTAwNDhcXHUyNEJEXFx1RkYyOFxcdTAxMjRcXHUxRTIyXFx1MUUyNlxcdTAyMUVcXHUxRTI0XFx1MUUyOFxcdTFFMkFcXHUwMTI2XFx1MkM2N1xcdTJDNzVcXHVBNzhEJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0knLCBsZXR0ZXJzOidcXHUwMDQ5XFx1MjRCRVxcdUZGMjlcXHUwMENDXFx1MDBDRFxcdTAwQ0VcXHUwMTI4XFx1MDEyQVxcdTAxMkNcXHUwMTMwXFx1MDBDRlxcdTFFMkVcXHUxRUM4XFx1MDFDRlxcdTAyMDhcXHUwMjBBXFx1MUVDQVxcdTAxMkVcXHUxRTJDXFx1MDE5Nyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidKJywgbGV0dGVyczonXFx1MDA0QVxcdTI0QkZcXHVGRjJBXFx1MDEzNFxcdTAyNDgnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonSycsIGxldHRlcnM6J1xcdTAwNEJcXHUyNEMwXFx1RkYyQlxcdTFFMzBcXHUwMUU4XFx1MUUzMlxcdTAxMzZcXHUxRTM0XFx1MDE5OFxcdTJDNjlcXHVBNzQwXFx1QTc0MlxcdUE3NDRcXHVBN0EyJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J0wnLCBsZXR0ZXJzOidcXHUwMDRDXFx1MjRDMVxcdUZGMkNcXHUwMTNGXFx1MDEzOVxcdTAxM0RcXHUxRTM2XFx1MUUzOFxcdTAxM0JcXHUxRTNDXFx1MUUzQVxcdTAxNDFcXHUwMjNEXFx1MkM2MlxcdTJDNjBcXHVBNzQ4XFx1QTc0NlxcdUE3ODAnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonTEonLGxldHRlcnM6J1xcdTAxQzcnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonTGonLGxldHRlcnM6J1xcdTAxQzgnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonTScsIGxldHRlcnM6J1xcdTAwNERcXHUyNEMyXFx1RkYyRFxcdTFFM0VcXHUxRTQwXFx1MUU0MlxcdTJDNkVcXHUwMTlDJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J04nLCBsZXR0ZXJzOidcXHUwMDRFXFx1MjRDM1xcdUZGMkVcXHUwMUY4XFx1MDE0M1xcdTAwRDFcXHUxRTQ0XFx1MDE0N1xcdTFFNDZcXHUwMTQ1XFx1MUU0QVxcdTFFNDhcXHUwMjIwXFx1MDE5RFxcdUE3OTBcXHVBN0E0J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J05KJyxsZXR0ZXJzOidcXHUwMUNBJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J05qJyxsZXR0ZXJzOidcXHUwMUNCJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J08nLCBsZXR0ZXJzOidcXHUwMDRGXFx1MjRDNFxcdUZGMkZcXHUwMEQyXFx1MDBEM1xcdTAwRDRcXHUxRUQyXFx1MUVEMFxcdTFFRDZcXHUxRUQ0XFx1MDBENVxcdTFFNENcXHUwMjJDXFx1MUU0RVxcdTAxNENcXHUxRTUwXFx1MUU1MlxcdTAxNEVcXHUwMjJFXFx1MDIzMFxcdTAwRDZcXHUwMjJBXFx1MUVDRVxcdTAxNTBcXHUwMUQxXFx1MDIwQ1xcdTAyMEVcXHUwMUEwXFx1MUVEQ1xcdTFFREFcXHUxRUUwXFx1MUVERVxcdTFFRTJcXHUxRUNDXFx1MUVEOFxcdTAxRUFcXHUwMUVDXFx1MDBEOFxcdTAxRkVcXHUwMTg2XFx1MDE5RlxcdUE3NEFcXHVBNzRDJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J09JJyxsZXR0ZXJzOidcXHUwMUEyJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J09PJyxsZXR0ZXJzOidcXHVBNzRFJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J09VJyxsZXR0ZXJzOidcXHUwMjIyJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J09FJyxsZXR0ZXJzOidcXHUwMDhDXFx1MDE1Mid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidvZScsbGV0dGVyczonXFx1MDA5Q1xcdTAxNTMnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonUCcsIGxldHRlcnM6J1xcdTAwNTBcXHUyNEM1XFx1RkYzMFxcdTFFNTRcXHUxRTU2XFx1MDFBNFxcdTJDNjNcXHVBNzUwXFx1QTc1MlxcdUE3NTQnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonUScsIGxldHRlcnM6J1xcdTAwNTFcXHUyNEM2XFx1RkYzMVxcdUE3NTZcXHVBNzU4XFx1MDI0QSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidSJywgbGV0dGVyczonXFx1MDA1MlxcdTI0QzdcXHVGRjMyXFx1MDE1NFxcdTFFNThcXHUwMTU4XFx1MDIxMFxcdTAyMTJcXHUxRTVBXFx1MUU1Q1xcdTAxNTZcXHUxRTVFXFx1MDI0Q1xcdTJDNjRcXHVBNzVBXFx1QTdBNlxcdUE3ODInfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonUycsIGxldHRlcnM6J1xcdTAwNTNcXHUyNEM4XFx1RkYzM1xcdTFFOUVcXHUwMTVBXFx1MUU2NFxcdTAxNUNcXHUxRTYwXFx1MDE2MFxcdTFFNjZcXHUxRTYyXFx1MUU2OFxcdTAyMThcXHUwMTVFXFx1MkM3RVxcdUE3QThcXHVBNzg0J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J1QnLCBsZXR0ZXJzOidcXHUwMDU0XFx1MjRDOVxcdUZGMzRcXHUxRTZBXFx1MDE2NFxcdTFFNkNcXHUwMjFBXFx1MDE2MlxcdTFFNzBcXHUxRTZFXFx1MDE2NlxcdTAxQUNcXHUwMUFFXFx1MDIzRVxcdUE3ODYnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonVFonLGxldHRlcnM6J1xcdUE3MjgnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonVScsIGxldHRlcnM6J1xcdTAwNTVcXHUyNENBXFx1RkYzNVxcdTAwRDlcXHUwMERBXFx1MDBEQlxcdTAxNjhcXHUxRTc4XFx1MDE2QVxcdTFFN0FcXHUwMTZDXFx1MDBEQ1xcdTAxREJcXHUwMUQ3XFx1MDFENVxcdTAxRDlcXHUxRUU2XFx1MDE2RVxcdTAxNzBcXHUwMUQzXFx1MDIxNFxcdTAyMTZcXHUwMUFGXFx1MUVFQVxcdTFFRThcXHUxRUVFXFx1MUVFQ1xcdTFFRjBcXHUxRUU0XFx1MUU3MlxcdTAxNzJcXHUxRTc2XFx1MUU3NFxcdTAyNDQnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonVicsIGxldHRlcnM6J1xcdTAwNTZcXHUyNENCXFx1RkYzNlxcdTFFN0NcXHUxRTdFXFx1MDFCMlxcdUE3NUVcXHUwMjQ1J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J1ZZJyxsZXR0ZXJzOidcXHVBNzYwJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J1cnLCBsZXR0ZXJzOidcXHUwMDU3XFx1MjRDQ1xcdUZGMzdcXHUxRTgwXFx1MUU4MlxcdTAxNzRcXHUxRTg2XFx1MUU4NFxcdTFFODhcXHUyQzcyJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J1gnLCBsZXR0ZXJzOidcXHUwMDU4XFx1MjRDRFxcdUZGMzhcXHUxRThBXFx1MUU4Qyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidZJywgbGV0dGVyczonXFx1MDA1OVxcdTI0Q0VcXHVGRjM5XFx1MUVGMlxcdTAwRERcXHUwMTc2XFx1MUVGOFxcdTAyMzJcXHUxRThFXFx1MDE3OFxcdTFFRjZcXHUxRUY0XFx1MDFCM1xcdTAyNEVcXHUxRUZFJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J1onLCBsZXR0ZXJzOidcXHUwMDVBXFx1MjRDRlxcdUZGM0FcXHUwMTc5XFx1MUU5MFxcdTAxN0JcXHUwMTdEXFx1MUU5MlxcdTFFOTRcXHUwMUI1XFx1MDIyNFxcdTJDN0ZcXHUyQzZCXFx1QTc2Mid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidhJywgbGV0dGVyczonXFx1MDA2MVxcdTI0RDBcXHVGRjQxXFx1MUU5QVxcdTAwRTBcXHUwMEUxXFx1MDBFMlxcdTFFQTdcXHUxRUE1XFx1MUVBQlxcdTFFQTlcXHUwMEUzXFx1MDEwMVxcdTAxMDNcXHUxRUIxXFx1MUVBRlxcdTFFQjVcXHUxRUIzXFx1MDIyN1xcdTAxRTFcXHUwMEU0XFx1MDFERlxcdTFFQTNcXHUwMEU1XFx1MDFGQlxcdTAxQ0VcXHUwMjAxXFx1MDIwM1xcdTFFQTFcXHUxRUFEXFx1MUVCN1xcdTFFMDFcXHUwMTA1XFx1MkM2NVxcdTAyNTAnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonYWEnLGxldHRlcnM6J1xcdUE3MzMnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonYWUnLGxldHRlcnM6J1xcdTAwRTZcXHUwMUZEXFx1MDFFMyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidhbycsbGV0dGVyczonXFx1QTczNSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidhdScsbGV0dGVyczonXFx1QTczNyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidhdicsbGV0dGVyczonXFx1QTczOVxcdUE3M0InfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonYXknLGxldHRlcnM6J1xcdUE3M0QnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonYicsIGxldHRlcnM6J1xcdTAwNjJcXHUyNEQxXFx1RkY0MlxcdTFFMDNcXHUxRTA1XFx1MUUwN1xcdTAxODBcXHUwMTgzXFx1MDI1Myd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidjJywgbGV0dGVyczonXFx1MDA2M1xcdTI0RDJcXHVGRjQzXFx1MDEwN1xcdTAxMDlcXHUwMTBCXFx1MDEwRFxcdTAwRTdcXHUxRTA5XFx1MDE4OFxcdTAyM0NcXHVBNzNGXFx1MjE4NCd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidkJywgbGV0dGVyczonXFx1MDA2NFxcdTI0RDNcXHVGRjQ0XFx1MUUwQlxcdTAxMEZcXHUxRTBEXFx1MUUxMVxcdTFFMTNcXHUxRTBGXFx1MDExMVxcdTAxOENcXHUwMjU2XFx1MDI1N1xcdUE3N0EnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonZHonLGxldHRlcnM6J1xcdTAxRjNcXHUwMUM2J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J2UnLCBsZXR0ZXJzOidcXHUwMDY1XFx1MjRENFxcdUZGNDVcXHUwMEU4XFx1MDBFOVxcdTAwRUFcXHUxRUMxXFx1MUVCRlxcdTFFQzVcXHUxRUMzXFx1MUVCRFxcdTAxMTNcXHUxRTE1XFx1MUUxN1xcdTAxMTVcXHUwMTE3XFx1MDBFQlxcdTFFQkJcXHUwMTFCXFx1MDIwNVxcdTAyMDdcXHUxRUI5XFx1MUVDN1xcdTAyMjlcXHUxRTFEXFx1MDExOVxcdTFFMTlcXHUxRTFCXFx1MDI0N1xcdTAyNUJcXHUwMUREJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J2YnLCBsZXR0ZXJzOidcXHUwMDY2XFx1MjRENVxcdUZGNDZcXHUxRTFGXFx1MDE5MlxcdUE3N0MnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonZycsIGxldHRlcnM6J1xcdTAwNjdcXHUyNEQ2XFx1RkY0N1xcdTAxRjVcXHUwMTFEXFx1MUUyMVxcdTAxMUZcXHUwMTIxXFx1MDFFN1xcdTAxMjNcXHUwMUU1XFx1MDI2MFxcdUE3QTFcXHUxRDc5XFx1QTc3Rid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidoJywgbGV0dGVyczonXFx1MDA2OFxcdTI0RDdcXHVGRjQ4XFx1MDEyNVxcdTFFMjNcXHUxRTI3XFx1MDIxRlxcdTFFMjVcXHUxRTI5XFx1MUUyQlxcdTFFOTZcXHUwMTI3XFx1MkM2OFxcdTJDNzZcXHUwMjY1J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J2h2JyxsZXR0ZXJzOidcXHUwMTk1J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J2knLCBsZXR0ZXJzOidcXHUwMDY5XFx1MjREOFxcdUZGNDlcXHUwMEVDXFx1MDBFRFxcdTAwRUVcXHUwMTI5XFx1MDEyQlxcdTAxMkRcXHUwMEVGXFx1MUUyRlxcdTFFQzlcXHUwMUQwXFx1MDIwOVxcdTAyMEJcXHUxRUNCXFx1MDEyRlxcdTFFMkRcXHUwMjY4XFx1MDEzMSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidqJywgbGV0dGVyczonXFx1MDA2QVxcdTI0RDlcXHVGRjRBXFx1MDEzNVxcdTAxRjBcXHUwMjQ5J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J2snLCBsZXR0ZXJzOidcXHUwMDZCXFx1MjREQVxcdUZGNEJcXHUxRTMxXFx1MDFFOVxcdTFFMzNcXHUwMTM3XFx1MUUzNVxcdTAxOTlcXHUyQzZBXFx1QTc0MVxcdUE3NDNcXHVBNzQ1XFx1QTdBMyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidsJywgbGV0dGVyczonXFx1MDA2Q1xcdTI0REJcXHVGRjRDXFx1MDE0MFxcdTAxM0FcXHUwMTNFXFx1MUUzN1xcdTFFMzlcXHUwMTNDXFx1MUUzRFxcdTFFM0JcXHUwMTdGXFx1MDE0MlxcdTAxOUFcXHUwMjZCXFx1MkM2MVxcdUE3NDlcXHVBNzgxXFx1QTc0Nyd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidsaicsbGV0dGVyczonXFx1MDFDOSd9LFxuICAgICAgICAgICAgICAgIHtiYXNlOidtJywgbGV0dGVyczonXFx1MDA2RFxcdTI0RENcXHVGRjREXFx1MUUzRlxcdTFFNDFcXHUxRTQzXFx1MDI3MVxcdTAyNkYnfSxcbiAgICAgICAgICAgICAgICB7YmFzZTonbicsIGxldHRlcnM6J1xcdTAwNkVcXHUyNEREXFx1RkY0RVxcdTAxRjlcXHUwMTQ0XFx1MDBGMVxcdTFFNDVcXHUwMTQ4XFx1MUU0N1xcdTAxNDZcXHUxRTRCXFx1MUU0OVxcdTAxOUVcXHUwMjcyXFx1MDE0OVxcdUE3OTFcXHVBN0E1J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J25qJyxsZXR0ZXJzOidcXHUwMUNDJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J28nLCBsZXR0ZXJzOidcXHUwMDZGXFx1MjRERVxcdUZGNEZcXHUwMEYyXFx1MDBGM1xcdTAwRjRcXHUxRUQzXFx1MUVEMVxcdTFFRDdcXHUxRUQ1XFx1MDBGNVxcdTFFNERcXHUwMjJEXFx1MUU0RlxcdTAxNERcXHUxRTUxXFx1MUU1M1xcdTAxNEZcXHUwMjJGXFx1MDIzMVxcdTAwRjZcXHUwMjJCXFx1MUVDRlxcdTAxNTFcXHUwMUQyXFx1MDIwRFxcdTAyMEZcXHUwMUExXFx1MUVERFxcdTFFREJcXHUxRUUxXFx1MUVERlxcdTFFRTNcXHUxRUNEXFx1MUVEOVxcdTAxRUJcXHUwMUVEXFx1MDBGOFxcdTAxRkZcXHUwMjU0XFx1QTc0QlxcdUE3NERcXHUwMjc1J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J29pJyxsZXR0ZXJzOidcXHUwMUEzJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J291JyxsZXR0ZXJzOidcXHUwMjIzJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J29vJyxsZXR0ZXJzOidcXHVBNzRGJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J3AnLGxldHRlcnM6J1xcdTAwNzBcXHUyNERGXFx1RkY1MFxcdTFFNTVcXHUxRTU3XFx1MDFBNVxcdTFEN0RcXHVBNzUxXFx1QTc1M1xcdUE3NTUnfSxcbiAgICAgICAgICAgICAgICB7YmFzZToncScsbGV0dGVyczonXFx1MDA3MVxcdTI0RTBcXHVGRjUxXFx1MDI0QlxcdUE3NTdcXHVBNzU5J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J3InLGxldHRlcnM6J1xcdTAwNzJcXHUyNEUxXFx1RkY1MlxcdTAxNTVcXHUxRTU5XFx1MDE1OVxcdTAyMTFcXHUwMjEzXFx1MUU1QlxcdTFFNURcXHUwMTU3XFx1MUU1RlxcdTAyNERcXHUwMjdEXFx1QTc1QlxcdUE3QTdcXHVBNzgzJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J3MnLGxldHRlcnM6J1xcdTAwNzNcXHUyNEUyXFx1RkY1M1xcdTAwREZcXHUwMTVCXFx1MUU2NVxcdTAxNURcXHUxRTYxXFx1MDE2MVxcdTFFNjdcXHUxRTYzXFx1MUU2OVxcdTAyMTlcXHUwMTVGXFx1MDIzRlxcdUE3QTlcXHVBNzg1XFx1MUU5Qid9LFxuICAgICAgICAgICAgICAgIHtiYXNlOid0JyxsZXR0ZXJzOidcXHUwMDc0XFx1MjRFM1xcdUZGNTRcXHUxRTZCXFx1MUU5N1xcdTAxNjVcXHUxRTZEXFx1MDIxQlxcdTAxNjNcXHUxRTcxXFx1MUU2RlxcdTAxNjdcXHUwMUFEXFx1MDI4OFxcdTJDNjZcXHVBNzg3J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J3R6JyxsZXR0ZXJzOidcXHVBNzI5J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J3UnLGxldHRlcnM6ICdcXHUwMDc1XFx1MjRFNFxcdUZGNTVcXHUwMEY5XFx1MDBGQVxcdTAwRkJcXHUwMTY5XFx1MUU3OVxcdTAxNkJcXHUxRTdCXFx1MDE2RFxcdTAwRkNcXHUwMURDXFx1MDFEOFxcdTAxRDZcXHUwMURBXFx1MUVFN1xcdTAxNkZcXHUwMTcxXFx1MDFENFxcdTAyMTVcXHUwMjE3XFx1MDFCMFxcdTFFRUJcXHUxRUU5XFx1MUVFRlxcdTFFRURcXHUxRUYxXFx1MUVFNVxcdTFFNzNcXHUwMTczXFx1MUU3N1xcdTFFNzVcXHUwMjg5J30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J3YnLGxldHRlcnM6J1xcdTAwNzZcXHUyNEU1XFx1RkY1NlxcdTFFN0RcXHUxRTdGXFx1MDI4QlxcdUE3NUZcXHUwMjhDJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J3Z5JyxsZXR0ZXJzOidcXHVBNzYxJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J3cnLGxldHRlcnM6J1xcdTAwNzdcXHUyNEU2XFx1RkY1N1xcdTFFODFcXHUxRTgzXFx1MDE3NVxcdTFFODdcXHUxRTg1XFx1MUU5OFxcdTFFODlcXHUyQzczJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J3gnLGxldHRlcnM6J1xcdTAwNzhcXHUyNEU3XFx1RkY1OFxcdTFFOEJcXHUxRThEJ30sXG4gICAgICAgICAgICAgICAge2Jhc2U6J3knLGxldHRlcnM6J1xcdTAwNzlcXHUyNEU4XFx1RkY1OVxcdTFFRjNcXHUwMEZEXFx1MDE3N1xcdTFFRjlcXHUwMjMzXFx1MUU4RlxcdTAwRkZcXHUxRUY3XFx1MUU5OVxcdTFFRjVcXHUwMUI0XFx1MDI0RlxcdTFFRkYnfSxcbiAgICAgICAgICAgICAgICB7YmFzZToneicsbGV0dGVyczonXFx1MDA3QVxcdTI0RTlcXHVGRjVBXFx1MDE3QVxcdTFFOTFcXHUwMTdDXFx1MDE3RVxcdTFFOTNcXHUxRTk1XFx1MDFCNlxcdTAyMjVcXHUwMjQwXFx1MkM2Q1xcdUE3NjMnfVxuICAgICAgICAgICAgXTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgZGlhY3JpdGljc01hcCA9IHt9O1xuICAgICAgICAgICAgZm9yICh2YXIgaT0wOyBpIDwgZGVmYXVsdERpYWNyaXRpY3NSZW1vdmFsYXAubGVuZ3RoOyBpKyspe1xuICAgICAgICAgICAgICAgIHZhciBsZXR0ZXJzID0gZGVmYXVsdERpYWNyaXRpY3NSZW1vdmFsYXBbaV0ubGV0dGVycztcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBqPTA7IGogPCBsZXR0ZXJzLmxlbmd0aCA7IGorKyl7XG4gICAgICAgICAgICAgICAgICAgIGRpYWNyaXRpY3NNYXBbbGV0dGVyc1tqXV0gPSBkZWZhdWx0RGlhY3JpdGljc1JlbW92YWxhcFtpXS5iYXNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiByZW1vdmVEaWFjcml0aWNzIChzdHIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoL1teXFx1MDAwMC1cXHUwMDdFXS9nLCBmdW5jdGlvbihhKXsgXG4gICAgICAgICAgICAgICAgICAgcmV0dXJuIGRpYWNyaXRpY3NNYXBbYV0gfHwgYTsgXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2V0IENhbmNlbCBidXR0b25cbiAgICAgICAgICAgIHZhciBjYW5jZWxNYXJnaW5Qcm9wID0gYXBwLnJ0bCA/ICdtYXJnaW4tbGVmdCcgOiAnbWFyZ2luLXJpZ2h0JztcbiAgICAgICAgICAgIHZhciBjYW5jZWxCdXR0b25IYXNNYXJnaW4gPSBmYWxzZTtcbiAgICAgICAgICAgIHMuc2V0Q2FuY2VsQnV0dG9uTWFyZ2luID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHMuY2FuY2VsQnV0dG9uLnRyYW5zaXRpb24oMCkuc2hvdygpO1xuICAgICAgICAgICAgICAgIHMuY2FuY2VsQnV0dG9uLmNzcyhjYW5jZWxNYXJnaW5Qcm9wLCAtcy5jYW5jZWxCdXR0b25bMF0ub2Zmc2V0V2lkdGggKyAncHgnKTtcbiAgICAgICAgICAgICAgICB2YXIgY2xpZW50TGVmdCA9IHMuY2FuY2VsQnV0dG9uWzBdLmNsaWVudExlZnQ7XG4gICAgICAgICAgICAgICAgcy5jYW5jZWxCdXR0b24udHJhbnNpdGlvbignJyk7XG4gICAgICAgICAgICAgICAgY2FuY2VsQnV0dG9uSGFzTWFyZ2luID0gdHJ1ZTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVHJpZ2dlclxuICAgICAgICAgICAgcy50cmlnZ2VyRXZlbnQgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBjYWxsYmFja05hbWUsIGV2ZW50RGF0YSkge1xuICAgICAgICAgICAgICAgIHMuY29udGFpbmVyLnRyaWdnZXIoZXZlbnROYW1lLCBldmVudERhdGEpO1xuICAgICAgICAgICAgICAgIGlmIChzLnNlYXJjaExpc3QubGVuZ3RoID4gMCkgcy5zZWFyY2hMaXN0LnRyaWdnZXIoZXZlbnROYW1lLCBldmVudERhdGEpO1xuICAgICAgICAgICAgICAgIGlmIChjYWxsYmFja05hbWUgJiYgcy5wYXJhbXNbY2FsbGJhY2tOYW1lXSkgcy5wYXJhbXNbY2FsbGJhY2tOYW1lXShzLCBldmVudERhdGEpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBFbmFibGUvZGlzYWxiZVxuICAgICAgICAgICAgcy5lbmFibGUgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIF9lbmFibGUoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgocy5zZWFyY2hMaXN0Lmxlbmd0aCB8fCBzLnBhcmFtcy5jdXN0b21TZWFyY2gpICYmICFzLmNvbnRhaW5lci5oYXNDbGFzcygnc2VhcmNoYmFyLWFjdGl2ZScpICYmICFzLnF1ZXJ5KSBzLm92ZXJsYXkuYWRkQ2xhc3MoJ3NlYXJjaGJhci1vdmVybGF5LWFjdGl2ZScpO1xuICAgICAgICAgICAgICAgICAgICBzLmNvbnRhaW5lci5hZGRDbGFzcygnc2VhcmNoYmFyLWFjdGl2ZScpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5jYW5jZWxCdXR0b24ubGVuZ3RoID4gMCAmJiAhcy5tYXRlcmlhbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjYW5jZWxCdXR0b25IYXNNYXJnaW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLnNldENhbmNlbEJ1dHRvbk1hcmdpbigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcy5jYW5jZWxCdXR0b24uY3NzKGNhbmNlbE1hcmdpblByb3AsICcwcHgnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzLnRyaWdnZXJFdmVudCgnZW5hYmxlU2VhcmNoJywgJ29uRW5hYmxlJyk7XG4gICAgICAgICAgICAgICAgICAgIHMuYWN0aXZlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UuaW9zICYmICFhcHAucGFyYW1zLm1hdGVyaWFsICYmIGUgJiYgZS50eXBlID09PSAnZm9jdXMnKSB7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgX2VuYWJsZSgpO1xuICAgICAgICAgICAgICAgICAgICB9LCA0MDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgX2VuYWJsZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgcy5kaXNhYmxlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHMuaW5wdXQudmFsKCcnKS50cmlnZ2VyKCdjaGFuZ2UnKTtcbiAgICAgICAgICAgICAgICBzLmNvbnRhaW5lci5yZW1vdmVDbGFzcygnc2VhcmNoYmFyLWFjdGl2ZSBzZWFyY2hiYXItbm90LWVtcHR5Jyk7XG4gICAgICAgICAgICAgICAgaWYgKHMuY2FuY2VsQnV0dG9uLmxlbmd0aCA+IDAgJiYgIXMubWF0ZXJpYWwpIHMuY2FuY2VsQnV0dG9uLmNzcyhjYW5jZWxNYXJnaW5Qcm9wLCAtcy5jYW5jZWxCdXR0b25bMF0ub2Zmc2V0V2lkdGggKyAncHgnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHMuc2VhcmNoTGlzdC5sZW5ndGggfHwgcy5wYXJhbXMuY3VzdG9tU2VhcmNoKSBzLm92ZXJsYXkucmVtb3ZlQ2xhc3MoJ3NlYXJjaGJhci1vdmVybGF5LWFjdGl2ZScpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBzLmFjdGl2ZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIF9kaXNhYmxlKCkge1xuICAgICAgICAgICAgICAgICAgICBzLmlucHV0LmJsdXIoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UuaW9zKSB7XG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgX2Rpc2FibGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgNDAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIF9kaXNhYmxlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHMudHJpZ2dlckV2ZW50KCdkaXNhYmxlU2VhcmNoJywgJ29uRGlzYWJsZScpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDbGVhclxuICAgICAgICAgICAgcy5jbGVhciA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzLnF1ZXJ5ICYmIGUgJiYgJChlLnRhcmdldCkuaGFzQ2xhc3MoJ3NlYXJjaGJhci1jbGVhcicpKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuZGlzYWJsZSgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHMuaW5wdXQudmFsKCcnKS50cmlnZ2VyKCdjaGFuZ2UnKS5mb2N1cygpO1xuICAgICAgICAgICAgICAgIHMudHJpZ2dlckV2ZW50KCdjbGVhclNlYXJjaCcsICdvbkNsZWFyJyk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNlYXJjaFxuICAgICAgICAgICAgcy5oYW5kbGVJbnB1dCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gcy5pbnB1dC52YWwoKS50cmltKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICgocy5zZWFyY2hMaXN0Lmxlbmd0aCA+IDAgfHwgcy5wYXJhbXMuY3VzdG9tU2VhcmNoKSAmJiAocy5wYXJhbXMuc2VhcmNoSW4gfHwgcy5pc1ZpcnR1YWxMaXN0KSkgcy5zZWFyY2godmFsdWUsIHRydWUpO1xuICAgICAgICAgICAgICAgIH0sIDApO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgcHJldmlvdXNRdWVyeSA9ICcnO1xuICAgICAgICAgICAgdmFyIHZpcnR1YWxMaXN0O1xuICAgICAgICAgICAgcy5zZWFyY2ggPSBmdW5jdGlvbiAocXVlcnksIGludGVybmFsKSB7XG4gICAgICAgICAgICAgICAgaWYgKHF1ZXJ5LnRyaW0oKSA9PT0gcHJldmlvdXNRdWVyeSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHByZXZpb3VzUXVlcnkgPSBxdWVyeS50cmltKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICghaW50ZXJuYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFzLmFjdGl2ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5lbmFibGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzLmlucHV0LnZhbChxdWVyeSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHMucXVlcnkgPSBzLnZhbHVlID0gcXVlcnk7XG4gICAgICAgICAgICAgICAgLy8gQWRkIGFjdGl2ZS9pbmFjdGl2ZSBjbGFzc2VzIG9uIG92ZXJsYXlcbiAgICAgICAgICAgICAgICBpZiAocXVlcnkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuY29udGFpbmVyLnJlbW92ZUNsYXNzKCdzZWFyY2hiYXItbm90LWVtcHR5Jyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnNlYXJjaExpc3QubGVuZ3RoICYmIHMuY29udGFpbmVyLmhhc0NsYXNzKCdzZWFyY2hiYXItYWN0aXZlJykpIHMub3ZlcmxheS5hZGRDbGFzcygnc2VhcmNoYmFyLW92ZXJsYXktYWN0aXZlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzLmNvbnRhaW5lci5hZGRDbGFzcygnc2VhcmNoYmFyLW5vdC1lbXB0eScpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5zZWFyY2hMaXN0Lmxlbmd0aCAmJiBzLmNvbnRhaW5lci5oYXNDbGFzcygnc2VhcmNoYmFyLWFjdGl2ZScpKSBzLm92ZXJsYXkucmVtb3ZlQ2xhc3MoJ3NlYXJjaGJhci1vdmVybGF5LWFjdGl2ZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmN1c3RvbVNlYXJjaCkge1xuICAgICAgICAgICAgICAgICAgICBzLnRyaWdnZXJFdmVudCgnc2VhcmNoJywgJ29uU2VhcmNoJywge3F1ZXJ5OiBxdWVyeX0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBmb3VuZEl0ZW1zID0gW107XG4gICAgICAgICAgICAgICAgaWYgKHMuaXNWaXJ0dWFsTGlzdCkge1xuICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsTGlzdCA9IHMuc2VhcmNoTGlzdFswXS5mN1ZpcnR1YWxMaXN0O1xuICAgICAgICAgICAgICAgICAgICBpZiAocXVlcnkudHJpbSgpID09PSAnJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmlydHVhbExpc3QucmVzZXRGaWx0ZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMubm90Rm91bmQuaGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5mb3VuZC5zaG93KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHZpcnR1YWxMaXN0LnBhcmFtcy5zZWFyY2hBbGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kSXRlbXMgPSB2aXJ0dWFsTGlzdC5wYXJhbXMuc2VhcmNoQWxsKHF1ZXJ5LCB2aXJ0dWFsTGlzdC5pdGVtcykgfHwgW107XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodmlydHVhbExpc3QucGFyYW1zLnNlYXJjaEJ5SXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2aXJ0dWFsTGlzdC5pdGVtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHZpcnR1YWxMaXN0LnBhcmFtcy5zZWFyY2hCeUl0ZW0ocXVlcnksIGksIHZpcnR1YWxMaXN0LnBhcmFtcy5pdGVtc1tpXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRJdGVtcy5wdXNoKGkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlcztcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnJlbW92ZURpYWNyaXRpY3MpIHZhbHVlcyA9IHJlbW92ZURpYWNyaXRpY3MocXVlcnkudHJpbSgpLnRvTG93ZXJDYXNlKCkpLnNwbGl0KCcgJyk7XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzID0gcXVlcnkudHJpbSgpLnRvTG93ZXJDYXNlKCkuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzLnNlYXJjaExpc3QuZmluZCgnbGknKS5yZW1vdmVDbGFzcygnaGlkZGVuLWJ5LXNlYXJjaGJhcicpLmVhY2goZnVuY3Rpb24gKGluZGV4LCBlbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWwgPSAkKGVsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb21wYXJlV2l0aFRleHQgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmZpbmQocy5wYXJhbXMuc2VhcmNoSW4pLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdGVtVGV4dCA9ICQodGhpcykudGV4dCgpLnRyaW0oKS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5yZW1vdmVEaWFjcml0aWNzKSBpdGVtVGV4dCA9IHJlbW92ZURpYWNyaXRpY3MoaXRlbVRleHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBhcmVXaXRoVGV4dC5wdXNoKGl0ZW1UZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29tcGFyZVdpdGhUZXh0ID0gY29tcGFyZVdpdGhUZXh0LmpvaW4oJyAnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3b3Jkc01hdGNoID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBhcmVXaXRoVGV4dC5pbmRleE9mKHZhbHVlc1tpXSkgPj0gMCkgd29yZHNNYXRjaCsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHdvcmRzTWF0Y2ggIT09IHZhbHVlcy5sZW5ndGggJiYgIShzLnBhcmFtcy5pZ25vcmUgJiYgZWwuaXMocy5wYXJhbXMuaWdub3JlKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5hZGRDbGFzcygnaGlkZGVuLWJ5LXNlYXJjaGJhcicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRJdGVtcy5wdXNoKGVsWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuaGlkZURpdmlkZXJzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnNlYXJjaExpc3QuZmluZCgnLml0ZW0tZGl2aWRlciwgLmxpc3QtZ3JvdXAtdGl0bGUnKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGl0bGUgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXh0RWxlbWVudHMgPSB0aXRsZS5uZXh0QWxsKCdsaScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoaWRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG5leHRFbGVtZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dEVsID0gJChuZXh0RWxlbWVudHNbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV4dEVsLmhhc0NsYXNzKCdsaXN0LWdyb3VwLXRpdGxlJykgfHwgbmV4dEVsLmhhc0NsYXNzKCdpdGVtLWRpdmlkZXInKSkgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbmV4dEVsLmhhc0NsYXNzKCdoaWRkZW4tYnktc2VhcmNoYmFyJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhpZGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWdub3JlID0gcy5wYXJhbXMuaWdub3JlICYmIHRpdGxlLmlzKHMucGFyYW1zLmlnbm9yZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhpZGUgJiYgIWlnbm9yZSkgdGl0bGUuYWRkQ2xhc3MoJ2hpZGRlbi1ieS1zZWFyY2hiYXInKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHRpdGxlLnJlbW92ZUNsYXNzKCdoaWRkZW4tYnktc2VhcmNoYmFyJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuaGlkZUdyb3Vwcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5zZWFyY2hMaXN0LmZpbmQoJy5saXN0LWdyb3VwJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdyb3VwID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaWdub3JlID0gcy5wYXJhbXMuaWdub3JlICYmIGdyb3VwLmlzKHMucGFyYW1zLmlnbm9yZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5vdEhpZGRlbiA9IGdyb3VwLmZpbmQoJ2xpOm5vdCguaGlkZGVuLWJ5LXNlYXJjaGJhciknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm90SGlkZGVuLmxlbmd0aCA9PT0gMCAmJiAhaWdub3JlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwLmFkZENsYXNzKCdoaWRkZW4tYnktc2VhcmNoYmFyJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBncm91cC5yZW1vdmVDbGFzcygnaGlkZGVuLWJ5LXNlYXJjaGJhcicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHMudHJpZ2dlckV2ZW50KCdzZWFyY2gnLCAnb25TZWFyY2gnLCB7cXVlcnk6IHF1ZXJ5LCBmb3VuZEl0ZW1zOiBmb3VuZEl0ZW1zfSk7XG4gICAgICAgICAgICAgICAgaWYgKGZvdW5kSXRlbXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHMubm90Rm91bmQuc2hvdygpO1xuICAgICAgICAgICAgICAgICAgICBzLmZvdW5kLmhpZGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHMubm90Rm91bmQuaGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICBzLmZvdW5kLnNob3coKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMuaXNWaXJ0dWFsTGlzdCkge1xuICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsTGlzdC5maWx0ZXJJdGVtcyhmb3VuZEl0ZW1zKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEV2ZW50c1xuICAgICAgICAgICAgZnVuY3Rpb24gcHJldmVudFN1Ym1pdChlKSB7XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIHMuYXR0YWNoRXZlbnRzID0gZnVuY3Rpb24gKGRlc3Ryb3kpIHtcbiAgICAgICAgICAgICAgICB2YXIgbWV0aG9kID0gZGVzdHJveSA/ICdvZmYnIDogJ29uJztcbiAgICAgICAgICAgICAgICBzLmNvbnRhaW5lclttZXRob2RdKCdzdWJtaXQnLCBwcmV2ZW50U3VibWl0KTtcbiAgICAgICAgICAgICAgICBpZiAoIXMubWF0ZXJpYWwpIHMuY2FuY2VsQnV0dG9uW21ldGhvZF0oJ2NsaWNrJywgcy5kaXNhYmxlKTtcbiAgICAgICAgICAgICAgICBzLm92ZXJsYXlbbWV0aG9kXSgnY2xpY2snLCBzLmRpc2FibGUpO1xuICAgICAgICAgICAgICAgIHMuaW5wdXRbbWV0aG9kXSgnZm9jdXMnLCBzLmVuYWJsZSk7XG4gICAgICAgICAgICAgICAgcy5pbnB1dFttZXRob2RdKCdjaGFuZ2Uga2V5ZG93biBrZXlwcmVzcyBrZXl1cCcsIHMuaGFuZGxlSW5wdXQpO1xuICAgICAgICAgICAgICAgIHMuY2xlYXJCdXR0b25bbWV0aG9kXSgnY2xpY2snLCBzLmNsZWFyKTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcy5kZXRhY2hFdmVudHMgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBzLmF0dGFjaEV2ZW50cyh0cnVlKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBEZXN0cm95XG4gICAgICAgICAgICBzLmluaXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcy5hdHRhY2hFdmVudHMoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBzLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzKSByZXR1cm47XG4gICAgICAgICAgICAgICAgcy5kZXRhY2hFdmVudHMoKTtcbiAgICAgICAgICAgICAgICBzID0gbnVsbDtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdFxuICAgICAgICAgICAgcy5pbml0KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgcy5jb250YWluZXJbMF0uZjdTZWFyY2hiYXIgPSBzO1xuICAgICAgICAgICAgcmV0dXJuIHM7XG4gICAgICAgIFxuICAgICAgICB9O1xuICAgICAgICBhcHAuc2VhcmNoYmFyID0gZnVuY3Rpb24gKGNvbnRhaW5lciwgcGFyYW1zKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFNlYXJjaGJhcihjb250YWluZXIsIHBhcmFtcyk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5pbml0U2VhcmNoYmFyID0gZnVuY3Rpb24gKGNvbnRhaW5lcikge1xuICAgICAgICAgICAgY29udGFpbmVyID0gJChjb250YWluZXIpO1xuICAgICAgICAgICAgdmFyIHNlYXJjaGJhciA9IGNvbnRhaW5lci5oYXNDbGFzcygnc2VhcmNoYmFyJykgPyBjb250YWluZXIgOiBjb250YWluZXIuZmluZCgnLnNlYXJjaGJhcicpO1xuICAgICAgICAgICAgaWYgKHNlYXJjaGJhci5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIGlmICghc2VhcmNoYmFyLmhhc0NsYXNzKCdzZWFyY2hiYXItaW5pdCcpKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHNiID0gYXBwLnNlYXJjaGJhcihzZWFyY2hiYXIsIHNlYXJjaGJhci5kYXRhc2V0KCkpO1xuICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIG9uQmVmb3JlUmVtb3ZlKCkge1xuICAgICAgICAgICAgICAgIGlmIChzYikgc2IuZGVzdHJveSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5oYXNDbGFzcygncGFnZScpKSB7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyLm9uY2UoJ3BhZ2VCZWZvcmVSZW1vdmUnLCBvbkJlZm9yZVJlbW92ZSk7ICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChjb250YWluZXIuaGFzQ2xhc3MoJ25hdmJhci1pbm5lcicpKSB7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyLm9uY2UoJ25hdmJhckJlZm9yZVJlbW92ZScsIG9uQmVmb3JlUmVtb3ZlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBNZXNzYWdlYmFyICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHZhciBNZXNzYWdlYmFyID0gZnVuY3Rpb24gKGNvbnRhaW5lciwgcGFyYW1zKSB7XG4gICAgICAgICAgICB2YXIgZGVmYXVsdHMgPSB7XG4gICAgICAgICAgICAgICAgdGV4dGFyZWE6IG51bGwsXG4gICAgICAgICAgICAgICAgbWF4SGVpZ2h0OiBudWxsLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcbiAgICAgICAgICAgIGZvciAodmFyIGRlZiBpbiBkZWZhdWx0cykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW2RlZl0gPT09ICd1bmRlZmluZWQnIHx8IHBhcmFtc1tkZWZdID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtc1tkZWZdID0gZGVmYXVsdHNbZGVmXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEluc3RhbmNlXG4gICAgICAgICAgICB2YXIgbSA9IHRoaXM7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUGFyYW1zXG4gICAgICAgICAgICBtLnBhcmFtcyA9IHBhcmFtcztcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDb250YWluZXJcbiAgICAgICAgICAgIG0uY29udGFpbmVyID0gJChjb250YWluZXIpO1xuICAgICAgICAgICAgaWYgKG0uY29udGFpbmVyLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFRleHRhcmVhXG4gICAgICAgICAgICBtLnRleHRhcmVhID0gbS5wYXJhbXMudGV4dGFyZWEgPyAkKG0ucGFyYW1zLnRleHRhcmVhKSA6IG0uY29udGFpbmVyLmZpbmQoJ3RleHRhcmVhJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSXMgSW4gUGFnZVxuICAgICAgICAgICAgbS5wYWdlQ29udGFpbmVyID0gbS5jb250YWluZXIucGFyZW50cygnLnBhZ2UnKS5lcSgwKTtcbiAgICAgICAgICAgIG0ucGFnZUNvbnRlbnQgPSBtLnBhZ2VDb250YWluZXIuZmluZCgnLnBhZ2UtY29udGVudCcpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXRpYWwgU2l6ZXNcbiAgICAgICAgICAgIG0ucGFnZUNvbnRlbnRQYWRkaW5nID0gcGFyc2VJbnQobS5wYWdlQ29udGVudC5jc3MoJ3BhZGRpbmctYm90dG9tJykpO1xuICAgICAgICAgICAgbS5pbml0aWFsQmFySGVpZ2h0ID0gbS5jb250YWluZXJbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgbS5pbml0aWFsQXJlYUhlaWdodCA9IG0udGV4dGFyZWFbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUmVzaXplIHRleHRhcmVhXG4gICAgICAgICAgICBtLnNpemVUZXh0YXJlYSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAvLyBSZXNldFxuICAgICAgICAgICAgICAgIG0udGV4dGFyZWEuY3NzKHsnaGVpZ2h0JzogJyd9KTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgaGVpZ2h0ID0gbS50ZXh0YXJlYVswXS5vZmZzZXRIZWlnaHQ7XG4gICAgICAgICAgICAgICAgdmFyIGRpZmYgPSBoZWlnaHQgLSBtLnRleHRhcmVhWzBdLmNsaWVudEhlaWdodDtcbiAgICAgICAgICAgICAgICB2YXIgc2Nyb2xsSGVpZ2h0ID0gbS50ZXh0YXJlYVswXS5zY3JvbGxIZWlnaHQ7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZVxuICAgICAgICAgICAgICAgIGlmIChzY3JvbGxIZWlnaHQgKyBkaWZmID4gaGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdBcmVhSGVpZ2h0ID0gc2Nyb2xsSGVpZ2h0ICsgZGlmZjtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld0JhckhlaWdodCA9IG0uaW5pdGlhbEJhckhlaWdodCArIChuZXdBcmVhSGVpZ2h0IC0gbS5pbml0aWFsQXJlYUhlaWdodCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBtYXhCYXJIZWlnaHQgPSBtLnBhcmFtcy5tYXhIZWlnaHQgfHwgbS5jb250YWluZXIucGFyZW50cygnLnZpZXcnKVswXS5vZmZzZXRIZWlnaHQgLSA4ODtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5ld0JhckhlaWdodCA+IG1heEJhckhlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3QmFySGVpZ2h0ID0gcGFyc2VJbnQobWF4QmFySGVpZ2h0LCAxMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdBcmVhSGVpZ2h0ID0gbmV3QmFySGVpZ2h0IC0gbS5pbml0aWFsQmFySGVpZ2h0ICsgbS5pbml0aWFsQXJlYUhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBtLnRleHRhcmVhLmNzcygnaGVpZ2h0JywgbmV3QXJlYUhlaWdodCArICdweCcpO1xuICAgICAgICAgICAgICAgICAgICBtLmNvbnRhaW5lci5jc3MoJ2hlaWdodCcsIG5ld0JhckhlaWdodCArICdweCcpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgb25Cb3R0b20gPSAobS5wYWdlQ29udGVudFswXS5zY3JvbGxUb3AgPT09IG0ucGFnZUNvbnRlbnRbMF0uc2Nyb2xsSGVpZ2h0IC0gbS5wYWdlQ29udGVudFswXS5vZmZzZXRIZWlnaHQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAobS5wYWdlQ29udGVudC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtLnBhZ2VDb250ZW50LmNzcygncGFkZGluZy1ib3R0b20nLCBuZXdCYXJIZWlnaHQgKyAncHgnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtLnBhZ2VDb250ZW50LmZpbmQoJy5tZXNzYWdlcy1uZXctZmlyc3QnKS5sZW5ndGggPT09IDAgJiYgb25Cb3R0b20pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtLnBhZ2VDb250ZW50LnNjcm9sbFRvcChtLnBhZ2VDb250ZW50WzBdLnNjcm9sbEhlaWdodCAtIG0ucGFnZUNvbnRlbnRbMF0ub2Zmc2V0SGVpZ2h0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG0ucGFnZUNvbnRlbnQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbS5jb250YWluZXIuY3NzKHsnaGVpZ2h0JzogJycsICdib3R0b20nOiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgbS5wYWdlQ29udGVudC5jc3MoeydwYWRkaW5nLWJvdHRvbSc6ICcnfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBDbGVhclxuICAgICAgICAgICAgbS5jbGVhciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBtLnRleHRhcmVhLnZhbCgnJykudHJpZ2dlcignY2hhbmdlJyk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbS52YWx1ZSA9IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbS50ZXh0YXJlYS52YWwoKTtcbiAgICAgICAgICAgICAgICBlbHNlIG0udGV4dGFyZWEudmFsKHZhbHVlKS50cmlnZ2VyKCdjaGFuZ2UnKTsgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gSGFuZGxlIHRleHRhcmVhXG4gICAgICAgICAgICBtLnRleHRhcmVhVGltZW91dCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIG0uaGFuZGxlVGV4dGFyZWEgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChtLnRleHRhcmVhVGltZW91dCk7XG4gICAgICAgICAgICAgICAgbS50ZXh0YXJlYVRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgbS5zaXplVGV4dGFyZWEoKTtcbiAgICAgICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy9FdmVudHNcbiAgICAgICAgICAgIGZ1bmN0aW9uIHByZXZlbnRTdWJtaXQoZSkge1xuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBtLmF0dGFjaEV2ZW50cyA9IGZ1bmN0aW9uIChkZXN0cm95KSB7XG4gICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGRlc3Ryb3kgPyAnb2ZmJyA6ICdvbic7XG4gICAgICAgICAgICAgICAgbS5jb250YWluZXJbbWV0aG9kXSgnc3VibWl0JywgcHJldmVudFN1Ym1pdCk7XG4gICAgICAgICAgICAgICAgbS50ZXh0YXJlYVttZXRob2RdKCdjaGFuZ2Uga2V5ZG93biBrZXlwcmVzcyBrZXl1cCBwYXN0ZSBjdXQnLCBtLmhhbmRsZVRleHRhcmVhKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBtLmRldGFjaEV2ZW50cyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBtLmF0dGFjaEV2ZW50cyh0cnVlKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgRGVzdHJveVxuICAgICAgICAgICAgbS5pbml0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIG0uYXR0YWNoRXZlbnRzKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbS5kZXN0cm95ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIG0uZGV0YWNoRXZlbnRzKCk7XG4gICAgICAgICAgICAgICAgbSA9IG51bGw7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXRcbiAgICAgICAgICAgIG0uaW5pdCgpO1xuICAgICAgICBcbiAgICAgICAgICAgIG0uY29udGFpbmVyWzBdLmY3TWVzc2FnZWJhciA9IG07XG4gICAgICAgICAgICByZXR1cm4gbTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLm1lc3NhZ2ViYXIgPSBmdW5jdGlvbiAoY29udGFpbmVyLCBwYXJhbXMpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgTWVzc2FnZWJhcihjb250YWluZXIsIHBhcmFtcyk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5pbml0UGFnZU1lc3NhZ2ViYXIgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICB2YXIgbWVzc2FnZWJhciA9IHBhZ2VDb250YWluZXIuaGFzQ2xhc3MoJ21lc3NhZ2ViYXInKSA/IHBhZ2VDb250YWluZXIgOiBwYWdlQ29udGFpbmVyLmZpbmQoJy5tZXNzYWdlYmFyJyk7XG4gICAgICAgICAgICBpZiAobWVzc2FnZWJhci5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIGlmICghbWVzc2FnZWJhci5oYXNDbGFzcygnbWVzc2FnZWJhci1pbml0JykpIHJldHVybjtcbiAgICAgICAgICAgIHZhciBtYiA9IGFwcC5tZXNzYWdlYmFyKG1lc3NhZ2ViYXIsIG1lc3NhZ2ViYXIuZGF0YXNldCgpKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBEZXN0cm95IG9uIHBhZ2UgcmVtb3ZlXG4gICAgICAgICAgICBmdW5jdGlvbiBwYWdlQmVmb3JlUmVtb3ZlKCkge1xuICAgICAgICAgICAgICAgIG1iLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyLm9mZigncGFnZUJlZm9yZVJlbW92ZScsIHBhZ2VCZWZvcmVSZW1vdmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHBhZ2VDb250YWluZXIuaGFzQ2xhc3MoJ3BhZ2UnKSkge1xuICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIub24oJ3BhZ2VCZWZvcmVSZW1vdmUnLCBwYWdlQmVmb3JlUmVtb3ZlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBYSFIgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgLy8gWEhSIENhY2hpbmdcbiAgICAgICAgYXBwLmNhY2hlID0gW107XG4gICAgICAgIGFwcC5yZW1vdmVGcm9tQ2FjaGUgPSBmdW5jdGlvbiAodXJsKSB7XG4gICAgICAgICAgICB2YXIgaW5kZXggPSBmYWxzZTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXBwLmNhY2hlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5jYWNoZVtpXS51cmwgPT09IHVybCkgaW5kZXggPSBpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGluZGV4ICE9PSBmYWxzZSkgYXBwLmNhY2hlLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvLyBYSFJcbiAgICAgICAgYXBwLnhociA9IGZhbHNlO1xuICAgICAgICBhcHAuZ2V0ID0gZnVuY3Rpb24gKHVybCwgdmlldywgaWdub3JlQ2FjaGUsIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICAvLyBzaG91bGQgd2UgaWdub3JlIGdldCBwYXJhbXMgb3Igbm90XG4gICAgICAgICAgICB2YXIgX3VybCA9IHVybDtcbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmNhY2hlSWdub3JlR2V0UGFyYW1ldGVycyAmJiB1cmwuaW5kZXhPZignPycpID49IDApIHtcbiAgICAgICAgICAgICAgICBfdXJsID0gdXJsLnNwbGl0KCc/JylbMF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5jYWNoZSAmJiAhaWdub3JlQ2FjaGUgJiYgdXJsLmluZGV4T2YoJ25vY2FjaGUnKSA8IDAgJiYgYXBwLnBhcmFtcy5jYWNoZUlnbm9yZS5pbmRleE9mKF91cmwpIDwgMCkge1xuICAgICAgICAgICAgICAgIC8vIENoZWNrIGlzIHRoZSB1cmwgY2FjaGVkXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcHAuY2FjaGUubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5jYWNoZVtpXS51cmwgPT09IF91cmwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGV4cGlyYXRpb25cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgobmV3IERhdGUoKSkuZ2V0VGltZSgpIC0gYXBwLmNhY2hlW2ldLnRpbWUgPCBhcHAucGFyYW1zLmNhY2hlRHVyYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBMb2FkIGZyb20gY2FjaGVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhhcHAuY2FjaGVbaV0uY29udGVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGFwcC54aHIgPSAkLmFqYXgoe1xuICAgICAgICAgICAgICAgIHVybDogdXJsLFxuICAgICAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgICAgICAgICAgYmVmb3JlU2VuZDogYXBwLnBhcmFtcy5vbkFqYXhTdGFydCxcbiAgICAgICAgICAgICAgICBjb21wbGV0ZTogZnVuY3Rpb24gKHhocikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoKHhoci5zdGF0dXMgPj0gMjAwICYmIHhoci5zdGF0dXMgPCAzMDApIHx8IHhoci5zdGF0dXMgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnJlbW92ZUZyb21DYWNoZShfdXJsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAuY2FjaGUucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogX3VybCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGltZTogKG5ldyBEYXRlKCkpLmdldFRpbWUoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudDogeGhyLnJlc3BvbnNlVGV4dFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soeGhyLnJlc3BvbnNlVGV4dCwgZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soeGhyLnJlc3BvbnNlVGV4dCwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMub25BamF4Q29tcGxldGUpIGFwcC5wYXJhbXMub25BamF4Q29tcGxldGUoeGhyKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbiAoeGhyKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHhoci5yZXNwb25zZVRleHQsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5vbkFqYXhFcnJvcikgYXBwLnBhcmFtcy5vbkFqYXhFcnJvcih4aHIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaWYgKHZpZXcpIHZpZXcueGhyID0gYXBwLnhocjtcbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gYXBwLnhocjtcbiAgICAgICAgfTtcbiAgICAgICAgXG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgUGFnZXMgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgLy8gUGFnZSBDYWxsYmFja3MgQVBJXG4gICAgICAgIGFwcC5wYWdlQ2FsbGJhY2tzID0ge307XG4gICAgICAgIFxuICAgICAgICBhcHAub25QYWdlID0gZnVuY3Rpb24gKGNhbGxiYWNrTmFtZSwgcGFnZU5hbWUsIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICBpZiAocGFnZU5hbWUgJiYgcGFnZU5hbWUuc3BsaXQoJyAnKS5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2VOYW1lcyA9IHBhZ2VOYW1lLnNwbGl0KCcgJyk7XG4gICAgICAgICAgICAgICAgdmFyIHJldHVybkNhbGxiYWNrcyA9IFtdO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFnZU5hbWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybkNhbGxiYWNrcy5wdXNoKGFwcC5vblBhZ2UoY2FsbGJhY2tOYW1lLCBwYWdlTmFtZXNbaV0sIGNhbGxiYWNrKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybkNhbGxiYWNrcy5yZW1vdmUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmV0dXJuQ2FsbGJhY2tzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5DYWxsYmFja3NbaV0ucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHJldHVybkNhbGxiYWNrcy50cmlnZ2VyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJldHVybkNhbGxiYWNrcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuQ2FsbGJhY2tzW2ldLnRyaWdnZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJldHVybkNhbGxiYWNrcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBjYWxsYmFja3MgPSBhcHAucGFnZUNhbGxiYWNrc1tjYWxsYmFja05hbWVdW3BhZ2VOYW1lXTtcbiAgICAgICAgICAgIGlmICghY2FsbGJhY2tzKSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tzID0gYXBwLnBhZ2VDYWxsYmFja3NbY2FsbGJhY2tOYW1lXVtwYWdlTmFtZV0gPSBbXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFwcC5wYWdlQ2FsbGJhY2tzW2NhbGxiYWNrTmFtZV1bcGFnZU5hbWVdLnB1c2goY2FsbGJhY2spO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlbW92ZUluZGV4O1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNhbGxiYWNrcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrc1tpXS50b1N0cmluZygpID09PSBjYWxsYmFjay50b1N0cmluZygpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlSW5kZXggPSBpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVtb3ZlSW5kZXggIT09ICd1bmRlZmluZWQnKSBjYWxsYmFja3Muc3BsaWNlKHJlbW92ZUluZGV4LCAxKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHRyaWdnZXI6IGNhbGxiYWNrXG4gICAgICAgICAgICB9O1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLy9DcmVhdGUgY2FsbGJhY2tzIG1ldGhvZHMgZHluYW1pY2FsbHlcbiAgICAgICAgZnVuY3Rpb24gY3JlYXRlUGFnZUNhbGxiYWNrKGNhbGxiYWNrTmFtZSkge1xuICAgICAgICAgICAgdmFyIGNhcGl0YWxpemVkID0gY2FsbGJhY2tOYW1lLnJlcGxhY2UoL14uLywgZnVuY3Rpb24gKG1hdGNoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG1hdGNoLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGFwcFsnb25QYWdlJyArIGNhcGl0YWxpemVkXSA9IGZ1bmN0aW9uIChwYWdlTmFtZSwgY2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXBwLm9uUGFnZShjYWxsYmFja05hbWUsIHBhZ2VOYW1lLCBjYWxsYmFjayk7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB2YXIgcGFnZUNhbGxiYWNrc05hbWVzID0gKCdiZWZvcmVJbml0IGluaXQgcmVpbml0IGJlZm9yZUFuaW1hdGlvbiBhZnRlckFuaW1hdGlvbiBiYWNrIGFmdGVyQmFjayBiZWZvcmVSZW1vdmUnKS5zcGxpdCgnICcpO1xuICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhZ2VDYWxsYmFja3NOYW1lcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgYXBwLnBhZ2VDYWxsYmFja3NbcGFnZUNhbGxiYWNrc05hbWVzW2ldXSA9IHt9O1xuICAgICAgICAgICAgY3JlYXRlUGFnZUNhbGxiYWNrKHBhZ2VDYWxsYmFja3NOYW1lc1tpXSk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGFwcC50cmlnZ2VyUGFnZUNhbGxiYWNrcyA9IGZ1bmN0aW9uIChjYWxsYmFja05hbWUsIHBhZ2VOYW1lLCBwYWdlRGF0YSkge1xuICAgICAgICAgICAgdmFyIGFsbFBhZ2VzQ2FsbGJhY2tzID0gYXBwLnBhZ2VDYWxsYmFja3NbY2FsbGJhY2tOYW1lXVsnKiddO1xuICAgICAgICAgICAgaWYgKGFsbFBhZ2VzQ2FsbGJhY2tzKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBhbGxQYWdlc0NhbGxiYWNrcy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICBhbGxQYWdlc0NhbGxiYWNrc1tqXShwYWdlRGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIGNhbGxiYWNrcyA9IGFwcC5wYWdlQ2FsbGJhY2tzW2NhbGxiYWNrTmFtZV1bcGFnZU5hbWVdO1xuICAgICAgICAgICAgaWYgKCFjYWxsYmFja3MgfHwgY2FsbGJhY2tzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjYWxsYmFja3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFja3NbaV0ocGFnZURhdGEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLy8gT24gUGFnZSBJbml0IENhbGxiYWNrXG4gICAgICAgIGFwcC5wYWdlSW5pdENhbGxiYWNrID0gZnVuY3Rpb24gKHZpZXcsIHBhcmFtcykge1xuICAgICAgICAgICAgdmFyIHBhZ2VDb250YWluZXIgPSBwYXJhbXMucGFnZUNvbnRhaW5lcjtcbiAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmY3UGFnZUluaXRpYWxpemVkICYmIHZpZXcgJiYgIXZpZXcucGFyYW1zLmRvbUNhY2hlKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHBhZ2VRdWVyeSA9IHBhcmFtcy5xdWVyeTtcbiAgICAgICAgICAgIGlmICghcGFnZVF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhcmFtcy51cmwgJiYgcGFyYW1zLnVybC5pbmRleE9mKCc/JykgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VRdWVyeSA9ICQucGFyc2VVcmxRdWVyeShwYXJhbXMudXJsIHx8ICcnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAocGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhICYmIHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YS5xdWVyeSkge1xuICAgICAgICAgICAgICAgICAgICBwYWdlUXVlcnkgPSBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEucXVlcnk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwYWdlUXVlcnkgPSB7fTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUGFnZSBEYXRhXG4gICAgICAgICAgICB2YXIgcGFnZURhdGEgPSB7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyOiBwYWdlQ29udGFpbmVyLFxuICAgICAgICAgICAgICAgIHVybDogcGFyYW1zLnVybCxcbiAgICAgICAgICAgICAgICBxdWVyeTogcGFnZVF1ZXJ5LFxuICAgICAgICAgICAgICAgIG5hbWU6ICQocGFnZUNvbnRhaW5lcikuYXR0cignZGF0YS1wYWdlJyksXG4gICAgICAgICAgICAgICAgdmlldzogdmlldyxcbiAgICAgICAgICAgICAgICBmcm9tOiBwYXJhbXMucG9zaXRpb24sXG4gICAgICAgICAgICAgICAgY29udGV4dDogcGFyYW1zLmNvbnRleHQsXG4gICAgICAgICAgICAgICAgbmF2YmFySW5uZXJDb250YWluZXI6IHBhcmFtcy5uYXZiYXJJbm5lckNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICBmcm9tUGFnZTogcGFyYW1zLmZyb21QYWdlXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgaWYgKHBhcmFtcy5mcm9tUGFnZSAmJiAhcGFyYW1zLmZyb21QYWdlLm5hdmJhcklubmVyQ29udGFpbmVyICYmIHBhcmFtcy5vbGROYXZiYXJJbm5lckNvbnRhaW5lcikge1xuICAgICAgICAgICAgICAgIHBhcmFtcy5mcm9tUGFnZS5uYXZiYXJJbm5lckNvbnRhaW5lciA9IHBhcmFtcy5vbGROYXZiYXJJbm5lckNvbnRhaW5lcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAocGFnZUNvbnRhaW5lci5mN1BhZ2VJbml0aWFsaXplZCAmJiAoKHZpZXcgJiYgdmlldy5wYXJhbXMuZG9tQ2FjaGUpIHx8ICghdmlldyAmJiAkKHBhZ2VDb250YWluZXIpLnBhcmVudHMoJy5wb3B1cCwgLnBvcG92ZXIsIC5sb2dpbi1zY3JlZW4sIC5tb2RhbCwgLmFjdGlvbnMtbW9kYWwsIC5waWNrZXItbW9kYWwnKS5sZW5ndGggPiAwKSkpIHtcbiAgICAgICAgICAgICAgICAvLyBSZWluaXQgUGFnZVxuICAgICAgICAgICAgICAgIGFwcC5yZWluaXRQYWdlKHBhZ2VDb250YWluZXIpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBDYWxsYmFja3NcbiAgICAgICAgICAgICAgICBhcHAucGx1Z2luSG9vaygncGFnZVJlaW5pdCcsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5vblBhZ2VSZWluaXQpIGFwcC5wYXJhbXMub25QYWdlUmVpbml0KGFwcCwgcGFnZURhdGEpO1xuICAgICAgICAgICAgICAgIGFwcC50cmlnZ2VyUGFnZUNhbGxiYWNrcygncmVpbml0JywgcGFnZURhdGEubmFtZSwgcGFnZURhdGEpO1xuICAgICAgICAgICAgICAgICQocGFnZURhdGEuY29udGFpbmVyKS50cmlnZ2VyKCdwYWdlUmVpbml0Jywge3BhZ2U6IHBhZ2VEYXRhfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5mN1BhZ2VJbml0aWFsaXplZCA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU3RvcmUgcGFnZWRhdGEgaW4gcGFnZVxuICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhID0gcGFnZURhdGE7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVXBkYXRlIFZpZXcncyBhY3RpdmVQYWdlXG4gICAgICAgICAgICBpZiAodmlldyAmJiAhcGFyYW1zLnByZWxvYWRPbmx5ICYmICFwYXJhbXMucmVsb2FkUHJldmlvdXMpIHtcbiAgICAgICAgICAgICAgICAvLyBBZGQgZGF0YS1wYWdlIG9uIHZpZXdcbiAgICAgICAgICAgICAgICAkKHZpZXcuY29udGFpbmVyKS5hdHRyKCdkYXRhLXBhZ2UnLCBwYWdlRGF0YS5uYW1lKTtcbiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVmlldyBhY3RpdmUgcGFnZSBkYXRhXG4gICAgICAgICAgICAgICAgdmlldy5hY3RpdmVQYWdlID0gcGFnZURhdGE7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQmVmb3JlIEluaXQgQ2FsbGJhY2tzXG4gICAgICAgICAgICBhcHAucGx1Z2luSG9vaygncGFnZUJlZm9yZUluaXQnLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5vblBhZ2VCZWZvcmVJbml0KSBhcHAucGFyYW1zLm9uUGFnZUJlZm9yZUluaXQoYXBwLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICBhcHAudHJpZ2dlclBhZ2VDYWxsYmFja3MoJ2JlZm9yZUluaXQnLCBwYWdlRGF0YS5uYW1lLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAkKHBhZ2VEYXRhLmNvbnRhaW5lcikudHJpZ2dlcigncGFnZUJlZm9yZUluaXQnLCB7cGFnZTogcGFnZURhdGF9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0IHBhZ2VcbiAgICAgICAgICAgIGFwcC5pbml0UGFnZShwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0IENhbGxiYWNrXG4gICAgICAgICAgICBhcHAucGx1Z2luSG9vaygncGFnZUluaXQnLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5vblBhZ2VJbml0KSBhcHAucGFyYW1zLm9uUGFnZUluaXQoYXBwLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICBhcHAudHJpZ2dlclBhZ2VDYWxsYmFja3MoJ2luaXQnLCBwYWdlRGF0YS5uYW1lLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAkKHBhZ2VEYXRhLmNvbnRhaW5lcikudHJpZ2dlcigncGFnZUluaXQnLCB7cGFnZTogcGFnZURhdGF9KTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnBhZ2VSZW1vdmVDYWxsYmFjayA9IGZ1bmN0aW9uICh2aWV3LCBwYWdlQ29udGFpbmVyLCBwb3NpdGlvbikge1xuICAgICAgICAgICAgdmFyIHBhZ2VDb250ZXh0O1xuICAgICAgICAgICAgaWYgKHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YSkgcGFnZUNvbnRleHQgPSBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEuY29udGV4dDtcbiAgICAgICAgICAgIC8vIFBhZ2UgRGF0YVxuICAgICAgICAgICAgdmFyIHBhZ2VEYXRhID0ge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lcjogcGFnZUNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICBuYW1lOiAkKHBhZ2VDb250YWluZXIpLmF0dHIoJ2RhdGEtcGFnZScpLFxuICAgICAgICAgICAgICAgIHZpZXc6IHZpZXcsXG4gICAgICAgICAgICAgICAgdXJsOiBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEgJiYgcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhLnVybCxcbiAgICAgICAgICAgICAgICBxdWVyeTogcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhICYmIHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YS5xdWVyeSxcbiAgICAgICAgICAgICAgICBuYXZiYXJJbm5lckNvbnRhaW5lcjogcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhICYmIHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YS5uYXZiYXJJbm5lckNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICBmcm9tOiBwb3NpdGlvbixcbiAgICAgICAgICAgICAgICBjb250ZXh0OiBwYWdlQ29udGV4dFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIC8vIEJlZm9yZSBJbml0IENhbGxiYWNrXG4gICAgICAgICAgICBhcHAucGx1Z2luSG9vaygncGFnZUJlZm9yZVJlbW92ZScsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm9uUGFnZUJlZm9yZVJlbW92ZSkgYXBwLnBhcmFtcy5vblBhZ2VCZWZvcmVSZW1vdmUoYXBwLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICBhcHAudHJpZ2dlclBhZ2VDYWxsYmFja3MoJ2JlZm9yZVJlbW92ZScsIHBhZ2VEYXRhLm5hbWUsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICQocGFnZURhdGEuY29udGFpbmVyKS50cmlnZ2VyKCdwYWdlQmVmb3JlUmVtb3ZlJywge3BhZ2U6IHBhZ2VEYXRhfSk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5wYWdlQmFja0NhbGxiYWNrID0gZnVuY3Rpb24gKGNhbGxiYWNrLCB2aWV3LCBwYXJhbXMpIHtcbiAgICAgICAgICAgIC8vIFBhZ2UgRGF0YVxuICAgICAgICAgICAgdmFyIHBhZ2VDb250YWluZXIgPSBwYXJhbXMucGFnZUNvbnRhaW5lcjtcbiAgICAgICAgICAgIHZhciBwYWdlQ29udGV4dDtcbiAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEpIHBhZ2VDb250ZXh0ID0gcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhLmNvbnRleHQ7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHBhZ2VEYXRhID0ge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lcjogcGFnZUNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICBuYW1lOiAkKHBhZ2VDb250YWluZXIpLmF0dHIoJ2RhdGEtcGFnZScpLFxuICAgICAgICAgICAgICAgIHVybDogcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhICYmIHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YS51cmwsXG4gICAgICAgICAgICAgICAgcXVlcnk6IHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YSAmJiBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEucXVlcnksXG4gICAgICAgICAgICAgICAgdmlldzogdmlldyxcbiAgICAgICAgICAgICAgICBmcm9tOiBwYXJhbXMucG9zaXRpb24sXG4gICAgICAgICAgICAgICAgY29udGV4dDogcGFnZUNvbnRleHQsXG4gICAgICAgICAgICAgICAgbmF2YmFySW5uZXJDb250YWluZXI6IHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YSAmJiBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEubmF2YmFySW5uZXJDb250YWluZXIsXG4gICAgICAgICAgICAgICAgc3dpcGVCYWNrOiBwYXJhbXMuc3dpcGVCYWNrXG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChjYWxsYmFjayA9PT0gJ2FmdGVyJykge1xuICAgICAgICAgICAgICAgIGFwcC5wbHVnaW5Ib29rKCdwYWdlQWZ0ZXJCYWNrJywgcGFnZURhdGEpO1xuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm9uUGFnZUFmdGVyQmFjaykgYXBwLnBhcmFtcy5vblBhZ2VBZnRlckJhY2soYXBwLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAgICAgYXBwLnRyaWdnZXJQYWdlQ2FsbGJhY2tzKCdhZnRlckJhY2snLCBwYWdlRGF0YS5uYW1lLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAgICAgJChwYWdlQ29udGFpbmVyKS50cmlnZ2VyKCdwYWdlQWZ0ZXJCYWNrJywge3BhZ2U6IHBhZ2VEYXRhfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNhbGxiYWNrID09PSAnYmVmb3JlJykge1xuICAgICAgICAgICAgICAgIGFwcC5wbHVnaW5Ib29rKCdwYWdlQmFjaycsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5vblBhZ2VCYWNrKSBhcHAucGFyYW1zLm9uUGFnZUJhY2soYXBwLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAgICAgYXBwLnRyaWdnZXJQYWdlQ2FsbGJhY2tzKCdiYWNrJywgcGFnZURhdGEubmFtZSwgcGFnZURhdGEpO1xuICAgICAgICAgICAgICAgICQocGFnZURhdGEuY29udGFpbmVyKS50cmlnZ2VyKCdwYWdlQmFjaycsIHtwYWdlOiBwYWdlRGF0YX0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBhcHAucGFnZUFuaW1DYWxsYmFjayA9IGZ1bmN0aW9uIChjYWxsYmFjaywgdmlldywgcGFyYW1zKSB7XG4gICAgICAgICAgICB2YXIgcGFnZUNvbnRhaW5lciA9IHBhcmFtcy5wYWdlQ29udGFpbmVyO1xuICAgICAgICAgICAgdmFyIHBhZ2VDb250ZXh0O1xuICAgICAgICAgICAgaWYgKHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YSkgcGFnZUNvbnRleHQgPSBwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEuY29udGV4dDtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgcGFnZVF1ZXJ5ID0gcGFyYW1zLnF1ZXJ5O1xuICAgICAgICAgICAgaWYgKCFwYWdlUXVlcnkpIHtcbiAgICAgICAgICAgICAgICBpZiAocGFyYW1zLnVybCAmJiBwYXJhbXMudXJsLmluZGV4T2YoJz8nKSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZVF1ZXJ5ID0gJC5wYXJzZVVybFF1ZXJ5KHBhcmFtcy51cmwgfHwgJycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChwYWdlQ29udGFpbmVyLmY3UGFnZURhdGEgJiYgcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhLnF1ZXJ5KSB7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VRdWVyeSA9IHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YS5xdWVyeTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VRdWVyeSA9IHt9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIFBhZ2UgRGF0YVxuICAgICAgICAgICAgdmFyIHBhZ2VEYXRhID0ge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lcjogcGFnZUNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICB1cmw6IHBhcmFtcy51cmwsXG4gICAgICAgICAgICAgICAgcXVlcnk6IHBhZ2VRdWVyeSxcbiAgICAgICAgICAgICAgICBuYW1lOiAkKHBhZ2VDb250YWluZXIpLmF0dHIoJ2RhdGEtcGFnZScpLFxuICAgICAgICAgICAgICAgIHZpZXc6IHZpZXcsXG4gICAgICAgICAgICAgICAgZnJvbTogcGFyYW1zLnBvc2l0aW9uLFxuICAgICAgICAgICAgICAgIGNvbnRleHQ6IHBhZ2VDb250ZXh0LFxuICAgICAgICAgICAgICAgIHN3aXBlQmFjazogcGFyYW1zLnN3aXBlQmFjayxcbiAgICAgICAgICAgICAgICBuYXZiYXJJbm5lckNvbnRhaW5lcjogcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhICYmIHBhZ2VDb250YWluZXIuZjdQYWdlRGF0YS5uYXZiYXJJbm5lckNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICBmcm9tUGFnZTogcGFyYW1zLmZyb21QYWdlXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdmFyIG9sZFBhZ2UgPSBwYXJhbXMub2xkUGFnZSxcbiAgICAgICAgICAgICAgICBuZXdQYWdlID0gcGFyYW1zLm5ld1BhZ2U7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVXBkYXRlIHBhZ2UgZGF0ZVxuICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5mN1BhZ2VEYXRhID0gcGFnZURhdGE7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKGNhbGxiYWNrID09PSAnYWZ0ZXInKSB7XG4gICAgICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ3BhZ2VBZnRlckFuaW1hdGlvbicsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5vblBhZ2VBZnRlckFuaW1hdGlvbikgYXBwLnBhcmFtcy5vblBhZ2VBZnRlckFuaW1hdGlvbihhcHAsIHBhZ2VEYXRhKTtcbiAgICAgICAgICAgICAgICBhcHAudHJpZ2dlclBhZ2VDYWxsYmFja3MoJ2FmdGVyQW5pbWF0aW9uJywgcGFnZURhdGEubmFtZSwgcGFnZURhdGEpO1xuICAgICAgICAgICAgICAgICQocGFnZURhdGEuY29udGFpbmVyKS50cmlnZ2VyKCdwYWdlQWZ0ZXJBbmltYXRpb24nLCB7cGFnZTogcGFnZURhdGF9KTtcbiAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY2FsbGJhY2sgPT09ICdiZWZvcmUnKSB7XG4gICAgICAgICAgICAgICAgLy8gQWRkIGRhdGEtcGFnZSBvbiB2aWV3XG4gICAgICAgICAgICAgICAgJCh2aWV3LmNvbnRhaW5lcikuYXR0cignZGF0YS1wYWdlJywgcGFnZURhdGEubmFtZSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBWaWV3J3MgYWN0aXZlUGFnZVxuICAgICAgICAgICAgICAgIGlmICh2aWV3KSB2aWV3LmFjdGl2ZVBhZ2UgPSBwYWdlRGF0YTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gSGlkZS9zaG93IG5hdmJhciBkeW5hbWljYWxseVxuICAgICAgICAgICAgICAgIGlmIChuZXdQYWdlLmhhc0NsYXNzKCduby1uYXZiYXInKSAmJiAhb2xkUGFnZS5oYXNDbGFzcygnbm8tbmF2YmFyJykpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5oaWRlTmF2YmFyKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghbmV3UGFnZS5oYXNDbGFzcygnbm8tbmF2YmFyJykgJiYgKG9sZFBhZ2UuaGFzQ2xhc3MoJ25vLW5hdmJhcicpIHx8IG9sZFBhZ2UuaGFzQ2xhc3MoJ25vLW5hdmJhci1ieS1zY3JvbGwnKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5zaG93TmF2YmFyKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIEhpZGUvc2hvdyBuYXZiYXIgdG9vbGJhclxuICAgICAgICAgICAgICAgIGlmIChuZXdQYWdlLmhhc0NsYXNzKCduby10b29sYmFyJykgJiYgIW9sZFBhZ2UuaGFzQ2xhc3MoJ25vLXRvb2xiYXInKSkge1xuICAgICAgICAgICAgICAgICAgICB2aWV3LmhpZGVUb29sYmFyKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghbmV3UGFnZS5oYXNDbGFzcygnbm8tdG9vbGJhcicpICYmIChvbGRQYWdlLmhhc0NsYXNzKCduby10b29sYmFyJykgfHwgb2xkUGFnZS5oYXNDbGFzcygnbm8tdG9vbGJhci1ieS1zY3JvbGwnKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5zaG93VG9vbGJhcigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBIaWRlL3Nob3cgdGFiYmFyXG4gICAgICAgICAgICAgICAgdmFyIHRhYkJhcjtcbiAgICAgICAgICAgICAgICBpZiAobmV3UGFnZS5oYXNDbGFzcygnbm8tdGFiYmFyJykgJiYgIW9sZFBhZ2UuaGFzQ2xhc3MoJ25vLXRhYmJhcicpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRhYkJhciA9ICQodmlldy5jb250YWluZXIpLmZpbmQoJy50YWJiYXInKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhYkJhci5sZW5ndGggPT09IDApIHRhYkJhciA9ICQodmlldy5jb250YWluZXIpLnBhcmVudHMoJy4nICsgYXBwLnBhcmFtcy52aWV3c0NsYXNzKS5maW5kKCcudGFiYmFyJyk7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5oaWRlVG9vbGJhcih0YWJCYXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIW5ld1BhZ2UuaGFzQ2xhc3MoJ25vLXRhYmJhcicpICYmIChvbGRQYWdlLmhhc0NsYXNzKCduby10YWJiYXInKSB8fCBvbGRQYWdlLmhhc0NsYXNzKCduby10YWJiYXItYnktc2Nyb2xsJykpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRhYkJhciA9ICQodmlldy5jb250YWluZXIpLmZpbmQoJy50YWJiYXInKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhYkJhci5sZW5ndGggPT09IDApIHRhYkJhciA9ICQodmlldy5jb250YWluZXIpLnBhcmVudHMoJy4nICsgYXBwLnBhcmFtcy52aWV3c0NsYXNzKS5maW5kKCcudGFiYmFyJyk7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5zaG93VG9vbGJhcih0YWJCYXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgb2xkUGFnZS5yZW1vdmVDbGFzcygnbm8tbmF2YmFyLWJ5LXNjcm9sbCBuby10b29sYmFyLWJ5LXNjcm9sbCcpO1xuICAgICAgICAgICAgICAgIC8vIENhbGxiYWNrc1xuICAgICAgICAgICAgICAgIGFwcC5wbHVnaW5Ib29rKCdwYWdlQmVmb3JlQW5pbWF0aW9uJywgcGFnZURhdGEpO1xuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm9uUGFnZUJlZm9yZUFuaW1hdGlvbikgYXBwLnBhcmFtcy5vblBhZ2VCZWZvcmVBbmltYXRpb24oYXBwLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAgICAgYXBwLnRyaWdnZXJQYWdlQ2FsbGJhY2tzKCdiZWZvcmVBbmltYXRpb24nLCBwYWdlRGF0YS5uYW1lLCBwYWdlRGF0YSk7XG4gICAgICAgICAgICAgICAgJChwYWdlRGF0YS5jb250YWluZXIpLnRyaWdnZXIoJ3BhZ2VCZWZvcmVBbmltYXRpb24nLCB7cGFnZTogcGFnZURhdGF9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8vIEluaXQgUGFnZSBFdmVudHMgYW5kIE1hbmlwdWxhdGlvbnNcbiAgICAgICAgYXBwLmluaXRQYWdlID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgaWYgKHBhZ2VDb250YWluZXIubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICAvLyBTaXplIG5hdmJhcnMgb24gcGFnZSBsb2FkXG4gICAgICAgICAgICBpZiAoYXBwLnNpemVOYXZiYXJzKSBhcHAuc2l6ZU5hdmJhcnMocGFnZUNvbnRhaW5lci5wYXJlbnRzKCcuJyArIGFwcC5wYXJhbXMudmlld0NsYXNzKVswXSk7XG4gICAgICAgICAgICAvLyBJbml0IG1lc3NhZ2VzXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRQYWdlTWVzc2FnZXMpIGFwcC5pbml0UGFnZU1lc3NhZ2VzKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgLy8gSW5pdCBmb3JtcyBzdG9yYWdlXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRGb3Jtc1N0b3JhZ2UpIGFwcC5pbml0Rm9ybXNTdG9yYWdlKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgLy8gSW5pdCBzbWFydCBzZWxlY3RcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdFNtYXJ0U2VsZWN0cykgYXBwLmluaXRTbWFydFNlbGVjdHMocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICAvLyBJbml0IHNsaWRlclxuICAgICAgICAgICAgaWYgKGFwcC5pbml0UGFnZVN3aXBlcikgYXBwLmluaXRQYWdlU3dpcGVyKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgLy8gSW5pdCBwdWxsIHRvIHJlZnJlc1xuICAgICAgICAgICAgaWYgKGFwcC5pbml0UHVsbFRvUmVmcmVzaCkgYXBwLmluaXRQdWxsVG9SZWZyZXNoKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgLy8gSW5pdCBpbmZpbml0ZSBzY3JvbGxcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdFBhZ2VJbmZpbml0ZVNjcm9sbCkgYXBwLmluaXRQYWdlSW5maW5pdGVTY3JvbGwocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICAvLyBJbml0IHNlYXJjaGJhclxuICAgICAgICAgICAgaWYgKGFwcC5pbml0U2VhcmNoYmFyKSBhcHAuaW5pdFNlYXJjaGJhcihwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIC8vIEluaXQgbWVzc2FnZSBiYXJcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdFBhZ2VNZXNzYWdlYmFyKSBhcHAuaW5pdFBhZ2VNZXNzYWdlYmFyKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgLy8gSW5pdCBzY3JvbGwgdG9vbGJhcnNcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdFBhZ2VTY3JvbGxUb29sYmFycykgYXBwLmluaXRQYWdlU2Nyb2xsVG9vbGJhcnMocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICAvLyBJbml0IGxhenkgaW1hZ2VzXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRJbWFnZXNMYXp5TG9hZCkgYXBwLmluaXRJbWFnZXNMYXp5TG9hZChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIC8vIEluaXQgcHJvZ3Jlc3MgYmFyc1xuICAgICAgICAgICAgaWYgKGFwcC5pbml0UGFnZVByb2dyZXNzYmFyKSBhcHAuaW5pdFBhZ2VQcm9ncmVzc2JhcihwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIC8vIEluaXQgcmVzaXplYWJsZSB0ZXh0YXJlYXNcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdFBhZ2VSZXNpemFibGVUZXh0YXJlYSkgYXBwLmluaXRQYWdlUmVzaXphYmxlVGV4dGFyZWEocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICAvLyBJbml0IE1hdGVyaWFsIFByZWxvYWRlclxuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwgJiYgYXBwLmluaXRQYWdlTWF0ZXJpYWxQcmVsb2FkZXIpIGFwcC5pbml0UGFnZU1hdGVyaWFsUHJlbG9hZGVyKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgLy8gSW5pdCBNYXRlcmlhbCBJbnB1dHNcbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsICYmIGFwcC5pbml0UGFnZU1hdGVyaWFsSW5wdXRzKSBhcHAuaW5pdFBhZ2VNYXRlcmlhbElucHV0cyhwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIC8vIEluaXQgTWF0ZXJpYWwgVGFiYmFyXG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBhcHAuaW5pdFBhZ2VNYXRlcmlhbFRhYmJhcikgYXBwLmluaXRQYWdlTWF0ZXJpYWxUYWJiYXIocGFnZUNvbnRhaW5lcik7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5yZWluaXRQYWdlID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgaWYgKHBhZ2VDb250YWluZXIubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICAvLyBTaXplIG5hdmJhcnMgb24gcGFnZSByZWluaXRcbiAgICAgICAgICAgIGlmIChhcHAuc2l6ZU5hdmJhcnMpIGFwcC5zaXplTmF2YmFycyhwYWdlQ29udGFpbmVyLnBhcmVudHMoJy4nICsgYXBwLnBhcmFtcy52aWV3Q2xhc3MpWzBdKTtcbiAgICAgICAgICAgIC8vIFJlaW5pdCBzbGlkZXJcbiAgICAgICAgICAgIGlmIChhcHAucmVpbml0UGFnZVN3aXBlcikgYXBwLnJlaW5pdFBhZ2VTd2lwZXIocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICAvLyBSZWluaXQgbGF6eSBsb2FkXG4gICAgICAgICAgICBpZiAoYXBwLnJlaW5pdExhenlMb2FkKSBhcHAucmVpbml0TGF6eUxvYWQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5pbml0UGFnZVdpdGhDYWxsYmFjayA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIHZhciB2aWV3Q29udGFpbmVyID0gcGFnZUNvbnRhaW5lci5wYXJlbnRzKCcuJyArIGFwcC5wYXJhbXMudmlld0NsYXNzKTtcbiAgICAgICAgICAgIGlmICh2aWV3Q29udGFpbmVyLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgdmFyIHZpZXcgPSB2aWV3Q29udGFpbmVyWzBdLmY3VmlldyB8fCB1bmRlZmluZWQ7XG4gICAgICAgICAgICB2YXIgdXJsID0gdmlldyAmJiB2aWV3LnVybCA/IHZpZXcudXJsIDogdW5kZWZpbmVkO1xuICAgICAgICAgICAgaWYgKHZpZXdDb250YWluZXIgJiYgcGFnZUNvbnRhaW5lci5hdHRyKCdkYXRhLXBhZ2UnKSkge1xuICAgICAgICAgICAgICAgIHZpZXdDb250YWluZXIuYXR0cignZGF0YS1wYWdlJywgcGFnZUNvbnRhaW5lci5hdHRyKCdkYXRhLXBhZ2UnKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhcHAucGFnZUluaXRDYWxsYmFjayh2aWV3LCB7cGFnZUNvbnRhaW5lcjogcGFnZUNvbnRhaW5lclswXSwgdXJsOiB1cmwsIHBvc2l0aW9uOiAnY2VudGVyJ30pO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIE5hdmlnYXRpb24gLyBSb3V0ZXIgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLnJvdXRlciA9IHtcbiAgICAgICAgICAgIC8vIFRlbXBvcmFyeSBET00gRWxlbWVudFxuICAgICAgICAgICAgdGVtcG9yYXJ5RG9tOiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSxcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBGaW5kIHBhZ2Ugb3IgbmF2YmFyIGluIHBhc3NlZCBjb250YWluZXIgd2hpY2ggYXJlIHJlbGF0ZWQgdG8gVmlld1xuICAgICAgICAgICAgZmluZEVsZW1lbnQ6IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGFpbmVyLCB2aWV3LCBub3RDYWNoZWQpIHtcbiAgICAgICAgICAgICAgICBjb250YWluZXIgPSAkKGNvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgaWYgKG5vdENhY2hlZCkgc2VsZWN0b3IgPSBzZWxlY3RvciArICc6bm90KC5jYWNoZWQpJztcbiAgICAgICAgICAgICAgICB2YXIgZm91bmQgPSBjb250YWluZXIuZmluZChzZWxlY3Rvcik7XG4gICAgICAgICAgICAgICAgaWYgKGZvdW5kLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2aWV3LnNlbGVjdG9yID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2VhcmNoIGluIHJlbGF0ZWQgdmlld1xuICAgICAgICAgICAgICAgICAgICAgICAgZm91bmQgPSBjb250YWluZXIuZmluZCh2aWV3LnNlbGVjdG9yICsgJyAnICsgc2VsZWN0b3IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChmb3VuZC5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBTZWFyY2ggaW4gbWFpbiB2aWV3XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3VuZCA9IGNvbnRhaW5lci5maW5kKCcuJyArIGFwcC5wYXJhbXMudmlld01haW5DbGFzcyArICcgJyArIHNlbGVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZm91bmQubGVuZ3RoID09PSAxKSByZXR1cm4gZm91bmQ7XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFRyeSB0byBmaW5kIG5vbiBjYWNoZWRcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFub3RDYWNoZWQpIGZvdW5kID0gYXBwLnJvdXRlci5maW5kRWxlbWVudChzZWxlY3RvciwgY29udGFpbmVyLCB2aWV3LCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvdW5kICYmIGZvdW5kLmxlbmd0aCA9PT0gMSkgcmV0dXJuIGZvdW5kO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTZXQgcGFnZXMgY2xhc3Nlc3MgZm9yIGFuaW1hdGlvbkVuZFxuICAgICAgICAgICAgYW5pbWF0ZVBhZ2VzOiBmdW5jdGlvbiAobGVmdFBhZ2UsIHJpZ2h0UGFnZSwgZGlyZWN0aW9uLCB2aWV3KSB7XG4gICAgICAgICAgICAgICAgLy8gTG9hZGluZyBuZXcgcGFnZVxuICAgICAgICAgICAgICAgIHZhciByZW1vdmVDbGFzc2VzID0gJ3BhZ2Utb24tY2VudGVyIHBhZ2Utb24tcmlnaHQgcGFnZS1vbi1sZWZ0JztcbiAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAndG8tbGVmdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgbGVmdFBhZ2UucmVtb3ZlQ2xhc3MocmVtb3ZlQ2xhc3NlcykuYWRkQ2xhc3MoJ3BhZ2UtZnJvbS1jZW50ZXItdG8tbGVmdCcpO1xuICAgICAgICAgICAgICAgICAgICByaWdodFBhZ2UucmVtb3ZlQ2xhc3MocmVtb3ZlQ2xhc3NlcykuYWRkQ2xhc3MoJ3BhZ2UtZnJvbS1yaWdodC10by1jZW50ZXInKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gR28gYmFja1xuICAgICAgICAgICAgICAgIGlmIChkaXJlY3Rpb24gPT09ICd0by1yaWdodCcpIHtcbiAgICAgICAgICAgICAgICAgICAgbGVmdFBhZ2UucmVtb3ZlQ2xhc3MocmVtb3ZlQ2xhc3NlcykuYWRkQ2xhc3MoJ3BhZ2UtZnJvbS1sZWZ0LXRvLWNlbnRlcicpO1xuICAgICAgICAgICAgICAgICAgICByaWdodFBhZ2UucmVtb3ZlQ2xhc3MocmVtb3ZlQ2xhc3NlcykuYWRkQ2xhc3MoJ3BhZ2UtZnJvbS1jZW50ZXItdG8tcmlnaHQnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQcmVwYXJlIG5hdmJhciBiZWZvcmUgYW5pbWFyaW9uXG4gICAgICAgICAgICBwcmVwYXJlTmF2YmFyOiBmdW5jdGlvbiAobmV3TmF2YmFySW5uZXIsIG9sZE5hdmJhcklubmVyLCBuZXdOYXZiYXJQb3NpdGlvbikge1xuICAgICAgICAgICAgICAgICQobmV3TmF2YmFySW5uZXIpLmZpbmQoJy5zbGlkaW5nJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzbGlkaW5nID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRpbmdPZmZzZXQgPSBuZXdOYXZiYXJQb3NpdGlvbiA9PT0gJ3JpZ2h0JyA/IHRoaXMuZjdOYXZiYXJSaWdodE9mZnNldCA6IHRoaXMuZjdOYXZiYXJMZWZ0T2Zmc2V0O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuYW5pbWF0ZU5hdkJhY2tJY29uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2xpZGluZy5oYXNDbGFzcygnbGVmdCcpICYmIHNsaWRpbmcuZmluZCgnLmJhY2sgLmljb24nKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGluZy5maW5kKCcuYmFjayAuaWNvbicpLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArICgtc2xpZGluZ09mZnNldCkgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHNsaWRpbmcudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgc2xpZGluZ09mZnNldCArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNldCBuYXZiYXJzIGNsYXNzZXNzIGZvciBhbmltYXRpb25cbiAgICAgICAgICAgIGFuaW1hdGVOYXZiYXJzOiBmdW5jdGlvbiAobGVmdE5hdmJhcklubmVyLCByaWdodE5hdmJhcklubmVyLCBkaXJlY3Rpb24sIHZpZXcpIHtcbiAgICAgICAgICAgICAgICAvLyBMb2FkaW5nIG5ldyBwYWdlXG4gICAgICAgICAgICAgICAgdmFyIHJlbW92ZUNsYXNzZXMgPSAnbmF2YmFyLW9uLXJpZ2h0IG5hdmJhci1vbi1jZW50ZXIgbmF2YmFyLW9uLWxlZnQnO1xuICAgICAgICAgICAgICAgIGlmIChkaXJlY3Rpb24gPT09ICd0by1sZWZ0Jykge1xuICAgICAgICAgICAgICAgICAgICByaWdodE5hdmJhcklubmVyLnJlbW92ZUNsYXNzKHJlbW92ZUNsYXNzZXMpLmFkZENsYXNzKCduYXZiYXItZnJvbS1yaWdodC10by1jZW50ZXInKTtcbiAgICAgICAgICAgICAgICAgICAgcmlnaHROYXZiYXJJbm5lci5maW5kKCcuc2xpZGluZycpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRpbmcgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGluZy50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDBweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hbmltYXRlTmF2QmFja0ljb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2xpZGluZy5oYXNDbGFzcygnbGVmdCcpICYmIHNsaWRpbmcuZmluZCgnLmJhY2sgLmljb24nKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRpbmcuZmluZCgnLmJhY2sgLmljb24nKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDBweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGxlZnROYXZiYXJJbm5lci5yZW1vdmVDbGFzcyhyZW1vdmVDbGFzc2VzKS5hZGRDbGFzcygnbmF2YmFyLWZyb20tY2VudGVyLXRvLWxlZnQnKTtcbiAgICAgICAgICAgICAgICAgICAgbGVmdE5hdmJhcklubmVyLmZpbmQoJy5zbGlkaW5nJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGluZyA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmlnaHRUZXh0O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuYW5pbWF0ZU5hdkJhY2tJY29uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNsaWRpbmcuaGFzQ2xhc3MoJ2NlbnRlcicpICYmIHJpZ2h0TmF2YmFySW5uZXIuZmluZCgnLnNsaWRpbmcubGVmdCAuYmFjayAuaWNvbicpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRUZXh0ID0gcmlnaHROYXZiYXJJbm5lci5maW5kKCcuc2xpZGluZy5sZWZ0IC5iYWNrIHNwYW4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJpZ2h0VGV4dC5sZW5ndGggPiAwKSB0aGlzLmY3TmF2YmFyTGVmdE9mZnNldCArPSByaWdodFRleHRbMF0ub2Zmc2V0TGVmdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNsaWRpbmcuaGFzQ2xhc3MoJ2xlZnQnKSAmJiBzbGlkaW5nLmZpbmQoJy5iYWNrIC5pY29uJykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGlkaW5nLmZpbmQoJy5iYWNrIC5pY29uJykudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKC10aGlzLmY3TmF2YmFyTGVmdE9mZnNldCkgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRpbmcudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHRoaXMuZjdOYXZiYXJMZWZ0T2Zmc2V0KSArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBHbyBiYWNrXG4gICAgICAgICAgICAgICAgaWYgKGRpcmVjdGlvbiA9PT0gJ3RvLXJpZ2h0Jykge1xuICAgICAgICAgICAgICAgICAgICBsZWZ0TmF2YmFySW5uZXIucmVtb3ZlQ2xhc3MocmVtb3ZlQ2xhc3NlcykuYWRkQ2xhc3MoJ25hdmJhci1mcm9tLWxlZnQtdG8tY2VudGVyJyk7XG4gICAgICAgICAgICAgICAgICAgIGxlZnROYXZiYXJJbm5lci5maW5kKCcuc2xpZGluZycpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRpbmcgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGluZy50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDBweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hbmltYXRlTmF2QmFja0ljb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2xpZGluZy5oYXNDbGFzcygnbGVmdCcpICYmIHNsaWRpbmcuZmluZCgnLmJhY2sgLmljb24nKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRpbmcuZmluZCgnLmJhY2sgLmljb24nKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDBweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHJpZ2h0TmF2YmFySW5uZXIucmVtb3ZlQ2xhc3MocmVtb3ZlQ2xhc3NlcykuYWRkQ2xhc3MoJ25hdmJhci1mcm9tLWNlbnRlci10by1yaWdodCcpO1xuICAgICAgICAgICAgICAgICAgICByaWdodE5hdmJhcklubmVyLmZpbmQoJy5zbGlkaW5nJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGluZyA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hbmltYXRlTmF2QmFja0ljb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2xpZGluZy5oYXNDbGFzcygnbGVmdCcpICYmIHNsaWRpbmcuZmluZCgnLmJhY2sgLmljb24nKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRpbmcuZmluZCgnLmJhY2sgLmljb24nKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAoLXRoaXMuZjdOYXZiYXJSaWdodE9mZnNldCkgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRpbmcudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHRoaXMuZjdOYXZiYXJSaWdodE9mZnNldCkgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICBcbiAgICAgICAgICAgIHByZXByb2Nlc3M6IGZ1bmN0aW9uKHZpZXcsIGNvbnRlbnQsIHVybCwgbmV4dCkge1xuICAgICAgICAgICAgICAgIC8vIFBsdWdpbiBob29rXG4gICAgICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ3JvdXRlclByZXByb2Nlc3MnLCB2aWV3LCBjb250ZW50LCB1cmwsIG5leHQpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBQcmVwcm9jZXNzIGJ5IHBsdWdpblxuICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBhcHAucGx1Z2luUHJvY2VzcygncHJlcHJvY2VzcycsIGNvbnRlbnQpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAodmlldyAmJiB2aWV3LnBhcmFtcyAmJiB2aWV3LnBhcmFtcy5wcmVwcm9jZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSB2aWV3LnBhcmFtcy5wcmVwcm9jZXNzKGNvbnRlbnQsIHVybCwgbmV4dCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGVudCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5leHQoY29udGVudCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoYXBwLnBhcmFtcy5wcmVwcm9jZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBhcHAucGFyYW1zLnByZXByb2Nlc3MoY29udGVudCwgdXJsLCBuZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250ZW50ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV4dChjb250ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmV4dChjb250ZW50KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcHJlcm91dGU6IGZ1bmN0aW9uKHZpZXcsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICBhcHAucGx1Z2luSG9vaygncm91dGVyUHJlcm91dGUnLCB2aWV3LCBvcHRpb25zKTtcbiAgICAgICAgICAgICAgICBpZiAoKGFwcC5wYXJhbXMucHJlcm91dGUgJiYgYXBwLnBhcmFtcy5wcmVyb3V0ZSh2aWV3LCBvcHRpb25zKSA9PT0gZmFsc2UpIHx8ICh2aWV3ICYmIHZpZXcucGFyYW1zLnByZXJvdXRlICYmIHZpZXcucGFyYW1zLnByZXJvdXRlKHZpZXcsIG9wdGlvbnMpID09PSBmYWxzZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgXG4gICAgICAgICAgICB0ZW1wbGF0ZTdSZW5kZXI6IGZ1bmN0aW9uICh2aWV3LCBvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgdmFyIHVybCA9IG9wdGlvbnMudXJsLFxuICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gb3B0aW9ucy5jb250ZW50LCAvL2luaXRpYWwgY29udGVudFxuICAgICAgICAgICAgICAgICAgICB0N19yZW5kZXJlZF9jb250ZW50ID0gb3B0aW9ucy5jb250ZW50LCAvLyB3aWxsIGJlIHJlbmRlcmVkIHVzaW5nIFRlbXBsYXRlN1xuICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gb3B0aW9ucy5jb250ZXh0LCAvLyBDb250ZXh0IGRhdGEgZm9yIFRlbXBsYXRlN1xuICAgICAgICAgICAgICAgICAgICBjb250ZXh0TmFtZSA9IG9wdGlvbnMuY29udGV4dE5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gb3B0aW9ucy50ZW1wbGF0ZSwgLy8gVGVtcGxhdGUgNyBjb21waWxlZCB0ZW1wbGF0ZVxuICAgICAgICAgICAgICAgICAgICBwYWdlTmFtZSA9IG9wdGlvbnMucGFnZU5hbWU7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciB0N19jdHgsIHQ3X3RlbXBsYXRlO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGVudCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVybCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC50ZW1wbGF0ZTdDYWNoZVt1cmxdICYmICFvcHRpb25zLmlnbm9yZUNhY2hlKSB0N190ZW1wbGF0ZSA9IHQ3LmNhY2hlW3VybF07XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0N190ZW1wbGF0ZSA9IHQ3LmNvbXBpbGUoY29udGVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdDcuY2FjaGVbdXJsXSA9IHQ3X3RlbXBsYXRlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgdDdfdGVtcGxhdGUgPSB0Ny5jb21waWxlKGNvbnRlbnQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmICh0ZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICB0N190ZW1wbGF0ZSA9IHRlbXBsYXRlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGNvbnRleHQpIHQ3X2N0eCA9IGNvbnRleHQ7XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjb250ZXh0TmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHROYW1lLmluZGV4T2YoJy4nKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9jdHhfcGF0aCA9IGNvbnRleHROYW1lLnNwbGl0KCcuJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9jdHggPSB0Ny5kYXRhW19jdHhfcGF0aFswXV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBfY3R4X3BhdGgubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9jdHhfcGF0aFtpXSkgX2N0eCA9IF9jdHhbX2N0eF9wYXRoW2ldXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdDdfY3R4ID0gX2N0eDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgdDdfY3R4ID0gdDcuZGF0YVtjb250ZXh0TmFtZV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0N19jdHggJiYgdXJsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0N19jdHggPSB0Ny5kYXRhWyd1cmw6JyArIHVybF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0N19jdHggJiYgdHlwZW9mIGNvbnRlbnQgPT09ICdzdHJpbmcnICYmICF0ZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy90cnkgdG8gZmluZCBieSBwYWdlIG5hbWUgaW4gY29udGVudFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhZ2VOYW1lTWF0Y2ggPSBjb250ZW50Lm1hdGNoKC8oZGF0YS1wYWdlPVtcIiddW15cIl4nXSpbXCInXSkvKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYWdlTmFtZU1hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhZ2UgPSBwYWdlTmFtZU1hdGNoWzBdLnNwbGl0KCdkYXRhLXBhZ2U9JylbMV0ucmVwbGFjZSgvWydcIl0vZywgJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYWdlKSB0N19jdHggPSB0Ny5kYXRhWydwYWdlOicgKyBwYWdlXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIXQ3X2N0eCAmJiB0ZW1wbGF0ZSAmJiB0Ny50ZW1wbGF0ZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRyeSB0byBmaW5kIG1hdGNoZWQgdGVtcGxhdGUgbmFtZSBpbiB0Ny50ZW1wbGF0ZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIHRlbXBsYXRlTmFtZSBpbiB0Ny50ZW1wbGF0ZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodDcudGVtcGxhdGVzW3RlbXBsYXRlTmFtZV0gPT09IHRlbXBsYXRlKSB0N19jdHggPSB0Ny5kYXRhW3RlbXBsYXRlTmFtZV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0N19jdHgpIHQ3X2N0eCA9IHt9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHQ3X3RlbXBsYXRlICYmIHQ3X2N0eCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHQ3X2N0eCA9PT0gJ2Z1bmN0aW9uJykgdDdfY3R4ID0gdDdfY3R4KCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh1cmwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEV4dGVuZCBkYXRhIHdpdGggVVJMIHF1ZXJ5XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcXVlcnkgPSAkLnBhcnNlVXJsUXVlcnkodXJsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHQ3X2N0eC51cmxfcXVlcnkgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBxdWVyeSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQ3X2N0eC51cmxfcXVlcnlba2V5XSA9IHF1ZXJ5W2tleV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdDdfcmVuZGVyZWRfY29udGVudCA9IHQ3X3RlbXBsYXRlKHQ3X2N0eCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4ge2NvbnRlbnQ6IHQ3X3JlbmRlcmVkX2NvbnRlbnQsIGNvbnRleHQ6IHQ3X2N0eH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgYXBwLnJvdXRlci5fbG9hZCA9IGZ1bmN0aW9uICh2aWV3LCBvcHRpb25zKSB7XG4gICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgdXJsID0gb3B0aW9ucy51cmwsXG4gICAgICAgICAgICAgICAgY29udGVudCA9IG9wdGlvbnMuY29udGVudCwgLy9pbml0aWFsIGNvbnRlbnRcbiAgICAgICAgICAgICAgICB0N19yZW5kZXJlZCA9IHtjb250ZW50OiBvcHRpb25zLmNvbnRlbnR9LFxuICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gb3B0aW9ucy50ZW1wbGF0ZSwgLy8gVGVtcGxhdGUgNyBjb21waWxlZCB0ZW1wbGF0ZVxuICAgICAgICAgICAgICAgIHBhZ2VOYW1lID0gb3B0aW9ucy5wYWdlTmFtZSxcbiAgICAgICAgICAgICAgICB2aWV3Q29udGFpbmVyID0gJCh2aWV3LmNvbnRhaW5lciksXG4gICAgICAgICAgICAgICAgcGFnZXNDb250YWluZXIgPSAkKHZpZXcucGFnZXNDb250YWluZXIpLFxuICAgICAgICAgICAgICAgIGFuaW1hdGVQYWdlcyA9IG9wdGlvbnMuYW5pbWF0ZVBhZ2VzLFxuICAgICAgICAgICAgICAgIG5ld1BhZ2UsIG9sZFBhZ2UsIHBhZ2VzSW5WaWV3LCBpLCBvbGROYXZiYXJJbm5lciwgbmV3TmF2YmFySW5uZXIsIG5hdmJhciwgZHluYW1pY05hdmJhciwgcmVsb2FkUG9zaXRpb24sXG4gICAgICAgICAgICAgICAgaXNEeW5hbWljUGFnZSA9IHR5cGVvZiB1cmwgPT09ICd1bmRlZmluZWQnICYmIGNvbnRlbnQgfHwgdGVtcGxhdGUsXG4gICAgICAgICAgICAgICAgcHVzaFN0YXRlID0gb3B0aW9ucy5wdXNoU3RhdGU7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHR5cGVvZiBhbmltYXRlUGFnZXMgPT09ICd1bmRlZmluZWQnKSBhbmltYXRlUGFnZXMgPSB2aWV3LnBhcmFtcy5hbmltYXRlUGFnZXM7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUGx1Z2luIGhvb2tcbiAgICAgICAgICAgIGFwcC5wbHVnaW5Ib29rKCdyb3V0ZXJMb2FkJywgdmlldywgb3B0aW9ucyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUmVuZGVyIHdpdGggVGVtcGxhdGU3XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy50ZW1wbGF0ZTdQYWdlcyAmJiB0eXBlb2YgY29udGVudCA9PT0gJ3N0cmluZycgfHwgdGVtcGxhdGUpIHtcbiAgICAgICAgICAgICAgICB0N19yZW5kZXJlZCA9IGFwcC5yb3V0ZXIudGVtcGxhdGU3UmVuZGVyKHZpZXcsIG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIGlmICh0N19yZW5kZXJlZC5jb250ZW50ICYmICFjb250ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSB0N19yZW5kZXJlZC5jb250ZW50O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBhcHAucm91dGVyLnRlbXBvcmFyeURvbS5pbm5lckhUTUwgPSAnJztcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQYXJzZSBET01cbiAgICAgICAgICAgIGlmICghcGFnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICBpZiAoKHR5cGVvZiBjb250ZW50ID09PSAnc3RyaW5nJykgfHwgKHVybCAmJiAodHlwZW9mIGNvbnRlbnQgPT09ICdzdHJpbmcnKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci50ZW1wb3JhcnlEb20uaW5uZXJIVE1MID0gdDdfcmVuZGVyZWQuY29udGVudDtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoJ2xlbmd0aCcgaW4gY29udGVudCAmJiBjb250ZW50Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGNpID0gMDsgY2kgPCBjb250ZW50Lmxlbmd0aDsgY2krKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoYXBwLnJvdXRlci50ZW1wb3JhcnlEb20pLmFwcGVuZChjb250ZW50W2NpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKGFwcC5yb3V0ZXIudGVtcG9yYXJ5RG9tKS5hcHBlbmQoY29udGVudCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUmVsb2FkIHBvc2l0aW9uXG4gICAgICAgICAgICByZWxvYWRQb3NpdGlvbiA9IG9wdGlvbnMucmVsb2FkICYmIChvcHRpb25zLnJlbG9hZFByZXZpb3VzID8gJ2xlZnQnIDogJ2NlbnRlcicpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEZpbmQgbmV3IHBhZ2VcbiAgICAgICAgICAgIGlmIChwYWdlTmFtZSkgbmV3UGFnZSA9IHBhZ2VzQ29udGFpbmVyLmZpbmQoJy5wYWdlW2RhdGEtcGFnZT1cIicgKyBwYWdlTmFtZSArICdcIl0nKTtcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIG5ld1BhZ2UgPSBhcHAucm91dGVyLmZpbmRFbGVtZW50KCcucGFnZScsIGFwcC5yb3V0ZXIudGVtcG9yYXJ5RG9tLCB2aWV3KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJZiBwYWdlIG5vdCBmb3VuZCBleGl0XG4gICAgICAgICAgICBpZiAoIW5ld1BhZ2UgfHwgbmV3UGFnZS5sZW5ndGggPT09IDAgfHwgKHBhZ2VOYW1lICYmIHZpZXcuYWN0aXZlUGFnZSAmJiB2aWV3LmFjdGl2ZVBhZ2UubmFtZSA9PT0gcGFnZU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBuZXdQYWdlLmFkZENsYXNzKG9wdGlvbnMucmVsb2FkID8gJ3BhZ2Utb24tJyArIHJlbG9hZFBvc2l0aW9uIDogJ3BhZ2Utb24tcmlnaHQnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBGaW5kIG9sZCBwYWdlIChzaG91bGQgYmUgdGhlIGxhc3Qgb25lKSBhbmQgcmVtb3ZlIG9sZGVyIHBhZ2VzXG4gICAgICAgICAgICBwYWdlc0luVmlldyA9IHBhZ2VzQ29udGFpbmVyLmNoaWxkcmVuKCcucGFnZTpub3QoLmNhY2hlZCknKTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5yZWxvYWQgJiYgb3B0aW9ucy5yZWxvYWRQcmV2aW91cyAmJiBwYWdlc0luVmlldy5sZW5ndGggPT09IDEpICB7XG4gICAgICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5yZWxvYWQpIHtcbiAgICAgICAgICAgICAgICBvbGRQYWdlID0gcGFnZXNJblZpZXcuZXEocGFnZXNJblZpZXcubGVuZ3RoIC0gMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAocGFnZXNJblZpZXcubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcGFnZXNJblZpZXcubGVuZ3RoIC0gMjsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZpZXcucGFyYW1zLmRvbUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnBhZ2VSZW1vdmVDYWxsYmFjayh2aWV3LCBwYWdlc0luVmlld1tpXSwgJ2xlZnQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKHBhZ2VzSW5WaWV3W2ldKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICQocGFnZXNJblZpZXdbaV0pLmFkZENsYXNzKCdjYWNoZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIXZpZXcucGFyYW1zLmRvbUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAucGFnZVJlbW92ZUNhbGxiYWNrKHZpZXcsIHBhZ2VzSW5WaWV3W2ldLCAnbGVmdCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJChwYWdlc0luVmlld1tpXSkucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKHBhZ2VzSW5WaWV3W2ldKS5hZGRDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgb2xkUGFnZSA9IHBhZ2VzQ29udGFpbmVyLmNoaWxkcmVuKCcucGFnZTpub3QoLmNhY2hlZCknKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmKHZpZXcucGFyYW1zLmRvbUNhY2hlKSBuZXdQYWdlLnJlbW92ZUNsYXNzKCdjYWNoZWQnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBEeW5hbWljIG5hdmJhclxuICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICBkeW5hbWljTmF2YmFyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAvLyBGaW5kIG5hdmJhclxuICAgICAgICAgICAgICAgIGlmIChwYWdlTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBuZXdOYXZiYXJJbm5lciA9IHZpZXdDb250YWluZXIuZmluZCgnLm5hdmJhci1pbm5lcltkYXRhLXBhZ2U9XCInICsgcGFnZU5hbWUgKyAnXCJdJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuZXdOYXZiYXJJbm5lciA9IGFwcC5yb3V0ZXIuZmluZEVsZW1lbnQoJy5uYXZiYXItaW5uZXInLCBhcHAucm91dGVyLnRlbXBvcmFyeURvbSwgdmlldyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghbmV3TmF2YmFySW5uZXIgfHwgbmV3TmF2YmFySW5uZXIubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGR5bmFtaWNOYXZiYXIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbmF2YmFyID0gdmlld0NvbnRhaW5lci5maW5kKCcubmF2YmFyJyk7XG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMucmVsb2FkKSB7XG4gICAgICAgICAgICAgICAgICAgIG9sZE5hdmJhcklubmVyID0gbmF2YmFyLmZpbmQoJy5uYXZiYXItaW5uZXI6bm90KC5jYWNoZWQpOmxhc3QtY2hpbGQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG9sZE5hdmJhcklubmVyID0gbmF2YmFyLmZpbmQoJy5uYXZiYXItaW5uZXI6bm90KC5jYWNoZWQpJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAob2xkTmF2YmFySW5uZXIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IG9sZE5hdmJhcklubmVyLmxlbmd0aCAtIDE7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdmlldy5wYXJhbXMuZG9tQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLm5hdmJhclJlbW92ZUNhbGxiYWNrKHZpZXcsIHBhZ2VzSW5WaWV3W2ldLCBuYXZiYXJbMF0sIG9sZE5hdmJhcklubmVyW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJChvbGROYXZiYXJJbm5lcltpXSkucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJChvbGROYXZiYXJJbm5lcltpXSkuYWRkQ2xhc3MoJ2NhY2hlZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFuZXdOYXZiYXJJbm5lciAmJiBvbGROYXZiYXJJbm5lci5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXZpZXcucGFyYW1zLmRvbUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5uYXZiYXJSZW1vdmVDYWxsYmFjayh2aWV3LCBwYWdlc0luVmlld1swXSwgbmF2YmFyWzBdLCBvbGROYXZiYXJJbm5lclswXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQob2xkTmF2YmFySW5uZXJbMF0pLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQob2xkTmF2YmFySW5uZXJbMF0pLmFkZENsYXNzKCdjYWNoZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIG9sZE5hdmJhcklubmVyID0gbmF2YmFyLmZpbmQoJy5uYXZiYXItaW5uZXI6bm90KC5jYWNoZWQpJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgIG5ld05hdmJhcklubmVyLmFkZENsYXNzKG9wdGlvbnMucmVsb2FkID8gJ25hdmJhci1vbi0nICsgcmVsb2FkUG9zaXRpb24gOiAnbmF2YmFyLW9uLXJpZ2h0Jyk7XG4gICAgICAgICAgICAgICAgaWYodmlldy5wYXJhbXMuZG9tQ2FjaGUpIG5ld05hdmJhcklubmVyLnJlbW92ZUNsYXNzKCdjYWNoZWQnKTtcbiAgICAgICAgICAgICAgICBuZXdQYWdlWzBdLmY3UmVsYXRlZE5hdmJhciA9IG5ld05hdmJhcklubmVyWzBdO1xuICAgICAgICAgICAgICAgIG5ld05hdmJhcklubmVyWzBdLmY3UmVsYXRlZFBhZ2UgPSBuZXdQYWdlWzBdO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIHNhdmUgY29udGVudCBhcmVhcyBpbnRvIHZpZXcncyBjYWNoZVxuICAgICAgICAgICAgaWYgKCF1cmwpIHtcbiAgICAgICAgICAgICAgICB2YXIgbmV3UGFnZU5hbWUgPSBwYWdlTmFtZSB8fCBuZXdQYWdlLmF0dHIoJ2RhdGEtcGFnZScpO1xuICAgICAgICAgICAgICAgIGlmIChpc0R5bmFtaWNQYWdlKSB1cmwgPSAnIycgKyBhcHAucGFyYW1zLmR5bmFtaWNQYWdlVXJsLnJlcGxhY2UoL3t7bmFtZX19L2csIG5ld1BhZ2VOYW1lKS5yZXBsYWNlKC97e2luZGV4fX0vZywgdmlldy5oaXN0b3J5Lmxlbmd0aCAtIChvcHRpb25zLnJlbG9hZCA/IDEgOiAwKSk7XG4gICAgICAgICAgICAgICAgZWxzZSB1cmwgPSAnIycgKyBuZXdQYWdlTmFtZTtcbiAgICAgICAgICAgICAgICBpZiAoIXZpZXcucGFyYW1zLmRvbUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuY29udGVudENhY2hlW3VybF0gPSBjb250ZW50O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuZG9tQ2FjaGUgJiYgcGFnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5wYWdlc0NhY2hlW3VybF0gPSBwYWdlTmFtZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUHVzaCBTdGF0ZVxuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMucHVzaFN0YXRlICYmICFvcHRpb25zLnJlbG9hZFByZXZpb3VzICYmIHZpZXcubWFpbikgIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHB1c2hTdGF0ZSA9PT0gJ3VuZGVmaW5lZCcpIHB1c2hTdGF0ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgdmFyIHB1c2hTdGF0ZVJvb3QgPSBhcHAucGFyYW1zLnB1c2hTdGF0ZVJvb3QgfHwgJyc7XG4gICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMucmVsb2FkID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJztcbiAgICAgICAgICAgICAgICBpZiAocHVzaFN0YXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghaXNEeW5hbWljUGFnZSAmJiAhcGFnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhpc3RvcnlbbWV0aG9kXSh7dXJsOiB1cmwsIHZpZXdJbmRleDogYXBwLnZpZXdzLmluZGV4T2Yodmlldyl9LCAnJywgcHVzaFN0YXRlUm9vdCArIGFwcC5wYXJhbXMucHVzaFN0YXRlU2VwYXJhdG9yICsgdXJsKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpc0R5bmFtaWNQYWdlICYmIGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhpc3RvcnlbbWV0aG9kXSh7Y29udGVudDogdHlwZW9mIGNvbnRlbnQgPT09ICdzdHJpbmcnID8gY29udGVudCA6ICcnLCB1cmw6IHVybCwgdmlld0luZGV4OiBhcHAudmlld3MuaW5kZXhPZih2aWV3KX0sICcnLCBwdXNoU3RhdGVSb290ICsgYXBwLnBhcmFtcy5wdXNoU3RhdGVTZXBhcmF0b3IgKyB1cmwpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHBhZ2VOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBoaXN0b3J5W21ldGhvZF0oe3BhZ2VOYW1lOiBwYWdlTmFtZSwgdXJsOiB1cmwsIHZpZXdJbmRleDogYXBwLnZpZXdzLmluZGV4T2Yodmlldyl9LCAnJywgcHVzaFN0YXRlUm9vdCArIGFwcC5wYXJhbXMucHVzaFN0YXRlU2VwYXJhdG9yICsgdXJsKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBVcGRhdGUgVmlldyBoaXN0b3J5XG4gICAgICAgICAgICB2aWV3LnVybCA9IHVybDtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnJlbG9hZCkge1xuICAgICAgICAgICAgICAgIHZhciBsYXN0VXJsID0gdmlldy5oaXN0b3J5W3ZpZXcuaGlzdG9yeS5sZW5ndGggLSAob3B0aW9ucy5yZWxvYWRQcmV2aW91cyA/IDIgOiAxKV07XG4gICAgICAgICAgICAgICAgaWYgKGxhc3RVcmwgJiZcbiAgICAgICAgICAgICAgICAgICAgbGFzdFVybC5pbmRleE9mKCcjJykgPT09IDAgJiZcbiAgICAgICAgICAgICAgICAgICAgbGFzdFVybCBpbiB2aWV3LmNvbnRlbnRDYWNoZSAmJlxuICAgICAgICAgICAgICAgICAgICBsYXN0VXJsICE9PSB1cmwgJiZcbiAgICAgICAgICAgICAgICAgICAgdmlldy5oaXN0b3J5LmluZGV4T2YobGFzdFVybCkgPT09IC0xKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuY29udGVudENhY2hlW2xhc3RVcmxdID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHZpZXcuY29udGVudENhY2hlW2xhc3RVcmxdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2aWV3Lmhpc3Rvcnlbdmlldy5oaXN0b3J5Lmxlbmd0aCAtIChvcHRpb25zLnJlbG9hZFByZXZpb3VzID8gMiA6IDEpXSA9IHVybDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHZpZXcuaGlzdG9yeS5wdXNoKHVybCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVW5pcXVlIGhpc3RvcnlcbiAgICAgICAgICAgIHZhciBoaXN0b3J5QmVjYW1lVW5pcXVlID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAodmlldy5wYXJhbXMudW5pcXVlSGlzdG9yeSkge1xuICAgICAgICAgICAgICAgIHZhciBfaGlzdG9yeSA9IHZpZXcuaGlzdG9yeTtcbiAgICAgICAgICAgICAgICB2YXIgX3VybCA9IHVybDtcbiAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMudW5pcXVlSGlzdG9yeUlnbm9yZUdldFBhcmFtZXRlcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgX2hpc3RvcnkgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgX3VybCA9IHVybC5zcGxpdCgnPycpWzBdO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdmlldy5oaXN0b3J5Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBfaGlzdG9yeS5wdXNoKHZpZXcuaGlzdG9yeVtpXS5zcGxpdCgnPycpWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKF9oaXN0b3J5LmluZGV4T2YoX3VybCkgIT09IF9oaXN0b3J5Lmxhc3RJbmRleE9mKF91cmwpKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuaGlzdG9yeSA9IHZpZXcuaGlzdG9yeS5zbGljZSgwLCBfaGlzdG9yeS5pbmRleE9mKF91cmwpKTtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5oaXN0b3J5LnB1c2godXJsKTtcbiAgICAgICAgICAgICAgICAgICAgaGlzdG9yeUJlY2FtZVVuaXF1ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gRG9tIG1hbmlwdWxhdGlvbnNcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnJlbG9hZFByZXZpb3VzKSB7XG4gICAgICAgICAgICAgICAgb2xkUGFnZSA9IG9sZFBhZ2UucHJldignLnBhZ2UnKTtcbiAgICAgICAgICAgICAgICBuZXdQYWdlLmluc2VydEJlZm9yZShvbGRQYWdlKTtcbiAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICBvbGROYXZiYXJJbm5lciA9IG9sZE5hdmJhcklubmVyLnByZXYoJy5uYXZiYXItaW5uZXInKTtcbiAgICAgICAgICAgICAgICAgICAgbmV3TmF2YmFySW5uZXIuaW5zZXJ0QWZ0ZXIob2xkTmF2YmFySW5uZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHBhZ2VzQ29udGFpbmVyLmFwcGVuZChuZXdQYWdlWzBdKTtcbiAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikgbmF2YmFyLmFwcGVuZChuZXdOYXZiYXJJbm5lclswXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBSZW1vdmUgT2xkIFBhZ2UgQW5kIE5hdmJhclxuICAgICAgICAgICAgaWYgKG9wdGlvbnMucmVsb2FkKSB7XG4gICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlICYmIHZpZXcuaW5pdGlhbFBhZ2VzLmluZGV4T2Yob2xkUGFnZVswXSkgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICBvbGRQYWdlLmFkZENsYXNzKCdjYWNoZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIG9sZE5hdmJhcklubmVyLmFkZENsYXNzKCdjYWNoZWQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5wYWdlUmVtb3ZlQ2FsbGJhY2sodmlldywgb2xkUGFnZVswXSwgcmVsb2FkUG9zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikgYXBwLm5hdmJhclJlbW92ZUNhbGxiYWNrKHZpZXcsIG9sZFBhZ2VbMF0sIG5hdmJhclswXSwgb2xkTmF2YmFySW5uZXJbMF0pO1xuICAgICAgICAgICAgICAgICAgICBvbGRQYWdlLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikgb2xkTmF2YmFySW5uZXIucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBhZ2UgSW5pdCBFdmVudHNcbiAgICAgICAgICAgIGFwcC5wYWdlSW5pdENhbGxiYWNrKHZpZXcsIHtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyOiBuZXdQYWdlWzBdLFxuICAgICAgICAgICAgICAgIHVybDogdXJsLFxuICAgICAgICAgICAgICAgIHBvc2l0aW9uOiBvcHRpb25zLnJlbG9hZCA/IHJlbG9hZFBvc2l0aW9uIDogJ3JpZ2h0JyxcbiAgICAgICAgICAgICAgICBuYXZiYXJJbm5lckNvbnRhaW5lcjogZHluYW1pY05hdmJhciA/IG5ld05hdmJhcklubmVyICYmIG5ld05hdmJhcklubmVyWzBdIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgIG9sZE5hdmJhcklubmVyQ29udGFpbmVyOiBkeW5hbWljTmF2YmFyID8gb2xkTmF2YmFySW5uZXIgJiYgb2xkTmF2YmFySW5uZXJbMF0gOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgY29udGV4dDogdDdfcmVuZGVyZWQuY29udGV4dCxcbiAgICAgICAgICAgICAgICBxdWVyeTogb3B0aW9ucy5xdWVyeSxcbiAgICAgICAgICAgICAgICBmcm9tUGFnZTogb2xkUGFnZSAmJiBvbGRQYWdlLmxlbmd0aCAmJiBvbGRQYWdlWzBdLmY3UGFnZURhdGEsXG4gICAgICAgICAgICAgICAgcmVsb2FkOiBvcHRpb25zLnJlbG9hZCxcbiAgICAgICAgICAgICAgICByZWxvYWRQcmV2aW91czogb3B0aW9ucy5yZWxvYWRQcmV2aW91c1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gTmF2YmFyIGluaXQgZXZlbnRcbiAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgYXBwLm5hdmJhckluaXRDYWxsYmFjayh2aWV3LCBuZXdQYWdlWzBdLCBuYXZiYXJbMF0sIG5ld05hdmJhcklubmVyWzBdLCB1cmwsIG9wdGlvbnMucmVsb2FkID8gcmVsb2FkUG9zaXRpb24gOiAncmlnaHQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5yZWxvYWQpIHtcbiAgICAgICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgaWYgKGhpc3RvcnlCZWNhbWVVbmlxdWUpIHZpZXcucmVmcmVzaFByZXZpb3VzUGFnZSgpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhciAmJiBhbmltYXRlUGFnZXMpIHtcbiAgICAgICAgICAgICAgICBhcHAucm91dGVyLnByZXBhcmVOYXZiYXIobmV3TmF2YmFySW5uZXIsIG9sZE5hdmJhcklubmVyLCAncmlnaHQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIEZvcmNlIHJlTGF5b3V0XG4gICAgICAgICAgICB2YXIgY2xpZW50TGVmdCA9IG5ld1BhZ2VbMF0uY2xpZW50TGVmdDtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBCZWZvcmUgQW5pbSBDYWxsYmFja1xuICAgICAgICAgICAgYXBwLnBhZ2VBbmltQ2FsbGJhY2soJ2JlZm9yZScsIHZpZXcsIHtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyOiBuZXdQYWdlWzBdLFxuICAgICAgICAgICAgICAgIHVybDogdXJsLFxuICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAncmlnaHQnLFxuICAgICAgICAgICAgICAgIG9sZFBhZ2U6IG9sZFBhZ2UsXG4gICAgICAgICAgICAgICAgbmV3UGFnZTogbmV3UGFnZSxcbiAgICAgICAgICAgICAgICBxdWVyeTogb3B0aW9ucy5xdWVyeSxcbiAgICAgICAgICAgICAgICBmcm9tUGFnZTogb2xkUGFnZSAmJiBvbGRQYWdlLmxlbmd0aCAmJiBvbGRQYWdlWzBdLmY3UGFnZURhdGFcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIGFmdGVyQW5pbWF0aW9uKCkge1xuICAgICAgICAgICAgICAgIHZpZXcuYWxsb3dQYWdlQ2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBuZXdQYWdlLnJlbW92ZUNsYXNzKCdwYWdlLWZyb20tcmlnaHQtdG8tY2VudGVyIHBhZ2Utb24tcmlnaHQgcGFnZS1vbi1sZWZ0JykuYWRkQ2xhc3MoJ3BhZ2Utb24tY2VudGVyJyk7XG4gICAgICAgICAgICAgICAgb2xkUGFnZS5yZW1vdmVDbGFzcygncGFnZS1mcm9tLWNlbnRlci10by1sZWZ0IHBhZ2Utb24tY2VudGVyIHBhZ2Utb24tcmlnaHQnKS5hZGRDbGFzcygncGFnZS1vbi1sZWZ0Jyk7XG4gICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgbmV3TmF2YmFySW5uZXIucmVtb3ZlQ2xhc3MoJ25hdmJhci1mcm9tLXJpZ2h0LXRvLWNlbnRlciBuYXZiYXItb24tbGVmdCBuYXZiYXItb24tcmlnaHQnKS5hZGRDbGFzcygnbmF2YmFyLW9uLWNlbnRlcicpO1xuICAgICAgICAgICAgICAgICAgICBvbGROYXZiYXJJbm5lci5yZW1vdmVDbGFzcygnbmF2YmFyLWZyb20tY2VudGVyLXRvLWxlZnQgbmF2YmFyLW9uLWNlbnRlciBuYXZiYXItb24tcmlnaHQnKS5hZGRDbGFzcygnbmF2YmFyLW9uLWxlZnQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYXBwLnBhZ2VBbmltQ2FsbGJhY2soJ2FmdGVyJywgdmlldywge1xuICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyOiBuZXdQYWdlWzBdLFxuICAgICAgICAgICAgICAgICAgICB1cmw6IHVybCxcbiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICdyaWdodCcsXG4gICAgICAgICAgICAgICAgICAgIG9sZFBhZ2U6IG9sZFBhZ2UsXG4gICAgICAgICAgICAgICAgICAgIG5ld1BhZ2U6IG5ld1BhZ2UsXG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5OiBvcHRpb25zLnF1ZXJ5LFxuICAgICAgICAgICAgICAgICAgICBmcm9tUGFnZTogb2xkUGFnZSAmJiBvbGRQYWdlLmxlbmd0aCAmJiBvbGRQYWdlWzBdLmY3UGFnZURhdGFcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5wdXNoU3RhdGUgJiYgdmlldy5tYWluKSBhcHAucHVzaFN0YXRlQ2xlYXJRdWV1ZSgpO1xuICAgICAgICAgICAgICAgIGlmICghKHZpZXcucGFyYW1zLnN3aXBlQmFja1BhZ2UgfHwgdmlldy5wYXJhbXMucHJlbG9hZFByZXZpb3VzUGFnZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvbGRQYWdlLmFkZENsYXNzKCdjYWNoZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyKSBvbGROYXZiYXJJbm5lci5hZGRDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoISh1cmwuaW5kZXhPZignIycpID09PSAwICYmIG5ld1BhZ2UuYXR0cignZGF0YS1wYWdlJykuaW5kZXhPZignc21hcnQtc2VsZWN0LScpID09PSAwKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5wYWdlUmVtb3ZlQ2FsbGJhY2sodmlldywgb2xkUGFnZVswXSwgJ2xlZnQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikgYXBwLm5hdmJhclJlbW92ZUNhbGxiYWNrKHZpZXcsIG9sZFBhZ2VbMF0sIG5hdmJhclswXSwgb2xkTmF2YmFySW5uZXJbMF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9sZFBhZ2UucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIG9sZE5hdmJhcklubmVyLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy51bmlxdWVIaXN0b3J5ICYmIGhpc3RvcnlCZWNhbWVVbmlxdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5yZWZyZXNoUHJldmlvdXNQYWdlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFuaW1hdGVQYWdlcykge1xuICAgICAgICAgICAgICAgIC8vIFNldCBwYWdlcyBiZWZvcmUgYW5pbWF0aW9uXG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwgJiYgYXBwLnBhcmFtcy5tYXRlcmlhbFBhZ2VMb2FkRGVsYXkpIHtcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLmFuaW1hdGVQYWdlcyhvbGRQYWdlLCBuZXdQYWdlLCAndG8tbGVmdCcsIHZpZXcpO1xuICAgICAgICAgICAgICAgICAgICB9LCBhcHAucGFyYW1zLm1hdGVyaWFsUGFnZUxvYWREZWxheSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLmFuaW1hdGVQYWdlcyhvbGRQYWdlLCBuZXdQYWdlLCAndG8tbGVmdCcsIHZpZXcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gRHluYW1pYyBuYXZiYXIgYW5pbWF0aW9uXG4gICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIuYW5pbWF0ZU5hdmJhcnMob2xkTmF2YmFySW5uZXIsIG5ld05hdmJhcklubmVyLCAndG8tbGVmdCcsIHZpZXcpO1xuICAgICAgICAgICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbmV3UGFnZS5hbmltYXRpb25FbmQoZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgYWZ0ZXJBbmltYXRpb24oKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyKSBuZXdOYXZiYXJJbm5lci5maW5kKCcuc2xpZGluZywgLnNsaWRpbmcgLmJhY2sgLmljb24nKS50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgICAgIGFmdGVyQW5pbWF0aW9uKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgYXBwLnJvdXRlci5sb2FkID0gZnVuY3Rpb24gKHZpZXcsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgIGlmIChhcHAucm91dGVyLnByZXJvdXRlKHZpZXcsIG9wdGlvbnMpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgICAgICAgICB2YXIgdXJsID0gb3B0aW9ucy51cmw7XG4gICAgICAgICAgICB2YXIgY29udGVudCA9IG9wdGlvbnMuY29udGVudDtcbiAgICAgICAgICAgIHZhciBwYWdlTmFtZSA9IG9wdGlvbnMucGFnZU5hbWU7XG4gICAgICAgICAgICBpZiAocGFnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICBpZiAocGFnZU5hbWUuaW5kZXhPZignPycpID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnF1ZXJ5ID0gJC5wYXJzZVVybFF1ZXJ5KHBhZ2VOYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5wYWdlTmFtZSA9IHBhZ2VOYW1lID0gcGFnZU5hbWUuc3BsaXQoJz8nKVswXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgdGVtcGxhdGUgPSBvcHRpb25zLnRlbXBsYXRlO1xuICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLnJlbG9hZFBhZ2VzID09PSB0cnVlKSBvcHRpb25zLnJlbG9hZCA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKCF2aWV3LmFsbG93UGFnZUNoYW5nZSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgaWYgKHVybCAmJiB2aWV3LnVybCA9PT0gdXJsICYmICFvcHRpb25zLnJlbG9hZCAmJiAhdmlldy5wYXJhbXMuYWxsb3dEdXBsaWNhdGVVcmxzKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKGFwcC54aHIgJiYgdmlldy54aHIgJiYgdmlldy54aHIgPT09IGFwcC54aHIpIHtcbiAgICAgICAgICAgICAgICBhcHAueGhyLmFib3J0KCk7XG4gICAgICAgICAgICAgICAgYXBwLnhociA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gcHJvY2VlZChjb250ZW50KSB7XG4gICAgICAgICAgICAgICAgYXBwLnJvdXRlci5wcmVwcm9jZXNzKHZpZXcsIGNvbnRlbnQsIHVybCwgZnVuY3Rpb24gKGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5jb250ZW50ID0gY29udGVudDtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci5fbG9hZCh2aWV3LCBvcHRpb25zKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjb250ZW50IHx8IHBhZ2VOYW1lKSB7XG4gICAgICAgICAgICAgICAgcHJvY2VlZChjb250ZW50KTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmICh0ZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIuX2xvYWQodmlldywgb3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmICghb3B0aW9ucy51cmwgfHwgb3B0aW9ucy51cmwgPT09ICcjJykge1xuICAgICAgICAgICAgICAgIHZpZXcuYWxsb3dQYWdlQ2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhcHAuZ2V0KG9wdGlvbnMudXJsLCB2aWV3LCBvcHRpb25zLmlnbm9yZUNhY2hlLCBmdW5jdGlvbiAoY29udGVudCwgZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHByb2NlZWQoY29udGVudCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGFwcC5yb3V0ZXIuX2JhY2sgPSBmdW5jdGlvbiAodmlldywgb3B0aW9ucykge1xuICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgICAgICAgICB2YXIgdXJsID0gb3B0aW9ucy51cmwsXG4gICAgICAgICAgICAgICAgY29udGVudCA9IG9wdGlvbnMuY29udGVudCxcbiAgICAgICAgICAgICAgICB0N19yZW5kZXJlZCA9IHtjb250ZW50OiBvcHRpb25zLmNvbnRlbnR9LCAvLyB3aWxsIGJlIHJlbmRlcmVkIHVzaW5nIFRlbXBsYXRlN1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gb3B0aW9ucy50ZW1wbGF0ZSwgLy8gVGVtcGxhdGUgNyBjb21waWxlZCB0ZW1wbGF0ZVxuICAgICAgICAgICAgICAgIGFuaW1hdGVQYWdlcyA9IG9wdGlvbnMuYW5pbWF0ZVBhZ2VzLFxuICAgICAgICAgICAgICAgIHByZWxvYWRPbmx5ID0gb3B0aW9ucy5wcmVsb2FkT25seSxcbiAgICAgICAgICAgICAgICBwdXNoU3RhdGUgPSBvcHRpb25zLnB1c2hTdGF0ZSxcbiAgICAgICAgICAgICAgICBpZ25vcmVDYWNoZSA9IG9wdGlvbnMuaWdub3JlQ2FjaGUsXG4gICAgICAgICAgICAgICAgZm9yY2UgPSBvcHRpb25zLmZvcmNlLFxuICAgICAgICAgICAgICAgIHBhZ2VOYW1lID0gb3B0aW9ucy5wYWdlTmFtZTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgdmlld0NvbnRhaW5lciA9ICQodmlldy5jb250YWluZXIpLFxuICAgICAgICAgICAgICAgIHBhZ2VzQ29udGFpbmVyID0gJCh2aWV3LnBhZ2VzQ29udGFpbmVyKSxcbiAgICAgICAgICAgICAgICBwYWdlc0luVmlldyA9IHBhZ2VzQ29udGFpbmVyLmNoaWxkcmVuKCcucGFnZTpub3QoLmNhY2hlZCknKSxcbiAgICAgICAgICAgICAgICBvbGRQYWdlLCBuZXdQYWdlLCBvbGROYXZiYXJJbm5lciwgbmV3TmF2YmFySW5uZXIsIG5hdmJhciwgbmF2YmFySW5uZXJzLCBkeW5hbWljTmF2YmFyLCBtYW5pcHVsYXRlRG9tID0gdHJ1ZTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAodHlwZW9mIGFuaW1hdGVQYWdlcyA9PT0gJ3VuZGVmaW5lZCcpIGFuaW1hdGVQYWdlcyA9IHZpZXcucGFyYW1zLmFuaW1hdGVQYWdlcztcbiAgICAgICAgXG4gICAgICAgICAgICBhcHAucGx1Z2luSG9vaygncm91dGVyQmFjaycsIHZpZXcsIG9wdGlvbnMpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFJlbmRlciB3aXRoIFRlbXBsYXRlN1xuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMudGVtcGxhdGU3UGFnZXMgJiYgdHlwZW9mIGNvbnRlbnQgPT09ICdzdHJpbmcnIHx8IHRlbXBsYXRlKSB7XG4gICAgICAgICAgICAgICAgdDdfcmVuZGVyZWQgPSBhcHAucm91dGVyLnRlbXBsYXRlN1JlbmRlcih2aWV3LCBvcHRpb25zKTtcbiAgICAgICAgICAgICAgICBpZiAodDdfcmVuZGVyZWQuY29udGVudCAmJiAhY29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICBjb250ZW50ID0gdDdfcmVuZGVyZWQuY29udGVudDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQW5pbWF0aW9uXG4gICAgICAgICAgICBmdW5jdGlvbiBhZnRlckFuaW1hdGlvbigpIHtcbiAgICAgICAgICAgICAgICBhcHAucGFnZUJhY2tDYWxsYmFjaygnYWZ0ZXInLCB2aWV3LCB7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXI6IG9sZFBhZ2VbMF0sXG4gICAgICAgICAgICAgICAgICAgIHVybDogdXJsLFxuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogJ2NlbnRlcicsXG4gICAgICAgICAgICAgICAgICAgIG9sZFBhZ2U6IG9sZFBhZ2UsXG4gICAgICAgICAgICAgICAgICAgIG5ld1BhZ2U6IG5ld1BhZ2UsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgYXBwLnBhZ2VBbmltQ2FsbGJhY2soJ2FmdGVyJywgdmlldywge1xuICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyOiBuZXdQYWdlWzBdLFxuICAgICAgICAgICAgICAgICAgICB1cmw6IHVybCxcbiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICdsZWZ0JyxcbiAgICAgICAgICAgICAgICAgICAgb2xkUGFnZTogb2xkUGFnZSxcbiAgICAgICAgICAgICAgICAgICAgbmV3UGFnZTogbmV3UGFnZSxcbiAgICAgICAgICAgICAgICAgICAgcXVlcnk6IG9wdGlvbnMucXVlcnksXG4gICAgICAgICAgICAgICAgICAgIGZyb21QYWdlOiBvbGRQYWdlICYmIG9sZFBhZ2UubGVuZ3RoICYmIG9sZFBhZ2VbMF0uZjdQYWdlRGF0YVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIuYWZ0ZXJCYWNrKHZpZXcsIG9sZFBhZ2VbMF0sIG5ld1BhZ2VbMF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gYW5pbWF0ZUJhY2soKSB7XG4gICAgICAgICAgICAgICAgLy8gUGFnZSBiZWZvcmUgYW5pbWF0aW9uIGNhbGxiYWNrXG4gICAgICAgICAgICAgICAgYXBwLnBhZ2VCYWNrQ2FsbGJhY2soJ2JlZm9yZScsIHZpZXcsIHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lcjogb2xkUGFnZVswXSxcbiAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmwsXG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnY2VudGVyJyxcbiAgICAgICAgICAgICAgICAgICAgb2xkUGFnZTogb2xkUGFnZSxcbiAgICAgICAgICAgICAgICAgICAgbmV3UGFnZTogbmV3UGFnZSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBhcHAucGFnZUFuaW1DYWxsYmFjaygnYmVmb3JlJywgdmlldywge1xuICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyOiBuZXdQYWdlWzBdLFxuICAgICAgICAgICAgICAgICAgICB1cmw6IHVybCxcbiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246ICdsZWZ0JyxcbiAgICAgICAgICAgICAgICAgICAgb2xkUGFnZTogb2xkUGFnZSxcbiAgICAgICAgICAgICAgICAgICAgbmV3UGFnZTogbmV3UGFnZSxcbiAgICAgICAgICAgICAgICAgICAgcXVlcnk6IG9wdGlvbnMucXVlcnksXG4gICAgICAgICAgICAgICAgICAgIGZyb21QYWdlOiBvbGRQYWdlICYmIG9sZFBhZ2UubGVuZ3RoICYmIG9sZFBhZ2VbMF0uZjdQYWdlRGF0YVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoYW5pbWF0ZVBhZ2VzKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFNldCBwYWdlcyBiZWZvcmUgYW5pbWF0aW9uXG4gICAgICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIuYW5pbWF0ZVBhZ2VzKG5ld1BhZ2UsIG9sZFBhZ2UsICd0by1yaWdodCcsIHZpZXcpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gRHluYW1pYyBuYXZiYXIgYW5pbWF0aW9uXG4gICAgICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLmFuaW1hdGVOYXZiYXJzKG5ld05hdmJhcklubmVyLCBvbGROYXZiYXJJbm5lciwgJ3RvLXJpZ2h0Jywgdmlldyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgbmV3UGFnZS5hbmltYXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJBbmltYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikgbmV3TmF2YmFySW5uZXIuZmluZCgnLnNsaWRpbmcsIC5zbGlkaW5nIC5iYWNrIC5pY29uJykudHJhbnNmb3JtKCcnKTtcbiAgICAgICAgICAgICAgICAgICAgYWZ0ZXJBbmltYXRpb24oKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgZnVuY3Rpb24gcGFyc2VOZXdQYWdlKCkge1xuICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIudGVtcG9yYXJ5RG9tLmlubmVySFRNTCA9ICcnO1xuICAgICAgICAgICAgICAgIC8vIFBhcnNlIERPTVxuICAgICAgICAgICAgICAgIGlmICgodHlwZW9mIGNvbnRlbnQgPT09ICdzdHJpbmcnKSB8fCAodXJsICYmICh0eXBlb2YgY29udGVudCA9PT0gJ3N0cmluZycpKSkge1xuICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLnRlbXBvcmFyeURvbS5pbm5lckhUTUwgPSB0N19yZW5kZXJlZC5jb250ZW50O1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgnbGVuZ3RoJyBpbiBjb250ZW50ICYmIGNvbnRlbnQubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgY2kgPSAwOyBjaSA8IGNvbnRlbnQubGVuZ3RoOyBjaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJChhcHAucm91dGVyLnRlbXBvcmFyeURvbSkuYXBwZW5kKGNvbnRlbnRbY2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoYXBwLnJvdXRlci50ZW1wb3JhcnlEb20pLmFwcGVuZChjb250ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBuZXdQYWdlID0gYXBwLnJvdXRlci5maW5kRWxlbWVudCgnLnBhZ2UnLCBhcHAucm91dGVyLnRlbXBvcmFyeURvbSwgdmlldyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5keW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEZpbmQgbmF2YmFyXG4gICAgICAgICAgICAgICAgICAgIG5ld05hdmJhcklubmVyID0gYXBwLnJvdXRlci5maW5kRWxlbWVudCgnLm5hdmJhci1pbm5lcicsIGFwcC5yb3V0ZXIudGVtcG9yYXJ5RG9tLCB2aWV3KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBzZXRQYWdlcygpIHtcbiAgICAgICAgICAgICAgICAvLyBJZiBwYWdlcyBub3QgZm91bmQgb3IgdGhlcmUgYXJlIHN0aWxsIG1vcmUgdGhhbiBvbmUsIGV4aXRcbiAgICAgICAgICAgICAgICBpZiAoIW5ld1BhZ2UgfHwgbmV3UGFnZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5keW5hbWljTmF2YmFyICYmIHR5cGVvZiBkeW5hbWljTmF2YmFyID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIW5ld05hdmJhcklubmVyIHx8IG5ld05hdmJhcklubmVyLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZHluYW1pY05hdmJhciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZHluYW1pY05hdmJhciA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIG5ld1BhZ2UuYWRkQ2xhc3MoJ3BhZ2Utb24tbGVmdCcpLnJlbW92ZUNsYXNzKCdjYWNoZWQnKTtcbiAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICBuYXZiYXIgPSB2aWV3Q29udGFpbmVyLmZpbmQoJy5uYXZiYXInKTtcbiAgICAgICAgICAgICAgICAgICAgbmF2YmFySW5uZXJzID0gdmlld0NvbnRhaW5lci5maW5kKCcubmF2YmFyLWlubmVyOm5vdCguY2FjaGVkKScpO1xuICAgICAgICAgICAgICAgICAgICBuZXdOYXZiYXJJbm5lci5hZGRDbGFzcygnbmF2YmFyLW9uLWxlZnQnKS5yZW1vdmVDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIFJlbW92ZS9oaWRlIHByZXZpb3VzIHBhZ2UgaW4gZm9yY2UgbW9kZVxuICAgICAgICAgICAgICAgIGlmIChmb3JjZSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcGFnZVRvUmVtb3ZlLCBuYXZiYXJUb1JlbW92ZTtcbiAgICAgICAgICAgICAgICAgICAgcGFnZVRvUmVtb3ZlID0gJChwYWdlc0luVmlld1twYWdlc0luVmlldy5sZW5ndGggLSAyXSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikgbmF2YmFyVG9SZW1vdmUgPSAkKHBhZ2VUb1JlbW92ZVswXSAmJiBwYWdlVG9SZW1vdmVbMF0uZjdSZWxhdGVkTmF2YmFyIHx8IG5hdmJhcklubmVyc1tuYXZiYXJJbm5lcnMubGVuZ3RoIC0gMl0pO1xuICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuZG9tQ2FjaGUgJiYgdmlldy5pbml0aWFsUGFnZXMuaW5kZXhPZihwYWdlVG9SZW1vdmVbMF0pID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYWdlVG9SZW1vdmUubGVuZ3RoICYmIHBhZ2VUb1JlbW92ZVswXSAhPT0gbmV3UGFnZVswXSkgcGFnZVRvUmVtb3ZlLmFkZENsYXNzKCdjYWNoZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyICYmIG5hdmJhclRvUmVtb3ZlLmxlbmd0aCAmJiBuYXZiYXJUb1JlbW92ZVswXSAhPT0gbmV3TmF2YmFySW5uZXJbMF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYXZiYXJUb1JlbW92ZS5hZGRDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVtb3ZlTmF2YmFyID0gZHluYW1pY05hdmJhciAmJiBuYXZiYXJUb1JlbW92ZS5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFnZVRvUmVtb3ZlLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5wYWdlUmVtb3ZlQ2FsbGJhY2sodmlldywgcGFnZVRvUmVtb3ZlWzBdLCAncmlnaHQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVtb3ZlTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5uYXZiYXJSZW1vdmVDYWxsYmFjayh2aWV3LCBwYWdlVG9SZW1vdmVbMF0sIG5hdmJhclswXSwgbmF2YmFyVG9SZW1vdmVbMF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlVG9SZW1vdmUucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlbW92ZU5hdmJhcikgbmF2YmFyVG9SZW1vdmUucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChyZW1vdmVOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAubmF2YmFyUmVtb3ZlQ2FsbGJhY2sodmlldywgcGFnZVRvUmVtb3ZlWzBdLCBuYXZiYXJbMF0sIG5hdmJhclRvUmVtb3ZlWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYXZiYXJUb1JlbW92ZS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBwYWdlc0luVmlldyA9IHBhZ2VzQ29udGFpbmVyLmNoaWxkcmVuKCcucGFnZTpub3QoLmNhY2hlZCknKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hdmJhcklubmVycyA9IHZpZXdDb250YWluZXIuZmluZCgnLm5hdmJhci1pbm5lcjpub3QoLmNhY2hlZCknKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5oaXN0b3J5LmluZGV4T2YodXJsKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2aWV3Lmhpc3RvcnkgPSB2aWV3Lmhpc3Rvcnkuc2xpY2UoMCwgdmlldy5oaXN0b3J5LmluZGV4T2YodXJsKSArIDIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcuaGlzdG9yeVtbdmlldy5oaXN0b3J5Lmxlbmd0aCAtIDJdXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZXcuaGlzdG9yeVt2aWV3Lmhpc3RvcnkubGVuZ3RoIC0gMl0gPSB1cmw7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWV3Lmhpc3RvcnkudW5zaGlmdCh1cmwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBvbGRQYWdlID0gJChwYWdlc0luVmlld1twYWdlc0luVmlldy5sZW5ndGggLSAxXSk7XG4gICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvbGRQYWdlWzBdID09PSBuZXdQYWdlWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvbGRQYWdlID0gcGFnZXNDb250YWluZXIuY2hpbGRyZW4oJy5wYWdlLnBhZ2Utb24tY2VudGVyJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob2xkUGFnZS5sZW5ndGggPT09IDAgJiYgdmlldy5hY3RpdmVQYWdlKSBvbGRQYWdlID0gJCh2aWV3LmFjdGl2ZVBhZ2UuY29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNOYXZiYXIgJiYgIW9sZE5hdmJhcklubmVyKSB7XG4gICAgICAgICAgICAgICAgICAgIG9sZE5hdmJhcklubmVyID0gJChuYXZiYXJJbm5lcnNbbmF2YmFySW5uZXJzLmxlbmd0aCAtIDFdKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob2xkTmF2YmFySW5uZXJbMF0gPT09IG5ld05hdmJhcklubmVyWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2xkTmF2YmFySW5uZXIgPSBuYXZiYXIuY2hpbGRyZW4oJy5uYXZiYXItaW5uZXIubmF2YmFyLW9uLWNlbnRlcjpub3QoLmNhY2hlZCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGROYXZiYXJJbm5lci5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbGROYXZiYXJJbm5lciA9IG5hdmJhci5jaGlsZHJlbignLm5hdmJhci1pbm5lcltkYXRhLXBhZ2U9XCInK29sZFBhZ2UuYXR0cignZGF0YS1wYWdlJykrJ1wiXScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChvbGROYXZiYXJJbm5lci5sZW5ndGggPT09IDAgfHwgbmV3TmF2YmFySW5uZXJbMF0gPT09IG9sZE5hdmJhcklubmVyWzBdKSBkeW5hbWljTmF2YmFyID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICBpZiAobWFuaXB1bGF0ZURvbSkgbmV3TmF2YmFySW5uZXIuaW5zZXJ0QmVmb3JlKG9sZE5hdmJhcklubmVyKTtcbiAgICAgICAgICAgICAgICAgICAgbmV3TmF2YmFySW5uZXJbMF0uZjdSZWxhdGVkUGFnZSA9IG5ld1BhZ2VbMF07XG4gICAgICAgICAgICAgICAgICAgIG5ld1BhZ2VbMF0uZjdSZWxhdGVkTmF2YmFyID0gbmV3TmF2YmFySW5uZXJbMF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChtYW5pcHVsYXRlRG9tKSBuZXdQYWdlLmluc2VydEJlZm9yZShvbGRQYWdlKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gUGFnZSBJbml0IEV2ZW50c1xuICAgICAgICAgICAgICAgIGFwcC5wYWdlSW5pdENhbGxiYWNrKHZpZXcsIHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lcjogbmV3UGFnZVswXSxcbiAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmwsXG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uOiAnbGVmdCcsXG4gICAgICAgICAgICAgICAgICAgIG5hdmJhcklubmVyQ29udGFpbmVyOiBkeW5hbWljTmF2YmFyID8gbmV3TmF2YmFySW5uZXJbMF0gOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgIG9sZE5hdmJhcklubmVyQ29udGFpbmVyOiBkeW5hbWljTmF2YmFyID8gb2xkTmF2YmFySW5uZXIgJiYgb2xkTmF2YmFySW5uZXJbMF0gOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IHQ3X3JlbmRlcmVkLmNvbnRleHQsXG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5OiBvcHRpb25zLnF1ZXJ5LFxuICAgICAgICAgICAgICAgICAgICBmcm9tUGFnZTogb2xkUGFnZSAmJiBvbGRQYWdlLmxlbmd0aCAmJiBvbGRQYWdlWzBdLmY3UGFnZURhdGEsXG4gICAgICAgICAgICAgICAgICAgIHByZWxvYWRPbmx5OiBwcmVsb2FkT25seVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5uYXZiYXJJbml0Q2FsbGJhY2sodmlldywgbmV3UGFnZVswXSwgbmF2YmFyWzBdLCBuZXdOYXZiYXJJbm5lclswXSwgdXJsLCAncmlnaHQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChkeW5hbWljTmF2YmFyICYmIG5ld05hdmJhcklubmVyLmhhc0NsYXNzKCduYXZiYXItb24tbGVmdCcpICYmIGFuaW1hdGVQYWdlcykge1xuICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLnByZXBhcmVOYXZiYXIobmV3TmF2YmFySW5uZXIsICBvbGROYXZiYXJJbm5lciwgJ2xlZnQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChwcmVsb2FkT25seSkge1xuICAgICAgICAgICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBWaWV3J3MgVVJMXG4gICAgICAgICAgICAgICAgdmlldy51cmwgPSB1cmw7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIEZvcmNlIHJlTGF5b3V0XG4gICAgICAgICAgICAgICAgdmFyIGNsaWVudExlZnQgPSBuZXdQYWdlWzBdLmNsaWVudExlZnQ7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGFuaW1hdGVCYWNrKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFB1c2ggc3RhdGVcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5wdXNoU3RhdGUgJiYgdmlldy5tYWluKSAge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHB1c2hTdGF0ZSA9PT0gJ3VuZGVmaW5lZCcpIHB1c2hTdGF0ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcHJlbG9hZE9ubHkgJiYgaGlzdG9yeS5zdGF0ZSAmJiBwdXNoU3RhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhpc3RvcnkuYmFjaygpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTaW1wbGUgZ28gYmFjayB3aGVuIHdlIGhhdmUgcGFnZXMgb24gbGVmdFxuICAgICAgICAgICAgaWYgKHBhZ2VzSW5WaWV3Lmxlbmd0aCA+IDEgJiYgIWZvcmNlKSB7XG4gICAgICAgICAgICAgICAgLy8gRXhpdCBpZiBvbmx5IHByZWxvYWRPbmx5XG4gICAgICAgICAgICAgICAgaWYgKHByZWxvYWRPbmx5KSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcuYWxsb3dQYWdlQ2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVmlldydzIFVSTFxuICAgICAgICAgICAgICAgIHZpZXcudXJsID0gdmlldy5oaXN0b3J5W3ZpZXcuaGlzdG9yeS5sZW5ndGggLSAyXTtcbiAgICAgICAgICAgICAgICB1cmwgPSB2aWV3LnVybDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gRGVmaW5lIG9sZCBhbmQgbmV3IHBhZ2VzXG4gICAgICAgICAgICAgICAgbmV3UGFnZSA9ICQocGFnZXNJblZpZXdbcGFnZXNJblZpZXcubGVuZ3RoIC0gMl0pO1xuICAgICAgICAgICAgICAgIG9sZFBhZ2UgPSAkKHBhZ2VzSW5WaWV3W3BhZ2VzSW5WaWV3Lmxlbmd0aCAtIDFdKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gRHluYW1pYyBuYXZiYXJcbiAgICAgICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICBkeW5hbWljTmF2YmFyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgLy8gRmluZCBuYXZiYXJcbiAgICAgICAgICAgICAgICAgICAgbmF2YmFySW5uZXJzID0gdmlld0NvbnRhaW5lci5maW5kKCcubmF2YmFyLWlubmVyOm5vdCguY2FjaGVkKScpO1xuICAgICAgICAgICAgICAgICAgICBuZXdOYXZiYXJJbm5lciA9ICQobmF2YmFySW5uZXJzWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgb2xkTmF2YmFySW5uZXIgPSAkKG5hdmJhcklubmVyc1sxXSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChuZXdOYXZiYXJJbm5lci5sZW5ndGggPT09IDAgfHwgb2xkTmF2YmFySW5uZXIubGVuZ3RoID09PSAwIHx8IG9sZE5hdmJhcklubmVyWzBdID09PSBuZXdOYXZiYXJJbm5lclswXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZHluYW1pY05hdmJhciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG1hbmlwdWxhdGVEb20gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBzZXRQYWdlcygpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoIWZvcmNlKSB7XG4gICAgICAgICAgICAgICAgLy8gR28gYmFjayB3aGVuIHRoZXJlIGlzIG5vIHBhZ2VzIG9uIGxlZnRcbiAgICAgICAgICAgICAgICBpZiAoIXByZWxvYWRPbmx5KSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXcudXJsID0gdmlldy5oaXN0b3J5W3ZpZXcuaGlzdG9yeS5sZW5ndGggLSAyXTtcbiAgICAgICAgICAgICAgICAgICAgdXJsID0gdmlldy51cmw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoY29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICBwYXJzZU5ld1BhZ2UoKTtcbiAgICAgICAgICAgICAgICAgICAgc2V0UGFnZXMoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChwYWdlTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBHZXQgZG9tIGNhY2hlZCBwYWdlc1xuICAgICAgICAgICAgICAgICAgICBuZXdQYWdlID0gJCh2aWV3Q29udGFpbmVyKS5maW5kKCcucGFnZVtkYXRhLXBhZ2U9XCInICsgcGFnZU5hbWUgKyAnXCJdJyk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5keW5hbWljTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdOYXZiYXJJbm5lciA9ICQodmlld0NvbnRhaW5lcikuZmluZCgnLm5hdmJhci1pbm5lcltkYXRhLXBhZ2U9XCInICsgcGFnZU5hbWUgKyAnXCJdJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3TmF2YmFySW5uZXIubGVuZ3RoID09PSAwICYmIG5ld1BhZ2VbMF0uZjdSZWxhdGVkTmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3TmF2YmFySW5uZXIgPSAkKG5ld1BhZ2VbMF0uZjdSZWxhdGVkTmF2YmFyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdOYXZiYXJJbm5lci5sZW5ndGggPT09IDAgJiYgbmV3UGFnZVswXS5mN1BhZ2VEYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3TmF2YmFySW5uZXIgPSAkKG5ld1BhZ2VbMF0uZjdQYWdlRGF0YS5uYXZiYXJJbm5lckNvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgc2V0UGFnZXMoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKHVybCAmJiB1cmwgPT09IHZpZXcudXJsIHx8IHBhZ2VOYW1lICYmIHZpZXcuYWN0aXZlUGFnZSAmJiB2aWV3LmFjdGl2ZVBhZ2UubmFtZSA9PT0gcGFnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIEdvIGJhY2sgd2l0aCBmb3JjZSB1cmxcbiAgICAgICAgICAgICAgICBpZiAoY29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICBwYXJzZU5ld1BhZ2UoKTtcbiAgICAgICAgICAgICAgICAgICAgc2V0UGFnZXMoKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChwYWdlTmFtZSAmJiB2aWV3LnBhcmFtcy5kb21DYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFnZU5hbWUpIHVybCA9ICcjJyArIHBhZ2VOYW1lO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgbmV3UGFnZSA9ICQodmlld0NvbnRhaW5lcikuZmluZCgnLnBhZ2VbZGF0YS1wYWdlPVwiJyArIHBhZ2VOYW1lICsgJ1wiXScpO1xuICAgICAgICAgICAgICAgICAgICBpZiAobmV3UGFnZVswXS5mN1BhZ2VEYXRhICYmIG5ld1BhZ2VbMF0uZjdQYWdlRGF0YS51cmwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybCA9IG5ld1BhZ2VbMF0uZjdQYWdlRGF0YS51cmw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmR5bmFtaWNOYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld05hdmJhcklubmVyID0gJCh2aWV3Q29udGFpbmVyKS5maW5kKCcubmF2YmFyLWlubmVyW2RhdGEtcGFnZT1cIicgKyBwYWdlTmFtZSArICdcIl0nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdOYXZiYXJJbm5lci5sZW5ndGggPT09IDAgJiYgbmV3UGFnZVswXS5mN1JlbGF0ZWROYXZiYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdOYXZiYXJJbm5lciA9ICQobmV3UGFnZVswXS5mN1JlbGF0ZWROYXZiYXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld05hdmJhcklubmVyLmxlbmd0aCA9PT0gMCAmJiBuZXdQYWdlWzBdLmY3UGFnZURhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdOYXZiYXJJbm5lciA9ICQobmV3UGFnZVswXS5mN1BhZ2VEYXRhLm5hdmJhcklubmVyQ29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzZXRQYWdlcygpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB9O1xuICAgICAgICBhcHAucm91dGVyLmJhY2sgPSBmdW5jdGlvbiAodmlldywgb3B0aW9ucykge1xuICAgICAgICAgICAgaWYgKGFwcC5yb3V0ZXIucHJlcm91dGUodmlldywgb3B0aW9ucykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICAgICAgICAgIHZhciB1cmwgPSBvcHRpb25zLnVybDtcbiAgICAgICAgICAgIHZhciBjb250ZW50ID0gb3B0aW9ucy5jb250ZW50O1xuICAgICAgICAgICAgdmFyIHBhZ2VOYW1lID0gb3B0aW9ucy5wYWdlTmFtZTtcbiAgICAgICAgICAgIGlmIChwYWdlTmFtZSkge1xuICAgICAgICAgICAgICAgIGlmIChwYWdlTmFtZS5pbmRleE9mKCc/JykgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMucXVlcnkgPSAkLnBhcnNlVXJsUXVlcnkocGFnZU5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnBhZ2VOYW1lID0gcGFnZU5hbWUgPSBwYWdlTmFtZS5zcGxpdCgnPycpWzBdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBmb3JjZSA9IG9wdGlvbnMuZm9yY2U7XG4gICAgICAgICAgICBpZiAoIXZpZXcuYWxsb3dQYWdlQ2hhbmdlKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKGFwcC54aHIgJiYgdmlldy54aHIgJiYgdmlldy54aHIgPT09IGFwcC54aHIpIHtcbiAgICAgICAgICAgICAgICBhcHAueGhyLmFib3J0KCk7XG4gICAgICAgICAgICAgICAgYXBwLnhociA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHBhZ2VzSW5WaWV3ID0gJCh2aWV3LnBhZ2VzQ29udGFpbmVyKS5maW5kKCcucGFnZTpub3QoLmNhY2hlZCknKTtcbiAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiBwcm9jZWVkKGNvbnRlbnQpIHtcbiAgICAgICAgICAgICAgICBhcHAucm91dGVyLnByZXByb2Nlc3ModmlldywgY29udGVudCwgdXJsLCBmdW5jdGlvbiAoY29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmNvbnRlbnQgPSBjb250ZW50O1xuICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLl9iYWNrKHZpZXcsIG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHBhZ2VzSW5WaWV3Lmxlbmd0aCA+IDEgJiYgIWZvcmNlKSB7XG4gICAgICAgICAgICAgICAgLy8gU2ltcGxlIGdvIGJhY2sgdG8gcHJldmlvcyBwYWdlIGluIHZpZXdcbiAgICAgICAgICAgICAgICBhcHAucm91dGVyLl9iYWNrKHZpZXcsIG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghZm9yY2UpIHtcbiAgICAgICAgICAgICAgICB1cmwgPSBvcHRpb25zLnVybCA9IHZpZXcuaGlzdG9yeVt2aWV3Lmhpc3RvcnkubGVuZ3RoIC0gMl07XG4gICAgICAgICAgICAgICAgaWYgKCF1cmwpIHtcbiAgICAgICAgICAgICAgICAgICAgdmlldy5hbGxvd1BhZ2VDaGFuZ2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh1cmwuaW5kZXhPZignIycpID09PSAwICYmIHZpZXcuY29udGVudENhY2hlW3VybF0pIHtcbiAgICAgICAgICAgICAgICAgICAgcHJvY2VlZCh2aWV3LmNvbnRlbnRDYWNoZVt1cmxdKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmICh1cmwuaW5kZXhPZignIycpID09PSAwICYmIHZpZXcucGFyYW1zLmRvbUNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcGFnZU5hbWUpIG9wdGlvbnMucGFnZU5hbWUgPSB1cmwuc3BsaXQoJyMnKVsxXTtcbiAgICAgICAgICAgICAgICAgICAgcHJvY2VlZCgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHVybC5pbmRleE9mKCcjJykgIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCBhamF4IHBhZ2VcbiAgICAgICAgICAgICAgICAgICAgYXBwLmdldChvcHRpb25zLnVybCwgdmlldywgb3B0aW9ucy5pZ25vcmVDYWNoZSwgZnVuY3Rpb24gKGNvbnRlbnQsIGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2VlZChjb250ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBHbyBiYWNrIHdpdGggZm9yY2UgdXJsXG4gICAgICAgICAgICAgICAgaWYgKCF1cmwgJiYgY29udGVudCkge1xuICAgICAgICAgICAgICAgICAgICBwcm9jZWVkKGNvbnRlbnQpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKCF1cmwgJiYgcGFnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2VOYW1lKSB1cmwgPSAnIycgKyBwYWdlTmFtZTtcbiAgICAgICAgICAgICAgICAgICAgcHJvY2VlZCgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHVybCkge1xuICAgICAgICAgICAgICAgICAgICBhcHAuZ2V0KG9wdGlvbnMudXJsLCB2aWV3LCBvcHRpb25zLmlnbm9yZUNhY2hlLCBmdW5jdGlvbiAoY29udGVudCwgZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZXcuYWxsb3dQYWdlQ2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9jZWVkKGNvbnRlbnQpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZpZXcuYWxsb3dQYWdlQ2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGFwcC5yb3V0ZXIuYWZ0ZXJCYWNrID0gZnVuY3Rpb24gKHZpZXcsIG9sZFBhZ2UsIG5ld1BhZ2UpIHtcbiAgICAgICAgICAgIC8vIFJlbW92ZSBvbGQgcGFnZSBhbmQgc2V0IGNsYXNzZXMgb24gbmV3IG9uZVxuICAgICAgICAgICAgb2xkUGFnZSA9ICQob2xkUGFnZSk7XG4gICAgICAgICAgICBuZXdQYWdlID0gJChuZXdQYWdlKTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuZG9tQ2FjaGUgJiYgdmlldy5pbml0aWFsUGFnZXMuaW5kZXhPZihvbGRQYWdlWzBdKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgb2xkUGFnZS5yZW1vdmVDbGFzcygncGFnZS1mcm9tLWNlbnRlci10by1yaWdodCcpLmFkZENsYXNzKCdjYWNoZWQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGFwcC5wYWdlUmVtb3ZlQ2FsbGJhY2sodmlldywgb2xkUGFnZVswXSwgJ3JpZ2h0Jyk7XG4gICAgICAgICAgICAgICAgb2xkUGFnZS5yZW1vdmUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBuZXdQYWdlLnJlbW92ZUNsYXNzKCdwYWdlLWZyb20tbGVmdC10by1jZW50ZXIgcGFnZS1vbi1sZWZ0JykuYWRkQ2xhc3MoJ3BhZ2Utb24tY2VudGVyJyk7XG4gICAgICAgICAgICB2aWV3LmFsbG93UGFnZUNoYW5nZSA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVXBkYXRlIFZpZXcncyBIaXN0b3J5XG4gICAgICAgICAgICB2YXIgcHJldmlvdXNVUkwgPSB2aWV3Lmhpc3RvcnkucG9wKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIG5ld05hdmJhcjtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBVcGRhdGVkIGR5bmFtaWMgbmF2YmFyXG4gICAgICAgICAgICBpZiAodmlldy5wYXJhbXMuZHluYW1pY05hdmJhcikge1xuICAgICAgICAgICAgICAgIHZhciBpbm5lcnMgPSAkKHZpZXcuY29udGFpbmVyKS5maW5kKCcubmF2YmFyLWlubmVyOm5vdCguY2FjaGVkKScpO1xuICAgICAgICAgICAgICAgIHZhciBvbGROYXZiYXIgPSAkKG9sZFBhZ2VbMF0uZjdSZWxhdGVkTmF2YmFyIHx8IGlubmVyc1sxXSk7XG4gICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlICYmIHZpZXcuaW5pdGlhbE5hdmJhcnMuaW5kZXhPZihvbGROYXZiYXJbMF0pID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgb2xkTmF2YmFyLnJlbW92ZUNsYXNzKCduYXZiYXItZnJvbS1jZW50ZXItdG8tcmlnaHQnKS5hZGRDbGFzcygnY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhcHAubmF2YmFyUmVtb3ZlQ2FsbGJhY2sodmlldywgb2xkUGFnZVswXSwgdW5kZWZpbmVkLCBvbGROYXZiYXJbMF0pO1xuICAgICAgICAgICAgICAgICAgICBvbGROYXZiYXIucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG5ld05hdmJhciA9ICQoaW5uZXJzWzBdKS5yZW1vdmVDbGFzcygnbmF2YmFyLW9uLWxlZnQgbmF2YmFyLWZyb20tbGVmdC10by1jZW50ZXInKS5hZGRDbGFzcygnbmF2YmFyLW9uLWNlbnRlcicpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFJlbW92ZSBwYWdlcyBpbiBkb20gY2FjaGVcbiAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5kb21DYWNoZSkge1xuICAgICAgICAgICAgICAgICQodmlldy5jb250YWluZXIpLmZpbmQoJy5wYWdlLmNhY2hlZCcpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcGFnZSA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpbmRleCA9IHBhZ2UuaW5kZXgoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhZ2VVcmwgPSBwYWdlWzBdLmY3UGFnZURhdGEgJiYgcGFnZVswXS5mN1BhZ2VEYXRhLnVybDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2VVcmwgJiYgdmlldy5oaXN0b3J5LmluZGV4T2YocGFnZVVybCkgPCAwICYmIHZpZXcuaW5pdGlhbFBhZ2VzLmluZGV4T2YodGhpcykgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAucGFnZVJlbW92ZUNhbGxiYWNrKHZpZXcsIHBhZ2VbMF0sICdyaWdodCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2VbMF0uZjdSZWxhdGVkTmF2YmFyICYmIHZpZXcucGFyYW1zLmR5bmFtaWNOYXZiYXIpIGFwcC5uYXZiYXJSZW1vdmVDYWxsYmFjayh2aWV3LCBwYWdlWzBdLCB1bmRlZmluZWQsIHBhZ2VbMF0uZjdSZWxhdGVkTmF2YmFyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2UucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFnZVswXS5mN1JlbGF0ZWROYXZiYXIgJiYgdmlldy5wYXJhbXMuZHluYW1pY05hdmJhcikgJChwYWdlWzBdLmY3UmVsYXRlZE5hdmJhcikucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDaGVjayBwcmV2aW91cyBwYWdlIGlzIGNvbnRlbnQgYmFzZWQgb25seSBhbmQgcmVtb3ZlIGl0IGZyb20gY29udGVudCBjYWNoZVxuICAgICAgICAgICAgaWYgKCF2aWV3LnBhcmFtcy5kb21DYWNoZSAmJlxuICAgICAgICAgICAgICAgIHByZXZpb3VzVVJMICYmXG4gICAgICAgICAgICAgICAgcHJldmlvdXNVUkwuaW5kZXhPZignIycpID4gLTEgJiZcbiAgICAgICAgICAgICAgICAocHJldmlvdXNVUkwgaW4gdmlldy5jb250ZW50Q2FjaGUpICYmXG4gICAgICAgICAgICAgICAgLy8gSWYgdGhlIHNhbWUgcGFnZSBpcyBpbiB0aGUgaGlzdG9yeSBtdWx0aXBsZSB0aW1lcywgZG9uJ3QgcmVtb3ZlIGl0LlxuICAgICAgICAgICAgICAgIHZpZXcuaGlzdG9yeS5pbmRleE9mKHByZXZpb3VzVVJMKSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICB2aWV3LmNvbnRlbnRDYWNoZVtwcmV2aW91c1VSTF0gPSBudWxsO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB2aWV3LmNvbnRlbnRDYWNoZVtwcmV2aW91c1VSTF07XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMucHVzaFN0YXRlICYmIHZpZXcubWFpbikgYXBwLnB1c2hTdGF0ZUNsZWFyUXVldWUoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQcmVsb2FkIHByZXZpb3VzIHBhZ2VcbiAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5wcmVsb2FkUHJldmlvdXNQYWdlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHZpZXcucGFyYW1zLmRvbUNhY2hlICYmIHZpZXcuaGlzdG9yeS5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwcmVsb2FkVXJsID0gdmlldy5oaXN0b3J5W3ZpZXcuaGlzdG9yeS5sZW5ndGggLSAyXTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzUGFnZTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzTmF2YmFyO1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJlbG9hZFVybCAmJiB2aWV3LnBhZ2VzQ2FjaGVbcHJlbG9hZFVybF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIExvYWQgYnkgcGFnZSBuYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1BhZ2UgPSAkKHZpZXcuY29udGFpbmVyKS5maW5kKCcucGFnZVtkYXRhLXBhZ2U9XCInICsgdmlldy5wYWdlc0NhY2hlW3ByZWxvYWRVcmxdICsgJ1wiXScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzUGFnZS5uZXh0KCcucGFnZScpWzBdICE9PSBuZXdQYWdlWzBdKSBwcmV2aW91c1BhZ2UuaW5zZXJ0QmVmb3JlKG5ld1BhZ2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld05hdmJhcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZXZpb3VzTmF2YmFyID0gJCh2aWV3LmNvbnRhaW5lcikuZmluZCgnLm5hdmJhci1pbm5lcltkYXRhLXBhZ2U9XCInICsgdmlldy5wYWdlc0NhY2hlW3ByZWxvYWRVcmxdICsgJ1wiXScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFwcmV2aW91c05hdmJhciB8fCBwcmV2aW91c05hdmJhci5sZW5ndGggPT09IDApIHByZXZpb3VzTmF2YmFyID0gbmV3TmF2YmFyLnByZXYoJy5uYXZiYXItaW5uZXIuY2FjaGVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXZpb3VzTmF2YmFyLm5leHQoJy5uYXZiYXItaW5uZXInKVswXSAhPT0gbmV3TmF2YmFyWzBdKSBwcmV2aW91c05hdmJhci5pbnNlcnRCZWZvcmUobmV3TmF2YmFyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEp1c3QgbG9hZCBwcmV2aW91cyBwYWdlXG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c1BhZ2UgPSBuZXdQYWdlLnByZXYoJy5wYWdlLmNhY2hlZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5ld05hdmJhcikgcHJldmlvdXNOYXZiYXIgPSBuZXdOYXZiYXIucHJldignLm5hdmJhci1pbm5lci5jYWNoZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNQYWdlICYmIHByZXZpb3VzUGFnZS5sZW5ndGggPiAwKSBwcmV2aW91c1BhZ2UucmVtb3ZlQ2xhc3MoJ2NhY2hlZCBwYWdlLW9uLXJpZ2h0IHBhZ2Utb24tY2VudGVyJykuYWRkQ2xhc3MoJ3BhZ2Utb24tbGVmdCcpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNOYXZiYXIgJiYgcHJldmlvdXNOYXZiYXIubGVuZ3RoID4gMCkgcHJldmlvdXNOYXZiYXIucmVtb3ZlQ2xhc3MoJ2NhY2hlZCBuYXZiYXItb24tcmlnaHQgbmF2YmFyLW9uLWNlbnRlcicpLmFkZENsYXNzKCduYXZiYXItb24tbGVmdCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci5iYWNrKHZpZXcsIHtwcmVsb2FkT25seTogdHJ1ZX0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgTW9kYWxzICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHZhciBfbW9kYWxUZW1wbGF0ZVRlbXBEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgYXBwLm1vZGFsU3RhY2sgPSBbXTtcbiAgICAgICAgYXBwLm1vZGFsU3RhY2tDbGVhclF1ZXVlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKGFwcC5tb2RhbFN0YWNrLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIChhcHAubW9kYWxTdGFjay5zaGlmdCgpKSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBhcHAubW9kYWwgPSBmdW5jdGlvbiAocGFyYW1zKSB7XG4gICAgICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307XG4gICAgICAgICAgICB2YXIgbW9kYWxIVE1MID0gJyc7XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tb2RhbFRlbXBsYXRlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLm1vZGFsKSBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLm1vZGFsID0gdDcuY29tcGlsZShhcHAucGFyYW1zLm1vZGFsVGVtcGxhdGUpO1xuICAgICAgICAgICAgICAgIG1vZGFsSFRNTCA9IGFwcC5fY29tcGlsZWRUZW1wbGF0ZXMubW9kYWwocGFyYW1zKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBidXR0b25zSFRNTCA9ICcnO1xuICAgICAgICAgICAgICAgIGlmIChwYXJhbXMuYnV0dG9ucyAmJiBwYXJhbXMuYnV0dG9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFyYW1zLmJ1dHRvbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbnNIVE1MICs9ICc8c3BhbiBjbGFzcz1cIm1vZGFsLWJ1dHRvbicgKyAocGFyYW1zLmJ1dHRvbnNbaV0uYm9sZCA/ICcgbW9kYWwtYnV0dG9uLWJvbGQnIDogJycpICsgJ1wiPicgKyBwYXJhbXMuYnV0dG9uc1tpXS50ZXh0ICsgJzwvc3Bhbj4nO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciB0aXRsZUhUTUwgPSBwYXJhbXMudGl0bGUgPyAnPGRpdiBjbGFzcz1cIm1vZGFsLXRpdGxlXCI+JyArIHBhcmFtcy50aXRsZSArICc8L2Rpdj4nIDogJyc7XG4gICAgICAgICAgICAgICAgdmFyIHRleHRIVE1MID0gcGFyYW1zLnRleHQgPyAnPGRpdiBjbGFzcz1cIm1vZGFsLXRleHRcIj4nICsgcGFyYW1zLnRleHQgKyAnPC9kaXY+JyA6ICcnO1xuICAgICAgICAgICAgICAgIHZhciBhZnRlclRleHRIVE1MID0gcGFyYW1zLmFmdGVyVGV4dCA/IHBhcmFtcy5hZnRlclRleHQgOiAnJztcbiAgICAgICAgICAgICAgICB2YXIgbm9CdXR0b25zID0gIXBhcmFtcy5idXR0b25zIHx8IHBhcmFtcy5idXR0b25zLmxlbmd0aCA9PT0gMCA/ICdtb2RhbC1uby1idXR0b25zJyA6ICcnO1xuICAgICAgICAgICAgICAgIHZhciB2ZXJ0aWNhbEJ1dHRvbnMgPSBwYXJhbXMudmVydGljYWxCdXR0b25zID8gJ21vZGFsLWJ1dHRvbnMtdmVydGljYWwnOiAnJztcbiAgICAgICAgICAgICAgICB2YXIgbW9kYWxCdXR0b25zSFRNTCA9IHBhcmFtcy5idXR0b25zICYmIHBhcmFtcy5idXR0b25zLmxlbmd0aCA+IDAgPyAnPGRpdiBjbGFzcz1cIm1vZGFsLWJ1dHRvbnMgbW9kYWwtYnV0dG9ucy0nICsgcGFyYW1zLmJ1dHRvbnMubGVuZ3RoICsgJyAnICsgdmVydGljYWxCdXR0b25zICsgJ1wiPicgKyBidXR0b25zSFRNTCArICc8L2Rpdj4nIDogJyc7XG4gICAgICAgICAgICAgICAgbW9kYWxIVE1MID0gJzxkaXYgY2xhc3M9XCJtb2RhbCAnICsgbm9CdXR0b25zICsgJyAnICsgKHBhcmFtcy5jc3NDbGFzcyB8fCAnJykgKyAnXCI+PGRpdiBjbGFzcz1cIm1vZGFsLWlubmVyXCI+JyArICh0aXRsZUhUTUwgKyB0ZXh0SFRNTCArIGFmdGVyVGV4dEhUTUwpICsgJzwvZGl2PicgKyBtb2RhbEJ1dHRvbnNIVE1MICsgJzwvZGl2Pic7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgX21vZGFsVGVtcGxhdGVUZW1wRGl2LmlubmVySFRNTCA9IG1vZGFsSFRNTDtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgbW9kYWwgPSAkKF9tb2RhbFRlbXBsYXRlVGVtcERpdikuY2hpbGRyZW4oKTtcbiAgICAgICAgXG4gICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKG1vZGFsWzBdKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBBZGQgZXZlbnRzIG9uIGJ1dHRvbnNcbiAgICAgICAgICAgIG1vZGFsLmZpbmQoJy5tb2RhbC1idXR0b24nKS5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWwpIHtcbiAgICAgICAgICAgICAgICAkKGVsKS5vbignY2xpY2snLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW1zLmJ1dHRvbnNbaW5kZXhdLmNsb3NlICE9PSBmYWxzZSkgYXBwLmNsb3NlTW9kYWwobW9kYWwpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW1zLmJ1dHRvbnNbaW5kZXhdLm9uQ2xpY2spIHBhcmFtcy5idXR0b25zW2luZGV4XS5vbkNsaWNrKG1vZGFsLCBlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5vbkNsaWNrKSBwYXJhbXMub25DbGljayhtb2RhbCwgaW5kZXgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBhcHAub3Blbk1vZGFsKG1vZGFsKTtcbiAgICAgICAgICAgIHJldHVybiBtb2RhbFswXTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmFsZXJ0ID0gZnVuY3Rpb24gKHRleHQsIHRpdGxlLCBjYWxsYmFja09rKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHRpdGxlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tPayA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgICAgICAgICB0aXRsZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBhcHAubW9kYWwoe1xuICAgICAgICAgICAgICAgIHRleHQ6IHRleHQgfHwgJycsXG4gICAgICAgICAgICAgICAgdGl0bGU6IHR5cGVvZiB0aXRsZSA9PT0gJ3VuZGVmaW5lZCcgPyBhcHAucGFyYW1zLm1vZGFsVGl0bGUgOiB0aXRsZSxcbiAgICAgICAgICAgICAgICBidXR0b25zOiBbIHt0ZXh0OiBhcHAucGFyYW1zLm1vZGFsQnV0dG9uT2ssIGJvbGQ6IHRydWUsIG9uQ2xpY2s6IGNhbGxiYWNrT2t9IF1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuY29uZmlybSA9IGZ1bmN0aW9uICh0ZXh0LCB0aXRsZSwgY2FsbGJhY2tPaywgY2FsbGJhY2tDYW5jZWwpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdGl0bGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFja0NhbmNlbCA9IGFyZ3VtZW50c1syXTtcbiAgICAgICAgICAgICAgICBjYWxsYmFja09rID0gYXJndW1lbnRzWzFdO1xuICAgICAgICAgICAgICAgIHRpdGxlID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGFwcC5tb2RhbCh7XG4gICAgICAgICAgICAgICAgdGV4dDogdGV4dCB8fCAnJyxcbiAgICAgICAgICAgICAgICB0aXRsZTogdHlwZW9mIHRpdGxlID09PSAndW5kZWZpbmVkJyA/IGFwcC5wYXJhbXMubW9kYWxUaXRsZSA6IHRpdGxlLFxuICAgICAgICAgICAgICAgIGJ1dHRvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAge3RleHQ6IGFwcC5wYXJhbXMubW9kYWxCdXR0b25DYW5jZWwsIG9uQ2xpY2s6IGNhbGxiYWNrQ2FuY2VsfSxcbiAgICAgICAgICAgICAgICAgICAge3RleHQ6IGFwcC5wYXJhbXMubW9kYWxCdXR0b25PaywgYm9sZDogdHJ1ZSwgb25DbGljazogY2FsbGJhY2tPa31cbiAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnByb21wdCA9IGZ1bmN0aW9uICh0ZXh0LCB0aXRsZSwgY2FsbGJhY2tPaywgY2FsbGJhY2tDYW5jZWwpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdGl0bGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFja0NhbmNlbCA9IGFyZ3VtZW50c1syXTtcbiAgICAgICAgICAgICAgICBjYWxsYmFja09rID0gYXJndW1lbnRzWzFdO1xuICAgICAgICAgICAgICAgIHRpdGxlID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGFwcC5tb2RhbCh7XG4gICAgICAgICAgICAgICAgdGV4dDogdGV4dCB8fCAnJyxcbiAgICAgICAgICAgICAgICB0aXRsZTogdHlwZW9mIHRpdGxlID09PSAndW5kZWZpbmVkJyA/IGFwcC5wYXJhbXMubW9kYWxUaXRsZSA6IHRpdGxlLFxuICAgICAgICAgICAgICAgIGFmdGVyVGV4dDogJzxkaXYgY2xhc3M9XCJpbnB1dC1maWVsZFwiPjxpbnB1dCB0eXBlPVwidGV4dFwiIGNsYXNzPVwibW9kYWwtdGV4dC1pbnB1dFwiPjwvZGl2PicsXG4gICAgICAgICAgICAgICAgYnV0dG9uczogW1xuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBhcHAucGFyYW1zLm1vZGFsQnV0dG9uQ2FuY2VsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IGFwcC5wYXJhbXMubW9kYWxCdXR0b25PayxcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvbGQ6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgb25DbGljazogZnVuY3Rpb24gKG1vZGFsLCBpbmRleCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IDAgJiYgY2FsbGJhY2tDYW5jZWwpIGNhbGxiYWNrQ2FuY2VsKCQobW9kYWwpLmZpbmQoJy5tb2RhbC10ZXh0LWlucHV0JykudmFsKCkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IDEgJiYgY2FsbGJhY2tPaykgY2FsbGJhY2tPaygkKG1vZGFsKS5maW5kKCcubW9kYWwtdGV4dC1pbnB1dCcpLnZhbCgpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLm1vZGFsTG9naW4gPSBmdW5jdGlvbiAodGV4dCwgdGl0bGUsIGNhbGxiYWNrT2ssIGNhbGxiYWNrQ2FuY2VsKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHRpdGxlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tDYW5jZWwgPSBhcmd1bWVudHNbMl07XG4gICAgICAgICAgICAgICAgY2FsbGJhY2tPayA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgICAgICAgICB0aXRsZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBhcHAubW9kYWwoe1xuICAgICAgICAgICAgICAgIHRleHQ6IHRleHQgfHwgJycsXG4gICAgICAgICAgICAgICAgdGl0bGU6IHR5cGVvZiB0aXRsZSA9PT0gJ3VuZGVmaW5lZCcgPyBhcHAucGFyYW1zLm1vZGFsVGl0bGUgOiB0aXRsZSxcbiAgICAgICAgICAgICAgICBhZnRlclRleHQ6ICc8ZGl2IGNsYXNzPVwiaW5wdXQtZmllbGQgbW9kYWwtaW5wdXQtZG91YmxlXCI+PGlucHV0IHR5cGU9XCJ0ZXh0XCIgbmFtZT1cIm1vZGFsLXVzZXJuYW1lXCIgcGxhY2Vob2xkZXI9XCInICsgYXBwLnBhcmFtcy5tb2RhbFVzZXJuYW1lUGxhY2Vob2xkZXIgKyAnXCIgY2xhc3M9XCJtb2RhbC10ZXh0LWlucHV0XCI+PC9kaXY+PGRpdiBjbGFzcz1cImlucHV0LWZpZWxkIG1vZGFsLWlucHV0LWRvdWJsZVwiPjxpbnB1dCB0eXBlPVwicGFzc3dvcmRcIiBuYW1lPVwibW9kYWwtcGFzc3dvcmRcIiBwbGFjZWhvbGRlcj1cIicgKyBhcHAucGFyYW1zLm1vZGFsUGFzc3dvcmRQbGFjZWhvbGRlciArICdcIiBjbGFzcz1cIm1vZGFsLXRleHQtaW5wdXRcIj48L2Rpdj4nLFxuICAgICAgICAgICAgICAgIGJ1dHRvbnM6IFtcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogYXBwLnBhcmFtcy5tb2RhbEJ1dHRvbkNhbmNlbFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBhcHAucGFyYW1zLm1vZGFsQnV0dG9uT2ssXG4gICAgICAgICAgICAgICAgICAgICAgICBib2xkOiB0cnVlXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBdLFxuICAgICAgICAgICAgICAgIG9uQ2xpY2s6IGZ1bmN0aW9uIChtb2RhbCwgaW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHVzZXJuYW1lID0gJChtb2RhbCkuZmluZCgnLm1vZGFsLXRleHQtaW5wdXRbbmFtZT1cIm1vZGFsLXVzZXJuYW1lXCJdJykudmFsKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwYXNzd29yZCA9ICQobW9kYWwpLmZpbmQoJy5tb2RhbC10ZXh0LWlucHV0W25hbWU9XCJtb2RhbC1wYXNzd29yZFwiXScpLnZhbCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IDAgJiYgY2FsbGJhY2tDYW5jZWwpIGNhbGxiYWNrQ2FuY2VsKHVzZXJuYW1lLCBwYXNzd29yZCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gMSAmJiBjYWxsYmFja09rKSBjYWxsYmFja09rKHVzZXJuYW1lLCBwYXNzd29yZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5tb2RhbFBhc3N3b3JkID0gZnVuY3Rpb24gKHRleHQsIHRpdGxlLCBjYWxsYmFja09rLCBjYWxsYmFja0NhbmNlbCkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB0aXRsZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrQ2FuY2VsID0gYXJndW1lbnRzWzJdO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrT2sgPSBhcmd1bWVudHNbMV07XG4gICAgICAgICAgICAgICAgdGl0bGUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYXBwLm1vZGFsKHtcbiAgICAgICAgICAgICAgICB0ZXh0OiB0ZXh0IHx8ICcnLFxuICAgICAgICAgICAgICAgIHRpdGxlOiB0eXBlb2YgdGl0bGUgPT09ICd1bmRlZmluZWQnID8gYXBwLnBhcmFtcy5tb2RhbFRpdGxlIDogdGl0bGUsXG4gICAgICAgICAgICAgICAgYWZ0ZXJUZXh0OiAnPGRpdiBjbGFzcz1cImlucHV0LWZpZWxkXCI+PGlucHV0IHR5cGU9XCJwYXNzd29yZFwiIG5hbWU9XCJtb2RhbC1wYXNzd29yZFwiIHBsYWNlaG9sZGVyPVwiJyArIGFwcC5wYXJhbXMubW9kYWxQYXNzd29yZFBsYWNlaG9sZGVyICsgJ1wiIGNsYXNzPVwibW9kYWwtdGV4dC1pbnB1dFwiPjwvZGl2PicsXG4gICAgICAgICAgICAgICAgYnV0dG9uczogW1xuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBhcHAucGFyYW1zLm1vZGFsQnV0dG9uQ2FuY2VsXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IGFwcC5wYXJhbXMubW9kYWxCdXR0b25PayxcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvbGQ6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIF0sXG4gICAgICAgICAgICAgICAgb25DbGljazogZnVuY3Rpb24gKG1vZGFsLCBpbmRleCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcGFzc3dvcmQgPSAkKG1vZGFsKS5maW5kKCcubW9kYWwtdGV4dC1pbnB1dFtuYW1lPVwibW9kYWwtcGFzc3dvcmRcIl0nKS52YWwoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4ID09PSAwICYmIGNhbGxiYWNrQ2FuY2VsKSBjYWxsYmFja0NhbmNlbChwYXNzd29yZCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gMSAmJiBjYWxsYmFja09rKSBjYWxsYmFja09rKHBhc3N3b3JkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnNob3dQcmVsb2FkZXIgPSBmdW5jdGlvbiAodGl0bGUpIHtcbiAgICAgICAgICAgIHJldHVybiBhcHAubW9kYWwoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiB0aXRsZSB8fCBhcHAucGFyYW1zLm1vZGFsUHJlbG9hZGVyVGl0bGUsXG4gICAgICAgICAgICAgICAgdGV4dDogJzxkaXYgY2xhc3M9XCJwcmVsb2FkZXJcIj4nICsgKGFwcC5wYXJhbXMubWF0ZXJpYWwgPyBhcHAucGFyYW1zLm1hdGVyaWFsUHJlbG9hZGVySHRtbCA6ICcnKSArICc8L2Rpdj4nLFxuICAgICAgICAgICAgICAgIGNzc0NsYXNzOiAnbW9kYWwtcHJlbG9hZGVyJ1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5oaWRlUHJlbG9hZGVyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgYXBwLmNsb3NlTW9kYWwoJy5tb2RhbC5tb2RhbC1pbicpO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuc2hvd0luZGljYXRvciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICQoJ2JvZHknKS5hcHBlbmQoJzxkaXYgY2xhc3M9XCJwcmVsb2FkZXItaW5kaWNhdG9yLW92ZXJsYXlcIj48L2Rpdj48ZGl2IGNsYXNzPVwicHJlbG9hZGVyLWluZGljYXRvci1tb2RhbFwiPjxzcGFuIGNsYXNzPVwicHJlbG9hZGVyIHByZWxvYWRlci13aGl0ZVwiPicgKyAoYXBwLnBhcmFtcy5tYXRlcmlhbCA/IGFwcC5wYXJhbXMubWF0ZXJpYWxQcmVsb2FkZXJIdG1sIDogJycpICsgJzwvc3Bhbj48L2Rpdj4nKTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmhpZGVJbmRpY2F0b3IgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAkKCcucHJlbG9hZGVyLWluZGljYXRvci1vdmVybGF5LCAucHJlbG9hZGVyLWluZGljYXRvci1tb2RhbCcpLnJlbW92ZSgpO1xuICAgICAgICB9O1xuICAgICAgICAvLyBBY3Rpb24gU2hlZXRcbiAgICAgICAgYXBwLmFjdGlvbnMgPSBmdW5jdGlvbiAodGFyZ2V0LCBwYXJhbXMpIHtcbiAgICAgICAgICAgIHZhciB0b1BvcG92ZXIgPSBmYWxzZSwgbW9kYWwsIGdyb3VwU2VsZWN0b3IsIGJ1dHRvblNlbGVjdG9yO1xuICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAvLyBBY3Rpb25zXG4gICAgICAgICAgICAgICAgcGFyYW1zID0gdGFyZ2V0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gUG9wb3ZlclxuICAgICAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLmlvcykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5pcGFkKSB0b1BvcG92ZXIgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQod2luZG93KS53aWR0aCgpID49IDc2OCkgdG9Qb3BvdmVyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwgW107XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHBhcmFtcy5sZW5ndGggPiAwICYmICEkLmlzQXJyYXkocGFyYW1zWzBdKSkge1xuICAgICAgICAgICAgICAgIHBhcmFtcyA9IFtwYXJhbXNdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIG1vZGFsSFRNTDtcbiAgICAgICAgICAgIGlmICh0b1BvcG92ZXIpIHtcbiAgICAgICAgICAgICAgICB2YXIgYWN0aW9uc1RvUG9wb3ZlclRlbXBsYXRlID0gYXBwLnBhcmFtcy5tb2RhbEFjdGlvbnNUb1BvcG92ZXJUZW1wbGF0ZSB8fFxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBvcG92ZXIgYWN0aW9ucy1wb3BvdmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwb3BvdmVyLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAne3sjZWFjaCB0aGlzfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibGlzdC1ibG9ja1wiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAnPHVsPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNlYWNoIHRoaXN9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBsYWJlbH19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxsaSBjbGFzcz1cImFjdGlvbnMtcG9wb3Zlci1sYWJlbCB7eyNpZiBjb2xvcn19Y29sb3Ite3tjb2xvcn19e3svaWZ9fSB7eyNpZiBib2xkfX1hY3Rpb25zLXBvcG92ZXItYm9sZHt7L2lmfX1cIj57e3RleHR9fTwvbGk+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7ZWxzZX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxsaT48YSBocmVmPVwiI1wiIGNsYXNzPVwiaXRlbS1saW5rIGxpc3QtYnV0dG9uIHt7I2lmIGNvbG9yfX1jb2xvci17e2NvbG9yfX17ey9pZn19IHt7I2lmIGJnfX1iZy17e2JnfX17ey9pZn19IHt7I2lmIGJvbGR9fWFjdGlvbnMtcG9wb3Zlci1ib2xke3svaWZ9fSB7eyNpZiBkaXNhYmxlZH19ZGlzYWJsZWR7ey9pZn19XCI+e3t0ZXh0fX08L2E+PC9saT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9lYWNofX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvdWw+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAne3svZWFjaH19JyArXG4gICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICBpZiAoIWFwcC5fY29tcGlsZWRUZW1wbGF0ZXMuYWN0aW9uc1RvUG9wb3Zlcikge1xuICAgICAgICAgICAgICAgICAgICBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLmFjdGlvbnNUb1BvcG92ZXIgPSB0Ny5jb21waWxlKGFjdGlvbnNUb1BvcG92ZXJUZW1wbGF0ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBwb3BvdmVySFRNTCA9IGFwcC5fY29tcGlsZWRUZW1wbGF0ZXMuYWN0aW9uc1RvUG9wb3ZlcihwYXJhbXMpO1xuICAgICAgICAgICAgICAgIG1vZGFsID0gJChhcHAucG9wb3Zlcihwb3BvdmVySFRNTCwgdGFyZ2V0LCB0cnVlKSk7XG4gICAgICAgICAgICAgICAgZ3JvdXBTZWxlY3RvciA9ICcubGlzdC1ibG9jayB1bCc7XG4gICAgICAgICAgICAgICAgYnV0dG9uU2VsZWN0b3IgPSAnLmxpc3QtYnV0dG9uJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1vZGFsQWN0aW9uc1RlbXBsYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYXBwLl9jb21waWxlZFRlbXBsYXRlcy5hY3Rpb25zKSBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLmFjdGlvbnMgPSB0Ny5jb21waWxlKGFwcC5wYXJhbXMubW9kYWxBY3Rpb25zVGVtcGxhdGUpO1xuICAgICAgICAgICAgICAgICAgICBtb2RhbEhUTUwgPSBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLmFjdGlvbnMocGFyYW1zKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBidXR0b25zSFRNTCA9ICcnO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHBhcmFtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBwYXJhbXNbaV0ubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaiA9PT0gMCkgYnV0dG9uc0hUTUwgKz0gJzxkaXYgY2xhc3M9XCJhY3Rpb25zLW1vZGFsLWdyb3VwXCI+JztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYnV0dG9uID0gcGFyYW1zW2ldW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBidXR0b25DbGFzcyA9IGJ1dHRvbi5sYWJlbCA/ICdhY3Rpb25zLW1vZGFsLWxhYmVsJyA6ICdhY3Rpb25zLW1vZGFsLWJ1dHRvbic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1dHRvbi5ib2xkKSBidXR0b25DbGFzcyArPSAnIGFjdGlvbnMtbW9kYWwtYnV0dG9uLWJvbGQnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChidXR0b24uY29sb3IpIGJ1dHRvbkNsYXNzICs9ICcgY29sb3ItJyArIGJ1dHRvbi5jb2xvcjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnV0dG9uLmJnKSBidXR0b25DbGFzcyArPSAnIGJnLScgKyBidXR0b24uYmc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1dHRvbi5kaXNhYmxlZCkgYnV0dG9uQ2xhc3MgKz0gJyBkaXNhYmxlZCc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uc0hUTUwgKz0gJzxkaXYgY2xhc3M9XCInICsgYnV0dG9uQ2xhc3MgKyAnXCI+JyArIGJ1dHRvbi50ZXh0ICsgJzwvZGl2Pic7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGogPT09IHBhcmFtc1tpXS5sZW5ndGggLSAxKSBidXR0b25zSFRNTCArPSAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBtb2RhbEhUTUwgPSAnPGRpdiBjbGFzcz1cImFjdGlvbnMtbW9kYWxcIj4nICsgYnV0dG9uc0hUTUwgKyAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgX21vZGFsVGVtcGxhdGVUZW1wRGl2LmlubmVySFRNTCA9IG1vZGFsSFRNTDtcbiAgICAgICAgICAgICAgICBtb2RhbCA9ICQoX21vZGFsVGVtcGxhdGVUZW1wRGl2KS5jaGlsZHJlbigpO1xuICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hcHBlbmQobW9kYWxbMF0pO1xuICAgICAgICAgICAgICAgIGdyb3VwU2VsZWN0b3IgPSAnLmFjdGlvbnMtbW9kYWwtZ3JvdXAnO1xuICAgICAgICAgICAgICAgIGJ1dHRvblNlbGVjdG9yID0gJy5hY3Rpb25zLW1vZGFsLWJ1dHRvbic7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIGdyb3VwcyA9IG1vZGFsLmZpbmQoZ3JvdXBTZWxlY3Rvcik7XG4gICAgICAgICAgICBncm91cHMuZWFjaChmdW5jdGlvbiAoaW5kZXgsIGVsKSB7XG4gICAgICAgICAgICAgICAgdmFyIGdyb3VwSW5kZXggPSBpbmRleDtcbiAgICAgICAgICAgICAgICAkKGVsKS5jaGlsZHJlbigpLmVhY2goZnVuY3Rpb24gKGluZGV4LCBlbCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgYnV0dG9uSW5kZXggPSBpbmRleDtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGJ1dHRvblBhcmFtcyA9IHBhcmFtc1tncm91cEluZGV4XVtidXR0b25JbmRleF07XG4gICAgICAgICAgICAgICAgICAgIHZhciBjbGlja1RhcmdldDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0b1BvcG92ZXIgJiYgJChlbCkuaXMoYnV0dG9uU2VsZWN0b3IpKSBjbGlja1RhcmdldCA9ICQoZWwpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodG9Qb3BvdmVyICYmICQoZWwpLmZpbmQoYnV0dG9uU2VsZWN0b3IpLmxlbmd0aCA+IDApIGNsaWNrVGFyZ2V0ID0gJChlbCkuZmluZChidXR0b25TZWxlY3Rvcik7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tUYXJnZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrVGFyZ2V0Lm9uKCdjbGljaycsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJ1dHRvblBhcmFtcy5jbG9zZSAhPT0gZmFsc2UpIGFwcC5jbG9zZU1vZGFsKG1vZGFsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnV0dG9uUGFyYW1zLm9uQ2xpY2spIGJ1dHRvblBhcmFtcy5vbkNsaWNrKG1vZGFsLCBlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmICghdG9Qb3BvdmVyKSBhcHAub3Blbk1vZGFsKG1vZGFsKTtcbiAgICAgICAgICAgIHJldHVybiBtb2RhbFswXTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnBvcG92ZXIgPSBmdW5jdGlvbiAobW9kYWwsIHRhcmdldCwgcmVtb3ZlT25DbG9zZSkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiByZW1vdmVPbkNsb3NlID09PSAndW5kZWZpbmVkJykgcmVtb3ZlT25DbG9zZSA9IHRydWU7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG1vZGFsID09PSAnc3RyaW5nJyAmJiBtb2RhbC5pbmRleE9mKCc8JykgPj0gMCkge1xuICAgICAgICAgICAgICAgIHZhciBfbW9kYWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgICAgICAgICBfbW9kYWwuaW5uZXJIVE1MID0gbW9kYWwudHJpbSgpO1xuICAgICAgICAgICAgICAgIGlmIChfbW9kYWwuY2hpbGROb2Rlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG1vZGFsID0gX21vZGFsLmNoaWxkTm9kZXNbMF07XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZW1vdmVPbkNsb3NlKSBtb2RhbC5jbGFzc0xpc3QuYWRkKCdyZW1vdmUtb24tY2xvc2UnKTtcbiAgICAgICAgICAgICAgICAgICAgJCgnYm9keScpLmFwcGVuZChtb2RhbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIGZhbHNlOyAvL25vdGhpbmcgZm91bmRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1vZGFsID0gJChtb2RhbCk7XG4gICAgICAgICAgICB0YXJnZXQgPSAkKHRhcmdldCk7XG4gICAgICAgICAgICBpZiAobW9kYWwubGVuZ3RoID09PSAwIHx8IHRhcmdldC5sZW5ndGggPT09IDApIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIGlmIChtb2RhbC5wYXJlbnRzKCdib2R5JykubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJlbW92ZU9uQ2xvc2UpIG1vZGFsLmFkZENsYXNzKCdyZW1vdmUtb24tY2xvc2UnKTtcbiAgICAgICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKG1vZGFsWzBdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChtb2RhbC5maW5kKCcucG9wb3Zlci1hbmdsZScpLmxlbmd0aCA9PT0gMCAmJiAhYXBwLnBhcmFtcy5tYXRlcmlhbCkge1xuICAgICAgICAgICAgICAgIG1vZGFsLmFwcGVuZCgnPGRpdiBjbGFzcz1cInBvcG92ZXItYW5nbGVcIj48L2Rpdj4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1vZGFsLnNob3coKTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgbWF0ZXJpYWwgPSBhcHAucGFyYW1zLm1hdGVyaWFsO1xuICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIHNpemVQb3BvdmVyKCkge1xuICAgICAgICAgICAgICAgIG1vZGFsLmNzcyh7bGVmdDogJycsIHRvcDogJyd9KTtcbiAgICAgICAgICAgICAgICB2YXIgbW9kYWxXaWR0aCA9ICBtb2RhbC53aWR0aCgpO1xuICAgICAgICAgICAgICAgIHZhciBtb2RhbEhlaWdodCA9ICBtb2RhbC5oZWlnaHQoKTsgLy8gMTMgLSBoZWlnaHQgb2YgYW5nbGVcbiAgICAgICAgICAgICAgICB2YXIgbW9kYWxBbmdsZSwgbW9kYWxBbmdsZVNpemUgPSAwLCBtb2RhbEFuZ2xlTGVmdCwgbW9kYWxBbmdsZVRvcDtcbiAgICAgICAgICAgICAgICBpZiAoIW1hdGVyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgIG1vZGFsQW5nbGUgPSBtb2RhbC5maW5kKCcucG9wb3Zlci1hbmdsZScpO1xuICAgICAgICAgICAgICAgICAgICBtb2RhbEFuZ2xlU2l6ZSA9IG1vZGFsQW5nbGUud2lkdGgoKSAvIDI7XG4gICAgICAgICAgICAgICAgICAgIG1vZGFsQW5nbGUucmVtb3ZlQ2xhc3MoJ29uLWxlZnQgb24tcmlnaHQgb24tdG9wIG9uLWJvdHRvbScpLmNzcyh7bGVmdDogJycsIHRvcDogJyd9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG1vZGFsLnJlbW92ZUNsYXNzKCdwb3BvdmVyLW9uLWxlZnQgcG9wb3Zlci1vbi1yaWdodCBwb3BvdmVyLW9uLXRvcCBwb3BvdmVyLW9uLWJvdHRvbScpLmNzcyh7bGVmdDogJycsIHRvcDogJyd9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciB0YXJnZXRXaWR0aCA9IHRhcmdldC5vdXRlcldpZHRoKCk7XG4gICAgICAgICAgICAgICAgdmFyIHRhcmdldEhlaWdodCA9IHRhcmdldC5vdXRlckhlaWdodCgpO1xuICAgICAgICAgICAgICAgIHZhciB0YXJnZXRPZmZzZXQgPSB0YXJnZXQub2Zmc2V0KCk7XG4gICAgICAgICAgICAgICAgdmFyIHRhcmdldFBhcmVudFBhZ2UgPSB0YXJnZXQucGFyZW50cygnLnBhZ2UnKTtcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0UGFyZW50UGFnZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldE9mZnNldC50b3AgPSB0YXJnZXRPZmZzZXQudG9wIC0gdGFyZ2V0UGFyZW50UGFnZVswXS5zY3JvbGxUb3A7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgd2luZG93SGVpZ2h0ID0gJCh3aW5kb3cpLmhlaWdodCgpO1xuICAgICAgICAgICAgICAgIHZhciB3aW5kb3dXaWR0aCA9ICQod2luZG93KS53aWR0aCgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgbW9kYWxUb3AgPSAwO1xuICAgICAgICAgICAgICAgIHZhciBtb2RhbExlZnQgPSAwO1xuICAgICAgICAgICAgICAgIHZhciBkaWZmID0gMDtcbiAgICAgICAgICAgICAgICAvLyBUb3AgUG9zaXRpb25cbiAgICAgICAgICAgICAgICB2YXIgbW9kYWxQb3NpdGlvbiA9IG1hdGVyaWFsID8gJ2JvdHRvbScgOiAndG9wJztcbiAgICAgICAgICAgICAgICBpZiAobWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGFsSGVpZ2h0IDwgd2luZG93SGVpZ2h0IC0gdGFyZ2V0T2Zmc2V0LnRvcCAtIHRhcmdldEhlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gT24gYm90dG9tXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbFBvc2l0aW9uID0gJ2JvdHRvbSc7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbFRvcCA9IHRhcmdldE9mZnNldC50b3A7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobW9kYWxIZWlnaHQgPCB0YXJnZXRPZmZzZXQudG9wKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBPbiB0b3BcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsVG9wID0gdGFyZ2V0T2Zmc2V0LnRvcCAtIG1vZGFsSGVpZ2h0ICsgdGFyZ2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxQb3NpdGlvbiA9ICd0b3AnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gT24gbWlkZGxlXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbFBvc2l0aW9uID0gJ2JvdHRvbSc7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbFRvcCA9IHRhcmdldE9mZnNldC50b3A7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChtb2RhbFRvcCA8PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbFRvcCA9IDg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobW9kYWxUb3AgKyBtb2RhbEhlaWdodCA+PSB3aW5kb3dIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsVG9wID0gd2luZG93SGVpZ2h0IC0gbW9kYWxIZWlnaHQgLSA4O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBIb3Jpem9udGFsIFBvc2l0aW9uXG4gICAgICAgICAgICAgICAgICAgIG1vZGFsTGVmdCA9IHRhcmdldE9mZnNldC5sZWZ0O1xuICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxMZWZ0ICsgbW9kYWxXaWR0aCA+PSB3aW5kb3dXaWR0aCAtIDgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsTGVmdCA9IHRhcmdldE9mZnNldC5sZWZ0ICsgdGFyZ2V0V2lkdGggLSBtb2RhbFdpZHRoIC0gODtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxMZWZ0IDwgOCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxMZWZ0ID0gODtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxQb3NpdGlvbiA9PT0gJ3RvcCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsLmFkZENsYXNzKCdwb3BvdmVyLW9uLXRvcCcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChtb2RhbFBvc2l0aW9uID09PSAnYm90dG9tJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWwuYWRkQ2xhc3MoJ3BvcG92ZXItb24tYm90dG9tJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldC5oYXNDbGFzcygnZmxvYXRpbmctYnV0dG9uLXRvLXBvcG92ZXInKSAmJiAhbW9kYWwuaGFzQ2xhc3MoJ21vZGFsLWluJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsLmFkZENsYXNzKCdwb3BvdmVyLWZsb2F0aW5nLWJ1dHRvbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRpZmZYID0gKG1vZGFsTGVmdCArIG1vZGFsV2lkdGggLyAyKSAtICh0YXJnZXRPZmZzZXQubGVmdCArIHRhcmdldFdpZHRoIC8gMiksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlmZlkgPSAobW9kYWxUb3AgKyBtb2RhbEhlaWdodCAvIDIpIC0gKHRhcmdldE9mZnNldC50b3AgKyB0YXJnZXRIZWlnaHQgLyAyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hZGRDbGFzcygnZmxvYXRpbmctYnV0dG9uLXRvLXBvcG92ZXItaW4nKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyBkaWZmWCArICdweCwgJyArIGRpZmZZICsgJ3B4LDApJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRhcmdldC5oYXNDbGFzcygnZmxvYXRpbmctYnV0dG9uLXRvLXBvcG92ZXItaW4nKSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hZGRDbGFzcygnZmxvYXRpbmctYnV0dG9uLXRvLXBvcG92ZXItc2NhbGUnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIGRpZmZYICsgJ3B4LCAnICsgZGlmZlkgKyAncHgsMCkgc2NhbGUoJyArIChtb2RhbFdpZHRoL3RhcmdldFdpZHRoKSArICcsICcgKyAobW9kYWxIZWlnaHQvdGFyZ2V0SGVpZ2h0KSArICcpJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWwub25jZSgnY2xvc2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZW1vdmVDbGFzcygnZmxvYXRpbmctYnV0dG9uLXRvLXBvcG92ZXItaW4gZmxvYXRpbmctYnV0dG9uLXRvLXBvcG92ZXItc2NhbGUnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ2Zsb2F0aW5nLWJ1dHRvbi10by1wb3BvdmVyLW91dCcpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50cmFuc2Zvcm0oJycpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQucmVtb3ZlQ2xhc3MoJ2Zsb2F0aW5nLWJ1dHRvbi10by1wb3BvdmVyLW91dCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWwub25jZSgnY2xvc2VkJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsLnJlbW92ZUNsYXNzKCdwb3BvdmVyLWZsb2F0aW5nLWJ1dHRvbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoKG1vZGFsSGVpZ2h0ICsgbW9kYWxBbmdsZVNpemUpIDwgdGFyZ2V0T2Zmc2V0LnRvcCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gT24gdG9wXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbFRvcCA9IHRhcmdldE9mZnNldC50b3AgLSBtb2RhbEhlaWdodCAtIG1vZGFsQW5nbGVTaXplO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKChtb2RhbEhlaWdodCArIG1vZGFsQW5nbGVTaXplKSA8IHdpbmRvd0hlaWdodCAtIHRhcmdldE9mZnNldC50b3AgLSB0YXJnZXRIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9uIGJvdHRvbVxuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxQb3NpdGlvbiA9ICdib3R0b20nO1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxUb3AgPSB0YXJnZXRPZmZzZXQudG9wICsgdGFyZ2V0SGVpZ2h0ICsgbW9kYWxBbmdsZVNpemU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBPbiBtaWRkbGVcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsUG9zaXRpb24gPSAnbWlkZGxlJztcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsVG9wID0gdGFyZ2V0SGVpZ2h0IC8gMiArIHRhcmdldE9mZnNldC50b3AgLSBtb2RhbEhlaWdodCAvIDI7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaWZmID0gbW9kYWxUb3A7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxUb3AgPD0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsVG9wID0gNTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1vZGFsVG9wICsgbW9kYWxIZWlnaHQgPj0gd2luZG93SGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxUb3AgPSB3aW5kb3dIZWlnaHQgLSBtb2RhbEhlaWdodCAtIDU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBkaWZmID0gZGlmZiAtIG1vZGFsVG9wO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBIb3Jpem9udGFsIFBvc2l0aW9uXG4gICAgICAgICAgICAgICAgICAgIGlmIChtb2RhbFBvc2l0aW9uID09PSAndG9wJyB8fCBtb2RhbFBvc2l0aW9uID09PSAnYm90dG9tJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWxMZWZ0ID0gdGFyZ2V0V2lkdGggLyAyICsgdGFyZ2V0T2Zmc2V0LmxlZnQgLSBtb2RhbFdpZHRoIC8gMjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmYgPSBtb2RhbExlZnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxMZWZ0IDwgNSkgbW9kYWxMZWZ0ID0gNTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2RhbExlZnQgKyBtb2RhbFdpZHRoID4gd2luZG93V2lkdGgpIG1vZGFsTGVmdCA9IHdpbmRvd1dpZHRoIC0gbW9kYWxXaWR0aCAtIDU7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxQb3NpdGlvbiA9PT0gJ3RvcCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RhbEFuZ2xlLmFkZENsYXNzKCdvbi1ib3R0b20nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2RhbFBvc2l0aW9uID09PSAnYm90dG9tJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsQW5nbGUuYWRkQ2xhc3MoJ29uLXRvcCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZGlmZiA9IGRpZmYgLSBtb2RhbExlZnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbEFuZ2xlTGVmdCA9IChtb2RhbFdpZHRoIC8gMiAtIG1vZGFsQW5nbGVTaXplICsgZGlmZik7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbEFuZ2xlTGVmdCA9IE1hdGgubWF4KE1hdGgubWluKG1vZGFsQW5nbGVMZWZ0LCBtb2RhbFdpZHRoIC0gbW9kYWxBbmdsZVNpemUgKiAyIC0gMTMpLCAxMyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbEFuZ2xlLmNzcyh7bGVmdDogbW9kYWxBbmdsZUxlZnQgKyAncHgnfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG1vZGFsUG9zaXRpb24gPT09ICdtaWRkbGUnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbExlZnQgPSB0YXJnZXRPZmZzZXQubGVmdCAtIG1vZGFsV2lkdGggLSBtb2RhbEFuZ2xlU2l6ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsQW5nbGUuYWRkQ2xhc3MoJ29uLXJpZ2h0Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobW9kYWxMZWZ0IDwgNSB8fCAobW9kYWxMZWZ0ICsgbW9kYWxXaWR0aCA+IHdpbmRvd1dpZHRoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2RhbExlZnQgPCA1KSBtb2RhbExlZnQgPSB0YXJnZXRPZmZzZXQubGVmdCArIHRhcmdldFdpZHRoICsgbW9kYWxBbmdsZVNpemU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGFsTGVmdCArIG1vZGFsV2lkdGggPiB3aW5kb3dXaWR0aCkgbW9kYWxMZWZ0ID0gd2luZG93V2lkdGggLSBtb2RhbFdpZHRoIC0gNTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RhbEFuZ2xlLnJlbW92ZUNsYXNzKCdvbi1yaWdodCcpLmFkZENsYXNzKCdvbi1sZWZ0Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbEFuZ2xlVG9wID0gKG1vZGFsSGVpZ2h0IC8gMiAtIG1vZGFsQW5nbGVTaXplICsgZGlmZik7XG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RhbEFuZ2xlVG9wID0gTWF0aC5tYXgoTWF0aC5taW4obW9kYWxBbmdsZVRvcCwgbW9kYWxIZWlnaHQgLSBtb2RhbEFuZ2xlU2l6ZSAqIDIgLSAxMyksIDEzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsQW5nbGUuY3NzKHt0b3A6IG1vZGFsQW5nbGVUb3AgKyAncHgnfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBBcHBseSBTdHlsZXNcbiAgICAgICAgICAgICAgICBtb2RhbC5jc3Moe3RvcDogbW9kYWxUb3AgKyAncHgnLCBsZWZ0OiBtb2RhbExlZnQgKyAncHgnfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgc2l6ZVBvcG92ZXIoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAkKHdpbmRvdykub24oJ3Jlc2l6ZScsIHNpemVQb3BvdmVyKTtcbiAgICAgICAgXG4gICAgICAgICAgICBtb2RhbC5vbignY2xvc2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgJCh3aW5kb3cpLm9mZigncmVzaXplJywgc2l6ZVBvcG92ZXIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgYXBwLm9wZW5Nb2RhbChtb2RhbCk7XG4gICAgICAgICAgICByZXR1cm4gbW9kYWxbMF07XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5wb3B1cCA9IGZ1bmN0aW9uIChtb2RhbCwgcmVtb3ZlT25DbG9zZSkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiByZW1vdmVPbkNsb3NlID09PSAndW5kZWZpbmVkJykgcmVtb3ZlT25DbG9zZSA9IHRydWU7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG1vZGFsID09PSAnc3RyaW5nJyAmJiBtb2RhbC5pbmRleE9mKCc8JykgPj0gMCkge1xuICAgICAgICAgICAgICAgIHZhciBfbW9kYWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgICAgICAgICBfbW9kYWwuaW5uZXJIVE1MID0gbW9kYWwudHJpbSgpO1xuICAgICAgICAgICAgICAgIGlmIChfbW9kYWwuY2hpbGROb2Rlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG1vZGFsID0gX21vZGFsLmNoaWxkTm9kZXNbMF07XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZW1vdmVPbkNsb3NlKSBtb2RhbC5jbGFzc0xpc3QuYWRkKCdyZW1vdmUtb24tY2xvc2UnKTtcbiAgICAgICAgICAgICAgICAgICAgJCgnYm9keScpLmFwcGVuZChtb2RhbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIGZhbHNlOyAvL25vdGhpbmcgZm91bmRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1vZGFsID0gJChtb2RhbCk7XG4gICAgICAgICAgICBpZiAobW9kYWwubGVuZ3RoID09PSAwKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICBpZiAobW9kYWwucGFyZW50cygnYm9keScpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGlmIChyZW1vdmVPbkNsb3NlKSBtb2RhbC5hZGRDbGFzcygncmVtb3ZlLW9uLWNsb3NlJyk7XG4gICAgICAgICAgICAgICAgJCgnYm9keScpLmFwcGVuZChtb2RhbFswXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtb2RhbC5zaG93KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgYXBwLm9wZW5Nb2RhbChtb2RhbCk7XG4gICAgICAgICAgICByZXR1cm4gbW9kYWxbMF07XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5waWNrZXJNb2RhbCA9IGZ1bmN0aW9uIChtb2RhbCwgcmVtb3ZlT25DbG9zZSkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiByZW1vdmVPbkNsb3NlID09PSAndW5kZWZpbmVkJykgcmVtb3ZlT25DbG9zZSA9IHRydWU7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG1vZGFsID09PSAnc3RyaW5nJyAmJiBtb2RhbC5pbmRleE9mKCc8JykgPj0gMCkge1xuICAgICAgICAgICAgICAgIG1vZGFsID0gJChtb2RhbCk7XG4gICAgICAgICAgICAgICAgaWYgKG1vZGFsLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbW92ZU9uQ2xvc2UpIG1vZGFsLmFkZENsYXNzKCdyZW1vdmUtb24tY2xvc2UnKTtcbiAgICAgICAgICAgICAgICAgICAgJCgnYm9keScpLmFwcGVuZChtb2RhbFswXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIGZhbHNlOyAvL25vdGhpbmcgZm91bmRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1vZGFsID0gJChtb2RhbCk7XG4gICAgICAgICAgICBpZiAobW9kYWwubGVuZ3RoID09PSAwKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICBpZiAobW9kYWwucGFyZW50cygnYm9keScpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGlmIChyZW1vdmVPbkNsb3NlKSBtb2RhbC5hZGRDbGFzcygncmVtb3ZlLW9uLWNsb3NlJyk7XG4gICAgICAgICAgICAgICAgJCgnYm9keScpLmFwcGVuZChtb2RhbFswXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoJCgnLnBpY2tlci1tb2RhbC5tb2RhbC1pbjpub3QoLm1vZGFsLW91dCknKS5sZW5ndGggPiAwICYmICFtb2RhbC5oYXNDbGFzcygnbW9kYWwtaW4nKSkge1xuICAgICAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKCcucGlja2VyLW1vZGFsLm1vZGFsLWluOm5vdCgubW9kYWwtb3V0KScpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbW9kYWwuc2hvdygpO1xuICAgICAgICAgICAgYXBwLm9wZW5Nb2RhbChtb2RhbCk7XG4gICAgICAgICAgICByZXR1cm4gbW9kYWxbMF07XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5sb2dpblNjcmVlbiA9IGZ1bmN0aW9uIChtb2RhbCkge1xuICAgICAgICAgICAgaWYgKCFtb2RhbCkgbW9kYWwgPSAnLmxvZ2luLXNjcmVlbic7XG4gICAgICAgICAgICBtb2RhbCA9ICQobW9kYWwpO1xuICAgICAgICAgICAgaWYgKG1vZGFsLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgaWYgKCQoJy5sb2dpbi1zY3JlZW4ubW9kYWwtaW46bm90KC5tb2RhbC1vdXQpJykubGVuZ3RoID4gMCAmJiAhbW9kYWwuaGFzQ2xhc3MoJ21vZGFsLWluJykpIHtcbiAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbCgnLmxvZ2luLXNjcmVlbi5tb2RhbC1pbjpub3QoLm1vZGFsLW91dCknKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1vZGFsLnNob3coKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgYXBwLm9wZW5Nb2RhbChtb2RhbCk7XG4gICAgICAgICAgICByZXR1cm4gbW9kYWxbMF07XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5vcGVuTW9kYWwgPSBmdW5jdGlvbiAobW9kYWwpIHtcbiAgICAgICAgICAgIG1vZGFsID0gJChtb2RhbCk7XG4gICAgICAgICAgICB2YXIgaXNNb2RhbCA9IG1vZGFsLmhhc0NsYXNzKCdtb2RhbCcpO1xuICAgICAgICAgICAgaWYgKCQoJy5tb2RhbC5tb2RhbC1pbjpub3QoLm1vZGFsLW91dCknKS5sZW5ndGggJiYgYXBwLnBhcmFtcy5tb2RhbFN0YWNrICYmIGlzTW9kYWwpIHtcbiAgICAgICAgICAgICAgICBhcHAubW9kYWxTdGFjay5wdXNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLm9wZW5Nb2RhbChtb2RhbCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gZG8gbm90aGluZyBpZiB0aGlzIG1vZGFsIGFscmVhZHkgc2hvd25cbiAgICAgICAgICAgIGlmICh0cnVlID09PSBtb2RhbC5kYXRhKCdmNy1tb2RhbC1zaG93bicpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbW9kYWwuZGF0YSgnZjctbW9kYWwtc2hvd24nLCB0cnVlKTtcbiAgICAgICAgICAgIG1vZGFsLm9uY2UoJ2Nsb3NlJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICBtb2RhbC5yZW1vdmVEYXRhKCdmNy1tb2RhbC1zaG93bicpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB2YXIgaXNQb3BvdmVyID0gbW9kYWwuaGFzQ2xhc3MoJ3BvcG92ZXInKTtcbiAgICAgICAgICAgIHZhciBpc1BvcHVwID0gbW9kYWwuaGFzQ2xhc3MoJ3BvcHVwJyk7XG4gICAgICAgICAgICB2YXIgaXNMb2dpblNjcmVlbiA9IG1vZGFsLmhhc0NsYXNzKCdsb2dpbi1zY3JlZW4nKTtcbiAgICAgICAgICAgIHZhciBpc1BpY2tlck1vZGFsID0gbW9kYWwuaGFzQ2xhc3MoJ3BpY2tlci1tb2RhbCcpO1xuICAgICAgICAgICAgaWYgKGlzTW9kYWwpIHtcbiAgICAgICAgICAgICAgICBtb2RhbC5zaG93KCk7XG4gICAgICAgICAgICAgICAgbW9kYWwuY3NzKHtcbiAgICAgICAgICAgICAgICAgICAgbWFyZ2luVG9wOiAtIE1hdGgucm91bmQobW9kYWwub3V0ZXJIZWlnaHQoKSAvIDIpICsgJ3B4J1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIHZhciBvdmVybGF5O1xuICAgICAgICAgICAgaWYgKCFpc0xvZ2luU2NyZWVuICYmICFpc1BpY2tlck1vZGFsKSB7XG4gICAgICAgICAgICAgICAgaWYgKCQoJy5tb2RhbC1vdmVybGF5JykubGVuZ3RoID09PSAwICYmICFpc1BvcHVwKSB7XG4gICAgICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hcHBlbmQoJzxkaXYgY2xhc3M9XCJtb2RhbC1vdmVybGF5XCI+PC9kaXY+Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICgkKCcucG9wdXAtb3ZlcmxheScpLmxlbmd0aCA9PT0gMCAmJiBpc1BvcHVwKSB7XG4gICAgICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hcHBlbmQoJzxkaXYgY2xhc3M9XCJwb3B1cC1vdmVybGF5XCI+PC9kaXY+Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG92ZXJsYXkgPSBpc1BvcHVwID8gJCgnLnBvcHVwLW92ZXJsYXknKSA6ICQoJy5tb2RhbC1vdmVybGF5Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBpc1BpY2tlck1vZGFsKSB7XG4gICAgICAgICAgICAgICAgaWYgKG1vZGFsLmhhc0NsYXNzKCdwaWNrZXItY2FsZW5kYXInKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLnBpY2tlci1tb2RhbC1vdmVybGF5JykubGVuZ3RoID09PSAwICYmICFpc1BvcHVwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKCc8ZGl2IGNsYXNzPVwicGlja2VyLW1vZGFsLW92ZXJsYXlcIj48L2Rpdj4nKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBvdmVybGF5ID0gJCgnLnBpY2tlci1tb2RhbC1vdmVybGF5Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vTWFrZSBzdXJlIHRoYXQgc3R5bGVzIGFyZSBhcHBsaWVkLCB0cmlnZ2VyIHJlbGF5b3V0O1xuICAgICAgICAgICAgdmFyIGNsaWVudExlZnQgPSBtb2RhbFswXS5jbGllbnRMZWZ0O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFRydWdnZXIgb3BlbiBldmVudFxuICAgICAgICAgICAgbW9kYWwudHJpZ2dlcignb3BlbicpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBpY2tlciBtb2RhbCBib2R5IGNsYXNzXG4gICAgICAgICAgICBpZiAoaXNQaWNrZXJNb2RhbCkge1xuICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hZGRDbGFzcygnd2l0aC1waWNrZXItbW9kYWwnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0IFBhZ2VzIGFuZCBOYXZiYXJzIGluIG1vZGFsXG4gICAgICAgICAgICBpZiAobW9kYWwuZmluZCgnLicgKyBhcHAucGFyYW1zLnZpZXdDbGFzcykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIG1vZGFsLmZpbmQoJy5wYWdlJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5pbml0UGFnZVdpdGhDYWxsYmFjayh0aGlzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBtb2RhbC5maW5kKCcubmF2YmFyJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5pbml0TmF2YmFyV2l0aENhbGxiYWNrKHRoaXMpOyBcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDbGFzc2VzIGZvciB0cmFuc2l0aW9uIGluXG4gICAgICAgICAgICBpZiAoIWlzTG9naW5TY3JlZW4gJiYgIWlzUGlja2VyTW9kYWwpIG92ZXJsYXkuYWRkQ2xhc3MoJ21vZGFsLW92ZXJsYXktdmlzaWJsZScpO1xuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwgJiYgaXNQaWNrZXJNb2RhbCAmJiBvdmVybGF5KSBvdmVybGF5LmFkZENsYXNzKCdtb2RhbC1vdmVybGF5LXZpc2libGUnKTtcbiAgICAgICAgICAgIG1vZGFsLnJlbW92ZUNsYXNzKCdtb2RhbC1vdXQnKS5hZGRDbGFzcygnbW9kYWwtaW4nKS50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKG1vZGFsLmhhc0NsYXNzKCdtb2RhbC1vdXQnKSkgbW9kYWwudHJpZ2dlcignY2xvc2VkJyk7XG4gICAgICAgICAgICAgICAgZWxzZSBtb2RhbC50cmlnZ2VyKCdvcGVuZWQnKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5jbG9zZU1vZGFsID0gZnVuY3Rpb24gKG1vZGFsKSB7XG4gICAgICAgICAgICBtb2RhbCA9ICQobW9kYWwgfHwgJy5tb2RhbC1pbicpO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBtb2RhbCAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kYWwubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIGlzTW9kYWwgPSBtb2RhbC5oYXNDbGFzcygnbW9kYWwnKTtcbiAgICAgICAgICAgIHZhciBpc1BvcG92ZXIgPSBtb2RhbC5oYXNDbGFzcygncG9wb3ZlcicpO1xuICAgICAgICAgICAgdmFyIGlzUG9wdXAgPSBtb2RhbC5oYXNDbGFzcygncG9wdXAnKTtcbiAgICAgICAgICAgIHZhciBpc0xvZ2luU2NyZWVuID0gbW9kYWwuaGFzQ2xhc3MoJ2xvZ2luLXNjcmVlbicpO1xuICAgICAgICAgICAgdmFyIGlzUGlja2VyTW9kYWwgPSBtb2RhbC5oYXNDbGFzcygncGlja2VyLW1vZGFsJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHJlbW92ZU9uQ2xvc2UgPSBtb2RhbC5oYXNDbGFzcygncmVtb3ZlLW9uLWNsb3NlJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIG92ZXJsYXk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChpc1BvcHVwKSBvdmVybGF5ID0gJCgnLnBvcHVwLW92ZXJsYXknKTtcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChpc1BpY2tlck1vZGFsICYmIGFwcC5wYXJhbXMubWF0ZXJpYWwpIG92ZXJsYXkgPSAkKCcucGlja2VyLW1vZGFsLW92ZXJsYXknKTtcbiAgICAgICAgICAgICAgICBlbHNlIGlmICghaXNQaWNrZXJNb2RhbCkgb3ZlcmxheSA9ICQoJy5tb2RhbC1vdmVybGF5Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKGlzUG9wdXApe1xuICAgICAgICAgICAgICAgIGlmIChtb2RhbC5sZW5ndGggPT09ICQoJy5wb3B1cC5tb2RhbC1pbicpLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBvdmVybGF5LnJlbW92ZUNsYXNzKCdtb2RhbC1vdmVybGF5LXZpc2libGUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChvdmVybGF5ICYmIG92ZXJsYXkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIG92ZXJsYXkucmVtb3ZlQ2xhc3MoJ21vZGFsLW92ZXJsYXktdmlzaWJsZScpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIG1vZGFsLnRyaWdnZXIoJ2Nsb3NlJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUGlja2VyIG1vZGFsIGJvZHkgY2xhc3NcbiAgICAgICAgICAgIGlmIChpc1BpY2tlck1vZGFsKSB7XG4gICAgICAgICAgICAgICAgJCgnYm9keScpLnJlbW92ZUNsYXNzKCd3aXRoLXBpY2tlci1tb2RhbCcpO1xuICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hZGRDbGFzcygncGlja2VyLW1vZGFsLWNsb3NpbmcnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoIShpc1BvcG92ZXIgJiYgIWFwcC5wYXJhbXMubWF0ZXJpYWwpKSB7XG4gICAgICAgICAgICAgICAgbW9kYWwucmVtb3ZlQ2xhc3MoJ21vZGFsLWluJykuYWRkQ2xhc3MoJ21vZGFsLW91dCcpLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGFsLmhhc0NsYXNzKCdtb2RhbC1vdXQnKSkgbW9kYWwudHJpZ2dlcignY2xvc2VkJyk7XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWwudHJpZ2dlcignb3BlbmVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNQb3BvdmVyKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChpc1BpY2tlck1vZGFsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKCdib2R5JykucmVtb3ZlQ2xhc3MoJ3BpY2tlci1tb2RhbC1jbG9zaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzUG9wdXAgfHwgaXNMb2dpblNjcmVlbiB8fCBpc1BpY2tlck1vZGFsIHx8IGlzUG9wb3Zlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbW9kYWwucmVtb3ZlQ2xhc3MoJ21vZGFsLW91dCcpLmhpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZW1vdmVPbkNsb3NlICYmIG1vZGFsLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtb2RhbC5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1vZGFsLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaWYgKGlzTW9kYWwgJiYgYXBwLnBhcmFtcy5tb2RhbFN0YWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5tb2RhbFN0YWNrQ2xlYXJRdWV1ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIG1vZGFsLnJlbW92ZUNsYXNzKCdtb2RhbC1pbiBtb2RhbC1vdXQnKS50cmlnZ2VyKCdjbG9zZWQnKS5oaWRlKCk7XG4gICAgICAgICAgICAgICAgaWYgKHJlbW92ZU9uQ2xvc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgbW9kYWwucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBQcm9ncmVzcyBCYXIgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5zZXRQcm9ncmVzc2JhciA9IGZ1bmN0aW9uIChjb250YWluZXIsIHByb2dyZXNzLCBzcGVlZCkge1xuICAgICAgICAgICAgY29udGFpbmVyID0gJChjb250YWluZXIgfHwgJ2JvZHknKTtcbiAgICAgICAgICAgIGlmIChjb250YWluZXIubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBpZiAocHJvZ3Jlc3MpIHByb2dyZXNzID0gTWF0aC5taW4oTWF0aC5tYXgocHJvZ3Jlc3MsIDApLCAxMDApO1xuICAgICAgICAgICAgdmFyIHByb2dyZXNzYmFyO1xuICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5oYXNDbGFzcygncHJvZ3Jlc3NiYXInKSkgcHJvZ3Jlc3NiYXIgPSBjb250YWluZXI7XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBwcm9ncmVzc2JhciA9IGNvbnRhaW5lci5jaGlsZHJlbignLnByb2dyZXNzYmFyJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocHJvZ3Jlc3NiYXIubGVuZ3RoID09PSAwIHx8IHByb2dyZXNzYmFyLmhhc0NsYXNzKCdwcm9ncmVzc2Jhci1pbmZpbml0ZScpKSByZXR1cm47XG4gICAgICAgICAgICB2YXIgY2xpZW50TGVmdCA9IHByb2dyZXNzYmFyWzBdLmNsaWVudExlZnQ7XG4gICAgICAgICAgICBwcm9ncmVzc2Jhci5jaGlsZHJlbignc3BhbicpLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArICgtMTAwICsgcHJvZ3Jlc3MpICsgJyUsMCwwKScpO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBzcGVlZCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBwcm9ncmVzc2Jhci5jaGlsZHJlbignc3BhbicpLnRyYW5zaXRpb24oc3BlZWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcHJvZ3Jlc3NiYXIuY2hpbGRyZW4oJ3NwYW4nKS50cmFuc2l0aW9uKCcnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwcm9ncmVzc2JhclswXTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnNob3dQcm9ncmVzc2JhciA9IGZ1bmN0aW9uIChjb250YWluZXIsIHByb2dyZXNzLCBjb2xvcikge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBjb250YWluZXIgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyID0gJ2JvZHknO1xuICAgICAgICAgICAgICAgIHByb2dyZXNzID0gYXJndW1lbnRzWzBdO1xuICAgICAgICAgICAgICAgIGNvbG9yID0gYXJndW1lbnRzWzFdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHByb2dyZXNzICYmIHR5cGVvZiBwcm9ncmVzcyA9PT0gJ3N0cmluZycgJiYgcGFyc2VGbG9hdChwcm9ncmVzcykgIT09IHByb2dyZXNzICogMSkge1xuICAgICAgICAgICAgICAgIGNvbG9yID0gcHJvZ3Jlc3M7XG4gICAgICAgICAgICAgICAgcHJvZ3Jlc3MgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb250YWluZXIgPSAkKGNvbnRhaW5lciB8fCAnYm9keScpO1xuICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIHZhciBwcm9ncmVzc2JhcjtcbiAgICAgICAgICAgIGlmIChjb250YWluZXIuaGFzQ2xhc3MoJ3Byb2dyZXNzYmFyJykpIHByb2dyZXNzYmFyID0gY29udGFpbmVyO1xuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcHJvZ3Jlc3NiYXIgPSBjb250YWluZXIuY2hpbGRyZW4oJy5wcm9ncmVzc2Jhcjpub3QoLnByb2dyZXNzYmFyLW91dCksIC5wcm9ncmVzc2Jhci1pbmZpbml0ZTpub3QoLnByb2dyZXNzYmFyLW91dCknKTtcbiAgICAgICAgICAgICAgICBpZiAocHJvZ3Jlc3NiYXIubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBvbmVcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9ncmVzcyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERldGVybWluZWRcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzYmFyID0gJCgnPHNwYW4gY2xhc3M9XCJwcm9ncmVzc2JhciBwcm9ncmVzc2Jhci1pbicgKyAoY29sb3IgPyAnIGNvbG9yLScgKyBjb2xvciA6ICcnKSArICdcIj48c3Bhbj48L3NwYW4+PC9zcGFuPicpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW5maW5pdGVcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzYmFyID0gJCgnPHNwYW4gY2xhc3M9XCJwcm9ncmVzc2Jhci1pbmZpbml0ZSBwcm9ncmVzc2Jhci1pbicgKyAoY29sb3IgPyAnIGNvbG9yLScgKyBjb2xvciA6ICcnKSArICdcIj48L3NwYW4+Jyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZChwcm9ncmVzc2Jhcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHByb2dyZXNzKSBhcHAuc2V0UHJvZ3Jlc3NiYXIoY29udGFpbmVyLCBwcm9ncmVzcyk7XG4gICAgICAgICAgICByZXR1cm4gcHJvZ3Jlc3NiYXJbMF07XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5oaWRlUHJvZ3Jlc3NiYXIgPSBmdW5jdGlvbiAoY29udGFpbmVyKSB7XG4gICAgICAgICAgICBjb250YWluZXIgPSAkKGNvbnRhaW5lciB8fCAnYm9keScpO1xuICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIHZhciBwcm9ncmVzc2JhcjtcbiAgICAgICAgICAgIGlmIChjb250YWluZXIuaGFzQ2xhc3MoJ3Byb2dyZXNzYmFyJykpIHByb2dyZXNzYmFyID0gY29udGFpbmVyO1xuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcHJvZ3Jlc3NiYXIgPSBjb250YWluZXIuY2hpbGRyZW4oJy5wcm9ncmVzc2JhciwgLnByb2dyZXNzYmFyLWluZmluaXRlJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocHJvZ3Jlc3NiYXIubGVuZ3RoID09PSAwIHx8ICFwcm9ncmVzc2Jhci5oYXNDbGFzcygncHJvZ3Jlc3NiYXItaW4nKSB8fCBwcm9ncmVzc2Jhci5oYXNDbGFzcygncHJvZ3Jlc3NiYXItb3V0JykpIHJldHVybjtcbiAgICAgICAgICAgIHByb2dyZXNzYmFyLnJlbW92ZUNsYXNzKCdwcm9ncmVzc2Jhci1pbicpLmFkZENsYXNzKCdwcm9ncmVzc2Jhci1vdXQnKS5hbmltYXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHByb2dyZXNzYmFyLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgIHByb2dyZXNzYmFyID0gbnVsbDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuaW5pdFBhZ2VQcm9ncmVzc2JhciA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIuZmluZCgnLnByb2dyZXNzYmFyJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIHAgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgIGlmIChwLmNoaWxkcmVuKCdzcGFuJykubGVuZ3RoID09PSAwKSBwLmFwcGVuZCgnPHNwYW4+PC9zcGFuPicpO1xuICAgICAgICAgICAgICAgIGlmIChwLmF0dHIoJ2RhdGEtcHJvZ3Jlc3MnKSkgYXBwLnNldFByb2dyZXNzYmFyKHAsIHAuYXR0cignZGF0YS1wcm9ncmVzcycpKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIFBhbmVscyAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAuYWxsb3dQYW5lbE9wZW4gPSB0cnVlO1xuICAgICAgICBhcHAub3BlblBhbmVsID0gZnVuY3Rpb24gKHBhbmVsUG9zaXRpb24pIHtcbiAgICAgICAgICAgIGlmICghYXBwLmFsbG93UGFuZWxPcGVuKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB2YXIgcGFuZWwgPSAkKCcucGFuZWwtJyArIHBhbmVsUG9zaXRpb24pO1xuICAgICAgICAgICAgaWYgKHBhbmVsLmxlbmd0aCA9PT0gMCB8fCBwYW5lbC5oYXNDbGFzcygnYWN0aXZlJykpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIGFwcC5jbG9zZVBhbmVsKCk7IC8vIENsb3NlIGlmIHNvbWUgcGFuZWwgaXMgb3BlbmVkXG4gICAgICAgICAgICBhcHAuYWxsb3dQYW5lbE9wZW4gPSBmYWxzZTtcbiAgICAgICAgICAgIHZhciBlZmZlY3QgPSBwYW5lbC5oYXNDbGFzcygncGFuZWwtcmV2ZWFsJykgPyAncmV2ZWFsJyA6ICdjb3Zlcic7XG4gICAgICAgICAgICBwYW5lbC5jc3Moe2Rpc3BsYXk6ICdibG9jayd9KS5hZGRDbGFzcygnYWN0aXZlJyk7XG4gICAgICAgICAgICBwYW5lbC50cmlnZ2VyKCdvcGVuJyk7XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCkge1xuICAgICAgICAgICAgICAgICQoJy5wYW5lbC1vdmVybGF5Jykuc2hvdygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHBhbmVsLmZpbmQoJy4nICsgYXBwLnBhcmFtcy52aWV3Q2xhc3MpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnNpemVOYXZiYXJzKSBhcHAuc2l6ZU5hdmJhcnMocGFuZWwuZmluZCgnLicgKyBhcHAucGFyYW1zLnZpZXdDbGFzcylbMF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFRyaWdnZXIgcmVMYXlvdXRcbiAgICAgICAgICAgIHZhciBjbGllbnRMZWZ0ID0gcGFuZWxbMF0uY2xpZW50TGVmdDtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gVHJhbnNpdGlvbiBFbmQ7XG4gICAgICAgICAgICB2YXIgdHJhbnNpdGlvbkVuZFRhcmdldCA9IGVmZmVjdCA9PT0gJ3JldmVhbCcgPyAkKCcuJyArIGFwcC5wYXJhbXMudmlld3NDbGFzcykgOiBwYW5lbDtcbiAgICAgICAgICAgIHZhciBvcGVuZWRUcmlnZ2VyZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZnVuY3Rpb24gcGFuZWxUcmFuc2l0aW9uRW5kKCkge1xuICAgICAgICAgICAgICAgIHRyYW5zaXRpb25FbmRUYXJnZXQudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoJChlLnRhcmdldCkuaXModHJhbnNpdGlvbkVuZFRhcmdldCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYW5lbC5oYXNDbGFzcygnYWN0aXZlJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYW5lbC50cmlnZ2VyKCdvcGVuZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhbmVsLnRyaWdnZXIoJ2Nsb3NlZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwpICQoJy5wYW5lbC1vdmVybGF5JykuY3NzKHtkaXNwbGF5OiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmFsbG93UGFuZWxPcGVuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHBhbmVsVHJhbnNpdGlvbkVuZCgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGFuZWxUcmFuc2l0aW9uRW5kKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgJCgnYm9keScpLmFkZENsYXNzKCd3aXRoLXBhbmVsLScgKyBwYW5lbFBvc2l0aW9uICsgJy0nICsgZWZmZWN0KTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuY2xvc2VQYW5lbCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBhY3RpdmVQYW5lbCA9ICQoJy5wYW5lbC5hY3RpdmUnKTtcbiAgICAgICAgICAgIGlmIChhY3RpdmVQYW5lbC5sZW5ndGggPT09IDApIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIHZhciBlZmZlY3QgPSBhY3RpdmVQYW5lbC5oYXNDbGFzcygncGFuZWwtcmV2ZWFsJykgPyAncmV2ZWFsJyA6ICdjb3Zlcic7XG4gICAgICAgICAgICB2YXIgcGFuZWxQb3NpdGlvbiA9IGFjdGl2ZVBhbmVsLmhhc0NsYXNzKCdwYW5lbC1sZWZ0JykgPyAnbGVmdCcgOiAncmlnaHQnO1xuICAgICAgICAgICAgYWN0aXZlUGFuZWwucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpO1xuICAgICAgICAgICAgdmFyIHRyYW5zaXRpb25FbmRUYXJnZXQgPSBlZmZlY3QgPT09ICdyZXZlYWwnID8gJCgnLicgKyBhcHAucGFyYW1zLnZpZXdzQ2xhc3MpIDogYWN0aXZlUGFuZWw7XG4gICAgICAgICAgICBhY3RpdmVQYW5lbC50cmlnZ2VyKCdjbG9zZScpO1xuICAgICAgICAgICAgYXBwLmFsbG93UGFuZWxPcGVuID0gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAgICAgdHJhbnNpdGlvbkVuZFRhcmdldC50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoYWN0aXZlUGFuZWwuaGFzQ2xhc3MoJ2FjdGl2ZScpKSByZXR1cm47XG4gICAgICAgICAgICAgICAgYWN0aXZlUGFuZWwuY3NzKHtkaXNwbGF5OiAnJ30pO1xuICAgICAgICAgICAgICAgIGFjdGl2ZVBhbmVsLnRyaWdnZXIoJ2Nsb3NlZCcpO1xuICAgICAgICAgICAgICAgICQoJ2JvZHknKS5yZW1vdmVDbGFzcygncGFuZWwtY2xvc2luZycpO1xuICAgICAgICAgICAgICAgIGFwcC5hbGxvd1BhbmVsT3BlbiA9IHRydWU7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAkKCdib2R5JykuYWRkQ2xhc3MoJ3BhbmVsLWNsb3NpbmcnKS5yZW1vdmVDbGFzcygnd2l0aC1wYW5lbC0nICsgcGFuZWxQb3NpdGlvbiArICctJyArIGVmZmVjdCk7XG4gICAgICAgIH07XG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIFN3aXBlIHBhbmVscyAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAuaW5pdFN3aXBlUGFuZWxzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIHBhbmVsLCBzaWRlO1xuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuc3dpcGVQYW5lbCkge1xuICAgICAgICAgICAgICAgIHBhbmVsID0gJCgnLnBhbmVsLnBhbmVsLScgKyBhcHAucGFyYW1zLnN3aXBlUGFuZWwpO1xuICAgICAgICAgICAgICAgIHNpZGUgPSBhcHAucGFyYW1zLnN3aXBlUGFuZWw7XG4gICAgICAgICAgICAgICAgaWYgKHBhbmVsLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuc3dpcGVQYW5lbE9ubHlDbG9zZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLnBhbmVsJykubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICB2YXIgcGFuZWxPdmVybGF5ID0gJCgnLnBhbmVsLW92ZXJsYXknKTtcbiAgICAgICAgICAgIHZhciBpc1RvdWNoZWQsIGlzTW92ZWQsIGlzU2Nyb2xsaW5nLCB0b3VjaGVzU3RhcnQgPSB7fSwgdG91Y2hTdGFydFRpbWUsIHRvdWNoZXNEaWZmLCB0cmFuc2xhdGUsIG92ZXJsYXlPcGFjaXR5LCBvcGVuZWQsIHBhbmVsV2lkdGgsIGVmZmVjdCwgZGlyZWN0aW9uO1xuICAgICAgICAgICAgdmFyIHZpZXdzID0gJCgnLicgKyBhcHAucGFyYW1zLnZpZXdzQ2xhc3MpO1xuICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoZSkge1xuICAgICAgICAgICAgICAgIGlmICghYXBwLmFsbG93UGFuZWxPcGVuIHx8ICghYXBwLnBhcmFtcy5zd2lwZVBhbmVsICYmICFhcHAucGFyYW1zLnN3aXBlUGFuZWxPbmx5Q2xvc2UpIHx8IGlzVG91Y2hlZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmICgkKCcubW9kYWwtaW4sIC5waG90by1icm93c2VyLWluJykubGVuZ3RoID4gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmICghKGFwcC5wYXJhbXMuc3dpcGVQYW5lbENsb3NlT3Bwb3NpdGUgfHwgYXBwLnBhcmFtcy5zd2lwZVBhbmVsT25seUNsb3NlKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLnBhbmVsLmFjdGl2ZScpLmxlbmd0aCA+IDAgJiYgIXBhbmVsLmhhc0NsYXNzKCdhY3RpdmUnKSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0b3VjaGVzU3RhcnQueCA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZS5wYWdlWDtcbiAgICAgICAgICAgICAgICB0b3VjaGVzU3RhcnQueSA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5zd2lwZVBhbmVsQ2xvc2VPcHBvc2l0ZSB8fCBhcHAucGFyYW1zLnN3aXBlUGFuZWxPbmx5Q2xvc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQoJy5wYW5lbC5hY3RpdmUnKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzaWRlID0gJCgnLnBhbmVsLmFjdGl2ZScpLmhhc0NsYXNzKCdwYW5lbC1sZWZ0JykgPyAnbGVmdCcgOiAncmlnaHQnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuc3dpcGVQYW5lbE9ubHlDbG9zZSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgc2lkZSA9IGFwcC5wYXJhbXMuc3dpcGVQYW5lbDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIXNpZGUpIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcGFuZWwgPSAkKCcucGFuZWwucGFuZWwtJyArIHNpZGUpO1xuICAgICAgICAgICAgICAgIG9wZW5lZCA9IHBhbmVsLmhhc0NsYXNzKCdhY3RpdmUnKTtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5zd2lwZVBhbmVsQWN0aXZlQXJlYSAmJiAhb3BlbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzaWRlID09PSAnbGVmdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b3VjaGVzU3RhcnQueCA+IGFwcC5wYXJhbXMuc3dpcGVQYW5lbEFjdGl2ZUFyZWEpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoc2lkZSA9PT0gJ3JpZ2h0Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRvdWNoZXNTdGFydC54IDwgd2luZG93LmlubmVyV2lkdGggLSBhcHAucGFyYW1zLnN3aXBlUGFuZWxBY3RpdmVBcmVhKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgaXNTY3JvbGxpbmcgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdG91Y2hTdGFydFRpbWUgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgIGRpcmVjdGlvbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZShlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFpc1RvdWNoZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAoZS5mN1ByZXZlbnRQYW5lbFN3aXBlKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2VYID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGUucGFnZVg7XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2VZID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpc1Njcm9sbGluZyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNTY3JvbGxpbmcgPSAhIShpc1Njcm9sbGluZyB8fCBNYXRoLmFicyhwYWdlWSAtIHRvdWNoZXNTdGFydC55KSA+IE1hdGguYWJzKHBhZ2VYIC0gdG91Y2hlc1N0YXJ0LngpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGlzU2Nyb2xsaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghZGlyZWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYWdlWCA+IHRvdWNoZXNTdGFydC54KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3Rpb24gPSAndG8tcmlnaHQnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aW9uID0gJ3RvLWxlZnQnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgICAgICBzaWRlID09PSAnbGVmdCcgJiZcbiAgICAgICAgICAgICAgICAgICAgICAgIChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXJlY3Rpb24gPT09ICd0by1sZWZ0JyAmJiAhcGFuZWwuaGFzQ2xhc3MoJ2FjdGl2ZScpXG4gICAgICAgICAgICAgICAgICAgICAgICApIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICBzaWRlID09PSAncmlnaHQnICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlyZWN0aW9uID09PSAndG8tcmlnaHQnICYmICFwYW5lbC5oYXNDbGFzcygnYWN0aXZlJylcbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuc3dpcGVQYW5lbE5vRm9sbG93KSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0aW1lRGlmZiA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCkgLSB0b3VjaFN0YXJ0VGltZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRpbWVEaWZmIDwgMzAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAndG8tbGVmdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2lkZSA9PT0gJ3JpZ2h0JykgYXBwLm9wZW5QYW5lbChzaWRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2lkZSA9PT0gJ2xlZnQnICYmIHBhbmVsLmhhc0NsYXNzKCdhY3RpdmUnKSkgYXBwLmNsb3NlUGFuZWwoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXJlY3Rpb24gPT09ICd0by1yaWdodCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2lkZSA9PT0gJ2xlZnQnKSBhcHAub3BlblBhbmVsKHNpZGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaWRlID09PSAncmlnaHQnICYmIHBhbmVsLmhhc0NsYXNzKCdhY3RpdmUnKSkgYXBwLmNsb3NlUGFuZWwoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIWlzTW92ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgZWZmZWN0ID0gcGFuZWwuaGFzQ2xhc3MoJ3BhbmVsLWNvdmVyJykgPyAnY292ZXInIDogJ3JldmVhbCc7XG4gICAgICAgICAgICAgICAgICAgIGlmICghb3BlbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYW5lbC5zaG93KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYW5lbE92ZXJsYXkuc2hvdygpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHBhbmVsV2lkdGggPSBwYW5lbFswXS5vZmZzZXRXaWR0aDtcbiAgICAgICAgICAgICAgICAgICAgcGFuZWwudHJhbnNpdGlvbigwKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhbmVsLmZpbmQoJy4nICsgYXBwLnBhcmFtcy52aWV3Q2xhc3MpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAuc2l6ZU5hdmJhcnMpIGFwcC5zaXplTmF2YmFycyhwYW5lbC5maW5kKCcuJyArIGFwcC5wYXJhbXMudmlld0NsYXNzKVswXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlzTW92ZWQgPSB0cnVlO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgdmFyIHRocmVzaG9sZCA9IG9wZW5lZCA/IDAgOiAtYXBwLnBhcmFtcy5zd2lwZVBhbmVsVGhyZXNob2xkO1xuICAgICAgICAgICAgICAgIGlmIChzaWRlID09PSAncmlnaHQnKSB0aHJlc2hvbGQgPSAtdGhyZXNob2xkO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHRvdWNoZXNEaWZmID0gcGFnZVggLSB0b3VjaGVzU3RhcnQueCArIHRocmVzaG9sZDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHNpZGUgPT09ICdyaWdodCcpIHtcbiAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlID0gdG91Y2hlc0RpZmYgIC0gKG9wZW5lZCA/IHBhbmVsV2lkdGggOiAwKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZSA+IDApIHRyYW5zbGF0ZSA9IDA7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGUgPCAtcGFuZWxXaWR0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlID0gLXBhbmVsV2lkdGg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZSA9IHRvdWNoZXNEaWZmICArIChvcGVuZWQgPyBwYW5lbFdpZHRoIDogMCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGUgPCAwKSB0cmFuc2xhdGUgPSAwO1xuICAgICAgICAgICAgICAgICAgICBpZiAodHJhbnNsYXRlID4gcGFuZWxXaWR0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlID0gcGFuZWxXaWR0aDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZWZmZWN0ID09PSAncmV2ZWFsJykge1xuICAgICAgICAgICAgICAgICAgICB2aWV3cy50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyB0cmFuc2xhdGUgKyAncHgsMCwwKScpLnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgICAgIHBhbmVsT3ZlcmxheS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyB0cmFuc2xhdGUgKyAncHgsMCwwKScpLnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBhcHAucGx1Z2luSG9vaygnc3dpcGVQYW5lbFNldFRyYW5zZm9ybScsIHZpZXdzWzBdLCBwYW5lbFswXSwgTWF0aC5hYnModHJhbnNsYXRlIC8gcGFuZWxXaWR0aCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcGFuZWwudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgdHJhbnNsYXRlICsgJ3B4LDAsMCknKS50cmFuc2l0aW9uKDApO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFuZWxPdmVybGF5LnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBvdmVybGF5T3BhY2l0eSA9IE1hdGguYWJzKHRyYW5zbGF0ZS9wYW5lbFdpZHRoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhbmVsT3ZlcmxheS5jc3Moe29wYWNpdHk6IG92ZXJsYXlPcGFjaXR5fSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgYXBwLnBsdWdpbkhvb2soJ3N3aXBlUGFuZWxTZXRUcmFuc2Zvcm0nLCB2aWV3c1swXSwgcGFuZWxbMF0sIE1hdGguYWJzKHRyYW5zbGF0ZSAvIHBhbmVsV2lkdGgpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaEVuZChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFpc1RvdWNoZWQgfHwgIWlzTW92ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdmFyIHRpbWVEaWZmID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKSAtIHRvdWNoU3RhcnRUaW1lO1xuICAgICAgICAgICAgICAgIHZhciBhY3Rpb247XG4gICAgICAgICAgICAgICAgdmFyIGVkZ2UgPSAodHJhbnNsYXRlID09PSAwIHx8IE1hdGguYWJzKHRyYW5zbGF0ZSkgPT09IHBhbmVsV2lkdGgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIW9wZW5lZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHJhbnNsYXRlID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSAncmVzZXQnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKFxuICAgICAgICAgICAgICAgICAgICAgICAgdGltZURpZmYgPCAzMDAgJiYgTWF0aC5hYnModHJhbnNsYXRlKSA+IDAgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVEaWZmID49IDMwMCAmJiAoTWF0aC5hYnModHJhbnNsYXRlKSA+PSBwYW5lbFdpZHRoIC8gMilcbiAgICAgICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSAnc3dhcCc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSAncmVzZXQnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHJhbnNsYXRlID09PSAtcGFuZWxXaWR0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gJ3Jlc2V0JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVEaWZmIDwgMzAwICYmIE1hdGguYWJzKHRyYW5zbGF0ZSkgPj0gMCB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgdGltZURpZmYgPj0gMzAwICYmIChNYXRoLmFicyh0cmFuc2xhdGUpIDw9IHBhbmVsV2lkdGggLyAyKVxuICAgICAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaWRlID09PSAnbGVmdCcgJiYgdHJhbnNsYXRlID09PSBwYW5lbFdpZHRoKSBhY3Rpb24gPSAncmVzZXQnO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBhY3Rpb24gPSAnc3dhcCc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSAncmVzZXQnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhY3Rpb24gPT09ICdzd2FwJykge1xuICAgICAgICAgICAgICAgICAgICBhcHAuYWxsb3dQYW5lbE9wZW4gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBpZiAob3BlbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VQYW5lbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVkZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYW5lbC5jc3Moe2Rpc3BsYXk6ICcnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJCgnYm9keScpLnJlbW92ZUNsYXNzKCdwYW5lbC1jbG9zaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAub3BlblBhbmVsKHNpZGUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChlZGdlKSBhcHAuYWxsb3dQYW5lbE9wZW4gPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uID09PSAncmVzZXQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcGVuZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5hbGxvd1BhbmVsT3BlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAub3BlblBhbmVsKHNpZGUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmNsb3NlUGFuZWwoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlZGdlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmFsbG93UGFuZWxPcGVuID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYW5lbC5jc3Moe2Rpc3BsYXk6ICcnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZWZmZWN0ID09PSAncmV2ZWFsJyA/IHZpZXdzIDogcGFuZWw7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFuZWwudHJpZ2dlcignY2xvc2UnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKCdib2R5JykuYWRkQ2xhc3MoJ3BhbmVsLWNsb3NpbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhbmVsLnRyaWdnZXIoJ2Nsb3NlZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYW5lbC5jc3Moe2Rpc3BsYXk6ICcnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJ2JvZHknKS5yZW1vdmVDbGFzcygncGFuZWwtY2xvc2luZycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAuYWxsb3dQYW5lbE9wZW4gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChlZmZlY3QgPT09ICdyZXZlYWwnKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpZXdzLnRyYW5zaXRpb24oJycpO1xuICAgICAgICAgICAgICAgICAgICB2aWV3cy50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwYW5lbC50cmFuc2l0aW9uKCcnKS50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgICAgIHBhbmVsT3ZlcmxheS5jc3Moe2Rpc3BsYXk6ICcnfSkudHJhbnNmb3JtKCcnKS50cmFuc2l0aW9uKCcnKS5jc3MoJ29wYWNpdHknLCAnJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAkKGRvY3VtZW50KS5vbihhcHAudG91Y2hFdmVudHMuc3RhcnQsIGhhbmRsZVRvdWNoU3RhcnQpO1xuICAgICAgICAgICAgJChkb2N1bWVudCkub24oYXBwLnRvdWNoRXZlbnRzLm1vdmUsIGhhbmRsZVRvdWNoTW92ZSk7XG4gICAgICAgICAgICAkKGRvY3VtZW50KS5vbihhcHAudG91Y2hFdmVudHMuZW5kLCBoYW5kbGVUb3VjaEVuZCk7XG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIEltYWdlIExhenkgTG9hZGluZyAgICoqKioqKioqKioqKlxuICAgICAgICAqKioqKioqKioqKiogICBCYXNlZCBvbiBzb2x1dGlvbiBieSBNYXJjIEdvZGFyZCwgaHR0cHM6Ly9naXRodWIuY29tL01hcmNHb2RhcmQgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLmluaXRJbWFnZXNMYXp5TG9hZCA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBMYXp5IGltYWdlc1xuICAgICAgICAgICAgdmFyIGxhenlMb2FkSW1hZ2VzO1xuICAgICAgICAgICAgaWYgKHBhZ2VDb250YWluZXIuaGFzQ2xhc3MoJ2xhenknKSkge1xuICAgICAgICAgICAgICAgIGxhenlMb2FkSW1hZ2VzID0gcGFnZUNvbnRhaW5lcjtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gbGF6eUxvYWRJbWFnZXMucGFyZW50cygnLnBhZ2UnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGxhenlMb2FkSW1hZ2VzID0gcGFnZUNvbnRhaW5lci5maW5kKCcubGF6eScpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGxhenlMb2FkSW1hZ2VzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNjcm9sbGFibGUgcGFnZSBjb250ZW50XG4gICAgICAgICAgICB2YXIgcGFnZUNvbnRlbnQ7XG4gICAgICAgICAgICBpZiAocGFnZUNvbnRhaW5lci5oYXNDbGFzcygncGFnZS1jb250ZW50JykpICB7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRlbnQgPSBwYWdlQ29udGFpbmVyO1xuICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSBwYWdlQ29udGFpbmVyLnBhcmVudHMoJy5wYWdlJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlICB7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRlbnQgPSBwYWdlQ29udGFpbmVyLmZpbmQoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwYWdlQ29udGVudC5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQbGFjZWhvbGRlclxuICAgICAgICAgICAgdmFyIHBsYWNlaG9sZGVyU3JjID0gJ2RhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQUVBQUFBQkFRTUFBQUFsMjFiS0FBQUFBMUJNVkVYQ3dzSzU5Mm1rQUFBQUNrbEVRVlFJMTJOZ0FBQUFBZ0FCNGlHOE13QUFBQUJKUlU1RXJrSmdnZz09JztcbiAgICAgICAgICAgIGlmICh0eXBlb2YgYXBwLnBhcmFtcy5pbWFnZXNMYXp5TG9hZFBsYWNlaG9sZGVyID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIHBsYWNlaG9sZGVyU3JjID0gYXBwLnBhcmFtcy5pbWFnZXNMYXp5TG9hZFBsYWNlaG9sZGVyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuaW1hZ2VzTGF6eUxvYWRQbGFjZWhvbGRlciAhPT0gZmFsc2UpIGxhenlMb2FkSW1hZ2VzLmVhY2goZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS5hdHRyKCdkYXRhLXNyYycpKSAkKHRoaXMpLmF0dHIoJ3NyYycsIHBsYWNlaG9sZGVyU3JjKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIGxvYWQgaW1hZ2VcbiAgICAgICAgICAgIHZhciBpbWFnZXNTZXF1ZW5jZSA9IFtdO1xuICAgICAgICAgICAgdmFyIGltYWdlSXNMb2FkaW5nID0gZmFsc2U7XG4gICAgICAgICAgICBmdW5jdGlvbiBsb2FkSW1hZ2UoZWwpIHtcbiAgICAgICAgICAgICAgICBlbCA9ICQoZWwpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgYmcgPSBlbC5hdHRyKCdkYXRhLWJhY2tncm91bmQnKTtcbiAgICAgICAgICAgICAgICB2YXIgc3JjID0gYmcgPyBiZyA6IGVsLmF0dHIoJ2RhdGEtc3JjJyk7XG4gICAgICAgICAgICAgICAgaWYgKCFzcmMpIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gb25Mb2FkKCkge1xuICAgICAgICAgICAgICAgICAgICBlbC5yZW1vdmVDbGFzcygnbGF6eScpLmFkZENsYXNzKCdsYXp5LWxvYWRlZCcpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmNzcygnYmFja2dyb3VuZC1pbWFnZScsICd1cmwoJyArIHNyYyArICcpJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbC5hdHRyKCdzcmMnLCBzcmMpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5pbWFnZXNMYXp5TG9hZFNlcXVlbnRpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlSXNMb2FkaW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW1hZ2VzU2VxdWVuY2UubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRJbWFnZShpbWFnZXNTZXF1ZW5jZS5zaGlmdCgpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuaW1hZ2VzTGF6eUxvYWRTZXF1ZW50aWFsKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbWFnZUlzTG9hZGluZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGltYWdlc1NlcXVlbmNlLmluZGV4T2YoZWxbMF0pIDwgMCkgaW1hZ2VzU2VxdWVuY2UucHVzaChlbFswXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIExvYWRpbmcgZmxhZ1xuICAgICAgICAgICAgICAgIGltYWdlSXNMb2FkaW5nID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgaW1hZ2UgPSBuZXcgSW1hZ2UoKTtcbiAgICAgICAgICAgICAgICBpbWFnZS5vbmxvYWQgPSBvbkxvYWQ7XG4gICAgICAgICAgICAgICAgaW1hZ2Uub25lcnJvciA9IG9uTG9hZDtcbiAgICAgICAgICAgICAgICBpbWFnZS5zcmMgPXNyYztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGxhenlIYW5kbGVyKCkge1xuICAgICAgICAgICAgICAgIGxhenlMb2FkSW1hZ2VzID0gcGFnZUNvbnRhaW5lci5maW5kKCcubGF6eScpO1xuICAgICAgICAgICAgICAgIGxhenlMb2FkSW1hZ2VzLmVhY2goZnVuY3Rpb24oaW5kZXgsIGVsKSB7XG4gICAgICAgICAgICAgICAgICAgIGVsID0gJChlbCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlbC5wYXJlbnRzKCcudGFiOm5vdCguYWN0aXZlKScpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoaXNFbGVtZW50SW5WaWV3cG9ydChlbFswXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRJbWFnZShlbCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiBpc0VsZW1lbnRJblZpZXdwb3J0IChlbCkge1xuICAgICAgICAgICAgICAgIHZhciByZWN0ID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgICAgICAgICAgdmFyIHRocmVzaG9sZCA9IGFwcC5wYXJhbXMuaW1hZ2VzTGF6eUxvYWRUaHJlc2hvbGQgfHwgMDtcbiAgICAgICAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgICAgICAgICByZWN0LnRvcCA+PSAoMCAtIHRocmVzaG9sZCkgJiZcbiAgICAgICAgICAgICAgICAgICAgcmVjdC5sZWZ0ID49ICgwIC0gdGhyZXNob2xkKSAmJlxuICAgICAgICAgICAgICAgICAgICByZWN0LnRvcCA8PSAod2luZG93LmlubmVySGVpZ2h0ICsgdGhyZXNob2xkKSAmJlxuICAgICAgICAgICAgICAgICAgICByZWN0LmxlZnQgPD0gKHdpbmRvdy5pbm5lcldpZHRoICsgdGhyZXNob2xkKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgZnVuY3Rpb24gYXR0YWNoRXZlbnRzKGRlc3Ryb3kpIHtcbiAgICAgICAgICAgICAgICB2YXIgbWV0aG9kID0gZGVzdHJveSA/ICdvZmYnIDogJ29uJztcbiAgICAgICAgICAgICAgICBsYXp5TG9hZEltYWdlc1ttZXRob2RdKCdsYXp5JywgbGF6eUhhbmRsZXIpO1xuICAgICAgICAgICAgICAgIGxhenlMb2FkSW1hZ2VzLnBhcmVudHMoJy50YWInKVttZXRob2RdKCdzaG93JywgbGF6eUhhbmRsZXIpO1xuICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXJbbWV0aG9kXSgnbGF6eScsIGxhenlIYW5kbGVyKTtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGVudFttZXRob2RdKCdsYXp5JywgbGF6eUhhbmRsZXIpO1xuICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50W21ldGhvZF0oJ3Njcm9sbCcsIGxhenlIYW5kbGVyKTtcbiAgICAgICAgICAgICAgICAkKHdpbmRvdylbbWV0aG9kXSgncmVzaXplJywgbGF6eUhhbmRsZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gZGV0YWNoRXZlbnRzKCkge1xuICAgICAgICAgICAgICAgIGF0dGFjaEV2ZW50cyh0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTdG9yZSBkZXRhY2ggZnVuY3Rpb25cbiAgICAgICAgICAgIHBhZ2VDb250YWluZXJbMF0uZjdEZXN0cm95SW1hZ2VzTGF6eUxvYWQgPSBkZXRhY2hFdmVudHM7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQXR0YWNoIGV2ZW50c1xuICAgICAgICAgICAgYXR0YWNoRXZlbnRzKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGVzdHJveSBvbiBwYWdlIHJlbW92ZVxuICAgICAgICAgICAgaWYgKHBhZ2VDb250YWluZXIuaGFzQ2xhc3MoJ3BhZ2UnKSkge1xuICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIub25jZSgncGFnZUJlZm9yZVJlbW92ZScsIGRldGFjaEV2ZW50cyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUnVuIGxvYWRlciBvbiBwYWdlIGxvYWQvaW5pdFxuICAgICAgICAgICAgbGF6eUhhbmRsZXIoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBSdW4gYWZ0ZXIgcGFnZSBhbmltYXRpb25cbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIub25jZSgncGFnZUFmdGVyQW5pbWF0aW9uJywgbGF6eUhhbmRsZXIpO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuZGVzdHJveUltYWdlc0xhenlMb2FkID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgaWYgKHBhZ2VDb250YWluZXIubGVuZ3RoID4gMCAmJiBwYWdlQ29udGFpbmVyWzBdLmY3RGVzdHJveUltYWdlc0xhenlMb2FkKSB7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lclswXS5mN0Rlc3Ryb3lJbWFnZXNMYXp5TG9hZCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBhcHAucmVpbml0SW1hZ2VzTGF6eUxvYWQgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICBpZiAocGFnZUNvbnRhaW5lci5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lci50cmlnZ2VyKCdsYXp5Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgTWF0ZXJpYWwgUHJlbG9hZGVyICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5pbml0UGFnZU1hdGVyaWFsUHJlbG9hZGVyID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgICQocGFnZUNvbnRhaW5lcikuZmluZCgnLnByZWxvYWRlcicpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLmNoaWxkcmVuKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICQodGhpcykuaHRtbChhcHAucGFyYW1zLm1hdGVyaWFsUHJlbG9hZGVySHRtbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgTWVzc2FnZXMgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgdmFyIE1lc3NhZ2VzID0gZnVuY3Rpb24gKGNvbnRhaW5lciwgcGFyYW1zKSB7XG4gICAgICAgICAgICB2YXIgZGVmYXVsdHMgPSB7XG4gICAgICAgICAgICAgICAgYXV0b0xheW91dDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBuZXdNZXNzYWdlc0ZpcnN0OiBmYWxzZSxcbiAgICAgICAgICAgICAgICBtZXNzYWdlVGVtcGxhdGU6IFxuICAgICAgICAgICAgICAgICAgICAne3sjaWYgZGF5fX0nICtcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJtZXNzYWdlcy1kYXRlXCI+e3tkYXl9fSB7eyNpZiB0aW1lfX0sIDxzcGFuPnt7dGltZX19PC9zcGFuPnt7L2lmfX08L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgJ3t7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJtZXNzYWdlIG1lc3NhZ2Ute3t0eXBlfX0ge3sjaWYgaGFzSW1hZ2V9fW1lc3NhZ2UtcGlje3svaWZ9fSB7eyNpZiBhdmF0YXJ9fW1lc3NhZ2Utd2l0aC1hdmF0YXJ7ey9pZn19IHt7I2lmIHBvc2l0aW9ufX1tZXNzYWdlLWFwcGVhci1mcm9tLXt7cG9zaXRpb259fXt7L2lmfX1cIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBuYW1lfX08ZGl2IGNsYXNzPVwibWVzc2FnZS1uYW1lXCI+e3tuYW1lfX08L2Rpdj57ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIm1lc3NhZ2UtdGV4dFwiPnt7dGV4dH19e3sjaWYgZGF0ZX19PGRpdiBjbGFzcz1cIm1lc3NhZ2UtZGF0ZVwiPnt7ZGF0ZX19PC9kaXY+e3svaWZ9fTwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIGF2YXRhcn19PGRpdiBjbGFzcz1cIm1lc3NhZ2UtYXZhdGFyXCIgc3R5bGU9XCJiYWNrZ3JvdW5kLWltYWdlOnVybCh7e2F2YXRhcn19KVwiPjwvZGl2Pnt7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBsYWJlbH19PGRpdiBjbGFzcz1cIm1lc3NhZ2UtbGFiZWxcIj57e2xhYmVsfX08L2Rpdj57ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xuICAgICAgICAgICAgZm9yICh2YXIgZGVmIGluIGRlZmF1bHRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXNbZGVmXSA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFyYW1zW2RlZl0gPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zW2RlZl0gPSBkZWZhdWx0c1tkZWZdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbnN0YW5jZVxuICAgICAgICAgICAgdmFyIG0gPSB0aGlzO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBhcmFtc1xuICAgICAgICAgICAgbS5wYXJhbXMgPSBwYXJhbXM7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ29udGFpbmVyXG4gICAgICAgICAgICBtLmNvbnRhaW5lciA9ICQoY29udGFpbmVyKTtcbiAgICAgICAgICAgIGlmIChtLmNvbnRhaW5lci5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBBdXRvbGF5b3V0XG4gICAgICAgICAgICBpZiAobS5wYXJhbXMuYXV0b0xheW91dCkgbS5jb250YWluZXIuYWRkQ2xhc3MoJ21lc3NhZ2VzLWF1dG8tbGF5b3V0Jyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gTmV3IG1lc3NhZ2VzIGZpcnN0XG4gICAgICAgICAgICBpZiAobS5wYXJhbXMubmV3TWVzc2FnZXNGaXJzdCkgbS5jb250YWluZXIuYWRkQ2xhc3MoJ21lc3NhZ2VzLW5ldy1maXJzdCcpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIElzIEluIFBhZ2VcbiAgICAgICAgICAgIG0ucGFnZUNvbnRhaW5lciA9IG0uY29udGFpbmVyLnBhcmVudHMoJy5wYWdlJykuZXEoMCk7XG4gICAgICAgICAgICBtLnBhZ2VDb250ZW50ID0gbS5wYWdlQ29udGFpbmVyLmZpbmQoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDb21waWxlZCB0ZW1wbGF0ZVxuICAgICAgICAgICAgbS50ZW1wbGF0ZSA9IFRlbXBsYXRlNy5jb21waWxlKG0ucGFyYW1zLm1lc3NhZ2VUZW1wbGF0ZSk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQXV0byBMYXlvdXRcbiAgICAgICAgICAgIG0ubGF5b3V0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmICghbS5jb250YWluZXIuaGFzQ2xhc3MoJ21lc3NhZ2VzLWF1dG8tbGF5b3V0JykpIG0uY29udGFpbmVyLmFkZENsYXNzKCdtZXNzYWdlcy1hdXRvLWxheW91dCcpO1xuICAgICAgICAgICAgICAgIG0uY29udGFpbmVyLmZpbmQoJy5tZXNzYWdlJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBtZXNzYWdlID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UuZmluZCgnLm1lc3NhZ2UtdGV4dCBpbWcnKS5sZW5ndGggPiAwKSBtZXNzYWdlLmFkZENsYXNzKCdtZXNzYWdlLXBpYycpO1xuICAgICAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS5maW5kKCcubWVzc2FnZS1hdmF0YXInKS5sZW5ndGggPiAwKSBtZXNzYWdlLmFkZENsYXNzKCdtZXNzYWdlLXdpdGgtYXZhdGFyJyk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgbS5jb250YWluZXIuZmluZCgnLm1lc3NhZ2UnKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaXNTZW50ID0gbWVzc2FnZS5oYXNDbGFzcygnbWVzc2FnZS1zZW50Jyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gbWVzc2FnZS5uZXh0KCcubWVzc2FnZS0nICsgKGlzU2VudCA/ICdzZW50JyA6ICdyZWNlaXZlZCcpKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByZXYgPSBtZXNzYWdlLnByZXYoJy5tZXNzYWdlLScgKyAoaXNTZW50ID8gJ3NlbnQnIDogJ3JlY2VpdmVkJykpO1xuICAgICAgICAgICAgICAgICAgICBpZiAobmV4dC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuYWRkQ2xhc3MoJ21lc3NhZ2UtbGFzdCBtZXNzYWdlLXdpdGgtdGFpbCcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgbWVzc2FnZS5yZW1vdmVDbGFzcygnbWVzc2FnZS1sYXN0IG1lc3NhZ2Utd2l0aC10YWlsJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAocHJldi5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuYWRkQ2xhc3MoJ21lc3NhZ2UtZmlyc3QnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIG1lc3NhZ2UucmVtb3ZlQ2xhc3MoJ21lc3NhZ2UtZmlyc3QnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChwcmV2Lmxlbmd0aCA+IDAgJiYgcHJldi5maW5kKCcubWVzc2FnZS1uYW1lJykubGVuZ3RoID4gMCAmJiBtZXNzYWdlLmZpbmQoJy5tZXNzYWdlLW5hbWUnKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJldi5maW5kKCcubWVzc2FnZS1uYW1lJykudGV4dCgpICE9PSBtZXNzYWdlLmZpbmQoJy5tZXNzYWdlLW5hbWUnKS50ZXh0KCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmV2LmFkZENsYXNzKCdtZXNzYWdlLWxhc3QgbWVzc2FnZS13aXRoLXRhaWwnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmFkZENsYXNzKCdtZXNzYWdlLWZpcnN0Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQWRkIE1lc3NhZ2VcbiAgICAgICAgICAgIG0uYXBwZW5kTWVzc2FnZSA9IGZ1bmN0aW9uIChwcm9wcywgYW5pbWF0ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBtLmFkZE1lc3NhZ2UocHJvcHMsICdhcHBlbmQnLCBhbmltYXRlKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBtLnByZXBlbmRNZXNzYWdlID0gZnVuY3Rpb24gKHByb3BzLCBhbmltYXRlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG0uYWRkTWVzc2FnZShwcm9wcywgJ3ByZXBlbmQnLCBhbmltYXRlKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBtLmFkZE1lc3NhZ2UgPSBmdW5jdGlvbiAocHJvcHMsIG1ldGhvZCwgYW5pbWF0ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBtLmFkZE1lc3NhZ2VzKFtwcm9wc10sIG1ldGhvZCwgYW5pbWF0ZSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbS5hZGRNZXNzYWdlcyA9IGZ1bmN0aW9uIChuZXdNZXNzYWdlcywgbWV0aG9kLCBhbmltYXRlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhbmltYXRlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBhbmltYXRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtZXRob2QgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIG1ldGhvZCA9IG0ucGFyYW1zLm5ld01lc3NhZ2VzRmlyc3QgPyAncHJlcGVuZCcgOiAnYXBwZW5kJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIG5ld01lc3NhZ2VzSFRNTCA9ICcnLCBpO1xuICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBuZXdNZXNzYWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSBuZXdNZXNzYWdlc1tpXSB8fCB7fTtcbiAgICAgICAgICAgICAgICAgICAgcHJvcHMudHlwZSA9IHByb3BzLnR5cGUgfHwgJ3NlbnQnO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXByb3BzLnRleHQpIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICBwcm9wcy5oYXNJbWFnZSA9IHByb3BzLnRleHQuaW5kZXhPZignPGltZycpID49IDA7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhbmltYXRlKSBwcm9wcy5wb3NpdGlvbiA9IG1ldGhvZCA9PT0gJ2FwcGVuZCcgPyAnYm90dG9tJyA6ICd0b3AnO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgbmV3TWVzc2FnZXNIVE1MICs9IG0udGVtcGxhdGUocHJvcHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgaGVpZ2h0QmVmb3JlLCBzY3JvbGxCZWZvcmU7XG4gICAgICAgICAgICAgICAgaWYgKG1ldGhvZCA9PT0gJ3ByZXBlbmQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGhlaWdodEJlZm9yZSA9IG0ucGFnZUNvbnRlbnRbMF0uc2Nyb2xsSGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICBzY3JvbGxCZWZvcmUgPSBtLnBhZ2VDb250ZW50WzBdLnNjcm9sbFRvcDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbS5jb250YWluZXJbbWV0aG9kXShuZXdNZXNzYWdlc0hUTUwpO1xuICAgICAgICAgICAgICAgIGlmIChtLnBhcmFtcy5hdXRvTGF5b3V0KSBtLmxheW91dCgpO1xuICAgICAgICAgICAgICAgIGlmIChtZXRob2QgPT09ICdwcmVwZW5kJykge1xuICAgICAgICAgICAgICAgICAgICBtLnBhZ2VDb250ZW50WzBdLnNjcm9sbFRvcCA9IHNjcm9sbEJlZm9yZSArIChtLnBhZ2VDb250ZW50WzBdLnNjcm9sbEhlaWdodCAtIGhlaWdodEJlZm9yZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICgobWV0aG9kID09PSAnYXBwZW5kJyAmJiAhbS5wYXJhbXMubmV3TWVzc2FnZXNGaXJzdCkgfHwgKG1ldGhvZCA9PT0gJ3ByZXBlbmQnICYmIG0ucGFyYW1zLm5ld01lc3NhZ2VzRmlyc3QpKSB7XG4gICAgICAgICAgICAgICAgICAgIG0uc2Nyb2xsTWVzc2FnZXMoYW5pbWF0ZSA/IHVuZGVmaW5lZCA6IDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZXMgPSBtLmNvbnRhaW5lci5maW5kKCcubWVzc2FnZScpO1xuICAgICAgICAgICAgICAgIGlmIChuZXdNZXNzYWdlcy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1ldGhvZCA9PT0gJ2FwcGVuZCcgPyBtZXNzYWdlc1ttZXNzYWdlcy5sZW5ndGggLSAxXSA6IG1lc3NhZ2VzWzBdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2VzVG9SZXR1cm4gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1ldGhvZCA9PT0gJ2FwcGVuZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IG1lc3NhZ2VzLmxlbmd0aCAtIG5ld01lc3NhZ2VzLmxlbmd0aDsgaSA8IG1lc3NhZ2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZXNUb1JldHVybi5wdXNoKG1lc3NhZ2VzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBuZXdNZXNzYWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VzVG9SZXR1cm4ucHVzaChtZXNzYWdlc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9ICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG1lc3NhZ2VzVG9SZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG0ucmVtb3ZlTWVzc2FnZSA9IGZ1bmN0aW9uIChtZXNzYWdlKSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZSA9ICQobWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtLnBhcmFtcy5hdXRvTGF5b3V0KSBtLmxheW91dCgpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbS5yZW1vdmVNZXNzYWdlcyA9IGZ1bmN0aW9uIChtZXNzYWdlcykge1xuICAgICAgICAgICAgICAgIG0ucmVtb3ZlTWVzc2FnZShtZXNzYWdlcyk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbS5jbGVhbiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBtLmNvbnRhaW5lci5odG1sKCcnKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2Nyb2xsXG4gICAgICAgICAgICBtLnNjcm9sbE1lc3NhZ2VzID0gZnVuY3Rpb24gKGR1cmF0aW9uLCBzY3JvbGxUb3ApIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGR1cmF0aW9uID09PSAndW5kZWZpbmVkJykgZHVyYXRpb24gPSA0MDA7XG4gICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRTY3JvbGwgPSBtLnBhZ2VDb250ZW50WzBdLnNjcm9sbFRvcDtcbiAgICAgICAgICAgICAgICB2YXIgbmV3U2Nyb2xsO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2Nyb2xsVG9wICE9PSAndW5kZWZpbmVkJykgbmV3U2Nyb2xsID0gc2Nyb2xsVG9wO1xuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuZXdTY3JvbGwgPSBtLnBhcmFtcy5uZXdNZXNzYWdlc0ZpcnN0ID8gMCA6IG0ucGFnZUNvbnRlbnRbMF0uc2Nyb2xsSGVpZ2h0IC0gbS5wYWdlQ29udGVudFswXS5vZmZzZXRIZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgIGlmIChuZXdTY3JvbGwgPT09IGN1cnJlbnRTY3JvbGwpIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbS5wYWdlQ29udGVudC5zY3JvbGxUb3AobmV3U2Nyb2xsLCBkdXJhdGlvbik7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgRGVzdHJveVxuICAgICAgICAgICAgbS5pbml0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChtLnBhcmFtcy5tZXNzYWdlcykge1xuICAgICAgICAgICAgICAgICAgICBtLmFkZE1lc3NhZ2VzKG0ucGFyYW1zLm1lc3NhZ2VzLCB1bmRlZmluZWQsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtLnBhcmFtcy5hdXRvTGF5b3V0KSBtLmxheW91dCgpOyAgICBcbiAgICAgICAgICAgICAgICAgICAgbS5zY3JvbGxNZXNzYWdlcygwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbS5kZXN0cm95ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIG0gPSBudWxsO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0XG4gICAgICAgICAgICBtLmluaXQoKTtcbiAgICAgICAgXG4gICAgICAgICAgICBtLmNvbnRhaW5lclswXS5mN01lc3NhZ2VzID0gbTtcbiAgICAgICAgICAgIHJldHVybiBtO1xuICAgICAgICB9O1xuICAgICAgICBhcHAubWVzc2FnZXMgPSBmdW5jdGlvbiAoY29udGFpbmVyLCBwYXJhbXMpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgTWVzc2FnZXMgKGNvbnRhaW5lciwgcGFyYW1zKTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmluaXRQYWdlTWVzc2FnZXMgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICB2YXIgbWVzc2FnZXMgPSBwYWdlQ29udGFpbmVyLmZpbmQoJy5tZXNzYWdlcycpO1xuICAgICAgICAgICAgaWYgKG1lc3NhZ2VzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKCFtZXNzYWdlcy5oYXNDbGFzcygnbWVzc2FnZXMtaW5pdCcpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIG0gPSBhcHAubWVzc2FnZXMobWVzc2FnZXMsIG1lc3NhZ2VzLmRhdGFzZXQoKSk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGVzdHJveSBvbiBwYWdlIHJlbW92ZVxuICAgICAgICAgICAgZnVuY3Rpb24gcGFnZUJlZm9yZVJlbW92ZSgpIHtcbiAgICAgICAgICAgICAgICBtLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyLm9mZigncGFnZUJlZm9yZVJlbW92ZScsIHBhZ2VCZWZvcmVSZW1vdmUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHBhZ2VDb250YWluZXIuaGFzQ2xhc3MoJ3BhZ2UnKSkge1xuICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIub24oJ3BhZ2VCZWZvcmVSZW1vdmUnLCBwYWdlQmVmb3JlUmVtb3ZlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIFN3aXBlb3V0IEFjdGlvbnMgKFN3aXBlIHRvIGRlbGV0ZSkgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5zd2lwZW91dE9wZW5lZEVsID0gdW5kZWZpbmVkO1xuICAgICAgICBhcHAuYWxsb3dTd2lwZW91dCA9IHRydWU7XG4gICAgICAgIGFwcC5pbml0U3dpcGVvdXQgPSBmdW5jdGlvbiAoc3dpcGVvdXRFbCkge1xuICAgICAgICAgICAgdmFyIGlzVG91Y2hlZCwgaXNNb3ZlZCwgaXNTY3JvbGxpbmcsIHRvdWNoZXNTdGFydCA9IHt9LCB0b3VjaFN0YXJ0VGltZSwgdG91Y2hlc0RpZmYsIHN3aXBlT3V0RWwsIHN3aXBlT3V0Q29udGVudCwgYWN0aW9uc1JpZ2h0LCBhY3Rpb25zTGVmdCwgYWN0aW9uc0xlZnRXaWR0aCwgYWN0aW9uc1JpZ2h0V2lkdGgsIHRyYW5zbGF0ZSwgb3BlbmVkLCBvcGVuZWRBY3Rpb25zLCBidXR0b25zTGVmdCwgYnV0dG9uc1JpZ2h0LCBkaXJlY3Rpb24sIG92ZXJzd2lwZUxlZnRCdXR0b24sIG92ZXJzd2lwZVJpZ2h0QnV0dG9uLCBvdmVyc3dpcGVMZWZ0LCBvdmVyc3dpcGVSaWdodCwgbm9Gb2xkTGVmdCwgbm9Gb2xkUmlnaHQ7XG4gICAgICAgICAgICAkKGRvY3VtZW50KS5vbihhcHAudG91Y2hFdmVudHMuc3RhcnQsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5zd2lwZW91dE9wZW5lZEVsKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSAkKGUudGFyZ2V0KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCEoXG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuc3dpcGVvdXRPcGVuZWRFbC5pcyh0YXJnZXRbMF0pIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQucGFyZW50cygnLnN3aXBlb3V0JykuaXMoYXBwLnN3aXBlb3V0T3BlbmVkRWwpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQuaGFzQ2xhc3MoJ21vZGFsLWluJykgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5oYXNDbGFzcygnbW9kYWwtb3ZlcmxheScpIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQuaGFzQ2xhc3MoJ2FjdGlvbnMtbW9kYWwnKSB8fCBcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldC5wYXJlbnRzKCcuYWN0aW9ucy1tb2RhbC5tb2RhbC1pbiwgLm1vZGFsLm1vZGFsLWluJykubGVuZ3RoID4gMFxuICAgICAgICAgICAgICAgICAgICAgICAgKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnN3aXBlb3V0Q2xvc2UoYXBwLnN3aXBlb3V0T3BlbmVkRWwpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFhcHAuYWxsb3dTd2lwZW91dCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlzU2Nyb2xsaW5nID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHRvdWNoZXNTdGFydC54ID0gZS50eXBlID09PSAndG91Y2hzdGFydCcgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBlLnBhZ2VYO1xuICAgICAgICAgICAgICAgIHRvdWNoZXNTdGFydC55ID0gZS50eXBlID09PSAndG91Y2hzdGFydCcgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgOiBlLnBhZ2VZO1xuICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRUaW1lID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoTW92ZShlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFpc1RvdWNoZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgcGFnZVggPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZS5wYWdlWDtcbiAgICAgICAgICAgICAgICB2YXIgcGFnZVkgPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGlzU2Nyb2xsaW5nID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBpc1Njcm9sbGluZyA9ICEhKGlzU2Nyb2xsaW5nIHx8IE1hdGguYWJzKHBhZ2VZIC0gdG91Y2hlc1N0YXJ0LnkpID4gTWF0aC5hYnMocGFnZVggLSB0b3VjaGVzU3RhcnQueCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaXNTY3JvbGxpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICghaXNNb3ZlZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLmxpc3QtYmxvY2suc29ydGFibGUtb3BlbmVkJykubGVuZ3RoID4gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqL1xuICAgICAgICAgICAgICAgICAgICBzd2lwZU91dEVsID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgc3dpcGVPdXRDb250ZW50ID0gc3dpcGVPdXRFbC5maW5kKCcuc3dpcGVvdXQtY29udGVudCcpO1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb25zUmlnaHQgPSBzd2lwZU91dEVsLmZpbmQoJy5zd2lwZW91dC1hY3Rpb25zLXJpZ2h0Jyk7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnNMZWZ0ID0gc3dpcGVPdXRFbC5maW5kKCcuc3dpcGVvdXQtYWN0aW9ucy1sZWZ0Jyk7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnNMZWZ0V2lkdGggPSBhY3Rpb25zUmlnaHRXaWR0aCA9IGJ1dHRvbnNMZWZ0ID0gYnV0dG9uc1JpZ2h0ID0gb3ZlcnN3aXBlUmlnaHRCdXR0b24gPSBvdmVyc3dpcGVMZWZ0QnV0dG9uID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgbm9Gb2xkTGVmdCA9IGFjdGlvbnNMZWZ0Lmhhc0NsYXNzKCdzd2lwZW91dC1hY3Rpb25zLW5vLWZvbGQnKSB8fCBhcHAucGFyYW1zLnN3aXBlb3V0QWN0aW9uc05vRm9sZDtcbiAgICAgICAgICAgICAgICAgICAgbm9Gb2xkUmlnaHQgPSBhY3Rpb25zUmlnaHQuaGFzQ2xhc3MoJ3N3aXBlb3V0LWFjdGlvbnMtbm8tZm9sZCcpIHx8IGFwcC5wYXJhbXMuc3dpcGVvdXRBY3Rpb25zTm9Gb2xkO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aW9uc0xlZnQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uc0xlZnRXaWR0aCA9IGFjdGlvbnNMZWZ0Lm91dGVyV2lkdGgoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbnNMZWZ0ID0gYWN0aW9uc0xlZnQuY2hpbGRyZW4oJ2EnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJzd2lwZUxlZnRCdXR0b24gPSBhY3Rpb25zTGVmdC5maW5kKCcuc3dpcGVvdXQtb3ZlcnN3aXBlJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbnNSaWdodC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25zUmlnaHRXaWR0aCA9IGFjdGlvbnNSaWdodC5vdXRlcldpZHRoKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBidXR0b25zUmlnaHQgPSBhY3Rpb25zUmlnaHQuY2hpbGRyZW4oJ2EnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJzd2lwZVJpZ2h0QnV0dG9uID0gYWN0aW9uc1JpZ2h0LmZpbmQoJy5zd2lwZW91dC1vdmVyc3dpcGUnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBvcGVuZWQgPSBzd2lwZU91dEVsLmhhc0NsYXNzKCdzd2lwZW91dC1vcGVuZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wZW5lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3BlbmVkQWN0aW9ucyA9IHN3aXBlT3V0RWwuZmluZCgnLnN3aXBlb3V0LWFjdGlvbnMtbGVmdC5zd2lwZW91dC1hY3Rpb25zLW9wZW5lZCcpLmxlbmd0aCA+IDAgPyAnbGVmdCcgOiAncmlnaHQnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHN3aXBlT3V0RWwucmVtb3ZlQ2xhc3MoJ3RyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFhcHAucGFyYW1zLnN3aXBlb3V0Tm9Gb2xsb3cpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXBlT3V0RWwuZmluZCgnLnN3aXBlb3V0LWFjdGlvbnMtb3BlbmVkJykucmVtb3ZlQ2xhc3MoJ3N3aXBlb3V0LWFjdGlvbnMtb3BlbmVkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzd2lwZU91dEVsLnJlbW92ZUNsYXNzKCdzd2lwZW91dC1vcGVuZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpc01vdmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdG91Y2hlc0RpZmYgPSBwYWdlWCAtIHRvdWNoZXNTdGFydC54O1xuICAgICAgICAgICAgICAgIHRyYW5zbGF0ZSA9IHRvdWNoZXNEaWZmO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAob3BlbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcGVuZWRBY3Rpb25zID09PSAncmlnaHQnKSB0cmFuc2xhdGUgPSB0cmFuc2xhdGUgLSBhY3Rpb25zUmlnaHRXaWR0aDtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB0cmFuc2xhdGUgPSB0cmFuc2xhdGUgKyBhY3Rpb25zTGVmdFdpZHRoO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZSA+IDAgJiYgYWN0aW9uc0xlZnQubGVuZ3RoID09PSAwIHx8IHRyYW5zbGF0ZSA8IDAgJiYgYWN0aW9uc1JpZ2h0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIW9wZW5lZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3dpcGVPdXRDb250ZW50LnRyYW5zZm9ybSgnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnV0dG9uc1JpZ2h0ICYmIGJ1dHRvbnNSaWdodC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uc1JpZ2h0LnRyYW5zZm9ybSgnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnV0dG9uc0xlZnQgJiYgYnV0dG9uc0xlZnQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbnNMZWZ0LnRyYW5zZm9ybSgnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlID0gMDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGUgPCAwKSBkaXJlY3Rpb24gPSAndG8tbGVmdCc7XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAodHJhbnNsYXRlID4gMCkgZGlyZWN0aW9uID0gJ3RvLXJpZ2h0JztcbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRpcmVjdGlvbikgZGlyZWN0aW9uID0gZGlyZWN0aW9uO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIGRpcmVjdGlvbiA9ICd0by1sZWZ0JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIGksIGJ1dHRvbk9mZnNldCwgcHJvZ3Jlc3M7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgZS5mN1ByZXZlbnRQYW5lbFN3aXBlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5zd2lwZW91dE5vRm9sbG93KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcGVuZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcGVuZWRBY3Rpb25zID09PSAncmlnaHQnICYmIHRvdWNoZXNEaWZmID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5zd2lwZW91dENsb3NlKHN3aXBlT3V0RWwpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wZW5lZEFjdGlvbnMgPT09ICdsZWZ0JyAmJiB0b3VjaGVzRGlmZiA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAuc3dpcGVvdXRDbG9zZShzd2lwZU91dEVsKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b3VjaGVzRGlmZiA8IDAgJiYgYWN0aW9uc1JpZ2h0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAuc3dpcGVvdXRPcGVuKHN3aXBlT3V0RWwsICdyaWdodCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRvdWNoZXNEaWZmID4gMCAmJiBhY3Rpb25zTGVmdC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnN3aXBlb3V0T3Blbihzd2lwZU91dEVsLCAnbGVmdCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgb3ZlcnN3aXBlTGVmdCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIG92ZXJzd2lwZVJpZ2h0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdmFyICRidXR0b247XG4gICAgICAgICAgICAgICAgaWYgKGFjdGlvbnNSaWdodC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFNob3cgcmlnaHQgYWN0aW9uc1xuICAgICAgICAgICAgICAgICAgICBwcm9ncmVzcyA9IHRyYW5zbGF0ZSAvIGFjdGlvbnNSaWdodFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICBpZiAodHJhbnNsYXRlIDwgLWFjdGlvbnNSaWdodFdpZHRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGUgPSAtYWN0aW9uc1JpZ2h0V2lkdGggLSBNYXRoLnBvdygtdHJhbnNsYXRlIC0gYWN0aW9uc1JpZ2h0V2lkdGgsIDAuOCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob3ZlcnN3aXBlUmlnaHRCdXR0b24ubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJzd2lwZVJpZ2h0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYnV0dG9uc1JpZ2h0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGJ1dHRvbnNSaWdodFtpXS5fYnV0dG9uT2Zmc2V0ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbnNSaWdodFtpXS5fYnV0dG9uT2Zmc2V0ID0gYnV0dG9uc1JpZ2h0W2ldLm9mZnNldExlZnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBidXR0b25PZmZzZXQgPSBidXR0b25zUmlnaHRbaV0uX2J1dHRvbk9mZnNldDtcbiAgICAgICAgICAgICAgICAgICAgICAgICRidXR0b24gPSAkKGJ1dHRvbnNSaWdodFtpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob3ZlcnN3aXBlUmlnaHRCdXR0b24ubGVuZ3RoID4gMCAmJiAkYnV0dG9uLmhhc0NsYXNzKCdzd2lwZW91dC1vdmVyc3dpcGUnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICRidXR0b24uY3NzKHtsZWZ0OiAob3ZlcnN3aXBlUmlnaHQgPyAtYnV0dG9uT2Zmc2V0IDogMCkgKyAncHgnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG92ZXJzd2lwZVJpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRidXR0b24uYWRkQ2xhc3MoJ3N3aXBlb3V0LW92ZXJzd2lwZS1hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRidXR0b24ucmVtb3ZlQ2xhc3MoJ3N3aXBlb3V0LW92ZXJzd2lwZS1hY3RpdmUnKTsgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAkYnV0dG9uLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArICh0cmFuc2xhdGUgLSBidXR0b25PZmZzZXQgKiAoMSArIE1hdGgubWF4KHByb2dyZXNzLCAtMSkpKSArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFjdGlvbnNMZWZ0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gU2hvdyBsZWZ0IGFjdGlvbnNcbiAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MgPSB0cmFuc2xhdGUgLyBhY3Rpb25zTGVmdFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICBpZiAodHJhbnNsYXRlID4gYWN0aW9uc0xlZnRXaWR0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlID0gYWN0aW9uc0xlZnRXaWR0aCArIE1hdGgucG93KHRyYW5zbGF0ZSAtIGFjdGlvbnNMZWZ0V2lkdGgsIDAuOCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob3ZlcnN3aXBlTGVmdEJ1dHRvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcnN3aXBlTGVmdCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJ1dHRvbnNMZWZ0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGJ1dHRvbnNMZWZ0W2ldLl9idXR0b25PZmZzZXQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uc0xlZnRbaV0uX2J1dHRvbk9mZnNldCA9IGFjdGlvbnNMZWZ0V2lkdGggLSBidXR0b25zTGVmdFtpXS5vZmZzZXRMZWZ0IC0gYnV0dG9uc0xlZnRbaV0ub2Zmc2V0V2lkdGg7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBidXR0b25PZmZzZXQgPSBidXR0b25zTGVmdFtpXS5fYnV0dG9uT2Zmc2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgJGJ1dHRvbiA9ICQoYnV0dG9uc0xlZnRbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG92ZXJzd2lwZUxlZnRCdXR0b24ubGVuZ3RoID4gMCAmJiAkYnV0dG9uLmhhc0NsYXNzKCdzd2lwZW91dC1vdmVyc3dpcGUnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICRidXR0b24uY3NzKHtsZWZ0OiAob3ZlcnN3aXBlTGVmdCA/IGJ1dHRvbk9mZnNldCA6IDApICsgJ3B4J30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvdmVyc3dpcGVMZWZ0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRidXR0b24uYWRkQ2xhc3MoJ3N3aXBlb3V0LW92ZXJzd2lwZS1hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRidXR0b24ucmVtb3ZlQ2xhc3MoJ3N3aXBlb3V0LW92ZXJzd2lwZS1hY3RpdmUnKTsgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYnV0dG9uc0xlZnQubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICRidXR0b24uY3NzKCd6LWluZGV4JywgYnV0dG9uc0xlZnQubGVuZ3RoIC0gaSk7IFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgJGJ1dHRvbi50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAodHJhbnNsYXRlICsgYnV0dG9uT2Zmc2V0ICogKDEgLSBNYXRoLm1pbihwcm9ncmVzcywgMSkpKSArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3dpcGVPdXRDb250ZW50LnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHRyYW5zbGF0ZSArICdweCwwLDApJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaEVuZChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFpc1RvdWNoZWQgfHwgIWlzTW92ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZhciB0aW1lRGlmZiA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCkgLSB0b3VjaFN0YXJ0VGltZTtcbiAgICAgICAgICAgICAgICB2YXIgYWN0aW9uLCBhY3Rpb25zV2lkdGgsIGFjdGlvbnMsIGJ1dHRvbnMsIGksIG5vRm9sZDtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBub0ZvbGQgPSBkaXJlY3Rpb24gPT09ICd0by1sZWZ0JyA/IG5vRm9sZFJpZ2h0IDogbm9Gb2xkTGVmdDtcbiAgICAgICAgICAgICAgICBhY3Rpb25zID0gZGlyZWN0aW9uID09PSAndG8tbGVmdCcgPyBhY3Rpb25zUmlnaHQgOiBhY3Rpb25zTGVmdDtcbiAgICAgICAgICAgICAgICBhY3Rpb25zV2lkdGggPSBkaXJlY3Rpb24gPT09ICd0by1sZWZ0JyA/IGFjdGlvbnNSaWdodFdpZHRoIDogYWN0aW9uc0xlZnRXaWR0aDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICB0aW1lRGlmZiA8IDMwMCAmJiAodG91Y2hlc0RpZmYgPCAtMTAgJiYgZGlyZWN0aW9uID09PSAndG8tbGVmdCcgfHwgdG91Y2hlc0RpZmYgPiAxMCAmJiBkaXJlY3Rpb24gPT09ICd0by1yaWdodCcpIHx8XG4gICAgICAgICAgICAgICAgICAgIHRpbWVEaWZmID49IDMwMCAmJiBNYXRoLmFicyh0cmFuc2xhdGUpID4gYWN0aW9uc1dpZHRoIC8gMlxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSAnb3Blbic7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSAnY2xvc2UnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodGltZURpZmYgPCAzMDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRyYW5zbGF0ZSkgPT09IDApIGFjdGlvbiA9ICdjbG9zZSc7XG4gICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyh0cmFuc2xhdGUpID09PSBhY3Rpb25zV2lkdGgpIGFjdGlvbiA9ICdvcGVuJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ29wZW4nKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5zd2lwZW91dE9wZW5lZEVsID0gc3dpcGVPdXRFbDtcbiAgICAgICAgICAgICAgICAgICAgc3dpcGVPdXRFbC50cmlnZ2VyKCdvcGVuJyk7XG4gICAgICAgICAgICAgICAgICAgIHN3aXBlT3V0RWwuYWRkQ2xhc3MoJ3N3aXBlb3V0LW9wZW5lZCB0cmFuc2l0aW9uaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdUcmFuc2xhdGUgPSBkaXJlY3Rpb24gPT09ICd0by1sZWZ0JyA/IC1hY3Rpb25zV2lkdGggOiBhY3Rpb25zV2lkdGg7XG4gICAgICAgICAgICAgICAgICAgIHN3aXBlT3V0Q29udGVudC50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyBuZXdUcmFuc2xhdGUgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb25zLmFkZENsYXNzKCdzd2lwZW91dC1hY3Rpb25zLW9wZW5lZCcpO1xuICAgICAgICAgICAgICAgICAgICBidXR0b25zID0gZGlyZWN0aW9uID09PSAndG8tbGVmdCcgPyBidXR0b25zUmlnaHQgOiBidXR0b25zTGVmdDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJ1dHRvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBidXR0b25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJChidXR0b25zW2ldKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyBuZXdUcmFuc2xhdGUgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChvdmVyc3dpcGVSaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uc1JpZ2h0LmZpbmQoJy5zd2lwZW91dC1vdmVyc3dpcGUnKVswXS5jbGljaygpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChvdmVyc3dpcGVMZWZ0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb25zTGVmdC5maW5kKCcuc3dpcGVvdXQtb3ZlcnN3aXBlJylbMF0uY2xpY2soKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc3dpcGVPdXRFbC50cmlnZ2VyKCdjbG9zZScpO1xuICAgICAgICAgICAgICAgICAgICBhcHAuc3dpcGVvdXRPcGVuZWRFbCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgc3dpcGVPdXRFbC5hZGRDbGFzcygndHJhbnNpdGlvbmluZycpLnJlbW92ZUNsYXNzKCdzd2lwZW91dC1vcGVuZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgc3dpcGVPdXRDb250ZW50LnRyYW5zZm9ybSgnJyk7XG4gICAgICAgICAgICAgICAgICAgIGFjdGlvbnMucmVtb3ZlQ2xhc3MoJ3N3aXBlb3V0LWFjdGlvbnMtb3BlbmVkJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBidXR0b25PZmZzZXQ7XG4gICAgICAgICAgICAgICAgaWYgKGJ1dHRvbnNMZWZ0ICYmIGJ1dHRvbnNMZWZ0Lmxlbmd0aCA+IDAgJiYgYnV0dG9uc0xlZnQgIT09IGJ1dHRvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJ1dHRvbnNMZWZ0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBidXR0b25PZmZzZXQgPSBidXR0b25zTGVmdFtpXS5fYnV0dG9uT2Zmc2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBidXR0b25PZmZzZXQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uc0xlZnRbaV0uX2J1dHRvbk9mZnNldCA9IGFjdGlvbnNMZWZ0V2lkdGggLSBidXR0b25zTGVmdFtpXS5vZmZzZXRMZWZ0IC0gYnV0dG9uc0xlZnRbaV0ub2Zmc2V0V2lkdGg7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAkKGJ1dHRvbnNMZWZ0W2ldKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAoYnV0dG9uT2Zmc2V0KSArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGJ1dHRvbnNSaWdodCAmJiBidXR0b25zUmlnaHQubGVuZ3RoID4gMCAmJiBidXR0b25zUmlnaHQgIT09IGJ1dHRvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJ1dHRvbnNSaWdodC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uT2Zmc2V0ID0gYnV0dG9uc1JpZ2h0W2ldLl9idXR0b25PZmZzZXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGJ1dHRvbk9mZnNldCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25zUmlnaHRbaV0uX2J1dHRvbk9mZnNldCA9IGJ1dHRvbnNSaWdodFtpXS5vZmZzZXRMZWZ0O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgJChidXR0b25zUmlnaHRbaV0pLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArICgtYnV0dG9uT2Zmc2V0KSArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc3dpcGVPdXRDb250ZW50LnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wZW5lZCAmJiBhY3Rpb24gPT09ICdvcGVuJyB8fCBjbG9zZWQgJiYgYWN0aW9uID09PSAnY2xvc2UnKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIHN3aXBlT3V0RWwudHJpZ2dlcihhY3Rpb24gPT09ICdvcGVuJyA/ICdvcGVuZWQnIDogJ2Nsb3NlZCcpO1xuICAgICAgICAgICAgICAgICAgICBpZiAob3BlbmVkICYmIGFjdGlvbiA9PT0gJ2Nsb3NlJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGlvbnNSaWdodC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uc1JpZ2h0LnRyYW5zZm9ybSgnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aW9uc0xlZnQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbnNMZWZ0LnRyYW5zZm9ybSgnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzd2lwZW91dEVsKSB7XG4gICAgICAgICAgICAgICAgJChzd2lwZW91dEVsKS5vbihhcHAudG91Y2hFdmVudHMuc3RhcnQsIGhhbmRsZVRvdWNoU3RhcnQpO1xuICAgICAgICAgICAgICAgICQoc3dpcGVvdXRFbCkub24oYXBwLnRvdWNoRXZlbnRzLm1vdmUsIGhhbmRsZVRvdWNoTW92ZSk7XG4gICAgICAgICAgICAgICAgJChzd2lwZW91dEVsKS5vbihhcHAudG91Y2hFdmVudHMuZW5kLCBoYW5kbGVUb3VjaEVuZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vbihhcHAudG91Y2hFdmVudHMuc3RhcnQsICcubGlzdC1ibG9jayBsaS5zd2lwZW91dCcsIGhhbmRsZVRvdWNoU3RhcnQpO1xuICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKGFwcC50b3VjaEV2ZW50cy5tb3ZlLCAnLmxpc3QtYmxvY2sgbGkuc3dpcGVvdXQnLCBoYW5kbGVUb3VjaE1vdmUpO1xuICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKGFwcC50b3VjaEV2ZW50cy5lbmQsICcubGlzdC1ibG9jayBsaS5zd2lwZW91dCcsIGhhbmRsZVRvdWNoRW5kKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnN3aXBlb3V0T3BlbiA9IGZ1bmN0aW9uIChlbCwgZGlyLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgZWwgPSAkKGVsKTtcbiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBkaXI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmIChlbC5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIGlmIChlbC5sZW5ndGggPiAxKSBlbCA9ICQoZWxbMF0pO1xuICAgICAgICAgICAgaWYgKCFlbC5oYXNDbGFzcygnc3dpcGVvdXQnKSB8fCBlbC5oYXNDbGFzcygnc3dpcGVvdXQtb3BlbmVkJykpIHJldHVybjtcbiAgICAgICAgICAgIGlmICghZGlyKSB7XG4gICAgICAgICAgICAgICAgaWYgKGVsLmZpbmQoJy5zd2lwZW91dC1hY3Rpb25zLXJpZ2h0JykubGVuZ3RoID4gMCkgZGlyID0gJ3JpZ2h0JztcbiAgICAgICAgICAgICAgICBlbHNlIGRpciA9ICdsZWZ0JztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBzd2lwZU91dEFjdGlvbnMgPSBlbC5maW5kKCcuc3dpcGVvdXQtYWN0aW9ucy0nICsgZGlyKTtcbiAgICAgICAgICAgIGlmIChzd2lwZU91dEFjdGlvbnMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICB2YXIgbm9Gb2xkID0gc3dpcGVPdXRBY3Rpb25zLmhhc0NsYXNzKCdzd2lwZW91dC1hY3Rpb25zLW5vLWZvbGQnKSB8fCBhcHAucGFyYW1zLnN3aXBlb3V0QWN0aW9uc05vRm9sZDtcbiAgICAgICAgICAgIGVsLnRyaWdnZXIoJ29wZW4nKS5hZGRDbGFzcygnc3dpcGVvdXQtb3BlbmVkJykucmVtb3ZlQ2xhc3MoJ3RyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgICAgIHN3aXBlT3V0QWN0aW9ucy5hZGRDbGFzcygnc3dpcGVvdXQtYWN0aW9ucy1vcGVuZWQnKTtcbiAgICAgICAgICAgIHZhciBidXR0b25zID0gc3dpcGVPdXRBY3Rpb25zLmNoaWxkcmVuKCdhJyk7XG4gICAgICAgICAgICB2YXIgc3dpcGVPdXRBY3Rpb25zV2lkdGggPSBzd2lwZU91dEFjdGlvbnMub3V0ZXJXaWR0aCgpO1xuICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZSA9IGRpciA9PT0gJ3JpZ2h0JyA/IC1zd2lwZU91dEFjdGlvbnNXaWR0aCA6IHN3aXBlT3V0QWN0aW9uc1dpZHRoO1xuICAgICAgICAgICAgdmFyIGk7XG4gICAgICAgICAgICBpZiAoYnV0dG9ucy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJ1dHRvbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRpciA9PT0gJ3JpZ2h0Jykge1xuICAgICAgICAgICAgICAgICAgICAgICAgJChidXR0b25zW2ldKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAoLSBidXR0b25zW2ldLm9mZnNldExlZnQpICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoYnV0dG9uc1tpXSkuY3NzKCd6LWluZGV4JywgYnV0dG9ucy5sZW5ndGggLSBpKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAoc3dpcGVPdXRBY3Rpb25zV2lkdGggLSBidXR0b25zW2ldLm9mZnNldFdpZHRoIC0gYnV0dG9uc1tpXS5vZmZzZXRMZWZ0KSArICdweCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIGNsaWVudExlZnQgPSBidXR0b25zWzFdLmNsaWVudExlZnQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbC5hZGRDbGFzcygndHJhbnNpdGlvbmluZycpO1xuICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJ1dHRvbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAkKGJ1dHRvbnNbaV0pLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArICh0cmFuc2xhdGUpICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsLmZpbmQoJy5zd2lwZW91dC1jb250ZW50JykudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgdHJhbnNsYXRlICsgJ3B4LDAsMCknKS50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBlbC50cmlnZ2VyKCdvcGVuZWQnKTtcbiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrLmNhbGwoZWxbMF0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBhcHAuc3dpcGVvdXRPcGVuZWRFbCA9IGVsO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuc3dpcGVvdXRDbG9zZSA9IGZ1bmN0aW9uIChlbCwgY2FsbGJhY2spIHtcbiAgICAgICAgICAgIGVsID0gJChlbCk7XG4gICAgICAgICAgICBpZiAoZWwubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoIWVsLmhhc0NsYXNzKCdzd2lwZW91dC1vcGVuZWQnKSkgcmV0dXJuO1xuICAgICAgICAgICAgdmFyIGRpciA9IGVsLmZpbmQoJy5zd2lwZW91dC1hY3Rpb25zLW9wZW5lZCcpLmhhc0NsYXNzKCdzd2lwZW91dC1hY3Rpb25zLXJpZ2h0JykgPyAncmlnaHQnIDogJ2xlZnQnO1xuICAgICAgICAgICAgdmFyIHN3aXBlT3V0QWN0aW9ucyA9IGVsLmZpbmQoJy5zd2lwZW91dC1hY3Rpb25zLW9wZW5lZCcpLnJlbW92ZUNsYXNzKCdzd2lwZW91dC1hY3Rpb25zLW9wZW5lZCcpO1xuICAgICAgICAgICAgdmFyIG5vRm9sZCA9IHN3aXBlT3V0QWN0aW9ucy5oYXNDbGFzcygnc3dpcGVvdXQtYWN0aW9ucy1uby1mb2xkJykgfHwgYXBwLnBhcmFtcy5zd2lwZW91dEFjdGlvbnNOb0ZvbGQ7XG4gICAgICAgICAgICB2YXIgYnV0dG9ucyA9IHN3aXBlT3V0QWN0aW9ucy5jaGlsZHJlbignYScpO1xuICAgICAgICAgICAgdmFyIHN3aXBlT3V0QWN0aW9uc1dpZHRoID0gc3dpcGVPdXRBY3Rpb25zLm91dGVyV2lkdGgoKTtcbiAgICAgICAgICAgIGFwcC5hbGxvd1N3aXBlb3V0ID0gZmFsc2U7XG4gICAgICAgICAgICBlbC50cmlnZ2VyKCdjbG9zZScpO1xuICAgICAgICAgICAgZWwucmVtb3ZlQ2xhc3MoJ3N3aXBlb3V0LW9wZW5lZCcpLmFkZENsYXNzKCd0cmFuc2l0aW9uaW5nJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIGNsb3NlVE87XG4gICAgICAgICAgICBmdW5jdGlvbiBvblN3aXBlb3V0Q2xvc2UoKSB7XG4gICAgICAgICAgICAgICAgYXBwLmFsbG93U3dpcGVvdXQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmIChlbC5oYXNDbGFzcygnc3dpcGVvdXQtb3BlbmVkJykpIHJldHVybjtcbiAgICAgICAgICAgICAgICBlbC5yZW1vdmVDbGFzcygndHJhbnNpdGlvbmluZycpO1xuICAgICAgICAgICAgICAgIGJ1dHRvbnMudHJhbnNmb3JtKCcnKTtcbiAgICAgICAgICAgICAgICBlbC50cmlnZ2VyKCdjbG9zZWQnKTtcbiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrLmNhbGwoZWxbMF0pO1xuICAgICAgICAgICAgICAgIGlmIChjbG9zZVRPKSBjbGVhclRpbWVvdXQoY2xvc2VUTyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbC5maW5kKCcuc3dpcGVvdXQtY29udGVudCcpLnRyYW5zZm9ybSgnJykudHJhbnNpdGlvbkVuZChvblN3aXBlb3V0Q2xvc2UpO1xuICAgICAgICAgICAgY2xvc2VUTyA9IHNldFRpbWVvdXQob25Td2lwZW91dENsb3NlLCA1MDApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGJ1dHRvbnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAoZGlyID09PSAncmlnaHQnKSB7XG4gICAgICAgICAgICAgICAgICAgICQoYnV0dG9uc1tpXSkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKC1idXR0b25zW2ldLm9mZnNldExlZnQpICsgJ3B4LDAsMCknKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICQoYnV0dG9uc1tpXSkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHN3aXBlT3V0QWN0aW9uc1dpZHRoIC0gYnV0dG9uc1tpXS5vZmZzZXRXaWR0aCAtIGJ1dHRvbnNbaV0ub2Zmc2V0TGVmdCkgKyAncHgsMCwwKScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAkKGJ1dHRvbnNbaV0pLmNzcyh7bGVmdDowICsgJ3B4J30pLnJlbW92ZUNsYXNzKCdzd2lwZW91dC1vdmVyc3dpcGUtYWN0aXZlJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXBwLnN3aXBlb3V0T3BlbmVkRWwgJiYgYXBwLnN3aXBlb3V0T3BlbmVkRWxbMF0gPT09IGVsWzBdKSBhcHAuc3dpcGVvdXRPcGVuZWRFbCA9IHVuZGVmaW5lZDtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnN3aXBlb3V0RGVsZXRlID0gZnVuY3Rpb24gKGVsLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgZWwgPSAkKGVsKTtcbiAgICAgICAgICAgIGlmIChlbC5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIGlmIChlbC5sZW5ndGggPiAxKSBlbCA9ICQoZWxbMF0pO1xuICAgICAgICAgICAgYXBwLnN3aXBlb3V0T3BlbmVkRWwgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICBlbC50cmlnZ2VyKCdkZWxldGUnKTtcbiAgICAgICAgICAgIGVsLmNzcyh7aGVpZ2h0OiBlbC5vdXRlckhlaWdodCgpICsgJ3B4J30pO1xuICAgICAgICAgICAgdmFyIGNsaWVudExlZnQgPSBlbFswXS5jbGllbnRMZWZ0O1xuICAgICAgICAgICAgZWwuY3NzKHtoZWlnaHQ6IDAgKyAncHgnfSkuYWRkQ2xhc3MoJ2RlbGV0aW5nIHRyYW5zaXRpb25pbmcnKS50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBlbC50cmlnZ2VyKCdkZWxldGVkJyk7XG4gICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjay5jYWxsKGVsWzBdKTtcbiAgICAgICAgICAgICAgICBpZiAoZWwucGFyZW50cygnLnZpcnR1YWwtbGlzdCcpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHZpcnR1YWxMaXN0ID0gZWwucGFyZW50cygnLnZpcnR1YWwtbGlzdCcpWzBdLmY3VmlydHVhbExpc3Q7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2aXJ0dWFsSW5kZXggPSBlbFswXS5mN1ZpcnR1YWxMaXN0SW5kZXg7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2aXJ0dWFsTGlzdCAmJiB0eXBlb2YgdmlydHVhbEluZGV4ICE9PSAndW5kZWZpbmVkJykgdmlydHVhbExpc3QuZGVsZXRlSXRlbSh2aXJ0dWFsSW5kZXgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZWwucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB2YXIgdHJhbnNsYXRlID0gJy0xMDAlJztcbiAgICAgICAgICAgIGVsLmZpbmQoJy5zd2lwZW91dC1jb250ZW50JykudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgdHJhbnNsYXRlICsgJywwLDApJyk7XG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBTb3J0YWJsZSAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLnNvcnRhYmxlVG9nZ2xlID0gZnVuY3Rpb24gKHNvcnRhYmxlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBzb3J0YWJsZUNvbnRhaW5lciA9ICQoc29ydGFibGVDb250YWluZXIpO1xuICAgICAgICAgICAgaWYgKHNvcnRhYmxlQ29udGFpbmVyLmxlbmd0aCA9PT0gMCkgc29ydGFibGVDb250YWluZXIgPSAkKCcubGlzdC1ibG9jay5zb3J0YWJsZScpO1xuICAgICAgICAgICAgc29ydGFibGVDb250YWluZXIudG9nZ2xlQ2xhc3MoJ3NvcnRhYmxlLW9wZW5lZCcpO1xuICAgICAgICAgICAgaWYgKHNvcnRhYmxlQ29udGFpbmVyLmhhc0NsYXNzKCdzb3J0YWJsZS1vcGVuZWQnKSkge1xuICAgICAgICAgICAgICAgIHNvcnRhYmxlQ29udGFpbmVyLnRyaWdnZXIoJ29wZW4nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHNvcnRhYmxlQ29udGFpbmVyLnRyaWdnZXIoJ2Nsb3NlJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gc29ydGFibGVDb250YWluZXI7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5zb3J0YWJsZU9wZW4gPSBmdW5jdGlvbiAoc29ydGFibGVDb250YWluZXIpIHtcbiAgICAgICAgICAgIHNvcnRhYmxlQ29udGFpbmVyID0gJChzb3J0YWJsZUNvbnRhaW5lcik7XG4gICAgICAgICAgICBpZiAoc29ydGFibGVDb250YWluZXIubGVuZ3RoID09PSAwKSBzb3J0YWJsZUNvbnRhaW5lciA9ICQoJy5saXN0LWJsb2NrLnNvcnRhYmxlJyk7XG4gICAgICAgICAgICBzb3J0YWJsZUNvbnRhaW5lci5hZGRDbGFzcygnc29ydGFibGUtb3BlbmVkJyk7XG4gICAgICAgICAgICBzb3J0YWJsZUNvbnRhaW5lci50cmlnZ2VyKCdvcGVuJyk7XG4gICAgICAgICAgICByZXR1cm4gc29ydGFibGVDb250YWluZXI7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5zb3J0YWJsZUNsb3NlID0gZnVuY3Rpb24gKHNvcnRhYmxlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBzb3J0YWJsZUNvbnRhaW5lciA9ICQoc29ydGFibGVDb250YWluZXIpO1xuICAgICAgICAgICAgaWYgKHNvcnRhYmxlQ29udGFpbmVyLmxlbmd0aCA9PT0gMCkgc29ydGFibGVDb250YWluZXIgPSAkKCcubGlzdC1ibG9jay5zb3J0YWJsZScpO1xuICAgICAgICAgICAgc29ydGFibGVDb250YWluZXIucmVtb3ZlQ2xhc3MoJ3NvcnRhYmxlLW9wZW5lZCcpO1xuICAgICAgICAgICAgc29ydGFibGVDb250YWluZXIudHJpZ2dlcignY2xvc2UnKTtcbiAgICAgICAgICAgIHJldHVybiBzb3J0YWJsZUNvbnRhaW5lcjtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmluaXRTb3J0YWJsZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBpc1RvdWNoZWQsIGlzTW92ZWQsIHRvdWNoU3RhcnRZLCB0b3VjaGVzRGlmZiwgc29ydGluZ0VsLCBzb3J0aW5nRWxIZWlnaHQsIHNvcnRpbmdJdGVtcywgbWluVG9wLCBtYXhUb3AsIGluc2VydEFmdGVyLCBpbnNlcnRCZWZvcmUsIHNvcnRhYmxlQ29udGFpbmVyO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KGUpIHtcbiAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0b3VjaFN0YXJ0WSA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqL1xuICAgICAgICAgICAgICAgIHNvcnRpbmdFbCA9ICQodGhpcykucGFyZW50KCk7XG4gICAgICAgICAgICAgICAgc29ydGluZ0l0ZW1zID0gc29ydGluZ0VsLnBhcmVudCgpLmZpbmQoJ2xpJyk7XG4gICAgICAgICAgICAgICAgc29ydGFibGVDb250YWluZXIgPSBzb3J0aW5nRWwucGFyZW50cygnLnNvcnRhYmxlJyk7XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGFwcC5hbGxvd1BhbmVsT3BlbiA9IGFwcC5hbGxvd1N3aXBlb3V0ID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoZSkge1xuICAgICAgICAgICAgICAgIGlmICghaXNUb3VjaGVkIHx8ICFzb3J0aW5nRWwpIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgcGFnZVggPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZS5wYWdlWDtcbiAgICAgICAgICAgICAgICB2YXIgcGFnZVkgPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICBpZiAoIWlzTW92ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgc29ydGluZ0VsLmFkZENsYXNzKCdzb3J0aW5nJyk7XG4gICAgICAgICAgICAgICAgICAgIHNvcnRhYmxlQ29udGFpbmVyLmFkZENsYXNzKCdzb3J0YWJsZS1zb3J0aW5nJyk7XG4gICAgICAgICAgICAgICAgICAgIG1pblRvcCA9IHNvcnRpbmdFbFswXS5vZmZzZXRUb3A7XG4gICAgICAgICAgICAgICAgICAgIG1heFRvcCA9IHNvcnRpbmdFbC5wYXJlbnQoKS5oZWlnaHQoKSAtIHNvcnRpbmdFbFswXS5vZmZzZXRUb3AgLSBzb3J0aW5nRWwuaGVpZ2h0KCk7XG4gICAgICAgICAgICAgICAgICAgIHNvcnRpbmdFbEhlaWdodCA9IHNvcnRpbmdFbFswXS5vZmZzZXRIZWlnaHQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlzTW92ZWQgPSB0cnVlO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgZS5mN1ByZXZlbnRQYW5lbFN3aXBlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0b3VjaGVzRGlmZiA9IHBhZ2VZIC0gdG91Y2hTdGFydFk7XG4gICAgICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZSA9IHRvdWNoZXNEaWZmO1xuICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGUgPCAtbWluVG9wKSB0cmFuc2xhdGUgPSAtbWluVG9wO1xuICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGUgPiBtYXhUb3ApIHRyYW5zbGF0ZSA9IG1heFRvcDtcbiAgICAgICAgICAgICAgICBzb3J0aW5nRWwudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLCcgKyB0cmFuc2xhdGUgKyAncHgsMCknKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaW5zZXJ0QmVmb3JlID0gaW5zZXJ0QWZ0ZXIgPSB1bmRlZmluZWQ7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHNvcnRpbmdJdGVtcy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRFbCA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50RWxbMF0gPT09IHNvcnRpbmdFbFswXSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB2YXIgY3VycmVudEVsT2Zmc2V0ID0gY3VycmVudEVsWzBdLm9mZnNldFRvcDtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGN1cnJlbnRFbEhlaWdodCA9IGN1cnJlbnRFbC5oZWlnaHQoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNvcnRpbmdFbE9mZnNldCA9IHNvcnRpbmdFbFswXS5vZmZzZXRUb3AgKyB0cmFuc2xhdGU7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoKHNvcnRpbmdFbE9mZnNldCA+PSBjdXJyZW50RWxPZmZzZXQgLSBjdXJyZW50RWxIZWlnaHQgLyAyKSAmJiBzb3J0aW5nRWwuaW5kZXgoKSA8IGN1cnJlbnRFbC5pbmRleCgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50RWwudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLCAnKygtc29ydGluZ0VsSGVpZ2h0KSsncHgsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydEFmdGVyID0gY3VycmVudEVsO1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0QmVmb3JlID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKChzb3J0aW5nRWxPZmZzZXQgPD0gY3VycmVudEVsT2Zmc2V0ICsgY3VycmVudEVsSGVpZ2h0IC8gMikgJiYgc29ydGluZ0VsLmluZGV4KCkgPiBjdXJyZW50RWwuaW5kZXgoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEVsLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwgJysoc29ydGluZ0VsSGVpZ2h0KSsncHgsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydEFmdGVyID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpbnNlcnRCZWZvcmUpIGluc2VydEJlZm9yZSA9IGN1cnJlbnRFbDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQodGhpcykudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLCAwJSwwKScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaEVuZChlKSB7XG4gICAgICAgICAgICAgICAgYXBwLmFsbG93UGFuZWxPcGVuID0gYXBwLmFsbG93U3dpcGVvdXQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmICghaXNUb3VjaGVkIHx8ICFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIHNvcnRpbmdJdGVtcy50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgICAgIHNvcnRpbmdFbC5yZW1vdmVDbGFzcygnc29ydGluZycpO1xuICAgICAgICAgICAgICAgIHNvcnRhYmxlQ29udGFpbmVyLnJlbW92ZUNsYXNzKCdzb3J0YWJsZS1zb3J0aW5nJyk7XG4gICAgICAgICAgICAgICAgdmFyIHZpcnR1YWxMaXN0LCBvbGRJbmRleCwgbmV3SW5kZXg7XG4gICAgICAgICAgICAgICAgaWYgKGluc2VydEFmdGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHNvcnRpbmdFbC5pbnNlcnRBZnRlcihpbnNlcnRBZnRlcik7XG4gICAgICAgICAgICAgICAgICAgIHNvcnRpbmdFbC50cmlnZ2VyKCdzb3J0Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChpbnNlcnRCZWZvcmUpIHtcbiAgICAgICAgICAgICAgICAgICAgc29ydGluZ0VsLmluc2VydEJlZm9yZShpbnNlcnRCZWZvcmUpO1xuICAgICAgICAgICAgICAgICAgICBzb3J0aW5nRWwudHJpZ2dlcignc29ydCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoKGluc2VydEFmdGVyIHx8IGluc2VydEJlZm9yZSkgJiYgc29ydGFibGVDb250YWluZXIuaGFzQ2xhc3MoJ3ZpcnR1YWwtbGlzdCcpKSB7XG4gICAgICAgICAgICAgICAgICAgIHZpcnR1YWxMaXN0ID0gc29ydGFibGVDb250YWluZXJbMF0uZjdWaXJ0dWFsTGlzdDtcbiAgICAgICAgICAgICAgICAgICAgb2xkSW5kZXggPSBzb3J0aW5nRWxbMF0uZjdWaXJ0dWFsTGlzdEluZGV4O1xuICAgICAgICAgICAgICAgICAgICBuZXdJbmRleCA9IGluc2VydEJlZm9yZSA/IGluc2VydEJlZm9yZVswXS5mN1ZpcnR1YWxMaXN0SW5kZXggOiBpbnNlcnRBZnRlclswXS5mN1ZpcnR1YWxMaXN0SW5kZXg7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2aXJ0dWFsTGlzdCkgdmlydHVhbExpc3QubW92ZUl0ZW0ob2xkSW5kZXgsIG5ld0luZGV4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaW5zZXJ0QWZ0ZXIgPSBpbnNlcnRCZWZvcmUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgJChkb2N1bWVudCkub24oYXBwLnRvdWNoRXZlbnRzLnN0YXJ0LCAnLmxpc3QtYmxvY2suc29ydGFibGUgLnNvcnRhYmxlLWhhbmRsZXInLCBoYW5kbGVUb3VjaFN0YXJ0KTtcbiAgICAgICAgICAgIGlmIChhcHAuc3VwcG9ydC50b3VjaCkge1xuICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKGFwcC50b3VjaEV2ZW50cy5tb3ZlLCAnLmxpc3QtYmxvY2suc29ydGFibGUgLnNvcnRhYmxlLWhhbmRsZXInLCBoYW5kbGVUb3VjaE1vdmUpO1xuICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKGFwcC50b3VjaEV2ZW50cy5lbmQsICcubGlzdC1ibG9jay5zb3J0YWJsZSAuc29ydGFibGUtaGFuZGxlcicsIGhhbmRsZVRvdWNoRW5kKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKGFwcC50b3VjaEV2ZW50cy5tb3ZlLCBoYW5kbGVUb3VjaE1vdmUpO1xuICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKGFwcC50b3VjaEV2ZW50cy5lbmQsIGhhbmRsZVRvdWNoRW5kKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgfTtcbiAgICAgICAgXG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIFNtYXJ0IFNlbGVjdCAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLmluaXRTbWFydFNlbGVjdHMgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICB2YXIgc2VsZWN0cztcbiAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmlzKCcuc21hcnQtc2VsZWN0JykpIHtcbiAgICAgICAgICAgICAgICBzZWxlY3RzID0gcGFnZUNvbnRhaW5lcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHNlbGVjdHMgPSBwYWdlQ29udGFpbmVyLmZpbmQoJy5zbWFydC1zZWxlY3QnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzZWxlY3RzLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgIHNlbGVjdHMuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNtYXJ0U2VsZWN0ID0gJCh0aGlzKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyICRzZWxlY3QgPSBzbWFydFNlbGVjdC5maW5kKCdzZWxlY3QnKTtcbiAgICAgICAgICAgICAgICBpZiAoJHNlbGVjdC5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIHNlbGVjdCA9ICRzZWxlY3RbMF07XG4gICAgICAgICAgICAgICAgaWYgKHNlbGVjdC5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIHZhbHVlVGV4dCA9IFtdO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2VsZWN0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3RbaV0uc2VsZWN0ZWQpIHZhbHVlVGV4dC5wdXNoKHNlbGVjdFtpXS50ZXh0Q29udGVudC50cmltKCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIGl0ZW1BZnRlciA9IHNtYXJ0U2VsZWN0LmZpbmQoJy5pdGVtLWFmdGVyJyk7XG4gICAgICAgICAgICAgICAgaWYgKGl0ZW1BZnRlci5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgc21hcnRTZWxlY3QuZmluZCgnLml0ZW0taW5uZXInKS5hcHBlbmQoJzxkaXYgY2xhc3M9XCJpdGVtLWFmdGVyXCI+JyArIHZhbHVlVGV4dC5qb2luKCcsICcpICsgJzwvZGl2PicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNlbGVjdGVkVGV4dCA9IGl0ZW1BZnRlci50ZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtQWZ0ZXIuaGFzQ2xhc3MoJ3NtYXJ0LXNlbGVjdC12YWx1ZScpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc2VsZWN0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0W2ldLnNlbGVjdGVkID0gc2VsZWN0W2ldLnRleHRDb250ZW50LnRyaW0oKSA9PT0gc2VsZWN0ZWRUZXh0LnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1BZnRlci50ZXh0KHZhbHVlVGV4dC5qb2luKCcsICcpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgXG4gICAgICAgIH07XG4gICAgICAgIGFwcC5zbWFydFNlbGVjdEFkZE9wdGlvbiA9IGZ1bmN0aW9uIChzZWxlY3QsIG9wdGlvbiwgaW5kZXgpIHtcbiAgICAgICAgICAgIHNlbGVjdCA9ICQoc2VsZWN0KTtcbiAgICAgICAgICAgIHZhciBzbWFydFNlbGVjdCA9IHNlbGVjdC5wYXJlbnRzKCcuc21hcnQtc2VsZWN0Jyk7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGluZGV4ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIHNlbGVjdC5hcHBlbmQob3B0aW9uKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICQob3B0aW9uKS5pbnNlcnRCZWZvcmUoc2VsZWN0LmZpbmQoJ29wdGlvbicpLmVxKGluZGV4KSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhcHAuaW5pdFNtYXJ0U2VsZWN0cyhzbWFydFNlbGVjdCk7XG4gICAgICAgICAgICB2YXIgc2VsZWN0TmFtZSA9IHNtYXJ0U2VsZWN0LmZpbmQoJ3NlbGVjdCcpLmF0dHIoJ25hbWUnKTtcbiAgICAgICAgICAgIHZhciBvcGVuZWQgPSAkKCcucGFnZS5zbWFydC1zZWxlY3QtcGFnZVtkYXRhLXNlbGVjdC1uYW1lPVwiJyArIHNlbGVjdE5hbWUgKyAnXCJdJykubGVuZ3RoID4gMDtcbiAgICAgICAgICAgIGlmIChvcGVuZWQpIHtcbiAgICAgICAgICAgICAgICBhcHAuc21hcnRTZWxlY3RPcGVuKHNtYXJ0U2VsZWN0LCB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnNtYXJ0U2VsZWN0T3BlbiA9IGZ1bmN0aW9uIChzbWFydFNlbGVjdCwgcmVMYXlvdXQpIHtcbiAgICAgICAgICAgIHNtYXJ0U2VsZWN0ID0gJChzbWFydFNlbGVjdCk7XG4gICAgICAgICAgICBpZiAoc21hcnRTZWxlY3QubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRmluZCByZWxhdGVkIHZpZXdcbiAgICAgICAgICAgIHZhciB2aWV3ID0gc21hcnRTZWxlY3QucGFyZW50cygnLicgKyBhcHAucGFyYW1zLnZpZXdDbGFzcyk7XG4gICAgICAgICAgICBpZiAodmlldy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIHZpZXcgPSB2aWV3WzBdLmY3VmlldztcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQYXJhbWV0ZXJzXG4gICAgICAgICAgICB2YXIgb3BlbkluID0gc21hcnRTZWxlY3QuYXR0cignZGF0YS1vcGVuLWluJykgfHwgYXBwLnBhcmFtcy5zbWFydFNlbGVjdE9wZW5JbjtcbiAgICAgICAgICAgIGlmIChvcGVuSW4gPT09ICdwb3B1cCcpIHtcbiAgICAgICAgICAgICAgICBpZiAoJCgnLnBvcHVwLnNtYXJ0LXNlbGVjdC1wb3B1cCcpLmxlbmd0aCA+IDApIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKG9wZW5JbiA9PT0gJ3BpY2tlcicpIHtcbiAgICAgICAgICAgICAgICBpZiAoJCgnLnBpY2tlci1tb2RhbC5tb2RhbC1pbicpLmxlbmd0aCA+IDAgJiYgIXJlTGF5b3V0KXtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNtYXJ0U2VsZWN0WzBdLmY3U21hcnRTZWxlY3RQaWNrZXIgIT09ICQoJy5waWNrZXItbW9kYWwubW9kYWwtaW46bm90KC5tb2RhbC1vdXQpJylbMF0pIGFwcC5jbG9zZU1vZGFsKCQoJy5waWNrZXItbW9kYWwubW9kYWwtaW46bm90KC5tb2RhbC1vdXQpJykpO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoIXZpZXcpIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgc21hcnRTZWxlY3REYXRhID0gc21hcnRTZWxlY3QuZGF0YXNldCgpO1xuICAgICAgICAgICAgdmFyIHBhZ2VUaXRsZSA9IHNtYXJ0U2VsZWN0RGF0YS5wYWdlVGl0bGUgfHwgc21hcnRTZWxlY3QuZmluZCgnLml0ZW0tdGl0bGUnKS50ZXh0KCk7XG4gICAgICAgICAgICB2YXIgYmFja1RleHQgPSBzbWFydFNlbGVjdERhdGEuYmFja1RleHQgfHwgYXBwLnBhcmFtcy5zbWFydFNlbGVjdEJhY2tUZXh0O1xuICAgICAgICAgICAgdmFyIGNsb3NlVGV4dDtcbiAgICAgICAgICAgIGlmIChvcGVuSW4gPT09ICdwaWNrZXInKSB7XG4gICAgICAgICAgICAgICAgY2xvc2VUZXh0ID0gc21hcnRTZWxlY3REYXRhLnBpY2tlckNsb3NlVGV4dCB8fCBzbWFydFNlbGVjdERhdGEuYmFja1RleHQgfHwgYXBwLnBhcmFtcy5zbWFydFNlbGVjdFBpY2tlckNsb3NlVGV4dCA7ICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjbG9zZVRleHQgPSBzbWFydFNlbGVjdERhdGEucG9wdXBDbG9zZVRleHQgfHwgc21hcnRTZWxlY3REYXRhLmJhY2tUZXh0IHx8IGFwcC5wYXJhbXMuc21hcnRTZWxlY3RQb3B1cENsb3NlVGV4dCA7ICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgYmFja09uU2VsZWN0ID0gc21hcnRTZWxlY3REYXRhLmJhY2tPblNlbGVjdCAhPT0gdW5kZWZpbmVkID8gc21hcnRTZWxlY3REYXRhLmJhY2tPblNlbGVjdCA6IGFwcC5wYXJhbXMuc21hcnRTZWxlY3RCYWNrT25TZWxlY3Q7XG4gICAgICAgICAgICB2YXIgZm9ybVRoZW1lID0gc21hcnRTZWxlY3REYXRhLmZvcm1UaGVtZSB8fCBhcHAucGFyYW1zLnNtYXJ0U2VsZWN0Rm9ybVRoZW1lO1xuICAgICAgICAgICAgdmFyIG5hdmJhclRoZW1lID0gc21hcnRTZWxlY3REYXRhLm5hdmJhclRoZW1lIHx8IGFwcC5wYXJhbXMuc21hcnRTZWxlY3ROYXZiYXJUaGVtZTtcbiAgICAgICAgICAgIHZhciB0b29sYmFyVGhlbWUgPSBzbWFydFNlbGVjdERhdGEudG9vbGJhclRoZW1lIHx8IGFwcC5wYXJhbXMuc21hcnRTZWxlY3RUb29sYmFyVGhlbWU7XG4gICAgICAgICAgICB2YXIgdmlydHVhbExpc3QgPSBzbWFydFNlbGVjdERhdGEudmlydHVhbExpc3Q7XG4gICAgICAgICAgICB2YXIgdmlydHVhbExpc3RIZWlnaHQgPSBzbWFydFNlbGVjdERhdGEudmlydHVhbExpc3RIZWlnaHQ7XG4gICAgICAgICAgICB2YXIgbWF0ZXJpYWwgPSBhcHAucGFyYW1zLm1hdGVyaWFsO1xuICAgICAgICAgICAgdmFyIHBpY2tlckhlaWdodCA9IHNtYXJ0U2VsZWN0RGF0YS5waWNrZXJIZWlnaHQgfHwgYXBwLnBhcmFtcy5zbWFydFNlbGVjdFBpY2tlckhlaWdodDtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDb2xsZWN0IGFsbCBvcHRpb25zL3ZhbHVlc1xuICAgICAgICAgICAgdmFyIHNlbGVjdCA9IHNtYXJ0U2VsZWN0LmZpbmQoJ3NlbGVjdCcpWzBdO1xuICAgICAgICAgICAgdmFyICRzZWxlY3QgPSAkKHNlbGVjdCk7XG4gICAgICAgICAgICB2YXIgJHNlbGVjdERhdGEgPSAkc2VsZWN0LmRhdGFzZXQoKTtcbiAgICAgICAgICAgIGlmIChzZWxlY3QuZGlzYWJsZWQgfHwgc21hcnRTZWxlY3QuaGFzQ2xhc3MoJ2Rpc2FibGVkJykgfHwgJHNlbGVjdC5oYXNDbGFzcygnZGlzYWJsZWQnKSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciB2YWx1ZXMgPSBbXTtcbiAgICAgICAgICAgIHZhciBpZCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICB2YXIgaW5wdXRUeXBlID0gc2VsZWN0Lm11bHRpcGxlID8gJ2NoZWNrYm94JyA6ICdyYWRpbyc7XG4gICAgICAgICAgICB2YXIgaW5wdXROYW1lID0gaW5wdXRUeXBlICsgJy0nICsgaWQ7XG4gICAgICAgICAgICB2YXIgbWF4TGVuZ3RoID0gJHNlbGVjdC5hdHRyKCdtYXhsZW5ndGgnKTtcbiAgICAgICAgICAgIHZhciBzZWxlY3ROYW1lID0gc2VsZWN0Lm5hbWU7XG4gICAgICAgICAgICB2YXIgb3B0aW9uLCBvcHRpb25IYXNNZWRpYSwgb3B0aW9uSW1hZ2UsIG9wdGlvbkljb24sIG9wdGlvbkdyb3VwLCBvcHRpb25Hcm91cExhYmVsLCBvcHRpb25QcmV2aW91c0dyb3VwLCBvcHRpb25Jc0xhYmVsLCBwcmV2aW91c0dyb3VwLCBvcHRpb25Db2xvciwgb3B0aW9uQ2xhc3NOYW1lLCBvcHRpb25EYXRhO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzZWxlY3QubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBvcHRpb24gPSAkKHNlbGVjdFtpXSk7XG4gICAgICAgICAgICAgICAgb3B0aW9uRGF0YSA9IG9wdGlvbi5kYXRhc2V0KCk7XG4gICAgICAgICAgICAgICAgb3B0aW9uSW1hZ2UgPSBvcHRpb25EYXRhLm9wdGlvbkltYWdlIHx8ICRzZWxlY3REYXRhLm9wdGlvbkltYWdlIHx8IHNtYXJ0U2VsZWN0RGF0YS5vcHRpb25JbWFnZTtcbiAgICAgICAgICAgICAgICBvcHRpb25JY29uID0gb3B0aW9uRGF0YS5vcHRpb25JY29uIHx8ICRzZWxlY3REYXRhLm9wdGlvbkljb24gfHwgc21hcnRTZWxlY3REYXRhLm9wdGlvbkljb247XG4gICAgICAgICAgICAgICAgb3B0aW9uSGFzTWVkaWEgPSBvcHRpb25JbWFnZSB8fCBvcHRpb25JY29uIHx8IGlucHV0VHlwZSA9PT0gJ2NoZWNrYm94JztcbiAgICAgICAgICAgICAgICBpZiAobWF0ZXJpYWwpIG9wdGlvbkhhc01lZGlhID0gb3B0aW9uSW1hZ2UgfHwgb3B0aW9uSWNvbjtcbiAgICAgICAgICAgICAgICBvcHRpb25Db2xvciA9IG9wdGlvbkRhdGEub3B0aW9uQ29sb3I7XG4gICAgICAgICAgICAgICAgb3B0aW9uQ2xhc3NOYW1lID0gb3B0aW9uRGF0YS5vcHRpb25DbGFzcztcbiAgICAgICAgICAgICAgICBpZiAob3B0aW9uWzBdLmRpc2FibGVkKSBvcHRpb25DbGFzc05hbWUgKz0gJyBkaXNhYmxlZCc7XG4gICAgICAgICAgICAgICAgb3B0aW9uR3JvdXAgPSBvcHRpb24ucGFyZW50KCdvcHRncm91cCcpWzBdO1xuICAgICAgICAgICAgICAgIG9wdGlvbkdyb3VwTGFiZWwgPSBvcHRpb25Hcm91cCAmJiBvcHRpb25Hcm91cC5sYWJlbDtcbiAgICAgICAgICAgICAgICBvcHRpb25Jc0xhYmVsID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbkdyb3VwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25Hcm91cCAhPT0gcHJldmlvdXNHcm91cCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uSXNMYWJlbCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcmV2aW91c0dyb3VwID0gb3B0aW9uR3JvdXA7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBMYWJlbDogb3B0aW9uR3JvdXBMYWJlbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc0xhYmVsOiBvcHRpb25Jc0xhYmVsXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YWx1ZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiBvcHRpb25bMF0udmFsdWUsXG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IG9wdGlvblswXS50ZXh0Q29udGVudC50cmltKCksXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBvcHRpb25bMF0uc2VsZWN0ZWQsXG4gICAgICAgICAgICAgICAgICAgIGdyb3VwOiBvcHRpb25Hcm91cCxcbiAgICAgICAgICAgICAgICAgICAgZ3JvdXBMYWJlbDogb3B0aW9uR3JvdXBMYWJlbCxcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2U6IG9wdGlvbkltYWdlLFxuICAgICAgICAgICAgICAgICAgICBpY29uOiBvcHRpb25JY29uLFxuICAgICAgICAgICAgICAgICAgICBjb2xvcjogb3B0aW9uQ29sb3IsXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogb3B0aW9uQ2xhc3NOYW1lLFxuICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZDogb3B0aW9uWzBdLmRpc2FibGVkLFxuICAgICAgICAgICAgICAgICAgICBpbnB1dFR5cGU6IGlucHV0VHlwZSxcbiAgICAgICAgICAgICAgICAgICAgaWQ6IGlkLFxuICAgICAgICAgICAgICAgICAgICBoYXNNZWRpYTogb3B0aW9uSGFzTWVkaWEsXG4gICAgICAgICAgICAgICAgICAgIGNoZWNrYm94OiBpbnB1dFR5cGUgPT09ICdjaGVja2JveCcsXG4gICAgICAgICAgICAgICAgICAgIGlucHV0TmFtZTogaW5wdXROYW1lLFxuICAgICAgICAgICAgICAgICAgICBtYXRlcmlhbDogYXBwLnBhcmFtcy5tYXRlcmlhbFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJdGVtIHRlbXBsYXRlL0hUTUxcbiAgICAgICAgICAgIGlmICghYXBwLl9jb21waWxlZFRlbXBsYXRlcy5zbWFydFNlbGVjdEl0ZW0pIHtcbiAgICAgICAgICAgICAgICBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLnNtYXJ0U2VsZWN0SXRlbSA9IHQ3LmNvbXBpbGUoYXBwLnBhcmFtcy5zbWFydFNlbGVjdEl0ZW1UZW1wbGF0ZSB8fCBcbiAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIGlzTGFiZWx9fScgK1xuICAgICAgICAgICAgICAgICAgICAnPGxpIGNsYXNzPVwiaXRlbS1kaXZpZGVyXCI+e3tncm91cExhYmVsfX08L2xpPicgK1xuICAgICAgICAgICAgICAgICAgICAne3tlbHNlfX0nICtcbiAgICAgICAgICAgICAgICAgICAgJzxsaXt7I2lmIGNsYXNzTmFtZX19IGNsYXNzPVwie3tjbGFzc05hbWV9fVwie3svaWZ9fT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8bGFiZWwgY2xhc3M9XCJsYWJlbC17e2lucHV0VHlwZX19IGl0ZW0tY29udGVudFwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8aW5wdXQgdHlwZT1cInt7aW5wdXRUeXBlfX1cIiBuYW1lPVwie3tpbnB1dE5hbWV9fVwiIHZhbHVlPVwie3t2YWx1ZX19XCIge3sjaWYgc2VsZWN0ZWR9fWNoZWNrZWR7ey9pZn19PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBtYXRlcmlhbH19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBoYXNNZWRpYX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1tZWRpYVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIGljb259fTxpIGNsYXNzPVwiaWNvbiB7e2ljb259fVwiPjwvaT57ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgaW1hZ2V9fTxpbWcgc3JjPVwie3tpbWFnZX19XCI+e3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLXRpdGxle3sjaWYgY29sb3J9fSBjb2xvci17e2NvbG9yfX17ey9pZn19XCI+e3t0ZXh0fX08L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tYWZ0ZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8aSBjbGFzcz1cImljb24gaWNvbi1mb3JtLXt7aW5wdXRUeXBlfX1cIj48L2k+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7ZWxzZX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1tZWRpYVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxpIGNsYXNzPVwiaWNvbiBpY29uLWZvcm0te3tpbnB1dFR5cGV9fVwiPjwvaT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0taW5uZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS10aXRsZXt7I2lmIGNvbG9yfX0gY29sb3Ite3tjb2xvcn19e3svaWZ9fVwiPnt7dGV4dH19PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3tlbHNlfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIGhhc01lZGlhfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLW1lZGlhXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgY2hlY2tib3h9fTxpIGNsYXNzPVwiaWNvbiBpY29uLWZvcm0tY2hlY2tib3hcIj48L2k+e3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIGljb259fTxpIGNsYXNzPVwiaWNvbiB7e2ljb259fVwiPjwvaT57ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgaW1hZ2V9fTxpbWcgc3JjPVwie3tpbWFnZX19XCI+e3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLXRpdGxle3sjaWYgY29sb3J9fSBjb2xvci17e2NvbG9yfX17ey9pZn19XCI+e3t0ZXh0fX08L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9sYWJlbD4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvbGk+JyArXG4gICAgICAgICAgICAgICAgICAgICd7ey9pZn19J1xuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgc21hcnRTZWxlY3RJdGVtVGVtcGxhdGUgPSBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLnNtYXJ0U2VsZWN0SXRlbTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdmFyIGlucHV0c0hUTUwgPSAnJztcbiAgICAgICAgICAgIGlmICghdmlydHVhbExpc3QpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHZhbHVlcy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICBpbnB1dHNIVE1MICs9IHNtYXJ0U2VsZWN0SXRlbVRlbXBsYXRlKHZhbHVlc1tqXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFRvb2xiYXIgLyBOYXZiYXJcbiAgICAgICAgICAgIHZhciB0b29sYmFySFRNTCA9ICcnLCBuYXZiYXJIVE1MO1xuICAgICAgICAgICAgdmFyIG5vTmF2YmFyID0gJycsIG5vVG9vbGJhciA9ICcnLCBub1RhYmJhciA9ICcnLCBuYXZiYXJMYXlvdXQ7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKG9wZW5JbiA9PT0gJ3BpY2tlcicpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWFwcC5fY29tcGlsZWRUZW1wbGF0ZXMuc21hcnRTZWxlY3RUb29sYmFyKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5fY29tcGlsZWRUZW1wbGF0ZXMuc21hcnRTZWxlY3RUb29sYmFyID0gdDcuY29tcGlsZShhcHAucGFyYW1zLnNtYXJ0U2VsZWN0VG9vbGJhclRlbXBsYXRlIHx8IFxuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJ0b29sYmFyIHt7I2lmIHRvb2xiYXJUaGVtZX19dGhlbWUte3t0b29sYmFyVGhlbWV9fXt7L2lmfX1cIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJ0b29sYmFyLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJsZWZ0XCI+PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJyaWdodFwiPjxhIGhyZWY9XCIjXCIgY2xhc3M9XCJsaW5rIGNsb3NlLXBpY2tlclwiPjxzcGFuPnt7Y2xvc2VUZXh0fX08L3NwYW4+PC9hPjwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nXG4gICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICB0b29sYmFySFRNTCA9IGFwcC5fY29tcGlsZWRUZW1wbGF0ZXMuc21hcnRTZWxlY3RUb29sYmFyKHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZVRpdGxlOiBwYWdlVGl0bGUsXG4gICAgICAgICAgICAgICAgICAgIGNsb3NlVGV4dDogY2xvc2VUZXh0LFxuICAgICAgICAgICAgICAgICAgICBvcGVuSW46IG9wZW5JbixcbiAgICAgICAgICAgICAgICAgICAgdG9vbGJhclRoZW1lOiB0b29sYmFyVGhlbWUsXG4gICAgICAgICAgICAgICAgICAgIGluUGlja2VyOiBvcGVuSW4gPT09ICdwaWNrZXInICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIC8vIE5hdmJhciBIVE1MXG4gICAgICAgICAgICAgICAgaWYgKCFhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLnNtYXJ0U2VsZWN0TmF2YmFyKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5fY29tcGlsZWRUZW1wbGF0ZXMuc21hcnRTZWxlY3ROYXZiYXIgPSB0Ny5jb21waWxlKGFwcC5wYXJhbXMuc21hcnRTZWxlY3ROYXZiYXJUZW1wbGF0ZSB8fCBcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibmF2YmFyIHt7I2lmIG5hdmJhclRoZW1lfX10aGVtZS17e25hdmJhclRoZW1lfX17ey9pZn19XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJuYXZiYXItaW5uZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7bGVmdFRlbXBsYXRlfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJjZW50ZXIgc2xpZGluZ1wiPnt7cGFnZVRpdGxlfX08L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+J1xuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBuYXZiYXJIVE1MID0gYXBwLl9jb21waWxlZFRlbXBsYXRlcy5zbWFydFNlbGVjdE5hdmJhcih7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VUaXRsZTogcGFnZVRpdGxlLFxuICAgICAgICAgICAgICAgICAgICBiYWNrVGV4dDogYmFja1RleHQsXG4gICAgICAgICAgICAgICAgICAgIGNsb3NlVGV4dDogY2xvc2VUZXh0LFxuICAgICAgICAgICAgICAgICAgICBvcGVuSW46IG9wZW5JbixcbiAgICAgICAgICAgICAgICAgICAgbmF2YmFyVGhlbWU6IG5hdmJhclRoZW1lLFxuICAgICAgICAgICAgICAgICAgICBpblBvcHVwOiBvcGVuSW4gPT09ICdwb3B1cCcsXG4gICAgICAgICAgICAgICAgICAgIGluUGFnZTogb3BlbkluID09PSAncGFnZScsXG4gICAgICAgICAgICAgICAgICAgIGxlZnRUZW1wbGF0ZTogb3BlbkluID09PSAncG9wdXAnID8gXG4gICAgICAgICAgICAgICAgICAgICAgICAoYXBwLnBhcmFtcy5zbWFydFNlbGVjdFBvcHVwQ2xvc2VUZW1wbGF0ZSB8fCAobWF0ZXJpYWwgPyAnPGRpdiBjbGFzcz1cImxlZnRcIj48YSBocmVmPVwiI1wiIGNsYXNzPVwibGluayBjbG9zZS1wb3B1cCBpY29uLW9ubHlcIj48aSBjbGFzcz1cImljb24gaWNvbi1iYWNrXCI+PC9pPjwvYT48L2Rpdj4nIDogJzxkaXYgY2xhc3M9XCJsZWZ0XCI+PGEgaHJlZj1cIiNcIiBjbGFzcz1cImxpbmsgY2xvc2UtcG9wdXBcIj48aSBjbGFzcz1cImljb24gaWNvbi1iYWNrXCI+PC9pPjxzcGFuPnt7Y2xvc2VUZXh0fX08L3NwYW4+PC9hPjwvZGl2PicpKS5yZXBsYWNlKC97e2Nsb3NlVGV4dH19L2csIGNsb3NlVGV4dCkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgKGFwcC5wYXJhbXMuc21hcnRTZWxlY3RCYWNrVGVtcGxhdGUgfHwgKG1hdGVyaWFsID8gJzxkaXYgY2xhc3M9XCJsZWZ0XCI+PGEgaHJlZj1cIiNcIiBjbGFzcz1cImJhY2sgbGluayBpY29uLW9ubHlcIj48aSBjbGFzcz1cImljb24gaWNvbi1iYWNrXCI+PC9pPjwvYT48L2Rpdj4nIDogJzxkaXYgY2xhc3M9XCJsZWZ0IHNsaWRpbmdcIj48YSBocmVmPVwiI1wiIGNsYXNzPVwiYmFjayBsaW5rXCI+PGkgY2xhc3M9XCJpY29uIGljb24tYmFja1wiPjwvaT48c3Bhbj57e2JhY2tUZXh0fX08L3NwYW4+PC9hPjwvZGl2PicpKS5yZXBsYWNlKC97e2JhY2tUZXh0fX0vZywgYmFja1RleHQpXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIG5hdmJhciBsYXlvdXQgdHlwZSAtIHN0YXRpYy9maXhlZC90aHJvdWdoXG4gICAgICAgICAgICAgICAgaWYgKG9wZW5JbiA9PT0gJ3BhZ2UnKSB7XG4gICAgICAgICAgICAgICAgICAgIG5hdmJhckxheW91dCA9ICdzdGF0aWMnO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc21hcnRTZWxlY3QucGFyZW50cygnLm5hdmJhci10aHJvdWdoJykubGVuZ3RoID4gMCkgbmF2YmFyTGF5b3V0ID0gJ3Rocm91Z2gnO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc21hcnRTZWxlY3QucGFyZW50cygnLm5hdmJhci1maXhlZCcpLmxlbmd0aCA+IDApIG5hdmJhckxheW91dCA9ICdmaXhlZCc7XG4gICAgICAgICAgICAgICAgICAgIG5vVG9vbGJhciA9IHNtYXJ0U2VsZWN0LnBhcmVudHMoJy5wYWdlJykuaGFzQ2xhc3MoJ25vLXRvb2xiYXInKSA/ICduby10b29sYmFyJyA6ICcnO1xuICAgICAgICAgICAgICAgICAgICBub05hdmJhciAgPSBzbWFydFNlbGVjdC5wYXJlbnRzKCcucGFnZScpLmhhc0NsYXNzKCduby1uYXZiYXInKSAgPyAnbm8tbmF2YmFyJyAgOiAnbmF2YmFyLScgKyBuYXZiYXJMYXlvdXQ7XG4gICAgICAgICAgICAgICAgICAgIG5vVGFiYmFyID0gc21hcnRTZWxlY3QucGFyZW50cygnLnBhZ2UnKS5oYXNDbGFzcygnbm8tdGFiYmFyJykgPyAnbm8tdGFiYmFyJyA6ICcnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbmF2YmFyTGF5b3V0ID0gJ2ZpeGVkJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUGFnZSBMYXlvdXRcbiAgICAgICAgICAgIHZhciBwYWdlTmFtZSA9ICdzbWFydC1zZWxlY3QtJyArIGlucHV0TmFtZTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgdXNlU2VhcmNoYmFyID0gdHlwZW9mIHNtYXJ0U2VsZWN0LmRhdGEoJ3NlYXJjaGJhcicpID09PSAndW5kZWZpbmVkJyA/IGFwcC5wYXJhbXMuc21hcnRTZWxlY3RTZWFyY2hiYXIgOiAoc21hcnRTZWxlY3QuZGF0YSgnc2VhcmNoYmFyJykgPT09ICd0cnVlJyA/IHRydWUgOiBmYWxzZSk7XG4gICAgICAgICAgICB2YXIgc2VhcmNoYmFyUGxhY2Vob2xkZXIsIHNlYXJjaGJhckNhbmNlbDtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICh1c2VTZWFyY2hiYXIpIHtcbiAgICAgICAgICAgICAgICBzZWFyY2hiYXJQbGFjZWhvbGRlciA9IHNtYXJ0U2VsZWN0LmRhdGEoJ3NlYXJjaGJhci1wbGFjZWhvbGRlcicpIHx8ICdTZWFyY2gnO1xuICAgICAgICAgICAgICAgIHNlYXJjaGJhckNhbmNlbCA9IHNtYXJ0U2VsZWN0LmRhdGEoJ3NlYXJjaGJhci1jYW5jZWwnKSB8fCAnQ2FuY2VsJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgc2VhcmNoYmFySFRNTCA9ICAgJzxmb3JtIGNsYXNzPVwic2VhcmNoYmFyIHNlYXJjaGJhci1pbml0XCIgZGF0YS1zZWFyY2gtbGlzdD1cIi5zbWFydC1zZWxlY3QtbGlzdC0nICsgaWQgKyAnXCIgZGF0YS1zZWFyY2gtaW49XCIuaXRlbS10aXRsZVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJzZWFyY2hiYXItaW5wdXRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGlucHV0IHR5cGU9XCJzZWFyY2hcIiBwbGFjZWhvbGRlcj1cIicgKyBzZWFyY2hiYXJQbGFjZWhvbGRlciArICdcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGEgaHJlZj1cIiNcIiBjbGFzcz1cInNlYXJjaGJhci1jbGVhclwiPjwvYT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChtYXRlcmlhbCA/ICcnIDogJzxhIGhyZWY9XCIjXCIgY2xhc3M9XCJzZWFyY2hiYXItY2FuY2VsXCI+JyArIHNlYXJjaGJhckNhbmNlbCArICc8L2E+JykgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Zvcm0+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJzZWFyY2hiYXItb3ZlcmxheVwiPjwvZGl2Pic7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHBhZ2VIVE1MID1cbiAgICAgICAgICAgICAgICAob3BlbkluICE9PSAncGlja2VyJyAmJiBuYXZiYXJMYXlvdXQgPT09ICd0aHJvdWdoJyA/IG5hdmJhckhUTUwgOiAnJykgK1xuICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicGFnZXNcIj4nICtcbiAgICAgICAgICAgICAgICAnICA8ZGl2IGRhdGEtcGFnZT1cIicgKyBwYWdlTmFtZSArICdcIiBkYXRhLXNlbGVjdC1uYW1lPVwiJyArIHNlbGVjdE5hbWUgKyAnXCIgY2xhc3M9XCJwYWdlIHNtYXJ0LXNlbGVjdC1wYWdlICcgKyBub05hdmJhciArICcgJyArIG5vVG9vbGJhciArICcgJyArIG5vVGFiYmFyICsgJ1wiPicgK1xuICAgICAgICAgICAgICAgICAgICAgKG9wZW5JbiAhPT0gJ3BpY2tlcicgJiYgbmF2YmFyTGF5b3V0ID09PSAnZml4ZWQnID8gbmF2YmFySFRNTCA6ICcnKSArXG4gICAgICAgICAgICAgICAgICAgICAodXNlU2VhcmNoYmFyID8gc2VhcmNoYmFySFRNTCA6ICcnKSArXG4gICAgICAgICAgICAgICAgJyAgICA8ZGl2IGNsYXNzPVwicGFnZS1jb250ZW50XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgIChvcGVuSW4gIT09ICdwaWNrZXInICYmIG5hdmJhckxheW91dCA9PT0gJ3N0YXRpYycgPyBuYXZiYXJIVE1MIDogJycpICtcbiAgICAgICAgICAgICAgICAnICAgICAgPGRpdiBjbGFzcz1cImxpc3QtYmxvY2sgJyArICh2aXJ0dWFsTGlzdCA/ICd2aXJ0dWFsLWxpc3QnIDogJycpICsgJyBzbWFydC1zZWxlY3QtbGlzdC0nICsgaWQgKyAnICcgKyAoZm9ybVRoZW1lID8gJ3RoZW1lLScgKyBmb3JtVGhlbWUgOiAnJykgKyAnXCI+JyArXG4gICAgICAgICAgICAgICAgJyAgICAgICAgPHVsPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICh2aXJ0dWFsTGlzdCA/ICcnIDogaW5wdXRzSFRNTCkgK1xuICAgICAgICAgICAgICAgICcgICAgICAgIDwvdWw+JyArXG4gICAgICAgICAgICAgICAgJyAgICAgIDwvZGl2PicgK1xuICAgICAgICAgICAgICAgICcgICAgPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgJyAgPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgJzwvZGl2Pic7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGVmaW5lIHBvcHVwIGFuZCBwaWNrZXJcbiAgICAgICAgICAgIHZhciBwb3B1cCwgcGlja2VyO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNjcm9sbCBTUyBQaWNrZXIgVG8gSW5wdXRcbiAgICAgICAgICAgIGZ1bmN0aW9uIHNjcm9sbFRvSW5wdXQoKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2VDb250ZW50ID0gc21hcnRTZWxlY3QucGFyZW50cygnLnBhZ2UtY29udGVudCcpO1xuICAgICAgICAgICAgICAgIGlmIChwYWdlQ29udGVudC5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgcGFkZGluZ1RvcCA9IHBhcnNlSW50KHBhZ2VDb250ZW50LmNzcygncGFkZGluZy10b3AnKSwgMTApLFxuICAgICAgICAgICAgICAgICAgICBwYWRkaW5nQm90dG9tID0gcGFyc2VJbnQocGFnZUNvbnRlbnQuY3NzKCdwYWRkaW5nLWJvdHRvbScpLCAxMCksXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VIZWlnaHQgPSBwYWdlQ29udGVudFswXS5vZmZzZXRIZWlnaHQgLSBwYWRkaW5nVG9wIC0gcGlja2VyLmhlaWdodCgpLFxuICAgICAgICAgICAgICAgICAgICBwYWdlU2Nyb2xsSGVpZ2h0ID0gcGFnZUNvbnRlbnRbMF0uc2Nyb2xsSGVpZ2h0IC0gcGFkZGluZ1RvcCAtIHBpY2tlci5oZWlnaHQoKSxcbiAgICAgICAgICAgICAgICAgICAgbmV3UGFkZGluZ0JvdHRvbTtcbiAgICAgICAgICAgICAgICB2YXIgaW5wdXRUb3AgPSBzbWFydFNlbGVjdC5vZmZzZXQoKS50b3AgLSBwYWRkaW5nVG9wICsgc21hcnRTZWxlY3RbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgIGlmIChpbnB1dFRvcCA+IHBhZ2VIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNjcm9sbFRvcCA9IHBhZ2VDb250ZW50LnNjcm9sbFRvcCgpICsgaW5wdXRUb3AgLSBwYWdlSGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2Nyb2xsVG9wICsgcGFnZUhlaWdodCA+IHBhZ2VTY3JvbGxIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhZGRpbmdCb3R0b20gPSBzY3JvbGxUb3AgKyBwYWdlSGVpZ2h0IC0gcGFnZVNjcm9sbEhlaWdodCArIHBhZGRpbmdCb3R0b207XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFnZUhlaWdodCA9PT0gcGFnZVNjcm9sbEhlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhZGRpbmdCb3R0b20gPSBwaWNrZXIuaGVpZ2h0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudC5jc3MoeydwYWRkaW5nLWJvdHRvbSc6IChuZXdQYWRkaW5nQm90dG9tKSArICdweCd9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudC5zY3JvbGxUb3Aoc2Nyb2xsVG9wLCAzMDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIENsb3NlIFNTIFBpY2tlciBvbiBIVE1MIENsaWNrXG4gICAgICAgICAgICBmdW5jdGlvbiBjbG9zZU9uSFRNTENsaWNrKGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgY2xvc2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldCA9PT0gc21hcnRTZWxlY3RbMF0gfHwgJChlLnRhcmdldCkucGFyZW50cyhzbWFydFNlbGVjdFswXSkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBjbG9zZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoJChlLnRhcmdldCkucGFyZW50cygnLnBpY2tlci1tb2RhbCcpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY2xvc2UgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGNsb3NlKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKCcuc21hcnQtc2VsZWN0LXBpY2tlci5tb2RhbC1pbicpOyAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDaGVjayBtYXggbGVuZ3RoXG4gICAgICAgICAgICBmdW5jdGlvbiBjaGVja01heExlbmd0aChjb250YWluZXIpIHtcbiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0LnNlbGVjdGVkT3B0aW9ucy5sZW5ndGggPj0gbWF4TGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5maW5kKCdpbnB1dFt0eXBlPVwiY2hlY2tib3hcIl0nKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5jaGVja2VkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnRzKCdsaScpLmFkZENsYXNzKCdkaXNhYmxlZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnRzKCdsaScpLnJlbW92ZUNsYXNzKCdkaXNhYmxlZCcpOyAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5maW5kKCcuZGlzYWJsZWQnKS5yZW1vdmVDbGFzcygnZGlzYWJsZWQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBFdmVudCBMaXN0ZW5lcnMgb24gbmV3IHBhZ2VcbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZUlucHV0cyhjb250YWluZXIpIHtcbiAgICAgICAgICAgICAgICBjb250YWluZXIgPSAkKGNvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgaWYgKHZpcnR1YWxMaXN0KSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB2aXJ0dWFsTGlzdEluc3RhbmNlID0gYXBwLnZpcnR1YWxMaXN0KGNvbnRhaW5lci5maW5kKCcudmlydHVhbC1saXN0JyksIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zOiB2YWx1ZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZW1wbGF0ZTogc21hcnRTZWxlY3RJdGVtVGVtcGxhdGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHQ6IHZpcnR1YWxMaXN0SGVpZ2h0IHx8IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlYXJjaEJ5SXRlbTogZnVuY3Rpb24gKHF1ZXJ5LCBpbmRleCwgaXRlbSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLnRleHQudG9Mb3dlckNhc2UoKS5pbmRleE9mKHF1ZXJ5LnRyaW0oKS50b0xvd2VyQ2FzZSgpKSA+PTAgKSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIub25jZShvcGVuSW4gPT09ICdwb3B1cCcgfHwgb3BlbkluID09PSAncGlja2VyJyA/ICdjbG9zZWQnOiAncGFnZUJlZm9yZVJlbW92ZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aXJ0dWFsTGlzdEluc3RhbmNlICYmIHZpcnR1YWxMaXN0SW5zdGFuY2UuZGVzdHJveSkgdmlydHVhbExpc3RJbnN0YW5jZS5kZXN0cm95KCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobWF4TGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGNoZWNrTWF4TGVuZ3RoKGNvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5vbignY2hhbmdlJywgJ2lucHV0W25hbWU9XCInICsgaW5wdXROYW1lICsgJ1wiXScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gdGhpcztcbiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlID0gaW5wdXQudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIHZhciBvcHRpb25UZXh0ID0gW107XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dC50eXBlID09PSAnY2hlY2tib3gnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWVzID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNlbGVjdC5vcHRpb25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9wdGlvbiA9IHNlbGVjdC5vcHRpb25zW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb24udmFsdWUgPT09IHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IGlucHV0LmNoZWNrZWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb24uc2VsZWN0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uVGV4dC5wdXNoKG9wdGlvbi50ZXh0Q29udGVudC50cmltKCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXhMZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja01heExlbmd0aChjb250YWluZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uVGV4dCA9IFtzbWFydFNlbGVjdC5maW5kKCdvcHRpb25bdmFsdWU9XCInICsgdmFsdWUgKyAnXCJdJykudGV4dCgpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdC52YWx1ZSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgJHNlbGVjdC50cmlnZ2VyKCdjaGFuZ2UnKTtcbiAgICAgICAgICAgICAgICAgICAgc21hcnRTZWxlY3QuZmluZCgnLml0ZW0tYWZ0ZXInKS50ZXh0KG9wdGlvblRleHQuam9pbignLCAnKSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChiYWNrT25TZWxlY3QgJiYgaW5wdXRUeXBlID09PSAncmFkaW8nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob3BlbkluID09PSAncG9wdXAnKSBhcHAuY2xvc2VNb2RhbChwb3B1cCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChvcGVuSW4gPT09ICdwaWNrZXInKSBhcHAuY2xvc2VNb2RhbChwaWNrZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB2aWV3LnJvdXRlci5iYWNrKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIHBhZ2VJbml0KGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgcGFnZSA9IGUuZGV0YWlsLnBhZ2U7XG4gICAgICAgICAgICAgICAgaWYgKHBhZ2UubmFtZSA9PT0gcGFnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgaGFuZGxlSW5wdXRzKHBhZ2UuY29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob3BlbkluID09PSAncG9wdXAnKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJlTGF5b3V0KSB7XG4gICAgICAgICAgICAgICAgICAgIHBvcHVwID0gJCgnLnBvcHVwLnNtYXJ0LXNlbGVjdC1wb3B1cCAudmlldycpO1xuICAgICAgICAgICAgICAgICAgICBwb3B1cC5odG1sKHBhZ2VIVE1MKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBvcHVwID0gYXBwLnBvcHVwKFxuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwb3B1cCBzbWFydC1zZWxlY3QtcG9wdXAgc21hcnQtc2VsZWN0LXBvcHVwLScgKyBpbnB1dE5hbWUgKyAnXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJ2aWV3IG5hdmJhci1maXhlZFwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlSFRNTCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PidcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgICAgIHBvcHVwID0gJChwb3B1cCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGFwcC5pbml0UGFnZShwb3B1cC5maW5kKCcucGFnZScpKTtcbiAgICAgICAgICAgICAgICBoYW5kbGVJbnB1dHMocG9wdXApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAob3BlbkluID09PSAncGlja2VyJykge1xuICAgICAgICAgICAgICAgIGlmIChyZUxheW91dCkge1xuICAgICAgICAgICAgICAgICAgICBwaWNrZXIgPSAkKCcucGlja2VyLW1vZGFsLnNtYXJ0LXNlbGVjdC1waWNrZXIgLnZpZXcnKTtcbiAgICAgICAgICAgICAgICAgICAgcGlja2VyLmh0bWwocGFnZUhUTUwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcGlja2VyID0gYXBwLnBpY2tlck1vZGFsKFxuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwaWNrZXItbW9kYWwgc21hcnQtc2VsZWN0LXBpY2tlciBzbWFydC1zZWxlY3QtcGlja2VyLScgKyBpbnB1dE5hbWUgKyAnXCInICsgKHBpY2tlckhlaWdodCA/ICcgc3R5bGU9XCJoZWlnaHQ6JyArIHBpY2tlckhlaWdodCArICdcIicgOiAnJykgKyAnPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvb2xiYXJIVE1MICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBpY2tlci1tb2RhbC1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInZpZXdcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VIVE1MICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICBwaWNrZXIgPSAkKHBpY2tlcik7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBTY3JvbGwgVG8gSW5wdXRcbiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9JbnB1dCgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2xvc2UgT24gQ2xpY2tcbiAgICAgICAgICAgICAgICAgICAgJCgnaHRtbCcpLm9uKCdjbGljaycsIGNsb3NlT25IVE1MQ2xpY2spO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gT24gQ2xvc2VcbiAgICAgICAgICAgICAgICAgICAgcGlja2VyLm9uY2UoJ2Nsb3NlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVzZXQgbGlua2VkIHBpY2tlclxuICAgICAgICAgICAgICAgICAgICAgICAgc21hcnRTZWxlY3RbMF0uZjdTbWFydFNlbGVjdFBpY2tlciA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGV0YWNoIGh0bWwgY2xpY2tcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJ2h0bWwnKS5vZmYoJ2NsaWNrJywgY2xvc2VPbkhUTUxDbGljayk7ICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIHBhZ2UgcGFkZGluZyBib3R0b21cbiAgICAgICAgICAgICAgICAgICAgICAgIHNtYXJ0U2VsZWN0LnBhcmVudHMoJy5wYWdlLWNvbnRlbnQnKS5jc3Moe3BhZGRpbmdCb3R0b206ICcnfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gTGluayBQaWNrZXJcbiAgICAgICAgICAgICAgICAgICAgc21hcnRTZWxlY3RbMF0uZjdTbWFydFNlbGVjdFBpY2tlciA9IHBpY2tlclswXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIEluaXQgUGFnZVxuICAgICAgICAgICAgICAgIGFwcC5pbml0UGFnZShwaWNrZXIuZmluZCgnLnBhZ2UnKSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIEF0dGFjaCBldmVudHNcbiAgICAgICAgICAgICAgICBoYW5kbGVJbnB1dHMocGlja2VyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uY2UoJ3BhZ2VJbml0JywgJy5zbWFydC1zZWxlY3QtcGFnZScsIHBhZ2VJbml0KTtcbiAgICAgICAgICAgICAgICB2aWV3LnJvdXRlci5sb2FkKHtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudDogcGFnZUhUTUwsXG4gICAgICAgICAgICAgICAgICAgIHJlbG9hZDogcmVMYXlvdXQgPyB0cnVlIDogdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBWaXJ0dWFsIExpc3QgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHZhciBWaXJ0dWFsTGlzdCA9IGZ1bmN0aW9uIChsaXN0QmxvY2ssIHBhcmFtcykge1xuICAgICAgICAgICAgdmFyIGRlZmF1bHRzID0ge1xuICAgICAgICAgICAgICAgIGNvbHM6IDEsXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiBhcHAucGFyYW1zLm1hdGVyaWFsID8gNDggOiA0NCxcbiAgICAgICAgICAgICAgICBjYWNoZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBkeW5hbWljSGVpZ2h0QnVmZmVyU2l6ZTogMSxcbiAgICAgICAgICAgICAgICBzaG93RmlsdGVyZWRJdGVtc09ubHk6IGZhbHNlXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xuICAgICAgICAgICAgZm9yICh2YXIgZGVmIGluIGRlZmF1bHRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXNbZGVmXSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zW2RlZl0gPSBkZWZhdWx0c1tkZWZdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQcmVwYXJhdGlvblxuICAgICAgICAgICAgdmFyIHZsID0gdGhpcztcbiAgICAgICAgICAgIHZsLmxpc3RCbG9jayA9ICQobGlzdEJsb2NrKTtcbiAgICAgICAgICAgIHZsLnBhcmFtcyA9IHBhcmFtcztcbiAgICAgICAgICAgIHZsLml0ZW1zID0gdmwucGFyYW1zLml0ZW1zO1xuICAgICAgICAgICAgaWYgKHZsLnBhcmFtcy5zaG93RmlsdGVyZWRJdGVtc09ubHkpIHtcbiAgICAgICAgICAgICAgICB2bC5maWx0ZXJlZEl0ZW1zID0gW107XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodmwucGFyYW1zLnRlbXBsYXRlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2bC5wYXJhbXMudGVtcGxhdGUgPT09ICdzdHJpbmcnKSB2bC50ZW1wbGF0ZSA9IHQ3LmNvbXBpbGUodmwucGFyYW1zLnRlbXBsYXRlKTtcbiAgICAgICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgdmwucGFyYW1zLnRlbXBsYXRlID09PSAnZnVuY3Rpb24nKSB2bC50ZW1wbGF0ZSA9IHZsLnBhcmFtcy50ZW1wbGF0ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZsLnBhZ2VDb250ZW50ID0gdmwubGlzdEJsb2NrLnBhcmVudHMoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBCYWQgc2Nyb2xsXG4gICAgICAgICAgICB2YXIgdXBkYXRhYmxlU2Nyb2xsO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB2bC5wYXJhbXMudXBkYXRhYmxlU2Nyb2xsICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIHVwZGF0YWJsZVNjcm9sbCA9IHZsLnBhcmFtcy51cGRhdGFibGVTY3JvbGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB1cGRhdGFibGVTY3JvbGwgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLmlvcyAmJiBhcHAuZGV2aWNlLm9zVmVyc2lvbi5zcGxpdCgnLicpWzBdIDwgOCkge1xuICAgICAgICAgICAgICAgICAgICB1cGRhdGFibGVTY3JvbGwgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQXBwZW5kIDx1bD5cbiAgICAgICAgICAgIHZsLnVsID0gdmwucGFyYW1zLnVsID8gJCh2bC5wYXJhbXMudWwpIDogdmwubGlzdEJsb2NrLmNoaWxkcmVuKCd1bCcpO1xuICAgICAgICAgICAgaWYgKHZsLnVsLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHZsLmxpc3RCbG9jay5hcHBlbmQoJzx1bD48L3VsPicpO1xuICAgICAgICAgICAgICAgIHZsLnVsID0gdmwubGlzdEJsb2NrLmNoaWxkcmVuKCd1bCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIERPTSBjYWNoZWQgaXRlbXNcbiAgICAgICAgICAgIHZsLmRvbUNhY2hlID0ge307XG4gICAgICAgICAgICB2bC5kaXNwbGF5RG9tQ2FjaGUgPSB7fTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBUZW1wb3JhcnkgRE9NIEVsZW1lbnRcbiAgICAgICAgICAgIHZsLnRlbXBEb21FbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndWwnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBMYXN0IHJlcGFpbiBwb3NpdGlvblxuICAgICAgICAgICAgdmwubGFzdFJlcGFpbnRZID0gbnVsbDtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBGcmFnbWVudFxuICAgICAgICAgICAgdmwuZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRmlsdGVyXG4gICAgICAgICAgICB2bC5maWx0ZXJJdGVtcyA9IGZ1bmN0aW9uIChpbmRleGVzLCByZXNldFNjcm9sbFRvcCkge1xuICAgICAgICAgICAgICAgIHZsLmZpbHRlcmVkSXRlbXMgPSBbXTtcbiAgICAgICAgICAgICAgICB2YXIgZmlyc3RJbmRleCA9IGluZGV4ZXNbMF07XG4gICAgICAgICAgICAgICAgdmFyIGxhc3RJbmRleCA9IGluZGV4ZXNbaW5kZXhlcy5sZW5ndGggLSAxXTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluZGV4ZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmwuZmlsdGVyZWRJdGVtcy5wdXNoKHZsLml0ZW1zW2luZGV4ZXNbaV1dKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXNldFNjcm9sbFRvcCA9PT0gJ3VuZGVmaW5lZCcpIHJlc2V0U2Nyb2xsVG9wID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAocmVzZXRTY3JvbGxUb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgdmwucGFnZUNvbnRlbnRbMF0uc2Nyb2xsVG9wID0gMDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmwudXBkYXRlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdmwucmVzZXRGaWx0ZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHZsLnBhcmFtcy5zaG93RmlsdGVyZWRJdGVtc09ubHkpIHtcbiAgICAgICAgICAgICAgICAgICAgdmwuZmlsdGVyZWRJdGVtcyA9IFtdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdmwuZmlsdGVyZWRJdGVtcyA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB2bC5maWx0ZXJlZEl0ZW1zOyAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmwudXBkYXRlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBwYWdlSGVpZ2h0LCByb3dzUGVyU2NyZWVuLCByb3dzQmVmb3JlLCByb3dzQWZ0ZXIsIHJvd3NUb1JlbmRlciwgbWF4QnVmZmVySGVpZ2h0ID0gMCwgbGlzdEhlaWdodDtcbiAgICAgICAgICAgIHZhciBkeW5hbWljSGVpZ2h0ID0gdHlwZW9mIHZsLnBhcmFtcy5oZWlnaHQgPT09ICdmdW5jdGlvbic7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2V0IGxpc3Qgc2l6ZVxuICAgICAgICAgICAgdmwuc2V0TGlzdFNpemUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGl0ZW1zID0gdmwuZmlsdGVyZWRJdGVtcyB8fCB2bC5pdGVtcztcbiAgICAgICAgICAgICAgICBwYWdlSGVpZ2h0ID0gdmwucGFnZUNvbnRlbnRbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgIGlmIChkeW5hbWljSGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgIGxpc3RIZWlnaHQgPSAwO1xuICAgICAgICAgICAgICAgICAgICB2bC5oZWlnaHRzID0gW107XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdGVtSGVpZ2h0ID0gdmwucGFyYW1zLmhlaWdodChpdGVtc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBsaXN0SGVpZ2h0ICs9IGl0ZW1IZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB2bC5oZWlnaHRzLnB1c2goaXRlbUhlaWdodCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxpc3RIZWlnaHQgPSBpdGVtcy5sZW5ndGggKiB2bC5wYXJhbXMuaGVpZ2h0IC8gdmwucGFyYW1zLmNvbHM7XG4gICAgICAgICAgICAgICAgICAgIHJvd3NQZXJTY3JlZW4gPSBNYXRoLmNlaWwocGFnZUhlaWdodCAvIHZsLnBhcmFtcy5oZWlnaHQpO1xuICAgICAgICAgICAgICAgICAgICByb3dzQmVmb3JlID0gdmwucGFyYW1zLnJvd3NCZWZvcmUgfHwgcm93c1BlclNjcmVlbiAqIDI7XG4gICAgICAgICAgICAgICAgICAgIHJvd3NBZnRlciA9IHZsLnBhcmFtcy5yb3dzQWZ0ZXIgfHwgcm93c1BlclNjcmVlbjtcbiAgICAgICAgICAgICAgICAgICAgcm93c1RvUmVuZGVyID0gKHJvd3NQZXJTY3JlZW4gKyByb3dzQmVmb3JlICsgcm93c0FmdGVyKTtcbiAgICAgICAgICAgICAgICAgICAgbWF4QnVmZmVySGVpZ2h0ID0gcm93c0JlZm9yZSAvIDIgKiB2bC5wYXJhbXMuaGVpZ2h0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHVwZGF0YWJsZVNjcm9sbCkge1xuICAgICAgICAgICAgICAgICAgICB2bC51bC5jc3Moe2hlaWdodDogbGlzdEhlaWdodCArICdweCd9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFJlbmRlciBpdGVtc1xuICAgICAgICAgICAgdmwucmVuZGVyID0gZnVuY3Rpb24gKGZvcmNlLCBmb3JjZVNjcm9sbFRvcCkge1xuICAgICAgICAgICAgICAgIGlmIChmb3JjZSkgdmwubGFzdFJlcGFpbnRZID0gbnVsbDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIHNjcm9sbFRvcCA9IC0odmwubGlzdEJsb2NrWzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCAtIHZsLnBhZ2VDb250ZW50WzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm9yY2VTY3JvbGxUb3AgIT09ICd1bmRlZmluZWQnKSBzY3JvbGxUb3AgPSBmb3JjZVNjcm9sbFRvcDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHZsLmxhc3RSZXBhaW50WSA9PT0gbnVsbCB8fCBNYXRoLmFicyhzY3JvbGxUb3AgLSB2bC5sYXN0UmVwYWludFkpID4gbWF4QnVmZmVySGVpZ2h0IHx8ICghdXBkYXRhYmxlU2Nyb2xsICYmICh2bC5wYWdlQ29udGVudFswXS5zY3JvbGxUb3AgKyBwYWdlSGVpZ2h0ID49IHZsLnBhZ2VDb250ZW50WzBdLnNjcm9sbEhlaWdodCkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHZsLmxhc3RSZXBhaW50WSA9IHNjcm9sbFRvcDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBpdGVtcyA9IHZsLmZpbHRlcmVkSXRlbXMgfHwgdmwuaXRlbXMsIFxuICAgICAgICAgICAgICAgICAgICBmcm9tSW5kZXgsIHRvSW5kZXgsIGhlaWdodEJlZm9yZUZpcnN0SXRlbSA9IDAsIGhlaWdodEJlZm9yZUxhc3RJdGVtID0gMDtcbiAgICAgICAgICAgICAgICBpZiAoZHluYW1pY0hlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbVRvcCA9IDAsIGosIGl0ZW1IZWlnaHQ7IFxuICAgICAgICAgICAgICAgICAgICBtYXhCdWZmZXJIZWlnaHQgPSBwYWdlSGVpZ2h0O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IHZsLmhlaWdodHMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1IZWlnaHQgPSB2bC5oZWlnaHRzW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmcm9tSW5kZXggPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1Ub3AgKyBpdGVtSGVpZ2h0ID49IHNjcm9sbFRvcCAtIHBhZ2VIZWlnaHQgKiAyICogdmwucGFyYW1zLmR5bmFtaWNIZWlnaHRCdWZmZXJTaXplKSBmcm9tSW5kZXggPSBqO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaGVpZ2h0QmVmb3JlRmlyc3RJdGVtICs9IGl0ZW1IZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0b0luZGV4ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtVG9wICsgaXRlbUhlaWdodCA+PSBzY3JvbGxUb3AgKyBwYWdlSGVpZ2h0ICogMiAqIHZsLnBhcmFtcy5keW5hbWljSGVpZ2h0QnVmZmVyU2l6ZSB8fCBqID09PSB2bC5oZWlnaHRzLmxlbmd0aCAtIDEpIHRvSW5kZXggPSBqICsgMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWlnaHRCZWZvcmVMYXN0SXRlbSArPSBpdGVtSGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVRvcCArPSBpdGVtSGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRvSW5kZXggPSBNYXRoLm1pbih0b0luZGV4LCBpdGVtcy5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZnJvbUluZGV4ID0gKHBhcnNlSW50KHNjcm9sbFRvcCAvIHZsLnBhcmFtcy5oZWlnaHQpIC0gcm93c0JlZm9yZSkgKiB2bC5wYXJhbXMuY29scztcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZyb21JbmRleCA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZyb21JbmRleCA9IDA7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdG9JbmRleCA9IE1hdGgubWluKGZyb21JbmRleCArIHJvd3NUb1JlbmRlciAqIHZsLnBhcmFtcy5jb2xzLCBpdGVtcy5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIHRvcFBvc2l0aW9uO1xuICAgICAgICAgICAgICAgIHZsLnJlYWNoRW5kID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IGZyb21JbmRleDsgaSA8IHRvSW5kZXg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbSwgaW5kZXg7XG4gICAgICAgICAgICAgICAgICAgIC8vIERlZmluZSByZWFsIGl0ZW0gaW5kZXhcbiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSB2bC5pdGVtcy5pbmRleE9mKGl0ZW1zW2ldKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChpID09PSBmcm9tSW5kZXgpIHZsLmN1cnJlbnRGcm9tSW5kZXggPSBpbmRleDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGkgPT09IHRvSW5kZXggLSAxKSB2bC5jdXJyZW50VG9JbmRleCA9IGluZGV4O1xuICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPT09IHZsLml0ZW1zLmxlbmd0aCAtIDEpIHZsLnJlYWNoRW5kID0gdHJ1ZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIEZpbmQgaXRlbXNcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZsLmRvbUNhY2hlW2luZGV4XSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbSA9IHZsLmRvbUNhY2hlW2luZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2bC50ZW1wbGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZsLnRlbXBEb21FbGVtZW50LmlubmVySFRNTCA9IHZsLnRlbXBsYXRlKGl0ZW1zW2ldLCB7aW5kZXg6IGluZGV4fSkudHJpbSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodmwucGFyYW1zLnJlbmRlckl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2bC50ZW1wRG9tRWxlbWVudC5pbm5lckhUTUwgPSB2bC5wYXJhbXMucmVuZGVySXRlbShpbmRleCwgaXRlbXNbaV0pLnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZsLnRlbXBEb21FbGVtZW50LmlubmVySFRNTCA9IGl0ZW1zW2ldLnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0gPSB2bC50ZW1wRG9tRWxlbWVudC5jaGlsZE5vZGVzWzBdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZsLnBhcmFtcy5jYWNoZSkgdmwuZG9tQ2FjaGVbaW5kZXhdID0gaXRlbTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpdGVtLmY3VmlydHVhbExpc3RJbmRleCA9IGluZGV4O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gU2V0IGl0ZW0gdG9wIHBvc2l0aW9uXG4gICAgICAgICAgICAgICAgICAgIGlmIChpID09PSBmcm9tSW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkeW5hbWljSGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9wUG9zaXRpb24gPSBoZWlnaHRCZWZvcmVGaXJzdEl0ZW07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3BQb3NpdGlvbiA9IChpICogdmwucGFyYW1zLmhlaWdodCAvIHZsLnBhcmFtcy5jb2xzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpdGVtLnN0eWxlLnRvcCA9IHRvcFBvc2l0aW9uICsgJ3B4JztcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIEJlZm9yZSBpdGVtIGluc2VydFxuICAgICAgICAgICAgICAgICAgICBpZiAodmwucGFyYW1zLm9uSXRlbUJlZm9yZUluc2VydCkgdmwucGFyYW1zLm9uSXRlbUJlZm9yZUluc2VydCh2bCwgaXRlbSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBBcHBlbmQgaXRlbSB0byBmcmFnbWVudFxuICAgICAgICAgICAgICAgICAgICB2bC5mcmFnbWVudC5hcHBlbmRDaGlsZChpdGVtKTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gVXBkYXRlIGxpc3QgaGVpZ2h0IHdpdGggbm90IHVwZGF0YWJsZSBzY3JvbGxcbiAgICAgICAgICAgICAgICBpZiAoIXVwZGF0YWJsZVNjcm9sbCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZHluYW1pY0hlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmwudWxbMF0uc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0QmVmb3JlTGFzdEl0ZW0gKyAncHgnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmwudWxbMF0uc3R5bGUuaGVpZ2h0ID0gaSAqIHZsLnBhcmFtcy5oZWlnaHQgLyB2bC5wYXJhbXMuY29scyArICdweCc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgbGlzdCBodG1sXG4gICAgICAgICAgICAgICAgaWYgKHZsLnBhcmFtcy5vbkJlZm9yZUNsZWFyKSB2bC5wYXJhbXMub25CZWZvcmVDbGVhcih2bCwgdmwuZnJhZ21lbnQpO1xuICAgICAgICAgICAgICAgIHZsLnVsWzBdLmlubmVySFRNTCA9ICcnO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAodmwucGFyYW1zLm9uSXRlbXNCZWZvcmVJbnNlcnQpIHZsLnBhcmFtcy5vbkl0ZW1zQmVmb3JlSW5zZXJ0KHZsLCB2bC5mcmFnbWVudCk7XG4gICAgICAgICAgICAgICAgdmwudWxbMF0uYXBwZW5kQ2hpbGQodmwuZnJhZ21lbnQpO1xuICAgICAgICAgICAgICAgIGlmICh2bC5wYXJhbXMub25JdGVtc0FmdGVySW5zZXJ0KSB2bC5wYXJhbXMub25JdGVtc0FmdGVySW5zZXJ0KHZsLCB2bC5mcmFnbWVudCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm9yY2VTY3JvbGxUb3AgIT09ICd1bmRlZmluZWQnICYmIGZvcmNlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZsLnBhZ2VDb250ZW50LnNjcm9sbFRvcChmb3JjZVNjcm9sbFRvcCwgMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICB2bC5zY3JvbGxUb0l0ZW0gPSBmdW5jdGlvbiAoaW5kZXgpIHtcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPiB2bC5pdGVtcy5sZW5ndGgpIHJldHVybiBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIGl0ZW1Ub3AgPSAwLCBsaXN0VG9wO1xuICAgICAgICAgICAgICAgIGlmIChkeW5hbWljSGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW5kZXg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVRvcCArPSB2bC5oZWlnaHRzW2ldO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpdGVtVG9wID0gaW5kZXggKiB2bC5wYXJhbXMuaGVpZ2h0O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBsaXN0VG9wID0gdmwubGlzdEJsb2NrWzBdLm9mZnNldFRvcDtcbiAgICAgICAgICAgICAgICB2bC5yZW5kZXIodHJ1ZSwgbGlzdFRvcCArIGl0ZW1Ub3AgLSBwYXJzZUludCh2bC5wYWdlQ29udGVudC5jc3MoJ3BhZGRpbmctdG9wJyksIDEwKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEhhbmRsZSBzY3JvbGwgZXZlbnRcbiAgICAgICAgICAgIHZsLmhhbmRsZVNjcm9sbCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgdmwucmVuZGVyKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgLy8gSGFuZGxlIHJlc2l6ZSBldmVudFxuICAgICAgICAgICAgdmwuaGFuZGxlUmVzaXplID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICB2bC5zZXRMaXN0U2l6ZSgpO1xuICAgICAgICAgICAgICAgIHZsLnJlbmRlcih0cnVlKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgdmwuYXR0YWNoRXZlbnRzID0gZnVuY3Rpb24gKGRldGFjaCkge1xuICAgICAgICAgICAgICAgIHZhciBhY3Rpb24gPSBkZXRhY2ggPyAnb2ZmJyA6ICdvbic7XG4gICAgICAgICAgICAgICAgdmwucGFnZUNvbnRlbnRbYWN0aW9uXSgnc2Nyb2xsJywgdmwuaGFuZGxlU2Nyb2xsKTtcbiAgICAgICAgICAgICAgICB2bC5saXN0QmxvY2sucGFyZW50cygnLnRhYicpLmVxKDApW2FjdGlvbl0oJ3Nob3cnLCB2bC5oYW5kbGVSZXNpemUpO1xuICAgICAgICAgICAgICAgICQod2luZG93KVthY3Rpb25dKCdyZXNpemUnLCB2bC5oYW5kbGVSZXNpemUpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0IFZpcnR1YWwgTGlzdFxuICAgICAgICAgICAgdmwuaW5pdCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2bC5hdHRhY2hFdmVudHMoKTtcbiAgICAgICAgICAgICAgICB2bC5zZXRMaXN0U2l6ZSgpO1xuICAgICAgICAgICAgICAgIHZsLnJlbmRlcigpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBBcHBlbmRcbiAgICAgICAgICAgIHZsLmFwcGVuZEl0ZW1zID0gZnVuY3Rpb24gKGl0ZW1zKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2bC5pdGVtcy5wdXNoKGl0ZW1zW2ldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmwudXBkYXRlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdmwuYXBwZW5kSXRlbSA9IGZ1bmN0aW9uIChpdGVtKSB7XG4gICAgICAgICAgICAgICAgdmwuYXBwZW5kSXRlbXMoW2l0ZW1dKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICAvLyBSZXBsYWNlXG4gICAgICAgICAgICB2bC5yZXBsYWNlQWxsSXRlbXMgPSBmdW5jdGlvbiAoaXRlbXMpIHtcbiAgICAgICAgICAgICAgICB2bC5pdGVtcyA9IGl0ZW1zO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB2bC5maWx0ZXJlZEl0ZW1zO1xuICAgICAgICAgICAgICAgIHZsLmRvbUNhY2hlID0ge307XG4gICAgICAgICAgICAgICAgdmwudXBkYXRlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdmwucmVwbGFjZUl0ZW0gPSBmdW5jdGlvbiAoaW5kZXgsIGl0ZW0pIHtcbiAgICAgICAgICAgICAgICB2bC5pdGVtc1tpbmRleF0gPSBpdGVtO1xuICAgICAgICAgICAgICAgIGlmICh2bC5wYXJhbXMuY2FjaGUpIGRlbGV0ZSB2bC5kb21DYWNoZVtpbmRleF07XG4gICAgICAgICAgICAgICAgdmwudXBkYXRlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgLy8gUHJlcGVuZFxuICAgICAgICAgICAgdmwucHJlcGVuZEl0ZW1zID0gZnVuY3Rpb24gKGl0ZW1zKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IGl0ZW1zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgICAgICAgICAgICAgIHZsLml0ZW1zLnVuc2hpZnQoaXRlbXNbaV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodmwucGFyYW1zLmNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdDYWNoZSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBjYWNoZWQgaW4gdmwuZG9tQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0NhY2hlW3BhcnNlSW50KGNhY2hlZCwgMTApICsgaXRlbXMubGVuZ3RoXSA9IHZsLmRvbUNhY2hlW2NhY2hlZF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmwuZG9tQ2FjaGUgPSBuZXdDYWNoZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmwudXBkYXRlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdmwucHJlcGVuZEl0ZW0gPSBmdW5jdGlvbiAoaXRlbSkge1xuICAgICAgICAgICAgICAgIHZsLnByZXBlbmRJdGVtcyhbaXRlbV0pO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBNb3ZlXG4gICAgICAgICAgICB2bC5tb3ZlSXRlbSA9IGZ1bmN0aW9uIChvbGRJbmRleCwgbmV3SW5kZXgpIHtcbiAgICAgICAgICAgICAgICBpZiAob2xkSW5kZXggPT09IG5ld0luZGV4KSByZXR1cm47XG4gICAgICAgICAgICAgICAgLy8gcmVtb3ZlIGl0ZW0gZnJvbSBhcnJheVxuICAgICAgICAgICAgICAgIHZhciBpdGVtID0gdmwuaXRlbXMuc3BsaWNlKG9sZEluZGV4LCAxKVswXTtcbiAgICAgICAgICAgICAgICBpZiAobmV3SW5kZXggPj0gdmwuaXRlbXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEFkZCBpdGVtIHRvIHRoZSBlbmRcbiAgICAgICAgICAgICAgICAgICAgdmwuaXRlbXMucHVzaChpdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgbmV3SW5kZXggPSB2bC5pdGVtcy5sZW5ndGggLSAxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gQWRkIGl0ZW0gdG8gbmV3IGluZGV4XG4gICAgICAgICAgICAgICAgICAgIHZsLml0ZW1zLnNwbGljZShuZXdJbmRleCwgMCwgaXRlbSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBjYWNoZVxuICAgICAgICAgICAgICAgIGlmICh2bC5wYXJhbXMuY2FjaGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld0NhY2hlID0ge307XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGNhY2hlZCBpbiB2bC5kb21DYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNhY2hlZEluZGV4ID0gcGFyc2VJbnQoY2FjaGVkLCAxMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGVmdEluZGV4ID0gb2xkSW5kZXggPCBuZXdJbmRleCA/IG9sZEluZGV4IDogbmV3SW5kZXg7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmlnaHRJbmRleCA9IG9sZEluZGV4IDwgbmV3SW5kZXggPyBuZXdJbmRleCA6IG9sZEluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4U2hpZnQgPSBvbGRJbmRleCA8IG5ld0luZGV4ID8gLTEgOiAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlZEluZGV4IDwgbGVmdEluZGV4IHx8IGNhY2hlZEluZGV4ID4gcmlnaHRJbmRleCkgbmV3Q2FjaGVbY2FjaGVkSW5kZXhdID0gdmwuZG9tQ2FjaGVbY2FjaGVkSW5kZXhdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlZEluZGV4ID09PSBsZWZ0SW5kZXgpIG5ld0NhY2hlW3JpZ2h0SW5kZXhdID0gdmwuZG9tQ2FjaGVbY2FjaGVkSW5kZXhdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlZEluZGV4ID4gbGVmdEluZGV4ICYmIGNhY2hlZEluZGV4IDw9IHJpZ2h0SW5kZXgpIG5ld0NhY2hlW2NhY2hlZEluZGV4ICsgaW5kZXhTaGlmdF0gPSB2bC5kb21DYWNoZVtjYWNoZWRJbmRleF07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmwuZG9tQ2FjaGUgPSBuZXdDYWNoZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmwudXBkYXRlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgLy8gSW5zZXJ0IGJlZm9yZVxuICAgICAgICAgICAgdmwuaW5zZXJ0SXRlbUJlZm9yZSA9IGZ1bmN0aW9uIChpbmRleCwgaXRlbSkge1xuICAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICB2bC5wcmVwZW5kSXRlbShpdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPj0gdmwuaXRlbXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZsLmFwcGVuZEl0ZW0oaXRlbSk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmwuaXRlbXMuc3BsaWNlKGluZGV4LCAwLCBpdGVtKTtcbiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgY2FjaGVcbiAgICAgICAgICAgICAgICBpZiAodmwucGFyYW1zLmNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdDYWNoZSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBjYWNoZWQgaW4gdmwuZG9tQ2FjaGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWNoZWRJbmRleCA9IHBhcnNlSW50KGNhY2hlZCwgMTApO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhY2hlZEluZGV4ID49IGluZGV4KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3Q2FjaGVbY2FjaGVkSW5kZXggKyAxXSA9IHZsLmRvbUNhY2hlW2NhY2hlZEluZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2bC5kb21DYWNoZSA9IG5ld0NhY2hlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2bC51cGRhdGUoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICAvLyBEZWxldGVcbiAgICAgICAgICAgIHZsLmRlbGV0ZUl0ZW1zID0gZnVuY3Rpb24gKGluZGV4ZXMpIHtcbiAgICAgICAgICAgICAgICB2YXIgcHJldkluZGV4LCBpbmRleFNoaWZ0ID0gMDtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGluZGV4ZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gaW5kZXhlc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcmV2SW5kZXggIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXggPiBwcmV2SW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleFNoaWZ0ID0gLWk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaW5kZXggPSBpbmRleCArIGluZGV4U2hpZnQ7XG4gICAgICAgICAgICAgICAgICAgIHByZXZJbmRleCA9IGluZGV4ZXNbaV07XG4gICAgICAgICAgICAgICAgICAgIC8vIERlbGV0ZSBpdGVtXG4gICAgICAgICAgICAgICAgICAgIHZhciBkZWxldGVkSXRlbSA9IHZsLml0ZW1zLnNwbGljZShpbmRleCwgMSlbMF07XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBEZWxldGUgZnJvbSBmaWx0ZXJlZFxuICAgICAgICAgICAgICAgICAgICBpZiAodmwuZmlsdGVyZWRJdGVtcyAmJiB2bC5maWx0ZXJlZEl0ZW1zLmluZGV4T2YoZGVsZXRlZEl0ZW0pID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZsLmZpbHRlcmVkSXRlbXMuc3BsaWNlKHZsLmZpbHRlcmVkSXRlbXMuaW5kZXhPZihkZWxldGVkSXRlbSksIDEpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBjYWNoZVxuICAgICAgICAgICAgICAgICAgICBpZiAodmwucGFyYW1zLmNhY2hlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3Q2FjaGUgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGNhY2hlZCBpbiB2bC5kb21DYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYWNoZWRJbmRleCA9IHBhcnNlSW50KGNhY2hlZCwgMTApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjYWNoZWRJbmRleCA9PT0gaW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHZsLmRvbUNhY2hlW2luZGV4XTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocGFyc2VJbnQoY2FjaGVkLCAxMCkgPiBpbmRleCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdDYWNoZVtjYWNoZWRJbmRleCAtIDFdID0gdmwuZG9tQ2FjaGVbY2FjaGVkXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld0NhY2hlW2NhY2hlZEluZGV4XSA9IHZsLmRvbUNhY2hlW2NhY2hlZF07ICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgdmwuZG9tQ2FjaGUgPSBuZXdDYWNoZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2bC51cGRhdGUoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB2bC5kZWxldGVBbGxJdGVtcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2bC5pdGVtcyA9IFtdO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB2bC5maWx0ZXJlZEl0ZW1zO1xuICAgICAgICAgICAgICAgIGlmICh2bC5wYXJhbXMuY2FjaGUpIHZsLmRvbUNhY2hlID0ge307XG4gICAgICAgICAgICAgICAgdmwudXBkYXRlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdmwuZGVsZXRlSXRlbSA9IGZ1bmN0aW9uIChpbmRleCkge1xuICAgICAgICAgICAgICAgIHZsLmRlbGV0ZUl0ZW1zKFtpbmRleF0pO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDbGVhciBjYWNoZVxuICAgICAgICAgICAgdmwuY2xlYXJDYWNoZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2bC5kb21DYWNoZSA9IHt9O1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBVcGRhdGUgVmlydHVhbCBMaXN0XG4gICAgICAgICAgICB2bC51cGRhdGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmwuc2V0TGlzdFNpemUoKTtcbiAgICAgICAgICAgICAgICB2bC5yZW5kZXIodHJ1ZSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIERlc3Ryb3lcbiAgICAgICAgICAgIHZsLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmwuYXR0YWNoRXZlbnRzKHRydWUpO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSB2bC5pdGVtcztcbiAgICAgICAgICAgICAgICBkZWxldGUgdmwuZG9tQ2FjaGU7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgVmlydHVhbCBMaXN0XG4gICAgICAgICAgICB2bC5pbml0KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU3RvcmUgdmwgaW4gY29udGFpbmVyXG4gICAgICAgICAgICB2bC5saXN0QmxvY2tbMF0uZjdWaXJ0dWFsTGlzdCA9IHZsO1xuICAgICAgICAgICAgcmV0dXJuIHZsO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLy8gQXBwIE1ldGhvZFxuICAgICAgICBhcHAudmlydHVhbExpc3QgPSBmdW5jdGlvbiAobGlzdEJsb2NrLCBwYXJhbXMpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgVmlydHVhbExpc3QobGlzdEJsb2NrLCBwYXJhbXMpO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgYXBwLnJlaW5pdFZpcnR1YWxMaXN0ID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHZhciBwYWdlID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIHZhciB2bGlzdHMgPSBwYWdlLmZpbmQoJy52aXJ0dWFsLWxpc3QnKTtcbiAgICAgICAgICAgIGlmICh2bGlzdHMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZsaXN0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciB2bGlzdEluc3RhbmNlID0gdmxpc3RzW2ldLmY3VmlydHVhbExpc3Q7XG4gICAgICAgICAgICAgICAgaWYgKHZsaXN0SW5zdGFuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgdmxpc3RJbnN0YW5jZS51cGRhdGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgUHVsbCBUbyBSZWZyZXNoICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5pbml0UHVsbFRvUmVmcmVzaCA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICB2YXIgZXZlbnRzVGFyZ2V0ID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIGlmICghZXZlbnRzVGFyZ2V0Lmhhc0NsYXNzKCdwdWxsLXRvLXJlZnJlc2gtY29udGVudCcpKSB7XG4gICAgICAgICAgICAgICAgZXZlbnRzVGFyZ2V0ID0gZXZlbnRzVGFyZ2V0LmZpbmQoJy5wdWxsLXRvLXJlZnJlc2gtY29udGVudCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFldmVudHNUYXJnZXQgfHwgZXZlbnRzVGFyZ2V0Lmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciB0b3VjaElkLCBpc1RvdWNoZWQsIGlzTW92ZWQsIHRvdWNoZXNTdGFydCA9IHt9LCBpc1Njcm9sbGluZywgdG91Y2hlc0RpZmYsIHRvdWNoU3RhcnRUaW1lLCBjb250YWluZXIsIHJlZnJlc2ggPSBmYWxzZSwgdXNlVHJhbnNsYXRlID0gZmFsc2UsIHN0YXJ0VHJhbnNsYXRlID0gMCwgdHJhbnNsYXRlLCBzY3JvbGxUb3AsIHdhc1Njcm9sbGVkLCBsYXllciwgdHJpZ2dlckRpc3RhbmNlLCBkeW5hbWljVHJpZ2dlckRpc3RhbmNlLCBwdWxsU3RhcnRlZDtcbiAgICAgICAgICAgIHZhciBwYWdlID0gZXZlbnRzVGFyZ2V0Lmhhc0NsYXNzKCdwYWdlJykgPyBldmVudHNUYXJnZXQgOiBldmVudHNUYXJnZXQucGFyZW50cygnLnBhZ2UnKTtcbiAgICAgICAgICAgIHZhciBoYXNOYXZiYXIgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmIChwYWdlLmZpbmQoJy5uYXZiYXInKS5sZW5ndGggPiAwIHx8IHBhZ2UucGFyZW50cygnLm5hdmJhci1maXhlZCwgLm5hdmJhci10aHJvdWdoJykubGVuZ3RoID4gMCB8fCBwYWdlLmhhc0NsYXNzKCduYXZiYXItZml4ZWQnKSB8fCBwYWdlLmhhc0NsYXNzKCduYXZiYXItdGhyb3VnaCcpKSBoYXNOYXZiYXIgPSB0cnVlO1xuICAgICAgICAgICAgaWYgKHBhZ2UuaGFzQ2xhc3MoJ25vLW5hdmJhcicpKSBoYXNOYXZiYXIgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmICghaGFzTmF2YmFyKSBldmVudHNUYXJnZXQuYWRkQ2xhc3MoJ3B1bGwtdG8tcmVmcmVzaC1uby1uYXZiYXInKTtcbiAgICAgICAgXG4gICAgICAgICAgICBjb250YWluZXIgPSBldmVudHNUYXJnZXQ7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGVmaW5lIHRyaWdnZXIgZGlzdGFuY2VcbiAgICAgICAgICAgIGlmIChjb250YWluZXIuYXR0cignZGF0YS1wdHItZGlzdGFuY2UnKSkge1xuICAgICAgICAgICAgICAgIGR5bmFtaWNUcmlnZ2VyRGlzdGFuY2UgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdHJpZ2dlckRpc3RhbmNlID0gNDQ7ICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoU3RhcnQoZSkge1xuICAgICAgICAgICAgICAgIGlmIChpc1RvdWNoZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2Uub3MgPT09ICdhbmRyb2lkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCd0YXJnZXRUb3VjaGVzJyBpbiBlICYmIGUudGFyZ2V0VG91Y2hlcy5sZW5ndGggPiAxKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovXG4gICAgICAgICAgICAgICAgY29udGFpbmVyID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICBpZiAoY29udGFpbmVyLmhhc0NsYXNzKCdyZWZyZXNoaW5nJykpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgcHVsbFN0YXJ0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlzU2Nyb2xsaW5nID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHdhc1Njcm9sbGVkID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIGlmIChlLnR5cGUgPT09ICd0b3VjaHN0YXJ0JykgdG91Y2hJZCA9IGUudGFyZ2V0VG91Y2hlc1swXS5pZGVudGlmaWVyO1xuICAgICAgICAgICAgICAgIHRvdWNoZXNTdGFydC54ID0gZS50eXBlID09PSAndG91Y2hzdGFydCcgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBlLnBhZ2VYO1xuICAgICAgICAgICAgICAgIHRvdWNoZXNTdGFydC55ID0gZS50eXBlID09PSAndG91Y2hzdGFydCcgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgOiBlLnBhZ2VZO1xuICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRUaW1lID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWlzVG91Y2hlZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHZhciBwYWdlWCwgcGFnZVksIHRvdWNoO1xuICAgICAgICAgICAgICAgIGlmIChlLnR5cGUgPT09ICd0b3VjaG1vdmUnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0b3VjaElkICYmIGUudG91Y2hlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlLnRvdWNoZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZS50b3VjaGVzW2ldLmlkZW50aWZpZXIgPT09IHRvdWNoSWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG91Y2ggPSBlLnRvdWNoZXNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghdG91Y2gpIHRvdWNoID0gZS50YXJnZXRUb3VjaGVzWzBdO1xuICAgICAgICAgICAgICAgICAgICBwYWdlWCA9IHRvdWNoLnBhZ2VYO1xuICAgICAgICAgICAgICAgICAgICBwYWdlWSA9IHRvdWNoLnBhZ2VZO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcGFnZVggPSBlLnBhZ2VYO1xuICAgICAgICAgICAgICAgICAgICBwYWdlWSA9IGUucGFnZVk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghcGFnZVggfHwgIXBhZ2VZKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGlzU2Nyb2xsaW5nID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBpc1Njcm9sbGluZyA9ICEhKGlzU2Nyb2xsaW5nIHx8IE1hdGguYWJzKHBhZ2VZIC0gdG91Y2hlc1N0YXJ0LnkpID4gTWF0aC5hYnMocGFnZVggLSB0b3VjaGVzU3RhcnQueCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWlzU2Nyb2xsaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBzY3JvbGxUb3AgPSBjb250YWluZXJbMF0uc2Nyb2xsVG9wO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygd2FzU2Nyb2xsZWQgPT09ICd1bmRlZmluZWQnICYmIHNjcm9sbFRvcCAhPT0gMCkgd2FzU2Nyb2xsZWQgPSB0cnVlOyBcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovXG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5yZW1vdmVDbGFzcygndHJhbnNpdGlvbmluZycpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2Nyb2xsVG9wID4gY29udGFpbmVyWzBdLm9mZnNldEhlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGR5bmFtaWNUcmlnZ2VyRGlzdGFuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyaWdnZXJEaXN0YW5jZSA9IGNvbnRhaW5lci5hdHRyKCdkYXRhLXB0ci1kaXN0YW5jZScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyaWdnZXJEaXN0YW5jZS5pbmRleE9mKCclJykgPj0gMCkgdHJpZ2dlckRpc3RhbmNlID0gY29udGFpbmVyWzBdLm9mZnNldEhlaWdodCAqIHBhcnNlSW50KHRyaWdnZXJEaXN0YW5jZSwgMTApIC8gMTAwO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHN0YXJ0VHJhbnNsYXRlID0gY29udGFpbmVyLmhhc0NsYXNzKCdyZWZyZXNoaW5nJykgPyB0cmlnZ2VyRGlzdGFuY2UgOiAwO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY29udGFpbmVyWzBdLnNjcm9sbEhlaWdodCA9PT0gY29udGFpbmVyWzBdLm9mZnNldEhlaWdodCB8fCBhcHAuZGV2aWNlLm9zICE9PSAnaW9zJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXNlVHJhbnNsYXRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZVRyYW5zbGF0ZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlzTW92ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRvdWNoZXNEaWZmID0gcGFnZVkgLSB0b3VjaGVzU3RhcnQueTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAodG91Y2hlc0RpZmYgPiAwICYmIHNjcm9sbFRvcCA8PSAwIHx8IHNjcm9sbFRvcCA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gaU9TIDggZml4XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLm9zID09PSAnaW9zJyAmJiBwYXJzZUludChhcHAuZGV2aWNlLm9zVmVyc2lvbi5zcGxpdCgnLicpWzBdLCAxMCkgPiA3ICYmIHNjcm9sbFRvcCA9PT0gMCAmJiAhd2FzU2Nyb2xsZWQpIHVzZVRyYW5zbGF0ZSA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAodXNlVHJhbnNsYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGUgPSAoTWF0aC5wb3codG91Y2hlc0RpZmYsIDAuODUpICsgc3RhcnRUcmFuc2xhdGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwnICsgdHJhbnNsYXRlICsgJ3B4LDApJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCh1c2VUcmFuc2xhdGUgJiYgTWF0aC5wb3codG91Y2hlc0RpZmYsIDAuODUpID4gdHJpZ2dlckRpc3RhbmNlKSB8fCAoIXVzZVRyYW5zbGF0ZSAmJiB0b3VjaGVzRGlmZiA+PSB0cmlnZ2VyRGlzdGFuY2UgKiAyKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVmcmVzaCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuYWRkQ2xhc3MoJ3B1bGwtdXAnKS5yZW1vdmVDbGFzcygncHVsbC1kb3duJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWZyZXNoID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIucmVtb3ZlQ2xhc3MoJ3B1bGwtdXAnKS5hZGRDbGFzcygncHVsbC1kb3duJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwdWxsU3RhcnRlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLnRyaWdnZXIoJ3B1bGxzdGFydCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHVsbFN0YXJ0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci50cmlnZ2VyKCdwdWxsbW92ZScsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50OiBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgc2Nyb2xsVG9wOiBzY3JvbGxUb3AsXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGU6IHRyYW5zbGF0ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdWNoZXNEaWZmOiB0b3VjaGVzRGlmZlxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHB1bGxTdGFydGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5yZW1vdmVDbGFzcygncHVsbC11cCBwdWxsLWRvd24nKTtcbiAgICAgICAgICAgICAgICAgICAgcmVmcmVzaCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoZSkge1xuICAgICAgICAgICAgICAgIGlmIChlLnR5cGUgPT09ICd0b3VjaGVuZCcgJiYgZS5jaGFuZ2VkVG91Y2hlcyAmJiBlLmNoYW5nZWRUb3VjaGVzLmxlbmd0aCA+IDAgJiYgdG91Y2hJZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZS5jaGFuZ2VkVG91Y2hlc1swXS5pZGVudGlmaWVyICE9PSB0b3VjaElkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghaXNUb3VjaGVkIHx8ICFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuYWRkQ2xhc3MoJ3RyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlID0gMDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29udGFpbmVyLnRyYW5zZm9ybSgnJyk7XG4gICAgICAgICAgICAgICAgaWYgKHJlZnJlc2gpIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmFkZENsYXNzKCdyZWZyZXNoaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci50cmlnZ2VyKCdyZWZyZXNoJywge1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5wdWxsVG9SZWZyZXNoRG9uZShjb250YWluZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5yZW1vdmVDbGFzcygncHVsbC1kb3duJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAocHVsbFN0YXJ0ZWQpIGNvbnRhaW5lci50cmlnZ2VyKCdwdWxsZW5kJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQXR0YWNoIEV2ZW50c1xuICAgICAgICAgICAgZXZlbnRzVGFyZ2V0Lm9uKGFwcC50b3VjaEV2ZW50cy5zdGFydCwgaGFuZGxlVG91Y2hTdGFydCk7XG4gICAgICAgICAgICBldmVudHNUYXJnZXQub24oYXBwLnRvdWNoRXZlbnRzLm1vdmUsIGhhbmRsZVRvdWNoTW92ZSk7XG4gICAgICAgICAgICBldmVudHNUYXJnZXQub24oYXBwLnRvdWNoRXZlbnRzLmVuZCwgaGFuZGxlVG91Y2hFbmQpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIERldGFjaCBFdmVudHMgb24gcGFnZSByZW1vdmVcbiAgICAgICAgICAgIGlmIChwYWdlLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgZnVuY3Rpb24gZGVzdHJveVB1bGxUb1JlZnJlc2goKSB7XG4gICAgICAgICAgICAgICAgZXZlbnRzVGFyZ2V0Lm9mZihhcHAudG91Y2hFdmVudHMuc3RhcnQsIGhhbmRsZVRvdWNoU3RhcnQpO1xuICAgICAgICAgICAgICAgIGV2ZW50c1RhcmdldC5vZmYoYXBwLnRvdWNoRXZlbnRzLm1vdmUsIGhhbmRsZVRvdWNoTW92ZSk7XG4gICAgICAgICAgICAgICAgZXZlbnRzVGFyZ2V0Lm9mZihhcHAudG91Y2hFdmVudHMuZW5kLCBoYW5kbGVUb3VjaEVuZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBldmVudHNUYXJnZXRbMF0uZjdEZXN0cm95UHVsbFRvUmVmcmVzaCA9IGRlc3Ryb3lQdWxsVG9SZWZyZXNoO1xuICAgICAgICAgICAgZnVuY3Rpb24gZGV0YWNoRXZlbnRzKCkge1xuICAgICAgICAgICAgICAgIGRlc3Ryb3lQdWxsVG9SZWZyZXNoKCk7XG4gICAgICAgICAgICAgICAgcGFnZS5vZmYoJ3BhZ2VCZWZvcmVSZW1vdmUnLCBkZXRhY2hFdmVudHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGFnZS5vbigncGFnZUJlZm9yZVJlbW92ZScsIGRldGFjaEV2ZW50cyk7XG4gICAgICAgIFxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgYXBwLnB1bGxUb1JlZnJlc2hEb25lID0gZnVuY3Rpb24gKGNvbnRhaW5lcikge1xuICAgICAgICAgICAgY29udGFpbmVyID0gJChjb250YWluZXIpO1xuICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5sZW5ndGggPT09IDApIGNvbnRhaW5lciA9ICQoJy5wdWxsLXRvLXJlZnJlc2gtY29udGVudC5yZWZyZXNoaW5nJyk7XG4gICAgICAgICAgICBjb250YWluZXIucmVtb3ZlQ2xhc3MoJ3JlZnJlc2hpbmcnKS5hZGRDbGFzcygndHJhbnNpdGlvbmluZycpO1xuICAgICAgICAgICAgY29udGFpbmVyLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5yZW1vdmVDbGFzcygndHJhbnNpdGlvbmluZyBwdWxsLXVwIHB1bGwtZG93bicpO1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci50cmlnZ2VyKCdyZWZyZXNoZG9uZScpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5wdWxsVG9SZWZyZXNoVHJpZ2dlciA9IGZ1bmN0aW9uIChjb250YWluZXIpIHtcbiAgICAgICAgICAgIGNvbnRhaW5lciA9ICQoY29udGFpbmVyKTtcbiAgICAgICAgICAgIGlmIChjb250YWluZXIubGVuZ3RoID09PSAwKSBjb250YWluZXIgPSAkKCcucHVsbC10by1yZWZyZXNoLWNvbnRlbnQnKTtcbiAgICAgICAgICAgIGlmIChjb250YWluZXIuaGFzQ2xhc3MoJ3JlZnJlc2hpbmcnKSkgcmV0dXJuO1xuICAgICAgICAgICAgY29udGFpbmVyLmFkZENsYXNzKCd0cmFuc2l0aW9uaW5nIHJlZnJlc2hpbmcnKTtcbiAgICAgICAgICAgIGNvbnRhaW5lci50cmlnZ2VyKCdyZWZyZXNoJywge1xuICAgICAgICAgICAgICAgIGRvbmU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnB1bGxUb1JlZnJlc2hEb25lKGNvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBhcHAuZGVzdHJveVB1bGxUb1JlZnJlc2ggPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICB2YXIgcHVsbFRvUmVmcmVzaENvbnRlbnQgPSBwYWdlQ29udGFpbmVyLmhhc0NsYXNzKCdwdWxsLXRvLXJlZnJlc2gtY29udGVudCcpID8gcGFnZUNvbnRhaW5lciA6IHBhZ2VDb250YWluZXIuZmluZCgnLnB1bGwtdG8tcmVmcmVzaC1jb250ZW50Jyk7XG4gICAgICAgICAgICBpZiAocHVsbFRvUmVmcmVzaENvbnRlbnQubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBpZiAocHVsbFRvUmVmcmVzaENvbnRlbnRbMF0uZjdEZXN0cm95UHVsbFRvUmVmcmVzaCkgcHVsbFRvUmVmcmVzaENvbnRlbnRbMF0uZjdEZXN0cm95UHVsbFRvUmVmcmVzaCgpO1xuICAgICAgICB9O1xuICAgICAgICBcblxuICAgICAgICAvKiA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIEluZmluaXRlIFNjcm9sbCAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovXG4gICAgICAgIGZ1bmN0aW9uIGhhbmRsZUluZmluaXRlU2Nyb2xsKCkge1xuICAgICAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi9cbiAgICAgICAgICAgIHZhciBpbmYgPSAkKHRoaXMpO1xuICAgICAgICAgICAgdmFyIHNjcm9sbFRvcCA9IGluZlswXS5zY3JvbGxUb3A7XG4gICAgICAgICAgICB2YXIgc2Nyb2xsSGVpZ2h0ID0gaW5mWzBdLnNjcm9sbEhlaWdodDtcbiAgICAgICAgICAgIHZhciBoZWlnaHQgPSBpbmZbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgdmFyIGRpc3RhbmNlID0gaW5mWzBdLmdldEF0dHJpYnV0ZSgnZGF0YS1kaXN0YW5jZScpO1xuICAgICAgICAgICAgdmFyIHZpcnR1YWxMaXN0Q29udGFpbmVyID0gaW5mLmZpbmQoJy52aXJ0dWFsLWxpc3QnKTtcbiAgICAgICAgICAgIHZhciB2aXJ0dWFsTGlzdDtcbiAgICAgICAgICAgIHZhciBvblRvcCA9IGluZi5oYXNDbGFzcygnaW5maW5pdGUtc2Nyb2xsLXRvcCcpO1xuICAgICAgICAgICAgaWYgKCFkaXN0YW5jZSkgZGlzdGFuY2UgPSA1MDtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgZGlzdGFuY2UgPT09ICdzdHJpbmcnICYmIGRpc3RhbmNlLmluZGV4T2YoJyUnKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgZGlzdGFuY2UgPSBwYXJzZUludChkaXN0YW5jZSwgMTApIC8gMTAwICogaGVpZ2h0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGRpc3RhbmNlID4gaGVpZ2h0KSBkaXN0YW5jZSA9IGhlaWdodDtcbiAgICAgICAgICAgIGlmIChvblRvcCkge1xuICAgICAgICAgICAgICAgIGlmIChzY3JvbGxUb3AgPCBkaXN0YW5jZSkge1xuICAgICAgICAgICAgICAgICAgICBpbmYudHJpZ2dlcignaW5maW5pdGUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoc2Nyb2xsVG9wICsgaGVpZ2h0ID49IHNjcm9sbEhlaWdodCAtIGRpc3RhbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2aXJ0dWFsTGlzdENvbnRhaW5lci5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2aXJ0dWFsTGlzdCA9IHZpcnR1YWxMaXN0Q29udGFpbmVyWzBdLmY3VmlydHVhbExpc3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlydHVhbExpc3QgJiYgIXZpcnR1YWxMaXN0LnJlYWNoRW5kKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaW5mLnRyaWdnZXIoJ2luZmluaXRlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICBhcHAuYXR0YWNoSW5maW5pdGVTY3JvbGwgPSBmdW5jdGlvbiAoaW5maW5pdGVDb250ZW50KSB7XG4gICAgICAgICAgICAkKGluZmluaXRlQ29udGVudCkub24oJ3Njcm9sbCcsIGhhbmRsZUluZmluaXRlU2Nyb2xsKTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmRldGFjaEluZmluaXRlU2Nyb2xsID0gZnVuY3Rpb24gKGluZmluaXRlQ29udGVudCkge1xuICAgICAgICAgICAgJChpbmZpbml0ZUNvbnRlbnQpLm9mZignc2Nyb2xsJywgaGFuZGxlSW5maW5pdGVTY3JvbGwpO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgYXBwLmluaXRQYWdlSW5maW5pdGVTY3JvbGwgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICB2YXIgaW5maW5pdGVDb250ZW50ID0gcGFnZUNvbnRhaW5lci5maW5kKCcuaW5maW5pdGUtc2Nyb2xsJyk7XG4gICAgICAgICAgICBpZiAoaW5maW5pdGVDb250ZW50Lmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgYXBwLmF0dGFjaEluZmluaXRlU2Nyb2xsKGluZmluaXRlQ29udGVudCk7XG4gICAgICAgICAgICBmdW5jdGlvbiBkZXRhY2hFdmVudHMoKSB7XG4gICAgICAgICAgICAgICAgYXBwLmRldGFjaEluZmluaXRlU2Nyb2xsKGluZmluaXRlQ29udGVudCk7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5vZmYoJ3BhZ2VCZWZvcmVSZW1vdmUnLCBkZXRhY2hFdmVudHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5vbigncGFnZUJlZm9yZVJlbW92ZScsIGRldGFjaEV2ZW50cyk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIEhpZGUvc2hvdyBUb29sYmFyL05hdmJhciBvbiBzY3JvbGwgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5pbml0UGFnZVNjcm9sbFRvb2xiYXJzID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgdmFyIHNjcm9sbENvbnRlbnQgPSBwYWdlQ29udGFpbmVyLmZpbmQoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgICAgIGlmIChzY3JvbGxDb250ZW50Lmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgdmFyIGhpZGVOYXZiYXIgPSAoYXBwLnBhcmFtcy5oaWRlTmF2YmFyT25QYWdlU2Nyb2xsIHx8IHNjcm9sbENvbnRlbnQuaGFzQ2xhc3MoJ2hpZGUtbmF2YmFyLW9uLXNjcm9sbCcpIHx8IHNjcm9sbENvbnRlbnQuaGFzQ2xhc3MoJ2hpZGUtYmFycy1vbi1zY3JvbGwnKSkgJiYgIShzY3JvbGxDb250ZW50Lmhhc0NsYXNzKCdrZWVwLW5hdmJhci1vbi1zY3JvbGwnKSB8fCBzY3JvbGxDb250ZW50Lmhhc0NsYXNzKCdrZWVwLWJhcnMtb24tc2Nyb2xsJykpO1xuICAgICAgICAgICAgdmFyIGhpZGVUb29sYmFyID0gKGFwcC5wYXJhbXMuaGlkZVRvb2xiYXJPblBhZ2VTY3JvbGwgfHwgc2Nyb2xsQ29udGVudC5oYXNDbGFzcygnaGlkZS10b29sYmFyLW9uLXNjcm9sbCcpIHx8IHNjcm9sbENvbnRlbnQuaGFzQ2xhc3MoJ2hpZGUtYmFycy1vbi1zY3JvbGwnKSkgJiYgIShzY3JvbGxDb250ZW50Lmhhc0NsYXNzKCdrZWVwLXRvb2xiYXItb24tc2Nyb2xsJykgfHwgc2Nyb2xsQ29udGVudC5oYXNDbGFzcygna2VlcC1iYXJzLW9uLXNjcm9sbCcpKTtcbiAgICAgICAgICAgIHZhciBoaWRlVGFiYmFyID0gKGFwcC5wYXJhbXMuaGlkZVRhYmJhck9uUGFnZVNjcm9sbCB8fCBzY3JvbGxDb250ZW50Lmhhc0NsYXNzKCdoaWRlLXRhYmJhci1vbi1zY3JvbGwnKSkgJiYgIShzY3JvbGxDb250ZW50Lmhhc0NsYXNzKCdrZWVwLXRhYmJhci1vbi1zY3JvbGwnKSk7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKCEoaGlkZU5hdmJhciB8fCBoaWRlVG9vbGJhciB8fCBoaWRlVGFiYmFyKSkgcmV0dXJuO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB2YXIgdmlld0NvbnRhaW5lciA9IHNjcm9sbENvbnRlbnQucGFyZW50cygnLicgKyBhcHAucGFyYW1zLnZpZXdDbGFzcyk7XG4gICAgICAgICAgICBpZiAodmlld0NvbnRhaW5lci5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgbmF2YmFyID0gdmlld0NvbnRhaW5lci5maW5kKCcubmF2YmFyJyksIFxuICAgICAgICAgICAgICAgIHRvb2xiYXIgPSB2aWV3Q29udGFpbmVyLmZpbmQoJy50b29sYmFyJyksIFxuICAgICAgICAgICAgICAgIHRhYmJhcjtcbiAgICAgICAgICAgIGlmIChoaWRlVGFiYmFyKSB7XG4gICAgICAgICAgICAgICAgdGFiYmFyID0gdmlld0NvbnRhaW5lci5maW5kKCcudGFiYmFyJyk7XG4gICAgICAgICAgICAgICAgaWYgKHRhYmJhci5sZW5ndGggPT09IDApIHRhYmJhciA9IHZpZXdDb250YWluZXIucGFyZW50cygnLicgKyBhcHAucGFyYW1zLnZpZXdzQ2xhc3MpLmZpbmQoJy50YWJiYXInKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgaGFzTmF2YmFyID0gbmF2YmFyLmxlbmd0aCA+IDAsXG4gICAgICAgICAgICAgICAgaGFzVG9vbGJhciA9IHRvb2xiYXIubGVuZ3RoID4gMCxcbiAgICAgICAgICAgICAgICBoYXNUYWJiYXIgPSB0YWJiYXIgJiYgdGFiYmFyLmxlbmd0aCA+IDA7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHByZXZpb3VzU2Nyb2xsLCBjdXJyZW50U2Nyb2xsO1xuICAgICAgICAgICAgICAgIHByZXZpb3VzU2Nyb2xsID0gY3VycmVudFNjcm9sbCA9IHNjcm9sbENvbnRlbnRbMF0uc2Nyb2xsVG9wO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBzY3JvbGxIZWlnaHQsIG9mZnNldEhlaWdodCwgcmVhY2hFbmQsIGFjdGlvbiwgbmF2YmFySGlkZGVuLCB0b29sYmFySGlkZGVuLCB0YWJiYXJIaWRkZW47XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHRvb2xiYXJIZWlnaHQgPSAoaGFzVG9vbGJhciAmJiBoaWRlVG9vbGJhcikgPyB0b29sYmFyWzBdLm9mZnNldEhlaWdodCA6IDA7XG4gICAgICAgICAgICB2YXIgdGFiYmFySGVpZ2h0ID0gKGhhc1RhYmJhciAmJiBoaWRlVGFiYmFyKSA/IHRhYmJhclswXS5vZmZzZXRIZWlnaHQgOiAwO1xuICAgICAgICAgICAgdmFyIGJvdHRvbUJhckhlaWdodCA9IHRhYmJhckhlaWdodCB8fCB0b29sYmFySGVpZ2h0O1xuICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVNjcm9sbChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBhZ2VDb250YWluZXIuaGFzQ2xhc3MoJ3BhZ2Utb24tbGVmdCcpKSByZXR1cm47XG4gICAgICAgICAgICAgICAgY3VycmVudFNjcm9sbCA9IHNjcm9sbENvbnRlbnRbMF0uc2Nyb2xsVG9wO1xuICAgICAgICAgICAgICAgIHNjcm9sbEhlaWdodCA9IHNjcm9sbENvbnRlbnRbMF0uc2Nyb2xsSGVpZ2h0O1xuICAgICAgICAgICAgICAgIG9mZnNldEhlaWdodCA9IHNjcm9sbENvbnRlbnRbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgIHJlYWNoRW5kID0gIGN1cnJlbnRTY3JvbGwgKyBvZmZzZXRIZWlnaHQgPj0gc2Nyb2xsSGVpZ2h0IC0gYm90dG9tQmFySGVpZ2h0O1xuICAgICAgICAgICAgICAgIG5hdmJhckhpZGRlbiA9IG5hdmJhci5oYXNDbGFzcygnbmF2YmFyLWhpZGRlbicpO1xuICAgICAgICAgICAgICAgIHRvb2xiYXJIaWRkZW4gPSB0b29sYmFyLmhhc0NsYXNzKCd0b29sYmFyLWhpZGRlbicpO1xuICAgICAgICAgICAgICAgIHRhYmJhckhpZGRlbiA9IHRhYmJhciAmJiB0YWJiYXIuaGFzQ2xhc3MoJ3Rvb2xiYXItaGlkZGVuJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChyZWFjaEVuZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5zaG93QmFyc09uUGFnZVNjcm9sbEVuZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gJ3Nob3cnO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHByZXZpb3VzU2Nyb2xsID4gY3VycmVudFNjcm9sbCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5zaG93QmFyc09uUGFnZVNjcm9sbFRvcCB8fCBjdXJyZW50U2Nyb2xsIDw9IDQ0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSAnc2hvdyc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSAnaGlkZSc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50U2Nyb2xsID4gNDQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbiA9ICdoaWRlJztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbiA9ICdzaG93JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gJ3Nob3cnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChoYXNOYXZiYXIgJiYgaGlkZU5hdmJhciAmJiBuYXZiYXJIaWRkZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5zaG93TmF2YmFyKG5hdmJhcik7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyLnJlbW92ZUNsYXNzKCduby1uYXZiYXItYnktc2Nyb2xsJyk7IFxuICAgICAgICAgICAgICAgICAgICAgICAgbmF2YmFySGlkZGVuID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc1Rvb2xiYXIgJiYgaGlkZVRvb2xiYXIgJiYgdG9vbGJhckhpZGRlbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnNob3dUb29sYmFyKHRvb2xiYXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5yZW1vdmVDbGFzcygnbm8tdG9vbGJhci1ieS1zY3JvbGwnKTsgXG4gICAgICAgICAgICAgICAgICAgICAgICB0b29sYmFySGlkZGVuID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc1RhYmJhciAmJiBoaWRlVGFiYmFyICYmIHRhYmJhckhpZGRlbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnNob3dUb29sYmFyKHRhYmJhcik7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyLnJlbW92ZUNsYXNzKCduby10YWJiYXItYnktc2Nyb2xsJyk7IFxuICAgICAgICAgICAgICAgICAgICAgICAgdGFiYmFySGlkZGVuID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChoYXNOYXZiYXIgJiYgaGlkZU5hdmJhciAmJiAhbmF2YmFySGlkZGVuKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuaGlkZU5hdmJhcihuYXZiYXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5hZGRDbGFzcygnbm8tbmF2YmFyLWJ5LXNjcm9sbCcpOyBcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hdmJhckhpZGRlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc1Rvb2xiYXIgJiYgaGlkZVRvb2xiYXIgJiYgIXRvb2xiYXJIaWRkZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5oaWRlVG9vbGJhcih0b29sYmFyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIuYWRkQ2xhc3MoJ25vLXRvb2xiYXItYnktc2Nyb2xsJyk7IFxuICAgICAgICAgICAgICAgICAgICAgICAgdG9vbGJhckhpZGRlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGhhc1RhYmJhciAmJiBoaWRlVGFiYmFyICYmICF0YWJiYXJIaWRkZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5oaWRlVG9vbGJhcih0YWJiYXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5hZGRDbGFzcygnbm8tdGFiYmFyLWJ5LXNjcm9sbCcpOyBcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhYmJhckhpZGRlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHByZXZpb3VzU2Nyb2xsID0gY3VycmVudFNjcm9sbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNjcm9sbENvbnRlbnQub24oJ3Njcm9sbCcsIGhhbmRsZVNjcm9sbCk7XG4gICAgICAgICAgICBzY3JvbGxDb250ZW50WzBdLmY3U2Nyb2xsVG9vbGJhcnNIYW5kbGVyID0gaGFuZGxlU2Nyb2xsO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuZGVzdHJveVNjcm9sbFRvb2xiYXJzID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgdmFyIHNjcm9sbENvbnRlbnQgPSBwYWdlQ29udGFpbmVyLmZpbmQoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgICAgIGlmIChzY3JvbGxDb250ZW50Lmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgdmFyIGhhbmRsZXIgPSBzY3JvbGxDb250ZW50WzBdLmY3U2Nyb2xsVG9vbGJhcnNIYW5kbGVyO1xuICAgICAgICAgICAgaWYgKCFoYW5kbGVyKSByZXR1cm47XG4gICAgICAgICAgICBzY3JvbGxDb250ZW50Lm9mZignc2Nyb2xsJywgc2Nyb2xsQ29udGVudFswXS5mN1Njcm9sbFRvb2xiYXJzSGFuZGxlcik7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgTWF0ZXJpYWwgVGFiYmFyICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5tYXRlcmlhbFRhYmJhclNldEhpZ2hsaWdodCA9IGZ1bmN0aW9uICh0YWJiYXIsIGFjdGl2ZUxpbmspIHtcbiAgICAgICAgICAgIHRhYmJhciA9ICQodGFiYmFyKTtcbiAgICAgICAgICAgIGFjdGl2ZUxpbmsgPSBhY3RpdmVMaW5rIHx8IHRhYmJhci5maW5kKCcudGFiLWxpbmsuYWN0aXZlJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHRhYkxpbmtXaWR0aCwgaGlnaGxpZ2h0VHJhbnNsYXRlO1xuICAgICAgICAgICAgaWYgKHRhYmJhci5oYXNDbGFzcygndGFiYmFyLXNjcm9sbGFibGUnKSkge1xuICAgICAgICAgICAgICAgIHRhYkxpbmtXaWR0aCA9IGFjdGl2ZUxpbmtbMF0ub2Zmc2V0V2lkdGggKyAncHgnO1xuICAgICAgICAgICAgICAgIGhpZ2hsaWdodFRyYW5zbGF0ZSA9IChhcHAucnRsID8gLSBhY3RpdmVMaW5rWzBdLm9mZnNldExlZnQ6IGFjdGl2ZUxpbmtbMF0ub2Zmc2V0TGVmdCkgKyAncHgnO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGFiTGlua1dpZHRoID0gMSAvIHRhYmJhci5maW5kKCcudGFiLWxpbmsnKS5sZW5ndGggKiAxMDAgKyAnJSc7XG4gICAgICAgICAgICAgICAgaGlnaGxpZ2h0VHJhbnNsYXRlID0gKGFwcC5ydGwgPyAtIGFjdGl2ZUxpbmsuaW5kZXgoKTogYWN0aXZlTGluay5pbmRleCgpKSAqIDEwMCArICclJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB0YWJiYXIuZmluZCgnLnRhYi1saW5rLWhpZ2hsaWdodCcpXG4gICAgICAgICAgICAgICAgLmNzcyh7d2lkdGg6IHRhYkxpbmtXaWR0aH0pXG4gICAgICAgICAgICAgICAgLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIGhpZ2hsaWdodFRyYW5zbGF0ZSArICcsMCwwKScpO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuaW5pdFBhZ2VNYXRlcmlhbFRhYmJhciA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIHZhciB0YWJiYXIgPSAkKHBhZ2VDb250YWluZXIpLmZpbmQoJy50YWJiYXInKTtcbiAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiB0YWJiYXJTZXRIaWdobGlnaHQoKSB7XG4gICAgICAgICAgICAgICAgYXBwLm1hdGVyaWFsVGFiYmFyU2V0SGlnaGxpZ2h0KHRhYmJhcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGFiYmFyLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBpZiAodGFiYmFyLmZpbmQoJy50YWItbGluay1oaWdobGlnaHQnKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdGFiYmFyLmZpbmQoJy50b29sYmFyLWlubmVyJykuYXBwZW5kKCc8c3BhbiBjbGFzcz1cInRhYi1saW5rLWhpZ2hsaWdodFwiPjwvc3Bhbj4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHRhYmJhclNldEhpZ2hsaWdodCgpO1xuICAgICAgICAgICAgICAgICQod2luZG93KS5vbigncmVzaXplJywgdGFiYmFyU2V0SGlnaGxpZ2h0KTtcbiAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyLm9uY2UoJ3BhZ2VCZWZvcmVSZW1vdmUnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICQod2luZG93KS5vZmYoJ3Jlc2l6ZScsIHRhYmJhclNldEhpZ2hsaWdodCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBUYWJzICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi9cbiAgICAgICAgYXBwLnNob3dUYWIgPSBmdW5jdGlvbiAodGFiLCB0YWJMaW5rLCBmb3JjZSkge1xuICAgICAgICAgICAgdmFyIG5ld1RhYiA9ICQodGFiKTtcbiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0YWJMaW5rID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yY2UgPSB0YWJMaW5rO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChuZXdUYWIubGVuZ3RoID09PSAwKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICBpZiAobmV3VGFiLmhhc0NsYXNzKCdhY3RpdmUnKSkge1xuICAgICAgICAgICAgICAgIGlmIChmb3JjZSkgbmV3VGFiLnRyaWdnZXIoJ3Nob3cnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgdGFicyA9IG5ld1RhYi5wYXJlbnQoJy50YWJzJyk7XG4gICAgICAgICAgICBpZiAodGFicy5sZW5ndGggPT09IDApIHJldHVybiBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBSZXR1cm4gc3dpcGVvdXRzIGluIGhpZGRlbiB0YWJzXG4gICAgICAgICAgICBhcHAuYWxsb3dTd2lwZW91dCA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQW5pbWF0ZWQgdGFic1xuICAgICAgICAgICAgdmFyIGlzQW5pbWF0ZWRUYWJzID0gdGFicy5wYXJlbnQoKS5oYXNDbGFzcygndGFicy1hbmltYXRlZC13cmFwJyk7XG4gICAgICAgICAgICBpZiAoaXNBbmltYXRlZFRhYnMpIHtcbiAgICAgICAgICAgICAgICB2YXIgdGFiVHJhbnNsYXRlID0gKGFwcC5ydGwgPyBuZXdUYWIuaW5kZXgoKSA6IC1uZXdUYWIuaW5kZXgoKSkgKiAxMDA7XG4gICAgICAgICAgICAgICAgdGFicy50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyB0YWJUcmFuc2xhdGUgKyAnJSwwLDApJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU3dpcGVhYmxlIHRhYnNcbiAgICAgICAgICAgIHZhciBpc1N3aXBlYWJsZVRhYnMgPSB0YWJzLnBhcmVudCgpLmhhc0NsYXNzKCd0YWJzLXN3aXBlYWJsZS13cmFwJyksIHN3aXBlcjtcbiAgICAgICAgICAgIGlmIChpc1N3aXBlYWJsZVRhYnMpIHtcbiAgICAgICAgICAgICAgICBzd2lwZXIgPSB0YWJzLnBhcmVudCgpWzBdLnN3aXBlcjtcbiAgICAgICAgICAgICAgICBpZiAoc3dpcGVyLmFjdGl2ZUluZGV4ICE9PSBuZXdUYWIuaW5kZXgoKSkgc3dpcGVyLnNsaWRlVG8obmV3VGFiLmluZGV4KCksIHVuZGVmaW5lZCwgZmFsc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFJlbW92ZSBhY3RpdmUgY2xhc3MgZnJvbSBvbGQgdGFic1xuICAgICAgICAgICAgdmFyIG9sZFRhYiA9IHRhYnMuY2hpbGRyZW4oJy50YWIuYWN0aXZlJykucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpO1xuICAgICAgICAgICAgLy8gQWRkIGFjdGl2ZSBjbGFzcyB0byBuZXcgdGFiXG4gICAgICAgICAgICBuZXdUYWIuYWRkQ2xhc3MoJ2FjdGl2ZScpO1xuICAgICAgICAgICAgLy8gVHJpZ2dlciAnc2hvdycgZXZlbnQgb24gbmV3IHRhYlxuICAgICAgICAgICAgbmV3VGFiLnRyaWdnZXIoJ3Nob3cnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBVcGRhdGUgbmF2YmFycyBpbiBuZXcgdGFiXG4gICAgICAgICAgICBpZiAoIWlzQW5pbWF0ZWRUYWJzICYmICFpc1N3aXBlYWJsZVRhYnMgJiYgbmV3VGFiLmZpbmQoJy5uYXZiYXInKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgLy8gRmluZCB0YWIncyB2aWV3XG4gICAgICAgICAgICAgICAgdmFyIHZpZXdDb250YWluZXI7XG4gICAgICAgICAgICAgICAgaWYgKG5ld1RhYi5oYXNDbGFzcyhhcHAucGFyYW1zLnZpZXdDbGFzcykpIHZpZXdDb250YWluZXIgPSBuZXdUYWJbMF07XG4gICAgICAgICAgICAgICAgZWxzZSB2aWV3Q29udGFpbmVyID0gbmV3VGFiLnBhcmVudHMoJy4nICsgYXBwLnBhcmFtcy52aWV3Q2xhc3MpWzBdO1xuICAgICAgICAgICAgICAgIGFwcC5zaXplTmF2YmFycyh2aWV3Q29udGFpbmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBGaW5kIHJlbGF0ZWQgbGluayBmb3IgbmV3IHRhYlxuICAgICAgICAgICAgaWYgKHRhYkxpbmspIHRhYkxpbmsgPSAkKHRhYkxpbmspO1xuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gU2VhcmNoIGJ5IGlkXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0YWIgPT09ICdzdHJpbmcnKSB0YWJMaW5rID0gJCgnLnRhYi1saW5rW2hyZWY9XCInICsgdGFiICsgJ1wiXScpO1xuICAgICAgICAgICAgICAgIGVsc2UgdGFiTGluayA9ICQoJy50YWItbGlua1tocmVmPVwiIycgKyBuZXdUYWIuYXR0cignaWQnKSArICdcIl0nKTtcbiAgICAgICAgICAgICAgICAvLyBTZWFyY2ggYnkgZGF0YS10YWJcbiAgICAgICAgICAgICAgICBpZiAoIXRhYkxpbmsgfHwgdGFiTGluayAmJiB0YWJMaW5rLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAkKCdbZGF0YS10YWJdJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3VGFiLmlzKCQodGhpcykuYXR0cignZGF0YS10YWInKSkpIHRhYkxpbmsgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGFiTGluay5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBGaW5kIHJlbGF0ZWQgbGluayBmb3Igb2xkIHRhYlxuICAgICAgICAgICAgdmFyIG9sZFRhYkxpbms7XG4gICAgICAgICAgICBpZiAob2xkVGFiICYmIG9sZFRhYi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgLy8gU2VhcmNoIGJ5IGlkXG4gICAgICAgICAgICAgICAgdmFyIG9sZFRhYklkID0gb2xkVGFiLmF0dHIoJ2lkJyk7XG4gICAgICAgICAgICAgICAgaWYgKG9sZFRhYklkKSBvbGRUYWJMaW5rID0gJCgnLnRhYi1saW5rW2hyZWY9XCIjJyArIG9sZFRhYklkICsgJ1wiXScpO1xuICAgICAgICAgICAgICAgIC8vIFNlYXJjaCBieSBkYXRhLXRhYlxuICAgICAgICAgICAgICAgIGlmICghb2xkVGFiTGluayB8fCBvbGRUYWJMaW5rICYmIG9sZFRhYkxpbmsubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICQoJ1tkYXRhLXRhYl0nKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvbGRUYWIuaXMoJCh0aGlzKS5hdHRyKCdkYXRhLXRhYicpKSkgb2xkVGFiTGluayA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBVcGRhdGUgbGlua3MnIGNsYXNzZXNcbiAgICAgICAgICAgIGlmICh0YWJMaW5rICYmIHRhYkxpbmsubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHRhYkxpbmsuYWRkQ2xhc3MoJ2FjdGl2ZScpO1xuICAgICAgICAgICAgICAgIC8vIE1hdGVyaWFsIEhpZ2hsaWdodFxuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0YWJiYXIgPSB0YWJMaW5rLnBhcmVudHMoJy50YWJiYXInKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhYmJhci5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFiYmFyLmZpbmQoJy50YWItbGluay1oaWdobGlnaHQnKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWJiYXIuZmluZCgnLnRvb2xiYXItaW5uZXInKS5hcHBlbmQoJzxzcGFuIGNsYXNzPVwidGFiLWxpbmstaGlnaGxpZ2h0XCI+PC9zcGFuPicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLm1hdGVyaWFsVGFiYmFyU2V0SGlnaGxpZ2h0KHRhYmJhciwgdGFiTGluayk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob2xkVGFiTGluayAmJiBvbGRUYWJMaW5rLmxlbmd0aCA+IDApIG9sZFRhYkxpbmsucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpO1xuICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBBY2NvcmRpb24gICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5hY2NvcmRpb25Ub2dnbGUgPSBmdW5jdGlvbiAoaXRlbSkge1xuICAgICAgICAgICAgaXRlbSA9ICQoaXRlbSk7XG4gICAgICAgICAgICBpZiAoaXRlbS5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIGlmIChpdGVtLmhhc0NsYXNzKCdhY2NvcmRpb24taXRlbS1leHBhbmRlZCcpKSBhcHAuYWNjb3JkaW9uQ2xvc2UoaXRlbSk7XG4gICAgICAgICAgICBlbHNlIGFwcC5hY2NvcmRpb25PcGVuKGl0ZW0pO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuYWNjb3JkaW9uT3BlbiA9IGZ1bmN0aW9uIChpdGVtKSB7XG4gICAgICAgICAgICBpdGVtID0gJChpdGVtKTtcbiAgICAgICAgICAgIHZhciBsaXN0ID0gaXRlbS5wYXJlbnRzKCcuYWNjb3JkaW9uLWxpc3QnKS5lcSgwKTtcbiAgICAgICAgICAgIHZhciBjb250ZW50ID0gaXRlbS5jaGlsZHJlbignLmFjY29yZGlvbi1pdGVtLWNvbnRlbnQnKTtcbiAgICAgICAgICAgIGlmIChjb250ZW50Lmxlbmd0aCA9PT0gMCkgY29udGVudCA9IGl0ZW0uZmluZCgnLmFjY29yZGlvbi1pdGVtLWNvbnRlbnQnKTtcbiAgICAgICAgICAgIHZhciBleHBhbmRlZEl0ZW0gPSBsaXN0Lmxlbmd0aCA+IDAgJiYgaXRlbS5wYXJlbnQoKS5jaGlsZHJlbignLmFjY29yZGlvbi1pdGVtLWV4cGFuZGVkJyk7XG4gICAgICAgICAgICBpZiAoZXhwYW5kZWRJdGVtLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBhcHAuYWNjb3JkaW9uQ2xvc2UoZXhwYW5kZWRJdGVtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnRlbnQuY3NzKCdoZWlnaHQnLCBjb250ZW50WzBdLnNjcm9sbEhlaWdodCArICdweCcpLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChpdGVtLmhhc0NsYXNzKCdhY2NvcmRpb24taXRlbS1leHBhbmRlZCcpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQudHJhbnNpdGlvbigwKTtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudC5jc3MoJ2hlaWdodCcsICdhdXRvJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjbGllbnRMZWZ0ID0gY29udGVudFswXS5jbGllbnRMZWZ0O1xuICAgICAgICAgICAgICAgICAgICBjb250ZW50LnRyYW5zaXRpb24oJycpO1xuICAgICAgICAgICAgICAgICAgICBpdGVtLnRyaWdnZXIoJ29wZW5lZCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudC5jc3MoJ2hlaWdodCcsICcnKTtcbiAgICAgICAgICAgICAgICAgICAgaXRlbS50cmlnZ2VyKCdjbG9zZWQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGl0ZW0udHJpZ2dlcignb3BlbicpO1xuICAgICAgICAgICAgaXRlbS5hZGRDbGFzcygnYWNjb3JkaW9uLWl0ZW0tZXhwYW5kZWQnKTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmFjY29yZGlvbkNsb3NlID0gZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICAgICAgICAgIGl0ZW0gPSAkKGl0ZW0pO1xuICAgICAgICAgICAgdmFyIGNvbnRlbnQgPSBpdGVtLmNoaWxkcmVuKCcuYWNjb3JkaW9uLWl0ZW0tY29udGVudCcpO1xuICAgICAgICAgICAgaWYgKGNvbnRlbnQubGVuZ3RoID09PSAwKSBjb250ZW50ID0gaXRlbS5maW5kKCcuYWNjb3JkaW9uLWl0ZW0tY29udGVudCcpO1xuICAgICAgICAgICAgaXRlbS5yZW1vdmVDbGFzcygnYWNjb3JkaW9uLWl0ZW0tZXhwYW5kZWQnKTtcbiAgICAgICAgICAgIGNvbnRlbnQudHJhbnNpdGlvbigwKTtcbiAgICAgICAgICAgIGNvbnRlbnQuY3NzKCdoZWlnaHQnLCBjb250ZW50WzBdLnNjcm9sbEhlaWdodCArICdweCcpO1xuICAgICAgICAgICAgLy8gUmVsYXlvdXRcbiAgICAgICAgICAgIHZhciBjbGllbnRMZWZ0ID0gY29udGVudFswXS5jbGllbnRMZWZ0O1xuICAgICAgICAgICAgLy8gQ2xvc2VcbiAgICAgICAgICAgIGNvbnRlbnQudHJhbnNpdGlvbignJyk7XG4gICAgICAgICAgICBjb250ZW50LmNzcygnaGVpZ2h0JywgJycpLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChpdGVtLmhhc0NsYXNzKCdhY2NvcmRpb24taXRlbS1leHBhbmRlZCcpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQudHJhbnNpdGlvbigwKTtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudC5jc3MoJ2hlaWdodCcsICdhdXRvJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjbGllbnRMZWZ0ID0gY29udGVudFswXS5jbGllbnRMZWZ0O1xuICAgICAgICAgICAgICAgICAgICBjb250ZW50LnRyYW5zaXRpb24oJycpO1xuICAgICAgICAgICAgICAgICAgICBpdGVtLnRyaWdnZXIoJ29wZW5lZCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29udGVudC5jc3MoJ2hlaWdodCcsICcnKTtcbiAgICAgICAgICAgICAgICAgICAgaXRlbS50cmlnZ2VyKCdjbG9zZWQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGl0ZW0udHJpZ2dlcignY2xvc2UnKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgRmFzdCBDbGlja3MgICAqKioqKioqKioqKipcbiAgICAgICAgKioqKioqKioqKioqICAgSW5zcGlyZWQgYnkgaHR0cHM6Ly9naXRodWIuY29tL2Z0bGFicy9mYXN0Y2xpY2sgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5pbml0RmFzdENsaWNrcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmFjdGl2ZVN0YXRlKSB7XG4gICAgICAgICAgICAgICAgJCgnaHRtbCcpLmFkZENsYXNzKCd3YXRjaC1hY3RpdmUtc3RhdGUnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLmlvcyAmJiBhcHAuZGV2aWNlLndlYlZpZXcpIHtcbiAgICAgICAgICAgICAgICAvLyBTdHJhbmdlIGhhY2sgcmVxdWlyZWQgZm9yIGlPUyA4IHdlYnZpZXcgdG8gd29yayBvbiBpbnB1dHNcbiAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIGZ1bmN0aW9uICgpIHt9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgdG91Y2hTdGFydFgsIHRvdWNoU3RhcnRZLCB0b3VjaFN0YXJ0VGltZSwgdGFyZ2V0RWxlbWVudCwgdHJhY2tDbGljaywgYWN0aXZlU2VsZWN0aW9uLCBzY3JvbGxQYXJlbnQsIGxhc3RDbGlja1RpbWUsIGlzTW92ZWQsIHRhcEhvbGRGaXJlZCwgdGFwSG9sZFRpbWVvdXQ7XG4gICAgICAgICAgICB2YXIgYWN0aXZhYmxlRWxlbWVudCwgYWN0aXZlVGltZW91dCwgbmVlZHNGYXN0Q2xpY2ssIG5lZWRzRmFzdENsaWNrVGltZU91dDtcbiAgICAgICAgICAgIHZhciByaXBwbGVXYXZlLCByaXBwbGVUYXJnZXQsIHJpcHBsZVRyYW5zZm9ybSwgcmlwcGxlVGltZW91dDtcbiAgICAgICAgICAgIGZ1bmN0aW9uIGZpbmRBY3RpdmFibGVFbGVtZW50KGVsKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9ICQoZWwpO1xuICAgICAgICAgICAgICAgIHZhciBwYXJlbnRzID0gdGFyZ2V0LnBhcmVudHMoYXBwLnBhcmFtcy5hY3RpdmVTdGF0ZUVsZW1lbnRzKTtcbiAgICAgICAgICAgICAgICB2YXIgYWN0aXZhYmxlO1xuICAgICAgICAgICAgICAgIGlmICh0YXJnZXQuaXMoYXBwLnBhcmFtcy5hY3RpdmVTdGF0ZUVsZW1lbnRzKSkge1xuICAgICAgICAgICAgICAgICAgICBhY3RpdmFibGUgPSB0YXJnZXQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChwYXJlbnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZhYmxlID0gYWN0aXZhYmxlID8gYWN0aXZhYmxlLmFkZChwYXJlbnRzKSA6IHBhcmVudHM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBhY3RpdmFibGUgPyBhY3RpdmFibGUgOiB0YXJnZXQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBpc0luc2lkZVNjcm9sbGFibGVWaWV3KGVsKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2VDb250ZW50ID0gZWwucGFyZW50cygnLnBhZ2UtY29udGVudCwgLnBhbmVsJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChwYWdlQ29udGVudC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gVGhpcyBldmVudCBoYW5kbGVyIGNvdmVycyB0aGUgXCJ0YXAgdG8gc3RvcCBzY3JvbGxpbmdcIi5cbiAgICAgICAgICAgICAgICBpZiAocGFnZUNvbnRlbnQucHJvcCgnc2Nyb2xsSGFuZGxlclNldCcpICE9PSAneWVzJykge1xuICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudC5vbignc2Nyb2xsJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGFjdGl2ZVRpbWVvdXQpO1xuICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyaXBwbGVUaW1lb3V0KTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50LnByb3AoJ3Njcm9sbEhhbmRsZXJTZXQnLCAneWVzJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGFkZEFjdGl2ZSgpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWFjdGl2YWJsZUVsZW1lbnQpIHJldHVybjtcbiAgICAgICAgICAgICAgICBhY3RpdmFibGVFbGVtZW50LmFkZENsYXNzKCdhY3RpdmUtc3RhdGUnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZUFjdGl2ZShlbCkge1xuICAgICAgICAgICAgICAgIGlmICghYWN0aXZhYmxlRWxlbWVudCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGFjdGl2YWJsZUVsZW1lbnQucmVtb3ZlQ2xhc3MoJ2FjdGl2ZS1zdGF0ZScpO1xuICAgICAgICAgICAgICAgIGFjdGl2YWJsZUVsZW1lbnQgPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaXNGb3JtRWxlbWVudChlbCkge1xuICAgICAgICAgICAgICAgIHZhciBub2RlcyA9ICgnaW5wdXQgc2VsZWN0IHRleHRhcmVhIGxhYmVsJykuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgICAgICBpZiAoZWwubm9kZU5hbWUgJiYgbm9kZXMuaW5kZXhPZihlbC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKSA+PSAwKSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBhbmRyb2lkTmVlZHNCbHVyKGVsKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5vQmx1ciA9ICgnYnV0dG9uIGlucHV0IHRleHRhcmVhIHNlbGVjdCcpLnNwbGl0KCcgJyk7XG4gICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgZWwgIT09IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAhPT0gZG9jdW1lbnQuYm9keSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAobm9CbHVyLmluZGV4T2YoZWwubm9kZU5hbWUudG9Mb3dlckNhc2UoKSkgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiB0YXJnZXROZWVkc0Zhc3RDbGljayhlbCkge1xuICAgICAgICAgICAgICAgIHZhciAkZWwgPSAkKGVsKTtcbiAgICAgICAgICAgICAgICBpZiAoZWwubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2lucHV0JyAmJiBlbC50eXBlID09PSAnZmlsZScpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAoJGVsLmhhc0NsYXNzKCduby1mYXN0Y2xpY2snKSB8fCAkZWwucGFyZW50cygnLm5vLWZhc3RjbGljaycpLmxlbmd0aCA+IDApIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIHRhcmdldE5lZWRzRm9jdXMoZWwpIHtcbiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCA9PT0gZWwpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgdGFnID0gZWwubm9kZU5hbWUudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgICAgICB2YXIgc2tpcElucHV0cyA9ICgnYnV0dG9uIGNoZWNrYm94IGZpbGUgaW1hZ2UgcmFkaW8gc3VibWl0Jykuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgICAgICBpZiAoZWwuZGlzYWJsZWQgfHwgZWwucmVhZE9ubHkpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAodGFnID09PSAndGV4dGFyZWEnKSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAodGFnID09PSAnc2VsZWN0Jykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5hbmRyb2lkKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0YWcgPT09ICdpbnB1dCcgJiYgc2tpcElucHV0cy5pbmRleE9mKGVsLnR5cGUpIDwgMCkgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiB0YXJnZXROZWVkc1ByZXZlbnQoZWwpIHtcbiAgICAgICAgICAgICAgICBlbCA9ICQoZWwpO1xuICAgICAgICAgICAgICAgIHZhciBwcmV2ZW50ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAoZWwuaXMoJ2xhYmVsJykgfHwgZWwucGFyZW50cygnbGFiZWwnKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLmFuZHJvaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZXZlbnQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChhcHAuZGV2aWNlLmlvcyAmJiBlbC5pcygnaW5wdXQnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJldmVudCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBwcmV2ZW50ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBwcmV2ZW50O1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIE1vdXNlIEhhbmRsZXJzXG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVNb3VzZURvd24gKGUpIHtcbiAgICAgICAgICAgICAgICBmaW5kQWN0aXZhYmxlRWxlbWVudChlLnRhcmdldCkuYWRkQ2xhc3MoJ2FjdGl2ZS1zdGF0ZScpO1xuICAgICAgICAgICAgICAgIGlmICgnd2hpY2gnIGluIGUgJiYgZS53aGljaCA9PT0gMykge1xuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJy5hY3RpdmUtc3RhdGUnKS5yZW1vdmVDbGFzcygnYWN0aXZlLXN0YXRlJyk7XG4gICAgICAgICAgICAgICAgICAgIH0sIDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBhcHAucGFyYW1zLm1hdGVyaWFsUmlwcGxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRYID0gZS5wYWdlWDtcbiAgICAgICAgICAgICAgICAgICAgdG91Y2hTdGFydFkgPSBlLnBhZ2VZO1xuICAgICAgICAgICAgICAgICAgICByaXBwbGVUb3VjaFN0YXJ0KGUudGFyZ2V0LCBlLnBhZ2VYLCBlLnBhZ2VZKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVNb3VzZU1vdmUgKGUpIHtcbiAgICAgICAgICAgICAgICAkKCcuYWN0aXZlLXN0YXRlJykucmVtb3ZlQ2xhc3MoJ2FjdGl2ZS1zdGF0ZScpO1xuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsICYmIGFwcC5wYXJhbXMubWF0ZXJpYWxSaXBwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmlwcGxlVG91Y2hNb3ZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlTW91c2VVcCAoZSkge1xuICAgICAgICAgICAgICAgICQoJy5hY3RpdmUtc3RhdGUnKS5yZW1vdmVDbGFzcygnYWN0aXZlLXN0YXRlJyk7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwgJiYgYXBwLnBhcmFtcy5tYXRlcmlhbFJpcHBsZSkge1xuICAgICAgICAgICAgICAgICAgICByaXBwbGVUb3VjaEVuZCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBNYXRlcmlhbCBUb3VjaCBSaXBwbGUgRWZmZWN0XG4gICAgICAgICAgICBmdW5jdGlvbiBmaW5kUmlwcGxlRWxlbWVudChlbCkge1xuICAgICAgICAgICAgICAgIHZhciBuZWVkc1JpcHBsZSA9IGFwcC5wYXJhbXMubWF0ZXJpYWxSaXBwbGVFbGVtZW50cztcbiAgICAgICAgICAgICAgICB2YXIgJGVsID0gJChlbCk7XG4gICAgICAgICAgICAgICAgaWYgKCRlbC5pcyhuZWVkc1JpcHBsZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCRlbC5oYXNDbGFzcygnbm8tcmlwcGxlJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGVsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmICgkZWwucGFyZW50cyhuZWVkc1JpcHBsZSkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcmlwcGxlUGFyZW50ID0gJGVsLnBhcmVudHMobmVlZHNSaXBwbGUpLmVxKDApO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmlwcGxlUGFyZW50Lmhhc0NsYXNzKCduby1yaXBwbGUnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByaXBwbGVQYXJlbnQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gY3JlYXRlUmlwcGxlKHgsIHksIGVsKSB7XG4gICAgICAgICAgICAgICAgdmFyIGJveCA9IGVsWzBdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgICAgICAgICAgIHZhciBjZW50ZXIgPSB7XG4gICAgICAgICAgICAgICAgICAgIHg6IHggLSBib3gubGVmdCxcbiAgICAgICAgICAgICAgICAgICAgeTogeSAtIGJveC50b3BcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBoZWlnaHQgPSBib3guaGVpZ2h0LFxuICAgICAgICAgICAgICAgICAgICB3aWR0aCA9IGJveC53aWR0aDtcbiAgICAgICAgICAgICAgICB2YXIgZGlhbWV0ZXIgPSBNYXRoLm1heChNYXRoLnBvdygoTWF0aC5wb3coaGVpZ2h0LCAyKSArIE1hdGgucG93KHdpZHRoLCAyKSksIDAuNSksIDQ4KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcmlwcGxlV2F2ZSA9ICQoXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicmlwcGxlLXdhdmVcIiBzdHlsZT1cIndpZHRoOiAnICsgZGlhbWV0ZXIgKyAncHg7IGhlaWdodDogJytkaWFtZXRlcisncHg7IG1hcmdpbi10b3A6LScrZGlhbWV0ZXIvMisncHg7IG1hcmdpbi1sZWZ0Oi0nK2RpYW1ldGVyLzIrJ3B4OyBsZWZ0OicrY2VudGVyLngrJ3B4OyB0b3A6JytjZW50ZXIueSsncHg7XCI+PC9kaXY+J1xuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgZWwucHJlcGVuZChyaXBwbGVXYXZlKTtcbiAgICAgICAgICAgICAgICB2YXIgY2xpZW50TGVmdCA9IHJpcHBsZVdhdmVbMF0uY2xpZW50TGVmdDtcbiAgICAgICAgICAgICAgICByaXBwbGVUcmFuc2Zvcm0gPSAndHJhbnNsYXRlM2QoJysoLWNlbnRlci54ICsgd2lkdGgvMikrJ3B4LCAnKygtY2VudGVyLnkgKyBoZWlnaHQvMikrJ3B4LCAwKSBzY2FsZSgxKSc7XG4gICAgICAgICAgICAgICAgcmlwcGxlV2F2ZS50cmFuc2Zvcm0ocmlwcGxlVHJhbnNmb3JtKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiByZW1vdmVSaXBwbGUoKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFyaXBwbGVXYXZlKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIHRvUmVtb3ZlID0gcmlwcGxlV2F2ZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIHJlbW92ZVRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdG9SZW1vdmUucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgfSwgNDAwKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcmlwcGxlV2F2ZVxuICAgICAgICAgICAgICAgICAgICAuYWRkQ2xhc3MoJ3JpcHBsZS13YXZlLWZpbGwnKVxuICAgICAgICAgICAgICAgICAgICAudHJhbnNmb3JtKHJpcHBsZVRyYW5zZm9ybS5yZXBsYWNlKCdzY2FsZSgxKScsICdzY2FsZSgxLjAxKScpKVxuICAgICAgICAgICAgICAgICAgICAudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQocmVtb3ZlVGltZW91dCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJpcHBsZVdhdmUgPSAkKHRoaXMpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmFkZENsYXNzKCdyaXBwbGUtd2F2ZS1vdXQnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50cmFuc2Zvcm0ocmlwcGxlVHJhbnNmb3JtLnJlcGxhY2UoJ3NjYWxlKDEpJywgJ3NjYWxlKDEuMDEpJykpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZVRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByaXBwbGVXYXZlLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSwgNzAwKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByaXBwbGVXYXZlLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJlbW92ZVRpbWVvdXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXMpLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICByaXBwbGVXYXZlID0gcmlwcGxlVGFyZ2V0ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIHJpcHBsZVRvdWNoU3RhcnQgKGVsLCB4LCB5KSB7XG4gICAgICAgICAgICAgICAgcmlwcGxlVGFyZ2V0ID0gZmluZFJpcHBsZUVsZW1lbnQoZWwpO1xuICAgICAgICAgICAgICAgIGlmICghcmlwcGxlVGFyZ2V0IHx8IHJpcHBsZVRhcmdldC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmlwcGxlVGFyZ2V0ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghaXNJbnNpZGVTY3JvbGxhYmxlVmlldyhyaXBwbGVUYXJnZXQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNyZWF0ZVJpcHBsZSh0b3VjaFN0YXJ0WCwgdG91Y2hTdGFydFksIHJpcHBsZVRhcmdldCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByaXBwbGVUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVSaXBwbGUodG91Y2hTdGFydFgsIHRvdWNoU3RhcnRZLCByaXBwbGVUYXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICB9LCA4MCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gcmlwcGxlVG91Y2hNb3ZlKCkge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChyaXBwbGVUaW1lb3V0KTtcbiAgICAgICAgICAgICAgICByZW1vdmVSaXBwbGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIHJpcHBsZVRvdWNoRW5kKCkge1xuICAgICAgICAgICAgICAgIGlmIChyaXBwbGVXYXZlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZVJpcHBsZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChyaXBwbGVUYXJnZXQgJiYgIWlzTW92ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHJpcHBsZVRpbWVvdXQpO1xuICAgICAgICAgICAgICAgICAgICBjcmVhdGVSaXBwbGUodG91Y2hTdGFydFgsIHRvdWNoU3RhcnRZLCByaXBwbGVUYXJnZXQpO1xuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KHJlbW92ZVJpcHBsZSwgMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZW1vdmVSaXBwbGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2VuZCBDbGlja1xuICAgICAgICAgICAgZnVuY3Rpb24gc2VuZENsaWNrKGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgdG91Y2ggPSBlLmNoYW5nZWRUb3VjaGVzWzBdO1xuICAgICAgICAgICAgICAgIHZhciBldnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnTW91c2VFdmVudHMnKTtcbiAgICAgICAgICAgICAgICB2YXIgZXZlbnRUeXBlID0gJ2NsaWNrJztcbiAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5hbmRyb2lkICYmIHRhcmdldEVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ3NlbGVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgZXZlbnRUeXBlID0gJ21vdXNlZG93bic7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGV2dC5pbml0TW91c2VFdmVudChldmVudFR5cGUsIHRydWUsIHRydWUsIHdpbmRvdywgMSwgdG91Y2guc2NyZWVuWCwgdG91Y2guc2NyZWVuWSwgdG91Y2guY2xpZW50WCwgdG91Y2guY2xpZW50WSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDAsIG51bGwpO1xuICAgICAgICAgICAgICAgIGV2dC5mb3J3YXJkZWRUb3VjaEV2ZW50ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0YXJnZXRFbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZ0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBUb3VjaCBIYW5kbGVyc1xuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hTdGFydChlKSB7XG4gICAgICAgICAgICAgICAgaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHRhcEhvbGRGaXJlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldFRvdWNoZXMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aXZhYmxlRWxlbWVudCkgcmVtb3ZlQWN0aXZlKCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZS50b3VjaGVzLmxlbmd0aCA+IDEgJiYgYWN0aXZhYmxlRWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICByZW1vdmVBY3RpdmUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMudGFwSG9sZCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGFwSG9sZFRpbWVvdXQpIGNsZWFyVGltZW91dCh0YXBIb2xkVGltZW91dCk7XG4gICAgICAgICAgICAgICAgICAgIHRhcEhvbGRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZSAmJiBlLnRvdWNoZXMgJiYgZS50b3VjaGVzLmxlbmd0aCA+IDEpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcEhvbGRGaXJlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKGUudGFyZ2V0KS50cmlnZ2VyKCd0YXBob2xkJyk7XG4gICAgICAgICAgICAgICAgICAgIH0sIGFwcC5wYXJhbXMudGFwSG9sZERlbGF5KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG5lZWRzRmFzdENsaWNrVGltZU91dCkgY2xlYXJUaW1lb3V0KG5lZWRzRmFzdENsaWNrVGltZU91dCk7XG4gICAgICAgICAgICAgICAgbmVlZHNGYXN0Q2xpY2sgPSB0YXJnZXROZWVkc0Zhc3RDbGljayhlLnRhcmdldCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICghbmVlZHNGYXN0Q2xpY2spIHtcbiAgICAgICAgICAgICAgICAgICAgdHJhY2tDbGljayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UuaW9zKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzZWxlY3Rpb24gPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rpb24ucmFuZ2VDb3VudCAmJiBzZWxlY3Rpb24uZm9jdXNOb2RlICE9PSBkb2N1bWVudC5ib2R5ICYmICghc2VsZWN0aW9uLmlzQ29sbGFwc2VkIHx8IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IHNlbGVjdGlvbi5mb2N1c05vZGUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVTZWxlY3Rpb24gPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVTZWxlY3Rpb24gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5hbmRyb2lkKSAge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYW5kcm9pZE5lZWRzQmx1cihlLnRhcmdldCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQuYmx1cigpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICB0cmFja0NsaWNrID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB0YXJnZXRFbGVtZW50ID0gZS50YXJnZXQ7XG4gICAgICAgICAgICAgICAgdG91Y2hTdGFydFRpbWUgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRYID0gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYO1xuICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRZID0gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBEZXRlY3Qgc2Nyb2xsIHBhcmVudFxuICAgICAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLmlvcykge1xuICAgICAgICAgICAgICAgICAgICBzY3JvbGxQYXJlbnQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgICQodGFyZ2V0RWxlbWVudCkucGFyZW50cygpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IHRoaXM7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyZW50LnNjcm9sbEhlaWdodCA+IHBhcmVudC5vZmZzZXRIZWlnaHQgJiYgIXNjcm9sbFBhcmVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcm9sbFBhcmVudCA9IHBhcmVudDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JvbGxQYXJlbnQuZjdTY3JvbGxUb3AgPSBzY3JvbGxQYXJlbnQuc2Nyb2xsVG9wO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKChlLnRpbWVTdGFtcCAtIGxhc3RDbGlja1RpbWUpIDwgYXBwLnBhcmFtcy5mYXN0Q2xpY2tzRGVsYXlCZXR3ZWVuQ2xpY2tzKSB7XG4gICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmFjdGl2ZVN0YXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIGFjdGl2YWJsZUVsZW1lbnQgPSBmaW5kQWN0aXZhYmxlRWxlbWVudCh0YXJnZXRFbGVtZW50KTtcbiAgICAgICAgICAgICAgICAgICAgLy8gSWYgaXQncyBpbnNpZGUgYSBzY3JvbGxhYmxlIHZpZXcsIHdlIGRvbid0IHRyaWdnZXIgYWN0aXZlLXN0YXRlIHlldCxcbiAgICAgICAgICAgICAgICAgICAgLy8gYmVjYXVzZSBpdCBjYW4gYmUgYSBzY3JvbGwgaW5zdGVhZC4gQmFzZWQgb24gdGhlIGxpbms6XG4gICAgICAgICAgICAgICAgICAgIC8vIGh0dHA6Ly9sYWJub3RlLmJlZWRlc2suY29tL2NsaWNrLXNjcm9sbC1hbmQtcHNldWRvLWFjdGl2ZS1vbi1tb2JpbGUtd2Via1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzSW5zaWRlU2Nyb2xsYWJsZVZpZXcoYWN0aXZhYmxlRWxlbWVudCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFkZEFjdGl2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZlVGltZW91dCA9IHNldFRpbWVvdXQoYWRkQWN0aXZlLCA4MCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwgJiYgYXBwLnBhcmFtcy5tYXRlcmlhbFJpcHBsZSkge1xuICAgICAgICAgICAgICAgICAgICByaXBwbGVUb3VjaFN0YXJ0KHRhcmdldEVsZW1lbnQsIHRvdWNoU3RhcnRYLCB0b3VjaFN0YXJ0WSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXRyYWNrQ2xpY2spIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgX2lzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB2YXIgZGlzdGFuY2UgPSBhcHAucGFyYW1zLmZhc3RDbGlja3NEaXN0YW5jZVRocmVzaG9sZDtcbiAgICAgICAgICAgICAgICBpZiAoZGlzdGFuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhZ2VYID0gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYO1xuICAgICAgICAgICAgICAgICAgICB2YXIgcGFnZVkgPSBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwYWdlWCAtIHRvdWNoU3RhcnRYKSA+IGRpc3RhbmNlIHx8ICBNYXRoLmFicyhwYWdlWSAtIHRvdWNoU3RhcnRZKSA+IGRpc3RhbmNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBfaXNNb3ZlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIF9pc01vdmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKF9pc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyYWNrQ2xpY2sgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RWxlbWVudCA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIGlzTW92ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy50YXBIb2xkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGFwSG9sZFRpbWVvdXQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFx0XHRcdGlmIChhcHAucGFyYW1zLmFjdGl2ZVN0YXRlKSB7XG4gICAgICAgIFx0XHRcdFx0Y2xlYXJUaW1lb3V0KGFjdGl2ZVRpbWVvdXQpO1xuICAgICAgICBcdFx0XHRcdHJlbW92ZUFjdGl2ZSgpO1xuICAgICAgICBcdFx0XHR9XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsICYmIGFwcC5wYXJhbXMubWF0ZXJpYWxSaXBwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJpcHBsZVRvdWNoTW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoZSkge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChhY3RpdmVUaW1lb3V0KTtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGFwSG9sZFRpbWVvdXQpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIXRyYWNrQ2xpY2spIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFhY3RpdmVTZWxlY3Rpb24gJiYgbmVlZHNGYXN0Q2xpY2spIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKGFwcC5kZXZpY2UuYW5kcm9pZCAmJiAhZS5jYW5jZWxhYmxlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5hY3RpdmVFbGVtZW50ID09PSBlLnRhcmdldCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hY3RpdmVTdGF0ZSkgcmVtb3ZlQWN0aXZlKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsICYmIGFwcC5wYXJhbXMubWF0ZXJpYWxSaXBwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJpcHBsZVRvdWNoRW5kKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIWFjdGl2ZVNlbGVjdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoKGUudGltZVN0YW1wIC0gbGFzdENsaWNrVGltZSkgPCBhcHAucGFyYW1zLmZhc3RDbGlja3NEZWxheUJldHdlZW5DbGlja3MpIHtcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChyZW1vdmVBY3RpdmUsIDApO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGxhc3RDbGlja1RpbWUgPSBlLnRpbWVTdGFtcDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdHJhY2tDbGljayA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5pb3MgJiYgc2Nyb2xsUGFyZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzY3JvbGxQYXJlbnQuc2Nyb2xsVG9wICE9PSBzY3JvbGxQYXJlbnQuZjdTY3JvbGxUb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gQWRkIGFjdGl2ZS1zdGF0ZSBoZXJlIGJlY2F1c2UsIGluIGEgdmVyeSBmYXN0IHRhcCwgdGhlIHRpbWVvdXQgZGlkbid0XG4gICAgICAgICAgICAgICAgLy8gaGF2ZSB0aGUgY2hhbmNlIHRvIGV4ZWN1dGUuIFJlbW92aW5nIGFjdGl2ZS1zdGF0ZSBpbiBhIHRpbWVvdXQgZ2l2ZXNcbiAgICAgICAgICAgICAgICAvLyB0aGUgY2hhbmNlIHRvIHRoZSBhbmltYXRpb24gZXhlY3V0ZS5cbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hY3RpdmVTdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICBhZGRBY3RpdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChyZW1vdmVBY3RpdmUsIDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBSZW1vdmUgUmlwcGxlXG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMubWF0ZXJpYWwgJiYgYXBwLnBhcmFtcy5tYXRlcmlhbFJpcHBsZSkge1xuICAgICAgICAgICAgICAgICAgICByaXBwbGVUb3VjaEVuZCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gVHJpZ2dlciBmb2N1cyB3aGVuIHJlcXVpcmVkXG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldE5lZWRzRm9jdXModGFyZ2V0RWxlbWVudCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UuaW9zICYmIGFwcC5kZXZpY2Uud2ViVmlldykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChldmVudC50aW1lU3RhbXAgLSB0b3VjaFN0YXJ0VGltZSkgPiAxNTkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRFbGVtZW50ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRFbGVtZW50LmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRFbGVtZW50LmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIEJsdXIgYWN0aXZlIGVsZW1lbnRzXG4gICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgdGFyZ2V0RWxlbWVudCAhPT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJiBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICE9PSBkb2N1bWVudC5ib2R5ICYmIHRhcmdldEVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gJ2xhYmVsJykge1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hY3RpdmVFbGVtZW50LmJsdXIoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFNlbmQgY2xpY2tcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgc2VuZENsaWNrKGUpO1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoQ2FuY2VsKGUpIHtcbiAgICAgICAgICAgICAgICB0cmFja0NsaWNrID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdGFyZ2V0RWxlbWVudCA9IG51bGw7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBBY3RpdmUgU3RhdGVcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoYWN0aXZlVGltZW91dCk7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRhcEhvbGRUaW1lb3V0KTtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5hY3RpdmVTdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICByZW1vdmVBY3RpdmUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFJlbW92ZSBSaXBwbGVcbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBhcHAucGFyYW1zLm1hdGVyaWFsUmlwcGxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJpcHBsZVRvdWNoRW5kKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZUNsaWNrKGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgYWxsb3dDbGljayA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAodHJhY2tDbGljaykge1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXRFbGVtZW50ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgdHJhY2tDbGljayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGUudGFyZ2V0LnR5cGUgPT09ICdzdWJtaXQnICYmIGUuZGV0YWlsID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIXRhcmdldEVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0Zvcm1FbGVtZW50KGUudGFyZ2V0KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWxsb3dDbGljayA9ICB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghbmVlZHNGYXN0Q2xpY2spIHtcbiAgICAgICAgICAgICAgICAgICAgYWxsb3dDbGljayA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5hY3RpdmVFbGVtZW50ID09PSB0YXJnZXRFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGFsbG93Q2xpY2sgPSAgdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGUuZm9yd2FyZGVkVG91Y2hFdmVudCkge1xuICAgICAgICAgICAgICAgICAgICBhbGxvd0NsaWNrID0gIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghZS5jYW5jZWxhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgIGFsbG93Q2xpY2sgPSAgdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMudGFwSG9sZCAmJiBhcHAucGFyYW1zLnRhcEhvbGRQcmV2ZW50Q2xpY2tzICYmIHRhcEhvbGRGaXJlZCkge1xuICAgICAgICAgICAgICAgICAgICBhbGxvd0NsaWNrID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghYWxsb3dDbGljaykge1xuICAgICAgICAgICAgICAgICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0RWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldE5lZWRzUHJldmVudCh0YXJnZXRFbGVtZW50KSB8fCBpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldEVsZW1lbnQgPSBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBuZWVkc0Zhc3RDbGlja1RpbWVPdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgbmVlZHNGYXN0Q2xpY2sgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9LCAoYXBwLmRldmljZS5pb3MgfHwgYXBwLmRldmljZS5hbmRyb2lkQ2hyb21lID8gMTAwIDogNDAwKSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnRhcEhvbGQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGFwSG9sZFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcEhvbGRGaXJlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9LCAoYXBwLmRldmljZS5pb3MgfHwgYXBwLmRldmljZS5hbmRyb2lkQ2hyb21lID8gMTAwIDogNDAwKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4gYWxsb3dDbGljaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhcHAuc3VwcG9ydC50b3VjaCkge1xuICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgaGFuZGxlQ2xpY2ssIHRydWUpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgaGFuZGxlVG91Y2hTdGFydCk7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgaGFuZGxlVG91Y2hNb3ZlKTtcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIGhhbmRsZVRvdWNoRW5kKTtcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIGhhbmRsZVRvdWNoQ2FuY2VsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmFjdGl2ZVN0YXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIGhhbmRsZU1vdXNlRG93bik7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGhhbmRsZU1vdXNlTW92ZSk7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBoYW5kbGVNb3VzZVVwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBhcHAucGFyYW1zLm1hdGVyaWFsUmlwcGxlKSB7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignY29udGV4dG1lbnUnLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aXZhYmxlRWxlbWVudCkgcmVtb3ZlQWN0aXZlKCk7XG4gICAgICAgICAgICAgICAgICAgIHJpcHBsZVRvdWNoRW5kKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB9O1xuICAgICAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgSGFuZGxlIGNsaWNrcyBhbmQgbWFrZSB0aGVtIGZhc3QgKG9uIHRhcCk7ICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAuaW5pdENsaWNrRXZlbnRzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlU2Nyb2xsVG9wKGUpIHtcbiAgICAgICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqL1xuICAgICAgICAgICAgICAgIHZhciBjbGlja2VkID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gJChlLnRhcmdldCk7XG4gICAgICAgICAgICAgICAgdmFyIGlzTGluayA9IGNsaWNrZWRbMF0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gJ2EnIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrZWQucGFyZW50cygnYScpLmxlbmd0aCA+IDAgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0WzBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICdhJyB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQucGFyZW50cygnYScpLmxlbmd0aCA+IDA7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChpc0xpbmspIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgcGFnZUNvbnRlbnQsIHBhZ2U7XG4gICAgICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMuc2Nyb2xsVG9wT25OYXZiYXJDbGljayAmJiBjbGlja2VkLmlzKCcubmF2YmFyIC5jZW50ZXInKSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBGaW5kIGFjdGl2ZSBwYWdlXG4gICAgICAgICAgICAgICAgICAgIHZhciBuYXZiYXIgPSBjbGlja2VkLnBhcmVudHMoJy5uYXZiYXInKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIFN0YXRpYyBMYXlvdXRcbiAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnQgPSBuYXZiYXIucGFyZW50cygnLnBhZ2UtY29udGVudCcpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2VDb250ZW50Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gRml4ZWQgTGF5b3V0XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAobmF2YmFyLnBhcmVudHMoJy5wYWdlJykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50ID0gbmF2YmFyLnBhcmVudHMoJy5wYWdlJykuZmluZCgnLnBhZ2UtY29udGVudCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhyb3VnaCBMYXlvdXRcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYWdlQ29udGVudC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmF2YmFyLm5leHRBbGwoJy5wYWdlcycpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnQgPSBuYXZiYXIubmV4dEFsbCgnLnBhZ2VzJykuZmluZCgnLnBhZ2U6bm90KC5wYWdlLW9uLWxlZnQpOm5vdCgucGFnZS1vbi1yaWdodCk6bm90KC5jYWNoZWQpJykuZmluZCgnLnBhZ2UtY29udGVudCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5zY3JvbGxUb3BPblN0YXR1c2JhckNsaWNrICYmIGNsaWNrZWQuaXMoJy5zdGF0dXNiYXItb3ZlcmxheScpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgkKCcucG9wdXAubW9kYWwtaW4nKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBmb3Igb3BlbmVkIHBvcHVwXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudCA9ICQoJy5wb3B1cC5tb2RhbC1pbicpLmZpbmQoJy5wYWdlOm5vdCgucGFnZS1vbi1sZWZ0KTpub3QoLnBhZ2Utb24tcmlnaHQpOm5vdCguY2FjaGVkKScpLmZpbmQoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICgkKCcucGFuZWwuYWN0aXZlJykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIG9wZW5lZCBwYW5lbFxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnQgPSAkKCcucGFuZWwuYWN0aXZlJykuZmluZCgnLnBhZ2U6bm90KC5wYWdlLW9uLWxlZnQpOm5vdCgucGFnZS1vbi1yaWdodCk6bm90KC5jYWNoZWQpJykuZmluZCgnLnBhZ2UtY29udGVudCcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKCQoJy52aWV3cyA+IC52aWV3LmFjdGl2ZScpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFZpZXcgaW4gdGFiIGJhciBhcHAgbGF5b3V0XG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudCA9ICQoJy52aWV3cyA+IC52aWV3LmFjdGl2ZScpLmZpbmQoJy5wYWdlOm5vdCgucGFnZS1vbi1sZWZ0KTpub3QoLnBhZ2Utb24tcmlnaHQpOm5vdCguY2FjaGVkKScpLmZpbmQoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVzdWFsIGNhc2VcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50ID0gJCgnLnZpZXdzJykuZmluZCgnLnBhZ2U6bm90KC5wYWdlLW9uLWxlZnQpOm5vdCgucGFnZS1vbi1yaWdodCk6bm90KC5jYWNoZWQpJykuZmluZCgnLnBhZ2UtY29udGVudCcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocGFnZUNvbnRlbnQgJiYgcGFnZUNvbnRlbnQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBmb3IgdGFiXG4gICAgICAgICAgICAgICAgICAgIGlmIChwYWdlQ29udGVudC5oYXNDbGFzcygndGFiJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50ID0gcGFnZUNvbnRlbnQucGFyZW50KCcudGFicycpLmNoaWxkcmVuKCcucGFnZS1jb250ZW50LmFjdGl2ZScpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYWdlQ29udGVudC5sZW5ndGggPiAwKSBwYWdlQ29udGVudC5zY3JvbGxUb3AoMCwgMzAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVDbGlja3MoZSkge1xuICAgICAgICAgICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovXG4gICAgICAgICAgICAgICAgdmFyIGNsaWNrZWQgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgIHZhciB1cmwgPSBjbGlja2VkLmF0dHIoJ2hyZWYnKTtcbiAgICAgICAgICAgICAgICB2YXIgaXNMaW5rID0gY2xpY2tlZFswXS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAnYSc7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGxpbmsgaXMgZXh0ZXJuYWxcbiAgICAgICAgICAgICAgICBpZiAoaXNMaW5rKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmlzKGFwcC5wYXJhbXMuZXh0ZXJuYWxMaW5rcykgfHwgKHVybCAmJiB1cmwuaW5kZXhPZignamF2YXNjcmlwdDonKSA+PSAwKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYodXJsICYmIGNsaWNrZWQuYXR0cigndGFyZ2V0JykgPT09ICdfc3lzdGVtJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aW5kb3cub3Blbih1cmwsICdfc3lzdGVtJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIENvbGxlY3QgQ2xpY2tlZCBkYXRhLSBhdHRyaWJ1dGVzXG4gICAgICAgICAgICAgICAgdmFyIGNsaWNrZWREYXRhID0gY2xpY2tlZC5kYXRhc2V0KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFNtYXJ0IFNlbGVjdFxuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCdzbWFydC1zZWxlY3QnKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnNtYXJ0U2VsZWN0T3BlbikgYXBwLnNtYXJ0U2VsZWN0T3BlbihjbGlja2VkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIE9wZW4gUGFuZWxcbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnb3Blbi1wYW5lbCcpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgkKCcucGFuZWwnKS5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKCcucGFuZWwnKS5oYXNDbGFzcygncGFuZWwtbGVmdCcpKSBhcHAub3BlblBhbmVsKCdsZWZ0Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFwcC5vcGVuUGFuZWwoJ3JpZ2h0Jyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZERhdGEucGFuZWwgPT09ICdyaWdodCcpIGFwcC5vcGVuUGFuZWwoJ3JpZ2h0Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGFwcC5vcGVuUGFuZWwoJ2xlZnQnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBDbG9zZSBQYW5lbFxuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCdjbG9zZS1wYW5lbCcpKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZVBhbmVsKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygncGFuZWwtb3ZlcmxheScpICYmIGFwcC5wYXJhbXMucGFuZWxzQ2xvc2VCeU91dHNpZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLmNsb3NlUGFuZWwoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gUG9wb3ZlclxuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCdvcGVuLXBvcG92ZXInKSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcG9wb3ZlcjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNsaWNrZWREYXRhLnBvcG92ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvcG92ZXIgPSBjbGlja2VkRGF0YS5wb3BvdmVyO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcG9wb3ZlciA9ICcucG9wb3Zlcic7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5wb3BvdmVyKHBvcG92ZXIsIGNsaWNrZWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnY2xvc2UtcG9wb3ZlcicpKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKCcucG9wb3Zlci5tb2RhbC1pbicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBQb3B1cFxuICAgICAgICAgICAgICAgIHZhciBwb3B1cDtcbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnb3Blbi1wb3B1cCcpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjbGlja2VkRGF0YS5wb3B1cCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcG9wdXAgPSBjbGlja2VkRGF0YS5wb3B1cDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHBvcHVwID0gJy5wb3B1cCc7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5wb3B1cChwb3B1cCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCdjbG9zZS1wb3B1cCcpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjbGlja2VkRGF0YS5wb3B1cCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcG9wdXAgPSBjbGlja2VkRGF0YS5wb3B1cDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHBvcHVwID0gJy5wb3B1cC5tb2RhbC1pbic7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKHBvcHVwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gTG9naW4gU2NyZWVuXG4gICAgICAgICAgICAgICAgdmFyIGxvZ2luU2NyZWVuO1xuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCdvcGVuLWxvZ2luLXNjcmVlbicpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjbGlja2VkRGF0YS5sb2dpblNjcmVlbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgbG9naW5TY3JlZW4gPSBjbGlja2VkRGF0YS5sb2dpblNjcmVlbjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGxvZ2luU2NyZWVuID0gJy5sb2dpbi1zY3JlZW4nO1xuICAgICAgICAgICAgICAgICAgICBhcHAubG9naW5TY3JlZW4obG9naW5TY3JlZW4pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnY2xvc2UtbG9naW4tc2NyZWVuJykpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLmNsb3NlTW9kYWwoJy5sb2dpbi1zY3JlZW4ubW9kYWwtaW4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gQ2xvc2UgTW9kYWxcbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnbW9kYWwtb3ZlcmxheScpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgkKCcubW9kYWwubW9kYWwtaW4nKS5sZW5ndGggPiAwICYmIGFwcC5wYXJhbXMubW9kYWxDbG9zZUJ5T3V0c2lkZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKCcubW9kYWwubW9kYWwtaW4nKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQoJy5hY3Rpb25zLW1vZGFsLm1vZGFsLWluJykubGVuZ3RoID4gMCAmJiBhcHAucGFyYW1zLmFjdGlvbnNDbG9zZUJ5T3V0c2lkZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKCcuYWN0aW9ucy1tb2RhbC5tb2RhbC1pbicpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQoJy5wb3BvdmVyLm1vZGFsLWluJykubGVuZ3RoID4gMCkgYXBwLmNsb3NlTW9kYWwoJy5wb3BvdmVyLm1vZGFsLWluJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCdwb3B1cC1vdmVybGF5JykpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQoJy5wb3B1cC5tb2RhbC1pbicpLmxlbmd0aCA+IDAgJiYgYXBwLnBhcmFtcy5wb3B1cENsb3NlQnlPdXRzaWRlKVxuICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmNsb3NlTW9kYWwoJy5wb3B1cC5tb2RhbC1pbicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygncGlja2VyLW1vZGFsLW92ZXJsYXknKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoJCgnLnBpY2tlci1tb2RhbC5tb2RhbC1pbicpLmxlbmd0aCA+IDApXG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbCgnLnBpY2tlci1tb2RhbC5tb2RhbC1pbicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gUGlja2VyXG4gICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ2Nsb3NlLXBpY2tlcicpKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwaWNrZXJUb0Nsb3NlID0gJCgnLnBpY2tlci1tb2RhbC5tb2RhbC1pbicpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocGlja2VyVG9DbG9zZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbChwaWNrZXJUb0Nsb3NlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBpY2tlclRvQ2xvc2UgPSAkKCcucG9wb3Zlci5tb2RhbC1pbiAucGlja2VyLW1vZGFsJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGlja2VyVG9DbG9zZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmNsb3NlTW9kYWwocGlja2VyVG9DbG9zZS5wYXJlbnRzKCcucG9wb3ZlcicpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnb3Blbi1waWNrZXInKSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcGlja2VyVG9PcGVuO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZERhdGEucGlja2VyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwaWNrZXJUb09wZW4gPSBjbGlja2VkRGF0YS5waWNrZXI7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBwaWNrZXJUb09wZW4gPSAnLnBpY2tlci1tb2RhbCc7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5waWNrZXJNb2RhbChwaWNrZXJUb09wZW4sIGNsaWNrZWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gVGFic1xuICAgICAgICAgICAgICAgIHZhciBpc1RhYkxpbms7XG4gICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ3RhYi1saW5rJykpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNUYWJMaW5rID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnNob3dUYWIoY2xpY2tlZERhdGEudGFiIHx8IGNsaWNrZWQuYXR0cignaHJlZicpLCBjbGlja2VkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gU3dpcGVvdXQgQ2xvc2VcbiAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnc3dpcGVvdXQtY2xvc2UnKSkge1xuICAgICAgICAgICAgICAgICAgICBhcHAuc3dpcGVvdXRDbG9zZShjbGlja2VkLnBhcmVudHMoJy5zd2lwZW91dC1vcGVuZWQnKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIFN3aXBlb3V0IERlbGV0ZVxuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCdzd2lwZW91dC1kZWxldGUnKSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZERhdGEuY29uZmlybSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSBjbGlja2VkRGF0YS5jb25maXJtO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRpdGxlID0gY2xpY2tlZERhdGEuY29uZmlybVRpdGxlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRpdGxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmNvbmZpcm0odGV4dCwgdGl0bGUsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnN3aXBlb3V0RGVsZXRlKGNsaWNrZWQucGFyZW50cygnLnN3aXBlb3V0JykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNsaWNrZWREYXRhLmNsb3NlT25DYW5jZWwpIGFwcC5zd2lwZW91dENsb3NlKGNsaWNrZWQucGFyZW50cygnLnN3aXBlb3V0JykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLmNvbmZpcm0odGV4dCwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAuc3dpcGVvdXREZWxldGUoY2xpY2tlZC5wYXJlbnRzKCcuc3dpcGVvdXQnKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZERhdGEuY2xvc2VPbkNhbmNlbCkgYXBwLnN3aXBlb3V0Q2xvc2UoY2xpY2tlZC5wYXJlbnRzKCcuc3dpcGVvdXQnKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcHAuc3dpcGVvdXREZWxldGUoY2xpY2tlZC5wYXJlbnRzKCcuc3dpcGVvdXQnKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIFNvcnRhYmxlXG4gICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ3RvZ2dsZS1zb3J0YWJsZScpKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5zb3J0YWJsZVRvZ2dsZShjbGlja2VkRGF0YS5zb3J0YWJsZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCdvcGVuLXNvcnRhYmxlJykpIHtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnNvcnRhYmxlT3BlbihjbGlja2VkRGF0YS5zb3J0YWJsZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCdjbG9zZS1zb3J0YWJsZScpKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5zb3J0YWJsZUNsb3NlKGNsaWNrZWREYXRhLnNvcnRhYmxlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gQWNjb3JkaW9uXG4gICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ2FjY29yZGlvbi1pdGVtLXRvZ2dsZScpIHx8IChjbGlja2VkLmhhc0NsYXNzKCdpdGVtLWxpbmsnKSAmJiBjbGlja2VkLnBhcmVudCgpLmhhc0NsYXNzKCdhY2NvcmRpb24taXRlbScpKSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgYWNjb3JkaW9uSXRlbSA9IGNsaWNrZWQucGFyZW50KCcuYWNjb3JkaW9uLWl0ZW0nKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjY29yZGlvbkl0ZW0ubGVuZ3RoID09PSAwKSBhY2NvcmRpb25JdGVtID0gY2xpY2tlZC5wYXJlbnRzKCcuYWNjb3JkaW9uLWl0ZW0nKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjY29yZGlvbkl0ZW0ubGVuZ3RoID09PSAwKSBhY2NvcmRpb25JdGVtID0gY2xpY2tlZC5wYXJlbnRzKCdsaScpO1xuICAgICAgICAgICAgICAgICAgICBhcHAuYWNjb3JkaW9uVG9nZ2xlKGFjY29yZGlvbkl0ZW0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gU3BlZWQgRGlhbFxuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjbGlja2VkLmhhc0NsYXNzKCdmbG9hdGluZy1idXR0b24nKSAmJiBjbGlja2VkLnBhcmVudCgpLmhhc0NsYXNzKCdzcGVlZC1kaWFsJykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsaWNrZWQucGFyZW50KCkudG9nZ2xlQ2xhc3MoJ3NwZWVkLWRpYWwtb3BlbmVkJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ2Nsb3NlLXNwZWVkLWRpYWwnKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJCgnLnNwZWVkLWRpYWwtb3BlbmVkJykucmVtb3ZlQ2xhc3MoJ3NwZWVkLWRpYWwtb3BlbmVkJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIExvYWQgUGFnZVxuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLmFqYXhMaW5rcyAmJiAhY2xpY2tlZC5pcyhhcHAucGFyYW1zLmFqYXhMaW5rcykgfHwgIWlzTGluayB8fCAhYXBwLnBhcmFtcy5yb3V0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaXNMaW5rKSB7XG4gICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciB2YWxpZFVybCA9IHVybCAmJiB1cmwubGVuZ3RoID4gMCAmJiB1cmwgIT09ICcjJyAmJiAhaXNUYWJMaW5rO1xuICAgICAgICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGNsaWNrZWREYXRhLnRlbXBsYXRlO1xuICAgICAgICAgICAgICAgIGlmICh2YWxpZFVybCB8fCBjbGlja2VkLmhhc0NsYXNzKCdiYWNrJykgfHwgdGVtcGxhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHZpZXc7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjbGlja2VkRGF0YS52aWV3KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2aWV3ID0gJChjbGlja2VkRGF0YS52aWV3KVswXS5mN1ZpZXc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2aWV3ID0gY2xpY2tlZC5wYXJlbnRzKCcuJyArIGFwcC5wYXJhbXMudmlld0NsYXNzKVswXSAmJiBjbGlja2VkLnBhcmVudHMoJy4nICsgYXBwLnBhcmFtcy52aWV3Q2xhc3MpWzBdLmY3VmlldztcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aWV3ICYmIHZpZXcucGFyYW1zLmxpbmtzVmlldykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygdmlldy5wYXJhbXMubGlua3NWaWV3ID09PSAnc3RyaW5nJykgdmlldyA9ICQodmlldy5wYXJhbXMubGlua3NWaWV3KVswXS5mN1ZpZXc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodmlldy5wYXJhbXMubGlua3NWaWV3IGluc3RhbmNlb2YgVmlldykgdmlldyA9IHZpZXcucGFyYW1zLmxpbmtzVmlldztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIXZpZXcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAubWFpblZpZXcpIHZpZXcgPSBhcHAubWFpblZpZXc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCF2aWV3KSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB2YXIgcGFnZU5hbWU7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGVtcGxhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1cmwuaW5kZXhPZignIycpID09PSAwICYmIHVybCAhPT0gJyMnKSAge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LnBhcmFtcy5kb21DYWNoZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlTmFtZSA9IHVybC5zcGxpdCgnIycpWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1cmwgPT09ICcjJyAmJiAhY2xpY2tlZC5oYXNDbGFzcygnYmFjaycpKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cmwgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHZhciBhbmltYXRlUGFnZXM7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgY2xpY2tlZERhdGEuYW5pbWF0ZVBhZ2VzICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgYW5pbWF0ZVBhZ2VzID0gY2xpY2tlZERhdGEuYW5pbWF0ZVBhZ2VzO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNsaWNrZWQuaGFzQ2xhc3MoJ3dpdGgtYW5pbWF0aW9uJykpIGFuaW1hdGVQYWdlcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnbm8tYW5pbWF0aW9uJykpIGFuaW1hdGVQYWdlcyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB2YXIgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFuaW1hdGVQYWdlczogYW5pbWF0ZVBhZ2VzLFxuICAgICAgICAgICAgICAgICAgICAgICAgaWdub3JlQ2FjaGU6IGNsaWNrZWREYXRhLmlnbm9yZUNhY2hlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yY2U6IGNsaWNrZWREYXRhLmZvcmNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVsb2FkOiBjbGlja2VkRGF0YS5yZWxvYWQsXG4gICAgICAgICAgICAgICAgICAgICAgICByZWxvYWRQcmV2aW91czogY2xpY2tlZERhdGEucmVsb2FkUHJldmlvdXMsXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlTmFtZTogcGFnZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBwdXNoU3RhdGU6IGNsaWNrZWREYXRhLnB1c2hTdGF0ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJsXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy50ZW1wbGF0ZTdQYWdlcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5jb250ZXh0TmFtZSA9IGNsaWNrZWREYXRhLmNvbnRleHROYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvbnRleHQgPSBjbGlja2VkRGF0YS5jb250ZXh0O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmNvbnRleHQgPSBKU09OLnBhcnNlKGNvbnRleHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICh0ZW1wbGF0ZSAmJiB0ZW1wbGF0ZSBpbiB0Ny50ZW1wbGF0ZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnMudGVtcGxhdGUgPSB0Ny50ZW1wbGF0ZXNbdGVtcGxhdGVdO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoY2xpY2tlZC5oYXNDbGFzcygnYmFjaycpKSB2aWV3LnJvdXRlci5iYWNrKG9wdGlvbnMpO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHZpZXcucm91dGVyLmxvYWQob3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgJChkb2N1bWVudCkub24oJ2NsaWNrJywgJ2EsIC5vcGVuLXBhbmVsLCAuY2xvc2UtcGFuZWwsIC5wYW5lbC1vdmVybGF5LCAubW9kYWwtb3ZlcmxheSwgLnBvcHVwLW92ZXJsYXksIC5zd2lwZW91dC1kZWxldGUsIC5zd2lwZW91dC1jbG9zZSwgLmNsb3NlLXBvcHVwLCAub3Blbi1wb3B1cCwgLm9wZW4tcG9wb3ZlciwgLm9wZW4tbG9naW4tc2NyZWVuLCAuY2xvc2UtbG9naW4tc2NyZWVuIC5zbWFydC1zZWxlY3QsIC50b2dnbGUtc29ydGFibGUsIC5vcGVuLXNvcnRhYmxlLCAuY2xvc2Utc29ydGFibGUsIC5hY2NvcmRpb24taXRlbS10b2dnbGUsIC5jbG9zZS1waWNrZXIsIC5waWNrZXItbW9kYWwtb3ZlcmxheScsIGhhbmRsZUNsaWNrcyk7XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5zY3JvbGxUb3BPbk5hdmJhckNsaWNrIHx8IGFwcC5wYXJhbXMuc2Nyb2xsVG9wT25TdGF0dXNiYXJDbGljaykge1xuICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCdjbGljaycsICcuc3RhdHVzYmFyLW92ZXJsYXksIC5uYXZiYXIgLmNlbnRlcicsIGhhbmRsZVNjcm9sbFRvcCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUHJldmVudCBzY3JvbGxpbmcgb24gb3ZlcmxheXNcbiAgICAgICAgICAgIGZ1bmN0aW9uIHByZXZlbnRTY3JvbGxpbmcoZSkge1xuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChhcHAuc3VwcG9ydC50b3VjaCAmJiAhYXBwLmRldmljZS5hbmRyb2lkKSB7XG4gICAgICAgICAgICAgICAgJChkb2N1bWVudCkub24oKGFwcC5wYXJhbXMuZmFzdENsaWNrcyA/ICd0b3VjaHN0YXJ0JyA6ICd0b3VjaG1vdmUnKSwgJy5wYW5lbC1vdmVybGF5LCAubW9kYWwtb3ZlcmxheSwgLnByZWxvYWRlci1pbmRpY2F0b3Itb3ZlcmxheSwgLnBvcHVwLW92ZXJsYXksIC5zZWFyY2hiYXItb3ZlcmxheScsIHByZXZlbnRTY3JvbGxpbmcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBBcHAgUmVzaXplIEFjdGlvbnMgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgLy8gUHJldmVudCBpUGFkIGhvcml6b250YWwgYm9keSBzY3JvbGxpbmcgd2hlbiBzb2Z0IGtleWJvYXJkIGlzIG9wZW5lZFxuICAgICAgICBmdW5jdGlvbiBfZml4SXBhZEJvZHlTY3JvbExlZnQoKSB7XG4gICAgICAgICAgICBpZiAoYXBwLmRldmljZS5pcGFkKSB7XG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zY3JvbGxMZWZ0ID0gMDtcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zY3JvbGxMZWZ0ID0gMDtcbiAgICAgICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBhcHAuaW5pdFJlc2l6ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICQod2luZG93KS5vbigncmVzaXplJywgYXBwLnJlc2l6ZSk7XG4gICAgICAgICAgICAkKHdpbmRvdykub24oJ29yaWVudGF0aW9uY2hhbmdlJywgYXBwLm9yaWVudGF0aW9uY2hhbmdlKTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnJlc2l6ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmIChhcHAuc2l6ZU5hdmJhcnMpIGFwcC5zaXplTmF2YmFycygpO1xuICAgICAgICAgICAgX2ZpeElwYWRCb2R5U2Nyb2xMZWZ0KCk7XG4gICAgICAgICAgICBcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLm9yaWVudGF0aW9uY2hhbmdlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKGFwcC5kZXZpY2UgJiYgYXBwLmRldmljZS5taW5pbWFsVWkpIHtcbiAgICAgICAgICAgICAgICBpZiAod2luZG93Lm9yaWVudGF0aW9uID09PSA5MCB8fCB3aW5kb3cub3JpZW50YXRpb24gPT09IC05MCkgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgX2ZpeElwYWRCb2R5U2Nyb2xMZWZ0KCk7XG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBTdG9yZSBhbmQgcGFyc2UgZm9ybXMgZGF0YSAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLmZvcm1zRGF0YSA9IHt9O1xuICAgICAgICBhcHAuZm9ybVN0b3JlRGF0YSA9IGZ1bmN0aW9uIChmb3JtSWQsIGZvcm1KU09OKSB7XG4gICAgICAgICAgICAvLyBTdG9yZSBmb3JtIGRhdGEgaW4gYXBwLmZvcm1zRGF0YVxuICAgICAgICAgICAgYXBwLmZvcm1zRGF0YVtmb3JtSWRdID0gZm9ybUpTT047XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU3RvcmUgZm9ybSBkYXRhIGluIGxvY2FsIHN0b3JhZ2UgYWxzb1xuICAgICAgICAgICAgYXBwLmxzWydmN2Zvcm0tJyArIGZvcm1JZF0gPSBKU09OLnN0cmluZ2lmeShmb3JtSlNPTik7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5mb3JtRGVsZXRlRGF0YSA9IGZ1bmN0aW9uIChmb3JtSWQpIHtcbiAgICAgICAgICAgIC8vIERlbGV0ZSBmb3JtIGRhdGEgZnJvbSBhcHAuZm9ybXNEYXRhXG4gICAgICAgICAgICBpZiAoYXBwLmZvcm1zRGF0YVtmb3JtSWRdKSB7XG4gICAgICAgICAgICAgICAgYXBwLmZvcm1zRGF0YVtmb3JtSWRdID0gJyc7XG4gICAgICAgICAgICAgICAgZGVsZXRlIGFwcC5mb3Jtc0RhdGFbZm9ybUlkXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBEZWxldGUgZm9ybSBkYXRhIGZyb20gbG9jYWwgc3RvcmFnZSBhbHNvXG4gICAgICAgICAgICBpZiAoYXBwLmxzWydmN2Zvcm0tJyArIGZvcm1JZF0pIHtcbiAgICAgICAgICAgICAgICBhcHAubHNbJ2Y3Zm9ybS0nICsgZm9ybUlkXSA9ICcnO1xuICAgICAgICAgICAgICAgIGFwcC5scy5yZW1vdmVJdGVtKCdmN2Zvcm0tJyArIGZvcm1JZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5mb3JtR2V0RGF0YSA9IGZ1bmN0aW9uIChmb3JtSWQpIHtcbiAgICAgICAgICAgIC8vIEZpcnN0IG9mIGFsbCBjaGVjayBpbiBsb2NhbCBzdG9yYWdlXG4gICAgICAgICAgICBpZiAoYXBwLmxzWydmN2Zvcm0tJyArIGZvcm1JZF0pIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShhcHAubHNbJ2Y3Zm9ybS0nICsgZm9ybUlkXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBUcnkgdG8gZ2V0IGl0IGZyb20gZm9ybXNEYXRhIG9ialxuICAgICAgICAgICAgZWxzZSBpZiAoYXBwLmZvcm1zRGF0YVtmb3JtSWRdKSByZXR1cm4gYXBwLmZvcm1zRGF0YVtmb3JtSWRdO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuZm9ybVRvSlNPTiA9IGZ1bmN0aW9uIChmb3JtKSB7XG4gICAgICAgICAgICBmb3JtID0gJChmb3JtKTtcbiAgICAgICAgICAgIGlmIChmb3JtLmxlbmd0aCAhPT0gMSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEZvcm0gZGF0YVxuICAgICAgICAgICAgdmFyIGZvcm1EYXRhID0ge307XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2tpcCBpbnB1dCB0eXBlc1xuICAgICAgICAgICAgdmFyIHNraXBUeXBlcyA9IFsnc3VibWl0JywgJ2ltYWdlJywgJ2J1dHRvbicsICdmaWxlJ107XG4gICAgICAgICAgICB2YXIgc2tpcE5hbWVzID0gW107XG4gICAgICAgICAgICBmb3JtLmZpbmQoJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IGlucHV0LmF0dHIoJ25hbWUnKTtcbiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGlucHV0LmF0dHIoJ3R5cGUnKTtcbiAgICAgICAgICAgICAgICB2YXIgdGFnID0gdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgICAgIGlmIChza2lwVHlwZXMuaW5kZXhPZih0eXBlKSA+PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKHNraXBOYW1lcy5pbmRleE9mKG5hbWUpID49IDAgfHwgIW5hbWUpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAodGFnID09PSAnc2VsZWN0JyAmJiBpbnB1dC5wcm9wKCdtdWx0aXBsZScpKSB7XG4gICAgICAgICAgICAgICAgICAgIHNraXBOYW1lcy5wdXNoKG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBmb3JtRGF0YVtuYW1lXSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBmb3JtLmZpbmQoJ3NlbGVjdFtuYW1lPVwiJyArIG5hbWUgKyAnXCJdIG9wdGlvbicpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuc2VsZWN0ZWQpIGZvcm1EYXRhW25hbWVdLnB1c2godGhpcy52YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjaGVja2JveCcgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraXBOYW1lcy5wdXNoKG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1EYXRhW25hbWVdID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybS5maW5kKCdpbnB1dFtuYW1lPVwiJyArIG5hbWUgKyAnXCJdJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNoZWNrZWQpIGZvcm1EYXRhW25hbWVdLnB1c2godGhpcy52YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdyYWRpbycgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraXBOYW1lcy5wdXNoKG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0uZmluZCgnaW5wdXRbbmFtZT1cIicgKyBuYW1lICsgJ1wiXScpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jaGVja2VkKSBmb3JtRGF0YVtuYW1lXSA9IHRoaXMudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0IDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtRGF0YVtuYW1lXSA9IGlucHV0LnZhbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgZm9ybS50cmlnZ2VyKCdmb3JtVG9KU09OJywge2Zvcm1EYXRhOiBmb3JtRGF0YX0pO1xuICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBmb3JtRGF0YTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmZvcm1Gcm9tSlNPTiA9IGZ1bmN0aW9uIChmb3JtLCBmb3JtRGF0YSkge1xuICAgICAgICAgICAgZm9ybSA9ICQoZm9ybSk7XG4gICAgICAgICAgICBpZiAoZm9ybS5sZW5ndGggIT09IDEpIHJldHVybiBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTa2lwIGlucHV0IHR5cGVzXG4gICAgICAgICAgICB2YXIgc2tpcFR5cGVzID0gWydzdWJtaXQnLCAnaW1hZ2UnLCAnYnV0dG9uJywgJ2ZpbGUnXTtcbiAgICAgICAgICAgIHZhciBza2lwTmFtZXMgPSBbXTtcbiAgICAgICAgXG4gICAgICAgICAgICBmb3JtLmZpbmQoJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGlucHV0ID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICB2YXIgbmFtZSA9IGlucHV0LmF0dHIoJ25hbWUnKTtcbiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGlucHV0LmF0dHIoJ3R5cGUnKTtcbiAgICAgICAgICAgICAgICB2YXIgdGFnID0gdGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICAgICAgICAgIGlmICghZm9ybURhdGFbbmFtZV0pIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAoc2tpcFR5cGVzLmluZGV4T2YodHlwZSkgPj0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmIChza2lwTmFtZXMuaW5kZXhPZihuYW1lKSA+PSAwIHx8ICFuYW1lKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKHRhZyA9PT0gJ3NlbGVjdCcgJiYgaW5wdXQucHJvcCgnbXVsdGlwbGUnKSkge1xuICAgICAgICAgICAgICAgICAgICBza2lwTmFtZXMucHVzaChuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgZm9ybS5maW5kKCdzZWxlY3RbbmFtZT1cIicgKyBuYW1lICsgJ1wiXSBvcHRpb24nKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3JtRGF0YVtuYW1lXS5pbmRleE9mKHRoaXMudmFsdWUpID49IDApIHRoaXMuc2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB0aGlzLnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdjaGVja2JveCcgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNraXBOYW1lcy5wdXNoKG5hbWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0uZmluZCgnaW5wdXRbbmFtZT1cIicgKyBuYW1lICsgJ1wiXScpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybURhdGFbbmFtZV0uaW5kZXhPZih0aGlzLnZhbHVlKSA+PSAwKSB0aGlzLmNoZWNrZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHRoaXMuY2hlY2tlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAncmFkaW8nIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lwTmFtZXMucHVzaChuYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtLmZpbmQoJ2lucHV0W25hbWU9XCInICsgbmFtZSArICdcIl0nKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1EYXRhW25hbWVdID09PSB0aGlzLnZhbHVlKSB0aGlzLmNoZWNrZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHRoaXMuY2hlY2tlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdCA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQudmFsKGZvcm1EYXRhW25hbWVdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGZvcm0udHJpZ2dlcignZm9ybUZyb21KU09OJywge2Zvcm1EYXRhOiBmb3JtRGF0YX0pO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuaW5pdEZvcm1zU3RvcmFnZSA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIHZhciBmb3JtcyA9IHBhZ2VDb250YWluZXIuZmluZCgnZm9ybS5zdG9yZS1kYXRhJyk7XG4gICAgICAgICAgICBpZiAoZm9ybXMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIFBhcnNlIGZvcm1zIGRhdGEgYW5kIGZpbGwgZm9ybSBpZiB0aGVyZSBpcyBzdWNoIGRhdGFcbiAgICAgICAgICAgIGZvcm1zLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBpZCA9IHRoaXMuZ2V0QXR0cmlidXRlKCdpZCcpO1xuICAgICAgICAgICAgICAgIGlmICghaWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgZm9ybURhdGEgPSBhcHAuZm9ybUdldERhdGEoaWQpO1xuICAgICAgICAgICAgICAgIGlmIChmb3JtRGF0YSkgYXBwLmZvcm1Gcm9tSlNPTih0aGlzLCBmb3JtRGF0YSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIC8vIFVwZGF0ZSBmb3JtcyBkYXRhIG9uIGlucHV0cyBjaGFuZ2VcbiAgICAgICAgICAgIGZ1bmN0aW9uIHN0b3JlRm9ybSgpIHtcbiAgICAgICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqL1xuICAgICAgICAgICAgICAgIHZhciBmb3JtID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICB2YXIgZm9ybUlkID0gZm9ybVswXS5pZDtcbiAgICAgICAgICAgICAgICBpZiAoIWZvcm1JZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHZhciBmb3JtSlNPTiA9IGFwcC5mb3JtVG9KU09OKGZvcm0pO1xuICAgICAgICAgICAgICAgIGlmICghZm9ybUpTT04pIHJldHVybjtcbiAgICAgICAgICAgICAgICBhcHAuZm9ybVN0b3JlRGF0YShmb3JtSWQsIGZvcm1KU09OKTtcbiAgICAgICAgICAgICAgICBmb3JtLnRyaWdnZXIoJ3N0b3JlJywge2RhdGE6IGZvcm1KU09OfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3Jtcy5vbignY2hhbmdlIHN1Ym1pdCcsIHN0b3JlRm9ybSk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGV0YWNoIExpc3RlbmVyc1xuICAgICAgICAgICAgZnVuY3Rpb24gcGFnZUJlZm9yZVJlbW92ZSgpIHtcbiAgICAgICAgICAgICAgICBmb3Jtcy5vZmYoJ2NoYW5nZSBzdWJtaXQnLCBzdG9yZUZvcm0pO1xuICAgICAgICAgICAgICAgIHBhZ2VDb250YWluZXIub2ZmKCdwYWdlQmVmb3JlUmVtb3ZlJywgcGFnZUJlZm9yZVJlbW92ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyLm9uKCdwYWdlQmVmb3JlUmVtb3ZlJywgcGFnZUJlZm9yZVJlbW92ZSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIEFqYXggc3VibWl0IGZvciBmb3JtcyAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgLy8gQWpheCBzdWJtaXQgb24gZm9ybXNcbiAgICAgICAgJChkb2N1bWVudCkub24oJ3N1Ym1pdCBjaGFuZ2UnLCAnZm9ybS5hamF4LXN1Ym1pdCwgZm9ybS5hamF4LXN1Ym1pdC1vbmNoYW5nZScsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICB2YXIgZm9ybSA9ICQodGhpcyk7XG4gICAgICAgICAgICBpZiAoZS50eXBlID09PSAnY2hhbmdlJyAmJiAhZm9ybS5oYXNDbGFzcygnYWpheC1zdWJtaXQtb25jaGFuZ2UnKSkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKGUudHlwZSA9PT0gJ3N1Ym1pdCcpIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGZvcm0uYXR0cignbWV0aG9kJykgfHwgJ0dFVCc7XG4gICAgICAgICAgICB2YXIgY29udGVudFR5cGUgPSBmb3JtLnByb3AoJ2VuY3R5cGUnKSB8fCBmb3JtLmF0dHIoJ2VuY3R5cGUnKTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgdXJsID0gZm9ybS5hdHRyKCdhY3Rpb24nKTtcbiAgICAgICAgICAgIGlmICghdXJsKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIGRhdGE7XG4gICAgICAgICAgICBpZiAobWV0aG9kID09PSAnUE9TVCcpIGRhdGEgPSBuZXcgRm9ybURhdGEoZm9ybVswXSk7XG4gICAgICAgICAgICBlbHNlIGRhdGEgPSAkLnNlcmlhbGl6ZU9iamVjdChhcHAuZm9ybVRvSlNPTihmb3JtWzBdKSk7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHhociA9ICQuYWpheCh7XG4gICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QsXG4gICAgICAgICAgICAgICAgdXJsOiB1cmwsXG4gICAgICAgICAgICAgICAgY29udGVudFR5cGU6IGNvbnRlbnRUeXBlLFxuICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsXG4gICAgICAgICAgICAgICAgYmVmb3JlU2VuZDogZnVuY3Rpb24gKHhocikge1xuICAgICAgICAgICAgICAgICAgICBmb3JtLnRyaWdnZXIoJ2JlZm9yZVN1Ym1pdCcsIHtkYXRhOmRhdGEsIHhocjogeGhyfSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24gKHhocikge1xuICAgICAgICAgICAgICAgICAgICBmb3JtLnRyaWdnZXIoJ3N1Ym1pdEVycm9yJywge2RhdGE6ZGF0YSwgeGhyOiB4aHJ9KTsgIFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9ybS50cmlnZ2VyKCdzdWJtaXR0ZWQnLCB7ZGF0YTogZGF0YSwgeGhyOiB4aHJ9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgUmVzaXphYmxlIHRleHRhcmVhICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAucmVzaXplVGV4dGFyZWEgPSBmdW5jdGlvbiAodGV4dGFyZWEpIHtcbiAgICAgICAgICAgIHRleHRhcmVhID0gJCh0ZXh0YXJlYSk7XG4gICAgICAgICAgICBpZiAoIXRleHRhcmVhLmhhc0NsYXNzKCdyZXNpemFibGUnKSkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRleHRhcmVhLmNzcyh7J2hlaWdodCc6ICcnfSk7XG4gICAgICAgICAgICB2YXIgaGVpZ2h0ID0gdGV4dGFyZWFbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgdmFyIGRpZmYgPSBoZWlnaHQgLSB0ZXh0YXJlYVswXS5jbGllbnRIZWlnaHQ7XG4gICAgICAgICAgICB2YXIgc2Nyb2xsSGVpZ2h0ID0gdGV4dGFyZWFbMF0uc2Nyb2xsSGVpZ2h0O1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChzY3JvbGxIZWlnaHQgKyBkaWZmID4gaGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgdmFyIG5ld0FyZWFIZWlnaHQgPSBzY3JvbGxIZWlnaHQgKyBkaWZmO1xuICAgICAgICAgICAgICAgIHRleHRhcmVhLmNzcygnaGVpZ2h0JywgbmV3QXJlYUhlaWdodCArICdweCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBhcHAucmVzaXphYmxlVGV4dGFyZWEgPSBmdW5jdGlvbiAodGV4dGFyZWEpIHtcbiAgICAgICAgICAgIHRleHRhcmVhID0gJCh0ZXh0YXJlYSk7XG4gICAgICAgICAgICBpZiAodGV4dGFyZWEubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICB2YXIgdGV4dGFyZWFUaW1lb3V0O1xuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVGV4dGFyZWEoKSB7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRleHRhcmVhVGltZW91dCk7XG4gICAgICAgICAgICAgICAgdGV4dGFyZWFUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5yZXNpemVUZXh0YXJlYSh0ZXh0YXJlYSk7XG4gICAgICAgICAgICAgICAgfSwgMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0ZXh0YXJlYVswXS5mN0Rlc3Ryb3lSZXNpemFibGVUZXh0YXJlYSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB0ZXh0YXJlYS5vZmYoJ2NoYW5nZSBrZXlkb3duIGtleXByZXNzIGtleXVwIHBhc3RlIGN1dCcsIGhhbmRsZVRleHRhcmVhKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXR1cm4gdGV4dGFyZWEub24oJ2NoYW5nZSBrZXlkb3duIGtleXByZXNzIGtleXVwIHBhc3RlIGN1dCcsIGhhbmRsZVRleHRhcmVhKTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmRlc3Ryb3lSZXNpemFibGVUZXh0YXJlYSA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIGlmIChwYWdlQ29udGFpbmVyLmxlbmd0aCA+IDAgJiYgcGFnZUNvbnRhaW5lci5pcygndGV4dGFyZWEnKSAmJiBwYWdlQ29udGFpbmVyWzBdLmY3RGVzdHJveVJlc2l6YWJsZVRleHRhcmVhKSB7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lclswXS5mN0Rlc3Ryb3lSZXNpemFibGVUZXh0YXJlYSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAocGFnZUNvbnRhaW5lci5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcGFnZUNvbnRhaW5lci5maW5kKCd0ZXh0YXJlYS5yZXNpYWJsZScpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdGV4dGFyZWEgPSB0aGlzO1xuICAgICAgICAgICAgICAgICAgICBpZiAodGV4dGFyZWEuZjdEZXN0cm95UmVzaXphYmxlVGV4dGFyZWEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHRhcmVhLmY3RGVzdHJveVJlc2l6YWJsZVRleHRhcmVhICgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5pbml0UGFnZVJlc2l6YWJsZVRleHRhcmVhID0gZnVuY3Rpb24gKHBhZ2VDb250YWluZXIpIHtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIgPSAkKHBhZ2VDb250YWluZXIpO1xuICAgICAgICAgICAgdmFyIHRleHRhcmVhcyA9IHBhZ2VDb250YWluZXIuZmluZCgndGV4dGFyZWEucmVzaXphYmxlJyk7XG4gICAgICAgICAgICB0ZXh0YXJlYXMuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgYXBwLnJlc2l6YWJsZVRleHRhcmVhKHRoaXMpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgTWF0ZXJpYWwgVGV4dCBJbnB1dHMgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLmluaXRQYWdlTWF0ZXJpYWxJbnB1dHMgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICB2YXIgdGV4dGFyZWFzID0gcGFnZUNvbnRhaW5lci5maW5kKCd0ZXh0YXJlYS5yZXNpemFibGUnKTtcbiAgICAgICAgICAgIHBhZ2VDb250YWluZXIuZmluZCgnLml0ZW0taW5wdXQnKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgaXRlbUlucHV0ID0gJCh0aGlzKTtcbiAgICAgICAgICAgICAgICB2YXIgbm90SW5wdXRzID0gWydjaGVja2JveCcsICdidXR0b24nLCAnc3VibWl0JywgJ3JhbmdlJywgJ3JhZGlvJywgJ2ltYWdlJ107XG4gICAgICAgICAgICAgICAgaXRlbUlucHV0LmZpbmQoJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpbnB1dCA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChub3RJbnB1dHMuaW5kZXhPZihpbnB1dC5hdHRyKCd0eXBlJykpIDwgMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbUlucHV0LmFkZENsYXNzKCdpdGVtLWlucHV0LWZpZWxkJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXQudmFsKCkudHJpbSgpICE9PSAnJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0LnBhcmVudHMoJy5pdGVtLWlucHV0LCAuaW5wdXQtZmllbGQnKS5hZGQoaW5wdXQucGFyZW50cygnLml0ZW0taW5uZXInKSkuYWRkQ2xhc3MoJ25vdC1lbXB0eS1zdGF0ZScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaWYgKGl0ZW1JbnB1dC5wYXJlbnRzKCcuaW5wdXQtaXRlbSwgLmlucHV0cy1saXN0JykubGVuZ3RoID4gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGl0ZW1JbnB1dC5wYXJlbnRzKCcubGlzdC1ibG9jaycpLmVxKDApLmFkZENsYXNzKCdpbnB1dHMtbGlzdCcpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIE1hdGVyaWFsIEZvY3VzIElucHV0cyAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAuaW5pdE1hdGVyaWFsV2F0Y2hJbnB1dHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgbm90SW5wdXRzID0gWydjaGVja2JveCcsICdidXR0b24nLCAnc3VibWl0JywgJ3JhbmdlJywgJ3JhZGlvJywgJ2ltYWdlJ107XG4gICAgICAgICAgICBmdW5jdGlvbiBhZGRGb2N1c1N0YXRlKGUpIHtcbiAgICAgICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSovXG4gICAgICAgICAgICAgICAgdmFyIGkgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgIHZhciB0eXBlID0gaS5hdHRyKCd0eXBlJyk7XG4gICAgICAgICAgICAgICAgaWYgKG5vdElucHV0cy5pbmRleE9mKHR5cGUpID49IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgZWxzID0gaS5hZGQoaS5wYXJlbnRzKCcuaXRlbS1pbnB1dCwgLmlucHV0LWZpZWxkJykpLmFkZChpLnBhcmVudHMoJy5pdGVtLWlubmVyJykuZXEoMCkpO1xuICAgICAgICAgICAgICAgIGVscy5hZGRDbGFzcygnZm9jdXMtc3RhdGUnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIHJlbW92ZUZvY3VzU3RhdGUoZSkge1xuICAgICAgICAgICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlKi9cbiAgICAgICAgICAgICAgICB2YXIgaSA9ICQodGhpcyksIHZhbHVlID0gaS52YWwoKTtcbiAgICAgICAgICAgICAgICB2YXIgdHlwZSA9IGkuYXR0cigndHlwZScpO1xuICAgICAgICAgICAgICAgIGlmIChub3RJbnB1dHMuaW5kZXhPZih0eXBlKSA+PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIGVscyA9IGkuYWRkKGkucGFyZW50cygnLml0ZW0taW5wdXQsIC5pbnB1dC1maWVsZCcpKS5hZGQoaS5wYXJlbnRzKCcuaXRlbS1pbm5lcicpLmVxKDApKTtcbiAgICAgICAgICAgICAgICBlbHMucmVtb3ZlQ2xhc3MoJ2ZvY3VzLXN0YXRlJyk7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlLnRyaW0oKSAhPT0gJycpIHtcbiAgICAgICAgICAgICAgICAgICAgZWxzLmFkZENsYXNzKCdub3QtZW1wdHktc3RhdGUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGVscy5yZW1vdmVDbGFzcygnbm90LWVtcHR5LXN0YXRlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gd2F0Y2hDaGFuZ2VTdGF0ZShlKSB7XG4gICAgICAgICAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUqL1xuICAgICAgICAgICAgICAgIHZhciBpID0gJCh0aGlzKSwgdmFsdWUgPSBpLnZhbCgpO1xuICAgICAgICAgICAgICAgIHZhciB0eXBlID0gaS5hdHRyKCd0eXBlJyk7XG4gICAgICAgICAgICAgICAgaWYgKG5vdElucHV0cy5pbmRleE9mKHR5cGUpID49IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgZWxzID0gaS5hZGQoaS5wYXJlbnRzKCcuaXRlbS1pbnB1dCwgLmlucHV0LWZpZWxkJykpLmFkZChpLnBhcmVudHMoJy5pdGVtLWlubmVyJykuZXEoMCkpO1xuICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZS50cmltKCkgIT09ICcnKSB7XG4gICAgICAgICAgICAgICAgICAgIGVscy5hZGRDbGFzcygnbm90LWVtcHR5LXN0YXRlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBlbHMucmVtb3ZlQ2xhc3MoJ25vdC1lbXB0eS1zdGF0ZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uKCdjaGFuZ2UnLCAnLml0ZW0taW5wdXQgaW5wdXQsIC5pdGVtLWlucHV0IHNlbGVjdCwgLml0ZW0taW5wdXQgdGV4dGFyZWEsIGlucHV0LCB0ZXh0YXJlYSwgc2VsZWN0Jywgd2F0Y2hDaGFuZ2VTdGF0ZSwgdHJ1ZSk7XG4gICAgICAgICAgICAkKGRvY3VtZW50KS5vbignZm9jdXMnLCAnLml0ZW0taW5wdXQgaW5wdXQsIC5pdGVtLWlucHV0IHNlbGVjdCwgLml0ZW0taW5wdXQgdGV4dGFyZWEsIGlucHV0LCB0ZXh0YXJlYSwgc2VsZWN0JywgYWRkRm9jdXNTdGF0ZSwgdHJ1ZSk7XG4gICAgICAgICAgICAkKGRvY3VtZW50KS5vbignYmx1cicsICcuaXRlbS1pbnB1dCBpbnB1dCwgLml0ZW0taW5wdXQgc2VsZWN0LCAuaXRlbS1pbnB1dCB0ZXh0YXJlYSwgaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QnLCByZW1vdmVGb2N1c1N0YXRlLCB0cnVlKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAqKioqKioqKioqKiogICBIYW5kbGUgQnJvd3NlcidzIEhpc3RvcnkgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLnB1c2hTdGF0ZVF1ZXVlID0gW107XG4gICAgICAgIGFwcC5wdXNoU3RhdGVDbGVhclF1ZXVlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKGFwcC5wdXNoU3RhdGVRdWV1ZS5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIHZhciBxdWV1ZSA9IGFwcC5wdXNoU3RhdGVRdWV1ZS5wb3AoKTtcbiAgICAgICAgICAgIHZhciBhbmltYXRlUGFnZXM7XG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5wdXNoU3RhdGVOb0FuaW1hdGlvbiA9PT0gdHJ1ZSkgYW5pbWF0ZVBhZ2VzID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAocXVldWUuYWN0aW9uID09PSAnYmFjaycpIHtcbiAgICAgICAgICAgICAgICBhcHAucm91dGVyLmJhY2socXVldWUudmlldywge2FuaW1hdGVQYWdlczogYW5pbWF0ZVBhZ2VzfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocXVldWUuYWN0aW9uID09PSAnbG9hZFBhZ2UnKSB7XG4gICAgICAgICAgICAgICAgYXBwLnJvdXRlci5sb2FkKHF1ZXVlLnZpZXcsIHt1cmw6IHF1ZXVlLnN0YXRlVXJsLCBhbmltYXRlUGFnZXM6IGFuaW1hdGVQYWdlcywgcHVzaFN0YXRlOiBmYWxzZX0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHF1ZXVlLmFjdGlvbiA9PT0gJ2xvYWRDb250ZW50Jykge1xuICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIubG9hZChxdWV1ZS52aWV3LCB7Y29udGVudDogcXVldWUuc3RhdGVDb250ZW50LCBhbmltYXRlUGFnZXM6IGFuaW1hdGVQYWdlcywgcHVzaFN0YXRlOiBmYWxzZX0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHF1ZXVlLmFjdGlvbiA9PT0gJ2xvYWRQYWdlTmFtZScpIHtcbiAgICAgICAgICAgICAgICBhcHAucm91dGVyLmxvYWQocXVldWUudmlldywge3BhZ2VOYW1lOiBxdWV1ZS5zdGF0ZVBhZ2VOYW1lLCB1cmw6IHF1ZXVlLnN0YXRlVXJsLCBhbmltYXRlUGFnZXM6IGFuaW1hdGVQYWdlcywgcHVzaFN0YXRlOiBmYWxzZX0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgYXBwLmluaXRQdXNoU3RhdGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgYmxvY2tQb3BzdGF0ZSA9IHRydWU7XG4gICAgICAgICAgICAkKHdpbmRvdykub24oJ2xvYWQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGJsb2NrUG9wc3RhdGUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlICYmIGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScpIHtcbiAgICAgICAgICAgICAgICBibG9ja1BvcHN0YXRlID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlUG9wU3RhdGUoZSkge1xuICAgICAgICAgICAgICAgIGlmIChibG9ja1BvcHN0YXRlKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIG1haW5WaWV3ID0gYXBwLm1haW5WaWV3O1xuICAgICAgICAgICAgICAgIGlmICghbWFpblZpZXcpIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgc3RhdGUgPSBlLnN0YXRlO1xuICAgICAgICAgICAgICAgIGlmICghc3RhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2aWV3SW5kZXg6IGFwcC52aWV3cy5pbmRleE9mKG1haW5WaWV3KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybCA6IG1haW5WaWV3Lmhpc3RvcnlbMF1cbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlLnZpZXdJbmRleCA8IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgdmlldyA9IGFwcC52aWV3c1tzdGF0ZS52aWV3SW5kZXhdO1xuICAgICAgICAgICAgICAgIHZhciBzdGF0ZVVybCA9IHN0YXRlICYmIHN0YXRlLnVybCB8fCB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgdmFyIHN0YXRlQ29udGVudCA9IHN0YXRlICYmIHN0YXRlLmNvbnRlbnQgfHwgdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHZhciBzdGF0ZVBhZ2VOYW1lID0gc3RhdGUgJiYgc3RhdGUucGFnZU5hbWUgfHwgdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHZhciBhbmltYXRlUGFnZXM7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChhcHAucGFyYW1zLnB1c2hTdGF0ZU5vQW5pbWF0aW9uID09PSB0cnVlKSBhbmltYXRlUGFnZXMgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlVXJsICE9PSB2aWV3LnVybCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5oaXN0b3J5LmluZGV4T2Yoc3RhdGVVcmwpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdvIEJhY2tcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LmFsbG93UGFnZUNoYW5nZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIuYmFjayh2aWV3LCB7dXJsOnVuZGVmaW5lZCwgYW5pbWF0ZVBhZ2VzOiBhbmltYXRlUGFnZXMsIHB1c2hTdGF0ZTogZmFsc2UsIHByZWxvYWRPbmx5OmZhbHNlfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAucHVzaFN0YXRlUXVldWUucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ2JhY2snLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWV3OiB2aWV3XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoc3RhdGVDb250ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBMb2FkIFBhZ2VcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2aWV3LmFsbG93UGFnZUNoYW5nZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5yb3V0ZXIubG9hZCh2aWV3LCB7Y29udGVudDpzdGF0ZUNvbnRlbnQsIGFuaW1hdGVQYWdlczogYW5pbWF0ZVBhZ2VzLCBwdXNoU3RhdGU6IGZhbHNlfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAucHVzaFN0YXRlUXVldWUudW5zaGlmdCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ2xvYWRDb250ZW50JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdGVDb250ZW50OiBzdGF0ZUNvbnRlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZXc6IHZpZXdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoc3RhdGVQYWdlTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCBQYWdlIGJ5IHBhZ2UgbmFtZSB3aXRoIERvbSBDYWNoZVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZpZXcuYWxsb3dQYWdlQ2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnJvdXRlci5sb2FkKHZpZXcsIHtwYWdlTmFtZTpzdGF0ZVBhZ2VOYW1lLCB1cmw6IHN0YXRlVXJsLCBhbmltYXRlUGFnZXM6IGFuaW1hdGVQYWdlcywgcHVzaFN0YXRlOiBmYWxzZX0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwLnB1c2hTdGF0ZVF1ZXVlLnVuc2hpZnQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdsb2FkUGFnZU5hbWUnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVBhZ2VOYW1lOiBzdGF0ZVBhZ2VOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2aWV3OiB2aWV3XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSAge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gTG9hZCBQYWdlXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmlldy5hbGxvd1BhZ2VDaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAucm91dGVyLmxvYWQodmlldywge3VybDpzdGF0ZVVybCwgYW5pbWF0ZVBhZ2VzOiBhbmltYXRlUGFnZXMsIHB1c2hTdGF0ZTogZmFsc2V9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5wdXNoU3RhdGVRdWV1ZS51bnNoaWZ0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiAnbG9hZFBhZ2UnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0ZVVybDogc3RhdGVVcmwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZXc6IHZpZXdcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICQod2luZG93KS5vbigncG9wc3RhdGUnLCBoYW5kbGVQb3BTdGF0ZSk7XG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgIEZyYW1ld29yazcgU3dpcGVyIEFkZGl0aW9uc1xuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBhcHAuc3dpcGVyID0gZnVuY3Rpb24gKGNvbnRhaW5lciwgcGFyYW1zKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFN3aXBlcihjb250YWluZXIsIHBhcmFtcyk7XG4gICAgICAgIH07XG4gICAgICAgIGFwcC5pbml0UGFnZVN3aXBlciA9IGZ1bmN0aW9uIChwYWdlQ29udGFpbmVyKSB7XG4gICAgICAgICAgICBwYWdlQ29udGFpbmVyID0gJChwYWdlQ29udGFpbmVyKTtcbiAgICAgICAgICAgIHZhciBzd2lwZXJzID0gcGFnZUNvbnRhaW5lci5maW5kKCcuc3dpcGVyLWluaXQsIC50YWJzLXN3aXBlYWJsZS13cmFwJyk7XG4gICAgICAgICAgICBpZiAoc3dpcGVycy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgIGZ1bmN0aW9uIGRlc3Ryb3lTd2lwZXJPblJlbW92ZShzbGlkZXIpIHtcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBkZXN0cm95U3dpcGVyKCkge1xuICAgICAgICAgICAgICAgICAgICBzbGlkZXIuZGVzdHJveSgpO1xuICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyLm9mZigncGFnZUJlZm9yZVJlbW92ZScsIGRlc3Ryb3lTd2lwZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwYWdlQ29udGFpbmVyLm9uKCdwYWdlQmVmb3JlUmVtb3ZlJywgZGVzdHJveVN3aXBlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzd2lwZXJzLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBzd2lwZXIgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgIGlmIChzd2lwZXIuaGFzQ2xhc3MoJ3RhYnMtc3dpcGVhYmxlLXdyYXAnKSkge1xuICAgICAgICAgICAgICAgICAgICBzd2lwZXIuYWRkQ2xhc3MoJ3N3aXBlci1jb250YWluZXInKS5jaGlsZHJlbignLnRhYnMnKS5hZGRDbGFzcygnc3dpcGVyLXdyYXBwZXInKS5jaGlsZHJlbignLnRhYicpLmFkZENsYXNzKCdzd2lwZXItc2xpZGUnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHBhcmFtcztcbiAgICAgICAgICAgICAgICBpZiAoc3dpcGVyLmRhdGEoJ3N3aXBlcicpKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcyA9IEpTT04ucGFyc2Uoc3dpcGVyLmRhdGEoJ3N3aXBlcicpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcyA9IHN3aXBlci5kYXRhc2V0KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzd2lwZXIuaGFzQ2xhc3MoJ3RhYnMtc3dpcGVhYmxlLXdyYXAnKSkge1xuICAgICAgICAgICAgICAgICAgICBwYXJhbXMub25TbGlkZUNoYW5nZVN0YXJ0ID0gZnVuY3Rpb24gKHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5zaG93VGFiKHMuc2xpZGVzLmVxKHMuYWN0aXZlSW5kZXgpKTtcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIF9zbGlkZXIgPSBhcHAuc3dpcGVyKHN3aXBlclswXSwgcGFyYW1zKTtcbiAgICAgICAgICAgICAgICBkZXN0cm95U3dpcGVyT25SZW1vdmUoX3NsaWRlcik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnJlaW5pdFBhZ2VTd2lwZXIgPSBmdW5jdGlvbiAocGFnZUNvbnRhaW5lcikge1xuICAgICAgICAgICAgcGFnZUNvbnRhaW5lciA9ICQocGFnZUNvbnRhaW5lcik7XG4gICAgICAgICAgICB2YXIgc2xpZGVycyA9IHBhZ2VDb250YWluZXIuZmluZCgnLnN3aXBlci1pbml0LCAudGFicy1zd2lwZWFibGUtd3JhcCcpO1xuICAgICAgICAgICAgaWYgKHNsaWRlcnMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNsaWRlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgc2xpZGVySW5zdGFuY2UgPSBzbGlkZXJzWzBdLnN3aXBlcjtcbiAgICAgICAgICAgICAgICBpZiAoc2xpZGVySW5zdGFuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgc2xpZGVySW5zdGFuY2UudXBkYXRlKHRydWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgUGhvdG8gQnJvd3NlciAgICoqKioqKioqKioqKlxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICB2YXIgUGhvdG9Ccm93c2VyID0gZnVuY3Rpb24gKHBhcmFtcykge1xuICAgICAgICAgICAgdmFyIHBiID0gdGhpcywgaTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgZGVmYXVsdHMgPSB7XG4gICAgICAgICAgICAgICAgcGhvdG9zIDogW10sXG4gICAgICAgICAgICAgICAgaW5pdGlhbFNsaWRlOiAwLFxuICAgICAgICAgICAgICAgIHNwYWNlQmV0d2VlbjogMjAsXG4gICAgICAgICAgICAgICAgc3BlZWQ6IDMwMCxcbiAgICAgICAgICAgICAgICB6b29tOiB0cnVlLFxuICAgICAgICAgICAgICAgIG1heFpvb206IDMsXG4gICAgICAgICAgICAgICAgbWluWm9vbTogMSxcbiAgICAgICAgICAgICAgICBleHBvc2l0aW9uOiB0cnVlLFxuICAgICAgICAgICAgICAgIGV4cG9zaXRpb25IaWRlQ2FwdGlvbnM6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHR5cGU6ICdzdGFuZGFsb25lJyxcbiAgICAgICAgICAgICAgICBuYXZiYXI6IHRydWUsXG4gICAgICAgICAgICAgICAgdG9vbGJhcjogdHJ1ZSxcbiAgICAgICAgICAgICAgICB0aGVtZTogJ2xpZ2h0JyxcbiAgICAgICAgICAgICAgICBzd2lwZVRvQ2xvc2U6IHRydWUsXG4gICAgICAgICAgICAgICAgYmFja0xpbmtUZXh0OiAnQ2xvc2UnLFxuICAgICAgICAgICAgICAgIG9mVGV4dDogJ29mJyxcbiAgICAgICAgICAgICAgICBsb29wOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBsYXp5TG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICAgICAgbGF6eUxvYWRpbmdJblByZXZOZXh0OiBmYWxzZSxcbiAgICAgICAgICAgICAgICBsYXp5TG9hZGluZ09uVHJhbnNpdGlvblN0YXJ0OiBmYWxzZSxcbiAgICAgICAgICAgICAgICBtYXRlcmlhbDogYXBwLnBhcmFtcy5tYXRlcmlhbCxcbiAgICAgICAgICAgICAgICBtYXRlcmlhbFByZWxvYWRlclN2ZzogYXBwLnBhcmFtcy5tYXRlcmlhbFByZWxvYWRlclN2ZyxcbiAgICAgICAgICAgICAgICBtYXRlcmlhbFByZWxvYWRlckh0bWw6IGFwcC5wYXJhbXMubWF0ZXJpYWxQcmVsb2FkZXJIdG1sLFxuICAgICAgICAgICAgICAgIC8qXG4gICAgICAgICAgICAgICAgQ2FsbGJhY2tzOlxuICAgICAgICAgICAgICAgIG9uTGF6eUltYWdlTG9hZChwYiwgc2xpZGUsIGltZylcbiAgICAgICAgICAgICAgICBvbkxhenlJbWFnZVJlYWR5KHBiLCBzbGlkZSwgaW1nKVxuICAgICAgICAgICAgICAgIG9uT3BlbihwYilcbiAgICAgICAgICAgICAgICBvbkNsb3NlKHBiKVxuICAgICAgICAgICAgICAgIG9uVHJhbnNpdGlvblN0YXJ0KHN3aXBlcilcbiAgICAgICAgICAgICAgICBvblRyYW5zaXRpb25FbmQoc3dpcGVyKVxuICAgICAgICAgICAgICAgIG9uU2xpZGVDaGFuZ2VTdGFydChzd2lwZXIpXG4gICAgICAgICAgICAgICAgb25TbGlkZUNoYW5nZUVuZChzd2lwZXIpXG4gICAgICAgICAgICAgICAgb25UYXAoc3dpcGVyLCBlKVxuICAgICAgICAgICAgICAgIG9uQ2xpY2soc3dpcGVyLCBlKVxuICAgICAgICAgICAgICAgIG9uRG91YmxlVGFwKHN3aXBlciwgZSlcbiAgICAgICAgICAgICAgICBvblN3aXBlVG9DbG9zZShwYilcbiAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xuICAgICAgICAgICAgaWYgKCFwYXJhbXMuYmFja0xpbmtUZXh0ICYmIGFwcC5wYXJhbXMubWF0ZXJpYWwpIGRlZmF1bHRzLmJhY2tMaW5rVGV4dCA9ICcnO1xuICAgICAgICAgICAgZm9yICh2YXIgZGVmIGluIGRlZmF1bHRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXNbZGVmXSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zW2RlZl0gPSBkZWZhdWx0c1tkZWZdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBwYi5wYXJhbXMgPSBwYXJhbXM7XG4gICAgICAgICAgICBwYi5wYXJhbXMuaWNvbnNDb2xvckNsYXNzID0gcGIucGFyYW1zLmljb25zQ29sb3IgPyAnY29sb3ItJyArIHBiLnBhcmFtcy5pY29uc0NvbG9yIDogKHBiLnBhcmFtcy50aGVtZSA9PT0gJ2RhcmsnID8gJ2NvbG9yLXdoaXRlJyA6ICcnKTtcbiAgICAgICAgICAgIHBiLnBhcmFtcy5wcmVsb2FkZXJDb2xvckNsYXNzID0gcGIucGFyYW1zLnRoZW1lID09PSAnZGFyaycgPyAncHJlbG9hZGVyLXdoaXRlJyA6ICcnO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFRlbXBsYXRlc1xuICAgICAgICAgICAgdmFyIHBob3RvVGVtcGxhdGUgPSBwYi5wYXJhbXMucGhvdG9UZW1wbGF0ZSB8fCBcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBob3RvLWJyb3dzZXItc2xpZGUgc3dpcGVyLXNsaWRlXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz1cInBob3RvLWJyb3dzZXItem9vbS1jb250YWluZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8aW1nIHNyYz1cInt7anMgXCJ0aGlzLnVybCB8fCB0aGlzXCJ9fVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9zcGFuPicgK1xuICAgICAgICAgICAgICAgICc8L2Rpdj4nO1xuICAgICAgICAgICAgdmFyIHBob3RvTGF6eVRlbXBsYXRlID0gcGIucGFyYW1zLmxhenlQaG90b1RlbXBsYXRlIHx8XG4gICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwaG90by1icm93c2VyLXNsaWRlIHBob3RvLWJyb3dzZXItc2xpZGUtbGF6eSBzd2lwZXItc2xpZGVcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwcmVsb2FkZXIge3tAcm9vdC5wcmVsb2FkZXJDb2xvckNsYXNzfX1cIj57eyNpZiBAcm9vdC5tYXRlcmlhbH19e3tAcm9vdC5tYXRlcmlhbFByZWxvYWRlckh0bWx9fXt7L2lmfX08L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPVwicGhvdG8tYnJvd3Nlci16b29tLWNvbnRhaW5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxpbWcgZGF0YS1zcmM9XCJ7e2pzIFwidGhpcy51cmwgfHwgdGhpc1wifX1cIiBjbGFzcz1cInN3aXBlci1sYXp5XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8L3NwYW4+JyArXG4gICAgICAgICAgICAgICAgJzwvZGl2Pic7XG4gICAgICAgICAgICB2YXIgb2JqZWN0VGVtcGxhdGUgPSBwYi5wYXJhbXMub2JqZWN0VGVtcGxhdGUgfHxcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBob3RvLWJyb3dzZXItc2xpZGUgcGhvdG8tYnJvd3Nlci1vYmplY3Qtc2xpZGUgc3dpcGVyLXNsaWRlXCI+e3tqcyBcInRoaXMuaHRtbCB8fCB0aGlzXCJ9fTwvZGl2Pic7XG4gICAgICAgICAgICB2YXIgY2FwdGlvblRlbXBsYXRlID0gcGIucGFyYW1zLmNhcHRpb25UZW1wbGF0ZSB8fFxuICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicGhvdG8tYnJvd3Nlci1jYXB0aW9uXCIgZGF0YS1jYXB0aW9uLWluZGV4PVwie3tAaW5kZXh9fVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAne3tjYXB0aW9ufX0nICtcbiAgICAgICAgICAgICAgICAnPC9kaXY+JztcbiAgICAgICAgICAgIHZhciBuYXZiYXJUZW1wbGF0ZSA9IHBiLnBhcmFtcy5uYXZiYXJUZW1wbGF0ZSB8fFxuICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibmF2YmFyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibmF2YmFyLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImxlZnQgc2xpZGluZ1wiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8YSBocmVmPVwiI1wiIGNsYXNzPVwibGluayBjbG9zZS1wb3B1cCBwaG90by1icm93c2VyLWNsb3NlLWxpbmsge3sjdW5sZXNzIGJhY2tMaW5rVGV4dH19aWNvbi1vbmx5e3svdW5sZXNzfX0ge3tqcyBcInRoaXMudHlwZSA9PT0gXFwncGFnZVxcJyA/IFxcJ2JhY2tcXCcgOiBcXCdcXCdcIn19XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8aSBjbGFzcz1cImljb24gaWNvbi1iYWNrIHt7aWNvbnNDb2xvckNsYXNzfX1cIj48L2k+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBiYWNrTGlua1RleHR9fTxzcGFuPnt7YmFja0xpbmtUZXh0fX08L3NwYW4+e3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2E+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImNlbnRlciBzbGlkaW5nXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPVwicGhvdG8tYnJvd3Nlci1jdXJyZW50XCI+PC9zcGFuPiAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHNwYW4gY2xhc3M9XCJwaG90by1icm93c2VyLW9mXCI+e3tvZlRleHR9fTwvc3Bhbj4gJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPVwicGhvdG8tYnJvd3Nlci10b3RhbFwiPjwvc3Bhbj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicmlnaHRcIj48L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICc8L2Rpdj4nO1xuICAgICAgICAgICAgdmFyIHRvb2xiYXJUZW1wbGF0ZSA9IHBiLnBhcmFtcy50b29sYmFyVGVtcGxhdGUgfHxcbiAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInRvb2xiYXIgdGFiYmFyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwidG9vbGJhci1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxhIGhyZWY9XCIjXCIgY2xhc3M9XCJsaW5rIHBob3RvLWJyb3dzZXItcHJldlwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8aSBjbGFzcz1cImljb24gaWNvbi1wcmV2IHt7aWNvbnNDb2xvckNsYXNzfX1cIj48L2k+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9hPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxhIGhyZWY9XCIjXCIgY2xhc3M9XCJsaW5rIHBob3RvLWJyb3dzZXItbmV4dFwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8aSBjbGFzcz1cImljb24gaWNvbi1uZXh0IHt7aWNvbnNDb2xvckNsYXNzfX1cIj48L2k+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9hPicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgJzwvZGl2Pic7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIGh0bWxUZW1wbGF0ZSA9IHQ3LmNvbXBpbGUoJzxkaXYgY2xhc3M9XCJwaG90by1icm93c2VyIHBob3RvLWJyb3dzZXIte3t0aGVtZX19XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwidmlldyBuYXZiYXItZml4ZWQgdG9vbGJhci1maXhlZFwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I3VubGVzcyBtYXRlcmlhbH19e3sjaWYgbmF2YmFyfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5hdmJhclRlbXBsYXRlICtcbiAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19e3svdW5sZXNzfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicGFnZSBuby10b29sYmFyIHt7I3VubGVzcyBuYXZiYXJ9fW5vLW5hdmJhcnt7L3VubGVzc319IHRvb2xiYXItZml4ZWQgbmF2YmFyLWZpeGVkXCIgZGF0YS1wYWdlPVwicGhvdG8tYnJvd3Nlci1zbGlkZXNcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgbWF0ZXJpYWx9fXt7I2lmIG5hdmJhcn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmF2YmFyVGVtcGxhdGUgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19e3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiB0b29sYmFyfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b29sYmFyVGVtcGxhdGUgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwaG90by1icm93c2VyLWNhcHRpb25zIHBob3RvLWJyb3dzZXItY2FwdGlvbnMte3tqcyBcInRoaXMuY2FwdGlvbnNUaGVtZSB8fCB0aGlzLnRoZW1lXCJ9fVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjZWFjaCBwaG90b3N9fXt7I2lmIGNhcHRpb259fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXB0aW9uVGVtcGxhdGUgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fXt7L2VhY2h9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBob3RvLWJyb3dzZXItc3dpcGVyLWNvbnRhaW5lciBzd2lwZXItY29udGFpbmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicGhvdG8tYnJvd3Nlci1zd2lwZXItd3JhcHBlciBzd2lwZXItd3JhcHBlclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2VhY2ggcGhvdG9zfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNqc19jb21wYXJlIFwidGhpcy5odG1sIHx8ICgodHlwZW9mIHRoaXMgPT09IFxcJ3N0cmluZ1xcJyB8fCB0aGlzIGluc3RhbmNlb2YgU3RyaW5nKSAmJiAodGhpcy5pbmRleE9mKFxcJzxcXCcpID49IDAgfHwgdGhpcy5pbmRleE9mKFxcJz5cXCcpID49IDApKVwifX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3RUZW1wbGF0ZSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3tlbHNlfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgQHJvb3QubGF6eUxvYWRpbmd9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBob3RvTGF6eVRlbXBsYXRlICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3tlbHNlfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaG90b1RlbXBsYXRlICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2pzX2NvbXBhcmV9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2VhY2h9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgJzwvZGl2PicpKHBiLnBhcmFtcyk7XG4gICAgICAgIFxuICAgICAgICAgICAgcGIuYWN0aXZlSW5kZXggPSBwYi5wYXJhbXMuaW5pdGlhbFNsaWRlO1xuICAgICAgICAgICAgcGIub3BlbkluZGV4ID0gcGIuYWN0aXZlSW5kZXg7XG4gICAgICAgICAgICBwYi5vcGVuZWQgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICBwYi5vcGVuID0gZnVuY3Rpb24gKGluZGV4KSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PT0gJ3VuZGVmaW5lZCcpIGluZGV4ID0gcGIuYWN0aXZlSW5kZXg7XG4gICAgICAgICAgICAgICAgaW5kZXggPSBwYXJzZUludChpbmRleCwgMTApO1xuICAgICAgICAgICAgICAgIGlmIChwYi5vcGVuZWQgJiYgcGIuc3dpcGVyKSB7XG4gICAgICAgICAgICAgICAgICAgIHBiLnN3aXBlci5zbGlkZVRvKGluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwYi5vcGVuZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHBiLm9wZW5JbmRleCA9IGluZGV4O1xuICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMudHlwZSA9PT0gJ3N0YW5kYWxvbmUnKSB7XG4gICAgICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hcHBlbmQoaHRtbFRlbXBsYXRlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy50eXBlID09PSAncG9wdXAnKSB7XG4gICAgICAgICAgICAgICAgICAgIHBiLnBvcHVwID0gYXBwLnBvcHVwKCc8ZGl2IGNsYXNzPVwicG9wdXAgcGhvdG8tYnJvd3Nlci1wb3B1cFwiPicgKyBodG1sVGVtcGxhdGUgKyAnPC9kaXY+Jyk7XG4gICAgICAgICAgICAgICAgICAgICQocGIucG9wdXApLm9uKCdjbG9zZWQnLCBwYi5vblBvcHVwQ2xvc2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLnR5cGUgPT09ICdwYWdlJykge1xuICAgICAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vbigncGFnZUJlZm9yZUluaXQnLCBwYi5vblBhZ2VCZWZvcmVJbml0KTtcbiAgICAgICAgICAgICAgICAgICAgJChkb2N1bWVudCkub24oJ3BhZ2VCZWZvcmVSZW1vdmUnLCBwYi5vblBhZ2VCZWZvcmVSZW1vdmUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXBiLnBhcmFtcy52aWV3KSBwYi5wYXJhbXMudmlldyA9IGFwcC5tYWluVmlldztcbiAgICAgICAgICAgICAgICAgICAgcGIucGFyYW1zLnZpZXcubG9hZENvbnRlbnQoaHRtbFRlbXBsYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwYi5sYXlvdXQocGIub3BlbkluZGV4KTtcbiAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLm9uT3Blbikge1xuICAgICAgICAgICAgICAgICAgICBwYi5wYXJhbXMub25PcGVuKHBiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBiLmNsb3NlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHBiLm9wZW5lZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmICghcGIuc3dpcGVyQ29udGFpbmVyIHx8IHBiLnN3aXBlckNvbnRhaW5lci5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLm9uQ2xvc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgcGIucGFyYW1zLm9uQ2xvc2UocGIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBEZXRhY2ggZXZlbnRzXG4gICAgICAgICAgICAgICAgcGIuYXR0YWNoRXZlbnRzKHRydWUpO1xuICAgICAgICAgICAgICAgIC8vIERlbGV0ZSBmcm9tIERPTVxuICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMudHlwZSA9PT0gJ3N0YW5kYWxvbmUnKSB7XG4gICAgICAgICAgICAgICAgICAgIHBiLmNvbnRhaW5lci5yZW1vdmVDbGFzcygncGhvdG8tYnJvd3Nlci1pbicpLmFkZENsYXNzKCdwaG90by1icm93c2VyLW91dCcpLmFuaW1hdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYi5jb250YWluZXIucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBEZXN0cm95IHNsaWRlclxuICAgICAgICAgICAgICAgIHBiLnN3aXBlci5kZXN0cm95KCk7XG4gICAgICAgICAgICAgICAgLy8gRGVsZXRlIHJlZmVyZW5jZXNcbiAgICAgICAgICAgICAgICBwYi5zd2lwZXIgPSBwYi5zd2lwZXJDb250YWluZXIgPSBwYi5zd2lwZXJXcmFwcGVyID0gcGIuc2xpZGVzID0gZ2VzdHVyZVNsaWRlID0gZ2VzdHVyZUltZyA9IGdlc3R1cmVJbWdXcmFwID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICBwYi5vblBvcHVwQ2xvc2UgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIHBiLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgJChwYi5wb3B1cCkub2ZmKCdwYWdlQmVmb3JlSW5pdCcsIHBiLm9uUG9wdXBDbG9zZSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcGIub25QYWdlQmVmb3JlSW5pdCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGUuZGV0YWlsLnBhZ2UubmFtZSA9PT0gJ3Bob3RvLWJyb3dzZXItc2xpZGVzJykge1xuICAgICAgICAgICAgICAgICAgICBwYi5sYXlvdXQocGIub3BlbkluZGV4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgJChkb2N1bWVudCkub2ZmKCdwYWdlQmVmb3JlSW5pdCcsIHBiLm9uUGFnZUJlZm9yZUluaXQpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBiLm9uUGFnZUJlZm9yZVJlbW92ZSA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGUuZGV0YWlsLnBhZ2UubmFtZSA9PT0gJ3Bob3RvLWJyb3dzZXItc2xpZGVzJykge1xuICAgICAgICAgICAgICAgICAgICBwYi5jbG9zZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vZmYoJ3BhZ2VCZWZvcmVSZW1vdmUnLCBwYi5vblBhZ2VCZWZvcmVSZW1vdmUpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICBwYi5vblNsaWRlclRyYW5zaXRpb25TdGFydCA9IGZ1bmN0aW9uIChzd2lwZXIpIHtcbiAgICAgICAgICAgICAgICBwYi5hY3RpdmVJbmRleCA9IHN3aXBlci5hY3RpdmVJbmRleDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIGN1cnJlbnQgPSBzd2lwZXIuYWN0aXZlSW5kZXggKyAxO1xuICAgICAgICAgICAgICAgIHZhciB0b3RhbCA9IHN3aXBlci5zbGlkZXMubGVuZ3RoO1xuICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMubG9vcCkge1xuICAgICAgICAgICAgICAgICAgICB0b3RhbCA9IHRvdGFsIC0gMjtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IGN1cnJlbnQgLSBzd2lwZXIubG9vcGVkU2xpZGVzO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCA8IDEpIGN1cnJlbnQgPSB0b3RhbCArIGN1cnJlbnQ7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50ID4gdG90YWwpIGN1cnJlbnQgPSBjdXJyZW50IC0gdG90YWw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHBiLmNvbnRhaW5lci5maW5kKCcucGhvdG8tYnJvd3Nlci1jdXJyZW50JykudGV4dChjdXJyZW50KTtcbiAgICAgICAgICAgICAgICBwYi5jb250YWluZXIuZmluZCgnLnBob3RvLWJyb3dzZXItdG90YWwnKS50ZXh0KHRvdGFsKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgJCgnLnBob3RvLWJyb3dzZXItcHJldiwgLnBob3RvLWJyb3dzZXItbmV4dCcpLnJlbW92ZUNsYXNzKCdwaG90by1icm93c2VyLWxpbmstaW5hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoc3dpcGVyLmlzQmVnaW5uaW5nICYmICFwYi5wYXJhbXMubG9vcCkge1xuICAgICAgICAgICAgICAgICAgICAkKCcucGhvdG8tYnJvd3Nlci1wcmV2JykuYWRkQ2xhc3MoJ3Bob3RvLWJyb3dzZXItbGluay1pbmFjdGl2ZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoc3dpcGVyLmlzRW5kICYmICFwYi5wYXJhbXMubG9vcCkge1xuICAgICAgICAgICAgICAgICAgICAkKCcucGhvdG8tYnJvd3Nlci1uZXh0JykuYWRkQ2xhc3MoJ3Bob3RvLWJyb3dzZXItbGluay1pbmFjdGl2ZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gVXBkYXRlIGNhcHRpb25zXG4gICAgICAgICAgICAgICAgaWYgKHBiLmNhcHRpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcGIuY2FwdGlvbnNDb250YWluZXIuZmluZCgnLnBob3RvLWJyb3dzZXItY2FwdGlvbi1hY3RpdmUnKS5yZW1vdmVDbGFzcygncGhvdG8tYnJvd3Nlci1jYXB0aW9uLWFjdGl2ZScpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgY2FwdGlvbkluZGV4ID0gcGIucGFyYW1zLmxvb3AgPyBzd2lwZXIuc2xpZGVzLmVxKHN3aXBlci5hY3RpdmVJbmRleCkuYXR0cignZGF0YS1zd2lwZXItc2xpZGUtaW5kZXgnKSA6IHBiLmFjdGl2ZUluZGV4O1xuICAgICAgICAgICAgICAgICAgICBwYi5jYXB0aW9uc0NvbnRhaW5lci5maW5kKCdbZGF0YS1jYXB0aW9uLWluZGV4PVwiJyArIGNhcHRpb25JbmRleCArICdcIl0nKS5hZGRDbGFzcygncGhvdG8tYnJvd3Nlci1jYXB0aW9uLWFjdGl2ZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFN0b3AgVmlkZW9cbiAgICAgICAgICAgICAgICB2YXIgcHJldmlvdXNTbGlkZVZpZGVvID0gc3dpcGVyLnNsaWRlcy5lcShzd2lwZXIucHJldmlvdXNJbmRleCkuZmluZCgndmlkZW8nKTtcbiAgICAgICAgICAgICAgICBpZiAocHJldmlvdXNTbGlkZVZpZGVvLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCdwYXVzZScgaW4gcHJldmlvdXNTbGlkZVZpZGVvWzBdKSBwcmV2aW91c1NsaWRlVmlkZW9bMF0ucGF1c2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gQ2FsbGJhY2tcbiAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLm9uVHJhbnNpdGlvblN0YXJ0KSBwYi5wYXJhbXMub25UcmFuc2l0aW9uU3RhcnQoc3dpcGVyKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYi5vblNsaWRlclRyYW5zaXRpb25FbmQgPSBmdW5jdGlvbiAoc3dpcGVyKSB7XG4gICAgICAgICAgICAgICAgLy8gUmVzZXQgem9vbVxuICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMuem9vbSAmJiBnZXN0dXJlU2xpZGUgJiYgc3dpcGVyLnByZXZpb3VzSW5kZXggIT09IHN3aXBlci5hY3RpdmVJbmRleCkge1xuICAgICAgICAgICAgICAgICAgICBnZXN0dXJlSW1nLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwwLDApIHNjYWxlKDEpJyk7XG4gICAgICAgICAgICAgICAgICAgIGdlc3R1cmVJbWdXcmFwLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwwLDApJyk7XG4gICAgICAgICAgICAgICAgICAgIGdlc3R1cmVTbGlkZSA9IGdlc3R1cmVJbWcgPSBnZXN0dXJlSW1nV3JhcCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgc2NhbGUgPSBjdXJyZW50U2NhbGUgPSAxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLm9uVHJhbnNpdGlvbkVuZCkgcGIucGFyYW1zLm9uVHJhbnNpdGlvbkVuZChzd2lwZXIpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcGIubGF5b3V0ID0gZnVuY3Rpb24gKGluZGV4KSB7XG4gICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy50eXBlID09PSAncGFnZScpIHtcbiAgICAgICAgICAgICAgICAgICAgcGIuY29udGFpbmVyID0gJCgnLnBob3RvLWJyb3dzZXItc3dpcGVyLWNvbnRhaW5lcicpLnBhcmVudHMoJy52aWV3Jyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwYi5jb250YWluZXIgPSAkKCcucGhvdG8tYnJvd3NlcicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLnR5cGUgPT09ICdzdGFuZGFsb25lJykge1xuICAgICAgICAgICAgICAgICAgICBwYi5jb250YWluZXIuYWRkQ2xhc3MoJ3Bob3RvLWJyb3dzZXItaW4nKTtcbiAgICAgICAgICAgICAgICAgICAgYXBwLnNpemVOYXZiYXJzKHBiLmNvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHBiLnN3aXBlckNvbnRhaW5lciA9IHBiLmNvbnRhaW5lci5maW5kKCcucGhvdG8tYnJvd3Nlci1zd2lwZXItY29udGFpbmVyJyk7XG4gICAgICAgICAgICAgICAgcGIuc3dpcGVyV3JhcHBlciA9IHBiLmNvbnRhaW5lci5maW5kKCcucGhvdG8tYnJvd3Nlci1zd2lwZXItd3JhcHBlcicpO1xuICAgICAgICAgICAgICAgIHBiLnNsaWRlcyA9IHBiLmNvbnRhaW5lci5maW5kKCcucGhvdG8tYnJvd3Nlci1zbGlkZScpO1xuICAgICAgICAgICAgICAgIHBiLmNhcHRpb25zQ29udGFpbmVyID0gcGIuY29udGFpbmVyLmZpbmQoJy5waG90by1icm93c2VyLWNhcHRpb25zJyk7XG4gICAgICAgICAgICAgICAgcGIuY2FwdGlvbnMgPSBwYi5jb250YWluZXIuZmluZCgnLnBob3RvLWJyb3dzZXItY2FwdGlvbicpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBzbGlkZXJTZXR0aW5ncyA9IHtcbiAgICAgICAgICAgICAgICAgICAgbmV4dEJ1dHRvbjogcGIucGFyYW1zLm5leHRCdXR0b24gfHwgJy5waG90by1icm93c2VyLW5leHQnLFxuICAgICAgICAgICAgICAgICAgICBwcmV2QnV0dG9uOiBwYi5wYXJhbXMucHJldkJ1dHRvbiB8fCAnLnBob3RvLWJyb3dzZXItcHJldicsXG4gICAgICAgICAgICAgICAgICAgIGluZGV4QnV0dG9uOiBwYi5wYXJhbXMuaW5kZXhCdXR0b24sXG4gICAgICAgICAgICAgICAgICAgIGluaXRpYWxTbGlkZTogaW5kZXgsXG4gICAgICAgICAgICAgICAgICAgIHNwYWNlQmV0d2VlbjogcGIucGFyYW1zLnNwYWNlQmV0d2VlbixcbiAgICAgICAgICAgICAgICAgICAgc3BlZWQ6IHBiLnBhcmFtcy5zcGVlZCxcbiAgICAgICAgICAgICAgICAgICAgbG9vcDogcGIucGFyYW1zLmxvb3AsXG4gICAgICAgICAgICAgICAgICAgIGxhenlMb2FkaW5nOiBwYi5wYXJhbXMubGF6eUxvYWRpbmcsXG4gICAgICAgICAgICAgICAgICAgIGxhenlMb2FkaW5nSW5QcmV2TmV4dDogcGIucGFyYW1zLmxhenlMb2FkaW5nSW5QcmV2TmV4dCxcbiAgICAgICAgICAgICAgICAgICAgbGF6eUxvYWRpbmdPblRyYW5zaXRpb25TdGFydDogcGIucGFyYW1zLmxhenlMb2FkaW5nT25UcmFuc2l0aW9uU3RhcnQsXG4gICAgICAgICAgICAgICAgICAgIHByZWxvYWRJbWFnZXM6IHBiLnBhcmFtcy5sYXp5TG9hZGluZyA/IGZhbHNlIDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgb25UYXA6IGZ1bmN0aW9uIChzd2lwZXIsIGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMub25UYXApIHBiLnBhcmFtcy5vblRhcChzd2lwZXIsIGUpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBvbkNsaWNrOiBmdW5jdGlvbiAoc3dpcGVyLCBlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLmV4cG9zaXRpb24pIHBiLnRvZ2dsZUV4cG9zaXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMub25DbGljaykgcGIucGFyYW1zLm9uQ2xpY2soc3dpcGVyLCBlKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgb25Eb3VibGVUYXA6IGZ1bmN0aW9uIChzd2lwZXIsIGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBiLnRvZ2dsZVpvb20oZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLm9uRG91YmxlVGFwKSBwYi5wYXJhbXMub25Eb3VibGVUYXAoc3dpcGVyLCBlKTtcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgb25UcmFuc2l0aW9uU3RhcnQ6IGZ1bmN0aW9uIChzd2lwZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBiLm9uU2xpZGVyVHJhbnNpdGlvblN0YXJ0KHN3aXBlcik7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIG9uVHJhbnNpdGlvbkVuZDogZnVuY3Rpb24gKHN3aXBlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGIub25TbGlkZXJUcmFuc2l0aW9uRW5kKHN3aXBlcik7ICBcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgb25TbGlkZUNoYW5nZVN0YXJ0OiBwYi5wYXJhbXMub25TbGlkZUNoYW5nZVN0YXJ0LFxuICAgICAgICAgICAgICAgICAgICBvblNsaWRlQ2hhbmdlRW5kOiBwYi5wYXJhbXMub25TbGlkZUNoYW5nZUVuZCxcbiAgICAgICAgICAgICAgICAgICAgb25MYXp5SW1hZ2VMb2FkOiBmdW5jdGlvbiAoc3dpcGVyLCBzbGlkZSwgaW1nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLm9uTGF6eUltYWdlTG9hZCkgcGIucGFyYW1zLm9uTGF6eUltYWdlTG9hZChwYiwgc2xpZGUsIGltZyk7XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIG9uTGF6eUltYWdlUmVhZHk6IGZ1bmN0aW9uIChzd2lwZXIsIHNsaWRlLCBpbWcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoc2xpZGUpLnJlbW92ZUNsYXNzKCdwaG90by1icm93c2VyLXNsaWRlLWxhenknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMub25MYXp5SW1hZ2VSZWFkeSkgcGIucGFyYW1zLm9uTGF6eUltYWdlUmVhZHkocGIsIHNsaWRlLCBpbWcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy5zd2lwZVRvQ2xvc2UgJiYgcGIucGFyYW1zLnR5cGUgIT09ICdwYWdlJykge1xuICAgICAgICAgICAgICAgICAgICBzbGlkZXJTZXR0aW5ncy5vblRvdWNoU3RhcnQgPSBwYi5zd2lwZUNsb3NlVG91Y2hTdGFydDtcbiAgICAgICAgICAgICAgICAgICAgc2xpZGVyU2V0dGluZ3Mub25Ub3VjaE1vdmVPcHBvc2l0ZSA9IHBiLnN3aXBlQ2xvc2VUb3VjaE1vdmU7XG4gICAgICAgICAgICAgICAgICAgIHNsaWRlclNldHRpbmdzLm9uVG91Y2hFbmQgPSBwYi5zd2lwZUNsb3NlVG91Y2hFbmQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBwYi5zd2lwZXIgPSBhcHAuc3dpcGVyKHBiLnN3aXBlckNvbnRhaW5lciwgc2xpZGVyU2V0dGluZ3MpO1xuICAgICAgICAgICAgICAgIGlmIChpbmRleCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBwYi5vblNsaWRlclRyYW5zaXRpb25TdGFydChwYi5zd2lwZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwYi5hdHRhY2hFdmVudHMoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYi5hdHRhY2hFdmVudHMgPSBmdW5jdGlvbiAoZGV0YWNoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGFjdGlvbiA9IGRldGFjaCA/ICdvZmYnIDogJ29uJztcbiAgICAgICAgICAgICAgICAvLyBTbGlkZSBiZXR3ZWVuIHBob3Rvc1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLnpvb20pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IHBiLnBhcmFtcy5sb29wID8gcGIuc3dpcGVyLnNsaWRlcyA6IHBiLnNsaWRlcztcbiAgICAgICAgICAgICAgICAgICAgLy8gU2NhbGUgaW1hZ2VcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W2FjdGlvbl0oJ2dlc3R1cmVzdGFydCcsIHBiLm9uU2xpZGVHZXN0dXJlU3RhcnQpO1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXRbYWN0aW9uXSgnZ2VzdHVyZWNoYW5nZScsIHBiLm9uU2xpZGVHZXN0dXJlQ2hhbmdlKTtcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W2FjdGlvbl0oJ2dlc3R1cmVlbmQnLCBwYi5vblNsaWRlR2VzdHVyZUVuZCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBNb3ZlIGltYWdlXG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFthY3Rpb25dKGFwcC50b3VjaEV2ZW50cy5zdGFydCwgcGIub25TbGlkZVRvdWNoU3RhcnQpO1xuICAgICAgICAgICAgICAgICAgICB0YXJnZXRbYWN0aW9uXShhcHAudG91Y2hFdmVudHMubW92ZSwgcGIub25TbGlkZVRvdWNoTW92ZSk7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldFthY3Rpb25dKGFwcC50b3VjaEV2ZW50cy5lbmQsIHBiLm9uU2xpZGVUb3VjaEVuZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHBiLmNvbnRhaW5lci5maW5kKCcucGhvdG8tYnJvd3Nlci1jbG9zZS1saW5rJylbYWN0aW9uXSgnY2xpY2snLCBwYi5jbG9zZSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBpc1RvdWNoZWQsIGlzTW92ZWQsIHRvdWNoZXNTdGFydCA9IHt9LCB0b3VjaGVzQ3VycmVudCA9IHt9LCB0b3VjaFN0YXJ0VGltZSwgaXNTY3JvbGxpbmcsIGFuaW1hdGluZyA9IGZhbHNlLCBjdXJyZW50VHJhbnNsYXRlO1xuICAgICAgICAgICAgdmFyIGFsbG93Q2xpY2sgPSB0cnVlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEV4cG9zZVxuICAgICAgICAgICAgcGIuZXhwb3NlZCA9IGZhbHNlO1xuICAgICAgICAgICAgcGIudG9nZ2xlRXhwb3NpdGlvbiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAocGIuY29udGFpbmVyKSBwYi5jb250YWluZXIudG9nZ2xlQ2xhc3MoJ3Bob3RvLWJyb3dzZXItZXhwb3NlZCcpO1xuICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMuZXhwb3NpdGlvbkhpZGVDYXB0aW9ucykgcGIuY2FwdGlvbnNDb250YWluZXIudG9nZ2xlQ2xhc3MoJ3Bob3RvLWJyb3dzZXItY2FwdGlvbnMtZXhwb3NlZCcpO1xuICAgICAgICAgICAgICAgIHBiLmV4cG9zZWQgPSAhcGIuZXhwb3NlZDtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYi5lbmFibGVFeHBvc2l0aW9uID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChwYi5jb250YWluZXIpIHBiLmNvbnRhaW5lci5hZGRDbGFzcygncGhvdG8tYnJvd3Nlci1leHBvc2VkJyk7XG4gICAgICAgICAgICAgICAgaWYgKHBiLnBhcmFtcy5leHBvc2l0aW9uSGlkZUNhcHRpb25zKSBwYi5jYXB0aW9uc0NvbnRhaW5lci5hZGRDbGFzcygncGhvdG8tYnJvd3Nlci1jYXB0aW9ucy1leHBvc2VkJyk7XG4gICAgICAgICAgICAgICAgcGIuZXhwb3NlZCA9IHRydWU7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcGIuZGlzYWJsZUV4cG9zaXRpb24gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHBiLmNvbnRhaW5lcikgcGIuY29udGFpbmVyLnJlbW92ZUNsYXNzKCdwaG90by1icm93c2VyLWV4cG9zZWQnKTtcbiAgICAgICAgICAgICAgICBpZiAocGIucGFyYW1zLmV4cG9zaXRpb25IaWRlQ2FwdGlvbnMpIHBiLmNhcHRpb25zQ29udGFpbmVyLnJlbW92ZUNsYXNzKCdwaG90by1icm93c2VyLWNhcHRpb25zLWV4cG9zZWQnKTtcbiAgICAgICAgICAgICAgICBwYi5leHBvc2VkID0gZmFsc2U7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBHZXN0dXJlc1xuICAgICAgICAgICAgdmFyIGdlc3R1cmVTbGlkZSwgZ2VzdHVyZUltZywgZ2VzdHVyZUltZ1dyYXAsIHNjYWxlID0gMSwgY3VycmVudFNjYWxlID0gMSwgaXNTY2FsaW5nID0gZmFsc2U7XG4gICAgICAgICAgICBwYi5vblNsaWRlR2VzdHVyZVN0YXJ0ID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWdlc3R1cmVTbGlkZSB8fCAhZ2VzdHVyZVNsaWRlLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBnZXN0dXJlU2xpZGUgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZ2VzdHVyZVNsaWRlLmxlbmd0aCA9PT0gMCkgZ2VzdHVyZVNsaWRlID0gcGIuc3dpcGVyLnNsaWRlcy5lcShwYi5zd2lwZXIuYWN0aXZlSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICBnZXN0dXJlSW1nID0gZ2VzdHVyZVNsaWRlLmZpbmQoJ2ltZywgc3ZnLCBjYW52YXMnKTtcbiAgICAgICAgICAgICAgICAgICAgZ2VzdHVyZUltZ1dyYXAgPSBnZXN0dXJlSW1nLnBhcmVudCgnLnBob3RvLWJyb3dzZXItem9vbS1jb250YWluZXInKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGdlc3R1cmVJbWdXcmFwLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZ2VzdHVyZUltZyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBnZXN0dXJlSW1nLnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgaXNTY2FsaW5nID0gdHJ1ZTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYi5vblNsaWRlR2VzdHVyZUNoYW5nZSA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFnZXN0dXJlSW1nIHx8IGdlc3R1cmVJbWcubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgc2NhbGUgPSBlLnNjYWxlICogY3VycmVudFNjYWxlO1xuICAgICAgICAgICAgICAgIGlmIChzY2FsZSA+IHBiLnBhcmFtcy5tYXhab29tKSB7XG4gICAgICAgICAgICAgICAgICAgIHNjYWxlID0gcGIucGFyYW1zLm1heFpvb20gLSAxICsgTWF0aC5wb3coKHNjYWxlIC0gcGIucGFyYW1zLm1heFpvb20gKyAxKSwgMC41KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHNjYWxlIDwgcGIucGFyYW1zLm1pblpvb20pIHtcbiAgICAgICAgICAgICAgICAgICAgc2NhbGUgPSAgcGIucGFyYW1zLm1pblpvb20gKyAxIC0gTWF0aC5wb3coKHBiLnBhcmFtcy5taW5ab29tIC0gc2NhbGUgKyAxKSwgMC41KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZ2VzdHVyZUltZy50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDAsMCwwKSBzY2FsZSgnICsgc2NhbGUgKyAnKScpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBiLm9uU2xpZGVHZXN0dXJlRW5kID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWdlc3R1cmVJbWcgfHwgZ2VzdHVyZUltZy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICBzY2FsZSA9IE1hdGgubWF4KE1hdGgubWluKHNjYWxlLCBwYi5wYXJhbXMubWF4Wm9vbSksIHBiLnBhcmFtcy5taW5ab29tKTtcbiAgICAgICAgICAgICAgICBnZXN0dXJlSW1nLnRyYW5zaXRpb24ocGIucGFyYW1zLnNwZWVkKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDAsMCwwKSBzY2FsZSgnICsgc2NhbGUgKyAnKScpO1xuICAgICAgICAgICAgICAgIGN1cnJlbnRTY2FsZSA9IHNjYWxlO1xuICAgICAgICAgICAgICAgIGlzU2NhbGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChzY2FsZSA9PT0gMSkgZ2VzdHVyZVNsaWRlID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBiLnRvZ2dsZVpvb20gPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGlmICghZ2VzdHVyZVNsaWRlKSB7XG4gICAgICAgICAgICAgICAgICAgIGdlc3R1cmVTbGlkZSA9IHBiLnN3aXBlci5zbGlkZXMuZXEocGIuc3dpcGVyLmFjdGl2ZUluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgZ2VzdHVyZUltZyA9IGdlc3R1cmVTbGlkZS5maW5kKCdpbWcsIHN2ZywgY2FudmFzJyk7XG4gICAgICAgICAgICAgICAgICAgIGdlc3R1cmVJbWdXcmFwID0gZ2VzdHVyZUltZy5wYXJlbnQoJy5waG90by1icm93c2VyLXpvb20tY29udGFpbmVyJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghZ2VzdHVyZUltZyB8fCBnZXN0dXJlSW1nLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciB0b3VjaFgsIHRvdWNoWSwgb2Zmc2V0WCwgb2Zmc2V0WSwgZGlmZlgsIGRpZmZZLCB0cmFuc2xhdGVYLCB0cmFuc2xhdGVZLCBpbWFnZVdpZHRoLCBpbWFnZUhlaWdodCwgc2NhbGVkV2lkdGgsIHNjYWxlZEhlaWdodCwgdHJhbnNsYXRlTWluWCwgdHJhbnNsYXRlTWluWSwgdHJhbnNsYXRlTWF4WCwgdHJhbnNsYXRlTWF4WTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbWFnZVRvdWNoZXNTdGFydC54ID09PSAndW5kZWZpbmVkJyAmJiBlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoWCA9IGUudHlwZSA9PT0gJ3RvdWNoZW5kJyA/IGUuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVggOiBlLnBhZ2VYO1xuICAgICAgICAgICAgICAgICAgICB0b3VjaFkgPSBlLnR5cGUgPT09ICd0b3VjaGVuZCcgPyBlLmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoWCA9IGltYWdlVG91Y2hlc1N0YXJ0Lng7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoWSA9IGltYWdlVG91Y2hlc1N0YXJ0Lnk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChzY2FsZSAmJiBzY2FsZSAhPT0gMSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBab29tIE91dFxuICAgICAgICAgICAgICAgICAgICBzY2FsZSA9IGN1cnJlbnRTY2FsZSA9IDE7XG4gICAgICAgICAgICAgICAgICAgIGdlc3R1cmVJbWdXcmFwLnRyYW5zaXRpb24oMzAwKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDAsMCwwKScpO1xuICAgICAgICAgICAgICAgICAgICBnZXN0dXJlSW1nLnRyYW5zaXRpb24oMzAwKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDAsMCwwKSBzY2FsZSgxKScpO1xuICAgICAgICAgICAgICAgICAgICBnZXN0dXJlU2xpZGUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBab29tIEluXG4gICAgICAgICAgICAgICAgICAgIHNjYWxlID0gY3VycmVudFNjYWxlID0gcGIucGFyYW1zLm1heFpvb207XG4gICAgICAgICAgICAgICAgICAgIGlmIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXRYID0gcGIuY29udGFpbmVyLm9mZnNldCgpLmxlZnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXRZID0gcGIuY29udGFpbmVyLm9mZnNldCgpLnRvcDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpZmZYID0gb2Zmc2V0WCArIHBiLmNvbnRhaW5lclswXS5vZmZzZXRXaWR0aC8yIC0gdG91Y2hYO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGlmZlkgPSBvZmZzZXRZICsgcGIuY29udGFpbmVyWzBdLm9mZnNldEhlaWdodC8yIC0gdG91Y2hZO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlV2lkdGggPSBnZXN0dXJlSW1nWzBdLm9mZnNldFdpZHRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VIZWlnaHQgPSBnZXN0dXJlSW1nWzBdLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlZFdpZHRoID0gaW1hZ2VXaWR0aCAqIHNjYWxlO1xuICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGVkSGVpZ2h0ID0gaW1hZ2VIZWlnaHQgKiBzY2FsZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGVNaW5YID0gTWF0aC5taW4oKHBiLnN3aXBlci53aWR0aCAvIDIgLSBzY2FsZWRXaWR0aCAvIDIpLCAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZU1pblkgPSBNYXRoLm1pbigocGIuc3dpcGVyLmhlaWdodCAvIDIgLSBzY2FsZWRIZWlnaHQgLyAyKSwgMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGVNYXhYID0gLXRyYW5zbGF0ZU1pblg7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGVNYXhZID0gLXRyYW5zbGF0ZU1pblk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlWCA9IGRpZmZYICogc2NhbGU7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGVZID0gZGlmZlkgKiBzY2FsZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZVggPCB0cmFuc2xhdGVNaW5YKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlWCA9ICB0cmFuc2xhdGVNaW5YO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZVggPiB0cmFuc2xhdGVNYXhYKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlWCA9IHRyYW5zbGF0ZU1heFg7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGVZIDwgdHJhbnNsYXRlTWluWSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZVkgPSAgdHJhbnNsYXRlTWluWTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGVZID4gdHJhbnNsYXRlTWF4WSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZVkgPSB0cmFuc2xhdGVNYXhZO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlWCA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGVZID0gMDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBnZXN0dXJlSW1nV3JhcC50cmFuc2l0aW9uKDMwMCkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgdHJhbnNsYXRlWCArICdweCwgJyArIHRyYW5zbGF0ZVkgKyAncHgsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgZ2VzdHVyZUltZy50cmFuc2l0aW9uKDMwMCkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLDAsMCkgc2NhbGUoJyArIHNjYWxlICsgJyknKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBpbWFnZUlzVG91Y2hlZCwgaW1hZ2VJc01vdmVkLCBpbWFnZUN1cnJlbnRYLCBpbWFnZUN1cnJlbnRZLCBpbWFnZU1pblgsIGltYWdlTWluWSwgaW1hZ2VNYXhYLCBpbWFnZU1heFksIGltYWdlV2lkdGgsIGltYWdlSGVpZ2h0LCBpbWFnZVRvdWNoZXNTdGFydCA9IHt9LCBpbWFnZVRvdWNoZXNDdXJyZW50ID0ge30sIGltYWdlU3RhcnRYLCBpbWFnZVN0YXJ0WSwgdmVsb2NpdHlQcmV2UG9zaXRpb25YLCB2ZWxvY2l0eVByZXZUaW1lLCB2ZWxvY2l0eVgsIHZlbG9jaXR5UHJldlBvc2l0aW9uWSwgdmVsb2NpdHlZO1xuICAgICAgICBcbiAgICAgICAgICAgIHBiLm9uU2xpZGVUb3VjaFN0YXJ0ID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWdlc3R1cmVJbWcgfHwgZ2VzdHVyZUltZy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAoaW1hZ2VJc1RvdWNoZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5vcyA9PT0gJ2FuZHJvaWQnKSBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgaW1hZ2VJc1RvdWNoZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGltYWdlVG91Y2hlc1N0YXJ0LnggPSBlLnR5cGUgPT09ICd0b3VjaHN0YXJ0JyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGUucGFnZVg7XG4gICAgICAgICAgICAgICAgaW1hZ2VUb3VjaGVzU3RhcnQueSA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwYi5vblNsaWRlVG91Y2hNb3ZlID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWdlc3R1cmVJbWcgfHwgZ2VzdHVyZUltZy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICBwYi5zd2lwZXIuYWxsb3dDbGljayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmICghaW1hZ2VJc1RvdWNoZWQgfHwgIWdlc3R1cmVTbGlkZSkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIWltYWdlSXNNb3ZlZCkge1xuICAgICAgICAgICAgICAgICAgICBpbWFnZVdpZHRoID0gZ2VzdHVyZUltZ1swXS5vZmZzZXRXaWR0aDtcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2VIZWlnaHQgPSBnZXN0dXJlSW1nWzBdLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2VTdGFydFggPSAkLmdldFRyYW5zbGF0ZShnZXN0dXJlSW1nV3JhcFswXSwgJ3gnKSB8fCAwO1xuICAgICAgICAgICAgICAgICAgICBpbWFnZVN0YXJ0WSA9ICQuZ2V0VHJhbnNsYXRlKGdlc3R1cmVJbWdXcmFwWzBdLCAneScpIHx8IDA7XG4gICAgICAgICAgICAgICAgICAgIGdlc3R1cmVJbWdXcmFwLnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIERlZmluZSBpZiB3ZSBuZWVkIGltYWdlIGRyYWdcbiAgICAgICAgICAgICAgICB2YXIgc2NhbGVkV2lkdGggPSBpbWFnZVdpZHRoICogc2NhbGU7XG4gICAgICAgICAgICAgICAgdmFyIHNjYWxlZEhlaWdodCA9IGltYWdlSGVpZ2h0ICogc2NhbGU7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChzY2FsZWRXaWR0aCA8IHBiLnN3aXBlci53aWR0aCAmJiBzY2FsZWRIZWlnaHQgPCBwYi5zd2lwZXIuaGVpZ2h0KSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGltYWdlTWluWCA9IE1hdGgubWluKChwYi5zd2lwZXIud2lkdGggLyAyIC0gc2NhbGVkV2lkdGggLyAyKSwgMCk7XG4gICAgICAgICAgICAgICAgaW1hZ2VNYXhYID0gLWltYWdlTWluWDtcbiAgICAgICAgICAgICAgICBpbWFnZU1pblkgPSBNYXRoLm1pbigocGIuc3dpcGVyLmhlaWdodCAvIDIgLSBzY2FsZWRIZWlnaHQgLyAyKSwgMCk7XG4gICAgICAgICAgICAgICAgaW1hZ2VNYXhZID0gLWltYWdlTWluWTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpbWFnZVRvdWNoZXNDdXJyZW50LnggPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZS5wYWdlWDtcbiAgICAgICAgICAgICAgICBpbWFnZVRvdWNoZXNDdXJyZW50LnkgPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCFpbWFnZUlzTW92ZWQgJiYgIWlzU2NhbGluZykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgICAgICAoTWF0aC5mbG9vcihpbWFnZU1pblgpID09PSBNYXRoLmZsb29yKGltYWdlU3RhcnRYKSAmJiBpbWFnZVRvdWNoZXNDdXJyZW50LnggPCBpbWFnZVRvdWNoZXNTdGFydC54KSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgKE1hdGguZmxvb3IoaW1hZ2VNYXhYKSA9PT0gTWF0aC5mbG9vcihpbWFnZVN0YXJ0WCkgJiYgaW1hZ2VUb3VjaGVzQ3VycmVudC54ID4gaW1hZ2VUb3VjaGVzU3RhcnQueClcbiAgICAgICAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2VJc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICBpbWFnZUlzTW92ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGltYWdlQ3VycmVudFggPSBpbWFnZVRvdWNoZXNDdXJyZW50LnggLSBpbWFnZVRvdWNoZXNTdGFydC54ICsgaW1hZ2VTdGFydFg7XG4gICAgICAgICAgICAgICAgaW1hZ2VDdXJyZW50WSA9IGltYWdlVG91Y2hlc0N1cnJlbnQueSAtIGltYWdlVG91Y2hlc1N0YXJ0LnkgKyBpbWFnZVN0YXJ0WTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoaW1hZ2VDdXJyZW50WCA8IGltYWdlTWluWCkge1xuICAgICAgICAgICAgICAgICAgICBpbWFnZUN1cnJlbnRYID0gIGltYWdlTWluWCArIDEgLSBNYXRoLnBvdygoaW1hZ2VNaW5YIC0gaW1hZ2VDdXJyZW50WCArIDEpLCAwLjgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaW1hZ2VDdXJyZW50WCA+IGltYWdlTWF4WCkge1xuICAgICAgICAgICAgICAgICAgICBpbWFnZUN1cnJlbnRYID0gaW1hZ2VNYXhYIC0gMSArIE1hdGgucG93KChpbWFnZUN1cnJlbnRYIC0gaW1hZ2VNYXhYICsgMSksIDAuOCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChpbWFnZUN1cnJlbnRZIDwgaW1hZ2VNaW5ZKSB7XG4gICAgICAgICAgICAgICAgICAgIGltYWdlQ3VycmVudFkgPSAgaW1hZ2VNaW5ZICsgMSAtIE1hdGgucG93KChpbWFnZU1pblkgLSBpbWFnZUN1cnJlbnRZICsgMSksIDAuOCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChpbWFnZUN1cnJlbnRZID4gaW1hZ2VNYXhZKSB7XG4gICAgICAgICAgICAgICAgICAgIGltYWdlQ3VycmVudFkgPSBpbWFnZU1heFkgLSAxICsgTWF0aC5wb3coKGltYWdlQ3VycmVudFkgLSBpbWFnZU1heFkgKyAxKSwgMC44KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vVmVsb2NpdHlcbiAgICAgICAgICAgICAgICBpZiAoIXZlbG9jaXR5UHJldlBvc2l0aW9uWCkgdmVsb2NpdHlQcmV2UG9zaXRpb25YID0gaW1hZ2VUb3VjaGVzQ3VycmVudC54O1xuICAgICAgICAgICAgICAgIGlmICghdmVsb2NpdHlQcmV2UG9zaXRpb25ZKSB2ZWxvY2l0eVByZXZQb3NpdGlvblkgPSBpbWFnZVRvdWNoZXNDdXJyZW50Lnk7XG4gICAgICAgICAgICAgICAgaWYgKCF2ZWxvY2l0eVByZXZUaW1lKSB2ZWxvY2l0eVByZXZUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICAgICAgICB2ZWxvY2l0eVggPSAoaW1hZ2VUb3VjaGVzQ3VycmVudC54IC0gdmVsb2NpdHlQcmV2UG9zaXRpb25YKSAvIChEYXRlLm5vdygpIC0gdmVsb2NpdHlQcmV2VGltZSkgLyAyO1xuICAgICAgICAgICAgICAgIHZlbG9jaXR5WSA9IChpbWFnZVRvdWNoZXNDdXJyZW50LnkgLSB2ZWxvY2l0eVByZXZQb3NpdGlvblkpIC8gKERhdGUubm93KCkgLSB2ZWxvY2l0eVByZXZUaW1lKSAvIDI7XG4gICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKGltYWdlVG91Y2hlc0N1cnJlbnQueCAtIHZlbG9jaXR5UHJldlBvc2l0aW9uWCkgPCAyKSB2ZWxvY2l0eVggPSAwO1xuICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhpbWFnZVRvdWNoZXNDdXJyZW50LnkgLSB2ZWxvY2l0eVByZXZQb3NpdGlvblkpIDwgMikgdmVsb2NpdHlZID0gMDtcbiAgICAgICAgICAgICAgICB2ZWxvY2l0eVByZXZQb3NpdGlvblggPSBpbWFnZVRvdWNoZXNDdXJyZW50Lng7XG4gICAgICAgICAgICAgICAgdmVsb2NpdHlQcmV2UG9zaXRpb25ZID0gaW1hZ2VUb3VjaGVzQ3VycmVudC55O1xuICAgICAgICAgICAgICAgIHZlbG9jaXR5UHJldlRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBnZXN0dXJlSW1nV3JhcC50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyBpbWFnZUN1cnJlbnRYICsgJ3B4LCAnICsgaW1hZ2VDdXJyZW50WSArICdweCwwKScpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBiLm9uU2xpZGVUb3VjaEVuZCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFnZXN0dXJlSW1nIHx8IGdlc3R1cmVJbWcubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKCFpbWFnZUlzVG91Y2hlZCB8fCAhaW1hZ2VJc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIGltYWdlSXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGltYWdlSXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGltYWdlSXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaW1hZ2VJc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdmFyIG1vbWVudHVtRHVyYXRpb25YID0gMzAwO1xuICAgICAgICAgICAgICAgIHZhciBtb21lbnR1bUR1cmF0aW9uWSA9IDMwMDtcbiAgICAgICAgICAgICAgICB2YXIgbW9tZW50dW1EaXN0YW5jZVggPSB2ZWxvY2l0eVggKiBtb21lbnR1bUR1cmF0aW9uWDtcbiAgICAgICAgICAgICAgICB2YXIgbmV3UG9zaXRpb25YID0gaW1hZ2VDdXJyZW50WCArIG1vbWVudHVtRGlzdGFuY2VYO1xuICAgICAgICAgICAgICAgIHZhciBtb21lbnR1bURpc3RhbmNlWSA9IHZlbG9jaXR5WSAqIG1vbWVudHVtRHVyYXRpb25ZO1xuICAgICAgICAgICAgICAgIHZhciBuZXdQb3NpdGlvblkgPSBpbWFnZUN1cnJlbnRZICsgbW9tZW50dW1EaXN0YW5jZVk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vRml4IGR1cmF0aW9uXG4gICAgICAgICAgICAgICAgaWYgKHZlbG9jaXR5WCAhPT0gMCkgbW9tZW50dW1EdXJhdGlvblggPSBNYXRoLmFicygobmV3UG9zaXRpb25YIC0gaW1hZ2VDdXJyZW50WCkgLyB2ZWxvY2l0eVgpO1xuICAgICAgICAgICAgICAgIGlmICh2ZWxvY2l0eVkgIT09IDApIG1vbWVudHVtRHVyYXRpb25ZID0gTWF0aC5hYnMoKG5ld1Bvc2l0aW9uWSAtIGltYWdlQ3VycmVudFkpIC8gdmVsb2NpdHlZKTtcbiAgICAgICAgICAgICAgICB2YXIgbW9tZW50dW1EdXJhdGlvbiA9IE1hdGgubWF4KG1vbWVudHVtRHVyYXRpb25YLCBtb21lbnR1bUR1cmF0aW9uWSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGltYWdlQ3VycmVudFggPSBuZXdQb3NpdGlvblg7XG4gICAgICAgICAgICAgICAgaW1hZ2VDdXJyZW50WSA9IG5ld1Bvc2l0aW9uWTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gRGVmaW5lIGlmIHdlIG5lZWQgaW1hZ2UgZHJhZ1xuICAgICAgICAgICAgICAgIHZhciBzY2FsZWRXaWR0aCA9IGltYWdlV2lkdGggKiBzY2FsZTtcbiAgICAgICAgICAgICAgICB2YXIgc2NhbGVkSGVpZ2h0ID0gaW1hZ2VIZWlnaHQgKiBzY2FsZTtcbiAgICAgICAgICAgICAgICBpbWFnZU1pblggPSBNYXRoLm1pbigocGIuc3dpcGVyLndpZHRoIC8gMiAtIHNjYWxlZFdpZHRoIC8gMiksIDApO1xuICAgICAgICAgICAgICAgIGltYWdlTWF4WCA9IC1pbWFnZU1pblg7XG4gICAgICAgICAgICAgICAgaW1hZ2VNaW5ZID0gTWF0aC5taW4oKHBiLnN3aXBlci5oZWlnaHQgLyAyIC0gc2NhbGVkSGVpZ2h0IC8gMiksIDApO1xuICAgICAgICAgICAgICAgIGltYWdlTWF4WSA9IC1pbWFnZU1pblk7XG4gICAgICAgICAgICAgICAgaW1hZ2VDdXJyZW50WCA9IE1hdGgubWF4KE1hdGgubWluKGltYWdlQ3VycmVudFgsIGltYWdlTWF4WCksIGltYWdlTWluWCk7XG4gICAgICAgICAgICAgICAgaW1hZ2VDdXJyZW50WSA9IE1hdGgubWF4KE1hdGgubWluKGltYWdlQ3VycmVudFksIGltYWdlTWF4WSksIGltYWdlTWluWSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGdlc3R1cmVJbWdXcmFwLnRyYW5zaXRpb24obW9tZW50dW1EdXJhdGlvbikudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgaW1hZ2VDdXJyZW50WCArICdweCwgJyArIGltYWdlQ3VycmVudFkgKyAncHgsMCknKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU3dpcGUgVXAgVG8gQ2xvc2VcbiAgICAgICAgICAgIHZhciBzd2lwZVRvQ2xvc2VJc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHZhciBhbGxvd1N3aXBlVG9DbG9zZSA9IHRydWU7XG4gICAgICAgICAgICB2YXIgc3dpcGVUb0Nsb3NlRGlmZiwgc3dpcGVUb0Nsb3NlU3RhcnQsIHN3aXBlVG9DbG9zZUN1cnJlbnQsIHN3aXBlVG9DbG9zZVN0YXJ0ZWQgPSBmYWxzZSwgc3dpcGVUb0Nsb3NlQWN0aXZlU2xpZGUsIHN3aXBlVG9DbG9zZVRpbWVTdGFydDtcbiAgICAgICAgICAgIHBiLnN3aXBlQ2xvc2VUb3VjaFN0YXJ0ID0gZnVuY3Rpb24gKHN3aXBlciwgZSkge1xuICAgICAgICAgICAgICAgIGlmICghYWxsb3dTd2lwZVRvQ2xvc2UpIHJldHVybjtcbiAgICAgICAgICAgICAgICBzd2lwZVRvQ2xvc2VJc1RvdWNoZWQgPSB0cnVlO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBiLnN3aXBlQ2xvc2VUb3VjaE1vdmUgPSBmdW5jdGlvbiAoc3dpcGVyLCBlKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzd2lwZVRvQ2xvc2VJc1RvdWNoZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAoIXN3aXBlVG9DbG9zZVN0YXJ0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgc3dpcGVUb0Nsb3NlU3RhcnRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHN3aXBlVG9DbG9zZVN0YXJ0ID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgICAgICAgICAgICAgIHN3aXBlVG9DbG9zZUFjdGl2ZVNsaWRlID0gcGIuc3dpcGVyLnNsaWRlcy5lcShwYi5zd2lwZXIuYWN0aXZlSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICBzd2lwZVRvQ2xvc2VUaW1lU3RhcnQgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgc3dpcGVUb0Nsb3NlQ3VycmVudCA9IGUudHlwZSA9PT0gJ3RvdWNobW92ZScgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgOiBlLnBhZ2VZO1xuICAgICAgICAgICAgICAgIHN3aXBlVG9DbG9zZURpZmYgPSBzd2lwZVRvQ2xvc2VTdGFydCAtIHN3aXBlVG9DbG9zZUN1cnJlbnQ7XG4gICAgICAgICAgICAgICAgdmFyIG9wYWNpdHkgPSAxIC0gTWF0aC5hYnMoc3dpcGVUb0Nsb3NlRGlmZikgLyAzMDA7XG4gICAgICAgICAgICAgICAgc3dpcGVUb0Nsb3NlQWN0aXZlU2xpZGUudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLCcgKyAoLXN3aXBlVG9DbG9zZURpZmYpICsgJ3B4LDApJyk7XG4gICAgICAgICAgICAgICAgcGIuc3dpcGVyLmNvbnRhaW5lci5jc3MoJ29wYWNpdHknLCBvcGFjaXR5KS50cmFuc2l0aW9uKDApO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHBiLnN3aXBlQ2xvc2VUb3VjaEVuZCA9IGZ1bmN0aW9uIChzd2lwZXIsIGUpIHtcbiAgICAgICAgICAgICAgICBzd2lwZVRvQ2xvc2VJc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAoIXN3aXBlVG9DbG9zZVN0YXJ0ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgc3dpcGVUb0Nsb3NlU3RhcnRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN3aXBlVG9DbG9zZVN0YXJ0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBhbGxvd1N3aXBlVG9DbG9zZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZhciBkaWZmID0gTWF0aC5hYnMoc3dpcGVUb0Nsb3NlRGlmZik7XG4gICAgICAgICAgICAgICAgdmFyIHRpbWVEaWZmID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKSAtIHN3aXBlVG9DbG9zZVRpbWVTdGFydDtcbiAgICAgICAgICAgICAgICBpZiAoKHRpbWVEaWZmIDwgMzAwICYmIGRpZmYgPiAyMCkgfHwgKHRpbWVEaWZmID49IDMwMCAmJiBkaWZmID4gMTAwKSkge1xuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMudHlwZSA9PT0gJ3N0YW5kYWxvbmUnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGIuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMudHlwZSA9PT0gJ3BvcHVwJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKHBiLnBvcHVwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYi5wYXJhbXMub25Td2lwZVRvQ2xvc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYi5wYXJhbXMub25Td2lwZVRvQ2xvc2UocGIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYWxsb3dTd2lwZVRvQ2xvc2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZGlmZiAhPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBzd2lwZVRvQ2xvc2VBY3RpdmVTbGlkZS5hZGRDbGFzcygndHJhbnNpdGlvbmluZycpLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWxsb3dTd2lwZVRvQ2xvc2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3dpcGVUb0Nsb3NlQWN0aXZlU2xpZGUucmVtb3ZlQ2xhc3MoJ3RyYW5zaXRpb25pbmcnKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhbGxvd1N3aXBlVG9DbG9zZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHBiLnN3aXBlci5jb250YWluZXIuY3NzKCdvcGFjaXR5JywgJycpLnRyYW5zaXRpb24oJycpO1xuICAgICAgICAgICAgICAgIHN3aXBlVG9DbG9zZUFjdGl2ZVNsaWRlLnRyYW5zZm9ybSgnJyk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBwYjtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGFwcC5waG90b0Jyb3dzZXIgPSBmdW5jdGlvbiAocGFyYW1zKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFBob3RvQnJvd3NlcihwYXJhbXMpO1xuICAgICAgICB9O1xuICAgICAgICBcblxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgQXV0b2NvbXBsZXRlICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICB2YXIgQXV0b2NvbXBsZXRlID0gZnVuY3Rpb24gKHBhcmFtcykge1xuICAgICAgICAgICAgdmFyIGEgPSB0aGlzO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBhcmFtc1xuICAgICAgICAgICAgdmFyIGRlZmF1bHRzID0ge1xuICAgICAgICAgICAgICAgIC8vIFN0YW5kYWxvbmUgT3B0aW9uc1xuICAgICAgICAgICAgICAgIC8qXG4gICAgICAgICAgICAgICAgb3BlbmVyOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICBwb3B1cENsb3NlVGV4dDogJ0Nsb3NlJyxcbiAgICAgICAgICAgICAgICBiYWNrVGV4dDogJ0JhY2snLFxuICAgICAgICAgICAgICAgIHNlYXJjaGJhclBsYWNlaG9sZGVyVGV4dDogJ1NlYXJjaC4uLicsXG4gICAgICAgICAgICAgICAgc2VhcmNoYmFyQ2FuY2VsVGV4dDogJ0NhbmNlbCcsXG4gICAgICAgICAgICAgICAgb3BlbkluOiAncGFnZScsXG4gICAgICAgICAgICAgICAgYmFja09uU2VsZWN0OiBmYWxzZSxcbiAgICAgICAgICAgICAgICBub3RGb3VuZFRleHQ6ICdOb3RoaW5nIGZvdW5kJyxcbiAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgIHBhZ2VUaXRsZTogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICovXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIEhhbmRsZSBEYXRhXG4gICAgICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICBzb3VyY2U6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBsaW1pdDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgdmFsdWVQcm9wZXJ0eTogJ2lkJyxcbiAgICAgICAgICAgICAgICB0ZXh0UHJvcGVydHk6ICd0ZXh0JyxcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gRHJvcGRvd24gT3B0aW9uc1xuICAgICAgICAgICAgICAgIC8qXG4gICAgICAgICAgICAgICAgZHJvcGRvd25QbGFjZWhvbGRlclRleHQ6ICdUeXBlIGFueXRoaW5nLi4uJyxcbiAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIHVwZGF0ZUlucHV0VmFsdWVPblNlbGVjdDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBleHBhbmRJbnB1dDogZmFsc2UsXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFByZWxvYWRlclxuICAgICAgICAgICAgICAgIHByZWxvYWRlckNvbG9yOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBwcmVsb2FkZXI6IGZhbHNlLFxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBUZW1wbGF0ZXNcbiAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgIGl0ZW1UZW1wbGF0ZTogdW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgIG5hdmJhclRlbXBsYXRlOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAgICAgZHJvcGRvd25UZW1wbGF0ZTogdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgZHJvcGRvd25JdGVtVGVtcGxhdGU6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBkcm9wZG93blBsYWNlaG9sZGVyVGVtcGxhdGU6IHVuZGVmaW5lZFxuICAgICAgICAgICAgICAgICovXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIENvbG9yIHRoZW1lc1xuICAgICAgICAgICAgICAgIC8qXG4gICAgICAgICAgICAgICAgbmF2YmFyVGhlbWU6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICBmb3JtVGhlbWU6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgICAgICAqL1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBDYWxsYmFja3NcbiAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgIG9uQ2hhbmdlOiBmdW5jdGlvbiAoYSwgdmFsdWUpIC0gZm9yIG5vdCBkcm9wZG93blxuICAgICAgICAgICAgICAgIG9uT3BlbjogZnVuY3Rpb24gKGEpXG4gICAgICAgICAgICAgICAgb25DbG9zZTogZnVuY3Rpb24gKGEpXG4gICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xuICAgICAgICAgICAgZm9yICh2YXIgZGVmIGluIGRlZmF1bHRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXNbZGVmXSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zW2RlZl0gPSBkZWZhdWx0c1tkZWZdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGEucGFyYW1zID0gcGFyYW1zO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIE9wZW5lciBMaW5rICYgVmlld1xuICAgICAgICAgICAgaWYgKGEucGFyYW1zLm9wZW5lcikge1xuICAgICAgICAgICAgICAgIGEub3BlbmVyID0gJChhLnBhcmFtcy5vcGVuZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHZpZXcgPSBhLnBhcmFtcy52aWV3O1xuICAgICAgICAgICAgaWYgKCFhLnBhcmFtcy52aWV3ICYmIGEub3BlbmVyICYmIGEub3BlbmVyLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIC8vIEZpbmQgcmVsYXRlZCB2aWV3XG4gICAgICAgICAgICAgICAgdmlldyA9IGEub3BlbmVyLnBhcmVudHMoJy4nICsgYXBwLnBhcmFtcy52aWV3Q2xhc3MpO1xuICAgICAgICAgICAgICAgIGlmICh2aWV3Lmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHZpZXcgPSB2aWV3WzBdLmY3VmlldztcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbnB1dFxuICAgICAgICAgICAgaWYgKGEucGFyYW1zLmlucHV0KSB7XG4gICAgICAgICAgICAgICAgYS5pbnB1dCA9ICQoYS5wYXJhbXMuaW5wdXQpO1xuICAgICAgICAgICAgICAgIGlmIChhLmlucHV0Lmxlbmd0aCA9PT0gMCAmJiBhLnBhcmFtcy5vcGVuSW4gPT09ICdkcm9wZG93bicpIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBBcnJheSB3aXRoIHNlbGVjdGVkIGl0ZW1zXG4gICAgICAgICAgICBhLnZhbHVlID0gYS5wYXJhbXMudmFsdWUgfHwgW107XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSUQgJiBJbnB1dHNcbiAgICAgICAgICAgIGEuaWQgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgYS5pbnB1dFR5cGUgPSBhLnBhcmFtcy5tdWx0aXBsZSA/ICdjaGVja2JveCcgOiAncmFkaW8nO1xuICAgICAgICAgICAgYS5pbnB1dE5hbWUgPSBhLmlucHV0VHlwZSArICctJyArIGEuaWQ7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSXMgTWF0ZXJpYWxcbiAgICAgICAgICAgIHZhciBtYXRlcmlhbCA9IGFwcC5wYXJhbXMubWF0ZXJpYWw7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQmFjayBPbiBTZWxlY3RcbiAgICAgICAgICAgIHZhciBiYWNrT25TZWxlY3QgPSBhLnBhcmFtcy5iYWNrT25TZWxlY3Q7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKGEucGFyYW1zLm9wZW5JbiAhPT0gJ2Ryb3Bkb3duJykge1xuICAgICAgICAgICAgICAgIC8vIEl0ZW0gVGVtcGxhdGVcbiAgICAgICAgICAgICAgICBhLml0ZW1UZW1wbGF0ZSA9IHQ3LmNvbXBpbGUoYS5wYXJhbXMuaXRlbVRlbXBsYXRlIHx8XG4gICAgICAgICAgICAgICAgICAgICc8bGk+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGxhYmVsIGNsYXNzPVwibGFiZWwte3tpbnB1dFR5cGV9fSBpdGVtLWNvbnRlbnRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGlucHV0IHR5cGU9XCJ7e2lucHV0VHlwZX19XCIgbmFtZT1cInt7aW5wdXROYW1lfX1cIiB2YWx1ZT1cInt7dmFsdWV9fVwiIHt7I2lmIHNlbGVjdGVkfX1jaGVja2Vke3svaWZ9fT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgbWF0ZXJpYWx9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tbWVkaWFcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8aSBjbGFzcz1cImljb24gaWNvbi1mb3JtLXt7aW5wdXRUeXBlfX1cIj48L2k+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tdGl0bGVcIj57e3RleHR9fTwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7ZWxzZX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBjaGVja2JveH19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1tZWRpYVwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxpIGNsYXNzPVwiaWNvbiBpY29uLWZvcm0tY2hlY2tib3hcIj48L2k+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tdGl0bGVcIj57e3RleHR9fTwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8L2xhYmVsPicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9saT4nXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAvLyBQYWdlIExheW91dFxuICAgICAgICAgICAgICAgIHZhciBwYWdlVGl0bGUgPSBhLnBhcmFtcy5wYWdlVGl0bGUgfHwgJyc7XG4gICAgICAgICAgICAgICAgaWYgKCFwYWdlVGl0bGUgJiYgYS5vcGVuZXIgJiYgYS5vcGVuZXIubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhZ2VUaXRsZSA9IGEub3BlbmVyLmZpbmQoJy5pdGVtLXRpdGxlJykudGV4dCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgcGFnZU5hbWUgPSAnYXV0b2NvbXBsZXRlLScgKyBhLmlucHV0TmFtZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIG5hdmJhclRoZW1lID0gYS5wYXJhbXMubmF2YmFyVGhlbWUsXG4gICAgICAgICAgICAgICAgICAgIGZvcm1UaGVtZSA9IGEucGFyYW1zLmZvcm1UaGVtZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gTmF2YmFyIEhUTUxcbiAgICAgICAgICAgICAgICB2YXIgbmF2YmFySFRNTDtcbiAgICAgICAgICAgICAgICB2YXIgbm9OYXZiYXIgPSAnJywgbm9Ub29sYmFyID0gJycsIG5hdmJhckxheW91dDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgYS5uYXZiYXJUZW1wbGF0ZSA9IHQ3LmNvbXBpbGUoYS5wYXJhbXMubmF2YmFyVGVtcGxhdGUgfHxcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJuYXZiYXIge3sjaWYgbmF2YmFyVGhlbWV9fXRoZW1lLXt7bmF2YmFyVGhlbWV9fXt7L2lmfX1cIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibmF2YmFyLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJsZWZ0IHNsaWRpbmdcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIG1hdGVyaWFsfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxhIGhyZWY9XCIjXCIgY2xhc3M9XCJsaW5rIHt7I2lmIGluUG9wdXB9fWNsb3NlLXBvcHVwe3tlbHNlfX1iYWNre3svaWZ9fSBpY29uLW9ubHlcIj48aSBjbGFzcz1cImljb24gaWNvbi1iYWNrXCI+PC9pPjwvYT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7ZWxzZX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8YSBocmVmPVwiI1wiIGNsYXNzPVwibGluayB7eyNpZiBpblBvcHVwfX1jbG9zZS1wb3B1cHt7ZWxzZX19YmFja3t7L2lmfX1cIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8aSBjbGFzcz1cImljb24gaWNvbi1iYWNrXCI+PC9pPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIGluUG9wdXB9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzcGFuPnt7cG9wdXBDbG9zZVRleHR9fTwvc3Bhbj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7e2Vsc2V9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxzcGFuPnt7YmFja1RleHR9fTwvc3Bhbj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2E+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiY2VudGVyIHNsaWRpbmdcIj57e3BhZ2VUaXRsZX19PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIHByZWxvYWRlcn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJyaWdodFwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImF1dG9jb21wbGV0ZS1wcmVsb2FkZXIgcHJlbG9hZGVyIHt7I2lmIHByZWxvYWRlckNvbG9yfX1wcmVsb2FkZXIte3twcmVsb2FkZXJDb2xvcn19e3svaWZ9fVwiPjwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+J1xuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgbmF2YmFySFRNTCA9IGEubmF2YmFyVGVtcGxhdGUoe1xuICAgICAgICAgICAgICAgICAgICBwYWdlVGl0bGU6IHBhZ2VUaXRsZSxcbiAgICAgICAgICAgICAgICAgICAgYmFja1RleHQ6IGEucGFyYW1zLmJhY2tUZXh0LFxuICAgICAgICAgICAgICAgICAgICBwb3B1cENsb3NlVGV4dDogYS5wYXJhbXMucG9wdXBDbG9zZVRleHQsXG4gICAgICAgICAgICAgICAgICAgIG9wZW5JbjogYS5wYXJhbXMub3BlbkluLFxuICAgICAgICAgICAgICAgICAgICBuYXZiYXJUaGVtZTogbmF2YmFyVGhlbWUsXG4gICAgICAgICAgICAgICAgICAgIGluUG9wdXA6IGEucGFyYW1zLm9wZW5JbiA9PT0gJ3BvcHVwJyxcbiAgICAgICAgICAgICAgICAgICAgaW5QYWdlOiBhLnBhcmFtcy5vcGVuSW4gPT09ICdwYWdlJyxcbiAgICAgICAgICAgICAgICAgICAgbWF0ZXJpYWw6IG1hdGVyaWFsLFxuICAgICAgICAgICAgICAgICAgICBwcmVsb2FkZXI6IGEucGFyYW1zLnByZWxvYWRlcixcbiAgICAgICAgICAgICAgICAgICAgcHJlbG9hZGVyQ29sb3I6IGEucGFyYW1zLnByZWxvYWRlckNvbG9yLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBEZXRlcm1pbmUgbmF2YmFyIGxheW91dCB0eXBlIC0gc3RhdGljL2ZpeGVkL3Rocm91Z2hcbiAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub3BlbkluID09PSAncGFnZScpIHtcbiAgICAgICAgICAgICAgICAgICAgbmF2YmFyTGF5b3V0ID0gJ3N0YXRpYyc7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhLm9wZW5lcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGEub3BlbmVyLnBhcmVudHMoJy5uYXZiYXItdGhyb3VnaCcpLmxlbmd0aCA+IDApIG5hdmJhckxheW91dCA9ICd0aHJvdWdoJztcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhLm9wZW5lci5wYXJlbnRzKCcubmF2YmFyLWZpeGVkJykubGVuZ3RoID4gMCkgbmF2YmFyTGF5b3V0ID0gJ2ZpeGVkJztcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vVG9vbGJhciA9IGEub3BlbmVyLnBhcmVudHMoJy5wYWdlJykuaGFzQ2xhc3MoJ25vLXRvb2xiYXInKSA/ICduby10b29sYmFyJyA6ICcnO1xuICAgICAgICAgICAgICAgICAgICAgICAgbm9OYXZiYXIgID0gYS5vcGVuZXIucGFyZW50cygnLnBhZ2UnKS5oYXNDbGFzcygnbm8tbmF2YmFyJykgID8gJ25vLW5hdmJhcicgIDogJ25hdmJhci0nICsgbmF2YmFyTGF5b3V0O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHZpZXcuY29udGFpbmVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCh2aWV3LmNvbnRhaW5lcikuaGFzQ2xhc3MoJ25hdmJhci10aHJvdWdoJykgfHwgJCh2aWV3LmNvbnRhaW5lcikuZmluZCgnLm5hdmJhci10aHJvdWdoJykubGVuZ3RoID4gMCkgbmF2YmFyTGF5b3V0ID0gJ3Rocm91Z2gnO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQodmlldy5jb250YWluZXIpLmhhc0NsYXNzKCduYXZiYXItZml4ZWQnKSB8fCAkKHZpZXcuY29udGFpbmVyKS5maW5kKCcubmF2YmFyLWZpeGVkJykubGVuZ3RoID4gMCkgbmF2YmFyTGF5b3V0ID0gJ2ZpeGVkJztcbiAgICAgICAgICAgICAgICAgICAgICAgIG5vVG9vbGJhciA9ICQodmlldy5hY3RpdmVQYWdlLmNvbnRhaW5lcikuaGFzQ2xhc3MoJ25vLXRvb2xiYXInKSA/ICduby10b29sYmFyJyA6ICcnO1xuICAgICAgICAgICAgICAgICAgICAgICAgbm9OYXZiYXIgID0gJCh2aWV3LmFjdGl2ZVBhZ2UuY29udGFpbmVyKS5oYXNDbGFzcygnbm8tbmF2YmFyJykgID8gJ25vLW5hdmJhcicgIDogJ25hdmJhci0nICsgbmF2YmFyTGF5b3V0O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBuYXZiYXJMYXlvdXQgPSAnZml4ZWQnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgc2VhcmNoYmFySFRNTCA9XG4gICAgICAgICAgICAgICAgICAgICc8Zm9ybSBjbGFzcz1cInNlYXJjaGJhclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJzZWFyY2hiYXItaW5wdXRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGlucHV0IHR5cGU9XCJzZWFyY2hcIiBwbGFjZWhvbGRlcj1cIicgKyBhLnBhcmFtcy5zZWFyY2hiYXJQbGFjZWhvbGRlclRleHQgKyAnXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxhIGhyZWY9XCIjXCIgY2xhc3M9XCJzZWFyY2hiYXItY2xlYXJcIj48L2E+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAobWF0ZXJpYWwgPyAnJyA6ICc8YSBocmVmPVwiI1wiIGNsYXNzPVwic2VhcmNoYmFyLWNhbmNlbFwiPicgKyBhLnBhcmFtcy5zZWFyY2hiYXJDYW5jZWxUZXh0ICsgJzwvYT4nKSArXG4gICAgICAgICAgICAgICAgICAgICc8L2Zvcm0+JyArXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwic2VhcmNoYmFyLW92ZXJsYXlcIj48L2Rpdj4nO1xuICAgICAgICAgICAgICAgIHZhciBwYWdlSFRNTCA9XG4gICAgICAgICAgICAgICAgICAgIChuYXZiYXJMYXlvdXQgPT09ICd0aHJvdWdoJyA/IG5hdmJhckhUTUwgOiAnJykgK1xuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBhZ2VzXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBkYXRhLXBhZ2U9XCInICsgcGFnZU5hbWUgKyAnXCIgY2xhc3M9XCJwYWdlIGF1dG9jb21wbGV0ZS1wYWdlICcgKyBub05hdmJhciArICcgJyArIG5vVG9vbGJhciArICdcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAobmF2YmFyTGF5b3V0ID09PSAnZml4ZWQnID8gbmF2YmFySFRNTCA6ICcnKSArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VhcmNoYmFySFRNTCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwYWdlLWNvbnRlbnRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKG5hdmJhckxheW91dCA9PT0gJ3N0YXRpYycgPyBuYXZiYXJIVE1MIDogJycpICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJsaXN0LWJsb2NrIGF1dG9jb21wbGV0ZS1mb3VuZCBhdXRvY29tcGxldGUtbGlzdC0nICsgYS5pZCArICcgJyArIChmb3JtVGhlbWUgPyAndGhlbWUtJyArIGZvcm1UaGVtZSA6ICcnKSArICdcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8dWw+PC91bD4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImxpc3QtYmxvY2sgYXV0b2NvbXBsZXRlLW5vdC1mb3VuZFwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzx1bD48bGkgY2xhc3M9XCJpdGVtLWNvbnRlbnRcIj48ZGl2IGNsYXNzPVwiaXRlbS1pbm5lclwiPjxkaXYgY2xhc3M9XCJpdGVtLXRpdGxlXCI+JyArIGEucGFyYW1zLm5vdEZvdW5kVGV4dCArICc8L2Rpdj48L2Rpdj48L2xpPjwvdWw+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJsaXN0LWJsb2NrIGF1dG9jb21wbGV0ZS12YWx1ZXNcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8dWw+PC91bD4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2Pic7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBhLmRyb3Bkb3duSXRlbVRlbXBsYXRlID0gdDcuY29tcGlsZShhLnBhcmFtcy5kcm9wZG93bkl0ZW1UZW1wbGF0ZSB8fFxuICAgICAgICAgICAgICAgICAgICAnPGxpPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxsYWJlbCBjbGFzcz1cInt7I3VubGVzcyBwbGFjZWhvbGRlcn19bGFiZWwtcmFkaW97ey91bmxlc3N9fSBpdGVtLWNvbnRlbnRcIiBkYXRhLXZhbHVlPVwie3t2YWx1ZX19XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS10aXRsZVwiPnt7dGV4dH19PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvbGFiZWw+JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2xpPidcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIGEuZHJvcGRvd25QbGFjZWhvbGRlclRlbXBsYXRlID0gdDcuY29tcGlsZShhLnBhcmFtcy5kcm9wZG93blBsYWNlaG9sZGVyVGVtcGxhdGUgfHxcbiAgICAgICAgICAgICAgICAgICAgJzxsaSBjbGFzcz1cImF1dG9jb21wbGV0ZS1kcm9wZG93bi1wbGFjZWhvbGRlclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLWNvbnRlbnRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0taW5uZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLXRpdGxlXCI+e3t0ZXh0fX08L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9sYWJlbD4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvbGk+J1xuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgYS5kcm9wZG93blRlbXBsYXRlID0gdDcuY29tcGlsZShhLnBhcmFtcy5kcm9wZG93blRlbXBsYXRlIHx8XG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiYXV0b2NvbXBsZXRlLWRyb3Bkb3duXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImF1dG9jb21wbGV0ZS1kcm9wZG93bi1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwibGlzdC1ibG9ja1wiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHVsPjwvdWw+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIHByZWxvYWRlcn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cImF1dG9jb21wbGV0ZS1wcmVsb2FkZXIgcHJlbG9hZGVyIHt7I2lmIHByZWxvYWRlckNvbG9yfX1wcmVsb2FkZXIte3twcmVsb2FkZXJDb2xvcn19e3svaWZ9fVwiPnt7I2lmIG1hdGVyaWFsfX17e21hdGVyaWFsUHJlbG9hZGVySHRtbH19e3svaWZ9fTwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PidcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIERlZmluZSBwb3B1cFxuICAgICAgICAgICAgYS5wb3B1cCA9IHVuZGVmaW5lZDtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBEZWZpbmUgRHJvcGRvd25cbiAgICAgICAgICAgIGEuZHJvcGRvd24gPSB1bmRlZmluZWQ7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSGFuZGxlIElucHV0IFZhbHVlIENoYW5nZVxuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlSW5wdXRWYWx1ZSAoZSkge1xuICAgICAgICAgICAgICAgIHZhciBxdWVyeSA9IGEuaW5wdXQudmFsKCk7XG4gICAgICAgICAgICAgICAgaWYgKGEucGFyYW1zLnNvdXJjZSkge1xuICAgICAgICAgICAgICAgICAgICBhLnBhcmFtcy5zb3VyY2UoYSwgcXVlcnksIGZ1bmN0aW9uIChpdGVtcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1zSFRNTCA9ICcnO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGxpbWl0ID0gYS5wYXJhbXMubGltaXQgPyBNYXRoLm1pbihhLnBhcmFtcy5saW1pdCwgaXRlbXMubGVuZ3RoKSA6IGl0ZW1zLmxlbmd0aDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGEuaXRlbXMgPSBpdGVtcztcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpLCBqO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlZ0V4cCA9IG5ldyBSZWdFeHAoJygnK3F1ZXJ5KycpJywgJ2knKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsaW1pdDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1WYWx1ZSA9IHR5cGVvZiBpdGVtc1tpXSA9PT0gJ29iamVjdCcgPyBpdGVtc1tpXVthLnBhcmFtcy52YWx1ZVByb3BlcnR5XSA6IGl0ZW1zW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zSFRNTCArPSBhLmRyb3Bkb3duSXRlbVRlbXBsYXRlKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGl0ZW1WYWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogKHR5cGVvZiBpdGVtc1tpXSAhPT0gJ29iamVjdCcgPyBpdGVtc1tpXSA6IGl0ZW1zW2ldW2EucGFyYW1zLnRleHRQcm9wZXJ0eV0pLnJlcGxhY2UocmVnRXhwLCAnPGI+JDE8L2I+JylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtc0hUTUwgPT09ICcnICYmIHF1ZXJ5ID09PSAnJyAmJiBhLnBhcmFtcy5kcm9wZG93blBsYWNlaG9sZGVyVGV4dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zSFRNTCArPSBhLmRyb3Bkb3duUGxhY2Vob2xkZXJUZW1wbGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IGEucGFyYW1zLmRyb3Bkb3duUGxhY2Vob2xkZXJUZXh0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgYS5kcm9wZG93bi5maW5kKCd1bCcpLmh0bWwoaXRlbXNIVE1MKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gSGFuZGxlIERyb3AgRG93biBDbGlja1xuICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlRHJvcGRvd25DbGljayAoZSkge1xuICAgICAgICAgICAgICAgIC8qanNoaW50IHZhbGlkdGhpczp0cnVlICovXG4gICAgICAgICAgICAgICAgdmFyIGNsaWNrZWQgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgIHZhciBjbGlja2VkSXRlbTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGEuaXRlbXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1WYWx1ZSA9IHR5cGVvZiBhLml0ZW1zW2ldID09PSAnb2JqZWN0JyA/IGEuaXRlbXNbaV1bYS5wYXJhbXMudmFsdWVQcm9wZXJ0eV0gOiBhLml0ZW1zW2ldO1xuICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBjbGlja2VkLmF0dHIoJ2RhdGEtdmFsdWUnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1WYWx1ZSA9PT0gdmFsdWUgfHwgaXRlbVZhbHVlICogMSA9PT0gdmFsdWUgKiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjbGlja2VkSXRlbSA9IGEuaXRlbXNbaV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGEucGFyYW1zLnVwZGF0ZUlucHV0VmFsdWVPblNlbGVjdCkge1xuICAgICAgICAgICAgICAgICAgICBhLmlucHV0LnZhbCh0eXBlb2YgY2xpY2tlZEl0ZW0gPT09ICdvYmplY3QnID8gY2xpY2tlZEl0ZW1bYS5wYXJhbXMudGV4dFByb3BlcnR5XSA6IGNsaWNrZWRJdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgYS5pbnB1dC50cmlnZ2VyKCdpbnB1dCBjaGFuZ2UnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChhLnBhcmFtcy5vbkNoYW5nZSkge1xuICAgICAgICAgICAgICAgICAgICBhLnBhcmFtcy5vbkNoYW5nZShhLCBjbGlja2VkSXRlbSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBhLmNsb3NlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSGFuZGxlIEhUTUwgQ2xpY2sgdG8gY2xvc2UgRHJvcGRvd25cbiAgICAgICAgICAgIGZ1bmN0aW9uIGNsb3NlT25IVE1MQ2xpY2sgKGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gJChlLnRhcmdldCk7XG4gICAgICAgICAgICAgICAgaWYgKCEodGFyZ2V0LmlzKGEuaW5wdXRbMF0pIHx8IGEuZHJvcGRvd24gJiYgdGFyZ2V0LnBhcmVudHMoYS5kcm9wZG93blswXSkubGVuZ3RoID4gMCkpIHtcbiAgICAgICAgICAgICAgICAgICAgYS5jbG9zZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBhLnBvc2l0aW9uRHJvcERvd24gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGxpc3RCbG9jayA9IGEuaW5wdXQucGFyZW50cygnLmxpc3QtYmxvY2snKSxcbiAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnQgPSBhLmlucHV0LnBhcmVudHMoJy5wYWdlLWNvbnRlbnQnKSxcbiAgICAgICAgICAgICAgICAgICAgcGFkZGluZ1RvcCA9IHBhcnNlSW50KHBhZ2VDb250ZW50LmNzcygncGFkZGluZy10b3AnKSwgMTApLFxuICAgICAgICAgICAgICAgICAgICBwYWRkaW5nQm90dG9tID0gcGFyc2VJbnQocGFnZUNvbnRlbnQuY3NzKCdwYWRkaW5nLXRvcCcpLCAxMCksXG4gICAgICAgICAgICAgICAgICAgIGlucHV0T2Zmc2V0ID0gYS5pbnB1dC5vZmZzZXQoKSxcbiAgICAgICAgICAgICAgICAgICAgbGlzdEJsb2NrT2Zmc2V0ID0gbGlzdEJsb2NrLmxlbmd0aCA+IDAgPyBsaXN0QmxvY2sub2Zmc2V0KCkgOiAwLFxuICAgICAgICAgICAgICAgICAgICBtYXhIZWlnaHQgPSBwYWdlQ29udGVudFswXS5zY3JvbGxIZWlnaHQgLSBwYWRkaW5nQm90dG9tIC0gKGlucHV0T2Zmc2V0LnRvcCArIHBhZ2VDb250ZW50WzBdLnNjcm9sbFRvcCkgLSBhLmlucHV0WzBdLm9mZnNldEhlaWdodDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgYS5kcm9wZG93bi5jc3Moe1xuICAgICAgICAgICAgICAgICAgICBsZWZ0OiAobGlzdEJsb2NrLmxlbmd0aCA+IDAgPyBsaXN0QmxvY2tPZmZzZXQubGVmdCA6IGlucHV0T2Zmc2V0LmxlZnQpICsgJ3B4JyxcbiAgICAgICAgICAgICAgICAgICAgdG9wOiBpbnB1dE9mZnNldC50b3AgKyBwYWdlQ29udGVudFswXS5zY3JvbGxUb3AgKyBhLmlucHV0WzBdLm9mZnNldEhlaWdodCArICdweCcsXG4gICAgICAgICAgICAgICAgICAgIHdpZHRoOiAobGlzdEJsb2NrLmxlbmd0aCA+IDAgPyBsaXN0QmxvY2tbMF0ub2Zmc2V0V2lkdGggOiBhLmlucHV0WzBdLm9mZnNldFdpZHRoKSArICdweCdcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBhLmRyb3Bkb3duLmNoaWxkcmVuKCcuYXV0b2NvbXBsZXRlLWRyb3Bkb3duLWlubmVyJykuY3NzKHtcbiAgICAgICAgICAgICAgICAgICAgbWF4SGVpZ2h0OiBtYXhIZWlnaHQgKyAncHgnLFxuICAgICAgICAgICAgICAgICAgICBwYWRkaW5nTGVmdDogbGlzdEJsb2NrLmxlbmd0aCA+IDAgJiYgIWEucGFyYW1zLmV4cGFuZElucHV0ID8gaW5wdXRPZmZzZXQubGVmdCAtIChtYXRlcmlhbCA/IDE2IDogMTUpICsgJ3B4JyA6ICcnXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEV2ZW50IExpc3RlbmVycyBvbiBuZXcgcGFnZVxuICAgICAgICAgICAgYS5wYWdlSW5pdCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBhZ2UgPSBlLmRldGFpbC5wYWdlO1xuICAgICAgICAgICAgICAgIGEucGFnZSA9ICQocGFnZS5jb250YWluZXIpO1xuICAgICAgICAgICAgICAgIGEucGFnZURhdGEgPSBwYWdlO1xuICAgICAgICAgICAgICAgIGlmIChwYWdlLm5hbWUgIT09IHBhZ2VOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIGNvbnRhaW5lciA9ICQocGFnZS5jb250YWluZXIpO1xuICAgICAgICAgICAgICAgIC8vIEluaXQgU2VhcmNoIEJhclxuICAgICAgICAgICAgICAgIHZhciBzZWFyY2hiYXIgPSBhcHAuc2VhcmNoYmFyKGNvbnRhaW5lci5maW5kKCcuc2VhcmNoYmFyJyksIHtcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tU2VhcmNoOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBvblNlYXJjaDogZnVuY3Rpb24gKHNlYXJjaGJhciwgZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEucXVlcnkubGVuZ3RoID09PSAwICYmIHNlYXJjaGJhci5hY3RpdmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2hiYXIub3ZlcmxheS5hZGRDbGFzcygnc2VhcmNoYmFyLW92ZXJsYXktYWN0aXZlJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2hiYXIub3ZlcmxheS5yZW1vdmVDbGFzcygnc2VhcmNoYmFyLW92ZXJsYXktYWN0aXZlJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGksIGosIGs7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGEucGFyYW1zLnNvdXJjZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEucGFyYW1zLnNvdXJjZShhLCBkYXRhLnF1ZXJ5LCBmdW5jdGlvbihpdGVtcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbXNIVE1MID0gJyc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsaW1pdCA9IGEucGFyYW1zLmxpbWl0ID8gTWF0aC5taW4oYS5wYXJhbXMubGltaXQsIGl0ZW1zLmxlbmd0aCkgOiBpdGVtcy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEuaXRlbXMgPSBpdGVtcztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxpbWl0OyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1WYWx1ZSA9IHR5cGVvZiBpdGVtc1tpXSA9PT0gJ29iamVjdCcgPyBpdGVtc1tpXVthLnBhcmFtcy52YWx1ZVByb3BlcnR5XSA6IGl0ZW1zW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IGEudmFsdWUubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYVZhbHVlID0gdHlwZW9mIGEudmFsdWVbal0gPT09ICdvYmplY3QnID8gYS52YWx1ZVtqXVthLnBhcmFtcy52YWx1ZVByb3BlcnR5XSA6IGEudmFsdWVbal07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFWYWx1ZSA9PT0gaXRlbVZhbHVlIHx8IGFWYWx1ZSAqIDEgPT09IGl0ZW1WYWx1ZSAqIDEpIHNlbGVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zSFRNTCArPSBhLml0ZW1UZW1wbGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGl0ZW1WYWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiB0eXBlb2YgaXRlbXNbaV0gIT09ICdvYmplY3QnID8gaXRlbXNbaV0gOiBpdGVtc1tpXVthLnBhcmFtcy50ZXh0UHJvcGVydHldLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0VHlwZTogYS5pbnB1dFR5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQ6IGEuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXROYW1lOiBhLmlucHV0TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZDogc2VsZWN0ZWQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tib3g6IGEuaW5wdXRUeXBlID09PSAnY2hlY2tib3gnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGVyaWFsOiBtYXRlcmlhbFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmZpbmQoJy5hdXRvY29tcGxldGUtZm91bmQgdWwnKS5odG1sKGl0ZW1zSFRNTCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLnF1ZXJ5Lmxlbmd0aCAhPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5maW5kKCcuYXV0b2NvbXBsZXRlLW5vdC1mb3VuZCcpLnNob3coKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuZmluZCgnLmF1dG9jb21wbGV0ZS1mb3VuZCwgLmF1dG9jb21wbGV0ZS12YWx1ZXMnKS5oaWRlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuZmluZCgnLmF1dG9jb21wbGV0ZS12YWx1ZXMnKS5zaG93KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmZpbmQoJy5hdXRvY29tcGxldGUtZm91bmQsIC5hdXRvY29tcGxldGUtbm90LWZvdW5kJykuaGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGFpbmVyLmZpbmQoJy5hdXRvY29tcGxldGUtZm91bmQnKS5zaG93KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuZmluZCgnLmF1dG9jb21wbGV0ZS1ub3QtZm91bmQsIC5hdXRvY29tcGxldGUtdmFsdWVzJykuaGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gU2F2ZSBzZWFyY2hiYXIgaW5zdGFuY2VcbiAgICAgICAgICAgICAgICBhLnNlYXJjaGJhciA9IHNlYXJjaGJhcjtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gVXBkYXRlIHZhbHVlc1xuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZVZhbHVlcygpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlc0hUTUwgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgdmFyIGk7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBhLnZhbHVlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzSFRNTCArPSBhLml0ZW1UZW1wbGF0ZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHR5cGVvZiBhLnZhbHVlW2ldID09PSAnb2JqZWN0JyA/IGEudmFsdWVbaV1bYS5wYXJhbXMudmFsdWVQcm9wZXJ0eV0gOiBhLnZhbHVlW2ldLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IHR5cGVvZiBhLnZhbHVlW2ldID09PSAnb2JqZWN0JyA/IGEudmFsdWVbaV1bYS5wYXJhbXMudGV4dFByb3BlcnR5XTogYS52YWx1ZVtpXSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dFR5cGU6IGEuaW5wdXRUeXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBhLmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlucHV0TmFtZTogYS5pbnB1dE5hbWUgKyAnLWNoZWNrZWQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrYm94OiBhLmlucHV0VHlwZSA9PT0gJ2NoZWNrYm94JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRlcmlhbDogbWF0ZXJpYWwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5maW5kKCcuYXV0b2NvbXBsZXRlLXZhbHVlcyB1bCcpLmh0bWwodmFsdWVzSFRNTCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBIYW5kbGUgSW5wdXRzXG4gICAgICAgICAgICAgICAgY29udGFpbmVyLm9uKCdjaGFuZ2UnLCAnaW5wdXRbdHlwZT1cInJhZGlvXCJdLCBpbnB1dFt0eXBlPVwiY2hlY2tib3hcIl0nLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaW5wdXQgPSB0aGlzO1xuICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBpbnB1dC52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRleHQgPSAkKGlucHV0KS5wYXJlbnRzKCdsaScpLmZpbmQoJy5pdGVtLXRpdGxlJykudGV4dCgpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaXNWYWx1ZXMgPSAkKGlucHV0KS5wYXJlbnRzKCcuYXV0b2NvbXBsZXRlLXZhbHVlcycpLmxlbmd0aCA+IDA7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpdGVtLCBpdGVtVmFsdWUsIGFWYWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsdWVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYS5pbnB1dFR5cGUgPT09ICdjaGVja2JveCcgJiYgIWlucHV0LmNoZWNrZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYS52YWx1ZS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhVmFsdWUgPSB0eXBlb2YgYS52YWx1ZVtpXSA9PT0gJ3N0cmluZycgPyBhLnZhbHVlW2ldIDogYS52YWx1ZVtpXVthLnBhcmFtcy52YWx1ZVByb3BlcnR5XTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFWYWx1ZSA9PT0gdmFsdWUgfHwgYVZhbHVlICogMSA9PT0gdmFsdWUgKiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLnZhbHVlLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVWYWx1ZXMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub25DaGFuZ2UpIGEucGFyYW1zLm9uQ2hhbmdlKGEsIGEudmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBGaW5kIFJlbGF0ZWQgSXRlbVxuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYS5pdGVtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXRlbVZhbHVlID0gdHlwZW9mIGEuaXRlbXNbaV0gPT09ICdzdHJpbmcnID8gYS5pdGVtc1tpXSA6IGEuaXRlbXNbaV1bYS5wYXJhbXMudmFsdWVQcm9wZXJ0eV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbVZhbHVlID09PSB2YWx1ZSB8fCBpdGVtVmFsdWUgKiAxID09PSB2YWx1ZSAqIDEpIGl0ZW0gPSBhLml0ZW1zW2ldO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBTZWxlY3RlZCBWYWx1ZVxuICAgICAgICAgICAgICAgICAgICBpZiAoYS5pbnB1dFR5cGUgPT09ICdyYWRpbycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGEudmFsdWUgPSBbaXRlbV07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5wdXQuY2hlY2tlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEudmFsdWUucHVzaChpdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBhLnZhbHVlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFWYWx1ZSA9IHR5cGVvZiBhLnZhbHVlW2ldID09PSAnc3RyaW5nJyA/IGEudmFsdWVbaV0gOiBhLnZhbHVlW2ldW2EucGFyYW1zLnZhbHVlUHJvcGVydHldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYVZhbHVlID09PSB2YWx1ZSB8fCBhVmFsdWUgKiAxID09PSB2YWx1ZSAqIDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEudmFsdWUuc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgVmFsdWVzIEJsb2NrXG4gICAgICAgICAgICAgICAgICAgIHVwZGF0ZVZhbHVlcygpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gT24gU2VsZWN0IENhbGxiYWNrXG4gICAgICAgICAgICAgICAgICAgIGlmICgoYS5pbnB1dFR5cGUgPT09ICdyYWRpbycgJiYgaW5wdXQuY2hlY2tlZCB8fCBhLmlucHV0VHlwZSA9PT0gJ2NoZWNrYm94JykgJiYgYS5wYXJhbXMub25DaGFuZ2UgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhLnBhcmFtcy5vbkNoYW5nZShhLCBhLnZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoYmFja09uU2VsZWN0ICYmIGEuaW5wdXRUeXBlID09PSAncmFkaW8nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub3BlbkluID09PSAncG9wdXAnKSBhcHAuY2xvc2VNb2RhbChhLnBvcHVwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Ugdmlldy5yb3V0ZXIuYmFjaygpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBWYWx1ZXMgT24gUGFnZSBJbml0XG4gICAgICAgICAgICAgICAgdXBkYXRlVmFsdWVzKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChhLnBhcmFtcy5vbk9wZW4pIGEucGFyYW1zLm9uT3BlbihhKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2hvdyBIaWRlIFByZWxvYWRlclxuICAgICAgICAgICAgYS5zaG93UHJlbG9hZGVyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChhLnBhcmFtcy5vcGVuSW4gPT09ICdkcm9wZG93bicpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGEuZHJvcGRvd24pIGEuZHJvcGRvd24uZmluZCgnLmF1dG9jb21wbGV0ZS1wcmVsb2FkZXInKS5hZGRDbGFzcygnYXV0b2NvbXBsZXRlLXByZWxvYWRlci12aXNpYmxlJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgJCgnLmF1dG9jb21wbGV0ZS1wcmVsb2FkZXInKS5hZGRDbGFzcygnYXV0b2NvbXBsZXRlLXByZWxvYWRlci12aXNpYmxlJyk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIGEuaGlkZVByZWxvYWRlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub3BlbkluID09PSAnZHJvcGRvd24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhLmRyb3Bkb3duKSBhLmRyb3Bkb3duLmZpbmQoJy5hdXRvY29tcGxldGUtcHJlbG9hZGVyJykucmVtb3ZlQ2xhc3MoJ2F1dG9jb21wbGV0ZS1wcmVsb2FkZXItdmlzaWJsZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlICQoJy5hdXRvY29tcGxldGUtcHJlbG9hZGVyJykucmVtb3ZlQ2xhc3MoJ2F1dG9jb21wbGV0ZS1wcmVsb2FkZXItdmlzaWJsZScpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBPcGVuIEF1dG9jb21wbGV0ZSBQYWdlL1BvcHVwXG4gICAgICAgICAgICBhLm9wZW4gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKGEub3BlbmVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgYS5vcGVuZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmIChhLnBhcmFtcy5vcGVuSW4gPT09ICdkcm9wZG93bicpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFhLmRyb3Bkb3duKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhLmRyb3Bkb3duID0gJChhLmRyb3Bkb3duVGVtcGxhdGUoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWxvYWRlcjogYS5wYXJhbXMucHJlbG9hZGVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWxvYWRlckNvbG9yOiBhLnBhcmFtcy5wcmVsb2FkZXJDb2xvcixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRlcmlhbDogbWF0ZXJpYWwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0ZXJpYWxQcmVsb2FkZXJIdG1sOiBhcHAucGFyYW1zLm1hdGVyaWFsUHJlbG9hZGVySHRtbFxuICAgICAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYS5kcm9wZG93bi5vbignY2xpY2snLCAnbGFiZWwnLCBoYW5kbGVEcm9wZG93bkNsaWNrKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIGxpc3RCbG9jayA9IGEuaW5wdXQucGFyZW50cygnLmxpc3QtYmxvY2snKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGxpc3RCbG9jay5sZW5ndGggJiYgYS5pbnB1dC5wYXJlbnRzKCcuaXRlbS1jb250ZW50JykubGVuZ3RoID4gMCAmJiBhLnBhcmFtcy5leHBhbmRJbnB1dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYS5pbnB1dC5wYXJlbnRzKCcuaXRlbS1jb250ZW50JykuYWRkQ2xhc3MoJ2l0ZW0tY29udGVudC1kcm9wZG93bi1leHBhbmQnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBhLnBvc2l0aW9uRHJvcERvd24oKTtcbiAgICAgICAgICAgICAgICAgICAgYS5pbnB1dC5wYXJlbnRzKCcucGFnZS1jb250ZW50JykuYXBwZW5kKGEuZHJvcGRvd24pO1xuICAgICAgICAgICAgICAgICAgICBhLmRyb3Bkb3duLmFkZENsYXNzKCdhdXRvY29tcGxldGUtZHJvcGRvd24taW4nKTtcbiAgICAgICAgICAgICAgICAgICAgYS5pbnB1dC50cmlnZ2VyKCdpbnB1dCcpO1xuICAgICAgICAgICAgICAgICAgICAkKHdpbmRvdykub24oJ3Jlc2l6ZScsIGEucG9zaXRpb25Ecm9wRG93bik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhLnBhcmFtcy5vbk9wZW4pIGEucGFyYW1zLm9uT3BlbihhKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICQoZG9jdW1lbnQpLm9uY2UoJ3BhZ2VJbml0JywgJy5hdXRvY29tcGxldGUtcGFnZScsIGEucGFnZUluaXQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub3BlbkluID09PSAncG9wdXAnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhLnBvcHVwID0gYXBwLnBvcHVwKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicG9wdXAgYXV0b2NvbXBsZXRlLXBvcHVwIGF1dG9jb21wbGV0ZS1wb3B1cC0nICsgYS5pbnB1dE5hbWUgKyAnXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwidmlldyBuYXZiYXItZml4ZWRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VIVE1MICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGEucG9wdXAgPSAkKGEucG9wdXApO1xuICAgICAgICAgICAgICAgICAgICAgICAgYS5wb3B1cC5vbmNlKCdjbG9zZWQnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5wb3B1cCA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLm9wZW5lZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhLnBhcmFtcy5vbkNsb3NlKSBhLnBhcmFtcy5vbkNsb3NlKGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2aWV3LnJvdXRlci5sb2FkKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50OiBwYWdlSFRNTFxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKGRvY3VtZW50KS5vbmNlKCdwYWdlQmFjaycsICcuYXV0b2NvbXBsZXRlLXBhZ2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5vcGVuZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub25DbG9zZSkgYS5wYXJhbXMub25DbG9zZShhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGEuY2xvc2UgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIGlmICghYS5vcGVuZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub3BlbkluID09PSAnZHJvcGRvd24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlICYmIGUudHlwZSA9PT0gJ2JsdXInICYmIGEuZHJvcGRvd24uZmluZCgnbGFiZWwuYWN0aXZlLXN0YXRlJykubGVuZ3RoID4gMCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICBhLmRyb3Bkb3duLnJlbW92ZUNsYXNzKCdhdXRvY29tcGxldGUtZHJvcGRvd24taW4nKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgYS5pbnB1dC5wYXJlbnRzKCcuaXRlbS1jb250ZW50LWRyb3Bkb3duLWV4cGFuZCcpLnJlbW92ZUNsYXNzKCdpdGVtLWNvbnRlbnQtZHJvcGRvd24tZXhwYW5kJyk7XG4gICAgICAgICAgICAgICAgICAgIGEub3BlbmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICQod2luZG93KS5vZmYoJ3Jlc2l6ZScsIGEucG9zaXRpb25Ecm9wRG93bik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhLnBhcmFtcy5vbkNsb3NlKSBhLnBhcmFtcy5vbkNsb3NlKGEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub3BlbkluID09PSAncG9wdXAnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhLnBvcHVwKSBhcHAuY2xvc2VNb2RhbChhLnBvcHVwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgRXZlbnRzXG4gICAgICAgICAgICBhLmluaXRFdmVudHMgPSBmdW5jdGlvbiAoZGV0YWNoKSB7XG4gICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGRldGFjaCA/ICdvZmYnIDogJ29uJztcbiAgICAgICAgICAgICAgICBpZiAoYS5wYXJhbXMub3BlbkluICE9PSAnZHJvcGRvd24nICYmIGEub3BlbmVyKSB7XG4gICAgICAgICAgICAgICAgICAgIGEub3BlbmVyW21ldGhvZF0oJ2NsaWNrJywgYS5vcGVuKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGEucGFyYW1zLm9wZW5JbiA9PT0gJ2Ryb3Bkb3duJyAmJiBhLmlucHV0KSB7XG4gICAgICAgICAgICAgICAgICAgIGEuaW5wdXRbbWV0aG9kXSgnZm9jdXMnLCBhLm9wZW4pO1xuICAgICAgICAgICAgICAgICAgICBhLmlucHV0W21ldGhvZF0oJ2lucHV0JywgaGFuZGxlSW5wdXRWYWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLmFuZHJvaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQoJ2h0bWwnKVttZXRob2RdKCdjbGljaycsIGNsb3NlT25IVE1MQ2xpY2spO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYS5pbnB1dFttZXRob2RdKCdibHVyJywgYS5jbG9zZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGRldGFjaCAmJiBhLmRyb3Bkb3duKSB7XG4gICAgICAgICAgICAgICAgICAgIGEuZHJvcGRvd24gPSBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdC9EZXN0cm95IE1ldGhvZHNcbiAgICAgICAgICAgIGEuaW5pdCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBhLmluaXRFdmVudHMoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBhLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgYS5pbml0RXZlbnRzKHRydWUpO1xuICAgICAgICAgICAgICAgIGEgPSBudWxsO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0XG4gICAgICAgICAgICBhLmluaXQoKTtcbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gYTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmF1dG9jb21wbGV0ZSA9IGZ1bmN0aW9uIChwYXJhbXMpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQXV0b2NvbXBsZXRlKHBhcmFtcyk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgUGlja2VyICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHZhciBQaWNrZXIgPSBmdW5jdGlvbiAocGFyYW1zKSB7XG4gICAgICAgICAgICB2YXIgcCA9IHRoaXM7XG4gICAgICAgICAgICB2YXIgZGVmYXVsdHMgPSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlVmFsdWVzT25Nb21lbnR1bTogZmFsc2UsXG4gICAgICAgICAgICAgICAgdXBkYXRlVmFsdWVzT25Ub3VjaG1vdmU6IHRydWUsXG4gICAgICAgICAgICAgICAgcm90YXRlRWZmZWN0OiBmYWxzZSxcbiAgICAgICAgICAgICAgICBtb21lbnR1bVJhdGlvOiA3LFxuICAgICAgICAgICAgICAgIGZyZWVNb2RlOiBmYWxzZSxcbiAgICAgICAgICAgICAgICAvLyBDb21tb24gc2V0dGluZ3NcbiAgICAgICAgICAgICAgICBjbG9zZUJ5T3V0c2lkZUNsaWNrOiB0cnVlLFxuICAgICAgICAgICAgICAgIHNjcm9sbFRvSW5wdXQ6IHRydWUsXG4gICAgICAgICAgICAgICAgaW5wdXRSZWFkT25seTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBjb252ZXJ0VG9Qb3BvdmVyOiB0cnVlLFxuICAgICAgICAgICAgICAgIG9ubHlJblBvcG92ZXI6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHRvb2xiYXI6IHRydWUsXG4gICAgICAgICAgICAgICAgdG9vbGJhckNsb3NlVGV4dDogJ0RvbmUnLFxuICAgICAgICAgICAgICAgIHRvb2xiYXJUZW1wbGF0ZTogXG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwidG9vbGJhclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJ0b29sYmFyLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJsZWZ0XCI+PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJyaWdodFwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGEgaHJlZj1cIiNcIiBjbGFzcz1cImxpbmsgY2xvc2UtcGlja2VyXCI+e3tjbG9zZVRleHR9fTwvYT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xuICAgICAgICAgICAgZm9yICh2YXIgZGVmIGluIGRlZmF1bHRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXNbZGVmXSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zW2RlZl0gPSBkZWZhdWx0c1tkZWZdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHAucGFyYW1zID0gcGFyYW1zO1xuICAgICAgICAgICAgcC5jb2xzID0gW107XG4gICAgICAgICAgICBwLmluaXRpYWxpemVkID0gZmFsc2U7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIElubGluZSBmbGFnXG4gICAgICAgICAgICBwLmlubGluZSA9IHAucGFyYW1zLmNvbnRhaW5lciA/IHRydWUgOiBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyAzRCBUcmFuc2Zvcm1zIG9yaWdpbiBidWcsIG9ubHkgb24gc2FmYXJpXG4gICAgICAgICAgICB2YXIgb3JpZ2luQnVnID0gYXBwLmRldmljZS5pb3MgfHwgKG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCdzYWZhcmknKSA+PSAwICYmIG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCdjaHJvbWUnKSA8IDApICYmICFhcHAuZGV2aWNlLmFuZHJvaWQ7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gU2hvdWxkIGJlIGNvbnZlcnRlZCB0byBwb3BvdmVyXG4gICAgICAgICAgICBmdW5jdGlvbiBpc1BvcG92ZXIoKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRvUG9wb3ZlciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmICghcC5wYXJhbXMuY29udmVydFRvUG9wb3ZlciAmJiAhcC5wYXJhbXMub25seUluUG9wb3ZlcikgcmV0dXJuIHRvUG9wb3ZlcjtcbiAgICAgICAgICAgICAgICBpZiAoIXAuaW5saW5lICYmIHAucGFyYW1zLmlucHV0KSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5vbmx5SW5Qb3BvdmVyKSB0b1BvcG92ZXIgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAuZGV2aWNlLmlvcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvUG9wb3ZlciA9IGFwcC5kZXZpY2UuaXBhZCA/IHRydWUgOiBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKHdpbmRvdykud2lkdGgoKSA+PSA3NjgpIHRvUG9wb3ZlciA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IFxuICAgICAgICAgICAgICAgIHJldHVybiB0b1BvcG92ZXI7IFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gaW5Qb3BvdmVyKCkge1xuICAgICAgICAgICAgICAgIGlmIChwLm9wZW5lZCAmJiBwLmNvbnRhaW5lciAmJiBwLmNvbnRhaW5lci5sZW5ndGggPiAwICYmIHAuY29udGFpbmVyLnBhcmVudHMoJy5wb3BvdmVyJykubGVuZ3RoID4gMCkgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVmFsdWVcbiAgICAgICAgICAgIHAuc2V0VmFsdWUgPSBmdW5jdGlvbiAoYXJyVmFsdWVzLCB0cmFuc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgdmFyIHZhbHVlSW5kZXggPSAwO1xuICAgICAgICAgICAgICAgIGlmIChwLmNvbHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHAudmFsdWUgPSBhcnJWYWx1ZXM7XG4gICAgICAgICAgICAgICAgICAgIHAudXBkYXRlVmFsdWUoYXJyVmFsdWVzKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHAuY29scy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5jb2xzW2ldICYmICFwLmNvbHNbaV0uZGl2aWRlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5jb2xzW2ldLnNldFZhbHVlKGFyclZhbHVlc1t2YWx1ZUluZGV4XSwgdHJhbnNpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZUluZGV4Kys7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcC51cGRhdGVWYWx1ZSA9IGZ1bmN0aW9uIChmb3JjZVZhbHVlcykge1xuICAgICAgICAgICAgICAgIHZhciBuZXdWYWx1ZSA9IGZvcmNlVmFsdWVzIHx8IFtdO1xuICAgICAgICAgICAgICAgIHZhciBuZXdEaXNwbGF5VmFsdWUgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHAuY29scy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXAuY29sc1tpXS5kaXZpZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdWYWx1ZS5wdXNoKHAuY29sc1tpXS52YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdEaXNwbGF5VmFsdWUucHVzaChwLmNvbHNbaV0uZGlzcGxheVZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobmV3VmFsdWUuaW5kZXhPZih1bmRlZmluZWQpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwLnZhbHVlID0gbmV3VmFsdWU7XG4gICAgICAgICAgICAgICAgcC5kaXNwbGF5VmFsdWUgPSBuZXdEaXNwbGF5VmFsdWU7XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm9uQ2hhbmdlKSB7XG4gICAgICAgICAgICAgICAgICAgIHAucGFyYW1zLm9uQ2hhbmdlKHAsIHAudmFsdWUsIHAuZGlzcGxheVZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHAuaW5wdXQgJiYgcC5pbnB1dC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICQocC5pbnB1dCkudmFsKHAucGFyYW1zLmZvcm1hdFZhbHVlID8gcC5wYXJhbXMuZm9ybWF0VmFsdWUocCwgcC52YWx1ZSwgcC5kaXNwbGF5VmFsdWUpIDogcC52YWx1ZS5qb2luKCcgJykpO1xuICAgICAgICAgICAgICAgICAgICAkKHAuaW5wdXQpLnRyaWdnZXIoJ2NoYW5nZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ29sdW1ucyBIYW5kbGVyc1xuICAgICAgICAgICAgcC5pbml0UGlja2VyQ29sID0gZnVuY3Rpb24gKGNvbEVsZW1lbnQsIHVwZGF0ZUl0ZW1zKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNvbENvbnRhaW5lciA9ICQoY29sRWxlbWVudCk7XG4gICAgICAgICAgICAgICAgdmFyIGNvbEluZGV4ID0gY29sQ29udGFpbmVyLmluZGV4KCk7XG4gICAgICAgICAgICAgICAgdmFyIGNvbCA9IHAuY29sc1tjb2xJbmRleF07XG4gICAgICAgICAgICAgICAgaWYgKGNvbC5kaXZpZGVyKSByZXR1cm47XG4gICAgICAgICAgICAgICAgY29sLmNvbnRhaW5lciA9IGNvbENvbnRhaW5lcjtcbiAgICAgICAgICAgICAgICBjb2wud3JhcHBlciA9IGNvbC5jb250YWluZXIuZmluZCgnLnBpY2tlci1pdGVtcy1jb2wtd3JhcHBlcicpO1xuICAgICAgICAgICAgICAgIGNvbC5pdGVtcyA9IGNvbC53cmFwcGVyLmZpbmQoJy5waWNrZXItaXRlbScpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBpLCBqO1xuICAgICAgICAgICAgICAgIHZhciB3cmFwcGVySGVpZ2h0LCBpdGVtSGVpZ2h0LCBpdGVtc0hlaWdodCwgbWluVHJhbnNsYXRlLCBtYXhUcmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgY29sLnJlcGxhY2VWYWx1ZXMgPSBmdW5jdGlvbiAodmFsdWVzLCBkaXNwbGF5VmFsdWVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbC5kZXN0cm95RXZlbnRzKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbC52YWx1ZXMgPSB2YWx1ZXM7XG4gICAgICAgICAgICAgICAgICAgIGNvbC5kaXNwbGF5VmFsdWVzID0gZGlzcGxheVZhbHVlcztcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld0l0ZW1zSFRNTCA9IHAuY29sdW1uSFRNTChjb2wsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICBjb2wud3JhcHBlci5odG1sKG5ld0l0ZW1zSFRNTCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbC5pdGVtcyA9IGNvbC53cmFwcGVyLmZpbmQoJy5waWNrZXItaXRlbScpO1xuICAgICAgICAgICAgICAgICAgICBjb2wuY2FsY1NpemUoKTtcbiAgICAgICAgICAgICAgICAgICAgY29sLnNldFZhbHVlKGNvbC52YWx1ZXNbMF0sIDAsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICBjb2wuaW5pdEV2ZW50cygpO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgY29sLmNhbGNTaXplID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMucm90YXRlRWZmZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2wuY29udGFpbmVyLnJlbW92ZUNsYXNzKCdwaWNrZXItaXRlbXMtY29sLWFic29sdXRlJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbC53aWR0aCkgY29sLmNvbnRhaW5lci5jc3Moe3dpZHRoOicnfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvbFdpZHRoLCBjb2xIZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgIGNvbFdpZHRoID0gMDtcbiAgICAgICAgICAgICAgICAgICAgY29sSGVpZ2h0ID0gY29sLmNvbnRhaW5lclswXS5vZmZzZXRIZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgIHdyYXBwZXJIZWlnaHQgPSBjb2wud3JhcHBlclswXS5vZmZzZXRIZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW1IZWlnaHQgPSBjb2wuaXRlbXNbMF0ub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICBpdGVtc0hlaWdodCA9IGl0ZW1IZWlnaHQgKiBjb2wuaXRlbXMubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICBtaW5UcmFuc2xhdGUgPSBjb2xIZWlnaHQgLyAyIC0gaXRlbXNIZWlnaHQgKyBpdGVtSGVpZ2h0IC8gMjtcbiAgICAgICAgICAgICAgICAgICAgbWF4VHJhbnNsYXRlID0gY29sSGVpZ2h0IC8gMiAtIGl0ZW1IZWlnaHQgLyAyOyAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbC53aWR0aCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sV2lkdGggPSBjb2wud2lkdGg7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyc2VJbnQoY29sV2lkdGgsIDEwKSA9PT0gY29sV2lkdGgpIGNvbFdpZHRoID0gY29sV2lkdGggKyAncHgnO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sLmNvbnRhaW5lci5jc3Moe3dpZHRoOiBjb2xXaWR0aH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5yb3RhdGVFZmZlY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY29sLndpZHRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sLml0ZW1zLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbSA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uY3NzKHt3aWR0aDonYXV0byd9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sV2lkdGggPSBNYXRoLm1heChjb2xXaWR0aCwgaXRlbVswXS5vZmZzZXRXaWR0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uY3NzKHt3aWR0aDonJ30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbC5jb250YWluZXIuY3NzKHt3aWR0aDogKGNvbFdpZHRoICsgMikgKyAncHgnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2wuY29udGFpbmVyLmFkZENsYXNzKCdwaWNrZXItaXRlbXMtY29sLWFic29sdXRlJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGNvbC5jYWxjU2l6ZSgpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbC53cmFwcGVyLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwnICsgbWF4VHJhbnNsYXRlICsgJ3B4LDApJykudHJhbnNpdGlvbigwKTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBhY3RpdmVJbmRleCA9IDA7XG4gICAgICAgICAgICAgICAgdmFyIGFuaW1hdGlvbkZyYW1lSWQ7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFNldCBWYWx1ZSBGdW5jdGlvblxuICAgICAgICAgICAgICAgIGNvbC5zZXRWYWx1ZSA9IGZ1bmN0aW9uIChuZXdWYWx1ZSwgdHJhbnNpdGlvbiwgdmFsdWVDYWxsYmFja3MpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0cmFuc2l0aW9uID09PSAndW5kZWZpbmVkJykgdHJhbnNpdGlvbiA9ICcnO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3QWN0aXZlSW5kZXggPSBjb2wud3JhcHBlci5maW5kKCcucGlja2VyLWl0ZW1bZGF0YS1waWNrZXItdmFsdWU9XCInICsgbmV3VmFsdWUgKyAnXCJdJykuaW5kZXgoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIG5ld0FjdGl2ZUluZGV4ID09PSAndW5kZWZpbmVkJyB8fCBuZXdBY3RpdmVJbmRleCA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3VHJhbnNsYXRlID0gLW5ld0FjdGl2ZUluZGV4ICogaXRlbUhlaWdodCArIG1heFRyYW5zbGF0ZTtcbiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIHdyYXBwZXJcbiAgICAgICAgICAgICAgICAgICAgY29sLndyYXBwZXIudHJhbnNpdGlvbih0cmFuc2l0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgY29sLndyYXBwZXIudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLCcgKyAobmV3VHJhbnNsYXRlKSArICdweCwwKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIFdhdGNoIGl0ZW1zXG4gICAgICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy51cGRhdGVWYWx1ZXNPbk1vbWVudHVtICYmIGNvbC5hY3RpdmVJbmRleCAmJiBjb2wuYWN0aXZlSW5kZXggIT09IG5ld0FjdGl2ZUluZGV4ICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgJC5jYW5jZWxBbmltYXRpb25GcmFtZShhbmltYXRpb25GcmFtZUlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbC53cmFwcGVyLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkLmNhbmNlbEFuaW1hdGlvbkZyYW1lKGFuaW1hdGlvbkZyYW1lSWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVEdXJpbmdTY3JvbGwoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIGl0ZW1zXG4gICAgICAgICAgICAgICAgICAgIGNvbC51cGRhdGVJdGVtcyhuZXdBY3RpdmVJbmRleCwgbmV3VHJhbnNsYXRlLCB0cmFuc2l0aW9uLCB2YWx1ZUNhbGxiYWNrcyk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgY29sLnVwZGF0ZUl0ZW1zID0gZnVuY3Rpb24gKGFjdGl2ZUluZGV4LCB0cmFuc2xhdGUsIHRyYW5zaXRpb24sIHZhbHVlQ2FsbGJhY2tzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHJhbnNsYXRlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlID0gJC5nZXRUcmFuc2xhdGUoY29sLndyYXBwZXJbMF0sICd5Jyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYodHlwZW9mIGFjdGl2ZUluZGV4ID09PSAndW5kZWZpbmVkJykgYWN0aXZlSW5kZXggPSAtTWF0aC5yb3VuZCgodHJhbnNsYXRlIC0gbWF4VHJhbnNsYXRlKS9pdGVtSGVpZ2h0KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGl2ZUluZGV4IDwgMCkgYWN0aXZlSW5kZXggPSAwO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYWN0aXZlSW5kZXggPj0gY29sLml0ZW1zLmxlbmd0aCkgYWN0aXZlSW5kZXggPSBjb2wuaXRlbXMubGVuZ3RoIC0gMTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzQWN0aXZlSW5kZXggPSBjb2wuYWN0aXZlSW5kZXg7XG4gICAgICAgICAgICAgICAgICAgIGNvbC5hY3RpdmVJbmRleCA9IGFjdGl2ZUluZGV4O1xuICAgICAgICAgICAgICAgICAgICBjb2wud3JhcHBlci5maW5kKCcucGlja2VyLXNlbGVjdGVkJykucmVtb3ZlQ2xhc3MoJ3BpY2tlci1zZWxlY3RlZCcpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgY29sLml0ZW1zLnRyYW5zaXRpb24odHJhbnNpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB2YXIgc2VsZWN0ZWRJdGVtID0gY29sLml0ZW1zLmVxKGFjdGl2ZUluZGV4KS5hZGRDbGFzcygncGlja2VyLXNlbGVjdGVkJykudHJhbnNmb3JtKCcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBTZXQgM0Qgcm90YXRlIGVmZmVjdFxuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMucm90YXRlRWZmZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcGVyY2VudGFnZSA9ICh0cmFuc2xhdGUgLSAoTWF0aC5mbG9vcigodHJhbnNsYXRlIC0gbWF4VHJhbnNsYXRlKS9pdGVtSGVpZ2h0KSAqIGl0ZW1IZWlnaHQgKyBtYXhUcmFuc2xhdGUpKSAvIGl0ZW1IZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbC5pdGVtcy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXRlbSA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1PZmZzZXRUb3AgPSBpdGVtLmluZGV4KCkgKiBpdGVtSGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2xhdGVPZmZzZXQgPSBtYXhUcmFuc2xhdGUgLSB0cmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGl0ZW1PZmZzZXQgPSBpdGVtT2Zmc2V0VG9wIC0gdHJhbnNsYXRlT2Zmc2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwZXJjZW50YWdlID0gaXRlbU9mZnNldCAvIGl0ZW1IZWlnaHQ7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdGVtc0ZpdCA9IE1hdGguY2VpbChjb2wuaGVpZ2h0IC8gaXRlbUhlaWdodCAvIDIpICsgMTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYW5nbGUgPSAoLTE4KnBlcmNlbnRhZ2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhbmdsZSA+IDE4MCkgYW5nbGUgPSAxODA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFuZ2xlIDwgLTE4MCkgYW5nbGUgPSAtMTgwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZhciBjbGFzc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChNYXRoLmFicyhwZXJjZW50YWdlKSA+IGl0ZW1zRml0KSBpdGVtLmFkZENsYXNzKCdwaWNrZXItaXRlbS1mYXInKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGl0ZW0ucmVtb3ZlQ2xhc3MoJ3BpY2tlci1pdGVtLWZhcicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCB0cmFuc2Zvcm1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoMCwgJyArICgtdHJhbnNsYXRlICsgbWF4VHJhbnNsYXRlKSArICdweCwgJyArIChvcmlnaW5CdWcgPyAtMTEwIDogMCkgKyAncHgpIHJvdGF0ZVgoJyArIGFuZ2xlICsgJ2RlZyknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWVDYWxsYmFja3MgfHwgdHlwZW9mIHZhbHVlQ2FsbGJhY2tzID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIHZhbHVlc1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sLnZhbHVlID0gc2VsZWN0ZWRJdGVtLmF0dHIoJ2RhdGEtcGlja2VyLXZhbHVlJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2wuZGlzcGxheVZhbHVlID0gY29sLmRpc3BsYXlWYWx1ZXMgPyBjb2wuZGlzcGxheVZhbHVlc1thY3RpdmVJbmRleF0gOiBjb2wudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBPbiBjaGFuZ2UgY2FsbGJhY2tcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmV2aW91c0FjdGl2ZUluZGV4ICE9PSBhY3RpdmVJbmRleCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2wub25DaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sLm9uQ2hhbmdlKHAsIGNvbC52YWx1ZSwgY29sLmRpc3BsYXlWYWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAudXBkYXRlVmFsdWUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHVwZGF0ZUR1cmluZ1Njcm9sbCgpIHtcbiAgICAgICAgICAgICAgICAgICAgYW5pbWF0aW9uRnJhbWVJZCA9ICQucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbC51cGRhdGVJdGVtcyh1bmRlZmluZWQsIHVuZGVmaW5lZCwgMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVEdXJpbmdTY3JvbGwoKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBVcGRhdGUgaXRlbXMgb24gaW5pdFxuICAgICAgICAgICAgICAgIGlmICh1cGRhdGVJdGVtcykgY29sLnVwZGF0ZUl0ZW1zKDAsIG1heFRyYW5zbGF0ZSwgMCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBhbGxvd0l0ZW1DbGljayA9IHRydWU7XG4gICAgICAgICAgICAgICAgdmFyIGlzVG91Y2hlZCwgaXNNb3ZlZCwgdG91Y2hTdGFydFksIHRvdWNoQ3VycmVudFksIHRvdWNoU3RhcnRUaW1lLCB0b3VjaEVuZFRpbWUsIHN0YXJ0VHJhbnNsYXRlLCByZXR1cm5UbywgY3VycmVudFRyYW5zbGF0ZSwgcHJldlRyYW5zbGF0ZSwgdmVsb2NpdHlUcmFuc2xhdGUsIHZlbG9jaXR5VGltZTtcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0IChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpc01vdmVkIHx8IGlzVG91Y2hlZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRZID0gdG91Y2hDdXJyZW50WSA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICAgICAgdG91Y2hTdGFydFRpbWUgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgYWxsb3dJdGVtQ2xpY2sgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBzdGFydFRyYW5zbGF0ZSA9IGN1cnJlbnRUcmFuc2xhdGUgPSAkLmdldFRyYW5zbGF0ZShjb2wud3JhcHBlclswXSwgJ3knKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghaXNUb3VjaGVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICAgICAgYWxsb3dJdGVtQ2xpY2sgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgdG91Y2hDdXJyZW50WSA9IGUudHlwZSA9PT0gJ3RvdWNobW92ZScgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgOiBlLnBhZ2VZO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzTW92ZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpcnN0IG1vdmVcbiAgICAgICAgICAgICAgICAgICAgICAgICQuY2FuY2VsQW5pbWF0aW9uRnJhbWUoYW5pbWF0aW9uRnJhbWVJZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpc01vdmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0VHJhbnNsYXRlID0gY3VycmVudFRyYW5zbGF0ZSA9ICQuZ2V0VHJhbnNsYXRlKGNvbC53cmFwcGVyWzBdLCAneScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sLndyYXBwZXIudHJhbnNpdGlvbigwKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB2YXIgZGlmZiA9IHRvdWNoQ3VycmVudFkgLSB0b3VjaFN0YXJ0WTtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudFRyYW5zbGF0ZSA9IHN0YXJ0VHJhbnNsYXRlICsgZGlmZjtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuVG8gPSB1bmRlZmluZWQ7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdHJhbnNsYXRlXG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VHJhbnNsYXRlIDwgbWluVHJhbnNsYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNsYXRlID0gbWluVHJhbnNsYXRlIC0gTWF0aC5wb3cobWluVHJhbnNsYXRlIC0gY3VycmVudFRyYW5zbGF0ZSwgMC44KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblRvID0gJ21pbic7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUcmFuc2xhdGUgPiBtYXhUcmFuc2xhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUcmFuc2xhdGUgPSBtYXhUcmFuc2xhdGUgKyBNYXRoLnBvdyhjdXJyZW50VHJhbnNsYXRlIC0gbWF4VHJhbnNsYXRlLCAwLjgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuVG8gPSAnbWF4JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyBUcmFuc2Zvcm0gd3JhcHBlclxuICAgICAgICAgICAgICAgICAgICBjb2wud3JhcHBlci50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDAsJyArIGN1cnJlbnRUcmFuc2xhdGUgKyAncHgsMCknKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBpdGVtc1xuICAgICAgICAgICAgICAgICAgICBjb2wudXBkYXRlSXRlbXModW5kZWZpbmVkLCBjdXJyZW50VHJhbnNsYXRlLCAwLCBwLnBhcmFtcy51cGRhdGVWYWx1ZXNPblRvdWNobW92ZSk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBDYWxjIHZlbG9jaXR5XG4gICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5VHJhbnNsYXRlID0gY3VycmVudFRyYW5zbGF0ZSAtIHByZXZUcmFuc2xhdGUgfHwgY3VycmVudFRyYW5zbGF0ZTtcbiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdHlUaW1lID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICAgICAgcHJldlRyYW5zbGF0ZSA9IGN1cnJlbnRUcmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoRW5kIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghaXNUb3VjaGVkIHx8ICFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICBjb2wud3JhcHBlci50cmFuc2l0aW9uKCcnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJldHVyblRvKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmV0dXJuVG8gPT09ICdtaW4nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sLndyYXBwZXIudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLCcgKyBtaW5UcmFuc2xhdGUgKyAncHgsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgY29sLndyYXBwZXIudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLCcgKyBtYXhUcmFuc2xhdGUgKyAncHgsMCknKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB0b3VjaEVuZFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHZlbG9jaXR5LCBuZXdUcmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0b3VjaEVuZFRpbWUgLSB0b3VjaFN0YXJ0VGltZSA+IDMwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3VHJhbnNsYXRlID0gY3VycmVudFRyYW5zbGF0ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZlbG9jaXR5ID0gTWF0aC5hYnModmVsb2NpdHlUcmFuc2xhdGUgLyAodG91Y2hFbmRUaW1lIC0gdmVsb2NpdHlUaW1lKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdUcmFuc2xhdGUgPSBjdXJyZW50VHJhbnNsYXRlICsgdmVsb2NpdHlUcmFuc2xhdGUgKiBwLnBhcmFtcy5tb21lbnR1bVJhdGlvO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBuZXdUcmFuc2xhdGUgPSBNYXRoLm1heChNYXRoLm1pbihuZXdUcmFuc2xhdGUsIG1heFRyYW5zbGF0ZSksIG1pblRyYW5zbGF0ZSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBBY3RpdmUgSW5kZXhcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFjdGl2ZUluZGV4ID0gLU1hdGguZmxvb3IoKG5ld1RyYW5zbGF0ZSAtIG1heFRyYW5zbGF0ZSkvaXRlbUhlaWdodCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWxpemUgdHJhbnNsYXRlXG4gICAgICAgICAgICAgICAgICAgIGlmICghcC5wYXJhbXMuZnJlZU1vZGUpIG5ld1RyYW5zbGF0ZSA9IC1hY3RpdmVJbmRleCAqIGl0ZW1IZWlnaHQgKyBtYXhUcmFuc2xhdGU7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBUcmFuc2Zvcm0gd3JhcHBlclxuICAgICAgICAgICAgICAgICAgICBjb2wud3JhcHBlci50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDAsJyArIChwYXJzZUludChuZXdUcmFuc2xhdGUsMTApKSArICdweCwwKScpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIGl0ZW1zXG4gICAgICAgICAgICAgICAgICAgIGNvbC51cGRhdGVJdGVtcyhhY3RpdmVJbmRleCwgbmV3VHJhbnNsYXRlLCAnJywgdHJ1ZSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBXYXRjaCBpdGVtc1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMudXBkYXRlVmFsdWVzT25Nb21lbnR1bSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlRHVyaW5nU2Nyb2xsKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb2wud3JhcHBlci50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJC5jYW5jZWxBbmltYXRpb25GcmFtZShhbmltYXRpb25GcmFtZUlkKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBBbGxvdyBjbGlja1xuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93SXRlbUNsaWNrID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfSwgMTAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZUNsaWNrKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFhbGxvd0l0ZW1DbGljaykgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAkLmNhbmNlbEFuaW1hdGlvbkZyYW1lKGFuaW1hdGlvbkZyYW1lSWQpO1xuICAgICAgICAgICAgICAgICAgICAvKmpzaGludCB2YWxpZHRoaXM6dHJ1ZSAqL1xuICAgICAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSAkKHRoaXMpLmF0dHIoJ2RhdGEtcGlja2VyLXZhbHVlJyk7XG4gICAgICAgICAgICAgICAgICAgIGNvbC5zZXRWYWx1ZSh2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBjb2wuaW5pdEV2ZW50cyA9IGZ1bmN0aW9uIChkZXRhY2gpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1ldGhvZCA9IGRldGFjaCA/ICdvZmYnIDogJ29uJztcbiAgICAgICAgICAgICAgICAgICAgY29sLmNvbnRhaW5lclttZXRob2RdKGFwcC50b3VjaEV2ZW50cy5zdGFydCwgaGFuZGxlVG91Y2hTdGFydCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbC5jb250YWluZXJbbWV0aG9kXShhcHAudG91Y2hFdmVudHMubW92ZSwgaGFuZGxlVG91Y2hNb3ZlKTtcbiAgICAgICAgICAgICAgICAgICAgY29sLmNvbnRhaW5lclttZXRob2RdKGFwcC50b3VjaEV2ZW50cy5lbmQsIGhhbmRsZVRvdWNoRW5kKTtcbiAgICAgICAgICAgICAgICAgICAgY29sLml0ZW1zW21ldGhvZF0oJ2NsaWNrJywgaGFuZGxlQ2xpY2spO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgY29sLmRlc3Ryb3lFdmVudHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbC5pbml0RXZlbnRzKHRydWUpO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbC5jb250YWluZXJbMF0uZjdEZXN0cm95UGlja2VyQ29sID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBjb2wuZGVzdHJveUV2ZW50cygpO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbC5pbml0RXZlbnRzKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHAuZGVzdHJveVBpY2tlckNvbCA9IGZ1bmN0aW9uIChjb2xDb250YWluZXIpIHtcbiAgICAgICAgICAgICAgICBjb2xDb250YWluZXIgPSAkKGNvbENvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgaWYgKCdmN0Rlc3Ryb3lQaWNrZXJDb2wnIGluIGNvbENvbnRhaW5lclswXSkgY29sQ29udGFpbmVyWzBdLmY3RGVzdHJveVBpY2tlckNvbCgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIC8vIFJlc2l6ZSBjb2xzXG4gICAgICAgICAgICBmdW5jdGlvbiByZXNpemVDb2xzKCkge1xuICAgICAgICAgICAgICAgIGlmICghcC5vcGVuZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHAuY29scy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXAuY29sc1tpXS5kaXZpZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLmNvbHNbaV0uY2FsY1NpemUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuY29sc1tpXS5zZXRWYWx1ZShwLmNvbHNbaV0udmFsdWUsIDAsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICQod2luZG93KS5vbigncmVzaXplJywgcmVzaXplQ29scyk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSFRNTCBMYXlvdXRcbiAgICAgICAgICAgIHAuY29sdW1uSFRNTCA9IGZ1bmN0aW9uIChjb2wsIG9ubHlJdGVtcykge1xuICAgICAgICAgICAgICAgIHZhciBjb2x1bW5JdGVtc0hUTUwgPSAnJztcbiAgICAgICAgICAgICAgICB2YXIgY29sdW1uSFRNTCA9ICcnO1xuICAgICAgICAgICAgICAgIGlmIChjb2wuZGl2aWRlcikge1xuICAgICAgICAgICAgICAgICAgICBjb2x1bW5IVE1MICs9ICc8ZGl2IGNsYXNzPVwicGlja2VyLWl0ZW1zLWNvbCBwaWNrZXItaXRlbXMtY29sLWRpdmlkZXIgJyArIChjb2wudGV4dEFsaWduID8gJ3BpY2tlci1pdGVtcy1jb2wtJyArIGNvbC50ZXh0QWxpZ24gOiAnJykgKyAnICcgKyAoY29sLmNzc0NsYXNzIHx8ICcnKSArICdcIj4nICsgY29sLmNvbnRlbnQgKyAnPC9kaXY+JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgY29sLnZhbHVlcy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uSXRlbXNIVE1MICs9ICc8ZGl2IGNsYXNzPVwicGlja2VyLWl0ZW1cIiBkYXRhLXBpY2tlci12YWx1ZT1cIicgKyBjb2wudmFsdWVzW2pdICsgJ1wiPicgKyAoY29sLmRpc3BsYXlWYWx1ZXMgPyBjb2wuZGlzcGxheVZhbHVlc1tqXSA6IGNvbC52YWx1ZXNbal0pICsgJzwvZGl2Pic7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY29sdW1uSFRNTCArPSAnPGRpdiBjbGFzcz1cInBpY2tlci1pdGVtcy1jb2wgJyArIChjb2wudGV4dEFsaWduID8gJ3BpY2tlci1pdGVtcy1jb2wtJyArIGNvbC50ZXh0QWxpZ24gOiAnJykgKyAnICcgKyAoY29sLmNzc0NsYXNzIHx8ICcnKSArICdcIj48ZGl2IGNsYXNzPVwicGlja2VyLWl0ZW1zLWNvbC13cmFwcGVyXCI+JyArIGNvbHVtbkl0ZW1zSFRNTCArICc8L2Rpdj48L2Rpdj4nO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gb25seUl0ZW1zID8gY29sdW1uSXRlbXNIVE1MIDogY29sdW1uSFRNTDtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwLmxheW91dCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgcGlja2VySFRNTCA9ICcnO1xuICAgICAgICAgICAgICAgIHZhciBwaWNrZXJDbGFzcyA9ICcnO1xuICAgICAgICAgICAgICAgIHZhciBpO1xuICAgICAgICAgICAgICAgIHAuY29scyA9IFtdO1xuICAgICAgICAgICAgICAgIHZhciBjb2xzSFRNTCA9ICcnO1xuICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwLnBhcmFtcy5jb2xzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjb2wgPSBwLnBhcmFtcy5jb2xzW2ldO1xuICAgICAgICAgICAgICAgICAgICBjb2xzSFRNTCArPSBwLmNvbHVtbkhUTUwocC5wYXJhbXMuY29sc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgIHAuY29scy5wdXNoKGNvbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHBpY2tlckNsYXNzID0gJ3BpY2tlci1tb2RhbCBwaWNrZXItY29sdW1ucyAnICsgKHAucGFyYW1zLmNzc0NsYXNzIHx8ICcnKSArIChwLnBhcmFtcy5yb3RhdGVFZmZlY3QgPyAnIHBpY2tlci0zZCcgOiAnJyk7XG4gICAgICAgICAgICAgICAgcGlja2VySFRNTCA9XG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiJyArIChwaWNrZXJDbGFzcykgKyAnXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAocC5wYXJhbXMudG9vbGJhciA/IHAucGFyYW1zLnRvb2xiYXJUZW1wbGF0ZS5yZXBsYWNlKC97e2Nsb3NlVGV4dH19L2csIHAucGFyYW1zLnRvb2xiYXJDbG9zZVRleHQpIDogJycpICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicGlja2VyLW1vZGFsLWlubmVyIHBpY2tlci1pdGVtc1wiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHNIVE1MICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBpY2tlci1jZW50ZXItaGlnaGxpZ2h0XCI+PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBwLnBpY2tlckhUTUwgPSBwaWNrZXJIVE1MOyAgICBcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5wdXQgRXZlbnRzXG4gICAgICAgICAgICBmdW5jdGlvbiBvcGVuT25JbnB1dChlKSB7XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIGlmIChwLm9wZW5lZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHAub3BlbigpO1xuICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5zY3JvbGxUb0lucHV0ICYmICFpc1BvcG92ZXIoKSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcGFnZUNvbnRlbnQgPSBwLmlucHV0LnBhcmVudHMoJy5wYWdlLWNvbnRlbnQnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2VDb250ZW50Lmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhZGRpbmdUb3AgPSBwYXJzZUludChwYWdlQ29udGVudC5jc3MoJ3BhZGRpbmctdG9wJyksIDEwKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZGRpbmdCb3R0b20gPSBwYXJzZUludChwYWdlQ29udGVudC5jc3MoJ3BhZGRpbmctYm90dG9tJyksIDEwKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VIZWlnaHQgPSBwYWdlQ29udGVudFswXS5vZmZzZXRIZWlnaHQgLSBwYWRkaW5nVG9wIC0gcC5jb250YWluZXIuaGVpZ2h0KCksXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlU2Nyb2xsSGVpZ2h0ID0gcGFnZUNvbnRlbnRbMF0uc2Nyb2xsSGVpZ2h0IC0gcGFkZGluZ1RvcCAtIHAuY29udGFpbmVyLmhlaWdodCgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGFkZGluZ0JvdHRvbTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlucHV0VG9wID0gcC5pbnB1dC5vZmZzZXQoKS50b3AgLSBwYWRkaW5nVG9wICsgcC5pbnB1dFswXS5vZmZzZXRIZWlnaHQ7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dFRvcCA+IHBhZ2VIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzY3JvbGxUb3AgPSBwYWdlQ29udGVudC5zY3JvbGxUb3AoKSArIGlucHV0VG9wIC0gcGFnZUhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzY3JvbGxUb3AgKyBwYWdlSGVpZ2h0ID4gcGFnZVNjcm9sbEhlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhZGRpbmdCb3R0b20gPSBzY3JvbGxUb3AgKyBwYWdlSGVpZ2h0IC0gcGFnZVNjcm9sbEhlaWdodCArIHBhZGRpbmdCb3R0b207XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhZ2VIZWlnaHQgPT09IHBhZ2VTY3JvbGxIZWlnaHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGFkZGluZ0JvdHRvbSA9IHAuY29udGFpbmVyLmhlaWdodCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdlQ29udGVudC5jc3MoeydwYWRkaW5nLWJvdHRvbSc6IChuZXdQYWRkaW5nQm90dG9tKSArICdweCd9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50LnNjcm9sbFRvcChzY3JvbGxUb3AsIDMwMCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBjbG9zZU9uSFRNTENsaWNrKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoaW5Qb3BvdmVyKCkpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAocC5pbnB1dCAmJiBwLmlucHV0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGUudGFyZ2V0ICE9PSBwLmlucHV0WzBdICYmICQoZS50YXJnZXQpLnBhcmVudHMoJy5waWNrZXItbW9kYWwnKS5sZW5ndGggPT09IDApIHAuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICgkKGUudGFyZ2V0KS5wYXJlbnRzKCcucGlja2VyLW1vZGFsJykubGVuZ3RoID09PSAwKSBwLmNsb3NlKCk7ICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmIChwLnBhcmFtcy5pbnB1dCkge1xuICAgICAgICAgICAgICAgIHAuaW5wdXQgPSAkKHAucGFyYW1zLmlucHV0KTtcbiAgICAgICAgICAgICAgICBpZiAocC5pbnB1dC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5pbnB1dFJlYWRPbmx5KSBwLmlucHV0LnByb3AoJ3JlYWRPbmx5JywgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcC5pbmxpbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuaW5wdXQub24oJ2NsaWNrJywgb3Blbk9uSW5wdXQpOyAgICBcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMuaW5wdXRSZWFkT25seSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5pbnB1dC5vbignZm9jdXMgbW91c2Vkb3duJywgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICghcC5pbmxpbmUgJiYgcC5wYXJhbXMuY2xvc2VCeU91dHNpZGVDbGljaykgJCgnaHRtbCcpLm9uKCdjbGljaycsIGNsb3NlT25IVE1MQ2xpY2spO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIE9wZW5cbiAgICAgICAgICAgIGZ1bmN0aW9uIG9uUGlja2VyQ2xvc2UoKSB7XG4gICAgICAgICAgICAgICAgcC5vcGVuZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAocC5pbnB1dCAmJiBwLmlucHV0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcC5pbnB1dC5wYXJlbnRzKCcucGFnZS1jb250ZW50JykuY3NzKHsncGFkZGluZy1ib3R0b20nOiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCkgcC5pbnB1dC50cmlnZ2VyKCdibHVyJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5vbkNsb3NlKSBwLnBhcmFtcy5vbkNsb3NlKHApO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBEZXN0cm95IGV2ZW50c1xuICAgICAgICAgICAgICAgIHAuY29udGFpbmVyLmZpbmQoJy5waWNrZXItaXRlbXMtY29sJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHAuZGVzdHJveVBpY2tlckNvbCh0aGlzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBwLm9wZW5lZCA9IGZhbHNlO1xuICAgICAgICAgICAgcC5vcGVuID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciB0b1BvcG92ZXIgPSBpc1BvcG92ZXIoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCFwLm9wZW5lZCkge1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gTGF5b3V0XG4gICAgICAgICAgICAgICAgICAgIHAubGF5b3V0KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBBcHBlbmRcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRvUG9wb3Zlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5waWNrZXJIVE1MID0gJzxkaXYgY2xhc3M9XCJwb3BvdmVyIHBvcG92ZXItcGlja2VyLWNvbHVtbnNcIj48ZGl2IGNsYXNzPVwicG9wb3Zlci1pbm5lclwiPicgKyBwLnBpY2tlckhUTUwgKyAnPC9kaXY+PC9kaXY+JztcbiAgICAgICAgICAgICAgICAgICAgICAgIHAucG9wb3ZlciA9IGFwcC5wb3BvdmVyKHAucGlja2VySFRNTCwgcC5wYXJhbXMuaW5wdXQsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXIgPSAkKHAucG9wb3ZlcikuZmluZCgnLnBpY2tlci1tb2RhbCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJChwLnBvcG92ZXIpLm9uKCdjbG9zZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblBpY2tlckNsb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChwLmlubGluZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXIgPSAkKHAucGlja2VySFRNTCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLmNvbnRhaW5lci5hZGRDbGFzcygncGlja2VyLW1vZGFsLWlubGluZScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJChwLnBhcmFtcy5jb250YWluZXIpLmFwcGVuZChwLmNvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLmNvbnRhaW5lciA9ICQoYXBwLnBpY2tlck1vZGFsKHAucGlja2VySFRNTCkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJChwLmNvbnRhaW5lcilcbiAgICAgICAgICAgICAgICAgICAgICAgIC5vbignY2xvc2UnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb25QaWNrZXJDbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIFN0b3JlIHBpY2tlciBpbnN0YW5jZVxuICAgICAgICAgICAgICAgICAgICBwLmNvbnRhaW5lclswXS5mN1BpY2tlciA9IHA7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBJbml0IEV2ZW50c1xuICAgICAgICAgICAgICAgICAgICBwLmNvbnRhaW5lci5maW5kKCcucGlja2VyLWl0ZW1zLWNvbCcpLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHVwZGF0ZUl0ZW1zID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoIXAuaW5pdGlhbGl6ZWQgJiYgcC5wYXJhbXMudmFsdWUpIHx8IChwLmluaXRpYWxpemVkICYmIHAudmFsdWUpKSB1cGRhdGVJdGVtcyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5pbml0UGlja2VyQ29sKHRoaXMsIHVwZGF0ZUl0ZW1zKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBTZXQgdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmluaXRpYWxpemVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocC52YWx1ZSkgcC5zZXRWYWx1ZShwLnZhbHVlLCAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHAucGFyYW1zLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5zZXRWYWx1ZShwLnBhcmFtcy52YWx1ZSwgMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocC52YWx1ZSkgcC5zZXRWYWx1ZShwLnZhbHVlLCAwKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gTWF0ZXJpYWwgRm9jdXNcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAuaW5wdXQgJiYgcC5pbnB1dC5sZW5ndGggPiAwICYmIGFwcC5wYXJhbXMubWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuaW5wdXQudHJpZ2dlcignZm9jdXMnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gU2V0IGZsYWdcbiAgICAgICAgICAgICAgICBwLm9wZW5lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgcC5pbml0aWFsaXplZCA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5vbk9wZW4pIHAucGFyYW1zLm9uT3BlbihwKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ2xvc2VcbiAgICAgICAgICAgIHAuY2xvc2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFwLm9wZW5lZCB8fCBwLmlubGluZSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmIChpblBvcG92ZXIoKSkge1xuICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbChwLnBvcG92ZXIpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBhcHAuY2xvc2VNb2RhbChwLmNvbnRhaW5lcik7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIERlc3Ryb3lcbiAgICAgICAgICAgIHAuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBwLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLmlucHV0ICYmIHAuaW5wdXQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBwLmlucHV0Lm9mZignY2xpY2sgZm9jdXMnLCBvcGVuT25JbnB1dCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICQoJ2h0bWwnKS5vZmYoJ2NsaWNrJywgY2xvc2VPbkhUTUxDbGljayk7XG4gICAgICAgICAgICAgICAgJCh3aW5kb3cpLm9mZigncmVzaXplJywgcmVzaXplQ29scyk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChwLmlubGluZSkge1xuICAgICAgICAgICAgICAgIHAub3BlbigpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKCFwLmluaXRpYWxpemVkICYmIHAucGFyYW1zLnZhbHVlKSBwLnNldFZhbHVlKHAucGFyYW1zLnZhbHVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gcDtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLnBpY2tlciA9IGZ1bmN0aW9uIChwYXJhbXMpIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUGlja2VyKHBhcmFtcyk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgQ2FsZW5kYXIgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgdmFyIENhbGVuZGFyID0gZnVuY3Rpb24gKHBhcmFtcykge1xuICAgICAgICAgICAgdmFyIHAgPSB0aGlzO1xuICAgICAgICAgICAgdmFyIGRlZmF1bHRzID0ge1xuICAgICAgICAgICAgICAgIG1vbnRoTmFtZXM6IFsnSmFudWFyeScsICdGZWJydWFyeScsICdNYXJjaCcsICdBcHJpbCcsICdNYXknLCAnSnVuZScsICdKdWx5JywgJ0F1Z3VzdCcgLCAnU2VwdGVtYmVyJyAsICdPY3RvYmVyJywgJ05vdmVtYmVyJywgJ0RlY2VtYmVyJ10sXG4gICAgICAgICAgICAgICAgbW9udGhOYW1lc1Nob3J0OiBbJ0phbicsICdGZWInLCAnTWFyJywgJ0FwcicsICdNYXknLCAnSnVuJywgJ0p1bCcsICdBdWcnLCAnU2VwJywgJ09jdCcsICdOb3YnLCAnRGVjJ10sXG4gICAgICAgICAgICAgICAgZGF5TmFtZXM6IFsnU3VuZGF5JywgJ01vbmRheScsICdUdWVzZGF5JywgJ1dlZG5lc2RheScsICdUaHVyc2RheScsICdGcmlkYXknLCAnU2F0dXJkYXknXSxcbiAgICAgICAgICAgICAgICBkYXlOYW1lc1Nob3J0OiBbJ1N1bicsICdNb24nLCAnVHVlJywgJ1dlZCcsICdUaHUnLCAnRnJpJywgJ1NhdCddLFxuICAgICAgICAgICAgICAgIGZpcnN0RGF5OiAxLCAvLyBGaXJzdCBkYXkgb2YgdGhlIHdlZWssIE1vbmRheVxuICAgICAgICAgICAgICAgIHdlZWtlbmREYXlzOiBbMCwgNl0sIC8vIFN1bmRheSBhbmQgU2F0dXJkYXlcbiAgICAgICAgICAgICAgICBtdWx0aXBsZTogZmFsc2UsXG4gICAgICAgICAgICAgICAgcmFuZ2VQaWNrZXI6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGRhdGVGb3JtYXQ6ICd5eXl5LW1tLWRkJyxcbiAgICAgICAgICAgICAgICBkaXJlY3Rpb246ICdob3Jpem9udGFsJywgLy8gb3IgJ3ZlcnRpY2FsJ1xuICAgICAgICAgICAgICAgIG1pbkRhdGU6IG51bGwsXG4gICAgICAgICAgICAgICAgbWF4RGF0ZTogbnVsbCxcbiAgICAgICAgICAgICAgICBkaXNhYmxlZDogbnVsbCwgLy8gZGF0ZXMgcmFuZ2Ugb2YgZGlzYWJsZWQgZGF5c1xuICAgICAgICAgICAgICAgIGV2ZW50czogbnVsbCwgLy8gZGF0ZXMgcmFuZ2Ugb2YgZGF5cyB3aXRoIGV2ZW50c1xuICAgICAgICAgICAgICAgIHJhbmdlc0NsYXNzZXM6IG51bGwsIC8vYXJyYXkgd2l0aCBjdXN0b20gY2xhc3NlcyBkYXRlIHJhbmdlc1xuICAgICAgICAgICAgICAgIHRvdWNoTW92ZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBhbmltYXRlOiB0cnVlLFxuICAgICAgICAgICAgICAgIGNsb3NlT25TZWxlY3Q6IGZhbHNlLFxuICAgICAgICAgICAgICAgIG1vbnRoUGlja2VyOiB0cnVlLFxuICAgICAgICAgICAgICAgIG1vbnRoUGlja2VyVGVtcGxhdGU6XG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicGlja2VyLWNhbGVuZGFyLW1vbnRoLXBpY2tlclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxhIGhyZWY9XCIjXCIgY2xhc3M9XCJsaW5rIGljb24tb25seSBwaWNrZXItY2FsZW5kYXItcHJldi1tb250aFwiPjxpIGNsYXNzPVwiaWNvbiBpY29uLXByZXZcIj48L2k+PC9hPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPVwiY3VycmVudC1tb250aC12YWx1ZVwiPjwvc3Bhbj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8YSBocmVmPVwiI1wiIGNsYXNzPVwibGluayBpY29uLW9ubHkgcGlja2VyLWNhbGVuZGFyLW5leHQtbW9udGhcIj48aSBjbGFzcz1cImljb24gaWNvbi1uZXh0XCI+PC9pPjwvYT4nICtcbiAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicsXG4gICAgICAgICAgICAgICAgeWVhclBpY2tlcjogdHJ1ZSxcbiAgICAgICAgICAgICAgICB5ZWFyUGlja2VyVGVtcGxhdGU6XG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicGlja2VyLWNhbGVuZGFyLXllYXItcGlja2VyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGEgaHJlZj1cIiNcIiBjbGFzcz1cImxpbmsgaWNvbi1vbmx5IHBpY2tlci1jYWxlbmRhci1wcmV2LXllYXJcIj48aSBjbGFzcz1cImljb24gaWNvbi1wcmV2XCI+PC9pPjwvYT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz1cImN1cnJlbnQteWVhci12YWx1ZVwiPjwvc3Bhbj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8YSBocmVmPVwiI1wiIGNsYXNzPVwibGluayBpY29uLW9ubHkgcGlja2VyLWNhbGVuZGFyLW5leHQteWVhclwiPjxpIGNsYXNzPVwiaWNvbiBpY29uLW5leHRcIj48L2k+PC9hPicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyxcbiAgICAgICAgICAgICAgICB3ZWVrSGVhZGVyOiB0cnVlLFxuICAgICAgICAgICAgICAgIC8vIENvbW1vbiBzZXR0aW5nc1xuICAgICAgICAgICAgICAgIGNsb3NlQnlPdXRzaWRlQ2xpY2s6IHRydWUsXG4gICAgICAgICAgICAgICAgc2Nyb2xsVG9JbnB1dDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBpbnB1dFJlYWRPbmx5OiB0cnVlLFxuICAgICAgICAgICAgICAgIGNvbnZlcnRUb1BvcG92ZXI6IHRydWUsXG4gICAgICAgICAgICAgICAgb25seUluUG9wb3ZlcjogZmFsc2UsXG4gICAgICAgICAgICAgICAgdG9vbGJhcjogdHJ1ZSxcbiAgICAgICAgICAgICAgICB0b29sYmFyQ2xvc2VUZXh0OiAnRG9uZScsXG4gICAgICAgICAgICAgICAgaGVhZGVyUGxhY2Vob2xkZXI6ICdTZWxlY3QgZGF0ZScsXG4gICAgICAgICAgICAgICAgaGVhZGVyOiBhcHAucGFyYW1zLm1hdGVyaWFsLFxuICAgICAgICAgICAgICAgIGZvb3RlcjogYXBwLnBhcmFtcy5tYXRlcmlhbCxcbiAgICAgICAgICAgICAgICB0b29sYmFyVGVtcGxhdGU6XG4gICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwidG9vbGJhclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJ0b29sYmFyLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7bW9udGhQaWNrZXJ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7e3llYXJQaWNrZXJ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyxcbiAgICAgICAgICAgICAgICBoZWFkZXJUZW1wbGF0ZTpcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJwaWNrZXItaGVhZGVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBpY2tlci1jYWxlbmRhci1zZWxlY3RlZC1kYXRlXCI+e3twbGFjZWhvbGRlcn19PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nLFxuICAgICAgICAgICAgICAgIGZvb3RlclRlbXBsYXRlOlxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cInBpY2tlci1mb290ZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8YSBocmVmPVwiI1wiIGNsYXNzPVwiYnV0dG9uIGNsb3NlLXBpY2tlclwiPnt7Y2xvc2VUZXh0fX08L2E+JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nLFxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvKiBDYWxsYmFja3NcbiAgICAgICAgICAgICAgICBvbk1vbnRoQWRkXG4gICAgICAgICAgICAgICAgb25DaGFuZ2VcbiAgICAgICAgICAgICAgICBvbk9wZW5cbiAgICAgICAgICAgICAgICBvbkNsb3NlXG4gICAgICAgICAgICAgICAgb25EYXlDbGlja1xuICAgICAgICAgICAgICAgIG9uTW9udGhZZWFyQ2hhbmdlU3RhcnRcbiAgICAgICAgICAgICAgICBvbk1vbnRoWWVhckNoYW5nZUVuZFxuICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xuICAgICAgICAgICAgZm9yICh2YXIgZGVmIGluIGRlZmF1bHRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXNbZGVmXSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zW2RlZl0gPSBkZWZhdWx0c1tkZWZdO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHAucGFyYW1zID0gcGFyYW1zO1xuICAgICAgICAgICAgcC5pbml0aWFsaXplZCA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIElubGluZSBmbGFnXG4gICAgICAgICAgICBwLmlubGluZSA9IHAucGFyYW1zLmNvbnRhaW5lciA/IHRydWUgOiBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJcyBob3Jpem9udGFsXG4gICAgICAgICAgICBwLmlzSCA9IHAucGFyYW1zLmRpcmVjdGlvbiA9PT0gJ2hvcml6b250YWwnO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFJUTCBpbnZlcnRlclxuICAgICAgICAgICAgdmFyIGludmVydGVyID0gcC5pc0ggPyAoYXBwLnJ0bCA/IC0xIDogMSkgOiAxO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEFuaW1hdGluZyBmbGFnXG4gICAgICAgICAgICBwLmFuaW1hdGluZyA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNob3VsZCBiZSBjb252ZXJ0ZWQgdG8gcG9wb3ZlclxuICAgICAgICAgICAgZnVuY3Rpb24gaXNQb3BvdmVyKCkge1xuICAgICAgICAgICAgICAgIHZhciB0b1BvcG92ZXIgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAoIXAucGFyYW1zLmNvbnZlcnRUb1BvcG92ZXIgJiYgIXAucGFyYW1zLm9ubHlJblBvcG92ZXIpIHJldHVybiB0b1BvcG92ZXI7XG4gICAgICAgICAgICAgICAgaWYgKCFwLmlubGluZSAmJiBwLnBhcmFtcy5pbnB1dCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMub25seUluUG9wb3ZlcikgdG9Qb3BvdmVyID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLmRldmljZS5pb3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b1BvcG92ZXIgPSBhcHAuZGV2aWNlLmlwYWQgPyB0cnVlIDogZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJCh3aW5kb3cpLndpZHRoKCkgPj0gNzY4KSB0b1BvcG92ZXIgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0b1BvcG92ZXI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBpblBvcG92ZXIoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHAub3BlbmVkICYmIHAuY29udGFpbmVyICYmIHAuY29udGFpbmVyLmxlbmd0aCA+IDAgJiYgcC5jb250YWluZXIucGFyZW50cygnLnBvcG92ZXInKS5sZW5ndGggPiAwKSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBGb3JtYXQgZGF0ZVxuICAgICAgICAgICAgZnVuY3Rpb24gZm9ybWF0RGF0ZShkYXRlKSB7XG4gICAgICAgICAgICAgICAgZGF0ZSA9IG5ldyBEYXRlKGRhdGUpO1xuICAgICAgICAgICAgICAgIHZhciB5ZWFyID0gZGF0ZS5nZXRGdWxsWWVhcigpO1xuICAgICAgICAgICAgICAgIHZhciBtb250aCA9IGRhdGUuZ2V0TW9udGgoKTtcbiAgICAgICAgICAgICAgICB2YXIgbW9udGgxID0gbW9udGggKyAxO1xuICAgICAgICAgICAgICAgIHZhciBkYXkgPSBkYXRlLmdldERhdGUoKTtcbiAgICAgICAgICAgICAgICB2YXIgd2Vla0RheSA9IGRhdGUuZ2V0RGF5KCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHJldHVybiBwLnBhcmFtcy5kYXRlRm9ybWF0XG4gICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC95eXl5L2csIHllYXIpXG4gICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC95eS9nLCAoeWVhciArICcnKS5zdWJzdHJpbmcoMikpXG4gICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9tbS9nLCBtb250aDEgPCAxMCA/ICcwJyArIG1vbnRoMSA6IG1vbnRoMSlcbiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL20oXFxXKykvZywgbW9udGgxICsgJyQxJylcbiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL01NL2csIHAucGFyYW1zLm1vbnRoTmFtZXNbbW9udGhdKVxuICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvTShcXFcrKS9nLCBwLnBhcmFtcy5tb250aE5hbWVzU2hvcnRbbW9udGhdICsgJyQxJylcbiAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL2RkL2csIGRheSA8IDEwID8gJzAnICsgZGF5IDogZGF5KVxuICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvZChcXFcrKS9nLCBkYXkgKyAnJDEnKVxuICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvREQvZywgcC5wYXJhbXMuZGF5TmFtZXNbd2Vla0RheV0pXG4gICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9EKFxcVyspL2csIHAucGFyYW1zLmRheU5hbWVzU2hvcnRbd2Vla0RheV0gKyAnJDEnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVmFsdWVcbiAgICAgICAgICAgIHAuYWRkVmFsdWUgPSBmdW5jdGlvbiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMubXVsdGlwbGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLnZhbHVlKSBwLnZhbHVlID0gW107XG4gICAgICAgICAgICAgICAgICAgIHZhciBpblZhbHVlc0luZGV4O1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHAudmFsdWUubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXcgRGF0ZSh2YWx1ZSkuZ2V0VGltZSgpID09PSBuZXcgRGF0ZShwLnZhbHVlW2ldKS5nZXRUaW1lKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpblZhbHVlc0luZGV4ID0gaTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluVmFsdWVzSW5kZXggPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLnZhbHVlLnB1c2godmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC52YWx1ZS5zcGxpY2UoaW5WYWx1ZXNJbmRleCwgMSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcC51cGRhdGVWYWx1ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChwLnBhcmFtcy5yYW5nZVBpY2tlcikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXAudmFsdWUpIHAudmFsdWUgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAudmFsdWUubGVuZ3RoID09PSAyIHx8IHAudmFsdWUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLnZhbHVlID0gW107XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHAudmFsdWVbMF0gIT09IHZhbHVlKSBwLnZhbHVlLnB1c2godmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHAudmFsdWUgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgcC52YWx1ZS5zb3J0KGZ1bmN0aW9uIChhLGIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhIC0gYjtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHAudXBkYXRlVmFsdWUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHAudmFsdWUgPSBbdmFsdWVdO1xuICAgICAgICAgICAgICAgICAgICBwLnVwZGF0ZVZhbHVlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHAuc2V0VmFsdWUgPSBmdW5jdGlvbiAoYXJyVmFsdWVzKSB7XG4gICAgICAgICAgICAgICAgcC52YWx1ZSA9IGFyclZhbHVlcztcbiAgICAgICAgICAgICAgICBwLnVwZGF0ZVZhbHVlKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcC51cGRhdGVWYWx1ZSA9IGZ1bmN0aW9uIChvbmx5SGVhZGVyKSB7XG4gICAgICAgICAgICAgICAgdmFyIGksIGlucHV0VmFsdWU7XG4gICAgICAgICAgICAgICAgaWYgKHAuY29udGFpbmVyICYmIHAuY29udGFpbmVyLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLmZpbmQoJy5waWNrZXItY2FsZW5kYXItZGF5LXNlbGVjdGVkJykucmVtb3ZlQ2xhc3MoJ3BpY2tlci1jYWxlbmRhci1kYXktc2VsZWN0ZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHZhbHVlRGF0ZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLnJhbmdlUGlja2VyICYmIHAudmFsdWUubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSBwLnZhbHVlWzBdOyBpIDw9IHAudmFsdWVbMV07IGkgKz0gMjQqNjAqNjAqMTAwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlRGF0ZSA9IG5ldyBEYXRlKGkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci5maW5kKCcucGlja2VyLWNhbGVuZGFyLWRheVtkYXRhLWRhdGU9XCInICsgdmFsdWVEYXRlLmdldEZ1bGxZZWFyKCkgKyAnLScgKyB2YWx1ZURhdGUuZ2V0TW9udGgoKSArICctJyArIHZhbHVlRGF0ZS5nZXREYXRlKCkgKyAnXCJdJykuYWRkQ2xhc3MoJ3BpY2tlci1jYWxlbmRhci1kYXktc2VsZWN0ZWQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwLnZhbHVlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVEYXRlID0gbmV3IERhdGUocC52YWx1ZVtpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLmZpbmQoJy5waWNrZXItY2FsZW5kYXItZGF5W2RhdGEtZGF0ZT1cIicgKyB2YWx1ZURhdGUuZ2V0RnVsbFllYXIoKSArICctJyArIHZhbHVlRGF0ZS5nZXRNb250aCgpICsgJy0nICsgdmFsdWVEYXRlLmdldERhdGUoKSArICdcIl0nKS5hZGRDbGFzcygncGlja2VyLWNhbGVuZGFyLWRheS1zZWxlY3RlZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMub25DaGFuZ2UpIHtcbiAgICAgICAgICAgICAgICAgICAgcC5wYXJhbXMub25DaGFuZ2UocCwgcC52YWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICgocC5pbnB1dCAmJiBwLmlucHV0Lmxlbmd0aCA+IDApIHx8IChhcHAucGFyYW1zLm1hdGVyaWFsICYmIHAucGFyYW1zLmhlYWRlcikpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLmZvcm1hdFZhbHVlKSBpbnB1dFZhbHVlID0gcC5wYXJhbXMuZm9ybWF0VmFsdWUocCwgcC52YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRWYWx1ZSA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHAudmFsdWUubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnB1dFZhbHVlLnB1c2goZm9ybWF0RGF0ZShwLnZhbHVlW2ldKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpbnB1dFZhbHVlID0gaW5wdXRWYWx1ZS5qb2luKHAucGFyYW1zLnJhbmdlUGlja2VyID8gJyAtICcgOiAnLCAnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBwLnBhcmFtcy5oZWFkZXIgJiYgcC5jb250YWluZXIgJiYgcC5jb250YWluZXIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1zZWxlY3RlZC1kYXRlJykudGV4dChpbnB1dFZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAocC5pbnB1dCAmJiBwLmlucHV0Lmxlbmd0aCA+IDAgJiYgIW9ubHlIZWFkZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQocC5pbnB1dCkudmFsKGlucHV0VmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgJChwLmlucHV0KS50cmlnZ2VyKCdjaGFuZ2UnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIENvbHVtbnMgSGFuZGxlcnNcbiAgICAgICAgICAgIHAuaW5pdENhbGVuZGFyRXZlbnRzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBjb2w7XG4gICAgICAgICAgICAgICAgdmFyIGFsbG93SXRlbUNsaWNrID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB2YXIgaXNUb3VjaGVkLCBpc01vdmVkLCB0b3VjaFN0YXJ0WCwgdG91Y2hTdGFydFksIHRvdWNoQ3VycmVudFgsIHRvdWNoQ3VycmVudFksIHRvdWNoU3RhcnRUaW1lLCB0b3VjaEVuZFRpbWUsIHN0YXJ0VHJhbnNsYXRlLCBjdXJyZW50VHJhbnNsYXRlLCB3cmFwcGVyV2lkdGgsIHdyYXBwZXJIZWlnaHQsIHBlcmNlbnRhZ2UsIHRvdWNoZXNEaWZmLCBpc1Njcm9sbGluZztcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0IChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpc01vdmVkIHx8IGlzVG91Y2hlZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAvLyBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRYID0gdG91Y2hDdXJyZW50WSA9IGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZS5wYWdlWDtcbiAgICAgICAgICAgICAgICAgICAgdG91Y2hTdGFydFkgPSB0b3VjaEN1cnJlbnRZID0gZS50eXBlID09PSAndG91Y2hzdGFydCcgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgOiBlLnBhZ2VZO1xuICAgICAgICAgICAgICAgICAgICB0b3VjaFN0YXJ0VGltZSA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgICAgIHBlcmNlbnRhZ2UgPSAwO1xuICAgICAgICAgICAgICAgICAgICBhbGxvd0l0ZW1DbGljayA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGlzU2Nyb2xsaW5nID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICBzdGFydFRyYW5zbGF0ZSA9IGN1cnJlbnRUcmFuc2xhdGUgPSBwLm1vbnRoc1RyYW5zbGF0ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlVG91Y2hNb3ZlIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghaXNUb3VjaGVkKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB0b3VjaEN1cnJlbnRYID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGUucGFnZVg7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoQ3VycmVudFkgPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpc1Njcm9sbGluZyA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzU2Nyb2xsaW5nID0gISEoaXNTY3JvbGxpbmcgfHwgTWF0aC5hYnModG91Y2hDdXJyZW50WSAtIHRvdWNoU3RhcnRZKSA+IE1hdGguYWJzKHRvdWNoQ3VycmVudFggLSB0b3VjaFN0YXJ0WCkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChwLmlzSCAmJiBpc1Njcm9sbGluZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5hbmltYXRpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGFsbG93SXRlbUNsaWNrID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGlmICghaXNNb3ZlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmlyc3QgbW92ZVxuICAgICAgICAgICAgICAgICAgICAgICAgaXNNb3ZlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB3cmFwcGVyV2lkdGggPSBwLndyYXBwZXJbMF0ub2Zmc2V0V2lkdGg7XG4gICAgICAgICAgICAgICAgICAgICAgICB3cmFwcGVySGVpZ2h0ID0gcC53cmFwcGVyWzBdLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci50cmFuc2l0aW9uKDApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHRvdWNoZXNEaWZmID0gcC5pc0ggPyB0b3VjaEN1cnJlbnRYIC0gdG91Y2hTdGFydFggOiB0b3VjaEN1cnJlbnRZIC0gdG91Y2hTdGFydFk7XG4gICAgICAgICAgICAgICAgICAgIHBlcmNlbnRhZ2UgPSB0b3VjaGVzRGlmZi8ocC5pc0ggPyB3cmFwcGVyV2lkdGggOiB3cmFwcGVySGVpZ2h0KTtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudFRyYW5zbGF0ZSA9IChwLm1vbnRoc1RyYW5zbGF0ZSAqIGludmVydGVyICsgcGVyY2VudGFnZSkgKiAxMDA7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBUcmFuc2Zvcm0gd3JhcHBlclxuICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHAuaXNIID8gY3VycmVudFRyYW5zbGF0ZSA6IDApICsgJyUsICcgKyAocC5pc0ggPyAwIDogY3VycmVudFRyYW5zbGF0ZSkgKyAnJSwgMCknKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZVRvdWNoRW5kIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghaXNUb3VjaGVkIHx8ICFpc01vdmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaXNUb3VjaGVkID0gaXNNb3ZlZCA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdG91Y2hFbmRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0b3VjaEVuZFRpbWUgLSB0b3VjaFN0YXJ0VGltZSA8IDMwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHRvdWNoZXNEaWZmKSA8IDEwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcC5yZXNldE1vbnRoKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0b3VjaGVzRGlmZiA+PSAxMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAucnRsKSBwLm5leHRNb250aCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcC5wcmV2TW9udGgoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAucnRsKSBwLnByZXZNb250aCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcC5uZXh0TW9udGgoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwZXJjZW50YWdlIDw9IC0wLjUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnJ0bCkgcC5wcmV2TW9udGgoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHAubmV4dE1vbnRoKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChwZXJjZW50YWdlID49IDAuNSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcHAucnRsKSBwLm5leHRNb250aCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcC5wcmV2TW9udGgoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAucmVzZXRNb250aCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBBbGxvdyBjbGlja1xuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93SXRlbUNsaWNrID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfSwgMTAwKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIGhhbmRsZURheUNsaWNrKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFhbGxvd0l0ZW1DbGljaykgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB2YXIgZGF5ID0gJChlLnRhcmdldCkucGFyZW50cygnLnBpY2tlci1jYWxlbmRhci1kYXknKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRheS5sZW5ndGggPT09IDAgJiYgJChlLnRhcmdldCkuaGFzQ2xhc3MoJ3BpY2tlci1jYWxlbmRhci1kYXknKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF5ID0gJChlLnRhcmdldCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGRheS5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRheS5oYXNDbGFzcygncGlja2VyLWNhbGVuZGFyLWRheS1zZWxlY3RlZCcpICYmICEocC5wYXJhbXMubXVsdGlwbGUgfHwgcC5wYXJhbXMucmFuZ2VQaWNrZXIpKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXkuaGFzQ2xhc3MoJ3BpY2tlci1jYWxlbmRhci1kYXktZGlzYWJsZWQnKSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXAucGFyYW1zLnJhbmdlUGlja2VyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF5Lmhhc0NsYXNzKCdwaWNrZXItY2FsZW5kYXItZGF5LW5leHQnKSkgcC5uZXh0TW9udGgoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXkuaGFzQ2xhc3MoJ3BpY2tlci1jYWxlbmRhci1kYXktcHJldicpKSBwLnByZXZNb250aCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHZhciBkYXRlWWVhciA9IGRheS5hdHRyKCdkYXRhLXllYXInKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGVNb250aCA9IGRheS5hdHRyKCdkYXRhLW1vbnRoJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBkYXRlRGF5ID0gZGF5LmF0dHIoJ2RhdGEtZGF5Jyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5vbkRheUNsaWNrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLnBhcmFtcy5vbkRheUNsaWNrKHAsIGRheVswXSwgZGF0ZVllYXIsIGRhdGVNb250aCwgZGF0ZURheSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcC5hZGRWYWx1ZShuZXcgRGF0ZShkYXRlWWVhciwgZGF0ZU1vbnRoLCBkYXRlRGF5KS5nZXRUaW1lKCkpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMuY2xvc2VPblNlbGVjdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLnJhbmdlUGlja2VyICYmIHAudmFsdWUubGVuZ3RoID09PSAyIHx8ICFwLnBhcmFtcy5yYW5nZVBpY2tlcikgcC5jbG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBwLmNvbnRhaW5lci5maW5kKCcucGlja2VyLWNhbGVuZGFyLXByZXYtbW9udGgnKS5vbignY2xpY2snLCBwLnByZXZNb250aCk7XG4gICAgICAgICAgICAgICAgcC5jb250YWluZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1uZXh0LW1vbnRoJykub24oJ2NsaWNrJywgcC5uZXh0TW9udGgpO1xuICAgICAgICAgICAgICAgIHAuY29udGFpbmVyLmZpbmQoJy5waWNrZXItY2FsZW5kYXItcHJldi15ZWFyJykub24oJ2NsaWNrJywgcC5wcmV2WWVhcik7XG4gICAgICAgICAgICAgICAgcC5jb250YWluZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1uZXh0LXllYXInKS5vbignY2xpY2snLCBwLm5leHRZZWFyKTtcbiAgICAgICAgICAgICAgICBwLndyYXBwZXIub24oJ2NsaWNrJywgaGFuZGxlRGF5Q2xpY2spO1xuICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy50b3VjaE1vdmUpIHtcbiAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLm9uKGFwcC50b3VjaEV2ZW50cy5zdGFydCwgaGFuZGxlVG91Y2hTdGFydCk7XG4gICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci5vbihhcHAudG91Y2hFdmVudHMubW92ZSwgaGFuZGxlVG91Y2hNb3ZlKTtcbiAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLm9uKGFwcC50b3VjaEV2ZW50cy5lbmQsIGhhbmRsZVRvdWNoRW5kKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHAuY29udGFpbmVyWzBdLmY3RGVzdHJveUNhbGVuZGFyRXZlbnRzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBwLmNvbnRhaW5lci5maW5kKCcucGlja2VyLWNhbGVuZGFyLXByZXYtbW9udGgnKS5vZmYoJ2NsaWNrJywgcC5wcmV2TW9udGgpO1xuICAgICAgICAgICAgICAgICAgICBwLmNvbnRhaW5lci5maW5kKCcucGlja2VyLWNhbGVuZGFyLW5leHQtbW9udGgnKS5vZmYoJ2NsaWNrJywgcC5uZXh0TW9udGgpO1xuICAgICAgICAgICAgICAgICAgICBwLmNvbnRhaW5lci5maW5kKCcucGlja2VyLWNhbGVuZGFyLXByZXYteWVhcicpLm9mZignY2xpY2snLCBwLnByZXZZZWFyKTtcbiAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1uZXh0LXllYXInKS5vZmYoJ2NsaWNrJywgcC5uZXh0WWVhcik7XG4gICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci5vZmYoJ2NsaWNrJywgaGFuZGxlRGF5Q2xpY2spO1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMudG91Y2hNb3ZlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIub2ZmKGFwcC50b3VjaEV2ZW50cy5zdGFydCwgaGFuZGxlVG91Y2hTdGFydCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIub2ZmKGFwcC50b3VjaEV2ZW50cy5tb3ZlLCBoYW5kbGVUb3VjaE1vdmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLm9mZihhcHAudG91Y2hFdmVudHMuZW5kLCBoYW5kbGVUb3VjaEVuZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcC5kZXN0cm95Q2FsZW5kYXJFdmVudHMgPSBmdW5jdGlvbiAoY29sQ29udGFpbmVyKSB7XG4gICAgICAgICAgICAgICAgaWYgKCdmN0Rlc3Ryb3lDYWxlbmRhckV2ZW50cycgaW4gcC5jb250YWluZXJbMF0pIHAuY29udGFpbmVyWzBdLmY3RGVzdHJveUNhbGVuZGFyRXZlbnRzKCk7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNjYW4gRGF0ZXMgUmFuZ2VcbiAgICAgICAgICAgIHAuZGF0ZUluUmFuZ2UgPSBmdW5jdGlvbiAoZGF5RGF0ZSwgcmFuZ2UpIHtcbiAgICAgICAgICAgICAgICB2YXIgbWF0Y2ggPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB2YXIgaTtcbiAgICAgICAgICAgICAgICBpZiAoIXJhbmdlKSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKCQuaXNBcnJheShyYW5nZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHJhbmdlLmxlbmd0aDsgaSArKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmdlW2ldLmZyb20gfHwgcmFuZ2VbaV0udG8pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmFuZ2VbaV0uZnJvbSAmJiByYW5nZVtpXS50bykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGRheURhdGUgPD0gbmV3IERhdGUocmFuZ2VbaV0udG8pLmdldFRpbWUoKSkgJiYgKGRheURhdGUgPj0gbmV3IERhdGUocmFuZ2VbaV0uZnJvbSkuZ2V0VGltZSgpKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJhbmdlW2ldLmZyb20pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRheURhdGUgPj0gbmV3IERhdGUocmFuZ2VbaV0uZnJvbSkuZ2V0VGltZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocmFuZ2VbaV0udG8pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRheURhdGUgPD0gbmV3IERhdGUocmFuZ2VbaV0udG8pLmdldFRpbWUoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXlEYXRlID09PSBuZXcgRGF0ZShyYW5nZVtpXSkuZ2V0VGltZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJhbmdlLmZyb20gfHwgcmFuZ2UudG8pIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJhbmdlLmZyb20gJiYgcmFuZ2UudG8pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoZGF5RGF0ZSA8PSBuZXcgRGF0ZShyYW5nZS50bykuZ2V0VGltZSgpKSAmJiAoZGF5RGF0ZSA+PSBuZXcgRGF0ZShyYW5nZS5mcm9tKS5nZXRUaW1lKCkpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJhbmdlLmZyb20pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXlEYXRlID49IG5ldyBEYXRlKHJhbmdlLmZyb20pLmdldFRpbWUoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChyYW5nZS50bykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRheURhdGUgPD0gbmV3IERhdGUocmFuZ2UudG8pLmdldFRpbWUoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgcmFuZ2UgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSByYW5nZShuZXcgRGF0ZShkYXlEYXRlKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBtYXRjaDtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICAvLyBDYWxlbmRhciBNZXRob2RzXG4gICAgICAgICAgICBwLmRheXNJbk1vbnRoID0gZnVuY3Rpb24gKGRhdGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgZCA9IG5ldyBEYXRlKGRhdGUpO1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShkLmdldEZ1bGxZZWFyKCksIGQuZ2V0TW9udGgoKSArIDEsIDApLmdldERhdGUoKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwLm1vbnRoSFRNTCA9IGZ1bmN0aW9uIChkYXRlLCBvZmZzZXQpIHtcbiAgICAgICAgICAgICAgICBkYXRlID0gbmV3IERhdGUoZGF0ZSk7XG4gICAgICAgICAgICAgICAgdmFyIHllYXIgPSBkYXRlLmdldEZ1bGxZZWFyKCksXG4gICAgICAgICAgICAgICAgICAgIG1vbnRoID0gZGF0ZS5nZXRNb250aCgpLFxuICAgICAgICAgICAgICAgICAgICBkYXkgPSBkYXRlLmdldERhdGUoKTtcbiAgICAgICAgICAgICAgICBpZiAob2Zmc2V0ID09PSAnbmV4dCcpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1vbnRoID09PSAxMSkgZGF0ZSA9IG5ldyBEYXRlKHllYXIgKyAxLCAwKTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBkYXRlID0gbmV3IERhdGUoeWVhciwgbW9udGggKyAxLCAxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG9mZnNldCA9PT0gJ3ByZXYnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtb250aCA9PT0gMCkgZGF0ZSA9IG5ldyBEYXRlKHllYXIgLSAxLCAxMSk7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgZGF0ZSA9IG5ldyBEYXRlKHllYXIsIG1vbnRoIC0gMSwgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChvZmZzZXQgPT09ICduZXh0JyB8fCBvZmZzZXQgPT09ICdwcmV2Jykge1xuICAgICAgICAgICAgICAgICAgICBtb250aCA9IGRhdGUuZ2V0TW9udGgoKTtcbiAgICAgICAgICAgICAgICAgICAgeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIGRheXNJblByZXZNb250aCA9IHAuZGF5c0luTW9udGgobmV3IERhdGUoZGF0ZS5nZXRGdWxsWWVhcigpLCBkYXRlLmdldE1vbnRoKCkpLmdldFRpbWUoKSAtIDEwICogMjQgKiA2MCAqIDYwICogMTAwMCksXG4gICAgICAgICAgICAgICAgICAgIGRheXNJbk1vbnRoID0gcC5kYXlzSW5Nb250aChkYXRlKSxcbiAgICAgICAgICAgICAgICAgICAgZmlyc3REYXlPZk1vbnRoSW5kZXggPSBuZXcgRGF0ZShkYXRlLmdldEZ1bGxZZWFyKCksIGRhdGUuZ2V0TW9udGgoKSkuZ2V0RGF5KCk7XG4gICAgICAgICAgICAgICAgaWYgKGZpcnN0RGF5T2ZNb250aEluZGV4ID09PSAwKSBmaXJzdERheU9mTW9udGhJbmRleCA9IDc7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBkYXlEYXRlLCBjdXJyZW50VmFsdWVzID0gW10sIGksIGosIGssXG4gICAgICAgICAgICAgICAgICAgIHJvd3MgPSA2LCBjb2xzID0gNyxcbiAgICAgICAgICAgICAgICAgICAgbW9udGhIVE1MID0gJycsXG4gICAgICAgICAgICAgICAgICAgIGRheUluZGV4ID0gMCArIChwLnBhcmFtcy5maXJzdERheSAtIDEpLFxuICAgICAgICAgICAgICAgICAgICB0b2RheSA9IG5ldyBEYXRlKCkuc2V0SG91cnMoMCwwLDAsMCksXG4gICAgICAgICAgICAgICAgICAgIG1pbkRhdGUgPSBwLnBhcmFtcy5taW5EYXRlID8gbmV3IERhdGUocC5wYXJhbXMubWluRGF0ZSkuZ2V0VGltZSgpIDogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgbWF4RGF0ZSA9IHAucGFyYW1zLm1heERhdGUgPyBuZXcgRGF0ZShwLnBhcmFtcy5tYXhEYXRlKS5nZXRUaW1lKCkgOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZCxcbiAgICAgICAgICAgICAgICAgICAgaGFzRXZlbnQ7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChwLnZhbHVlICYmIHAudmFsdWUubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwLnZhbHVlLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50VmFsdWVzLnB1c2gobmV3IERhdGUocC52YWx1ZVtpXSkuc2V0SG91cnMoMCwwLDAsMCkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBmb3IgKGkgPSAxOyBpIDw9IHJvd3M7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcm93SFRNTCA9ICcnO1xuICAgICAgICAgICAgICAgICAgICB2YXIgcm93ID0gaTtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMTsgaiA8PSBjb2xzOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb2wgPSBqO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF5SW5kZXggKys7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGF5TnVtYmVyID0gZGF5SW5kZXggLSBmaXJzdERheU9mTW9udGhJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3ZWVrRGF5SW5kZXggPSAoY29sIC0gMSArIHAucGFyYW1zLmZpcnN0RGF5ID4gNikgPyAoY29sIC0gMSAtIDcgKyBwLnBhcmFtcy5maXJzdERheSkgOiAoY29sIC0gMSArIHAucGFyYW1zLmZpcnN0RGF5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhZGRDbGFzcyA9ICcnO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRheU51bWJlciA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXlOdW1iZXIgPSBkYXlzSW5QcmV2TW9udGggKyBkYXlOdW1iZXIgKyAxO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZENsYXNzICs9ICcgcGlja2VyLWNhbGVuZGFyLWRheS1wcmV2JztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXlEYXRlID0gbmV3IERhdGUobW9udGggLSAxIDwgMCA/IHllYXIgLSAxIDogeWVhciwgbW9udGggLSAxIDwgMCA/IDExIDogbW9udGggLSAxLCBkYXlOdW1iZXIpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRheU51bWJlciA9IGRheU51bWJlciArIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRheU51bWJlciA+IGRheXNJbk1vbnRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRheU51bWJlciA9IGRheU51bWJlciAtIGRheXNJbk1vbnRoO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRDbGFzcyArPSAnIHBpY2tlci1jYWxlbmRhci1kYXktbmV4dCc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRheURhdGUgPSBuZXcgRGF0ZShtb250aCArIDEgPiAxMSA/IHllYXIgKyAxIDogeWVhciwgbW9udGggKyAxID4gMTEgPyAwIDogbW9udGggKyAxLCBkYXlOdW1iZXIpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRheURhdGUgPSBuZXcgRGF0ZSh5ZWFyLCBtb250aCwgZGF5TnVtYmVyKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVG9kYXlcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXlEYXRlID09PSB0b2RheSkgYWRkQ2xhc3MgKz0gJyBwaWNrZXItY2FsZW5kYXItZGF5LXRvZGF5JztcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNlbGVjdGVkXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMucmFuZ2VQaWNrZXIgJiYgY3VycmVudFZhbHVlcy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF5RGF0ZSA+PSBjdXJyZW50VmFsdWVzWzBdICYmIGRheURhdGUgPD0gY3VycmVudFZhbHVlc1sxXSkgYWRkQ2xhc3MgKz0gJyBwaWNrZXItY2FsZW5kYXItZGF5LXNlbGVjdGVkJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50VmFsdWVzLmluZGV4T2YoZGF5RGF0ZSkgPj0gMCkgYWRkQ2xhc3MgKz0gJyBwaWNrZXItY2FsZW5kYXItZGF5LXNlbGVjdGVkJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFdlZWtlbmRcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy53ZWVrZW5kRGF5cy5pbmRleE9mKHdlZWtEYXlJbmRleCkgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZENsYXNzICs9ICcgcGlja2VyLWNhbGVuZGFyLWRheS13ZWVrZW5kJztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEhhcyBFdmVudHNcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhc0V2ZW50ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMuZXZlbnRzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAuZGF0ZUluUmFuZ2UoZGF5RGF0ZSwgcC5wYXJhbXMuZXZlbnRzKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNFdmVudCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhc0V2ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkQ2xhc3MgKz0gJyBwaWNrZXItY2FsZW5kYXItZGF5LWhhcy1ldmVudHMnO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ3VzdG9tIFJhbmdlc1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLnJhbmdlc0NsYXNzZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGsgPSAwOyBrIDwgcC5wYXJhbXMucmFuZ2VzQ2xhc3Nlcy5sZW5ndGg7IGsrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5kYXRlSW5SYW5nZShkYXlEYXRlLCBwLnBhcmFtcy5yYW5nZXNDbGFzc2VzW2tdLnJhbmdlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkQ2xhc3MgKz0gJyAnICsgcC5wYXJhbXMucmFuZ2VzQ2xhc3Nlc1trXS5jc3NDbGFzcztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERpc2FibGVkXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKChtaW5EYXRlICYmIGRheURhdGUgPCBtaW5EYXRlKSB8fCAobWF4RGF0ZSAmJiBkYXlEYXRlID4gbWF4RGF0ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMuZGlzYWJsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5kYXRlSW5SYW5nZShkYXlEYXRlLCBwLnBhcmFtcy5kaXNhYmxlZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkaXNhYmxlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZENsYXNzICs9ICcgcGlja2VyLWNhbGVuZGFyLWRheS1kaXNhYmxlZCc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGRheURhdGUgPSBuZXcgRGF0ZShkYXlEYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkYXlZZWFyID0gZGF5RGF0ZS5nZXRGdWxsWWVhcigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRheU1vbnRoID0gZGF5RGF0ZS5nZXRNb250aCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcm93SFRNTCArPSAnPGRpdiBkYXRhLXllYXI9XCInICsgZGF5WWVhciArICdcIiBkYXRhLW1vbnRoPVwiJyArIGRheU1vbnRoICsgJ1wiIGRhdGEtZGF5PVwiJyArIGRheU51bWJlciArICdcIiBjbGFzcz1cInBpY2tlci1jYWxlbmRhci1kYXknICsgKGFkZENsYXNzKSArICdcIiBkYXRhLWRhdGU9XCInICsgKGRheVllYXIgKyAnLScgKyBkYXlNb250aCArICctJyArIGRheU51bWJlcikgKyAnXCI+PHNwYW4+JytkYXlOdW1iZXIrJzwvc3Bhbj48L2Rpdj4nO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIG1vbnRoSFRNTCArPSAnPGRpdiBjbGFzcz1cInBpY2tlci1jYWxlbmRhci1yb3dcIj4nICsgcm93SFRNTCArICc8L2Rpdj4nO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBtb250aEhUTUwgPSAnPGRpdiBjbGFzcz1cInBpY2tlci1jYWxlbmRhci1tb250aFwiIGRhdGEteWVhcj1cIicgKyB5ZWFyICsgJ1wiIGRhdGEtbW9udGg9XCInICsgbW9udGggKyAnXCI+JyArIG1vbnRoSFRNTCArICc8L2Rpdj4nO1xuICAgICAgICAgICAgICAgIHJldHVybiBtb250aEhUTUw7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcC5hbmltYXRpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgIHAudXBkYXRlQ3VycmVudE1vbnRoWWVhciA9IGZ1bmN0aW9uIChkaXIpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGRpciA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50TW9udGggPSBwYXJzZUludChwLm1vbnRocy5lcSgxKS5hdHRyKCdkYXRhLW1vbnRoJyksIDEwKTtcbiAgICAgICAgICAgICAgICAgICAgcC5jdXJyZW50WWVhciA9IHBhcnNlSW50KHAubW9udGhzLmVxKDEpLmF0dHIoJ2RhdGEteWVhcicpLCAxMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwLmN1cnJlbnRNb250aCA9IHBhcnNlSW50KHAubW9udGhzLmVxKGRpciA9PT0gJ25leHQnID8gKHAubW9udGhzLmxlbmd0aCAtIDEpIDogMCkuYXR0cignZGF0YS1tb250aCcpLCAxMCk7XG4gICAgICAgICAgICAgICAgICAgIHAuY3VycmVudFllYXIgPSBwYXJzZUludChwLm1vbnRocy5lcShkaXIgPT09ICduZXh0JyA/IChwLm1vbnRocy5sZW5ndGggLSAxKSA6IDApLmF0dHIoJ2RhdGEteWVhcicpLCAxMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHAuY29udGFpbmVyLmZpbmQoJy5jdXJyZW50LW1vbnRoLXZhbHVlJykudGV4dChwLnBhcmFtcy5tb250aE5hbWVzW3AuY3VycmVudE1vbnRoXSk7XG4gICAgICAgICAgICAgICAgcC5jb250YWluZXIuZmluZCgnLmN1cnJlbnQteWVhci12YWx1ZScpLnRleHQocC5jdXJyZW50WWVhcik7XG4gICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHAub25Nb250aENoYW5nZVN0YXJ0ID0gZnVuY3Rpb24gKGRpcikge1xuICAgICAgICAgICAgICAgIHAudXBkYXRlQ3VycmVudE1vbnRoWWVhcihkaXIpO1xuICAgICAgICAgICAgICAgIHAubW9udGhzLnJlbW92ZUNsYXNzKCdwaWNrZXItY2FsZW5kYXItbW9udGgtY3VycmVudCBwaWNrZXItY2FsZW5kYXItbW9udGgtcHJldiBwaWNrZXItY2FsZW5kYXItbW9udGgtbmV4dCcpO1xuICAgICAgICAgICAgICAgIHZhciBjdXJyZW50SW5kZXggPSBkaXIgPT09ICduZXh0JyA/IHAubW9udGhzLmxlbmd0aCAtIDEgOiAwO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBwLm1vbnRocy5lcShjdXJyZW50SW5kZXgpLmFkZENsYXNzKCdwaWNrZXItY2FsZW5kYXItbW9udGgtY3VycmVudCcpO1xuICAgICAgICAgICAgICAgIHAubW9udGhzLmVxKGRpciA9PT0gJ25leHQnID8gY3VycmVudEluZGV4IC0gMSA6IGN1cnJlbnRJbmRleCArIDEpLmFkZENsYXNzKGRpciA9PT0gJ25leHQnID8gJ3BpY2tlci1jYWxlbmRhci1tb250aC1wcmV2JyA6ICdwaWNrZXItY2FsZW5kYXItbW9udGgtbmV4dCcpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMub25Nb250aFllYXJDaGFuZ2VTdGFydCkge1xuICAgICAgICAgICAgICAgICAgICBwLnBhcmFtcy5vbk1vbnRoWWVhckNoYW5nZVN0YXJ0KHAsIHAuY3VycmVudFllYXIsIHAuY3VycmVudE1vbnRoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcC5vbk1vbnRoQ2hhbmdlRW5kID0gZnVuY3Rpb24gKGRpciwgcmVidWlsZEJvdGgpIHtcbiAgICAgICAgICAgICAgICBwLmFuaW1hdGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZhciBuZXh0TW9udGhIVE1MLCBwcmV2TW9udGhIVE1MLCBuZXdNb250aEhUTUw7XG4gICAgICAgICAgICAgICAgcC53cmFwcGVyLmZpbmQoJy5waWNrZXItY2FsZW5kYXItbW9udGg6bm90KC5waWNrZXItY2FsZW5kYXItbW9udGgtcHJldik6bm90KC5waWNrZXItY2FsZW5kYXItbW9udGgtY3VycmVudCk6bm90KC5waWNrZXItY2FsZW5kYXItbW9udGgtbmV4dCknKS5yZW1vdmUoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkaXIgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGRpciA9ICduZXh0JztcbiAgICAgICAgICAgICAgICAgICAgcmVidWlsZEJvdGggPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIXJlYnVpbGRCb3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIG5ld01vbnRoSFRNTCA9IHAubW9udGhIVE1MKG5ldyBEYXRlKHAuY3VycmVudFllYXIsIHAuY3VycmVudE1vbnRoKSwgZGlyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci5maW5kKCcucGlja2VyLWNhbGVuZGFyLW1vbnRoLW5leHQsIC5waWNrZXItY2FsZW5kYXItbW9udGgtcHJldicpLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICBwcmV2TW9udGhIVE1MID0gcC5tb250aEhUTUwobmV3IERhdGUocC5jdXJyZW50WWVhciwgcC5jdXJyZW50TW9udGgpLCAncHJldicpO1xuICAgICAgICAgICAgICAgICAgICBuZXh0TW9udGhIVE1MID0gcC5tb250aEhUTUwobmV3IERhdGUocC5jdXJyZW50WWVhciwgcC5jdXJyZW50TW9udGgpLCAnbmV4dCcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoZGlyID09PSAnbmV4dCcgfHwgcmVidWlsZEJvdGgpIHtcbiAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLmFwcGVuZChuZXdNb250aEhUTUwgfHwgbmV4dE1vbnRoSFRNTCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChkaXIgPT09ICdwcmV2JyB8fCByZWJ1aWxkQm90aCkge1xuICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIucHJlcGVuZChuZXdNb250aEhUTUwgfHwgcHJldk1vbnRoSFRNTCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHAubW9udGhzID0gcC53cmFwcGVyLmZpbmQoJy5waWNrZXItY2FsZW5kYXItbW9udGgnKTtcbiAgICAgICAgICAgICAgICBwLnNldE1vbnRoc1RyYW5zbGF0ZShwLm1vbnRoc1RyYW5zbGF0ZSk7XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm9uTW9udGhBZGQpIHtcbiAgICAgICAgICAgICAgICAgICAgcC5wYXJhbXMub25Nb250aEFkZChwLCBkaXIgPT09ICduZXh0JyA/IHAubW9udGhzLmVxKHAubW9udGhzLmxlbmd0aCAtIDEpWzBdIDogcC5tb250aHMuZXEoMClbMF0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMub25Nb250aFllYXJDaGFuZ2VFbmQpIHtcbiAgICAgICAgICAgICAgICAgICAgcC5wYXJhbXMub25Nb250aFllYXJDaGFuZ2VFbmQocCwgcC5jdXJyZW50WWVhciwgcC5jdXJyZW50TW9udGgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwLnNldE1vbnRoc1RyYW5zbGF0ZSA9IGZ1bmN0aW9uICh0cmFuc2xhdGUpIHtcbiAgICAgICAgICAgICAgICB0cmFuc2xhdGUgPSB0cmFuc2xhdGUgfHwgcC5tb250aHNUcmFuc2xhdGUgfHwgMDtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHAubW9udGhzVHJhbnNsYXRlID09PSAndW5kZWZpbmVkJykgcC5tb250aHNUcmFuc2xhdGUgPSB0cmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgcC5tb250aHMucmVtb3ZlQ2xhc3MoJ3BpY2tlci1jYWxlbmRhci1tb250aC1jdXJyZW50IHBpY2tlci1jYWxlbmRhci1tb250aC1wcmV2IHBpY2tlci1jYWxlbmRhci1tb250aC1uZXh0Jyk7XG4gICAgICAgICAgICAgICAgdmFyIHByZXZNb250aFRyYW5zbGF0ZSA9IC0odHJhbnNsYXRlICsgMSkgKiAxMDAgKiBpbnZlcnRlcjtcbiAgICAgICAgICAgICAgICB2YXIgY3VycmVudE1vbnRoVHJhbnNsYXRlID0gLXRyYW5zbGF0ZSAqIDEwMCAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgIHZhciBuZXh0TW9udGhUcmFuc2xhdGUgPSAtKHRyYW5zbGF0ZSAtIDEpICogMTAwICogaW52ZXJ0ZXI7XG4gICAgICAgICAgICAgICAgcC5tb250aHMuZXEoMCkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHAuaXNIID8gcHJldk1vbnRoVHJhbnNsYXRlIDogMCkgKyAnJSwgJyArIChwLmlzSCA/IDAgOiBwcmV2TW9udGhUcmFuc2xhdGUpICsgJyUsIDApJykuYWRkQ2xhc3MoJ3BpY2tlci1jYWxlbmRhci1tb250aC1wcmV2Jyk7XG4gICAgICAgICAgICAgICAgcC5tb250aHMuZXEoMSkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHAuaXNIID8gY3VycmVudE1vbnRoVHJhbnNsYXRlIDogMCkgKyAnJSwgJyArIChwLmlzSCA/IDAgOiBjdXJyZW50TW9udGhUcmFuc2xhdGUpICsgJyUsIDApJykuYWRkQ2xhc3MoJ3BpY2tlci1jYWxlbmRhci1tb250aC1jdXJyZW50Jyk7XG4gICAgICAgICAgICAgICAgcC5tb250aHMuZXEoMikudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHAuaXNIID8gbmV4dE1vbnRoVHJhbnNsYXRlIDogMCkgKyAnJSwgJyArIChwLmlzSCA/IDAgOiBuZXh0TW9udGhUcmFuc2xhdGUpICsgJyUsIDApJykuYWRkQ2xhc3MoJ3BpY2tlci1jYWxlbmRhci1tb250aC1uZXh0Jyk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcC5uZXh0TW9udGggPSBmdW5jdGlvbiAodHJhbnNpdGlvbikge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHJhbnNpdGlvbiA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIHRyYW5zaXRpb24gPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb24gPSAnJztcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLnBhcmFtcy5hbmltYXRlKSB0cmFuc2l0aW9uID0gMDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIG5leHRNb250aCA9IHBhcnNlSW50KHAubW9udGhzLmVxKHAubW9udGhzLmxlbmd0aCAtIDEpLmF0dHIoJ2RhdGEtbW9udGgnKSwgMTApO1xuICAgICAgICAgICAgICAgIHZhciBuZXh0WWVhciA9IHBhcnNlSW50KHAubW9udGhzLmVxKHAubW9udGhzLmxlbmd0aCAtIDEpLmF0dHIoJ2RhdGEteWVhcicpLCAxMCk7XG4gICAgICAgICAgICAgICAgdmFyIG5leHREYXRlID0gbmV3IERhdGUobmV4dFllYXIsIG5leHRNb250aCk7XG4gICAgICAgICAgICAgICAgdmFyIG5leHREYXRlVGltZSA9IG5leHREYXRlLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICB2YXIgdHJhbnNpdGlvbkVuZENhbGxiYWNrID0gcC5hbmltYXRpbmcgPyBmYWxzZSA6IHRydWU7XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm1heERhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5leHREYXRlVGltZSA+IG5ldyBEYXRlKHAucGFyYW1zLm1heERhdGUpLmdldFRpbWUoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHAucmVzZXRNb250aCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHAubW9udGhzVHJhbnNsYXRlIC0tO1xuICAgICAgICAgICAgICAgIGlmIChuZXh0TW9udGggPT09IHAuY3VycmVudE1vbnRoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXh0TW9udGhUcmFuc2xhdGUgPSAtKHAubW9udGhzVHJhbnNsYXRlKSAqIDEwMCAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dE1vbnRoSFRNTCA9ICQocC5tb250aEhUTUwobmV4dERhdGVUaW1lLCAnbmV4dCcpKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAocC5pc0ggPyBuZXh0TW9udGhUcmFuc2xhdGUgOiAwKSArICclLCAnICsgKHAuaXNIID8gMCA6IG5leHRNb250aFRyYW5zbGF0ZSkgKyAnJSwgMCknKS5hZGRDbGFzcygncGlja2VyLWNhbGVuZGFyLW1vbnRoLW5leHQnKTtcbiAgICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLmFwcGVuZChuZXh0TW9udGhIVE1MWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgcC5tb250aHMgPSBwLndyYXBwZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1tb250aCcpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMub25Nb250aEFkZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5wYXJhbXMub25Nb250aEFkZChwLCBwLm1vbnRocy5lcShwLm1vbnRocy5sZW5ndGggLSAxKVswXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcC5hbmltYXRpbmcgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHAub25Nb250aENoYW5nZVN0YXJ0KCduZXh0Jyk7XG4gICAgICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZSA9IChwLm1vbnRoc1RyYW5zbGF0ZSAqIDEwMCkgKiBpbnZlcnRlcjtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcC53cmFwcGVyLnRyYW5zaXRpb24odHJhbnNpdGlvbikudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHAuaXNIID8gdHJhbnNsYXRlIDogMCkgKyAnJSwgJyArIChwLmlzSCA/IDAgOiB0cmFuc2xhdGUpICsgJyUsIDApJyk7XG4gICAgICAgICAgICAgICAgaWYgKHRyYW5zaXRpb25FbmRDYWxsYmFjaykge1xuICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLm9uTW9udGhDaGFuZ2VFbmQoJ25leHQnKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghcC5wYXJhbXMuYW5pbWF0ZSkge1xuICAgICAgICAgICAgICAgICAgICBwLm9uTW9udGhDaGFuZ2VFbmQoJ25leHQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcC5wcmV2TW9udGggPSBmdW5jdGlvbiAodHJhbnNpdGlvbikge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHJhbnNpdGlvbiA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIHRyYW5zaXRpb24gPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyYW5zaXRpb24gPSAnJztcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLnBhcmFtcy5hbmltYXRlKSB0cmFuc2l0aW9uID0gMDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIHByZXZNb250aCA9IHBhcnNlSW50KHAubW9udGhzLmVxKDApLmF0dHIoJ2RhdGEtbW9udGgnKSwgMTApO1xuICAgICAgICAgICAgICAgIHZhciBwcmV2WWVhciA9IHBhcnNlSW50KHAubW9udGhzLmVxKDApLmF0dHIoJ2RhdGEteWVhcicpLCAxMCk7XG4gICAgICAgICAgICAgICAgdmFyIHByZXZEYXRlID0gbmV3IERhdGUocHJldlllYXIsIHByZXZNb250aCArIDEsIC0xKTtcbiAgICAgICAgICAgICAgICB2YXIgcHJldkRhdGVUaW1lID0gcHJldkRhdGUuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgIHZhciB0cmFuc2l0aW9uRW5kQ2FsbGJhY2sgPSBwLmFuaW1hdGluZyA/IGZhbHNlIDogdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMubWluRGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocHJldkRhdGVUaW1lIDwgbmV3IERhdGUocC5wYXJhbXMubWluRGF0ZSkuZ2V0VGltZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcC5yZXNldE1vbnRoKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcC5tb250aHNUcmFuc2xhdGUgKys7XG4gICAgICAgICAgICAgICAgaWYgKHByZXZNb250aCA9PT0gcC5jdXJyZW50TW9udGgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZNb250aFRyYW5zbGF0ZSA9IC0ocC5tb250aHNUcmFuc2xhdGUpICogMTAwICogaW52ZXJ0ZXI7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwcmV2TW9udGhIVE1MID0gJChwLm1vbnRoSFRNTChwcmV2RGF0ZVRpbWUsICdwcmV2JykpLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIChwLmlzSCA/IHByZXZNb250aFRyYW5zbGF0ZSA6IDApICsgJyUsICcgKyAocC5pc0ggPyAwIDogcHJldk1vbnRoVHJhbnNsYXRlKSArICclLCAwKScpLmFkZENsYXNzKCdwaWNrZXItY2FsZW5kYXItbW9udGgtcHJldicpO1xuICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIucHJlcGVuZChwcmV2TW9udGhIVE1MWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgcC5tb250aHMgPSBwLndyYXBwZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1tb250aCcpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMub25Nb250aEFkZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5wYXJhbXMub25Nb250aEFkZChwLCBwLm1vbnRocy5lcSgwKVswXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcC5hbmltYXRpbmcgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHAub25Nb250aENoYW5nZVN0YXJ0KCdwcmV2Jyk7XG4gICAgICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZSA9IChwLm1vbnRoc1RyYW5zbGF0ZSAqIDEwMCkgKiBpbnZlcnRlcjtcbiAgICAgICAgICAgICAgICBwLndyYXBwZXIudHJhbnNpdGlvbih0cmFuc2l0aW9uKS50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKCcgKyAocC5pc0ggPyB0cmFuc2xhdGUgOiAwKSArICclLCAnICsgKHAuaXNIID8gMCA6IHRyYW5zbGF0ZSkgKyAnJSwgMCknKTtcbiAgICAgICAgICAgICAgICBpZiAodHJhbnNpdGlvbkVuZENhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAub25Nb250aENoYW5nZUVuZCgncHJldicpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFwLnBhcmFtcy5hbmltYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIHAub25Nb250aENoYW5nZUVuZCgncHJldicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBwLnJlc2V0TW9udGggPSBmdW5jdGlvbiAodHJhbnNpdGlvbikge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHJhbnNpdGlvbiA9PT0gJ3VuZGVmaW5lZCcpIHRyYW5zaXRpb24gPSAnJztcbiAgICAgICAgICAgICAgICB2YXIgdHJhbnNsYXRlID0gKHAubW9udGhzVHJhbnNsYXRlICogMTAwKSAqIGludmVydGVyO1xuICAgICAgICAgICAgICAgIHAud3JhcHBlci50cmFuc2l0aW9uKHRyYW5zaXRpb24pLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIChwLmlzSCA/IHRyYW5zbGF0ZSA6IDApICsgJyUsICcgKyAocC5pc0ggPyAwIDogdHJhbnNsYXRlKSArICclLCAwKScpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHAuc2V0WWVhck1vbnRoID0gZnVuY3Rpb24gKHllYXIsIG1vbnRoLCB0cmFuc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB5ZWFyID09PSAndW5kZWZpbmVkJykgeWVhciA9IHAuY3VycmVudFllYXI7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBtb250aCA9PT0gJ3VuZGVmaW5lZCcpIG1vbnRoID0gcC5jdXJyZW50TW9udGg7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0cmFuc2l0aW9uID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgdHJhbnNpdGlvbiA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgdHJhbnNpdGlvbiA9ICcnO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXAucGFyYW1zLmFuaW1hdGUpIHRyYW5zaXRpb24gPSAwO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0RGF0ZTtcbiAgICAgICAgICAgICAgICBpZiAoeWVhciA8IHAuY3VycmVudFllYXIpIHtcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RGF0ZSA9IG5ldyBEYXRlKHllYXIsIG1vbnRoICsgMSwgLTEpLmdldFRpbWUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRhcmdldERhdGUgPSBuZXcgRGF0ZSh5ZWFyLCBtb250aCkuZ2V0VGltZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMubWF4RGF0ZSAmJiB0YXJnZXREYXRlID4gbmV3IERhdGUocC5wYXJhbXMubWF4RGF0ZSkuZ2V0VGltZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm1pbkRhdGUgJiYgdGFyZ2V0RGF0ZSA8IG5ldyBEYXRlKHAucGFyYW1zLm1pbkRhdGUpLmdldFRpbWUoKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBjdXJyZW50RGF0ZSA9IG5ldyBEYXRlKHAuY3VycmVudFllYXIsIHAuY3VycmVudE1vbnRoKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgdmFyIGRpciA9IHRhcmdldERhdGUgPiBjdXJyZW50RGF0ZSA/ICduZXh0JyA6ICdwcmV2JztcbiAgICAgICAgICAgICAgICB2YXIgbmV3TW9udGhIVE1MID0gcC5tb250aEhUTUwobmV3IERhdGUoeWVhciwgbW9udGgpKTtcbiAgICAgICAgICAgICAgICBwLm1vbnRoc1RyYW5zbGF0ZSA9IHAubW9udGhzVHJhbnNsYXRlIHx8IDA7XG4gICAgICAgICAgICAgICAgdmFyIHByZXZUcmFuc2xhdGUgPSBwLm1vbnRoc1RyYW5zbGF0ZTtcbiAgICAgICAgICAgICAgICB2YXIgbW9udGhUcmFuc2xhdGUsIHdyYXBwZXJUcmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgdmFyIHRyYW5zaXRpb25FbmRDYWxsYmFjayA9IHAuYW5pbWF0aW5nID8gZmFsc2UgOiB0cnVlO1xuICAgICAgICAgICAgICAgIGlmICh0YXJnZXREYXRlID4gY3VycmVudERhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gVG8gbmV4dFxuICAgICAgICAgICAgICAgICAgICBwLm1vbnRoc1RyYW5zbGF0ZSAtLTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmFuaW1hdGluZykgcC5tb250aHMuZXEocC5tb250aHMubGVuZ3RoIC0gMSkucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIHAud3JhcHBlci5hcHBlbmQobmV3TW9udGhIVE1MKTtcbiAgICAgICAgICAgICAgICAgICAgcC5tb250aHMgPSBwLndyYXBwZXIuZmluZCgnLnBpY2tlci1jYWxlbmRhci1tb250aCcpO1xuICAgICAgICAgICAgICAgICAgICBtb250aFRyYW5zbGF0ZSA9IC0ocHJldlRyYW5zbGF0ZSAtIDEpICogMTAwICogaW52ZXJ0ZXI7XG4gICAgICAgICAgICAgICAgICAgIHAubW9udGhzLmVxKHAubW9udGhzLmxlbmd0aCAtIDEpLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIChwLmlzSCA/IG1vbnRoVHJhbnNsYXRlIDogMCkgKyAnJSwgJyArIChwLmlzSCA/IDAgOiBtb250aFRyYW5zbGF0ZSkgKyAnJSwgMCknKS5hZGRDbGFzcygncGlja2VyLWNhbGVuZGFyLW1vbnRoLW5leHQnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFRvIHByZXZcbiAgICAgICAgICAgICAgICAgICAgcC5tb250aHNUcmFuc2xhdGUgKys7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcC5hbmltYXRpbmcpIHAubW9udGhzLmVxKDApLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICBwLndyYXBwZXIucHJlcGVuZChuZXdNb250aEhUTUwpO1xuICAgICAgICAgICAgICAgICAgICBwLm1vbnRocyA9IHAud3JhcHBlci5maW5kKCcucGlja2VyLWNhbGVuZGFyLW1vbnRoJyk7XG4gICAgICAgICAgICAgICAgICAgIG1vbnRoVHJhbnNsYXRlID0gLShwcmV2VHJhbnNsYXRlICsgMSkgKiAxMDAgKiBpbnZlcnRlcjtcbiAgICAgICAgICAgICAgICAgICAgcC5tb250aHMuZXEoMCkudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHAuaXNIID8gbW9udGhUcmFuc2xhdGUgOiAwKSArICclLCAnICsgKHAuaXNIID8gMCA6IG1vbnRoVHJhbnNsYXRlKSArICclLCAwKScpLmFkZENsYXNzKCdwaWNrZXItY2FsZW5kYXItbW9udGgtcHJldicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMub25Nb250aEFkZCkge1xuICAgICAgICAgICAgICAgICAgICBwLnBhcmFtcy5vbk1vbnRoQWRkKHAsIGRpciA9PT0gJ25leHQnID8gcC5tb250aHMuZXEocC5tb250aHMubGVuZ3RoIC0gMSlbMF0gOiBwLm1vbnRocy5lcSgwKVswXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHAuYW5pbWF0aW5nID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBwLm9uTW9udGhDaGFuZ2VTdGFydChkaXIpO1xuICAgICAgICAgICAgICAgIHdyYXBwZXJUcmFuc2xhdGUgPSAocC5tb250aHNUcmFuc2xhdGUgKiAxMDApICogaW52ZXJ0ZXI7XG4gICAgICAgICAgICAgICAgcC53cmFwcGVyLnRyYW5zaXRpb24odHJhbnNpdGlvbikudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKHAuaXNIID8gd3JhcHBlclRyYW5zbGF0ZSA6IDApICsgJyUsICcgKyAocC5pc0ggPyAwIDogd3JhcHBlclRyYW5zbGF0ZSkgKyAnJSwgMCknKTtcbiAgICAgICAgICAgICAgICBpZiAodHJhbnNpdGlvbkVuZENhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgICAgcC53cmFwcGVyLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5vbk1vbnRoQ2hhbmdlRW5kKGRpciwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIXAucGFyYW1zLmFuaW1hdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcC5vbk1vbnRoQ2hhbmdlRW5kKGRpcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHAubmV4dFllYXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcC5zZXRZZWFyTW9udGgocC5jdXJyZW50WWVhciArIDEpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHAucHJldlllYXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcC5zZXRZZWFyTW9udGgocC5jdXJyZW50WWVhciAtIDEpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSFRNTCBMYXlvdXRcbiAgICAgICAgICAgIHAubGF5b3V0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBwaWNrZXJIVE1MID0gJyc7XG4gICAgICAgICAgICAgICAgdmFyIHBpY2tlckNsYXNzID0gJyc7XG4gICAgICAgICAgICAgICAgdmFyIGk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBsYXlvdXREYXRlID0gcC52YWx1ZSAmJiBwLnZhbHVlLmxlbmd0aCA/IHAudmFsdWVbMF0gOiBuZXcgRGF0ZSgpLnNldEhvdXJzKDAsMCwwLDApO1xuICAgICAgICAgICAgICAgIHZhciBwcmV2TW9udGhIVE1MID0gcC5tb250aEhUTUwobGF5b3V0RGF0ZSwgJ3ByZXYnKTtcbiAgICAgICAgICAgICAgICB2YXIgY3VycmVudE1vbnRoSFRNTCA9IHAubW9udGhIVE1MKGxheW91dERhdGUpO1xuICAgICAgICAgICAgICAgIHZhciBuZXh0TW9udGhIVE1MID0gcC5tb250aEhUTUwobGF5b3V0RGF0ZSwgJ25leHQnKTtcbiAgICAgICAgICAgICAgICB2YXIgbW9udGhzSFRNTCA9ICc8ZGl2IGNsYXNzPVwicGlja2VyLWNhbGVuZGFyLW1vbnRoc1wiPjxkaXYgY2xhc3M9XCJwaWNrZXItY2FsZW5kYXItbW9udGhzLXdyYXBwZXJcIj4nICsgKHByZXZNb250aEhUTUwgKyBjdXJyZW50TW9udGhIVE1MICsgbmV4dE1vbnRoSFRNTCkgKyAnPC9kaXY+PC9kaXY+JztcbiAgICAgICAgICAgICAgICAvLyBXZWVrIGRheXMgaGVhZGVyXG4gICAgICAgICAgICAgICAgdmFyIHdlZWtIZWFkZXJIVE1MID0gJyc7XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLndlZWtIZWFkZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IDc7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHdlZWtEYXlJbmRleCA9IChpICsgcC5wYXJhbXMuZmlyc3REYXkgPiA2KSA/IChpIC0gNyArIHAucGFyYW1zLmZpcnN0RGF5KSA6IChpICsgcC5wYXJhbXMuZmlyc3REYXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRheU5hbWUgPSBwLnBhcmFtcy5kYXlOYW1lc1Nob3J0W3dlZWtEYXlJbmRleF07XG4gICAgICAgICAgICAgICAgICAgICAgICB3ZWVrSGVhZGVySFRNTCArPSAnPGRpdiBjbGFzcz1cInBpY2tlci1jYWxlbmRhci13ZWVrLWRheSAnICsgKChwLnBhcmFtcy53ZWVrZW5kRGF5cy5pbmRleE9mKHdlZWtEYXlJbmRleCkgPj0gMCkgPyAncGlja2VyLWNhbGVuZGFyLXdlZWstZGF5LXdlZWtlbmQnIDogJycpICsgJ1wiPiAnICsgZGF5TmFtZSArICc8L2Rpdj4nO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB3ZWVrSGVhZGVySFRNTCA9ICc8ZGl2IGNsYXNzPVwicGlja2VyLWNhbGVuZGFyLXdlZWstZGF5c1wiPicgKyB3ZWVrSGVhZGVySFRNTCArICc8L2Rpdj4nO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwaWNrZXJDbGFzcyA9ICdwaWNrZXItbW9kYWwgcGlja2VyLWNhbGVuZGFyJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKHAucGFyYW1zLnJhbmdlUGlja2VyID8gJyBwaWNrZXItY2FsZW5kYXItcmFuZ2UnIDogJycpICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAocC5wYXJhbXMuY3NzQ2xhc3MgPyAnICcgKyBwLnBhcmFtcy5jc3NDbGFzcyA6ICcnKTtcbiAgICAgICAgICAgICAgICB2YXIgdG9vbGJhckhUTUwgPSBwLnBhcmFtcy50b29sYmFyID8gcC5wYXJhbXMudG9vbGJhclRlbXBsYXRlLnJlcGxhY2UoL3t7Y2xvc2VUZXh0fX0vZywgcC5wYXJhbXMudG9vbGJhckNsb3NlVGV4dCkgOiAnJztcbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMudG9vbGJhcikge1xuICAgICAgICAgICAgICAgICAgICB0b29sYmFySFRNTCA9IHAucGFyYW1zLnRvb2xiYXJUZW1wbGF0ZVxuICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL3t7Y2xvc2VUZXh0fX0vZywgcC5wYXJhbXMudG9vbGJhckNsb3NlVGV4dClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC97e21vbnRoUGlja2VyfX0vZywgKHAucGFyYW1zLm1vbnRoUGlja2VyID8gcC5wYXJhbXMubW9udGhQaWNrZXJUZW1wbGF0ZSA6ICcnKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC97e3llYXJQaWNrZXJ9fS9nLCAocC5wYXJhbXMueWVhclBpY2tlciA/IHAucGFyYW1zLnllYXJQaWNrZXJUZW1wbGF0ZSA6ICcnKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBoZWFkZXJIVE1MID0gcC5wYXJhbXMuaGVhZGVyID8gcC5wYXJhbXMuaGVhZGVyVGVtcGxhdGUucmVwbGFjZSgve3tjbG9zZVRleHR9fS9nLCBwLnBhcmFtcy50b29sYmFyQ2xvc2VUZXh0KS5yZXBsYWNlKC97e3BsYWNlaG9sZGVyfX0vZywgcC5wYXJhbXMuaGVhZGVyUGxhY2Vob2xkZXIpIDogJyc7XG4gICAgICAgICAgICAgICAgdmFyIGZvb3RlckhUTUwgPSBwLnBhcmFtcy5mb290ZXIgPyBwLnBhcmFtcy5mb290ZXJUZW1wbGF0ZS5yZXBsYWNlKC97e2Nsb3NlVGV4dH19L2csIHAucGFyYW1zLnRvb2xiYXJDbG9zZVRleHQpIDogJyc7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHBpY2tlckhUTUwgPVxuICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIicgKyAocGlja2VyQ2xhc3MpICsgJ1wiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVySFRNTCArXG4gICAgICAgICAgICAgICAgICAgICAgICBmb290ZXJIVE1MICtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvb2xiYXJIVE1MICtcbiAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwicGlja2VyLW1vZGFsLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgd2Vla0hlYWRlckhUTUwgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vbnRoc0hUTUwgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JztcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHAucGlja2VySFRNTCA9IHBpY2tlckhUTUw7XG4gICAgICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIElucHV0IEV2ZW50c1xuICAgICAgICAgICAgZnVuY3Rpb24gb3Blbk9uSW5wdXQoZSkge1xuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICBpZiAocC5vcGVuZWQpIHJldHVybjtcbiAgICAgICAgICAgICAgICBwLm9wZW4oKTtcbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMuc2Nyb2xsVG9JbnB1dCAmJiAhaXNQb3BvdmVyKCkgJiYgIWFwcC5wYXJhbXMubWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhZ2VDb250ZW50ID0gcC5pbnB1dC5wYXJlbnRzKCcucGFnZS1jb250ZW50Jyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYWdlQ29udGVudC5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHZhciBwYWRkaW5nVG9wID0gcGFyc2VJbnQocGFnZUNvbnRlbnQuY3NzKCdwYWRkaW5nLXRvcCcpLCAxMCksXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWRkaW5nQm90dG9tID0gcGFyc2VJbnQocGFnZUNvbnRlbnQuY3NzKCdwYWRkaW5nLWJvdHRvbScpLCAxMCksXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlSGVpZ2h0ID0gcGFnZUNvbnRlbnRbMF0ub2Zmc2V0SGVpZ2h0IC0gcGFkZGluZ1RvcCAtIHAuY29udGFpbmVyLmhlaWdodCgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZVNjcm9sbEhlaWdodCA9IHBhZ2VDb250ZW50WzBdLnNjcm9sbEhlaWdodCAtIHBhZGRpbmdUb3AgLSBwLmNvbnRhaW5lci5oZWlnaHQoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhZGRpbmdCb3R0b207XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB2YXIgaW5wdXRUb3AgPSBwLmlucHV0Lm9mZnNldCgpLnRvcCAtIHBhZGRpbmdUb3AgKyBwLmlucHV0WzBdLm9mZnNldEhlaWdodDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlucHV0VG9wID4gcGFnZUhlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjcm9sbFRvcCA9IHBhZ2VDb250ZW50LnNjcm9sbFRvcCgpICsgaW5wdXRUb3AgLSBwYWdlSGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNjcm9sbFRvcCArIHBhZ2VIZWlnaHQgPiBwYWdlU2Nyb2xsSGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGFkZGluZ0JvdHRvbSA9IHNjcm9sbFRvcCArIHBhZ2VIZWlnaHQgLSBwYWdlU2Nyb2xsSGVpZ2h0ICsgcGFkZGluZ0JvdHRvbTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFnZUhlaWdodCA9PT0gcGFnZVNjcm9sbEhlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdQYWRkaW5nQm90dG9tID0gcC5jb250YWluZXIuaGVpZ2h0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VDb250ZW50LmNzcyh7J3BhZGRpbmctYm90dG9tJzogKG5ld1BhZGRpbmdCb3R0b20pICsgJ3B4J30pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZUNvbnRlbnQuc2Nyb2xsVG9wKHNjcm9sbFRvcCwgMzAwKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGNsb3NlT25IVE1MQ2xpY2soZSkge1xuICAgICAgICAgICAgICAgIGlmIChpblBvcG92ZXIoKSkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmIChwLmlucHV0ICYmIHAuaW5wdXQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZS50YXJnZXQgIT09IHAuaW5wdXRbMF0gJiYgJChlLnRhcmdldCkucGFyZW50cygnLnBpY2tlci1tb2RhbCcpLmxlbmd0aCA9PT0gMCkgcC5jbG9zZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCQoZS50YXJnZXQpLnBhcmVudHMoJy5waWNrZXItbW9kYWwnKS5sZW5ndGggPT09IDApIHAuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHAucGFyYW1zLmlucHV0KSB7XG4gICAgICAgICAgICAgICAgcC5pbnB1dCA9ICQocC5wYXJhbXMuaW5wdXQpO1xuICAgICAgICAgICAgICAgIGlmIChwLmlucHV0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLmlucHV0UmVhZE9ubHkpIHAuaW5wdXQucHJvcCgncmVhZE9ubHknLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmlubGluZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5pbnB1dC5vbignY2xpY2snLCBvcGVuT25JbnB1dCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLmlucHV0UmVhZE9ubHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuaW5wdXQub24oJ2ZvY3VzIG1vdXNlZG93bicsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmICghcC5pbmxpbmUgJiYgcC5wYXJhbXMuY2xvc2VCeU91dHNpZGVDbGljaykgJCgnaHRtbCcpLm9uKCdjbGljaycsIGNsb3NlT25IVE1MQ2xpY2spO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIE9wZW5cbiAgICAgICAgICAgIGZ1bmN0aW9uIG9uUGlja2VyQ2xvc2UoKSB7XG4gICAgICAgICAgICAgICAgcC5vcGVuZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAocC5pbnB1dCAmJiBwLmlucHV0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcC5pbnB1dC5wYXJlbnRzKCcucGFnZS1jb250ZW50JykuY3NzKHsncGFkZGluZy1ib3R0b20nOiAnJ30pO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCkgcC5pbnB1dC50cmlnZ2VyKCdibHVyJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy5vbkNsb3NlKSBwLnBhcmFtcy5vbkNsb3NlKHApO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBEZXN0cm95IGV2ZW50c1xuICAgICAgICAgICAgICAgIHAuZGVzdHJveUNhbGVuZGFyRXZlbnRzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgcC5vcGVuZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIHAub3BlbiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgdG9Qb3BvdmVyID0gaXNQb3BvdmVyKCk7XG4gICAgICAgICAgICAgICAgdmFyIHVwZGF0ZVZhbHVlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKCFwLm9wZW5lZCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBTZXQgZGF0ZSB2YWx1ZVxuICAgICAgICAgICAgICAgICAgICBpZiAoIXAudmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnBhcmFtcy52YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHAudmFsdWUgPSBwLnBhcmFtcy52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVWYWx1ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIExheW91dFxuICAgICAgICAgICAgICAgICAgICBwLmxheW91dCgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gQXBwZW5kXG4gICAgICAgICAgICAgICAgICAgIGlmICh0b1BvcG92ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAucGlja2VySFRNTCA9ICc8ZGl2IGNsYXNzPVwicG9wb3ZlciBwb3BvdmVyLXBpY2tlci1jYWxlbmRhclwiPjxkaXYgY2xhc3M9XCJwb3BvdmVyLWlubmVyXCI+JyArIHAucGlja2VySFRNTCArICc8L2Rpdj48L2Rpdj4nO1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5wb3BvdmVyID0gYXBwLnBvcG92ZXIocC5waWNrZXJIVE1MLCBwLnBhcmFtcy5pbnB1dCwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLmNvbnRhaW5lciA9ICQocC5wb3BvdmVyKS5maW5kKCcucGlja2VyLW1vZGFsJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKHAucG9wb3Zlcikub24oJ2Nsb3NlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uUGlja2VyQ2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHAuaW5saW5lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLmNvbnRhaW5lciA9ICQocC5waWNrZXJIVE1MKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuY29udGFpbmVyLmFkZENsYXNzKCdwaWNrZXItbW9kYWwtaW5saW5lJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKHAucGFyYW1zLmNvbnRhaW5lcikuYXBwZW5kKHAuY29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHAuY29udGFpbmVyID0gJChhcHAucGlja2VyTW9kYWwocC5waWNrZXJIVE1MKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAkKHAuY29udGFpbmVyKVxuICAgICAgICAgICAgICAgICAgICAgICAgLm9uKCdjbG9zZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblBpY2tlckNsb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gU3RvcmUgY2FsZW5kYXIgaW5zdGFuY2VcbiAgICAgICAgICAgICAgICAgICAgcC5jb250YWluZXJbMF0uZjdDYWxlbmRhciA9IHA7XG4gICAgICAgICAgICAgICAgICAgIHAud3JhcHBlciA9IHAuY29udGFpbmVyLmZpbmQoJy5waWNrZXItY2FsZW5kYXItbW9udGhzLXdyYXBwZXInKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIE1vbnRoc1xuICAgICAgICAgICAgICAgICAgICBwLm1vbnRocyA9IHAud3JhcHBlci5maW5kKCcucGlja2VyLWNhbGVuZGFyLW1vbnRoJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgY3VycmVudCBtb250aCBhbmQgeWVhclxuICAgICAgICAgICAgICAgICAgICBwLnVwZGF0ZUN1cnJlbnRNb250aFllYXIoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIFNldCBpbml0aWFsIHRyYW5zbGF0ZVxuICAgICAgICAgICAgICAgICAgICBwLm1vbnRoc1RyYW5zbGF0ZSA9IDA7XG4gICAgICAgICAgICAgICAgICAgIHAuc2V0TW9udGhzVHJhbnNsYXRlKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBJbml0IGV2ZW50c1xuICAgICAgICAgICAgICAgICAgICBwLmluaXRDYWxlbmRhckV2ZW50cygpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLy8gVXBkYXRlIGlucHV0IHZhbHVlXG4gICAgICAgICAgICAgICAgICAgIGlmICh1cGRhdGVWYWx1ZSkgcC51cGRhdGVWYWx1ZSgpO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChhcHAucGFyYW1zLm1hdGVyaWFsICYmIHAudmFsdWUpIHAudXBkYXRlVmFsdWUodHJ1ZSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBNYXRlcmlhbCBGb2N1c1xuICAgICAgICAgICAgICAgICAgICBpZiAocC5pbnB1dCAmJiBwLmlucHV0Lmxlbmd0aCA+IDAgJiYgYXBwLnBhcmFtcy5tYXRlcmlhbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcC5pbnB1dC50cmlnZ2VyKCdmb2N1cycpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgLy8gU2V0IGZsYWdcbiAgICAgICAgICAgICAgICBwLm9wZW5lZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgcC5pbml0aWFsaXplZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm9uTW9udGhBZGQpIHtcbiAgICAgICAgICAgICAgICAgICAgcC5tb250aHMuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLnBhcmFtcy5vbk1vbnRoQWRkKHAsIHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHAucGFyYW1zLm9uT3BlbikgcC5wYXJhbXMub25PcGVuKHApO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDbG9zZVxuICAgICAgICAgICAgcC5jbG9zZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXAub3BlbmVkIHx8IHAuaW5saW5lKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKGluUG9wb3ZlcigpKSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKHAucG9wb3Zlcik7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGFwcC5jbG9zZU1vZGFsKHAuY29udGFpbmVyKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGVzdHJveVxuICAgICAgICAgICAgcC5kZXN0cm95ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHAuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICBpZiAocC5wYXJhbXMuaW5wdXQgJiYgcC5pbnB1dC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHAuaW5wdXQub2ZmKCdjbGljayBmb2N1cycsIG9wZW5PbklucHV0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgJCgnaHRtbCcpLm9mZignY2xpY2snLCBjbG9zZU9uSFRNTENsaWNrKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHAuaW5saW5lKSB7XG4gICAgICAgICAgICAgICAgcC5vcGVuKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoIXAuaW5pdGlhbGl6ZWQgJiYgcC5wYXJhbXMudmFsdWUpIHAuc2V0VmFsdWUocC5wYXJhbXMudmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBwO1xuICAgICAgICB9O1xuICAgICAgICBhcHAuY2FsZW5kYXIgPSBmdW5jdGlvbiAocGFyYW1zKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IENhbGVuZGFyKHBhcmFtcyk7XG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIE5vdGlmaWNhdGlvbnMgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgdmFyIF90ZW1wTm90aWZpY2F0aW9uRWxlbWVudDtcbiAgICAgICAgYXBwLmFkZE5vdGlmaWNhdGlvbiA9IGZ1bmN0aW9uIChwYXJhbXMpIHtcbiAgICAgICAgICAgIGlmICghcGFyYW1zKSByZXR1cm47XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zLm1lZGlhID09PSAndW5kZWZpbmVkJykgcGFyYW1zLm1lZGlhID0gYXBwLnBhcmFtcy5ub3RpZmljYXRpb25NZWRpYTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zLnRpdGxlID09PSAndW5kZWZpbmVkJykgcGFyYW1zLnRpdGxlID0gYXBwLnBhcmFtcy5ub3RpZmljYXRpb25UaXRsZTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zLnN1YnRpdGxlID09PSAndW5kZWZpbmVkJykgcGFyYW1zLnN1YnRpdGxlID0gYXBwLnBhcmFtcy5ub3RpZmljYXRpb25TdWJ0aXRsZTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zLmNsb3NlSWNvbiA9PT0gJ3VuZGVmaW5lZCcpIHBhcmFtcy5jbG9zZUljb24gPSBhcHAucGFyYW1zLm5vdGlmaWNhdGlvbkNsb3NlSWNvbjtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zLmhvbGQgPT09ICd1bmRlZmluZWQnKSBwYXJhbXMuaG9sZCA9IGFwcC5wYXJhbXMubm90aWZpY2F0aW9uSG9sZDtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zLmNsb3NlT25DbGljayA9PT0gJ3VuZGVmaW5lZCcpIHBhcmFtcy5jbG9zZU9uQ2xpY2sgPSBhcHAucGFyYW1zLm5vdGlmaWNhdGlvbkNsb3NlT25DbGljaztcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zLmJ1dHRvbiA9PT0gJ3VuZGVmaW5lZCcpIHBhcmFtcy5idXR0b24gPSBhcHAucGFyYW1zLm5vdGlmaWNhdGlvbkNsb3NlQnV0dG9uVGV4dCAmJiB7XG4gICAgICAgICAgICAgICAgdGV4dDogYXBwLnBhcmFtcy5ub3RpZmljYXRpb25DbG9zZUJ1dHRvblRleHQsXG4gICAgICAgICAgICAgICAgY2xvc2U6IHRydWVcbiAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKCFfdGVtcE5vdGlmaWNhdGlvbkVsZW1lbnQpIF90ZW1wTm90aWZpY2F0aW9uRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICBcbiAgICAgICAgICAgIHBhcmFtcy5tYXRlcmlhbCA9IGFwcC5wYXJhbXMubWF0ZXJpYWw7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIGNvbnRhaW5lciA9ICQoJy5ub3RpZmljYXRpb25zJyk7XG4gICAgICAgICAgICBpZiAoY29udGFpbmVyLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICQoJ2JvZHknKS5hcHBlbmQoJzxkaXYgY2xhc3M9XCJub3RpZmljYXRpb25zIGxpc3QtYmxvY2snICsgKHBhcmFtcy5tYXRlcmlhbCA/ICcnIDogJyBtZWRpYS1saXN0JykgKyAnXCI+PHVsPjwvdWw+PC9kaXY+Jyk7XG4gICAgICAgICAgICAgICAgY29udGFpbmVyID0gJCgnLm5vdGlmaWNhdGlvbnMnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBsaXN0ID0gY29udGFpbmVyLmNoaWxkcmVuKCd1bCcpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB2YXIgbm90aWZpY2F0aW9uVGVtcGxhdGUgPSBhcHAucGFyYW1zLm5vdGlmaWNhdGlvblRlbXBsYXRlIHx8IFxuICAgICAgICAgICAgICAgICd7eyNpZiBjdXN0b219fScgK1xuICAgICAgICAgICAgICAgICc8bGk+e3tjdXN0b219fTwvbGk+JyArXG4gICAgICAgICAgICAgICAgJ3t7ZWxzZX19JyArXG4gICAgICAgICAgICAgICAgJzxsaSBjbGFzcz1cIm5vdGlmaWNhdGlvbi1pdGVtIG5vdGlmaWNhdGlvbi1oaWRkZW5cIj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLWNvbnRlbnRcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBtYXRlcmlhbH19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLWlubmVyXCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS10aXRsZVwiPnt7anMgXCJ0aGlzLm1lc3NhZ2UgfHwgdGhpcy50aXRsZSB8fCB0aGlzLnN1YnRpdGxlXCJ9fTwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgLi4vYnV0dG9ufX17eyNidXR0b259fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tYWZ0ZXJcIj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8YSBocmVmPVwiI1wiIGNsYXNzPVwiYnV0dG9uIHt7I2lmIGNvbG9yfX1jb2xvci17e2NvbG9yfX17ey9pZn19IHt7I2pzX2NvbXBhcmUgXCJ0aGlzLmNsb3NlICE9PSBmYWxzZVwifX1jbG9zZS1ub3RpZmljYXRpb257ey9qc19jb21wYXJlfX1cIj57e3RleHR9fTwvYT4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svYnV0dG9ufX17ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJzwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3t7ZWxzZX19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIG1lZGlhfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tbWVkaWFcIj57e21lZGlhfX08L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaXRlbS1pbm5lclwiPicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tdGl0bGUtcm93XCI+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3sjaWYgdGl0bGV9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLXRpdGxlXCI+e3t0aXRsZX19PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAne3svaWZ9fScgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIGNsb3NlSWNvbn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPGRpdiBjbGFzcz1cIml0ZW0tYWZ0ZXJcIj48YSBocmVmPVwiI1wiIGNsYXNzPVwiY2xvc2Utbm90aWZpY2F0aW9uXCI+PHNwYW4+PC9zcGFuPjwvYT48L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7I2lmIHN1YnRpdGxlfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLXN1YnRpdGxlXCI+e3tzdWJ0aXRsZX19PC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7eyNpZiBtZXNzYWdlfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpdGVtLXRleHRcIj57e21lc3NhZ2V9fTwvZGl2PicgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPC9kaXY+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3t7L2lmfX0nICtcbiAgICAgICAgICAgICAgICAgICAgICAgICd7ey9pZn19JyArXG4gICAgICAgICAgICAgICAgICAgICc8L2Rpdj4nICtcbiAgICAgICAgICAgICAgICAnPC9saT4nICtcbiAgICAgICAgICAgICAgICAne3svaWZ9fSc7XG4gICAgICAgICAgICBpZiAoIWFwcC5fY29tcGlsZWRUZW1wbGF0ZXMubm90aWZpY2F0aW9uKSB7XG4gICAgICAgICAgICAgICAgYXBwLl9jb21waWxlZFRlbXBsYXRlcy5ub3RpZmljYXRpb24gPSB0Ny5jb21waWxlKG5vdGlmaWNhdGlvblRlbXBsYXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF90ZW1wTm90aWZpY2F0aW9uRWxlbWVudC5pbm5lckhUTUwgPSBhcHAuX2NvbXBpbGVkVGVtcGxhdGVzLm5vdGlmaWNhdGlvbihwYXJhbXMpO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBpdGVtID0gJChfdGVtcE5vdGlmaWNhdGlvbkVsZW1lbnQpLmNoaWxkcmVuKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgaXRlbS5vbignY2xpY2snLCBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIHZhciBjbG9zZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSAkKGUudGFyZ2V0KTtcbiAgICAgICAgICAgICAgICBpZiAocGFyYW1zLm1hdGVyaWFsICYmIHRhcmdldC5oYXNDbGFzcygnYnV0dG9uJykpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5idXR0b24gJiYgcGFyYW1zLmJ1dHRvbi5vbkNsaWNrKSBwYXJhbXMuYnV0dG9uLm9uQ2xpY2suY2FsbCh0YXJnZXRbMF0sIGUsIGl0ZW1bMF0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0LmlzKCcuY2xvc2Utbm90aWZpY2F0aW9uJykgfHwgJChlLnRhcmdldCkucGFyZW50cygnLmNsb3NlLW5vdGlmaWNhdGlvbicpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY2xvc2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5vbkNsaWNrKSBwYXJhbXMub25DbGljayhlLCBpdGVtWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5jbG9zZU9uQ2xpY2spIGNsb3NlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGNsb3NlKSBhcHAuY2xvc2VOb3RpZmljYXRpb24oaXRlbVswXSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGlmIChwYXJhbXMub25DbG9zZSkge1xuICAgICAgICAgICAgICAgIGl0ZW0uZGF0YSgnZjdOb3RpZmljYXRpb25PbkNsb3NlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBwYXJhbXMub25DbG9zZShpdGVtWzBdKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwYXJhbXMuYWRkaXRpb25hbENsYXNzKSB7XG4gICAgICAgICAgICAgICAgaXRlbS5hZGRDbGFzcyhwYXJhbXMuYWRkaXRpb25hbENsYXNzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChwYXJhbXMuaG9sZCkge1xuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5sZW5ndGggPiAwKSBhcHAuY2xvc2VOb3RpZmljYXRpb24oaXRlbVswXSk7XG4gICAgICAgICAgICAgICAgfSwgcGFyYW1zLmhvbGQpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGxpc3RbcGFyYW1zLm1hdGVyaWFsID8gJ2FwcGVuZCcgOiAncHJlcGVuZCddKGl0ZW1bMF0pO1xuICAgICAgICAgICAgY29udGFpbmVyLnNob3coKTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgaXRlbUhlaWdodCA9IGl0ZW0ub3V0ZXJIZWlnaHQoKSwgY2xpZW50TGVmdDtcbiAgICAgICAgICAgIGlmIChwYXJhbXMubWF0ZXJpYWwpIHtcbiAgICAgICAgICAgICAgICBjb250YWluZXIudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLCAnK2l0ZW1IZWlnaHQrJ3B4LCAwKScpO1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci50cmFuc2l0aW9uKDApO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBjbGllbnRMZWZ0ID0gaXRlbVswXS5jbGllbnRMZWZ0O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICBjb250YWluZXIudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLCAwLCAwKScpO1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci50cmFuc2l0aW9uKCcnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGl0ZW0uY3NzKCdtYXJnaW5Ub3AnLCAtaXRlbUhlaWdodCArICdweCcpO1xuICAgICAgICAgICAgICAgIGl0ZW0udHJhbnNpdGlvbigwKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgY2xpZW50TGVmdCA9IGl0ZW1bMF0uY2xpZW50TGVmdDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaXRlbS50cmFuc2l0aW9uKCcnKTtcbiAgICAgICAgICAgICAgICBpdGVtLmNzcygnbWFyZ2luVG9wJywgJzBweCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGNvbnRhaW5lci50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDAsIDAsMCknKTtcbiAgICAgICAgICAgIGl0ZW0ucmVtb3ZlQ2xhc3MoJ25vdGlmaWNhdGlvbi1oaWRkZW4nKTtcbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gaXRlbVswXTtcbiAgICAgICAgfTtcbiAgICAgICAgYXBwLmNsb3NlTm90aWZpY2F0aW9uID0gZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICAgICAgICAgIGl0ZW0gPSAkKGl0ZW0pO1xuICAgICAgICAgICAgaWYgKGl0ZW0ubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoaXRlbS5oYXNDbGFzcygnbm90aWZpY2F0aW9uLWl0ZW0tcmVtb3ZpbmcnKSkgcmV0dXJuO1xuICAgICAgICAgICAgdmFyIGNvbnRhaW5lciA9ICQoJy5ub3RpZmljYXRpb25zJyk7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIGl0ZW1IZWlnaHQgPSBpdGVtLm91dGVySGVpZ2h0KCk7XG4gICAgICAgICAgICBpdGVtLmNzcygnaGVpZ2h0JywgaXRlbUhlaWdodCArICdweCcpLnRyYW5zaXRpb24oMCkuYWRkQ2xhc3MoJ25vdGlmaWNhdGlvbi1pdGVtLXJlbW92aW5nJyk7XG4gICAgICAgICAgICB2YXIgY2xpZW50TGVmdCA9IGl0ZW1bMF0uY2xpZW50TGVmdDtcbiAgICAgICAgXG4gICAgICAgICAgICBpdGVtLmNzcygnaGVpZ2h0JywgJzBweCcpLnRyYW5zaXRpb24oJycpO1xuICAgICAgICAgICAgaWYgKGl0ZW0uZGF0YSgnZjdOb3RpZmljYXRpb25PbkNsb3NlJykpIGl0ZW0uZGF0YSgnZjdOb3RpZmljYXRpb25PbkNsb3NlJykoKTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoY29udGFpbmVyLmZpbmQoJy5ub3RpZmljYXRpb24taXRlbTpub3QoLm5vdGlmaWNhdGlvbi1pdGVtLXJlbW92aW5nKScpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lci50cmFuc2Zvcm0oJycpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGl0ZW0uYWRkQ2xhc3MoJ25vdGlmaWNhdGlvbi1oaWRkZW4nKS50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpdGVtLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgIGlmIChjb250YWluZXIuZmluZCgnLm5vdGlmaWNhdGlvbi1pdGVtJykubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRhaW5lci5oaWRlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgQ29tcGlsZSBUZW1wbGF0ZTcgVGVtcGxhdGVzIE9uIEFwcCBJbml0XG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIGFwcC5pbml0VGVtcGxhdGU3VGVtcGxhdGVzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKCF3aW5kb3cuVGVtcGxhdGU3KSByZXR1cm47XG4gICAgICAgICAgICBUZW1wbGF0ZTcudGVtcGxhdGVzID0gVGVtcGxhdGU3LnRlbXBsYXRlcyB8fCBhcHAucGFyYW1zLnRlbXBsYXRlcyB8fCB7fTtcbiAgICAgICAgICAgIFRlbXBsYXRlNy5kYXRhID0gVGVtcGxhdGU3LmRhdGEgfHwgYXBwLnBhcmFtcy50ZW1wbGF0ZTdEYXRhIHx8IHt9O1xuICAgICAgICAgICAgVGVtcGxhdGU3LmNhY2hlID0gVGVtcGxhdGU3LmNhY2hlIHx8IHt9O1xuICAgICAgICBcbiAgICAgICAgICAgIGFwcC50ZW1wbGF0ZXMgPSBUZW1wbGF0ZTcudGVtcGxhdGVzO1xuICAgICAgICAgICAgYXBwLnRlbXBsYXRlN0RhdGEgPSBUZW1wbGF0ZTcuZGF0YTtcbiAgICAgICAgICAgIGFwcC50ZW1wbGF0ZTdDYWNoZSA9IFRlbXBsYXRlNy5jYWNoZTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQcmVjb21waWxlIHRlbXBsYXRlcyBvbiBhcHAgaW5pdFxuICAgICAgICAgICAgaWYgKCFhcHAucGFyYW1zLnByZWNvbXBpbGVUZW1wbGF0ZXMpIHJldHVybjtcbiAgICAgICAgICAgICQoJ3NjcmlwdFt0eXBlPVwidGV4dC90ZW1wbGF0ZTdcIl0nKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgaWQgPSAkKHRoaXMpLmF0dHIoJ2lkJyk7XG4gICAgICAgICAgICAgICAgaWYgKCFpZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIFRlbXBsYXRlNy50ZW1wbGF0ZXNbaWRdID0gVGVtcGxhdGU3LmNvbXBpbGUoJCh0aGlzKS5odG1sKCkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIFxuXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICoqKioqKioqKioqKiAgIFBsdWdpbnMgQVBJICAgKioqKioqKioqKioqXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHZhciBfcGx1Z2lucyA9IFtdO1xuICAgICAgICBhcHAuaW5pdFBsdWdpbnMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAvLyBJbml0aWFsaXplIHBsdWdpbnNcbiAgICAgICAgICAgIGZvciAodmFyIHBsdWdpbiBpbiBhcHAucGx1Z2lucykge1xuICAgICAgICAgICAgICAgIHZhciBwID0gYXBwLnBsdWdpbnNbcGx1Z2luXShhcHAsIGFwcC5wYXJhbXNbcGx1Z2luXSk7XG4gICAgICAgICAgICAgICAgaWYgKHApIF9wbHVnaW5zLnB1c2gocCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIC8vIFBsdWdpbiBIb29rc1xuICAgICAgICBhcHAucGx1Z2luSG9vayA9IGZ1bmN0aW9uIChob29rKSB7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IF9wbHVnaW5zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKF9wbHVnaW5zW2ldLmhvb2tzICYmIGhvb2sgaW4gX3BsdWdpbnNbaV0uaG9va3MpIHtcbiAgICAgICAgICAgICAgICAgICAgX3BsdWdpbnNbaV0uaG9va3NbaG9va10oYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0sIGFyZ3VtZW50c1szXSwgYXJndW1lbnRzWzRdLCBhcmd1bWVudHNbNV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgLy8gUHJldmVudGVkIGJ5IHBsdWdpblxuICAgICAgICBhcHAucGx1Z2luUHJldmVudCA9IGZ1bmN0aW9uIChhY3Rpb24pIHtcbiAgICAgICAgICAgIHZhciBwcmV2ZW50ID0gZmFsc2U7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IF9wbHVnaW5zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKF9wbHVnaW5zW2ldLnByZXZlbnRzICYmIGFjdGlvbiBpbiBfcGx1Z2luc1tpXS5wcmV2ZW50cykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoX3BsdWdpbnNbaV0ucHJldmVudHNbYWN0aW9uXShhcmd1bWVudHNbMV0sIGFyZ3VtZW50c1syXSwgYXJndW1lbnRzWzNdLCBhcmd1bWVudHNbNF0sIGFyZ3VtZW50c1s1XSkpIHByZXZlbnQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwcmV2ZW50O1xuICAgICAgICB9O1xuICAgICAgICAvLyBQcmVwcm9jZXNzIGNvbnRlbnQgYnkgcGx1Z2luXG4gICAgICAgIGFwcC5wbHVnaW5Qcm9jZXNzID0gZnVuY3Rpb24gKHByb2Nlc3MsIGRhdGEpIHtcbiAgICAgICAgICAgIHZhciBwcm9jZXNzZWQgPSBkYXRhO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBfcGx1Z2lucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmIChfcGx1Z2luc1tpXS5wcmVwcm9jZXNzICYmIHByb2Nlc3MgaW4gX3BsdWdpbnNbaV0ucHJlcHJvY2Vzcykge1xuICAgICAgICAgICAgICAgICAgICBwcm9jZXNzZWQgPSBfcGx1Z2luc1tpXS5wcmVwcm9jZXNzW3Byb2Nlc3NdKGRhdGEsIGFyZ3VtZW50c1syXSwgYXJndW1lbnRzWzNdLCBhcmd1bWVudHNbNF0sIGFyZ3VtZW50c1s1XSwgYXJndW1lbnRzWzZdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcHJvY2Vzc2VkO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgXG5cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgKioqKioqKioqKioqICAgQXBwIEluaXQgICAqKioqKioqKioqKipcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYXBwLmluaXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAvLyBDb21waWxlIFRlbXBsYXRlNyB0ZW1wbGF0ZXMgb24gYXBwIGxvYWRcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdFRlbXBsYXRlN1RlbXBsYXRlcykgYXBwLmluaXRUZW1wbGF0ZTdUZW1wbGF0ZXMoKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBQbHVnaW5zXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRQbHVnaW5zKSBhcHAuaW5pdFBsdWdpbnMoKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBEZXZpY2VcbiAgICAgICAgICAgIGlmIChhcHAuZ2V0RGV2aWNlSW5mbykgYXBwLmdldERldmljZUluZm8oKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBDbGljayBldmVudHNcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdEZhc3RDbGlja3MgJiYgYXBwLnBhcmFtcy5mYXN0Q2xpY2tzKSBhcHAuaW5pdEZhc3RDbGlja3MoKTtcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdENsaWNrRXZlbnRzKSBhcHAuaW5pdENsaWNrRXZlbnRzKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBlYWNoIHBhZ2UgY2FsbGJhY2tzXG4gICAgICAgICAgICAkKCcucGFnZTpub3QoLmNhY2hlZCknKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBhcHAuaW5pdFBhZ2VXaXRoQ2FsbGJhY2sodGhpcyk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0IGVhY2ggbmF2YmFyIGNhbGxiYWNrc1xuICAgICAgICAgICAgJCgnLm5hdmJhcjpub3QoLmNhY2hlZCknKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBhcHAuaW5pdE5hdmJhcldpdGhDYWxsYmFjayh0aGlzKTsgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCByZXNpemUgZXZlbnRzXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRSZXNpemUpIGFwcC5pbml0UmVzaXplKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBwdXNoIHN0YXRlXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRQdXNoU3RhdGUgJiYgYXBwLnBhcmFtcy5wdXNoU3RhdGUpIGFwcC5pbml0UHVzaFN0YXRlKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBMaXZlIFN3aXBlb3V0cyBldmVudHNcbiAgICAgICAgICAgIGlmIChhcHAuaW5pdFN3aXBlb3V0ICYmIGFwcC5wYXJhbXMuc3dpcGVvdXQpIGFwcC5pbml0U3dpcGVvdXQoKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBJbml0IExpdmUgU29ydGFibGUgZXZlbnRzXG4gICAgICAgICAgICBpZiAoYXBwLmluaXRTb3J0YWJsZSAmJiBhcHAucGFyYW1zLnNvcnRhYmxlKSBhcHAuaW5pdFNvcnRhYmxlKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gSW5pdCBMaXZlIFN3aXBlIFBhbmVsc1xuICAgICAgICAgICAgaWYgKGFwcC5pbml0U3dpcGVQYW5lbHMgJiYgKGFwcC5wYXJhbXMuc3dpcGVQYW5lbCB8fCBhcHAucGFyYW1zLnN3aXBlUGFuZWxPbmx5Q2xvc2UpKSBhcHAuaW5pdFN3aXBlUGFuZWxzKCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXQgTWF0ZXJpYWwgSW5wdXRzXG4gICAgICAgICAgICBpZiAoYXBwLnBhcmFtcy5tYXRlcmlhbCAmJiBhcHAuaW5pdE1hdGVyaWFsV2F0Y2hJbnB1dHMpIGFwcC5pbml0TWF0ZXJpYWxXYXRjaElucHV0cygpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBBcHAgSW5pdCBjYWxsYmFja1xuICAgICAgICAgICAgaWYgKGFwcC5wYXJhbXMub25BcHBJbml0KSBhcHAucGFyYW1zLm9uQXBwSW5pdCgpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFBsdWdpbiBhcHAgaW5pdCBob29rXG4gICAgICAgICAgICBhcHAucGx1Z2luSG9vaygnYXBwSW5pdCcpO1xuICAgICAgICB9O1xuICAgICAgICBpZiAoYXBwLnBhcmFtcy5pbml0KSBhcHAuaW5pdCgpO1xuICAgICAgICBcblxuICAgICAgICAvL1JldHVybiBpbnN0YW5jZSAgICAgICAgXG4gICAgICAgIHJldHVybiBhcHA7XG4gICAgfTtcbiAgICBcblxuICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgRG9tNyBMaWJyYXJ5XG4gICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICB2YXIgRG9tNyA9IChmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBEb203ID0gZnVuY3Rpb24gKGFycikge1xuICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcywgaSA9IDA7XG4gICAgICAgICAgICAvLyBDcmVhdGUgYXJyYXktbGlrZSBvYmplY3RcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBfdGhpc1tpXSA9IGFycltpXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIF90aGlzLmxlbmd0aCA9IGFyci5sZW5ndGg7XG4gICAgICAgICAgICAvLyBSZXR1cm4gY29sbGVjdGlvbiB3aXRoIG1ldGhvZHNcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICB9O1xuICAgICAgICB2YXIgJCA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCkge1xuICAgICAgICAgICAgdmFyIGFyciA9IFtdLCBpID0gMDtcbiAgICAgICAgICAgIGlmIChzZWxlY3RvciAmJiAhY29udGV4dCkge1xuICAgICAgICAgICAgICAgIGlmIChzZWxlY3RvciBpbnN0YW5jZW9mIERvbTcpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGVjdG9yO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgIC8vIFN0cmluZ1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBlbHMsIHRlbXBQYXJlbnQsIGh0bWw7XG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdG9yID0gaHRtbCA9IHNlbGVjdG9yLnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGh0bWwuaW5kZXhPZignPCcpID49IDAgJiYgaHRtbC5pbmRleE9mKCc+JykgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRvQ3JlYXRlID0gJ2Rpdic7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaHRtbC5pbmRleE9mKCc8bGknKSA9PT0gMCkgdG9DcmVhdGUgPSAndWwnO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGh0bWwuaW5kZXhPZignPHRyJykgPT09IDApIHRvQ3JlYXRlID0gJ3Rib2R5JztcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChodG1sLmluZGV4T2YoJzx0ZCcpID09PSAwIHx8IGh0bWwuaW5kZXhPZignPHRoJykgPT09IDApIHRvQ3JlYXRlID0gJ3RyJztcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChodG1sLmluZGV4T2YoJzx0Ym9keScpID09PSAwKSB0b0NyZWF0ZSA9ICd0YWJsZSc7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaHRtbC5pbmRleE9mKCc8b3B0aW9uJykgPT09IDApIHRvQ3JlYXRlID0gJ3NlbGVjdCc7XG4gICAgICAgICAgICAgICAgICAgICAgICB0ZW1wUGFyZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCh0b0NyZWF0ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0ZW1wUGFyZW50LmlubmVySFRNTCA9IGh0bWw7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGVtcFBhcmVudC5jaGlsZE5vZGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2godGVtcFBhcmVudC5jaGlsZE5vZGVzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghY29udGV4dCAmJiBzZWxlY3RvclswXSA9PT0gJyMnICYmICFzZWxlY3Rvci5tYXRjaCgvWyAuPD46fl0vKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFB1cmUgSUQgc2VsZWN0b3JcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHMgPSBbZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoc2VsZWN0b3Iuc3BsaXQoJyMnKVsxXSldO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gT3RoZXIgc2VsZWN0b3JzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzID0gKGNvbnRleHQgfHwgZG9jdW1lbnQpLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGVscy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbHNbaV0pIGFyci5wdXNoKGVsc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gTm9kZS9lbGVtZW50XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoc2VsZWN0b3Iubm9kZVR5cGUgfHwgc2VsZWN0b3IgPT09IHdpbmRvdyB8fCBzZWxlY3RvciA9PT0gZG9jdW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goc2VsZWN0b3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvL0FycmF5IG9mIGVsZW1lbnRzIG9yIGluc3RhbmNlIG9mIERvbVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHNlbGVjdG9yLmxlbmd0aCA+IDAgJiYgc2VsZWN0b3JbMF0ubm9kZVR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNlbGVjdG9yLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhcnIucHVzaChzZWxlY3RvcltpXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbmV3IERvbTcoYXJyKTtcbiAgICAgICAgfTtcblxuICAgICAgICBEb203LnByb3RvdHlwZSA9IHtcbiAgICAgICAgICAgIC8vIENsYXNzZXMgYW5kIGF0dHJpdXRlc1xuICAgICAgICAgICAgYWRkQ2xhc3M6IGZ1bmN0aW9uIChjbGFzc05hbWUpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNsYXNzTmFtZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBjbGFzc2VzID0gY2xhc3NOYW1lLnNwbGl0KCcgJyk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjbGFzc2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdGhpcy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzW2pdLmNsYXNzTGlzdCAhPT0gJ3VuZGVmaW5lZCcpIHRoaXNbal0uY2xhc3NMaXN0LmFkZChjbGFzc2VzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICByZW1vdmVDbGFzczogZnVuY3Rpb24gKGNsYXNzTmFtZSkge1xuICAgICAgICAgICAgICAgIHZhciBjbGFzc2VzID0gY2xhc3NOYW1lLnNwbGl0KCcgJyk7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjbGFzc2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdGhpcy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzW2pdLmNsYXNzTGlzdCAhPT0gJ3VuZGVmaW5lZCcpIHRoaXNbal0uY2xhc3NMaXN0LnJlbW92ZShjbGFzc2VzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBoYXNDbGFzczogZnVuY3Rpb24gKGNsYXNzTmFtZSkge1xuICAgICAgICAgICAgICAgIGlmICghdGhpc1swXSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIHRoaXNbMF0uY2xhc3NMaXN0LmNvbnRhaW5zKGNsYXNzTmFtZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdG9nZ2xlQ2xhc3M6IGZ1bmN0aW9uIChjbGFzc05hbWUpIHtcbiAgICAgICAgICAgICAgICB2YXIgY2xhc3NlcyA9IGNsYXNzTmFtZS5zcGxpdCgnICcpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2xhc3Nlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpc1tqXS5jbGFzc0xpc3QgIT09ICd1bmRlZmluZWQnKSB0aGlzW2pdLmNsYXNzTGlzdC50b2dnbGUoY2xhc3Nlc1tpXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYXR0cjogZnVuY3Rpb24gKGF0dHJzLCB2YWx1ZSkge1xuICAgICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxICYmIHR5cGVvZiBhdHRycyA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IGF0dHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0pIHJldHVybiB0aGlzWzBdLmdldEF0dHJpYnV0ZShhdHRycyk7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIFNldCBhdHRyc1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU3RyaW5nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXS5zZXRBdHRyaWJ1dGUoYXR0cnMsIHZhbHVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9iamVjdFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGF0dHJOYW1lIGluIGF0dHJzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV1bYXR0ck5hbWVdID0gYXR0cnNbYXR0ck5hbWVdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLnNldEF0dHJpYnV0ZShhdHRyTmFtZSwgYXR0cnNbYXR0ck5hbWVdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHJlbW92ZUF0dHI6IGZ1bmN0aW9uIChhdHRyKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXNbaV0ucmVtb3ZlQXR0cmlidXRlKGF0dHIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwcm9wOiBmdW5jdGlvbiAocHJvcHMsIHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEgJiYgdHlwZW9mIHByb3BzID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAvLyBHZXQgcHJvcFxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpc1swXSkgcmV0dXJuIHRoaXNbMF1bcHJvcHNdO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBTZXQgcHJvcHNcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0cmluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV1bcHJvcHNdID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBPYmplY3RcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBwcm9wTmFtZSBpbiBwcm9wcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldW3Byb3BOYW1lXSA9IHByb3BzW3Byb3BOYW1lXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGRhdGE6IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gR2V0IHZhbHVlXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc1swXS5kb203RWxlbWVudERhdGFTdG9yYWdlICYmIChrZXkgaW4gdGhpc1swXS5kb203RWxlbWVudERhdGFTdG9yYWdlKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWzBdLmRvbTdFbGVtZW50RGF0YVN0b3JhZ2Vba2V5XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkYXRhS2V5ID0gdGhpc1swXS5nZXRBdHRyaWJ1dGUoJ2RhdGEtJyArIGtleSk7ICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhS2V5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRhS2V5O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gU2V0IHZhbHVlXG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGVsID0gdGhpc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZWwuZG9tN0VsZW1lbnREYXRhU3RvcmFnZSkgZWwuZG9tN0VsZW1lbnREYXRhU3RvcmFnZSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICAgICAgZWwuZG9tN0VsZW1lbnREYXRhU3RvcmFnZVtrZXldID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHJlbW92ZURhdGE6IGZ1bmN0aW9uKGtleSkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZWwgPSB0aGlzW2ldO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZWwuZG9tN0VsZW1lbnREYXRhU3RvcmFnZSAmJiBlbC5kb203RWxlbWVudERhdGFTdG9yYWdlW2tleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsLmRvbTdFbGVtZW50RGF0YVN0b3JhZ2Vba2V5XSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZWwuZG9tN0VsZW1lbnREYXRhU3RvcmFnZVtrZXldO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGRhdGFzZXQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgZWwgPSB0aGlzWzBdO1xuICAgICAgICAgICAgICAgIGlmIChlbCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YXNldCA9IHt9O1xuICAgICAgICAgICAgICAgICAgICBpZiAoZWwuZGF0YXNldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgZGF0YUtleSBpbiBlbC5kYXRhc2V0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YXNldFtkYXRhS2V5XSA9IGVsLmRhdGFzZXRbZGF0YUtleV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGVsLmF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXR0ciA9IGVsLmF0dHJpYnV0ZXNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHIubmFtZS5pbmRleE9mKCdkYXRhLScpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YXNldFskLnRvQ2FtZWxDYXNlKGF0dHIubmFtZS5zcGxpdCgnZGF0YS0nKVsxXSldID0gYXR0ci52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGRhdGFzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkYXRhc2V0W2tleV0gPT09ICdmYWxzZScpIGRhdGFzZXRba2V5XSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoZGF0YXNldFtrZXldID09PSAndHJ1ZScpIGRhdGFzZXRba2V5XSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChwYXJzZUZsb2F0KGRhdGFzZXRba2V5XSkgPT09IGRhdGFzZXRba2V5XSAqIDEpIGRhdGFzZXRba2V5XSA9IGRhdGFzZXRba2V5XSAqIDE7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGFzZXQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB2YWw6IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzWzBdKSByZXR1cm4gdGhpc1swXS52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLnZhbHVlID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC8vIFRyYW5zZm9ybXNcbiAgICAgICAgICAgIHRyYW5zZm9ybSA6IGZ1bmN0aW9uICh0cmFuc2Zvcm0pIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVsU3R5bGUgPSB0aGlzW2ldLnN0eWxlO1xuICAgICAgICAgICAgICAgICAgICBlbFN0eWxlLndlYmtpdFRyYW5zZm9ybSA9IGVsU3R5bGUuTXNUcmFuc2Zvcm0gPSBlbFN0eWxlLm1zVHJhbnNmb3JtID0gZWxTdHlsZS5Nb3pUcmFuc2Zvcm0gPSBlbFN0eWxlLk9UcmFuc2Zvcm0gPSBlbFN0eWxlLnRyYW5zZm9ybSA9IHRyYW5zZm9ybTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdHJhbnNpdGlvbjogZnVuY3Rpb24gKGR1cmF0aW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkdXJhdGlvbiAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb24gPSBkdXJhdGlvbiArICdtcyc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZWxTdHlsZSA9IHRoaXNbaV0uc3R5bGU7XG4gICAgICAgICAgICAgICAgICAgIGVsU3R5bGUud2Via2l0VHJhbnNpdGlvbkR1cmF0aW9uID0gZWxTdHlsZS5Nc1RyYW5zaXRpb25EdXJhdGlvbiA9IGVsU3R5bGUubXNUcmFuc2l0aW9uRHVyYXRpb24gPSBlbFN0eWxlLk1velRyYW5zaXRpb25EdXJhdGlvbiA9IGVsU3R5bGUuT1RyYW5zaXRpb25EdXJhdGlvbiA9IGVsU3R5bGUudHJhbnNpdGlvbkR1cmF0aW9uID0gZHVyYXRpb247XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC8vRXZlbnRzXG4gICAgICAgICAgICBvbjogZnVuY3Rpb24gKGV2ZW50TmFtZSwgdGFyZ2V0U2VsZWN0b3IsIGxpc3RlbmVyLCBjYXB0dXJlKSB7XG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gaGFuZGxlTGl2ZUV2ZW50KGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRhcmdldCA9IGUudGFyZ2V0O1xuICAgICAgICAgICAgICAgICAgICBpZiAoJCh0YXJnZXQpLmlzKHRhcmdldFNlbGVjdG9yKSkgbGlzdGVuZXIuY2FsbCh0YXJnZXQsIGUpO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwYXJlbnRzID0gJCh0YXJnZXQpLnBhcmVudHMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgcGFyZW50cy5sZW5ndGg7IGsrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKHBhcmVudHNba10pLmlzKHRhcmdldFNlbGVjdG9yKSkgbGlzdGVuZXIuY2FsbChwYXJlbnRzW2tdLCBlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgZXZlbnRzID0gZXZlbnROYW1lLnNwbGl0KCcgJyk7XG4gICAgICAgICAgICAgICAgdmFyIGksIGo7XG4gICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXRTZWxlY3RvciA9PT0gJ2Z1bmN0aW9uJyB8fCB0YXJnZXRTZWxlY3RvciA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFVzdWFsIGV2ZW50c1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXRTZWxlY3RvciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyID0gYXJndW1lbnRzWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhcHR1cmUgPSBhcmd1bWVudHNbMl0gfHwgZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgZXZlbnRzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXS5hZGRFdmVudExpc3RlbmVyKGV2ZW50c1tqXSwgbGlzdGVuZXIsIGNhcHR1cmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy9MaXZlIGV2ZW50c1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IGV2ZW50cy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpc1tpXS5kb203TGl2ZUxpc3RlbmVycykgdGhpc1tpXS5kb203TGl2ZUxpc3RlbmVycyA9IFtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV0uZG9tN0xpdmVMaXN0ZW5lcnMucHVzaCh7bGlzdGVuZXI6IGxpc3RlbmVyLCBsaXZlTGlzdGVuZXI6IGhhbmRsZUxpdmVFdmVudH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV0uYWRkRXZlbnRMaXN0ZW5lcihldmVudHNbal0sIGhhbmRsZUxpdmVFdmVudCwgY2FwdHVyZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9mZjogZnVuY3Rpb24gKGV2ZW50TmFtZSwgdGFyZ2V0U2VsZWN0b3IsIGxpc3RlbmVyLCBjYXB0dXJlKSB7XG4gICAgICAgICAgICAgICAgdmFyIGV2ZW50cyA9IGV2ZW50TmFtZS5zcGxpdCgnICcpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdGhpcy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXRTZWxlY3RvciA9PT0gJ2Z1bmN0aW9uJyB8fCB0YXJnZXRTZWxlY3RvciA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBVc3VhbCBldmVudHNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRhcmdldFNlbGVjdG9yID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyID0gYXJndW1lbnRzWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXB0dXJlID0gYXJndW1lbnRzWzJdIHx8IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2pdLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRzW2ldLCBsaXN0ZW5lciwgY2FwdHVyZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBMaXZlIGV2ZW50XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbal0uZG9tN0xpdmVMaXN0ZW5lcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCB0aGlzW2pdLmRvbTdMaXZlTGlzdGVuZXJzLmxlbmd0aDsgaysrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc1tqXS5kb203TGl2ZUxpc3RlbmVyc1trXS5saXN0ZW5lciA9PT0gbGlzdGVuZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2pdLnJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRzW2ldLCB0aGlzW2pdLmRvbTdMaXZlTGlzdGVuZXJzW2tdLmxpdmVMaXN0ZW5lciwgY2FwdHVyZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb25jZTogZnVuY3Rpb24gKGV2ZW50TmFtZSwgdGFyZ2V0U2VsZWN0b3IsIGxpc3RlbmVyLCBjYXB0dXJlKSB7XG4gICAgICAgICAgICAgICAgdmFyIGRvbSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXRTZWxlY3RvciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lciA9IGFyZ3VtZW50c1sxXTtcbiAgICAgICAgICAgICAgICAgICAgY2FwdHVyZSA9IGFyZ3VtZW50c1syXTtcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0U2VsZWN0b3IgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gcHJveHkoZSkge1xuICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lci5jYWxsKGUudGFyZ2V0LCBlKTtcbiAgICAgICAgICAgICAgICAgICAgZG9tLm9mZihldmVudE5hbWUsIHRhcmdldFNlbGVjdG9yLCBwcm94eSwgY2FwdHVyZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBkb20ub24oZXZlbnROYW1lLCB0YXJnZXRTZWxlY3RvciwgcHJveHksIGNhcHR1cmUpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uIChldmVudE5hbWUsIGV2ZW50RGF0YSkge1xuICAgICAgICAgICAgICAgIHZhciBldmVudHMgPSBldmVudE5hbWUuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2dCA9IG5ldyBDdXN0b21FdmVudChldmVudHNbaV0sIHtkZXRhaWw6IGV2ZW50RGF0YSwgYnViYmxlczogdHJ1ZSwgY2FuY2VsYWJsZTogdHJ1ZX0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnRXZlbnQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldnQuaW5pdEV2ZW50KGV2ZW50c1tpXSwgdHJ1ZSwgdHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZ0LmRldGFpbCA9IGV2ZW50RGF0YTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbal0uZGlzcGF0Y2hFdmVudChldnQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRyYW5zaXRpb25FbmQ6IGZ1bmN0aW9uIChjYWxsYmFjaykge1xuICAgICAgICAgICAgICAgIHZhciBldmVudHMgPSBbJ3dlYmtpdFRyYW5zaXRpb25FbmQnLCAndHJhbnNpdGlvbmVuZCcsICdvVHJhbnNpdGlvbkVuZCcsICdNU1RyYW5zaXRpb25FbmQnLCAnbXNUcmFuc2l0aW9uRW5kJ10sXG4gICAgICAgICAgICAgICAgICAgIGksIGosIGRvbSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gZmlyZUNhbGxCYWNrKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgLypqc2hpbnQgdmFsaWR0aGlzOnRydWUgKi9cbiAgICAgICAgICAgICAgICAgICAgaWYgKGUudGFyZ2V0ICE9PSB0aGlzKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwodGhpcywgZSk7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbS5vZmYoZXZlbnRzW2ldLCBmaXJlQ2FsbEJhY2spO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb20ub24oZXZlbnRzW2ldLCBmaXJlQ2FsbEJhY2spO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGFuaW1hdGlvbkVuZDogZnVuY3Rpb24gKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgdmFyIGV2ZW50cyA9IFsnd2Via2l0QW5pbWF0aW9uRW5kJywgJ09BbmltYXRpb25FbmQnLCAnTVNBbmltYXRpb25FbmQnLCAnYW5pbWF0aW9uZW5kJ10sXG4gICAgICAgICAgICAgICAgICAgIGksIGosIGRvbSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gZmlyZUNhbGxCYWNrKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZSk7XG4gICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBldmVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbS5vZmYoZXZlbnRzW2ldLCBmaXJlQ2FsbEJhY2spO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZXZlbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb20ub24oZXZlbnRzW2ldLCBmaXJlQ2FsbEJhY2spO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIC8vIFNpemluZy9TdHlsZXNcbiAgICAgICAgICAgIHdpZHRoOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0gPT09IHdpbmRvdykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93LmlubmVyV2lkdGg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyc2VGbG9hdCh0aGlzLmNzcygnd2lkdGgnKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvdXRlcldpZHRoOiBmdW5jdGlvbiAoaW5jbHVkZU1hcmdpbnMpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbmNsdWRlTWFyZ2lucykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0eWxlcyA9IHRoaXMuc3R5bGVzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1swXS5vZmZzZXRXaWR0aCArIHBhcnNlRmxvYXQoc3R5bGVzLmdldFByb3BlcnR5VmFsdWUoJ21hcmdpbi1yaWdodCcpKSArIHBhcnNlRmxvYXQoc3R5bGVzLmdldFByb3BlcnR5VmFsdWUoJ21hcmdpbi1sZWZ0JykpOyAgICBcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1swXS5vZmZzZXRXaWR0aDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBoZWlnaHQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpc1swXSA9PT0gd2luZG93KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFyc2VGbG9hdCh0aGlzLmNzcygnaGVpZ2h0JykpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb3V0ZXJIZWlnaHQ6IGZ1bmN0aW9uIChpbmNsdWRlTWFyZ2lucykge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluY2x1ZGVNYXJnaW5zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3R5bGVzID0gdGhpcy5zdHlsZXMoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWzBdLm9mZnNldEhlaWdodCArIHBhcnNlRmxvYXQoc3R5bGVzLmdldFByb3BlcnR5VmFsdWUoJ21hcmdpbi10b3AnKSkgKyBwYXJzZUZsb2F0KHN0eWxlcy5nZXRQcm9wZXJ0eVZhbHVlKCdtYXJnaW4tYm90dG9tJykpOyAgICBcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1swXS5vZmZzZXRIZWlnaHQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb2Zmc2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZWwgPSB0aGlzWzBdO1xuICAgICAgICAgICAgICAgICAgICB2YXIgYm94ID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBib2R5ID0gZG9jdW1lbnQuYm9keTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNsaWVudFRvcCAgPSBlbC5jbGllbnRUb3AgIHx8IGJvZHkuY2xpZW50VG9wICB8fCAwO1xuICAgICAgICAgICAgICAgICAgICB2YXIgY2xpZW50TGVmdCA9IGVsLmNsaWVudExlZnQgfHwgYm9keS5jbGllbnRMZWZ0IHx8IDA7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzY3JvbGxUb3AgID0gd2luZG93LnBhZ2VZT2Zmc2V0IHx8IGVsLnNjcm9sbFRvcDtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNjcm9sbExlZnQgPSB3aW5kb3cucGFnZVhPZmZzZXQgfHwgZWwuc2Nyb2xsTGVmdDtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvcDogYm94LnRvcCAgKyBzY3JvbGxUb3AgIC0gY2xpZW50VG9wLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGVmdDogYm94LmxlZnQgKyBzY3JvbGxMZWZ0IC0gY2xpZW50TGVmdFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGhpZGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpc1tpXS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzaG93OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXNbaV0uc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHN0eWxlczogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBpLCBzdHlsZXM7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0pIHJldHVybiB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzWzBdLCBudWxsKTtcbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY3NzOiBmdW5jdGlvbiAocHJvcHMsIHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgdmFyIGk7XG4gICAgICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wcyA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzWzBdKSByZXR1cm4gd2luZG93LmdldENvbXB1dGVkU3R5bGUodGhpc1swXSwgbnVsbCkuZ2V0UHJvcGVydHlWYWx1ZShwcm9wcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIHByb3AgaW4gcHJvcHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXS5zdHlsZVtwcm9wXSA9IHByb3BzW3Byb3BdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyICYmIHR5cGVvZiBwcm9wcyA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV0uc3R5bGVbcHJvcHNdID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgXG4gICAgICAgICAgICAvL0RvbSBtYW5pcHVsYXRpb25cbiAgICAgICAgICAgIGVhY2g6IGZ1bmN0aW9uIChjYWxsYmFjaykge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXNbaV0sIGksIHRoaXNbaV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmaWx0ZXI6IGZ1bmN0aW9uIChjYWxsYmFjaykge1xuICAgICAgICAgICAgICAgIHZhciBtYXRjaGVkSXRlbXMgPSBbXTtcbiAgICAgICAgICAgICAgICB2YXIgZG9tID0gdGhpcztcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRvbS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2suY2FsbChkb21baV0sIGksIGRvbVtpXSkpIG1hdGNoZWRJdGVtcy5wdXNoKGRvbVtpXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRG9tNyhtYXRjaGVkSXRlbXMpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGh0bWw6IGZ1bmN0aW9uIChodG1sKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBodG1sID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1swXSA/IHRoaXNbMF0uaW5uZXJIVE1MIDogdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLmlubmVySFRNTCA9IGh0bWw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRleHQ6IGZ1bmN0aW9uICh0ZXh0KSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0ZXh0ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGhpc1swXSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbMF0udGV4dENvbnRlbnQudHJpbSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV0udGV4dENvbnRlbnQgPSB0ZXh0O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpczogZnVuY3Rpb24gKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzWzBdIHx8IHR5cGVvZiBzZWxlY3RvciA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICB2YXIgY29tcGFyZVdpdGgsIGk7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVsID0gdGhpc1swXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVsID09PSBkb2N1bWVudCkgcmV0dXJuIHNlbGVjdG9yID09PSBkb2N1bWVudDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVsID09PSB3aW5kb3cpIHJldHVybiBzZWxlY3RvciA9PT0gd2luZG93O1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVsLm1hdGNoZXMpIHJldHVybiBlbC5tYXRjaGVzKHNlbGVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoZWwud2Via2l0TWF0Y2hlc1NlbGVjdG9yKSByZXR1cm4gZWwud2Via2l0TWF0Y2hlc1NlbGVjdG9yKHNlbGVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoZWwubW96TWF0Y2hlc1NlbGVjdG9yKSByZXR1cm4gZWwubW96TWF0Y2hlc1NlbGVjdG9yKHNlbGVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoZWwubXNNYXRjaGVzU2VsZWN0b3IpIHJldHVybiBlbC5tc01hdGNoZXNTZWxlY3RvcihzZWxlY3Rvcik7XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29tcGFyZVdpdGggPSAkKHNlbGVjdG9yKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb21wYXJlV2l0aC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21wYXJlV2l0aFtpXSA9PT0gdGhpc1swXSkgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoc2VsZWN0b3IgPT09IGRvY3VtZW50KSByZXR1cm4gdGhpc1swXSA9PT0gZG9jdW1lbnQ7XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoc2VsZWN0b3IgPT09IHdpbmRvdykgcmV0dXJuIHRoaXNbMF0gPT09IHdpbmRvdztcbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdG9yLm5vZGVUeXBlIHx8IHNlbGVjdG9yIGluc3RhbmNlb2YgRG9tNykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29tcGFyZVdpdGggPSBzZWxlY3Rvci5ub2RlVHlwZSA/IFtzZWxlY3Rvcl0gOiBzZWxlY3RvcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjb21wYXJlV2l0aC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb21wYXJlV2l0aFtpXSA9PT0gdGhpc1swXSkgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaW5kZXhPZjogZnVuY3Rpb24gKGVsKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzW2ldID09PSBlbCkgcmV0dXJuIGk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGluZGV4OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNoaWxkID0gdGhpc1swXTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGkgPSAwO1xuICAgICAgICAgICAgICAgICAgICB3aGlsZSAoKGNoaWxkID0gY2hpbGQucHJldmlvdXNTaWJsaW5nKSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLm5vZGVUeXBlID09PSAxKSBpKys7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcTogZnVuY3Rpb24gKGluZGV4KSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgICAgIHZhciBsZW5ndGggPSB0aGlzLmxlbmd0aDtcbiAgICAgICAgICAgICAgICB2YXIgcmV0dXJuSW5kZXg7XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4ID4gbGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERvbTcoW10pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybkluZGV4ID0gbGVuZ3RoICsgaW5kZXg7XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXR1cm5JbmRleCA8IDApIHJldHVybiBuZXcgRG9tNyhbXSk7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIG5ldyBEb203KFt0aGlzW3JldHVybkluZGV4XV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERvbTcoW3RoaXNbaW5kZXhdXSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYXBwZW5kOiBmdW5jdGlvbiAobmV3Q2hpbGQpIHtcbiAgICAgICAgICAgICAgICB2YXIgaSwgajtcbiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG5ld0NoaWxkID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRlbXBEaXYuaW5uZXJIVE1MID0gbmV3Q2hpbGQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSAodGVtcERpdi5maXJzdENoaWxkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXS5hcHBlbmRDaGlsZCh0ZW1wRGl2LmZpcnN0Q2hpbGQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG5ld0NoaWxkIGluc3RhbmNlb2YgRG9tNykge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IG5ld0NoaWxkLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXS5hcHBlbmRDaGlsZChuZXdDaGlsZFtqXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLmFwcGVuZENoaWxkKG5ld0NoaWxkKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBhcHBlbmRUbzogZnVuY3Rpb24gKHBhcmVudCkge1xuICAgICAgICAgICAgICAgICQocGFyZW50KS5hcHBlbmQodGhpcyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcHJlcGVuZDogZnVuY3Rpb24gKG5ld0NoaWxkKSB7XG4gICAgICAgICAgICAgICAgdmFyIGksIGo7XG4gICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBuZXdDaGlsZCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZW1wRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0ZW1wRGl2LmlubmVySFRNTCA9IG5ld0NoaWxkO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gdGVtcERpdi5jaGlsZE5vZGVzLmxlbmd0aCAtIDE7IGogPj0gMDsgai0tKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpc1tpXS5pbnNlcnRCZWZvcmUodGVtcERpdi5jaGlsZE5vZGVzW2pdLCB0aGlzW2ldLmNoaWxkTm9kZXNbMF0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gdGhpc1tpXS5pbnNlcnRBZGphY2VudEhUTUwoJ2FmdGVyYmVnaW4nLCBuZXdDaGlsZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobmV3Q2hpbGQgaW5zdGFuY2VvZiBEb203KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSAwOyBqIDwgbmV3Q2hpbGQubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzW2ldLmluc2VydEJlZm9yZShuZXdDaGlsZFtqXSwgdGhpc1tpXS5jaGlsZE5vZGVzWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXNbaV0uaW5zZXJ0QmVmb3JlKG5ld0NoaWxkLCB0aGlzW2ldLmNoaWxkTm9kZXNbMF0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHByZXBlbmRUbzogZnVuY3Rpb24gKHBhcmVudCkge1xuICAgICAgICAgICAgICAgICQocGFyZW50KS5wcmVwZW5kKHRoaXMpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGluc2VydEJlZm9yZTogZnVuY3Rpb24gKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgdmFyIGJlZm9yZSA9ICQoc2VsZWN0b3IpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYmVmb3JlLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlWzBdLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRoaXNbaV0sIGJlZm9yZVswXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoYmVmb3JlLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYmVmb3JlLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYmVmb3JlW2pdLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRoaXNbaV0uY2xvbmVOb2RlKHRydWUpLCBiZWZvcmVbal0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGluc2VydEFmdGVyOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHtcbiAgICAgICAgICAgICAgICB2YXIgYWZ0ZXIgPSAkKHNlbGVjdG9yKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFmdGVyLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJbMF0ucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGhpc1tpXSwgYWZ0ZXJbMF0ubmV4dFNpYmxpbmcpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGFmdGVyLmxlbmd0aCA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgYWZ0ZXIubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZnRlcltqXS5wYXJlbnROb2RlLmluc2VydEJlZm9yZSh0aGlzW2ldLmNsb25lTm9kZSh0cnVlKSwgYWZ0ZXJbal0ubmV4dFNpYmxpbmcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG5leHQ6IGZ1bmN0aW9uIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc1swXS5uZXh0RWxlbWVudFNpYmxpbmcgJiYgJCh0aGlzWzBdLm5leHRFbGVtZW50U2libGluZykuaXMoc2VsZWN0b3IpKSByZXR1cm4gbmV3IERvbTcoW3RoaXNbMF0ubmV4dEVsZW1lbnRTaWJsaW5nXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBuZXcgRG9tNyhbXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpc1swXS5uZXh0RWxlbWVudFNpYmxpbmcpIHJldHVybiBuZXcgRG9tNyhbdGhpc1swXS5uZXh0RWxlbWVudFNpYmxpbmddKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIG5ldyBEb203KFtdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBuZXcgRG9tNyhbXSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbmV4dEFsbDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgdmFyIG5leHRFbHMgPSBbXTtcbiAgICAgICAgICAgICAgICB2YXIgZWwgPSB0aGlzWzBdO1xuICAgICAgICAgICAgICAgIGlmICghZWwpIHJldHVybiBuZXcgRG9tNyhbXSk7XG4gICAgICAgICAgICAgICAgd2hpbGUgKGVsLm5leHRFbGVtZW50U2libGluZykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbmV4dCA9IGVsLm5leHRFbGVtZW50U2libGluZztcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZigkKG5leHQpLmlzKHNlbGVjdG9yKSkgbmV4dEVscy5wdXNoKG5leHQpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgbmV4dEVscy5wdXNoKG5leHQpO1xuICAgICAgICAgICAgICAgICAgICBlbCA9IG5leHQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRG9tNyhuZXh0RWxzKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwcmV2OiBmdW5jdGlvbiAoc2VsZWN0b3IpIHtcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3Rvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0ucHJldmlvdXNFbGVtZW50U2libGluZyAmJiAkKHRoaXNbMF0ucHJldmlvdXNFbGVtZW50U2libGluZykuaXMoc2VsZWN0b3IpKSByZXR1cm4gbmV3IERvbTcoW3RoaXNbMF0ucHJldmlvdXNFbGVtZW50U2libGluZ10pO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSByZXR1cm4gbmV3IERvbTcoW10pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbMF0ucHJldmlvdXNFbGVtZW50U2libGluZykgcmV0dXJuIG5ldyBEb203KFt0aGlzWzBdLnByZXZpb3VzRWxlbWVudFNpYmxpbmddKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIG5ldyBEb203KFtdKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBuZXcgRG9tNyhbXSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcHJldkFsbDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgdmFyIHByZXZFbHMgPSBbXTtcbiAgICAgICAgICAgICAgICB2YXIgZWwgPSB0aGlzWzBdO1xuICAgICAgICAgICAgICAgIGlmICghZWwpIHJldHVybiBuZXcgRG9tNyhbXSk7XG4gICAgICAgICAgICAgICAgd2hpbGUgKGVsLnByZXZpb3VzRWxlbWVudFNpYmxpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByZXYgPSBlbC5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xuICAgICAgICAgICAgICAgICAgICBpZiAoc2VsZWN0b3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCQocHJldikuaXMoc2VsZWN0b3IpKSBwcmV2RWxzLnB1c2gocHJldik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBwcmV2RWxzLnB1c2gocHJldik7XG4gICAgICAgICAgICAgICAgICAgIGVsID0gcHJldjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEb203KHByZXZFbHMpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHBhcmVudDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBhcmVudHMgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbaV0ucGFyZW50Tm9kZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQodGhpc1tpXS5wYXJlbnROb2RlKS5pcyhzZWxlY3RvcikpIHBhcmVudHMucHVzaCh0aGlzW2ldLnBhcmVudE5vZGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLnB1c2godGhpc1tpXS5wYXJlbnROb2RlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gJCgkLnVuaXF1ZShwYXJlbnRzKSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcGFyZW50czogZnVuY3Rpb24gKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBhcmVudHMgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcmVudCA9IHRoaXNbaV0ucGFyZW50Tm9kZTtcbiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKHBhcmVudCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCQocGFyZW50KS5pcyhzZWxlY3RvcikpIHBhcmVudHMucHVzaChwYXJlbnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50cy5wdXNoKHBhcmVudCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQgPSBwYXJlbnQucGFyZW50Tm9kZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gJCgkLnVuaXF1ZShwYXJlbnRzKSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgY2xvc2VzdDogZnVuY3Rpb24gKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNsb3Nlc3QgPSB0aGlzO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRG9tNyhbXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghY2xvc2VzdC5pcyhzZWxlY3RvcikpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xvc2VzdCA9IGNsb3Nlc3QucGFyZW50cyhzZWxlY3RvcikuZXEoMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBjbG9zZXN0O1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGZpbmQgOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHtcbiAgICAgICAgICAgICAgICB2YXIgZm91bmRFbGVtZW50cyA9IFtdO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZm91bmQgPSB0aGlzW2ldLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGZvdW5kLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3VuZEVsZW1lbnRzLnB1c2goZm91bmRbal0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRG9tNyhmb3VuZEVsZW1lbnRzKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjaGlsZHJlbjogZnVuY3Rpb24gKHNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNoaWxkcmVuID0gW107XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZE5vZGVzID0gdGhpc1tpXS5jaGlsZE5vZGVzO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBjaGlsZE5vZGVzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXNlbGVjdG9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkTm9kZXNbal0ubm9kZVR5cGUgPT09IDEpIGNoaWxkcmVuLnB1c2goY2hpbGROb2Rlc1tqXSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hpbGROb2Rlc1tqXS5ub2RlVHlwZSA9PT0gMSAmJiAkKGNoaWxkTm9kZXNbal0pLmlzKHNlbGVjdG9yKSkgY2hpbGRyZW4ucHVzaChjaGlsZE5vZGVzW2pdKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IERvbTcoJC51bmlxdWUoY2hpbGRyZW4pKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXNbaV0ucGFyZW50Tm9kZSkgdGhpc1tpXS5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXNbaV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkZXRhY2g6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5yZW1vdmUoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBhZGQ6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgZG9tID0gdGhpcztcbiAgICAgICAgICAgICAgICB2YXIgaSwgajtcbiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0b0FkZCA9ICQoYXJndW1lbnRzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IHRvQWRkLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb21bZG9tLmxlbmd0aF0gPSB0b0FkZFtqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGRvbS5sZW5ndGgrKztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gZG9tO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLy8gU2hvcnRjdXRzXG4gICAgICAgIChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgc2hvcnRjdXRzID0gKCdjbGljayBibHVyIGZvY3VzIGZvY3VzaW4gZm9jdXNvdXQga2V5dXAga2V5ZG93biBrZXlwcmVzcyBzdWJtaXQgY2hhbmdlIG1vdXNlZG93biBtb3VzZW1vdmUgbW91c2V1cCBtb3VzZWVudGVyIG1vdXNlbGVhdmUgbW91c2VvdXQgbW91c2VvdmVyIHRvdWNoc3RhcnQgdG91Y2hlbmQgdG91Y2htb3ZlIHJlc2l6ZSBzY3JvbGwnKS5zcGxpdCgnICcpO1xuICAgICAgICAgICAgdmFyIG5vdFRyaWdnZXIgPSAoJ3Jlc2l6ZSBzY3JvbGwnKS5zcGxpdCgnICcpO1xuICAgICAgICAgICAgZnVuY3Rpb24gY3JlYXRlTWV0aG9kKG5hbWUpIHtcbiAgICAgICAgICAgICAgICBEb203LnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uICh0YXJnZXRTZWxlY3RvciwgbGlzdGVuZXIsIGNhcHR1cmUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGk7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0U2VsZWN0b3IgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgdGhpcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub3RUcmlnZ2VyLmluZGV4T2YobmFtZSkgPCAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuYW1lIGluIHRoaXNbaV0pIHRoaXNbaV1bbmFtZV0oKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKHRoaXNbaV0pLnRyaWdnZXIobmFtZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9uKG5hbWUsIHRhcmdldFNlbGVjdG9yLCBsaXN0ZW5lciwgY2FwdHVyZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzaG9ydGN1dHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBjcmVhdGVNZXRob2Qoc2hvcnRjdXRzW2ldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSkoKTtcbiAgICAgICAgXG5cbiAgICAgICAgLy8gR2xvYmFsIEFqYXggU2V0dXBcbiAgICAgICAgdmFyIGdsb2JhbEFqYXhPcHRpb25zID0ge307XG4gICAgICAgICQuYWpheFNldHVwID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnR5cGUpIG9wdGlvbnMubWV0aG9kID0gb3B0aW9ucy50eXBlO1xuICAgICAgICAgICAgJC5lYWNoKG9wdGlvbnMsIGZ1bmN0aW9uIChvcHRpb25OYW1lLCBvcHRpb25WYWx1ZSkge1xuICAgICAgICAgICAgICAgIGdsb2JhbEFqYXhPcHRpb25zW29wdGlvbk5hbWVdICA9IG9wdGlvblZhbHVlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvLyBBamF4XG4gICAgICAgIHZhciBfanNvbnBSZXF1ZXN0cyA9IDA7XG4gICAgICAgICQuYWpheCA9IGZ1bmN0aW9uIChvcHRpb25zKSB7XG4gICAgICAgICAgICB2YXIgZGVmYXVsdHMgPSB7XG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICAgICAgICBkYXRhOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBhc3luYzogdHJ1ZSxcbiAgICAgICAgICAgICAgICBjYWNoZTogdHJ1ZSxcbiAgICAgICAgICAgICAgICB1c2VyOiAnJyxcbiAgICAgICAgICAgICAgICBwYXNzd29yZDogJycsXG4gICAgICAgICAgICAgICAgaGVhZGVyczoge30sXG4gICAgICAgICAgICAgICAgeGhyRmllbGRzOiB7fSxcbiAgICAgICAgICAgICAgICBzdGF0dXNDb2RlOiB7fSxcbiAgICAgICAgICAgICAgICBwcm9jZXNzRGF0YTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBkYXRhVHlwZTogJ3RleHQnLFxuICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyxcbiAgICAgICAgICAgICAgICB0aW1lb3V0OiAwXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgdmFyIGNhbGxiYWNrcyA9IFsnYmVmb3JlU2VuZCcsICdlcnJvcicsICdjb21wbGV0ZScsICdzdWNjZXNzJywgJ3N0YXR1c0NvZGUnXTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgLy9Gb3IgalF1ZXJ5IGd1eXNcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnR5cGUpIG9wdGlvbnMubWV0aG9kID0gb3B0aW9ucy50eXBlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIE1lcmdlIGdsb2JhbCBhbmQgZGVmYXVsdHNcbiAgICAgICAgICAgICQuZWFjaChnbG9iYWxBamF4T3B0aW9ucywgZnVuY3Rpb24gKGdsb2JhbE9wdGlvbk5hbWUsIGdsb2JhbE9wdGlvblZhbHVlKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrcy5pbmRleE9mKGdsb2JhbE9wdGlvbk5hbWUpIDwgMCkgZGVmYXVsdHNbZ2xvYmFsT3B0aW9uTmFtZV0gPSBnbG9iYWxPcHRpb25WYWx1ZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIEZ1bmN0aW9uIHRvIHJ1biBYSFIgY2FsbGJhY2tzIGFuZCBldmVudHNcbiAgICAgICAgICAgIGZ1bmN0aW9uIGZpcmVBamF4Q2FsbGJhY2sgKGV2ZW50TmFtZSwgZXZlbnREYXRhLCBjYWxsYmFja05hbWUpIHtcbiAgICAgICAgICAgICAgICB2YXIgYSA9IGFyZ3VtZW50cztcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnROYW1lKSAkKGRvY3VtZW50KS50cmlnZ2VyKGV2ZW50TmFtZSwgZXZlbnREYXRhKTtcbiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIEdsb2JhbCBjYWxsYmFja1xuICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2tOYW1lIGluIGdsb2JhbEFqYXhPcHRpb25zKSBnbG9iYWxBamF4T3B0aW9uc1tjYWxsYmFja05hbWVdKGFbM10sIGFbNF0sIGFbNV0sIGFbNl0pO1xuICAgICAgICAgICAgICAgICAgICAvLyBPcHRpb25zIGNhbGxiYWNrXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zW2NhbGxiYWNrTmFtZV0pIG9wdGlvbnNbY2FsbGJhY2tOYW1lXShhWzNdLCBhWzRdLCBhWzVdLCBhWzZdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gTWVyZ2Ugb3B0aW9ucyBhbmQgZGVmYXVsdHNcbiAgICAgICAgICAgICQuZWFjaChkZWZhdWx0cywgZnVuY3Rpb24gKHByb3AsIGRlZmF1bHRWYWx1ZSkge1xuICAgICAgICAgICAgICAgIGlmICghKHByb3AgaW4gb3B0aW9ucykpIG9wdGlvbnNbcHJvcF0gPSBkZWZhdWx0VmFsdWU7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBEZWZhdWx0IFVSTFxuICAgICAgICAgICAgaWYgKCFvcHRpb25zLnVybCkge1xuICAgICAgICAgICAgICAgIG9wdGlvbnMudXJsID0gd2luZG93LmxvY2F0aW9uLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBQYXJhbWV0ZXJzIFByZWZpeFxuICAgICAgICAgICAgdmFyIHBhcmFtc1ByZWZpeCA9IG9wdGlvbnMudXJsLmluZGV4T2YoJz8nKSA+PSAwID8gJyYnIDogJz8nO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFVDIG1ldGhvZFxuICAgICAgICAgICAgdmFyIF9tZXRob2QgPSBvcHRpb25zLm1ldGhvZC50b1VwcGVyQ2FzZSgpO1xuICAgICAgICAgICAgLy8gRGF0YSB0byBtb2RpZnkgR0VUIFVSTFxuICAgICAgICAgICAgaWYgKChfbWV0aG9kID09PSAnR0VUJyB8fCBfbWV0aG9kID09PSAnSEVBRCcgfHwgX21ldGhvZCA9PT0gJ09QVElPTlMnIHx8IF9tZXRob2QgPT09ICdERUxFVEUnKSAmJiBvcHRpb25zLmRhdGEpIHtcbiAgICAgICAgICAgICAgICB2YXIgc3RyaW5nRGF0YTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnMuZGF0YSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gU2hvdWxkIGJlIGtleT12YWx1ZSBzdHJpbmdcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZGF0YS5pbmRleE9mKCc/JykgPj0gMCkgc3RyaW5nRGF0YSA9IG9wdGlvbnMuZGF0YS5zcGxpdCgnPycpWzFdO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHN0cmluZ0RhdGEgPSBvcHRpb25zLmRhdGE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyBTaG91bGQgYmUga2V5PXZhbHVlIG9iamVjdFxuICAgICAgICAgICAgICAgICAgICBzdHJpbmdEYXRhID0gJC5zZXJpYWxpemVPYmplY3Qob3B0aW9ucy5kYXRhKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHN0cmluZ0RhdGEubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMudXJsICs9IHBhcmFtc1ByZWZpeCArIHN0cmluZ0RhdGE7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbXNQcmVmaXggPT09ICc/JykgcGFyYW1zUHJlZml4ID0gJyYnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIEpTT05QXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5kYXRhVHlwZSA9PT0gJ2pzb24nICYmIG9wdGlvbnMudXJsLmluZGV4T2YoJ2NhbGxiYWNrPScpID49IDApIHtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrTmFtZSA9ICdmN2pzb25wXycgKyBEYXRlLm5vdygpICsgKF9qc29ucFJlcXVlc3RzKyspO1xuICAgICAgICAgICAgICAgIHZhciBhYm9ydFRpbWVvdXQ7XG4gICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrU3BsaXQgPSBvcHRpb25zLnVybC5zcGxpdCgnY2FsbGJhY2s9Jyk7XG4gICAgICAgICAgICAgICAgdmFyIHJlcXVlc3RVcmwgPSBjYWxsYmFja1NwbGl0WzBdICsgJ2NhbGxiYWNrPScgKyBjYWxsYmFja05hbWU7XG4gICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrU3BsaXRbMV0uaW5kZXhPZignJicpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFkZFZhcnMgPSBjYWxsYmFja1NwbGl0WzFdLnNwbGl0KCcmJykuZmlsdGVyKGZ1bmN0aW9uIChlbCkgeyByZXR1cm4gZWwuaW5kZXhPZignPScpID4gMDsgfSkuam9pbignJicpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoYWRkVmFycy5sZW5ndGggPiAwKSByZXF1ZXN0VXJsICs9ICcmJyArIGFkZFZhcnM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBDcmVhdGUgc2NyaXB0XG4gICAgICAgICAgICAgICAgdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgICAgICAgICAgICAgIHNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7XG4gICAgICAgICAgICAgICAgc2NyaXB0Lm9uZXJyb3IgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCk7XG4gICAgICAgICAgICAgICAgICAgIGZpcmVBamF4Q2FsbGJhY2sodW5kZWZpbmVkLCB1bmRlZmluZWQsICdlcnJvcicsIG51bGwsICdzY3JpcHRlcnJvcicpO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgc2NyaXB0LnNyYyA9IHJlcXVlc3RVcmw7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIEhhbmRsZXJcbiAgICAgICAgICAgICAgICB3aW5kb3dbY2FsbGJhY2tOYW1lXSA9IGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChhYm9ydFRpbWVvdXQpO1xuICAgICAgICAgICAgICAgICAgICBmaXJlQWpheENhbGxiYWNrKHVuZGVmaW5lZCwgdW5kZWZpbmVkLCAnc3VjY2VzcycsIGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICBzY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHQpO1xuICAgICAgICAgICAgICAgICAgICBzY3JpcHQgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgd2luZG93W2NhbGxiYWNrTmFtZV07XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdoZWFkJykuYXBwZW5kQ2hpbGQoc2NyaXB0KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMudGltZW91dCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzY3JpcHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChzY3JpcHQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc2NyaXB0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpcmVBamF4Q2FsbGJhY2sodW5kZWZpbmVkLCB1bmRlZmluZWQsICdlcnJvcicsIG51bGwsICd0aW1lb3V0Jyk7XG4gICAgICAgICAgICAgICAgICAgIH0sIG9wdGlvbnMudGltZW91dCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ2FjaGUgZm9yIEdFVC9IRUFEIHJlcXVlc3RzXG4gICAgICAgICAgICBpZiAoX21ldGhvZCA9PT0gJ0dFVCcgfHwgX21ldGhvZCA9PT0gJ0hFQUQnIHx8IF9tZXRob2QgPT09ICdPUFRJT05TJyB8fCBfbWV0aG9kID09PSAnREVMRVRFJykge1xuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmNhY2hlID09PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnVybCArPSAocGFyYW1zUHJlZml4ICsgJ19ub2NhY2hlPScgKyBEYXRlLm5vdygpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ3JlYXRlIFhIUlxuICAgICAgICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFNhdmUgUmVxdWVzdCBVUkxcbiAgICAgICAgICAgIHhoci5yZXF1ZXN0VXJsID0gb3B0aW9ucy51cmw7XG4gICAgICAgICAgICB4aHIucmVxdWVzdFBhcmFtZXRlcnMgPSBvcHRpb25zO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIE9wZW4gWEhSXG4gICAgICAgICAgICB4aHIub3BlbihfbWV0aG9kLCBvcHRpb25zLnVybCwgb3B0aW9ucy5hc3luYywgb3B0aW9ucy51c2VyLCBvcHRpb25zLnBhc3N3b3JkKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDcmVhdGUgUE9TVCBEYXRhXG4gICAgICAgICAgICB2YXIgcG9zdERhdGEgPSBudWxsO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmICgoX21ldGhvZCA9PT0gJ1BPU1QnIHx8IF9tZXRob2QgPT09ICdQVVQnIHx8IF9tZXRob2QgPT09ICdQQVRDSCcpICYmIG9wdGlvbnMuZGF0YSkge1xuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnByb2Nlc3NEYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwb3N0RGF0YUluc3RhbmNlcyA9IFtBcnJheUJ1ZmZlciwgQmxvYiwgRG9jdW1lbnQsIEZvcm1EYXRhXTtcbiAgICAgICAgICAgICAgICAgICAgLy8gUG9zdCBEYXRhXG4gICAgICAgICAgICAgICAgICAgIGlmIChwb3N0RGF0YUluc3RhbmNlcy5pbmRleE9mKG9wdGlvbnMuZGF0YS5jb25zdHJ1Y3RvcikgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcG9zdERhdGEgPSBvcHRpb25zLmRhdGE7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBQT1NUIEhlYWRlcnNcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBib3VuZGFyeSA9ICctLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0nICsgRGF0ZS5ub3coKS50b1N0cmluZygxNik7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY29udGVudFR5cGUgPT09ICdtdWx0aXBhcnRcXC9mb3JtLWRhdGEnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtVHlwZScsICdtdWx0aXBhcnRcXC9mb3JtLWRhdGE7IGJvdW5kYXJ5PScgKyBib3VuZGFyeSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignQ29udGVudC1UeXBlJywgb3B0aW9ucy5jb250ZW50VHlwZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBwb3N0RGF0YSA9ICcnO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9kYXRhID0gJC5zZXJpYWxpemVPYmplY3Qob3B0aW9ucy5kYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmNvbnRlbnRUeXBlID09PSAnbXVsdGlwYXJ0XFwvZm9ybS1kYXRhJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvdW5kYXJ5ID0gJy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLScgKyBEYXRlLm5vdygpLnRvU3RyaW5nKDE2KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZGF0YSA9IF9kYXRhLnNwbGl0KCcmJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIF9uZXdEYXRhID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBfZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfbmV3RGF0YS5wdXNoKCdDb250ZW50LURpc3Bvc2l0aW9uOiBmb3JtLWRhdGE7IG5hbWU9XCInICsgX2RhdGFbaV0uc3BsaXQoJz0nKVswXSArICdcIlxcclxcblxcclxcbicgKyBfZGF0YVtpXS5zcGxpdCgnPScpWzFdICsgJ1xcclxcbicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3N0RGF0YSA9ICctLScgKyBib3VuZGFyeSArICdcXHJcXG4nICsgX25ld0RhdGEuam9pbignLS0nICsgYm91bmRhcnkgKyAnXFxyXFxuJykgKyAnLS0nICsgYm91bmRhcnkgKyAnLS1cXHJcXG4nO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zdERhdGEgPSBvcHRpb25zLmNvbnRlbnRUeXBlID09PSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyA/IF9kYXRhIDogX2RhdGEucmVwbGFjZSgvJi9nLCAnXFxyXFxuJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBvc3REYXRhID0gb3B0aW9ucy5kYXRhO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQWRkaXRpb25hbCBoZWFkZXJzXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5oZWFkZXJzKSB7XG4gICAgICAgICAgICAgICAgJC5lYWNoKG9wdGlvbnMuaGVhZGVycywgZnVuY3Rpb24gKGhlYWRlck5hbWUsIGhlYWRlckNhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGhlYWRlck5hbWUsIGhlYWRlckNhbGxiYWNrKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDaGVjayBmb3IgY3Jvc3NEb21haW5cbiAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5jcm9zc0RvbWFpbiA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBvcHRpb25zLmNyb3NzRG9tYWluID0gL14oW1xcdy1dKzopP1xcL1xcLyhbXlxcL10rKS8udGVzdChvcHRpb25zLnVybCkgJiYgUmVnRXhwLiQyICE9PSB3aW5kb3cubG9jYXRpb24uaG9zdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoIW9wdGlvbnMuY3Jvc3NEb21haW4pIHtcbiAgICAgICAgICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1SZXF1ZXN0ZWQtV2l0aCcsICdYTUxIdHRwUmVxdWVzdCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnhockZpZWxkcykge1xuICAgICAgICAgICAgICAgICQuZWFjaChvcHRpb25zLnhockZpZWxkcywgZnVuY3Rpb24gKGZpZWxkTmFtZSwgZmllbGRWYWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICB4aHJbZmllbGROYW1lXSA9IGZpZWxkVmFsdWU7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHhoclRpbWVvdXQ7XG4gICAgICAgICAgICAvLyBIYW5kbGUgWEhSXG4gICAgICAgICAgICB4aHIub25sb2FkID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoeGhyVGltZW91dCkgY2xlYXJUaW1lb3V0KHhoclRpbWVvdXQpO1xuICAgICAgICAgICAgICAgIGlmICgoeGhyLnN0YXR1cyA+PSAyMDAgJiYgeGhyLnN0YXR1cyA8IDMwMCkgfHwgeGhyLnN0YXR1cyA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcmVzcG9uc2VEYXRhO1xuICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5kYXRhVHlwZSA9PT0gJ2pzb24nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlRGF0YSA9IEpTT04ucGFyc2UoeGhyLnJlc3BvbnNlVGV4dCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlyZUFqYXhDYWxsYmFjaygnYWpheFN1Y2Nlc3MnLCB7eGhyOiB4aHJ9LCAnc3VjY2VzcycsIHJlc3BvbnNlRGF0YSwgeGhyLnN0YXR1cywgeGhyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaXJlQWpheENhbGxiYWNrKCdhamF4RXJyb3InLCB7eGhyOiB4aHIsIHBhcnNlZXJyb3I6IHRydWV9LCAnZXJyb3InLCB4aHIsICdwYXJzZWVycm9yJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNwb25zZURhdGEgPSB4aHIucmVzcG9uc2VUeXBlID09PSAndGV4dCcgfHwgeGhyLnJlc3BvbnNlVHlwZSA9PT0gJycgPyB4aHIucmVzcG9uc2VUZXh0IDogeGhyLnJlc3BvbnNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgZmlyZUFqYXhDYWxsYmFjaygnYWpheFN1Y2Nlc3MnLCB7eGhyOiB4aHJ9LCAnc3VjY2VzcycsIHJlc3BvbnNlRGF0YSwgeGhyLnN0YXR1cywgeGhyKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgZmlyZUFqYXhDYWxsYmFjaygnYWpheEVycm9yJywge3hocjogeGhyfSwgJ2Vycm9yJywgeGhyLCB4aHIuc3RhdHVzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuc3RhdHVzQ29kZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZ2xvYmFsQWpheE9wdGlvbnMuc3RhdHVzQ29kZSAmJiBnbG9iYWxBamF4T3B0aW9ucy5zdGF0dXNDb2RlW3hoci5zdGF0dXNdKSBnbG9iYWxBamF4T3B0aW9ucy5zdGF0dXNDb2RlW3hoci5zdGF0dXNdKHhocik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnN0YXR1c0NvZGVbeGhyLnN0YXR1c10pIG9wdGlvbnMuc3RhdHVzQ29kZVt4aHIuc3RhdHVzXSh4aHIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBmaXJlQWpheENhbGxiYWNrKCdhamF4Q29tcGxldGUnLCB7eGhyOiB4aHJ9LCAnY29tcGxldGUnLCB4aHIsIHhoci5zdGF0dXMpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICB4aHIub25lcnJvciA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHhoclRpbWVvdXQpIGNsZWFyVGltZW91dCh4aHJUaW1lb3V0KTtcbiAgICAgICAgICAgICAgICBmaXJlQWpheENhbGxiYWNrKCdhamF4RXJyb3InLCB7eGhyOiB4aHJ9LCAnZXJyb3InLCB4aHIsIHhoci5zdGF0dXMpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBBamF4IHN0YXJ0IGNhbGxiYWNrXG4gICAgICAgICAgICBmaXJlQWpheENhbGxiYWNrKCdhamF4U3RhcnQnLCB7eGhyOiB4aHJ9LCAnc3RhcnQnLCB4aHIpO1xuICAgICAgICAgICAgZmlyZUFqYXhDYWxsYmFjayh1bmRlZmluZWQsIHVuZGVmaW5lZCwgJ2JlZm9yZVNlbmQnLCB4aHIpO1xuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTZW5kIFhIUlxuICAgICAgICAgICAgeGhyLnNlbmQocG9zdERhdGEpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFRpbWVvdXRcbiAgICAgICAgICAgIGlmIChvcHRpb25zLnRpbWVvdXQgPiAwKSB7XG4gICAgICAgICAgICAgICAgeGhyLm9uYWJvcnQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh4aHJUaW1lb3V0KSBjbGVhclRpbWVvdXQoeGhyVGltZW91dCk7XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB4aHJUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHhoci5hYm9ydCgpO1xuICAgICAgICAgICAgICAgICAgICBmaXJlQWpheENhbGxiYWNrKCdhamF4RXJyb3InLCB7eGhyOiB4aHIsIHRpbWVvdXQ6IHRydWV9LCAnZXJyb3InLCB4aHIsICd0aW1lb3V0Jyk7XG4gICAgICAgICAgICAgICAgICAgIGZpcmVBamF4Q2FsbGJhY2soJ2FqYXhDb21wbGV0ZScsIHt4aHI6IHhociwgdGltZW91dDogdHJ1ZX0sICdjb21wbGV0ZScsIHhociwgJ3RpbWVvdXQnKTtcbiAgICAgICAgICAgICAgICB9LCBvcHRpb25zLnRpbWVvdXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFJldHVybiBYSFIgb2JqZWN0XG4gICAgICAgICAgICByZXR1cm4geGhyO1xuICAgICAgICB9O1xuICAgICAgICAvLyBTaHJvdGN1dHNcbiAgICAgICAgKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBtZXRob2RzID0gKCdnZXQgcG9zdCBnZXRKU09OJykuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgIGZ1bmN0aW9uIGNyZWF0ZU1ldGhvZChtZXRob2QpIHtcbiAgICAgICAgICAgICAgICAkW21ldGhvZF0gPSBmdW5jdGlvbiAodXJsLCBkYXRhLCBzdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAkLmFqYXgoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmwsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IG1ldGhvZCA9PT0gJ3Bvc3QnID8gJ1BPU1QnIDogJ0dFVCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiB0eXBlb2YgZGF0YSA9PT0gJ2Z1bmN0aW9uJyA/IHVuZGVmaW5lZCA6IGRhdGEsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiB0eXBlb2YgZGF0YSA9PT0gJ2Z1bmN0aW9uJyA/IGRhdGEgOiBzdWNjZXNzLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6IG1ldGhvZCA9PT0gJ2dldEpTT04nID8gJ2pzb24nIDogdW5kZWZpbmVkXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1ldGhvZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBjcmVhdGVNZXRob2QobWV0aG9kc1tpXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pKCk7XG4gICAgICAgIFxuXG4gICAgICAgIC8vIERPTSBMaWJyYXJ5IFV0aWxpdGVzXG4gICAgICAgICQucGFyc2VVcmxRdWVyeSA9IGZ1bmN0aW9uICh1cmwpIHtcbiAgICAgICAgICAgIHZhciBxdWVyeSA9IHt9LCBpLCBwYXJhbXMsIHBhcmFtO1xuICAgICAgICAgICAgaWYgKHVybC5pbmRleE9mKCc/JykgPj0gMCkgdXJsID0gdXJsLnNwbGl0KCc/JylbMV07XG4gICAgICAgICAgICBlbHNlIHJldHVybiBxdWVyeTtcbiAgICAgICAgICAgIHBhcmFtcyA9IHVybC5zcGxpdCgnJicpO1xuICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHBhcmFtcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHBhcmFtID0gcGFyYW1zW2ldLnNwbGl0KCc9Jyk7XG4gICAgICAgICAgICAgICAgcXVlcnlbcGFyYW1bMF1dID0gcGFyYW1bMV07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcXVlcnk7XG4gICAgICAgIH07XG4gICAgICAgICQuaXNBcnJheSA9IGZ1bmN0aW9uIChhcnIpIHtcbiAgICAgICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmFwcGx5KGFycikgPT09ICdbb2JqZWN0IEFycmF5XScpIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgZWxzZSByZXR1cm4gZmFsc2U7XG4gICAgICAgIH07XG4gICAgICAgICQuZWFjaCA9IGZ1bmN0aW9uIChvYmosIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG9iaiAhPT0gJ29iamVjdCcpIHJldHVybjtcbiAgICAgICAgICAgIGlmICghY2FsbGJhY2spIHJldHVybjtcbiAgICAgICAgICAgIHZhciBpLCBwcm9wO1xuICAgICAgICAgICAgaWYgKCQuaXNBcnJheShvYmopIHx8IG9iaiBpbnN0YW5jZW9mIERvbTcpIHtcbiAgICAgICAgICAgICAgICAvLyBBcnJheVxuICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBvYmoubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soaSwgb2JqW2ldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBPYmplY3RcbiAgICAgICAgICAgICAgICBmb3IgKHByb3AgaW4gb2JqKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvYmouaGFzT3duUHJvcGVydHkocHJvcCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHByb3AsIG9ialtwcm9wXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgICQudW5pcXVlID0gZnVuY3Rpb24gKGFycikge1xuICAgICAgICAgICAgdmFyIHVuaXF1ZSA9IFtdO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZiAodW5pcXVlLmluZGV4T2YoYXJyW2ldKSA9PT0gLTEpIHVuaXF1ZS5wdXNoKGFycltpXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdW5pcXVlO1xuICAgICAgICB9O1xuICAgICAgICAkLnNlcmlhbGl6ZU9iamVjdCA9ICQucGFyYW0gPSBmdW5jdGlvbiAob2JqLCBwYXJlbnRzKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ3N0cmluZycpIHJldHVybiBvYmo7XG4gICAgICAgICAgICB2YXIgcmVzdWx0QXJyYXkgPSBbXTtcbiAgICAgICAgICAgIHZhciBzZXBhcmF0b3IgPSAnJic7XG4gICAgICAgICAgICBwYXJlbnRzID0gcGFyZW50cyB8fCBbXTtcbiAgICAgICAgICAgIHZhciBuZXdQYXJlbnRzO1xuICAgICAgICAgICAgZnVuY3Rpb24gdmFyX25hbWUobmFtZSkge1xuICAgICAgICAgICAgICAgIGlmIChwYXJlbnRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIF9wYXJlbnRzID0gJyc7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcGFyZW50cy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGogPT09IDApIF9wYXJlbnRzICs9IHBhcmVudHNbal07XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIF9wYXJlbnRzICs9ICdbJyArIGVuY29kZVVSSUNvbXBvbmVudChwYXJlbnRzW2pdKSArICddJztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3BhcmVudHMgKyAnWycgKyBlbmNvZGVVUklDb21wb25lbnQobmFtZSkgKyAnXSc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIHZhcl92YWx1ZSh2YWx1ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBlbmNvZGVVUklDb21wb25lbnQodmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yICh2YXIgcHJvcCBpbiBvYmopIHtcbiAgICAgICAgICAgICAgICBpZiAob2JqLmhhc093blByb3BlcnR5KHByb3ApKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciB0b1B1c2g7XG4gICAgICAgICAgICAgICAgICAgIGlmICgkLmlzQXJyYXkob2JqW3Byb3BdKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdG9QdXNoID0gW107XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9ialtwcm9wXS5sZW5ndGg7IGkgKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoISQuaXNBcnJheShvYmpbcHJvcF1baV0pICYmIHR5cGVvZiBvYmpbcHJvcF1baV0gPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhcmVudHMgPSBwYXJlbnRzLnNsaWNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhcmVudHMucHVzaChwcm9wKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGFyZW50cy5wdXNoKGkgKyAnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvUHVzaC5wdXNoKCQuc2VyaWFsaXplT2JqZWN0KG9ialtwcm9wXVtpXSwgbmV3UGFyZW50cykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9QdXNoLnB1c2godmFyX25hbWUocHJvcCkgKyAnW109JyArIHZhcl92YWx1ZShvYmpbcHJvcF1baV0pKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9QdXNoLmxlbmd0aCA+IDApIHJlc3VsdEFycmF5LnB1c2godG9QdXNoLmpvaW4oc2VwYXJhdG9yKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodHlwZW9mIG9ialtwcm9wXSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9iamVjdCwgY29udmVydCB0byBuYW1lZCBhcnJheVxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3UGFyZW50cyA9IHBhcmVudHMuc2xpY2UoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BhcmVudHMucHVzaChwcm9wKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvUHVzaCA9ICQuc2VyaWFsaXplT2JqZWN0KG9ialtwcm9wXSwgbmV3UGFyZW50cyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodG9QdXNoICE9PSAnJykgcmVzdWx0QXJyYXkucHVzaCh0b1B1c2gpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiBvYmpbcHJvcF0gIT09ICd1bmRlZmluZWQnICYmIG9ialtwcm9wXSAhPT0gJycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNob3VsZCBiZSBzdHJpbmcgb3IgcGxhaW4gdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdEFycmF5LnB1c2godmFyX25hbWUocHJvcCkgKyAnPScgKyB2YXJfdmFsdWUob2JqW3Byb3BdKSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0QXJyYXkuam9pbihzZXBhcmF0b3IpO1xuICAgICAgICB9O1xuICAgICAgICAkLnRvQ2FtZWxDYXNlID0gZnVuY3Rpb24gKHN0cmluZykge1xuICAgICAgICAgICAgcmV0dXJuIHN0cmluZy50b0xvd2VyQ2FzZSgpLnJlcGxhY2UoLy0oLikvZywgZnVuY3Rpb24obWF0Y2gsIGdyb3VwMSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBncm91cDEudG9VcHBlckNhc2UoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICAkLmRhdGFzZXQgPSBmdW5jdGlvbiAoZWwpIHtcbiAgICAgICAgICAgIHJldHVybiAkKGVsKS5kYXRhc2V0KCk7XG4gICAgICAgIH07XG4gICAgICAgICQuZ2V0VHJhbnNsYXRlID0gZnVuY3Rpb24gKGVsLCBheGlzKSB7XG4gICAgICAgICAgICB2YXIgbWF0cml4LCBjdXJUcmFuc2Zvcm0sIGN1clN0eWxlLCB0cmFuc2Zvcm1NYXRyaXg7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gYXV0b21hdGljIGF4aXMgZGV0ZWN0aW9uXG4gICAgICAgICAgICBpZiAodHlwZW9mIGF4aXMgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgYXhpcyA9ICd4JztcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBjdXJTdHlsZSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsLCBudWxsKTtcbiAgICAgICAgICAgIGlmICh3aW5kb3cuV2ViS2l0Q1NTTWF0cml4KSB7XG4gICAgICAgICAgICAgICAgY3VyVHJhbnNmb3JtID0gY3VyU3R5bGUudHJhbnNmb3JtIHx8IGN1clN0eWxlLndlYmtpdFRyYW5zZm9ybTtcbiAgICAgICAgICAgICAgICBpZiAoY3VyVHJhbnNmb3JtLnNwbGl0KCcsJykubGVuZ3RoID4gNikge1xuICAgICAgICAgICAgICAgICAgICBjdXJUcmFuc2Zvcm0gPSBjdXJUcmFuc2Zvcm0uc3BsaXQoJywgJykubWFwKGZ1bmN0aW9uKGEpe1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEucmVwbGFjZSgnLCcsJy4nKTtcbiAgICAgICAgICAgICAgICAgICAgfSkuam9pbignLCAnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gU29tZSBvbGQgdmVyc2lvbnMgb2YgV2Via2l0IGNob2tlIHdoZW4gJ25vbmUnIGlzIHBhc3NlZDsgcGFzc1xuICAgICAgICAgICAgICAgIC8vIGVtcHR5IHN0cmluZyBpbnN0ZWFkIGluIHRoaXMgY2FzZVxuICAgICAgICAgICAgICAgIHRyYW5zZm9ybU1hdHJpeCA9IG5ldyBXZWJLaXRDU1NNYXRyaXgoY3VyVHJhbnNmb3JtID09PSAnbm9uZScgPyAnJyA6IGN1clRyYW5zZm9ybSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0cmFuc2Zvcm1NYXRyaXggPSBjdXJTdHlsZS5Nb3pUcmFuc2Zvcm0gfHwgY3VyU3R5bGUuT1RyYW5zZm9ybSB8fCBjdXJTdHlsZS5Nc1RyYW5zZm9ybSB8fCBjdXJTdHlsZS5tc1RyYW5zZm9ybSAgfHwgY3VyU3R5bGUudHJhbnNmb3JtIHx8IGN1clN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ3RyYW5zZm9ybScpLnJlcGxhY2UoJ3RyYW5zbGF0ZSgnLCAnbWF0cml4KDEsIDAsIDAsIDEsJyk7XG4gICAgICAgICAgICAgICAgbWF0cml4ID0gdHJhbnNmb3JtTWF0cml4LnRvU3RyaW5nKCkuc3BsaXQoJywnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoYXhpcyA9PT0gJ3gnKSB7XG4gICAgICAgICAgICAgICAgLy9MYXRlc3QgQ2hyb21lIGFuZCB3ZWJraXRzIEZpeFxuICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuV2ViS2l0Q1NTTWF0cml4KVxuICAgICAgICAgICAgICAgICAgICBjdXJUcmFuc2Zvcm0gPSB0cmFuc2Zvcm1NYXRyaXgubTQxO1xuICAgICAgICAgICAgICAgIC8vQ3JhenkgSUUxMCBNYXRyaXhcbiAgICAgICAgICAgICAgICBlbHNlIGlmIChtYXRyaXgubGVuZ3RoID09PSAxNilcbiAgICAgICAgICAgICAgICAgICAgY3VyVHJhbnNmb3JtID0gcGFyc2VGbG9hdChtYXRyaXhbMTJdKTtcbiAgICAgICAgICAgICAgICAvL05vcm1hbCBCcm93c2Vyc1xuICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAgY3VyVHJhbnNmb3JtID0gcGFyc2VGbG9hdChtYXRyaXhbNF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGF4aXMgPT09ICd5Jykge1xuICAgICAgICAgICAgICAgIC8vTGF0ZXN0IENocm9tZSBhbmQgd2Via2l0cyBGaXhcbiAgICAgICAgICAgICAgICBpZiAod2luZG93LldlYktpdENTU01hdHJpeClcbiAgICAgICAgICAgICAgICAgICAgY3VyVHJhbnNmb3JtID0gdHJhbnNmb3JtTWF0cml4Lm00MjtcbiAgICAgICAgICAgICAgICAvL0NyYXp5IElFMTAgTWF0cml4XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAobWF0cml4Lmxlbmd0aCA9PT0gMTYpXG4gICAgICAgICAgICAgICAgICAgIGN1clRyYW5zZm9ybSA9IHBhcnNlRmxvYXQobWF0cml4WzEzXSk7XG4gICAgICAgICAgICAgICAgLy9Ob3JtYWwgQnJvd3NlcnNcbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIGN1clRyYW5zZm9ybSA9IHBhcnNlRmxvYXQobWF0cml4WzVdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIGN1clRyYW5zZm9ybSB8fCAwO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgJC5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSBmdW5jdGlvbiAoY2FsbGJhY2spIHtcbiAgICAgICAgICAgIGlmICh3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKSByZXR1cm4gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZShjYWxsYmFjayk7XG4gICAgICAgICAgICBlbHNlIGlmICh3aW5kb3cud2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lKSByZXR1cm4gd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZShjYWxsYmFjayk7XG4gICAgICAgICAgICBlbHNlIGlmICh3aW5kb3cubW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lKSByZXR1cm4gd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZShjYWxsYmFjayk7XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93LnNldFRpbWVvdXQoY2FsbGJhY2ssIDEwMDAgLyA2MCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgICQuY2FuY2VsQW5pbWF0aW9uRnJhbWUgPSBmdW5jdGlvbiAoaWQpIHtcbiAgICAgICAgICAgIGlmICh3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUpIHJldHVybiB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUoaWQpO1xuICAgICAgICAgICAgZWxzZSBpZiAod2luZG93LndlYmtpdENhbmNlbEFuaW1hdGlvbkZyYW1lKSByZXR1cm4gd2luZG93LndlYmtpdENhbmNlbEFuaW1hdGlvbkZyYW1lKGlkKTtcbiAgICAgICAgICAgIGVsc2UgaWYgKHdpbmRvdy5tb3pDYW5jZWxBbmltYXRpb25GcmFtZSkgcmV0dXJuIHdpbmRvdy5tb3pDYW5jZWxBbmltYXRpb25GcmFtZShpZCk7XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93LmNsZWFyVGltZW91dChpZCk7XG4gICAgICAgICAgICB9ICBcbiAgICAgICAgfTtcbiAgICAgICAgJC5zdXBwb3J0VG91Y2ggPSAhISgoJ29udG91Y2hzdGFydCcgaW4gd2luZG93KSB8fCB3aW5kb3cuRG9jdW1lbnRUb3VjaCAmJiBkb2N1bWVudCBpbnN0YW5jZW9mIERvY3VtZW50VG91Y2gpO1xuICAgICAgICBcbiAgICAgICAgLy8gTGluayB0byBwcm90b3R5cGVcbiAgICAgICAgJC5mbiA9IERvbTcucHJvdG90eXBlO1xuICAgICAgICBcbiAgICAgICAgLy8gUGx1Z2luc1xuICAgICAgICAkLmZuLnNjcm9sbFRvID0gZnVuY3Rpb24gKGxlZnQsIHRvcCwgZHVyYXRpb24sIGVhc2luZywgY2FsbGJhY2spIHtcbiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSA0ICYmIHR5cGVvZiBlYXNpbmcgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGVhc2luZztcbiAgICAgICAgICAgICAgICBlYXNpbmcgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgZWwgPSB0aGlzO1xuICAgICAgICAgICAgICAgIHZhciBjdXJyZW50VG9wLCBjdXJyZW50TGVmdCwgbWF4VG9wLCBtYXhMZWZ0LCBuZXdUb3AsIG5ld0xlZnQsIHNjcm9sbFRvcCwgc2Nyb2xsTGVmdDtcbiAgICAgICAgICAgICAgICB2YXIgYW5pbWF0ZVRvcCA9IHRvcCA+IDAgfHwgdG9wID09PSAwO1xuICAgICAgICAgICAgICAgIHZhciBhbmltYXRlTGVmdCA9IGxlZnQgPiAwIHx8IGxlZnQgPT09IDA7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBlYXNpbmcgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGVhc2luZyA9ICdzd2luZyc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChhbmltYXRlVG9wKSB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRUb3AgPSBlbC5zY3JvbGxUb3A7XG4gICAgICAgICAgICAgICAgICAgIGlmICghZHVyYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNjcm9sbFRvcCA9IHRvcDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoYW5pbWF0ZUxlZnQpIHtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudExlZnQgPSBlbC5zY3JvbGxMZWZ0O1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWR1cmF0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlbC5zY3JvbGxMZWZ0ID0gbGVmdDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWR1cmF0aW9uKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKGFuaW1hdGVUb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgbWF4VG9wID0gZWwuc2Nyb2xsSGVpZ2h0IC0gZWwub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgICAgICBuZXdUb3AgPSBNYXRoLm1heChNYXRoLm1pbih0b3AsIG1heFRvcCksIDApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoYW5pbWF0ZUxlZnQpIHtcbiAgICAgICAgICAgICAgICAgICAgbWF4TGVmdCA9IGVsLnNjcm9sbFdpZHRoIC0gZWwub2Zmc2V0V2lkdGg7XG4gICAgICAgICAgICAgICAgICAgIG5ld0xlZnQgPSBNYXRoLm1heChNYXRoLm1pbihsZWZ0LCBtYXhMZWZ0KSwgMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhciBzdGFydFRpbWUgPSBudWxsO1xuICAgICAgICAgICAgICAgIGlmIChhbmltYXRlVG9wICYmIG5ld1RvcCA9PT0gY3VycmVudFRvcCkgYW5pbWF0ZVRvcCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChhbmltYXRlTGVmdCAmJiBuZXdMZWZ0ID09PSBjdXJyZW50TGVmdCkgYW5pbWF0ZUxlZnQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiByZW5kZXIodGltZSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodGltZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXJ0VGltZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRUaW1lID0gdGltZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YXIgZG9uZUxlZnQsIGRvbmVUb3AsIGRvbmU7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwcm9ncmVzcyA9IE1hdGgubWF4KE1hdGgubWluKCh0aW1lIC0gc3RhcnRUaW1lKSAvIGR1cmF0aW9uLCAxKSwgMCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBlYXNlUHJvZ3Jlc3MgPSBlYXNpbmcgPT09ICdsaW5lYXInID8gcHJvZ3Jlc3MgOiAoMC41IC0gTWF0aC5jb3MoIHByb2dyZXNzICogTWF0aC5QSSApIC8gMik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhbmltYXRlVG9wKSBzY3JvbGxUb3AgPSBjdXJyZW50VG9wICsgKGVhc2VQcm9ncmVzcyAqIChuZXdUb3AgLSBjdXJyZW50VG9wKSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChhbmltYXRlTGVmdCkgc2Nyb2xsTGVmdCA9IGN1cnJlbnRMZWZ0ICsgKGVhc2VQcm9ncmVzcyAqIChuZXdMZWZ0IC0gY3VycmVudExlZnQpKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFuaW1hdGVUb3AgJiYgbmV3VG9wID4gY3VycmVudFRvcCAmJiBzY3JvbGxUb3AgPj0gbmV3VG9wKSAge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2Nyb2xsVG9wID0gbmV3VG9wO1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFuaW1hdGVUb3AgJiYgbmV3VG9wIDwgY3VycmVudFRvcCAmJiBzY3JvbGxUb3AgPD0gbmV3VG9wKSAge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2Nyb2xsVG9wID0gbmV3VG9wO1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChhbmltYXRlTGVmdCAmJiBuZXdMZWZ0ID4gY3VycmVudExlZnQgJiYgc2Nyb2xsTGVmdCA+PSBuZXdMZWZ0KSAge1xuICAgICAgICAgICAgICAgICAgICAgICAgZWwuc2Nyb2xsTGVmdCA9IG5ld0xlZnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoYW5pbWF0ZUxlZnQgJiYgbmV3TGVmdCA8IGN1cnJlbnRMZWZ0ICYmIHNjcm9sbExlZnQgPD0gbmV3TGVmdCkgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsLnNjcm9sbExlZnQgPSBuZXdMZWZ0O1xuICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChkb25lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGFuaW1hdGVUb3ApIGVsLnNjcm9sbFRvcCA9IHNjcm9sbFRvcDtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGFuaW1hdGVMZWZ0KSBlbC5zY3JvbGxMZWZ0ID0gc2Nyb2xsTGVmdDtcbiAgICAgICAgICAgICAgICAgICAgJC5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUocmVuZGVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgJC5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUocmVuZGVyKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9O1xuICAgICAgICAkLmZuLnNjcm9sbFRvcCA9IGZ1bmN0aW9uICh0b3AsIGR1cmF0aW9uLCBlYXNpbmcsIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMyAmJiB0eXBlb2YgZWFzaW5nID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBlYXNpbmc7XG4gICAgICAgICAgICAgICAgZWFzaW5nID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIGRvbSA9IHRoaXM7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHRvcCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBpZiAoZG9tLmxlbmd0aCA+IDApIHJldHVybiBkb21bMF0uc2Nyb2xsVG9wO1xuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZG9tLnNjcm9sbFRvKHVuZGVmaW5lZCwgdG9wLCBkdXJhdGlvbiwgZWFzaW5nLCBjYWxsYmFjayk7XG4gICAgICAgIH07XG4gICAgICAgICQuZm4uc2Nyb2xsTGVmdCA9IGZ1bmN0aW9uIChsZWZ0LCBkdXJhdGlvbiwgZWFzaW5nLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDMgJiYgdHlwZW9mIGVhc2luZyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZWFzaW5nO1xuICAgICAgICAgICAgICAgIGVhc2luZyA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBkb20gPSB0aGlzO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBsZWZ0ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIGlmIChkb20ubGVuZ3RoID4gMCkgcmV0dXJuIGRvbVswXS5zY3JvbGxMZWZ0O1xuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZG9tLnNjcm9sbFRvKGxlZnQsIHVuZGVmaW5lZCwgZHVyYXRpb24sIGVhc2luZywgY2FsbGJhY2spO1xuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiAkO1xuICAgIH0pKCk7XG4gICAgXG4gICAgLy8gRXhwb3J0IERvbTcgdG8gRnJhbWV3b3JrN1xuICAgIEZyYW1ld29yazcuJCA9IERvbTc7XG4gICAgXG4gICAgLy8gRXhwb3J0IHRvIGxvY2FsIHNjb3BlXG4gICAgdmFyICQgPSBEb203O1xuICAgIFxuICAgIC8vIEV4cG9ydCB0byBXaW5kb3dcbiAgICB3aW5kb3cuRG9tNyA9IERvbTc7XG4gICAgXG5cbiAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIEZlYXR1cmVzIFN1cHBvcnQgRGV0ZWN0aW9uXG4gICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICBGcmFtZXdvcms3LnByb3RvdHlwZS5zdXBwb3J0ID0gKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIHN1cHBvcnQgPSB7XG4gICAgICAgICAgICB0b3VjaDogISEoKCdvbnRvdWNoc3RhcnQnIGluIHdpbmRvdykgfHwgd2luZG93LkRvY3VtZW50VG91Y2ggJiYgZG9jdW1lbnQgaW5zdGFuY2VvZiBEb2N1bWVudFRvdWNoKVxuICAgICAgICB9O1xuICAgIFxuICAgICAgICAvLyBFeHBvcnQgb2JqZWN0XG4gICAgICAgIHJldHVybiBzdXBwb3J0O1xuICAgIH0pKCk7XG4gICAgXG5cbiAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIERldmljZS9PUyBEZXRlY3Rpb25cbiAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgIEZyYW1ld29yazcucHJvdG90eXBlLmRldmljZSA9IChmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBkZXZpY2UgPSB7fTtcbiAgICAgICAgdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudDtcbiAgICAgICAgdmFyICQgPSBEb203O1xuICAgIFxuICAgICAgICB2YXIgYW5kcm9pZCA9IHVhLm1hdGNoKC8oQW5kcm9pZCk7P1tcXHNcXC9dKyhbXFxkLl0rKT8vKTtcbiAgICAgICAgdmFyIGlwYWQgPSB1YS5tYXRjaCgvKGlQYWQpLipPU1xccyhbXFxkX10rKS8pO1xuICAgICAgICB2YXIgaXBvZCA9IHVhLm1hdGNoKC8oaVBvZCkoLipPU1xccyhbXFxkX10rKSk/Lyk7XG4gICAgICAgIHZhciBpcGhvbmUgPSAhaXBhZCAmJiB1YS5tYXRjaCgvKGlQaG9uZVxcc09TKVxccyhbXFxkX10rKS8pO1xuICAgIFxuICAgICAgICBkZXZpY2UuaW9zID0gZGV2aWNlLmFuZHJvaWQgPSBkZXZpY2UuaXBob25lID0gZGV2aWNlLmlwYWQgPSBkZXZpY2UuYW5kcm9pZENocm9tZSA9IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgLy8gQW5kcm9pZFxuICAgICAgICBpZiAoYW5kcm9pZCkge1xuICAgICAgICAgICAgZGV2aWNlLm9zID0gJ2FuZHJvaWQnO1xuICAgICAgICAgICAgZGV2aWNlLm9zVmVyc2lvbiA9IGFuZHJvaWRbMl07XG4gICAgICAgICAgICBkZXZpY2UuYW5kcm9pZCA9IHRydWU7XG4gICAgICAgICAgICBkZXZpY2UuYW5kcm9pZENocm9tZSA9IHVhLnRvTG93ZXJDYXNlKCkuaW5kZXhPZignY2hyb21lJykgPj0gMDtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaXBhZCB8fCBpcGhvbmUgfHwgaXBvZCkge1xuICAgICAgICAgICAgZGV2aWNlLm9zID0gJ2lvcyc7XG4gICAgICAgICAgICBkZXZpY2UuaW9zID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICAvLyBpT1NcbiAgICAgICAgaWYgKGlwaG9uZSAmJiAhaXBvZCkge1xuICAgICAgICAgICAgZGV2aWNlLm9zVmVyc2lvbiA9IGlwaG9uZVsyXS5yZXBsYWNlKC9fL2csICcuJyk7XG4gICAgICAgICAgICBkZXZpY2UuaXBob25lID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaXBhZCkge1xuICAgICAgICAgICAgZGV2aWNlLm9zVmVyc2lvbiA9IGlwYWRbMl0ucmVwbGFjZSgvXy9nLCAnLicpO1xuICAgICAgICAgICAgZGV2aWNlLmlwYWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpcG9kKSB7XG4gICAgICAgICAgICBkZXZpY2Uub3NWZXJzaW9uID0gaXBvZFszXSA/IGlwb2RbM10ucmVwbGFjZSgvXy9nLCAnLicpIDogbnVsbDtcbiAgICAgICAgICAgIGRldmljZS5pcGhvbmUgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIC8vIGlPUyA4KyBjaGFuZ2VkIFVBXG4gICAgICAgIGlmIChkZXZpY2UuaW9zICYmIGRldmljZS5vc1ZlcnNpb24gJiYgdWEuaW5kZXhPZignVmVyc2lvbi8nKSA+PSAwKSB7XG4gICAgICAgICAgICBpZiAoZGV2aWNlLm9zVmVyc2lvbi5zcGxpdCgnLicpWzBdID09PSAnMTAnKSB7XG4gICAgICAgICAgICAgICAgZGV2aWNlLm9zVmVyc2lvbiA9IHVhLnRvTG93ZXJDYXNlKCkuc3BsaXQoJ3ZlcnNpb24vJylbMV0uc3BsaXQoJyAnKVswXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIFxuICAgICAgICAvLyBXZWJ2aWV3XG4gICAgICAgIGRldmljZS53ZWJWaWV3ID0gKGlwaG9uZSB8fCBpcGFkIHx8IGlwb2QpICYmIHVhLm1hdGNoKC8uKkFwcGxlV2ViS2l0KD8hLipTYWZhcmkpL2kpO1xuICAgICAgICAgICAgXG4gICAgICAgIC8vIE1pbmltYWwgVUlcbiAgICAgICAgaWYgKGRldmljZS5vcyAmJiBkZXZpY2Uub3MgPT09ICdpb3MnKSB7XG4gICAgICAgICAgICB2YXIgb3NWZXJzaW9uQXJyID0gZGV2aWNlLm9zVmVyc2lvbi5zcGxpdCgnLicpO1xuICAgICAgICAgICAgZGV2aWNlLm1pbmltYWxVaSA9ICFkZXZpY2Uud2ViVmlldyAmJlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoaXBvZCB8fCBpcGhvbmUpICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChvc1ZlcnNpb25BcnJbMF0gKiAxID09PSA3ID8gb3NWZXJzaW9uQXJyWzFdICogMSA+PSAxIDogb3NWZXJzaW9uQXJyWzBdICogMSA+IDcpICYmXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoJ21ldGFbbmFtZT1cInZpZXdwb3J0XCJdJykubGVuZ3RoID4gMCAmJiAkKCdtZXRhW25hbWU9XCJ2aWV3cG9ydFwiXScpLmF0dHIoJ2NvbnRlbnQnKS5pbmRleE9mKCdtaW5pbWFsLXVpJykgPj0gMDtcbiAgICAgICAgfVxuICAgIFxuICAgICAgICAvLyBDaGVjayBmb3Igc3RhdHVzIGJhciBhbmQgZnVsbHNjcmVlbiBhcHAgbW9kZVxuICAgICAgICB2YXIgd2luZG93V2lkdGggPSAkKHdpbmRvdykud2lkdGgoKTtcbiAgICAgICAgdmFyIHdpbmRvd0hlaWdodCA9ICQod2luZG93KS5oZWlnaHQoKTtcbiAgICAgICAgZGV2aWNlLnN0YXR1c0JhciA9IGZhbHNlO1xuICAgICAgICBpZiAoZGV2aWNlLndlYlZpZXcgJiYgKHdpbmRvd1dpZHRoICogd2luZG93SGVpZ2h0ID09PSBzY3JlZW4ud2lkdGggKiBzY3JlZW4uaGVpZ2h0KSkge1xuICAgICAgICAgICAgZGV2aWNlLnN0YXR1c0JhciA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBkZXZpY2Uuc3RhdHVzQmFyID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgLy8gQ2xhc3Nlc1xuICAgICAgICB2YXIgY2xhc3NOYW1lcyA9IFtdO1xuICAgIFxuICAgICAgICAvLyBQaXhlbCBSYXRpb1xuICAgICAgICBkZXZpY2UucGl4ZWxSYXRpbyA9IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvIHx8IDE7XG4gICAgICAgIGNsYXNzTmFtZXMucHVzaCgncGl4ZWwtcmF0aW8tJyArIE1hdGguZmxvb3IoZGV2aWNlLnBpeGVsUmF0aW8pKTtcbiAgICAgICAgaWYgKGRldmljZS5waXhlbFJhdGlvID49IDIpIHtcbiAgICAgICAgICAgIGNsYXNzTmFtZXMucHVzaCgncmV0aW5hJyk7XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgLy8gT1MgY2xhc3Nlc1xuICAgICAgICBpZiAoZGV2aWNlLm9zKSB7XG4gICAgICAgICAgICBjbGFzc05hbWVzLnB1c2goZGV2aWNlLm9zLCBkZXZpY2Uub3MgKyAnLScgKyBkZXZpY2Uub3NWZXJzaW9uLnNwbGl0KCcuJylbMF0sIGRldmljZS5vcyArICctJyArIGRldmljZS5vc1ZlcnNpb24ucmVwbGFjZSgvXFwuL2csICctJykpO1xuICAgICAgICAgICAgaWYgKGRldmljZS5vcyA9PT0gJ2lvcycpIHtcbiAgICAgICAgICAgICAgICB2YXIgbWFqb3IgPSBwYXJzZUludChkZXZpY2Uub3NWZXJzaW9uLnNwbGl0KCcuJylbMF0sIDEwKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gbWFqb3IgLSAxOyBpID49IDY7IGktLSkge1xuICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWVzLnB1c2goJ2lvcy1ndC0nICsgaSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgLy8gU3RhdHVzIGJhciBjbGFzc2VzXG4gICAgICAgIGlmIChkZXZpY2Uuc3RhdHVzQmFyKSB7XG4gICAgICAgICAgICBjbGFzc05hbWVzLnB1c2goJ3dpdGgtc3RhdHVzYmFyLW92ZXJsYXknKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICQoJ2h0bWwnKS5yZW1vdmVDbGFzcygnd2l0aC1zdGF0dXNiYXItb3ZlcmxheScpO1xuICAgICAgICB9XG4gICAgXG4gICAgICAgIC8vIEFkZCBodG1sIGNsYXNzZXNcbiAgICAgICAgaWYgKGNsYXNzTmFtZXMubGVuZ3RoID4gMCkgJCgnaHRtbCcpLmFkZENsYXNzKGNsYXNzTmFtZXMuam9pbignICcpKTtcbiAgICBcbiAgICAgICAgLy8gRXhwb3J0IG9iamVjdFxuICAgICAgICByZXR1cm4gZGV2aWNlO1xuICAgIH0pKCk7XG4gICAgXG5cbiAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIFBsdWdpbnMgcHJvdG90eXBlXG4gICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICBGcmFtZXdvcms3LnByb3RvdHlwZS5wbHVnaW5zID0ge307XG4gICAgXG5cbiAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgIFRlbXBsYXRlNyBUZW1wbGF0ZSBlbmdpbmVcbiAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgIHdpbmRvdy5UZW1wbGF0ZTcgPSAoZnVuY3Rpb24gKCkge1xuICAgICAgICBmdW5jdGlvbiBpc0FycmF5KGFycikge1xuICAgICAgICAgICAgcmV0dXJuIE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuYXBwbHkoYXJyKSA9PT0gJ1tvYmplY3QgQXJyYXldJztcbiAgICAgICAgfVxuICAgICAgICBmdW5jdGlvbiBpc09iamVjdChvYmopIHtcbiAgICAgICAgICAgIHJldHVybiBvYmogaW5zdGFuY2VvZiBPYmplY3Q7XG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gaXNGdW5jdGlvbihmdW5jKSB7XG4gICAgICAgICAgICByZXR1cm4gdHlwZW9mIGZ1bmMgPT09ICdmdW5jdGlvbic7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGNhY2hlID0ge307XG4gICAgICAgIGZ1bmN0aW9uIGhlbHBlclRvU2xpY2VzKHN0cmluZykge1xuICAgICAgICAgICAgdmFyIGhlbHBlclBhcnRzID0gc3RyaW5nLnJlcGxhY2UoL1t7fSN9XS9nLCAnJykuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgIHZhciBzbGljZXMgPSBbXTtcbiAgICAgICAgICAgIHZhciBzaGlmdEluZGV4LCBpLCBqO1xuICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGhlbHBlclBhcnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIHBhcnQgPSBoZWxwZXJQYXJ0c1tpXTtcbiAgICAgICAgICAgICAgICBpZiAoaSA9PT0gMCkgc2xpY2VzLnB1c2gocGFydCk7XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChwYXJ0LmluZGV4T2YoJ1wiJykgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFBsYWluIFN0cmluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnQubWF0Y2goL1wiL2cpLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9uZSB3b3JkIHN0cmluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWNlcy5wdXNoKHBhcnQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gRmluZCBjbG9zZWQgSW5kZXhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGlmdEluZGV4ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGogPSBpICsgMTsgaiA8IGhlbHBlclBhcnRzLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnQgKz0gJyAnICsgaGVscGVyUGFydHNbal07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChoZWxwZXJQYXJ0c1tqXS5pbmRleE9mKCdcIicpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoaWZ0SW5kZXggPSBqO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpY2VzLnB1c2gocGFydCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hpZnRJbmRleCkgaSA9IHNoaWZ0SW5kZXg7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFydC5pbmRleE9mKCc9JykgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGFzaFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYXNoUGFydHMgPSBwYXJ0LnNwbGl0KCc9Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhhc2hOYW1lID0gaGFzaFBhcnRzWzBdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYXNoQ29udGVudCA9IGhhc2hQYXJ0c1sxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGFzaENvbnRlbnQubWF0Y2goL1wiL2cpLmxlbmd0aCAhPT0gMikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGlmdEluZGV4ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gaSArIDE7IGogPCBoZWxwZXJQYXJ0cy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFzaENvbnRlbnQgKz0gJyAnICsgaGVscGVyUGFydHNbal07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaGVscGVyUGFydHNbal0uaW5kZXhPZignXCInKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hpZnRJbmRleCA9IGo7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNoaWZ0SW5kZXgpIGkgPSBzaGlmdEluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaGFzaCA9IFtoYXNoTmFtZSwgaGFzaENvbnRlbnQucmVwbGFjZSgvXCIvZywnJyldO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWNlcy5wdXNoKGhhc2gpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUGxhaW4gdmFyaWFibGVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGljZXMucHVzaChwYXJ0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBzbGljZXM7XG4gICAgICAgIH1cbiAgICAgICAgZnVuY3Rpb24gc3RyaW5nVG9CbG9ja3Moc3RyaW5nKSB7XG4gICAgICAgICAgICB2YXIgYmxvY2tzID0gW10sIGksIGosIGs7XG4gICAgICAgICAgICBpZiAoIXN0cmluZykgcmV0dXJuIFtdO1xuICAgICAgICAgICAgdmFyIF9ibG9ja3MgPSBzdHJpbmcuc3BsaXQoLyh7e1tee159XSp9fSkvKTtcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBfYmxvY2tzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIGJsb2NrID0gX2Jsb2Nrc1tpXTtcbiAgICAgICAgICAgICAgICBpZiAoYmxvY2sgPT09ICcnKSBjb250aW51ZTtcbiAgICAgICAgICAgICAgICBpZiAoYmxvY2suaW5kZXhPZigne3snKSA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgYmxvY2tzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3BsYWluJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnQ6IGJsb2NrXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJsb2NrLmluZGV4T2YoJ3svJykgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGJsb2NrLmluZGV4T2YoJ3sjJykgPCAwICYmIGJsb2NrLmluZGV4T2YoJyAnKSA8IDAgJiYgYmxvY2suaW5kZXhPZignZWxzZScpIDwgMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2ltcGxlIHZhcmlhYmxlXG4gICAgICAgICAgICAgICAgICAgICAgICBibG9ja3MucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3ZhcmlhYmxlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0TmFtZTogYmxvY2sucmVwbGFjZSgvW3t9XS9nLCAnJylcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8gSGVscGVyc1xuICAgICAgICAgICAgICAgICAgICB2YXIgaGVscGVyU2xpY2VzID0gaGVscGVyVG9TbGljZXMoYmxvY2spO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaGVscGVyTmFtZSA9IGhlbHBlclNsaWNlc1swXTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGlzUGFydGlhbCA9IGhlbHBlck5hbWUgPT09ICc+JztcbiAgICAgICAgICAgICAgICAgICAgdmFyIGhlbHBlckNvbnRleHQgPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGhlbHBlckhhc2ggPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMTsgaiA8IGhlbHBlclNsaWNlcy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWNlID0gaGVscGVyU2xpY2VzW2pdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlzQXJyYXkoc2xpY2UpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGFzaFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlbHBlckhhc2hbc2xpY2VbMF1dID0gc2xpY2VbMV0gPT09ICdmYWxzZScgPyBmYWxzZSA6IHNsaWNlWzFdO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVscGVyQ29udGV4dC5wdXNoKHNsaWNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJsb2NrLmluZGV4T2YoJ3sjJykgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ29uZGl0aW9uL0hlbHBlclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhlbHBlclN0YXJ0SW5kZXggPSBpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhlbHBlckNvbnRlbnQgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbHNlQ29udGVudCA9ICcnO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRvU2tpcCA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2hpZnRJbmRleDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBmb3VuZENsb3NlZCA9IGZhbHNlLCBmb3VuZEVsc2UgPSBmYWxzZSwgZm91bmRDbG9zZWRFbHNlID0gZmFsc2UsIGRlcHRoID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaiA9IGkgKyAxOyBqIDwgX2Jsb2Nrcy5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfYmxvY2tzW2pdLmluZGV4T2YoJ3t7IycpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGggKys7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfYmxvY2tzW2pdLmluZGV4T2YoJ3t7LycpID49IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVwdGggLS07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfYmxvY2tzW2pdLmluZGV4T2YoJ3t7IycgKyBoZWxwZXJOYW1lKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlbHBlckNvbnRlbnQgKz0gX2Jsb2Nrc1tqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvdW5kRWxzZSkgZWxzZUNvbnRlbnQgKz0gX2Jsb2Nrc1tqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9Ta2lwICsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChfYmxvY2tzW2pdLmluZGV4T2YoJ3t7LycgKyBoZWxwZXJOYW1lKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0b1NraXAgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b1NraXAtLTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlbHBlckNvbnRlbnQgKz0gX2Jsb2Nrc1tqXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3VuZEVsc2UpIGVsc2VDb250ZW50ICs9IF9ibG9ja3Nbal07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGlmdEluZGV4ID0gajtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kQ2xvc2VkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKF9ibG9ja3Nbal0uaW5kZXhPZignZWxzZScpID49IDAgJiYgZGVwdGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRFbHNlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZm91bmRFbHNlKSBoZWxwZXJDb250ZW50ICs9IF9ibG9ja3Nbal07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3VuZEVsc2UpIGVsc2VDb250ZW50ICs9IF9ibG9ja3Nbal07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvdW5kQ2xvc2VkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNoaWZ0SW5kZXgpIGkgPSBzaGlmdEluZGV4O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsb2Nrcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2hlbHBlcicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlbHBlck5hbWU6IGhlbHBlck5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRleHROYW1lOiBoZWxwZXJDb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50OiBoZWxwZXJDb250ZW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZlcnNlQ29udGVudDogZWxzZUNvbnRlbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhc2g6IGhlbHBlckhhc2hcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChibG9jay5pbmRleE9mKCcgJykgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNQYXJ0aWFsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVscGVyTmFtZSA9ICdfcGFydGlhbCc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhlbHBlckNvbnRleHRbMF0pIGhlbHBlckNvbnRleHRbMF0gPSAnXCInICsgaGVscGVyQ29udGV4dFswXS5yZXBsYWNlKC9cInwnL2csICcnKSArICdcIic7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBibG9ja3MucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2hlbHBlcicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVscGVyTmFtZTogaGVscGVyTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0TmFtZTogaGVscGVyQ29udGV4dCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYXNoOiBoZWxwZXJIYXNoXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBibG9ja3M7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIFRlbXBsYXRlNyA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSkge1xuICAgICAgICAgICAgdmFyIHQgPSB0aGlzO1xuICAgICAgICAgICAgdC50ZW1wbGF0ZSA9IHRlbXBsYXRlO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBmdW5jdGlvbiBnZXRDb21waWxlRm4oYmxvY2ssIGRlcHRoKSB7XG4gICAgICAgICAgICAgICAgaWYgKGJsb2NrLmNvbnRlbnQpIHJldHVybiBjb21waWxlKGJsb2NrLmNvbnRlbnQsIGRlcHRoKTtcbiAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBmdW5jdGlvbiAoKSB7cmV0dXJuICcnOyB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gZ2V0Q29tcGlsZUludmVyc2UoYmxvY2ssIGRlcHRoKSB7XG4gICAgICAgICAgICAgICAgaWYgKGJsb2NrLmludmVyc2VDb250ZW50KSByZXR1cm4gY29tcGlsZShibG9jay5pbnZlcnNlQ29udGVudCwgZGVwdGgpO1xuICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIGZ1bmN0aW9uICgpIHtyZXR1cm4gJyc7IH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBnZXRDb21waWxlVmFyKG5hbWUsIGN0eCkge1xuICAgICAgICAgICAgICAgIHZhciB2YXJpYWJsZSwgcGFydHMsIGxldmVsc1VwID0gMCwgaW5pdGlhbEN0eCA9IGN0eDtcbiAgICAgICAgICAgICAgICBpZiAobmFtZS5pbmRleE9mKCcuLi8nKSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBsZXZlbHNVcCA9IG5hbWUuc3BsaXQoJy4uLycpLmxlbmd0aCAtIDE7XG4gICAgICAgICAgICAgICAgICAgIHZhciBuZXdEZXB0aCA9IGN0eC5zcGxpdCgnXycpWzFdIC0gbGV2ZWxzVXA7XG4gICAgICAgICAgICAgICAgICAgIGN0eCA9ICdjdHhfJyArIChuZXdEZXB0aCA+PSAxID8gbmV3RGVwdGggOiAxKTtcbiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBuYW1lLnNwbGl0KCcuLi8nKVtsZXZlbHNVcF0uc3BsaXQoJy4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAobmFtZS5pbmRleE9mKCdAZ2xvYmFsJykgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY3R4ID0gJ1RlbXBsYXRlNy5nbG9iYWwnO1xuICAgICAgICAgICAgICAgICAgICBwYXJ0cyA9IG5hbWUuc3BsaXQoJ0BnbG9iYWwuJylbMV0uc3BsaXQoJy4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAobmFtZS5pbmRleE9mKCdAcm9vdCcpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGN0eCA9ICdyb290JztcbiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBuYW1lLnNwbGl0KCdAcm9vdC4nKVsxXS5zcGxpdCgnLicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcGFydHMgPSBuYW1lLnNwbGl0KCcuJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHZhcmlhYmxlID0gY3R4O1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFydHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHBhcnQgPSBwYXJ0c1tpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnQuaW5kZXhPZignQCcpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZSArPSAnWyhkYXRhICYmIGRhdGEuJyArIHBhcnQucmVwbGFjZSgnQCcsICcnKSArICcpXSc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZSA9ICcoZGF0YSAmJiBkYXRhLicgKyBuYW1lLnJlcGxhY2UoJ0AnLCAnJykgKyAnKSc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNGaW5pdGUocGFydCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXJpYWJsZSArPSAnWycgKyBwYXJ0ICsgJ10nO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcnQuaW5kZXhPZigndGhpcycpID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlID0gcGFydC5yZXBsYWNlKCd0aGlzJywgY3R4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlICs9ICcuJyArIHBhcnQ7ICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFyaWFibGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBnZXRDb21waWxlZEFyZ3VtZW50cyhjb250ZXh0QXJyYXksIGN0eCkge1xuICAgICAgICAgICAgICAgIHZhciBhcnIgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbnRleHRBcnJheS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoY29udGV4dEFycmF5W2ldLmluZGV4T2YoJ1wiJykgPT09IDApIGFyci5wdXNoKGNvbnRleHRBcnJheVtpXSk7XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXJyLnB1c2goZ2V0Q29tcGlsZVZhcihjb250ZXh0QXJyYXlbaV0sIGN0eCkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgIFxuICAgICAgICAgICAgICAgIHJldHVybiBhcnIuam9pbignLCAnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIGNvbXBpbGUodGVtcGxhdGUsIGRlcHRoKSB7XG4gICAgICAgICAgICAgICAgZGVwdGggPSBkZXB0aCB8fCAxO1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gdGVtcGxhdGUgfHwgdC50ZW1wbGF0ZTtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRlbXBsYXRlICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RlbXBsYXRlNzogVGVtcGxhdGUgbXVzdCBiZSBhIHN0cmluZycpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgYmxvY2tzID0gc3RyaW5nVG9CbG9ja3ModGVtcGxhdGUpO1xuICAgICAgICAgICAgICAgIGlmIChibG9ja3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7IHJldHVybiAnJzsgfTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmFyIGN0eCA9ICdjdHhfJyArIGRlcHRoO1xuICAgICAgICAgICAgICAgIHZhciByZXN1bHRTdHJpbmcgPSAnJztcbiAgICAgICAgICAgICAgICBpZiAoZGVwdGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0U3RyaW5nICs9ICcoZnVuY3Rpb24gKCcgKyBjdHggKyAnLCBkYXRhLCByb290KSB7XFxuJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZyArPSAnKGZ1bmN0aW9uICgnICsgY3R4ICsgJywgZGF0YSkge1xcbic7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChkZXB0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmcgKz0gJ2Z1bmN0aW9uIGlzQXJyYXkoYXJyKXtyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5hcHBseShhcnIpID09PSBcXCdbb2JqZWN0IEFycmF5XVxcJzt9XFxuJztcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0U3RyaW5nICs9ICdmdW5jdGlvbiBpc0Z1bmN0aW9uKGZ1bmMpe3JldHVybiAodHlwZW9mIGZ1bmMgPT09IFxcJ2Z1bmN0aW9uXFwnKTt9XFxuJztcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0U3RyaW5nICs9ICdmdW5jdGlvbiBjKHZhbCwgY3R4KSB7aWYgKHR5cGVvZiB2YWwgIT09IFwidW5kZWZpbmVkXCIgJiYgdmFsICE9PSBudWxsKSB7aWYgKGlzRnVuY3Rpb24odmFsKSkge3JldHVybiB2YWwuY2FsbChjdHgpO30gZWxzZSByZXR1cm4gdmFsO30gZWxzZSByZXR1cm4gXCJcIjt9XFxuJztcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0U3RyaW5nICs9ICdyb290ID0gcm9vdCB8fCBjdHhfMSB8fCB7fTtcXG4nO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmcgKz0gJ3ZhciByID0gXFwnXFwnO1xcbic7XG4gICAgICAgICAgICAgICAgdmFyIGksIGosIGNvbnRleHQ7XG4gICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGJsb2Nrcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgYmxvY2sgPSBibG9ja3NbaV07XG4gICAgICAgICAgICAgICAgICAgIC8vIFBsYWluIGJsb2NrXG4gICAgICAgICAgICAgICAgICAgIGlmIChibG9jay50eXBlID09PSAncGxhaW4nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmcgKz0gJ3IgKz1cXCcnICsgKGJsb2NrLmNvbnRlbnQpLnJlcGxhY2UoL1xcci9nLCAnXFxcXHInKS5yZXBsYWNlKC9cXG4vZywgJ1xcXFxuJykucmVwbGFjZSgvJy9nLCAnXFxcXCcgKyAnXFwnJykgKyAnXFwnOyc7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YXIgdmFyaWFibGUsIGNvbXBpbGVkQXJndW1lbnRzO1xuICAgICAgICAgICAgICAgICAgICAvLyBWYXJpYWJsZSBibG9ja1xuICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2sudHlwZSA9PT0gJ3ZhcmlhYmxlJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWFibGUgPSBnZXRDb21waWxlVmFyKGJsb2NrLmNvbnRleHROYW1lLCBjdHgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0U3RyaW5nICs9ICdyICs9IGMoJyArIHZhcmlhYmxlICsgJywgJyArIGN0eCArICcpOyc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8gSGVscGVycyBibG9ja1xuICAgICAgICAgICAgICAgICAgICBpZiAoYmxvY2sudHlwZSA9PT0gJ2hlbHBlcicpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChibG9jay5oZWxwZXJOYW1lIGluIHQuaGVscGVycykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbXBpbGVkQXJndW1lbnRzID0gZ2V0Q29tcGlsZWRBcmd1bWVudHMoYmxvY2suY29udGV4dE5hbWUsIGN0eCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0U3RyaW5nICs9ICdyICs9IChUZW1wbGF0ZTcuaGVscGVycy4nICsgYmxvY2suaGVscGVyTmFtZSArICcpLmNhbGwoJyArIGN0eCArICcsICcgKyAoY29tcGlsZWRBcmd1bWVudHMgJiYgKGNvbXBpbGVkQXJndW1lbnRzICsgJywgJykpICsne2hhc2g6JyArIEpTT04uc3RyaW5naWZ5KGJsb2NrLmhhc2gpICsgJywgZGF0YTogZGF0YSB8fCB7fSwgZm46ICcgKyBnZXRDb21waWxlRm4oYmxvY2ssIGRlcHRoICsgMSkgKyAnLCBpbnZlcnNlOiAnICsgZ2V0Q29tcGlsZUludmVyc2UoYmxvY2ssIGRlcHRoICsgMSkgKyAnLCByb290OiByb290fSk7JztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChibG9jay5jb250ZXh0TmFtZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignVGVtcGxhdGU3OiBNaXNzaW5nIGhlbHBlcjogXCInICsgYmxvY2suaGVscGVyTmFtZSArICdcIicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWFibGUgPSBnZXRDb21waWxlVmFyKGJsb2NrLmhlbHBlck5hbWUsIGN0eCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZyArPSAnaWYgKCcgKyB2YXJpYWJsZSArICcpIHsnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmcgKz0gJ2lmIChpc0FycmF5KCcgKyB2YXJpYWJsZSArICcpKSB7JztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0U3RyaW5nICs9ICdyICs9IChUZW1wbGF0ZTcuaGVscGVycy5lYWNoKS5jYWxsKCcgKyBjdHggKyAnLCAnICsgdmFyaWFibGUgKyAnLCB7aGFzaDonICsgSlNPTi5zdHJpbmdpZnkoYmxvY2suaGFzaCkgKyAnLCBkYXRhOiBkYXRhIHx8IHt9LCBmbjogJyArIGdldENvbXBpbGVGbihibG9jaywgZGVwdGgrMSkgKyAnLCBpbnZlcnNlOiAnICsgZ2V0Q29tcGlsZUludmVyc2UoYmxvY2ssIGRlcHRoKzEpICsgJywgcm9vdDogcm9vdH0pOyc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZyArPSAnfWVsc2Ugeyc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFN0cmluZyArPSAnciArPSAoVGVtcGxhdGU3LmhlbHBlcnMud2l0aCkuY2FsbCgnICsgY3R4ICsgJywgJyArIHZhcmlhYmxlICsgJywge2hhc2g6JyArIEpTT04uc3RyaW5naWZ5KGJsb2NrLmhhc2gpICsgJywgZGF0YTogZGF0YSB8fCB7fSwgZm46ICcgKyBnZXRDb21waWxlRm4oYmxvY2ssIGRlcHRoKzEpICsgJywgaW52ZXJzZTogJyArIGdldENvbXBpbGVJbnZlcnNlKGJsb2NrLCBkZXB0aCsxKSArICcsIHJvb3Q6IHJvb3R9KTsnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRTdHJpbmcgKz0gJ319JztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVzdWx0U3RyaW5nICs9ICdcXG5yZXR1cm4gcjt9KSc7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGV2YWwuY2FsbCh3aW5kb3csIHJlc3VsdFN0cmluZyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0LmNvbXBpbGUgPSBmdW5jdGlvbiAodGVtcGxhdGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXQuY29tcGlsZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgdC5jb21waWxlZCA9IGNvbXBpbGUodGVtcGxhdGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gdC5jb21waWxlZDtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH07XG4gICAgICAgIFRlbXBsYXRlNy5wcm90b3R5cGUgPSB7XG4gICAgICAgICAgICBvcHRpb25zOiB7fSxcbiAgICAgICAgICAgIHBhcnRpYWxzOiB7fSxcbiAgICAgICAgICAgIGhlbHBlcnM6IHtcbiAgICAgICAgICAgICAgICAnX3BhcnRpYWwnIDogZnVuY3Rpb24gKHBhcnRpYWxOYW1lLCBvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwID0gVGVtcGxhdGU3LnByb3RvdHlwZS5wYXJ0aWFsc1twYXJ0aWFsTmFtZV07XG4gICAgICAgICAgICAgICAgICAgIGlmICghcCB8fCAocCAmJiAhcC50ZW1wbGF0ZSkpIHJldHVybiAnJztcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFwLmNvbXBpbGVkKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwLmNvbXBpbGVkID0gdDcuY29tcGlsZShwLnRlbXBsYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YXIgY3R4ID0gdGhpcztcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaGFzaE5hbWUgaW4gb3B0aW9ucy5oYXNoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdHhbaGFzaE5hbWVdID0gb3B0aW9ucy5oYXNoW2hhc2hOYW1lXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcC5jb21waWxlZChjdHgsIG9wdGlvbnMuZGF0YSwgb3B0aW9ucy5yb290KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICdlc2NhcGUnOiBmdW5jdGlvbiAoY29udGV4dCwgb3B0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGNvbnRleHQgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RlbXBsYXRlNzogUGFzc2VkIGNvbnRleHQgdG8gXCJlc2NhcGVcIiBoZWxwZXIgc2hvdWxkIGJlIGEgc3RyaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvJi9nLCAnJmFtcDsnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC88L2csICcmbHQ7JylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAucmVwbGFjZSgvPi9nLCAnJmd0OycpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnJlcGxhY2UoL1wiL2csICcmcXVvdDsnKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICdpZic6IGZ1bmN0aW9uIChjb250ZXh0LCBvcHRpb25zKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGNvbnRleHQpKSB7IGNvbnRleHQgPSBjb250ZXh0LmNhbGwodGhpcyk7IH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25zLmZuKHRoaXMsIG9wdGlvbnMuZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9ucy5pbnZlcnNlKHRoaXMsIG9wdGlvbnMuZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICd1bmxlc3MnOiBmdW5jdGlvbiAoY29udGV4dCwgb3B0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihjb250ZXh0KSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghY29udGV4dCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9wdGlvbnMuZm4odGhpcywgb3B0aW9ucy5kYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25zLmludmVyc2UodGhpcywgb3B0aW9ucy5kYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgJ2VhY2gnOiBmdW5jdGlvbiAoY29udGV4dCwgb3B0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcmV0ID0gJycsIGkgPSAwO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXNGdW5jdGlvbihjb250ZXh0KSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChpc0FycmF5KGNvbnRleHQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5oYXNoLnJldmVyc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZXh0ID0gY29udGV4dC5yZXZlcnNlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgY29udGV4dC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldCArPSBvcHRpb25zLmZuKGNvbnRleHRbaV0sIHtmaXJzdDogaSA9PT0gMCwgbGFzdDogaSA9PT0gY29udGV4dC5sZW5ndGggLSAxLCBpbmRleDogaX0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaGFzaC5yZXZlcnNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQucmV2ZXJzZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGNvbnRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpKys7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0ICs9IG9wdGlvbnMuZm4oY29udGV4dFtrZXldLCB7a2V5OiBrZXl9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoaSA+IDApIHJldHVybiByZXQ7XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIG9wdGlvbnMuaW52ZXJzZSh0aGlzKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICd3aXRoJzogZnVuY3Rpb24gKGNvbnRleHQsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oY29udGV4dCkpIHsgY29udGV4dCA9IGNvbnRleHQuY2FsbCh0aGlzKTsgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9ucy5mbihjb250ZXh0KTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICdqb2luJzogZnVuY3Rpb24gKGNvbnRleHQsIG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlzRnVuY3Rpb24oY29udGV4dCkpIHsgY29udGV4dCA9IGNvbnRleHQuY2FsbCh0aGlzKTsgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gY29udGV4dC5qb2luKG9wdGlvbnMuaGFzaC5kZWxpbWl0ZXIgfHwgb3B0aW9ucy5oYXNoLmRlbGltZXRlcik7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAnanMnOiBmdW5jdGlvbiAoZXhwcmVzc2lvbiwgb3B0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZnVuYztcbiAgICAgICAgICAgICAgICAgICAgaWYgKGV4cHJlc3Npb24uaW5kZXhPZigncmV0dXJuJyk+PTApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZ1bmMgPSAnKGZ1bmN0aW9uKCl7JytleHByZXNzaW9uKyd9KSc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jID0gJyhmdW5jdGlvbigpe3JldHVybiAoJytleHByZXNzaW9uKycpfSknO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBldmFsLmNhbGwodGhpcywgZnVuYykuY2FsbCh0aGlzKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICdqc19jb21wYXJlJzogZnVuY3Rpb24gKGV4cHJlc3Npb24sIG9wdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZ1bmM7XG4gICAgICAgICAgICAgICAgICAgIGlmIChleHByZXNzaW9uLmluZGV4T2YoJ3JldHVybicpPj0wKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmdW5jID0gJyhmdW5jdGlvbigpeycrZXhwcmVzc2lvbisnfSknO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgZnVuYyA9ICcoZnVuY3Rpb24oKXtyZXR1cm4gKCcrZXhwcmVzc2lvbisnKX0pJztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YXIgY29uZGl0aW9uID0gZXZhbC5jYWxsKHRoaXMsIGZ1bmMpLmNhbGwodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjb25kaXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvcHRpb25zLmZuKHRoaXMsIG9wdGlvbnMuZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb3B0aW9ucy5pbnZlcnNlKHRoaXMsIG9wdGlvbnMuZGF0YSk7ICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHZhciB0NyA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgZGF0YSkge1xuICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICAgICAgICB2YXIgaW5zdGFuY2UgPSBuZXcgVGVtcGxhdGU3KHRlbXBsYXRlKTtcbiAgICAgICAgICAgICAgICB2YXIgcmVuZGVyZWQgPSBpbnN0YW5jZS5jb21waWxlKCkoZGF0YSk7XG4gICAgICAgICAgICAgICAgaW5zdGFuY2UgPSBudWxsO1xuICAgICAgICAgICAgICAgIHJldHVybiAocmVuZGVyZWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSByZXR1cm4gbmV3IFRlbXBsYXRlNyh0ZW1wbGF0ZSk7XG4gICAgICAgIH07XG4gICAgICAgIHQ3LnJlZ2lzdGVySGVscGVyID0gZnVuY3Rpb24gKG5hbWUsIGZuKSB7XG4gICAgICAgICAgICBUZW1wbGF0ZTcucHJvdG90eXBlLmhlbHBlcnNbbmFtZV0gPSBmbjtcbiAgICAgICAgfTtcbiAgICAgICAgdDcudW5yZWdpc3RlckhlbHBlciA9IGZ1bmN0aW9uIChuYW1lKSB7XG4gICAgICAgICAgICBUZW1wbGF0ZTcucHJvdG90eXBlLmhlbHBlcnNbbmFtZV0gPSB1bmRlZmluZWQ7ICBcbiAgICAgICAgICAgIGRlbGV0ZSBUZW1wbGF0ZTcucHJvdG90eXBlLmhlbHBlcnNbbmFtZV07XG4gICAgICAgIH07XG4gICAgICAgIHQ3LnJlZ2lzdGVyUGFydGlhbCA9IGZ1bmN0aW9uIChuYW1lLCB0ZW1wbGF0ZSkge1xuICAgICAgICAgICAgVGVtcGxhdGU3LnByb3RvdHlwZS5wYXJ0aWFsc1tuYW1lXSA9IHt0ZW1wbGF0ZTogdGVtcGxhdGV9O1xuICAgICAgICB9O1xuICAgICAgICB0Ny51bnJlZ2lzdGVyUGFydGlhbCA9IGZ1bmN0aW9uIChuYW1lLCB0ZW1wbGF0ZSkge1xuICAgICAgICAgICAgaWYgKFRlbXBsYXRlNy5wcm90b3R5cGUucGFydGlhbHNbbmFtZV0pIHtcbiAgICAgICAgICAgICAgICBUZW1wbGF0ZTcucHJvdG90eXBlLnBhcnRpYWxzW25hbWVdID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBUZW1wbGF0ZTcucHJvdG90eXBlLnBhcnRpYWxzW25hbWVdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgdDcuY29tcGlsZSA9IGZ1bmN0aW9uICh0ZW1wbGF0ZSwgb3B0aW9ucykge1xuICAgICAgICAgICAgdmFyIGluc3RhbmNlID0gbmV3IFRlbXBsYXRlNyh0ZW1wbGF0ZSwgb3B0aW9ucyk7XG4gICAgICAgICAgICByZXR1cm4gaW5zdGFuY2UuY29tcGlsZSgpO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgdDcub3B0aW9ucyA9IFRlbXBsYXRlNy5wcm90b3R5cGUub3B0aW9ucztcbiAgICAgICAgdDcuaGVscGVycyA9IFRlbXBsYXRlNy5wcm90b3R5cGUuaGVscGVycztcbiAgICAgICAgdDcucGFydGlhbHMgPSBUZW1wbGF0ZTcucHJvdG90eXBlLnBhcnRpYWxzO1xuICAgICAgICByZXR1cm4gdDc7XG4gICAgfSkoKTtcblxuICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgU3dpcGVyXG4gICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICB3aW5kb3cuU3dpcGVyID0gZnVuY3Rpb24gKGNvbnRhaW5lciwgcGFyYW1zKSB7XG4gICAgICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBTd2lwZXIpKSByZXR1cm4gbmV3IFN3aXBlcihjb250YWluZXIsIHBhcmFtcyk7XG4gICAgICAgIHZhciBkZWZhdWx0cyA9IHtcbiAgICAgICAgICAgIGRpcmVjdGlvbjogJ2hvcml6b250YWwnLFxuICAgICAgICAgICAgdG91Y2hFdmVudHNUYXJnZXQ6ICdjb250YWluZXInLFxuICAgICAgICAgICAgaW5pdGlhbFNsaWRlOiAwLFxuICAgICAgICAgICAgc3BlZWQ6IDMwMCxcbiAgICAgICAgICAgIC8vIGF1dG9wbGF5XG4gICAgICAgICAgICBhdXRvcGxheTogZmFsc2UsXG4gICAgICAgICAgICBhdXRvcGxheURpc2FibGVPbkludGVyYWN0aW9uOiB0cnVlLFxuICAgICAgICAgICAgYXV0b3BsYXlTdG9wT25MYXN0OiBmYWxzZSxcbiAgICAgICAgICAgIC8vIFRvIHN1cHBvcnQgaU9TJ3Mgc3dpcGUtdG8tZ28tYmFjayBnZXN0dXJlICh3aGVuIGJlaW5nIHVzZWQgaW4tYXBwLCB3aXRoIFVJV2ViVmlldykuXG4gICAgICAgICAgICBpT1NFZGdlU3dpcGVEZXRlY3Rpb246IGZhbHNlLFxuICAgICAgICAgICAgaU9TRWRnZVN3aXBlVGhyZXNob2xkOiAyMCxcbiAgICAgICAgICAgIC8vIEZyZWUgbW9kZVxuICAgICAgICAgICAgZnJlZU1vZGU6IGZhbHNlLFxuICAgICAgICAgICAgZnJlZU1vZGVNb21lbnR1bTogdHJ1ZSxcbiAgICAgICAgICAgIGZyZWVNb2RlTW9tZW50dW1SYXRpbzogMSxcbiAgICAgICAgICAgIGZyZWVNb2RlTW9tZW50dW1Cb3VuY2U6IHRydWUsXG4gICAgICAgICAgICBmcmVlTW9kZU1vbWVudHVtQm91bmNlUmF0aW86IDEsXG4gICAgICAgICAgICBmcmVlTW9kZVN0aWNreTogZmFsc2UsXG4gICAgICAgICAgICBmcmVlTW9kZU1pbmltdW1WZWxvY2l0eTogMC4wMixcbiAgICAgICAgICAgIC8vIEF1dG9oZWlnaHRcbiAgICAgICAgICAgIGF1dG9IZWlnaHQ6IGZhbHNlLFxuICAgICAgICAgICAgLy8gU2V0IHdyYXBwZXIgd2lkdGhcbiAgICAgICAgICAgIHNldFdyYXBwZXJTaXplOiBmYWxzZSxcbiAgICAgICAgICAgIC8vIFZpcnR1YWwgVHJhbnNsYXRlXG4gICAgICAgICAgICB2aXJ0dWFsVHJhbnNsYXRlOiBmYWxzZSxcbiAgICAgICAgICAgIC8vIEVmZmVjdHNcbiAgICAgICAgICAgIGVmZmVjdDogJ3NsaWRlJywgLy8gJ3NsaWRlJyBvciAnZmFkZScgb3IgJ2N1YmUnIG9yICdjb3ZlcmZsb3cnIG9yICdmbGlwJ1xuICAgICAgICAgICAgY292ZXJmbG93OiB7XG4gICAgICAgICAgICAgICAgcm90YXRlOiA1MCxcbiAgICAgICAgICAgICAgICBzdHJldGNoOiAwLFxuICAgICAgICAgICAgICAgIGRlcHRoOiAxMDAsXG4gICAgICAgICAgICAgICAgbW9kaWZpZXI6IDEsXG4gICAgICAgICAgICAgICAgc2xpZGVTaGFkb3dzIDogdHJ1ZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGZsaXA6IHtcbiAgICAgICAgICAgICAgICBzbGlkZVNoYWRvd3MgOiB0cnVlLFxuICAgICAgICAgICAgICAgIGxpbWl0Um90YXRpb246IHRydWVcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBjdWJlOiB7XG4gICAgICAgICAgICAgICAgc2xpZGVTaGFkb3dzOiB0cnVlLFxuICAgICAgICAgICAgICAgIHNoYWRvdzogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzaGFkb3dPZmZzZXQ6IDIwLFxuICAgICAgICAgICAgICAgIHNoYWRvd1NjYWxlOiAwLjk0XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZmFkZToge1xuICAgICAgICAgICAgICAgIGNyb3NzRmFkZTogZmFsc2VcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAvLyBQYXJhbGxheFxuICAgICAgICAgICAgcGFyYWxsYXg6IGZhbHNlLFxuICAgICAgICAgICAgLy8gU2Nyb2xsYmFyXG4gICAgICAgICAgICBzY3JvbGxiYXI6IG51bGwsXG4gICAgICAgICAgICBzY3JvbGxiYXJIaWRlOiB0cnVlLFxuICAgICAgICAgICAgc2Nyb2xsYmFyRHJhZ2dhYmxlOiBmYWxzZSxcbiAgICAgICAgICAgIHNjcm9sbGJhclNuYXBPblJlbGVhc2U6IGZhbHNlLFxuICAgICAgICAgICAgLy8gS2V5Ym9hcmQgTW91c2V3aGVlbFxuICAgICAgICAgICAga2V5Ym9hcmRDb250cm9sOiBmYWxzZSxcbiAgICAgICAgICAgIG1vdXNld2hlZWxDb250cm9sOiBmYWxzZSxcbiAgICAgICAgICAgIG1vdXNld2hlZWxSZWxlYXNlT25FZGdlczogZmFsc2UsXG4gICAgICAgICAgICBtb3VzZXdoZWVsSW52ZXJ0OiBmYWxzZSxcbiAgICAgICAgICAgIG1vdXNld2hlZWxGb3JjZVRvQXhpczogZmFsc2UsXG4gICAgICAgICAgICBtb3VzZXdoZWVsU2Vuc2l0aXZpdHk6IDEsXG4gICAgICAgICAgICAvLyBIYXNoIE5hdmlnYXRpb25cbiAgICAgICAgICAgIGhhc2huYXY6IGZhbHNlLFxuICAgICAgICAgICAgLy8gQnJlYWtwb2ludHNcbiAgICAgICAgICAgIGJyZWFrcG9pbnRzOiB1bmRlZmluZWQsXG4gICAgICAgICAgICAvLyBTbGlkZXMgZ3JpZFxuICAgICAgICAgICAgc3BhY2VCZXR3ZWVuOiAwLFxuICAgICAgICAgICAgc2xpZGVzUGVyVmlldzogMSxcbiAgICAgICAgICAgIHNsaWRlc1BlckNvbHVtbjogMSxcbiAgICAgICAgICAgIHNsaWRlc1BlckNvbHVtbkZpbGw6ICdjb2x1bW4nLFxuICAgICAgICAgICAgc2xpZGVzUGVyR3JvdXA6IDEsXG4gICAgICAgICAgICBjZW50ZXJlZFNsaWRlczogZmFsc2UsXG4gICAgICAgICAgICBzbGlkZXNPZmZzZXRCZWZvcmU6IDAsIC8vIGluIHB4XG4gICAgICAgICAgICBzbGlkZXNPZmZzZXRBZnRlcjogMCwgLy8gaW4gcHhcbiAgICAgICAgICAgIC8vIFJvdW5kIGxlbmd0aFxuICAgICAgICAgICAgcm91bmRMZW5ndGhzOiBmYWxzZSxcbiAgICAgICAgICAgIC8vIFRvdWNoZXNcbiAgICAgICAgICAgIHRvdWNoUmF0aW86IDEsXG4gICAgICAgICAgICB0b3VjaEFuZ2xlOiA0NSxcbiAgICAgICAgICAgIHNpbXVsYXRlVG91Y2g6IHRydWUsXG4gICAgICAgICAgICBzaG9ydFN3aXBlczogdHJ1ZSxcbiAgICAgICAgICAgIGxvbmdTd2lwZXM6IHRydWUsXG4gICAgICAgICAgICBsb25nU3dpcGVzUmF0aW86IDAuNSxcbiAgICAgICAgICAgIGxvbmdTd2lwZXNNczogMzAwLFxuICAgICAgICAgICAgZm9sbG93RmluZ2VyOiB0cnVlLFxuICAgICAgICAgICAgb25seUV4dGVybmFsOiBmYWxzZSxcbiAgICAgICAgICAgIHRocmVzaG9sZDogMCxcbiAgICAgICAgICAgIHRvdWNoTW92ZVN0b3BQcm9wYWdhdGlvbjogdHJ1ZSxcbiAgICAgICAgICAgIC8vIFVuaXF1ZSBOYXZpZ2F0aW9uIEVsZW1lbnRzXG4gICAgICAgICAgICB1bmlxdWVOYXZFbGVtZW50czogdHJ1ZSxcbiAgICAgICAgICAgIC8vIFBhZ2luYXRpb25cbiAgICAgICAgICAgIHBhZ2luYXRpb246IG51bGwsXG4gICAgICAgICAgICBwYWdpbmF0aW9uRWxlbWVudDogJ3NwYW4nLFxuICAgICAgICAgICAgcGFnaW5hdGlvbkNsaWNrYWJsZTogZmFsc2UsXG4gICAgICAgICAgICBwYWdpbmF0aW9uSGlkZTogZmFsc2UsXG4gICAgICAgICAgICBwYWdpbmF0aW9uQnVsbGV0UmVuZGVyOiBudWxsLFxuICAgICAgICAgICAgcGFnaW5hdGlvblByb2dyZXNzUmVuZGVyOiBudWxsLFxuICAgICAgICAgICAgcGFnaW5hdGlvbkZyYWN0aW9uUmVuZGVyOiBudWxsLFxuICAgICAgICAgICAgcGFnaW5hdGlvbkN1c3RvbVJlbmRlcjogbnVsbCxcbiAgICAgICAgICAgIHBhZ2luYXRpb25UeXBlOiAnYnVsbGV0cycsIC8vICdidWxsZXRzJyBvciAncHJvZ3Jlc3MnIG9yICdmcmFjdGlvbicgb3IgJ2N1c3RvbSdcbiAgICAgICAgICAgIC8vIFJlc2lzdGFuY2VcbiAgICAgICAgICAgIHJlc2lzdGFuY2U6IHRydWUsXG4gICAgICAgICAgICByZXNpc3RhbmNlUmF0aW86IDAuODUsXG4gICAgICAgICAgICAvLyBOZXh0L3ByZXYgYnV0dG9uc1xuICAgICAgICAgICAgbmV4dEJ1dHRvbjogbnVsbCxcbiAgICAgICAgICAgIHByZXZCdXR0b246IG51bGwsXG4gICAgICAgICAgICAvLyBQcm9ncmVzc1xuICAgICAgICAgICAgd2F0Y2hTbGlkZXNQcm9ncmVzczogZmFsc2UsXG4gICAgICAgICAgICB3YXRjaFNsaWRlc1Zpc2liaWxpdHk6IGZhbHNlLFxuICAgICAgICAgICAgLy8gQ3Vyc29yXG4gICAgICAgICAgICBncmFiQ3Vyc29yOiBmYWxzZSxcbiAgICAgICAgICAgIC8vIENsaWNrc1xuICAgICAgICAgICAgcHJldmVudENsaWNrczogdHJ1ZSxcbiAgICAgICAgICAgIHByZXZlbnRDbGlja3NQcm9wYWdhdGlvbjogdHJ1ZSxcbiAgICAgICAgICAgIHNsaWRlVG9DbGlja2VkU2xpZGU6IGZhbHNlLFxuICAgICAgICAgICAgLy8gTGF6eSBMb2FkaW5nXG4gICAgICAgICAgICBsYXp5TG9hZGluZzogZmFsc2UsXG4gICAgICAgICAgICBsYXp5TG9hZGluZ0luUHJldk5leHQ6IGZhbHNlLFxuICAgICAgICAgICAgbGF6eUxvYWRpbmdJblByZXZOZXh0QW1vdW50OiAxLFxuICAgICAgICAgICAgbGF6eUxvYWRpbmdPblRyYW5zaXRpb25TdGFydDogZmFsc2UsXG4gICAgICAgICAgICAvLyBJbWFnZXNcbiAgICAgICAgICAgIHByZWxvYWRJbWFnZXM6IHRydWUsXG4gICAgICAgICAgICB1cGRhdGVPbkltYWdlc1JlYWR5OiB0cnVlLFxuICAgICAgICAgICAgLy8gbG9vcFxuICAgICAgICAgICAgbG9vcDogZmFsc2UsXG4gICAgICAgICAgICBsb29wQWRkaXRpb25hbFNsaWRlczogMCxcbiAgICAgICAgICAgIGxvb3BlZFNsaWRlczogbnVsbCxcbiAgICAgICAgICAgIC8vIENvbnRyb2xcbiAgICAgICAgICAgIGNvbnRyb2w6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIGNvbnRyb2xJbnZlcnNlOiBmYWxzZSxcbiAgICAgICAgICAgIGNvbnRyb2xCeTogJ3NsaWRlJywgLy9vciAnY29udGFpbmVyJ1xuICAgICAgICAgICAgLy8gU3dpcGluZy9ubyBzd2lwaW5nXG4gICAgICAgICAgICBhbGxvd1N3aXBlVG9QcmV2OiB0cnVlLFxuICAgICAgICAgICAgYWxsb3dTd2lwZVRvTmV4dDogdHJ1ZSxcbiAgICAgICAgICAgIHN3aXBlSGFuZGxlcjogbnVsbCwgLy8nLnN3aXBlLWhhbmRsZXInLFxuICAgICAgICAgICAgbm9Td2lwaW5nOiB0cnVlLFxuICAgICAgICAgICAgbm9Td2lwaW5nQ2xhc3M6ICdzd2lwZXItbm8tc3dpcGluZycsXG4gICAgICAgICAgICAvLyBOU1xuICAgICAgICAgICAgc2xpZGVDbGFzczogJ3N3aXBlci1zbGlkZScsXG4gICAgICAgICAgICBzbGlkZUFjdGl2ZUNsYXNzOiAnc3dpcGVyLXNsaWRlLWFjdGl2ZScsXG4gICAgICAgICAgICBzbGlkZVZpc2libGVDbGFzczogJ3N3aXBlci1zbGlkZS12aXNpYmxlJyxcbiAgICAgICAgICAgIHNsaWRlRHVwbGljYXRlQ2xhc3M6ICdzd2lwZXItc2xpZGUtZHVwbGljYXRlJyxcbiAgICAgICAgICAgIHNsaWRlTmV4dENsYXNzOiAnc3dpcGVyLXNsaWRlLW5leHQnLFxuICAgICAgICAgICAgc2xpZGVQcmV2Q2xhc3M6ICdzd2lwZXItc2xpZGUtcHJldicsXG4gICAgICAgICAgICB3cmFwcGVyQ2xhc3M6ICdzd2lwZXItd3JhcHBlcicsXG4gICAgICAgICAgICBidWxsZXRDbGFzczogJ3N3aXBlci1wYWdpbmF0aW9uLWJ1bGxldCcsXG4gICAgICAgICAgICBidWxsZXRBY3RpdmVDbGFzczogJ3N3aXBlci1wYWdpbmF0aW9uLWJ1bGxldC1hY3RpdmUnLFxuICAgICAgICAgICAgYnV0dG9uRGlzYWJsZWRDbGFzczogJ3N3aXBlci1idXR0b24tZGlzYWJsZWQnLFxuICAgICAgICAgICAgcGFnaW5hdGlvbkN1cnJlbnRDbGFzczogJ3N3aXBlci1wYWdpbmF0aW9uLWN1cnJlbnQnLFxuICAgICAgICAgICAgcGFnaW5hdGlvblRvdGFsQ2xhc3M6ICdzd2lwZXItcGFnaW5hdGlvbi10b3RhbCcsXG4gICAgICAgICAgICBwYWdpbmF0aW9uSGlkZGVuQ2xhc3M6ICdzd2lwZXItcGFnaW5hdGlvbi1oaWRkZW4nLFxuICAgICAgICAgICAgcGFnaW5hdGlvblByb2dyZXNzYmFyQ2xhc3M6ICdzd2lwZXItcGFnaW5hdGlvbi1wcm9ncmVzc2JhcicsXG4gICAgICAgICAgICAvLyBPYnNlcnZlclxuICAgICAgICAgICAgb2JzZXJ2ZXI6IGZhbHNlLFxuICAgICAgICAgICAgb2JzZXJ2ZVBhcmVudHM6IGZhbHNlLFxuICAgICAgICAgICAgLy8gQWNjZXNzaWJpbGl0eVxuICAgICAgICAgICAgYTExeTogZmFsc2UsXG4gICAgICAgICAgICBwcmV2U2xpZGVNZXNzYWdlOiAnUHJldmlvdXMgc2xpZGUnLFxuICAgICAgICAgICAgbmV4dFNsaWRlTWVzc2FnZTogJ05leHQgc2xpZGUnLFxuICAgICAgICAgICAgZmlyc3RTbGlkZU1lc3NhZ2U6ICdUaGlzIGlzIHRoZSBmaXJzdCBzbGlkZScsXG4gICAgICAgICAgICBsYXN0U2xpZGVNZXNzYWdlOiAnVGhpcyBpcyB0aGUgbGFzdCBzbGlkZScsXG4gICAgICAgICAgICBwYWdpbmF0aW9uQnVsbGV0TWVzc2FnZTogJ0dvIHRvIHNsaWRlIHt7aW5kZXh9fScsXG4gICAgICAgICAgICAvLyBDYWxsYmFja3NcbiAgICAgICAgICAgIHJ1bkNhbGxiYWNrc09uSW5pdDogdHJ1ZVxuICAgICAgICAgICAgLypcbiAgICAgICAgICAgIENhbGxiYWNrczpcbiAgICAgICAgICAgIG9uSW5pdDogZnVuY3Rpb24gKHN3aXBlcilcbiAgICAgICAgICAgIG9uRGVzdHJveTogZnVuY3Rpb24gKHN3aXBlcilcbiAgICAgICAgICAgIG9uQ2xpY2s6IGZ1bmN0aW9uIChzd2lwZXIsIGUpXG4gICAgICAgICAgICBvblRhcDogZnVuY3Rpb24gKHN3aXBlciwgZSlcbiAgICAgICAgICAgIG9uRG91YmxlVGFwOiBmdW5jdGlvbiAoc3dpcGVyLCBlKVxuICAgICAgICAgICAgb25TbGlkZXJNb3ZlOiBmdW5jdGlvbiAoc3dpcGVyLCBlKVxuICAgICAgICAgICAgb25TbGlkZUNoYW5nZVN0YXJ0OiBmdW5jdGlvbiAoc3dpcGVyKVxuICAgICAgICAgICAgb25TbGlkZUNoYW5nZUVuZDogZnVuY3Rpb24gKHN3aXBlcilcbiAgICAgICAgICAgIG9uVHJhbnNpdGlvblN0YXJ0OiBmdW5jdGlvbiAoc3dpcGVyKVxuICAgICAgICAgICAgb25UcmFuc2l0aW9uRW5kOiBmdW5jdGlvbiAoc3dpcGVyKVxuICAgICAgICAgICAgb25JbWFnZXNSZWFkeTogZnVuY3Rpb24gKHN3aXBlcilcbiAgICAgICAgICAgIG9uUHJvZ3Jlc3M6IGZ1bmN0aW9uIChzd2lwZXIsIHByb2dyZXNzKVxuICAgICAgICAgICAgb25Ub3VjaFN0YXJ0OiBmdW5jdGlvbiAoc3dpcGVyLCBlKVxuICAgICAgICAgICAgb25Ub3VjaE1vdmU6IGZ1bmN0aW9uIChzd2lwZXIsIGUpXG4gICAgICAgICAgICBvblRvdWNoTW92ZU9wcG9zaXRlOiBmdW5jdGlvbiAoc3dpcGVyLCBlKVxuICAgICAgICAgICAgb25Ub3VjaEVuZDogZnVuY3Rpb24gKHN3aXBlciwgZSlcbiAgICAgICAgICAgIG9uUmVhY2hCZWdpbm5pbmc6IGZ1bmN0aW9uIChzd2lwZXIpXG4gICAgICAgICAgICBvblJlYWNoRW5kOiBmdW5jdGlvbiAoc3dpcGVyKVxuICAgICAgICAgICAgb25TZXRUcmFuc2l0aW9uOiBmdW5jdGlvbiAoc3dpcGVyLCBkdXJhdGlvbilcbiAgICAgICAgICAgIG9uU2V0VHJhbnNsYXRlOiBmdW5jdGlvbiAoc3dpcGVyLCB0cmFuc2xhdGUpXG4gICAgICAgICAgICBvbkF1dG9wbGF5U3RhcnQ6IGZ1bmN0aW9uIChzd2lwZXIpXG4gICAgICAgICAgICBvbkF1dG9wbGF5U3RvcDogZnVuY3Rpb24gKHN3aXBlciksXG4gICAgICAgICAgICBvbkxhenlJbWFnZUxvYWQ6IGZ1bmN0aW9uIChzd2lwZXIsIHNsaWRlLCBpbWFnZSlcbiAgICAgICAgICAgIG9uTGF6eUltYWdlUmVhZHk6IGZ1bmN0aW9uIChzd2lwZXIsIHNsaWRlLCBpbWFnZSlcbiAgICAgICAgICAgICovXG4gICAgICAgIFxuICAgICAgICB9O1xuICAgICAgICB2YXIgaW5pdGlhbFZpcnR1YWxUcmFuc2xhdGUgPSBwYXJhbXMgJiYgcGFyYW1zLnZpcnR1YWxUcmFuc2xhdGU7XG4gICAgICAgIFxuICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307XG4gICAgICAgIHZhciBvcmlnaW5hbFBhcmFtcyA9IHt9O1xuICAgICAgICBmb3IgKHZhciBwYXJhbSBpbiBwYXJhbXMpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW3BhcmFtXSA9PT0gJ29iamVjdCcgJiYgcGFyYW1zW3BhcmFtXSAhPT0gbnVsbCAmJiAhKHBhcmFtc1twYXJhbV0ubm9kZVR5cGUgfHwgcGFyYW1zW3BhcmFtXSA9PT0gd2luZG93IHx8IHBhcmFtc1twYXJhbV0gPT09IGRvY3VtZW50IHx8ICh0eXBlb2YgRG9tNyAhPT0gJ3VuZGVmaW5lZCcgJiYgcGFyYW1zW3BhcmFtXSBpbnN0YW5jZW9mIERvbTcpIHx8ICh0eXBlb2YgalF1ZXJ5ICE9PSAndW5kZWZpbmVkJyAmJiBwYXJhbXNbcGFyYW1dIGluc3RhbmNlb2YgalF1ZXJ5KSkpIHtcbiAgICAgICAgICAgICAgICBvcmlnaW5hbFBhcmFtc1twYXJhbV0gPSB7fTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBkZWVwUGFyYW0gaW4gcGFyYW1zW3BhcmFtXSkge1xuICAgICAgICAgICAgICAgICAgICBvcmlnaW5hbFBhcmFtc1twYXJhbV1bZGVlcFBhcmFtXSA9IHBhcmFtc1twYXJhbV1bZGVlcFBhcmFtXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBvcmlnaW5hbFBhcmFtc1twYXJhbV0gPSBwYXJhbXNbcGFyYW1dO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGZvciAodmFyIGRlZiBpbiBkZWZhdWx0cykge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXNbZGVmXSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBwYXJhbXNbZGVmXSA9IGRlZmF1bHRzW2RlZl07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgcGFyYW1zW2RlZl0gPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgZGVlcERlZiBpbiBkZWZhdWx0c1tkZWZdKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zW2RlZl1bZGVlcERlZl0gPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXNbZGVmXVtkZWVwRGVmXSA9IGRlZmF1bHRzW2RlZl1bZGVlcERlZl07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIFN3aXBlclxuICAgICAgICB2YXIgcyA9IHRoaXM7XG4gICAgICAgIFxuICAgICAgICAvLyBQYXJhbXNcbiAgICAgICAgcy5wYXJhbXMgPSBwYXJhbXM7XG4gICAgICAgIHMub3JpZ2luYWxQYXJhbXMgPSBvcmlnaW5hbFBhcmFtcztcbiAgICAgICAgXG4gICAgICAgIC8vIENsYXNzbmFtZVxuICAgICAgICBzLmNsYXNzTmFtZXMgPSBbXTtcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgRG9tIExpYnJhcnkgYW5kIHBsdWdpbnNcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBpZiAodHlwZW9mICQgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZiBEb203ICE9PSAndW5kZWZpbmVkJyl7XG4gICAgICAgICAgICAkID0gRG9tNztcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mICQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIERvbTcgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgJCA9IHdpbmRvdy5Eb203IHx8IHdpbmRvdy5aZXB0byB8fCB3aW5kb3cualF1ZXJ5O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgJCA9IERvbTc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoISQpIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICAvLyBFeHBvcnQgaXQgdG8gU3dpcGVyIGluc3RhbmNlXG4gICAgICAgIHMuJCA9ICQ7XG4gICAgICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBCcmVha3BvaW50c1xuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMuY3VycmVudEJyZWFrcG9pbnQgPSB1bmRlZmluZWQ7XG4gICAgICAgIHMuZ2V0QWN0aXZlQnJlYWtwb2ludCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIC8vR2V0IGJyZWFrcG9pbnQgZm9yIHdpbmRvdyB3aWR0aFxuICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5icmVha3BvaW50cykgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgdmFyIGJyZWFrcG9pbnQgPSBmYWxzZTtcbiAgICAgICAgICAgIHZhciBwb2ludHMgPSBbXSwgcG9pbnQ7XG4gICAgICAgICAgICBmb3IgKCBwb2ludCBpbiBzLnBhcmFtcy5icmVha3BvaW50cyApIHtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuYnJlYWtwb2ludHMuaGFzT3duUHJvcGVydHkocG9pbnQpKSB7XG4gICAgICAgICAgICAgICAgICAgIHBvaW50cy5wdXNoKHBvaW50KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwb2ludHMuc29ydChmdW5jdGlvbiAoYSwgYikge1xuICAgICAgICAgICAgICAgIHJldHVybiBwYXJzZUludChhLCAxMCkgPiBwYXJzZUludChiLCAxMCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcG9pbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgcG9pbnQgPSBwb2ludHNbaV07XG4gICAgICAgICAgICAgICAgaWYgKHBvaW50ID49IHdpbmRvdy5pbm5lcldpZHRoICYmICFicmVha3BvaW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrcG9pbnQgPSBwb2ludDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gYnJlYWtwb2ludCB8fCAnbWF4JztcbiAgICAgICAgfTtcbiAgICAgICAgcy5zZXRCcmVha3BvaW50ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgLy9TZXQgYnJlYWtwb2ludCBmb3Igd2luZG93IHdpZHRoIGFuZCB1cGRhdGUgcGFyYW1ldGVyc1xuICAgICAgICAgICAgdmFyIGJyZWFrcG9pbnQgPSBzLmdldEFjdGl2ZUJyZWFrcG9pbnQoKTtcbiAgICAgICAgICAgIGlmIChicmVha3BvaW50ICYmIHMuY3VycmVudEJyZWFrcG9pbnQgIT09IGJyZWFrcG9pbnQpIHtcbiAgICAgICAgICAgICAgICB2YXIgYnJlYWtQb2ludHNQYXJhbXMgPSBicmVha3BvaW50IGluIHMucGFyYW1zLmJyZWFrcG9pbnRzID8gcy5wYXJhbXMuYnJlYWtwb2ludHNbYnJlYWtwb2ludF0gOiBzLm9yaWdpbmFsUGFyYW1zO1xuICAgICAgICAgICAgICAgIHZhciBuZWVkc1JlTG9vcCA9IHMucGFyYW1zLmxvb3AgJiYgKGJyZWFrUG9pbnRzUGFyYW1zLnNsaWRlc1BlclZpZXcgIT09IHMucGFyYW1zLnNsaWRlc1BlclZpZXcpO1xuICAgICAgICAgICAgICAgIGZvciAoIHZhciBwYXJhbSBpbiBicmVha1BvaW50c1BhcmFtcyApIHtcbiAgICAgICAgICAgICAgICAgICAgcy5wYXJhbXNbcGFyYW1dID0gYnJlYWtQb2ludHNQYXJhbXNbcGFyYW1dO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzLmN1cnJlbnRCcmVha3BvaW50ID0gYnJlYWtwb2ludDtcbiAgICAgICAgICAgICAgICBpZihuZWVkc1JlTG9vcCAmJiBzLmRlc3Ryb3lMb29wKSB7XG4gICAgICAgICAgICAgICAgICAgIHMucmVMb29wKHRydWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgLy8gU2V0IGJyZWFrcG9pbnQgb24gbG9hZFxuICAgICAgICBpZiAocy5wYXJhbXMuYnJlYWtwb2ludHMpIHtcbiAgICAgICAgICAgIHMuc2V0QnJlYWtwb2ludCgpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBQcmVwYXJhdGlvbiAtIERlZmluZSBDb250YWluZXIsIFdyYXBwZXIgYW5kIFBhZ2luYXRpb25cbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLmNvbnRhaW5lciA9ICQoY29udGFpbmVyKTtcbiAgICAgICAgaWYgKHMuY29udGFpbmVyLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICBpZiAocy5jb250YWluZXIubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgdmFyIHN3aXBlcnMgPSBbXTtcbiAgICAgICAgICAgIHMuY29udGFpbmVyLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBjb250YWluZXIgPSB0aGlzO1xuICAgICAgICAgICAgICAgIHN3aXBlcnMucHVzaChuZXcgU3dpcGVyKHRoaXMsIHBhcmFtcykpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByZXR1cm4gc3dpcGVycztcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gU2F2ZSBpbnN0YW5jZSBpbiBjb250YWluZXIgSFRNTCBFbGVtZW50IGFuZCBpbiBkYXRhXG4gICAgICAgIHMuY29udGFpbmVyWzBdLnN3aXBlciA9IHM7XG4gICAgICAgIHMuY29udGFpbmVyLmRhdGEoJ3N3aXBlcicsIHMpO1xuICAgICAgICBcbiAgICAgICAgcy5jbGFzc05hbWVzLnB1c2goJ3N3aXBlci1jb250YWluZXItJyArIHMucGFyYW1zLmRpcmVjdGlvbik7XG4gICAgICAgIFxuICAgICAgICBpZiAocy5wYXJhbXMuZnJlZU1vZGUpIHtcbiAgICAgICAgICAgIHMuY2xhc3NOYW1lcy5wdXNoKCdzd2lwZXItY29udGFpbmVyLWZyZWUtbW9kZScpO1xuICAgICAgICB9XG4gICAgICAgIGlmICghcy5zdXBwb3J0LmZsZXhib3gpIHtcbiAgICAgICAgICAgIHMuY2xhc3NOYW1lcy5wdXNoKCdzd2lwZXItY29udGFpbmVyLW5vLWZsZXhib3gnKTtcbiAgICAgICAgICAgIHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbiA9IDE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHMucGFyYW1zLmF1dG9IZWlnaHQpIHtcbiAgICAgICAgICAgIHMuY2xhc3NOYW1lcy5wdXNoKCdzd2lwZXItY29udGFpbmVyLWF1dG9oZWlnaHQnKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBFbmFibGUgc2xpZGVzIHByb2dyZXNzIHdoZW4gcmVxdWlyZWRcbiAgICAgICAgaWYgKHMucGFyYW1zLnBhcmFsbGF4IHx8IHMucGFyYW1zLndhdGNoU2xpZGVzVmlzaWJpbGl0eSkge1xuICAgICAgICAgICAgcy5wYXJhbXMud2F0Y2hTbGlkZXNQcm9ncmVzcyA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgLy8gQ292ZXJmbG93IC8gM0RcbiAgICAgICAgaWYgKFsnY3ViZScsICdjb3ZlcmZsb3cnLCAnZmxpcCddLmluZGV4T2Yocy5wYXJhbXMuZWZmZWN0KSA+PSAwKSB7XG4gICAgICAgICAgICBpZiAocy5zdXBwb3J0LnRyYW5zZm9ybXMzZCkge1xuICAgICAgICAgICAgICAgIHMucGFyYW1zLndhdGNoU2xpZGVzUHJvZ3Jlc3MgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHMuY2xhc3NOYW1lcy5wdXNoKCdzd2lwZXItY29udGFpbmVyLTNkJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzLnBhcmFtcy5lZmZlY3QgPSAnc2xpZGUnO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChzLnBhcmFtcy5lZmZlY3QgIT09ICdzbGlkZScpIHtcbiAgICAgICAgICAgIHMuY2xhc3NOYW1lcy5wdXNoKCdzd2lwZXItY29udGFpbmVyLScgKyBzLnBhcmFtcy5lZmZlY3QpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzLnBhcmFtcy5lZmZlY3QgPT09ICdjdWJlJykge1xuICAgICAgICAgICAgcy5wYXJhbXMucmVzaXN0YW5jZVJhdGlvID0gMDtcbiAgICAgICAgICAgIHMucGFyYW1zLnNsaWRlc1BlclZpZXcgPSAxO1xuICAgICAgICAgICAgcy5wYXJhbXMuc2xpZGVzUGVyQ29sdW1uID0gMTtcbiAgICAgICAgICAgIHMucGFyYW1zLnNsaWRlc1Blckdyb3VwID0gMTtcbiAgICAgICAgICAgIHMucGFyYW1zLmNlbnRlcmVkU2xpZGVzID0gZmFsc2U7XG4gICAgICAgICAgICBzLnBhcmFtcy5zcGFjZUJldHdlZW4gPSAwO1xuICAgICAgICAgICAgcy5wYXJhbXMudmlydHVhbFRyYW5zbGF0ZSA9IHRydWU7XG4gICAgICAgICAgICBzLnBhcmFtcy5zZXRXcmFwcGVyU2l6ZSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzLnBhcmFtcy5lZmZlY3QgPT09ICdmYWRlJyB8fCBzLnBhcmFtcy5lZmZlY3QgPT09ICdmbGlwJykge1xuICAgICAgICAgICAgcy5wYXJhbXMuc2xpZGVzUGVyVmlldyA9IDE7XG4gICAgICAgICAgICBzLnBhcmFtcy5zbGlkZXNQZXJDb2x1bW4gPSAxO1xuICAgICAgICAgICAgcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXAgPSAxO1xuICAgICAgICAgICAgcy5wYXJhbXMud2F0Y2hTbGlkZXNQcm9ncmVzcyA9IHRydWU7XG4gICAgICAgICAgICBzLnBhcmFtcy5zcGFjZUJldHdlZW4gPSAwO1xuICAgICAgICAgICAgcy5wYXJhbXMuc2V0V3JhcHBlclNpemUgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5pdGlhbFZpcnR1YWxUcmFuc2xhdGUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgcy5wYXJhbXMudmlydHVhbFRyYW5zbGF0ZSA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIEdyYWIgQ3Vyc29yXG4gICAgICAgIGlmIChzLnBhcmFtcy5ncmFiQ3Vyc29yICYmIHMuc3VwcG9ydC50b3VjaCkge1xuICAgICAgICAgICAgcy5wYXJhbXMuZ3JhYkN1cnNvciA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBXcmFwcGVyXG4gICAgICAgIHMud3JhcHBlciA9IHMuY29udGFpbmVyLmNoaWxkcmVuKCcuJyArIHMucGFyYW1zLndyYXBwZXJDbGFzcyk7XG4gICAgICAgIFxuICAgICAgICAvLyBQYWdpbmF0aW9uXG4gICAgICAgIGlmIChzLnBhcmFtcy5wYWdpbmF0aW9uKSB7XG4gICAgICAgICAgICBzLnBhZ2luYXRpb25Db250YWluZXIgPSAkKHMucGFyYW1zLnBhZ2luYXRpb24pO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnVuaXF1ZU5hdkVsZW1lbnRzICYmIHR5cGVvZiBzLnBhcmFtcy5wYWdpbmF0aW9uID09PSAnc3RyaW5nJyAmJiBzLnBhZ2luYXRpb25Db250YWluZXIubGVuZ3RoID4gMSAmJiBzLmNvbnRhaW5lci5maW5kKHMucGFyYW1zLnBhZ2luYXRpb24pLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgIHMucGFnaW5hdGlvbkNvbnRhaW5lciA9IHMuY29udGFpbmVyLmZpbmQocy5wYXJhbXMucGFnaW5hdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnBhZ2luYXRpb25UeXBlID09PSAnYnVsbGV0cycgJiYgcy5wYXJhbXMucGFnaW5hdGlvbkNsaWNrYWJsZSkge1xuICAgICAgICAgICAgICAgIHMucGFnaW5hdGlvbkNvbnRhaW5lci5hZGRDbGFzcygnc3dpcGVyLXBhZ2luYXRpb24tY2xpY2thYmxlJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzLnBhcmFtcy5wYWdpbmF0aW9uQ2xpY2thYmxlID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzLnBhZ2luYXRpb25Db250YWluZXIuYWRkQ2xhc3MoJ3N3aXBlci1wYWdpbmF0aW9uLScgKyBzLnBhcmFtcy5wYWdpbmF0aW9uVHlwZSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gTmV4dC9QcmV2IEJ1dHRvbnNcbiAgICAgICAgaWYgKHMucGFyYW1zLm5leHRCdXR0b24gfHwgcy5wYXJhbXMucHJldkJ1dHRvbikge1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLm5leHRCdXR0b24pIHtcbiAgICAgICAgICAgICAgICBzLm5leHRCdXR0b24gPSAkKHMucGFyYW1zLm5leHRCdXR0b24pO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy51bmlxdWVOYXZFbGVtZW50cyAmJiB0eXBlb2Ygcy5wYXJhbXMubmV4dEJ1dHRvbiA9PT0gJ3N0cmluZycgJiYgcy5uZXh0QnV0dG9uLmxlbmd0aCA+IDEgJiYgcy5jb250YWluZXIuZmluZChzLnBhcmFtcy5uZXh0QnV0dG9uKS5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5uZXh0QnV0dG9uID0gcy5jb250YWluZXIuZmluZChzLnBhcmFtcy5uZXh0QnV0dG9uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMucHJldkJ1dHRvbikge1xuICAgICAgICAgICAgICAgIHMucHJldkJ1dHRvbiA9ICQocy5wYXJhbXMucHJldkJ1dHRvbik7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnVuaXF1ZU5hdkVsZW1lbnRzICYmIHR5cGVvZiBzLnBhcmFtcy5wcmV2QnV0dG9uID09PSAnc3RyaW5nJyAmJiBzLnByZXZCdXR0b24ubGVuZ3RoID4gMSAmJiBzLmNvbnRhaW5lci5maW5kKHMucGFyYW1zLnByZXZCdXR0b24pLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgICAgICBzLnByZXZCdXR0b24gPSBzLmNvbnRhaW5lci5maW5kKHMucGFyYW1zLnByZXZCdXR0b24pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gSXMgSG9yaXpvbnRhbFxuICAgICAgICBzLmlzSG9yaXpvbnRhbCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiBzLnBhcmFtcy5kaXJlY3Rpb24gPT09ICdob3Jpem9udGFsJztcbiAgICAgICAgfTtcbiAgICAgICAgLy8gcy5pc0ggPSBpc0g7XG4gICAgICAgIFxuICAgICAgICAvLyBSVExcbiAgICAgICAgcy5ydGwgPSBzLmlzSG9yaXpvbnRhbCgpICYmIChzLmNvbnRhaW5lclswXS5kaXIudG9Mb3dlckNhc2UoKSA9PT0gJ3J0bCcgfHwgcy5jb250YWluZXIuY3NzKCdkaXJlY3Rpb24nKSA9PT0gJ3J0bCcpO1xuICAgICAgICBpZiAocy5ydGwpIHtcbiAgICAgICAgICAgIHMuY2xhc3NOYW1lcy5wdXNoKCdzd2lwZXItY29udGFpbmVyLXJ0bCcpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBXcm9uZyBSVEwgc3VwcG9ydFxuICAgICAgICBpZiAocy5ydGwpIHtcbiAgICAgICAgICAgIHMud3JvbmdSVEwgPSBzLndyYXBwZXIuY3NzKCdkaXNwbGF5JykgPT09ICctd2Via2l0LWJveCc7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIENvbHVtbnNcbiAgICAgICAgaWYgKHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbiA+IDEpIHtcbiAgICAgICAgICAgIHMuY2xhc3NOYW1lcy5wdXNoKCdzd2lwZXItY29udGFpbmVyLW11bHRpcm93Jyk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIENoZWNrIGZvciBBbmRyb2lkXG4gICAgICAgIGlmIChzLmRldmljZS5hbmRyb2lkKSB7XG4gICAgICAgICAgICBzLmNsYXNzTmFtZXMucHVzaCgnc3dpcGVyLWNvbnRhaW5lci1hbmRyb2lkJyk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIEFkZCBjbGFzc2VzXG4gICAgICAgIHMuY29udGFpbmVyLmFkZENsYXNzKHMuY2xhc3NOYW1lcy5qb2luKCcgJykpO1xuICAgICAgICBcbiAgICAgICAgLy8gVHJhbnNsYXRlXG4gICAgICAgIHMudHJhbnNsYXRlID0gMDtcbiAgICAgICAgXG4gICAgICAgIC8vIFByb2dyZXNzXG4gICAgICAgIHMucHJvZ3Jlc3MgPSAwO1xuICAgICAgICBcbiAgICAgICAgLy8gVmVsb2NpdHlcbiAgICAgICAgcy52ZWxvY2l0eSA9IDA7XG4gICAgICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBMb2NrcywgdW5sb2Nrc1xuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMubG9ja1N3aXBlVG9OZXh0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcy5wYXJhbXMuYWxsb3dTd2lwZVRvTmV4dCA9IGZhbHNlO1xuICAgICAgICB9O1xuICAgICAgICBzLmxvY2tTd2lwZVRvUHJldiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHMucGFyYW1zLmFsbG93U3dpcGVUb1ByZXYgPSBmYWxzZTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5sb2NrU3dpcGVzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcy5wYXJhbXMuYWxsb3dTd2lwZVRvTmV4dCA9IHMucGFyYW1zLmFsbG93U3dpcGVUb1ByZXYgPSBmYWxzZTtcbiAgICAgICAgfTtcbiAgICAgICAgcy51bmxvY2tTd2lwZVRvTmV4dCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHMucGFyYW1zLmFsbG93U3dpcGVUb05leHQgPSB0cnVlO1xuICAgICAgICB9O1xuICAgICAgICBzLnVubG9ja1N3aXBlVG9QcmV2ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcy5wYXJhbXMuYWxsb3dTd2lwZVRvUHJldiA9IHRydWU7XG4gICAgICAgIH07XG4gICAgICAgIHMudW5sb2NrU3dpcGVzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcy5wYXJhbXMuYWxsb3dTd2lwZVRvTmV4dCA9IHMucGFyYW1zLmFsbG93U3dpcGVUb1ByZXYgPSB0cnVlO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgUm91bmQgaGVscGVyXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgZnVuY3Rpb24gcm91bmQoYSkge1xuICAgICAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IoYSk7XG4gICAgICAgIH1cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgU2V0IGdyYWIgY3Vyc29yXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgaWYgKHMucGFyYW1zLmdyYWJDdXJzb3IpIHtcbiAgICAgICAgICAgIHMuY29udGFpbmVyWzBdLnN0eWxlLmN1cnNvciA9ICdtb3ZlJztcbiAgICAgICAgICAgIHMuY29udGFpbmVyWzBdLnN0eWxlLmN1cnNvciA9ICctd2Via2l0LWdyYWInO1xuICAgICAgICAgICAgcy5jb250YWluZXJbMF0uc3R5bGUuY3Vyc29yID0gJy1tb3otZ3JhYic7XG4gICAgICAgICAgICBzLmNvbnRhaW5lclswXS5zdHlsZS5jdXJzb3IgPSAnZ3JhYic7XG4gICAgICAgIH1cbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgVXBkYXRlIG9uIEltYWdlcyBSZWFkeVxuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMuaW1hZ2VzVG9Mb2FkID0gW107XG4gICAgICAgIHMuaW1hZ2VzTG9hZGVkID0gMDtcbiAgICAgICAgXG4gICAgICAgIHMubG9hZEltYWdlID0gZnVuY3Rpb24gKGltZ0VsZW1lbnQsIHNyYywgc3Jjc2V0LCBjaGVja0ZvckNvbXBsZXRlLCBjYWxsYmFjaykge1xuICAgICAgICAgICAgdmFyIGltYWdlO1xuICAgICAgICAgICAgZnVuY3Rpb24gb25SZWFkeSAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjaygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFpbWdFbGVtZW50LmNvbXBsZXRlIHx8ICFjaGVja0ZvckNvbXBsZXRlKSB7XG4gICAgICAgICAgICAgICAgaWYgKHNyYykge1xuICAgICAgICAgICAgICAgICAgICBpbWFnZSA9IG5ldyB3aW5kb3cuSW1hZ2UoKTtcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2Uub25sb2FkID0gb25SZWFkeTtcbiAgICAgICAgICAgICAgICAgICAgaW1hZ2Uub25lcnJvciA9IG9uUmVhZHk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzcmNzZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLnNyY3NldCA9IHNyY3NldDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoc3JjKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpbWFnZS5zcmMgPSBzcmM7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBvblJlYWR5KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIH0gZWxzZSB7Ly9pbWFnZSBhbHJlYWR5IGxvYWRlZC4uLlxuICAgICAgICAgICAgICAgIG9uUmVhZHkoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgcy5wcmVsb2FkSW1hZ2VzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcy5pbWFnZXNUb0xvYWQgPSBzLmNvbnRhaW5lci5maW5kKCdpbWcnKTtcbiAgICAgICAgICAgIGZ1bmN0aW9uIF9vblJlYWR5KCkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcyA9PT0gJ3VuZGVmaW5lZCcgfHwgcyA9PT0gbnVsbCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmIChzLmltYWdlc0xvYWRlZCAhPT0gdW5kZWZpbmVkKSBzLmltYWdlc0xvYWRlZCsrO1xuICAgICAgICAgICAgICAgIGlmIChzLmltYWdlc0xvYWRlZCA9PT0gcy5pbWFnZXNUb0xvYWQubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy51cGRhdGVPbkltYWdlc1JlYWR5KSBzLnVwZGF0ZSgpO1xuICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uSW1hZ2VzUmVhZHknLCBzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHMuaW1hZ2VzVG9Mb2FkLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgcy5sb2FkSW1hZ2Uocy5pbWFnZXNUb0xvYWRbaV0sIChzLmltYWdlc1RvTG9hZFtpXS5jdXJyZW50U3JjIHx8IHMuaW1hZ2VzVG9Mb2FkW2ldLmdldEF0dHJpYnV0ZSgnc3JjJykpLCAocy5pbWFnZXNUb0xvYWRbaV0uc3Jjc2V0IHx8IHMuaW1hZ2VzVG9Mb2FkW2ldLmdldEF0dHJpYnV0ZSgnc3Jjc2V0JykpLCB0cnVlLCBfb25SZWFkeSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBBdXRvcGxheVxuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMuYXV0b3BsYXlUaW1lb3V0SWQgPSB1bmRlZmluZWQ7XG4gICAgICAgIHMuYXV0b3BsYXlpbmcgPSBmYWxzZTtcbiAgICAgICAgcy5hdXRvcGxheVBhdXNlZCA9IGZhbHNlO1xuICAgICAgICBmdW5jdGlvbiBhdXRvcGxheSgpIHtcbiAgICAgICAgICAgIHMuYXV0b3BsYXlUaW1lb3V0SWQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMubG9vcCkge1xuICAgICAgICAgICAgICAgICAgICBzLmZpeExvb3AoKTtcbiAgICAgICAgICAgICAgICAgICAgcy5fc2xpZGVOZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgIHMuZW1pdCgnb25BdXRvcGxheScsIHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFzLmlzRW5kKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLl9zbGlkZU5leHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuZW1pdCgnb25BdXRvcGxheScsIHMpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFwYXJhbXMuYXV0b3BsYXlTdG9wT25MYXN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5fc2xpZGVUbygwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uQXV0b3BsYXknLCBzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMuc3RvcEF1dG9wbGF5KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCBzLnBhcmFtcy5hdXRvcGxheSk7XG4gICAgICAgIH1cbiAgICAgICAgcy5zdGFydEF1dG9wbGF5ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBzLmF1dG9wbGF5VGltZW91dElkICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5hdXRvcGxheSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgaWYgKHMuYXV0b3BsYXlpbmcpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIHMuYXV0b3BsYXlpbmcgPSB0cnVlO1xuICAgICAgICAgICAgcy5lbWl0KCdvbkF1dG9wbGF5U3RhcnQnLCBzKTtcbiAgICAgICAgICAgIGF1dG9wbGF5KCk7XG4gICAgICAgIH07XG4gICAgICAgIHMuc3RvcEF1dG9wbGF5ID0gZnVuY3Rpb24gKGludGVybmFsKSB7XG4gICAgICAgICAgICBpZiAoIXMuYXV0b3BsYXlUaW1lb3V0SWQpIHJldHVybjtcbiAgICAgICAgICAgIGlmIChzLmF1dG9wbGF5VGltZW91dElkKSBjbGVhclRpbWVvdXQocy5hdXRvcGxheVRpbWVvdXRJZCk7XG4gICAgICAgICAgICBzLmF1dG9wbGF5aW5nID0gZmFsc2U7XG4gICAgICAgICAgICBzLmF1dG9wbGF5VGltZW91dElkID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgcy5lbWl0KCdvbkF1dG9wbGF5U3RvcCcsIHMpO1xuICAgICAgICB9O1xuICAgICAgICBzLnBhdXNlQXV0b3BsYXkgPSBmdW5jdGlvbiAoc3BlZWQpIHtcbiAgICAgICAgICAgIGlmIChzLmF1dG9wbGF5UGF1c2VkKSByZXR1cm47XG4gICAgICAgICAgICBpZiAocy5hdXRvcGxheVRpbWVvdXRJZCkgY2xlYXJUaW1lb3V0KHMuYXV0b3BsYXlUaW1lb3V0SWQpO1xuICAgICAgICAgICAgcy5hdXRvcGxheVBhdXNlZCA9IHRydWU7XG4gICAgICAgICAgICBpZiAoc3BlZWQgPT09IDApIHtcbiAgICAgICAgICAgICAgICBzLmF1dG9wbGF5UGF1c2VkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgYXV0b3BsYXkoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHMud3JhcHBlci50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFzKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIHMuYXV0b3BsYXlQYXVzZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFzLmF1dG9wbGF5aW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnN0b3BBdXRvcGxheSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXV0b3BsYXkoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBNaW4vTWF4IFRyYW5zbGF0ZVxuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMubWluVHJhbnNsYXRlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuICgtcy5zbmFwR3JpZFswXSk7XG4gICAgICAgIH07XG4gICAgICAgIHMubWF4VHJhbnNsYXRlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuICgtcy5zbmFwR3JpZFtzLnNuYXBHcmlkLmxlbmd0aCAtIDFdKTtcbiAgICAgICAgfTtcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgU2xpZGVyL3NsaWRlcyBzaXplc1xuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMudXBkYXRlQXV0b0hlaWdodCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIC8vIFVwZGF0ZSBIZWlnaHRcbiAgICAgICAgICAgIHZhciBzbGlkZSA9IHMuc2xpZGVzLmVxKHMuYWN0aXZlSW5kZXgpWzBdO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBzbGlkZSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICB2YXIgbmV3SGVpZ2h0ID0gc2xpZGUub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgICAgIGlmIChuZXdIZWlnaHQpIHMud3JhcHBlci5jc3MoJ2hlaWdodCcsIG5ld0hlaWdodCArICdweCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBzLnVwZGF0ZUNvbnRhaW5lclNpemUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgd2lkdGgsIGhlaWdodDtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygcy5wYXJhbXMud2lkdGggIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgd2lkdGggPSBzLnBhcmFtcy53aWR0aDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHdpZHRoID0gcy5jb250YWluZXJbMF0uY2xpZW50V2lkdGg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodHlwZW9mIHMucGFyYW1zLmhlaWdodCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICBoZWlnaHQgPSBzLnBhcmFtcy5oZWlnaHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBoZWlnaHQgPSBzLmNvbnRhaW5lclswXS5jbGllbnRIZWlnaHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAod2lkdGggPT09IDAgJiYgcy5pc0hvcml6b250YWwoKSB8fCBoZWlnaHQgPT09IDAgJiYgIXMuaXNIb3Jpem9udGFsKCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy9TdWJ0cmFjdCBwYWRkaW5nc1xuICAgICAgICAgICAgd2lkdGggPSB3aWR0aCAtIHBhcnNlSW50KHMuY29udGFpbmVyLmNzcygncGFkZGluZy1sZWZ0JyksIDEwKSAtIHBhcnNlSW50KHMuY29udGFpbmVyLmNzcygncGFkZGluZy1yaWdodCcpLCAxMCk7XG4gICAgICAgICAgICBoZWlnaHQgPSBoZWlnaHQgLSBwYXJzZUludChzLmNvbnRhaW5lci5jc3MoJ3BhZGRpbmctdG9wJyksIDEwKSAtIHBhcnNlSW50KHMuY29udGFpbmVyLmNzcygncGFkZGluZy1ib3R0b20nKSwgMTApO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFN0b3JlIHZhbHVlc1xuICAgICAgICAgICAgcy53aWR0aCA9IHdpZHRoO1xuICAgICAgICAgICAgcy5oZWlnaHQgPSBoZWlnaHQ7XG4gICAgICAgICAgICBzLnNpemUgPSBzLmlzSG9yaXpvbnRhbCgpID8gcy53aWR0aCA6IHMuaGVpZ2h0O1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgcy51cGRhdGVTbGlkZXNTaXplID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcy5zbGlkZXMgPSBzLndyYXBwZXIuY2hpbGRyZW4oJy4nICsgcy5wYXJhbXMuc2xpZGVDbGFzcyk7XG4gICAgICAgICAgICBzLnNuYXBHcmlkID0gW107XG4gICAgICAgICAgICBzLnNsaWRlc0dyaWQgPSBbXTtcbiAgICAgICAgICAgIHMuc2xpZGVzU2l6ZXNHcmlkID0gW107XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHNwYWNlQmV0d2VlbiA9IHMucGFyYW1zLnNwYWNlQmV0d2VlbixcbiAgICAgICAgICAgICAgICBzbGlkZVBvc2l0aW9uID0gLXMucGFyYW1zLnNsaWRlc09mZnNldEJlZm9yZSxcbiAgICAgICAgICAgICAgICBpLFxuICAgICAgICAgICAgICAgIHByZXZTbGlkZVNpemUgPSAwLFxuICAgICAgICAgICAgICAgIGluZGV4ID0gMDtcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygcy5zaXplID09PSAndW5kZWZpbmVkJykgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBzcGFjZUJldHdlZW4gPT09ICdzdHJpbmcnICYmIHNwYWNlQmV0d2Vlbi5pbmRleE9mKCclJykgPj0gMCkge1xuICAgICAgICAgICAgICAgIHNwYWNlQmV0d2VlbiA9IHBhcnNlRmxvYXQoc3BhY2VCZXR3ZWVuLnJlcGxhY2UoJyUnLCAnJykpIC8gMTAwICogcy5zaXplO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIHMudmlydHVhbFNpemUgPSAtc3BhY2VCZXR3ZWVuO1xuICAgICAgICAgICAgLy8gcmVzZXQgbWFyZ2luc1xuICAgICAgICAgICAgaWYgKHMucnRsKSBzLnNsaWRlcy5jc3Moe21hcmdpbkxlZnQ6ICcnLCBtYXJnaW5Ub3A6ICcnfSk7XG4gICAgICAgICAgICBlbHNlIHMuc2xpZGVzLmNzcyh7bWFyZ2luUmlnaHQ6ICcnLCBtYXJnaW5Cb3R0b206ICcnfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIHNsaWRlc051bWJlckV2ZW5Ub1Jvd3M7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuc2xpZGVzUGVyQ29sdW1uID4gMSkge1xuICAgICAgICAgICAgICAgIGlmIChNYXRoLmZsb29yKHMuc2xpZGVzLmxlbmd0aCAvIHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbikgPT09IHMuc2xpZGVzLmxlbmd0aCAvIHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbikge1xuICAgICAgICAgICAgICAgICAgICBzbGlkZXNOdW1iZXJFdmVuVG9Sb3dzID0gcy5zbGlkZXMubGVuZ3RoO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc2xpZGVzTnVtYmVyRXZlblRvUm93cyA9IE1hdGguY2VpbChzLnNsaWRlcy5sZW5ndGggLyBzLnBhcmFtcy5zbGlkZXNQZXJDb2x1bW4pICogcy5wYXJhbXMuc2xpZGVzUGVyQ29sdW1uO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuc2xpZGVzUGVyVmlldyAhPT0gJ2F1dG8nICYmIHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbkZpbGwgPT09ICdyb3cnKSB7XG4gICAgICAgICAgICAgICAgICAgIHNsaWRlc051bWJlckV2ZW5Ub1Jvd3MgPSBNYXRoLm1heChzbGlkZXNOdW1iZXJFdmVuVG9Sb3dzLCBzLnBhcmFtcy5zbGlkZXNQZXJWaWV3ICogcy5wYXJhbXMuc2xpZGVzUGVyQ29sdW1uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQ2FsYyBzbGlkZXNcbiAgICAgICAgICAgIHZhciBzbGlkZVNpemU7XG4gICAgICAgICAgICB2YXIgc2xpZGVzUGVyQ29sdW1uID0gcy5wYXJhbXMuc2xpZGVzUGVyQ29sdW1uO1xuICAgICAgICAgICAgdmFyIHNsaWRlc1BlclJvdyA9IHNsaWRlc051bWJlckV2ZW5Ub1Jvd3MgLyBzbGlkZXNQZXJDb2x1bW47XG4gICAgICAgICAgICB2YXIgbnVtRnVsbENvbHVtbnMgPSBzbGlkZXNQZXJSb3cgLSAocy5wYXJhbXMuc2xpZGVzUGVyQ29sdW1uICogc2xpZGVzUGVyUm93IC0gcy5zbGlkZXMubGVuZ3RoKTtcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBzLnNsaWRlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHNsaWRlU2l6ZSA9IDA7XG4gICAgICAgICAgICAgICAgdmFyIHNsaWRlID0gcy5zbGlkZXMuZXEoaSk7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNsaWRlc1BlckNvbHVtbiA+IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gU2V0IHNsaWRlcyBvcmRlclxuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3U2xpZGVPcmRlckluZGV4O1xuICAgICAgICAgICAgICAgICAgICB2YXIgY29sdW1uLCByb3c7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zbGlkZXNQZXJDb2x1bW5GaWxsID09PSAnY29sdW1uJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sdW1uID0gTWF0aC5mbG9vcihpIC8gc2xpZGVzUGVyQ29sdW1uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvdyA9IGkgLSBjb2x1bW4gKiBzbGlkZXNQZXJDb2x1bW47XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sdW1uID4gbnVtRnVsbENvbHVtbnMgfHwgKGNvbHVtbiA9PT0gbnVtRnVsbENvbHVtbnMgJiYgcm93ID09PSBzbGlkZXNQZXJDb2x1bW4tMSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKytyb3cgPj0gc2xpZGVzUGVyQ29sdW1uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvdyA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbisrO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1NsaWRlT3JkZXJJbmRleCA9IGNvbHVtbiArIHJvdyAqIHNsaWRlc051bWJlckV2ZW5Ub1Jvd3MgLyBzbGlkZXNQZXJDb2x1bW47XG4gICAgICAgICAgICAgICAgICAgICAgICBzbGlkZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnLXdlYmtpdC1ib3gtb3JkaW5hbC1ncm91cCc6IG5ld1NsaWRlT3JkZXJJbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJy1tb3otYm94LW9yZGluYWwtZ3JvdXAnOiBuZXdTbGlkZU9yZGVySW5kZXgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICctbXMtZmxleC1vcmRlcic6IG5ld1NsaWRlT3JkZXJJbmRleCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJy13ZWJraXQtb3JkZXInOiBuZXdTbGlkZU9yZGVySW5kZXgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdvcmRlcic6IG5ld1NsaWRlT3JkZXJJbmRleFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcm93ID0gTWF0aC5mbG9vcihpIC8gc2xpZGVzUGVyUm93KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbiA9IGkgLSByb3cgKiBzbGlkZXNQZXJSb3c7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgc2xpZGVcbiAgICAgICAgICAgICAgICAgICAgICAgIC5jc3Moe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtYXJnaW4tdG9wJzogKHJvdyAhPT0gMCAmJiBzLnBhcmFtcy5zcGFjZUJldHdlZW4pICYmIChzLnBhcmFtcy5zcGFjZUJldHdlZW4gKyAncHgnKVxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC5hdHRyKCdkYXRhLXN3aXBlci1jb2x1bW4nLCBjb2x1bW4pXG4gICAgICAgICAgICAgICAgICAgICAgICAuYXR0cignZGF0YS1zd2lwZXItcm93Jywgcm93KTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzbGlkZS5jc3MoJ2Rpc3BsYXknKSA9PT0gJ25vbmUnKSBjb250aW51ZTtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuc2xpZGVzUGVyVmlldyA9PT0gJ2F1dG8nKSB7XG4gICAgICAgICAgICAgICAgICAgIHNsaWRlU2l6ZSA9IHMuaXNIb3Jpem9udGFsKCkgPyBzbGlkZS5vdXRlcldpZHRoKHRydWUpIDogc2xpZGUub3V0ZXJIZWlnaHQodHJ1ZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5yb3VuZExlbmd0aHMpIHNsaWRlU2l6ZSA9IHJvdW5kKHNsaWRlU2l6ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzbGlkZVNpemUgPSAocy5zaXplIC0gKHMucGFyYW1zLnNsaWRlc1BlclZpZXcgLSAxKSAqIHNwYWNlQmV0d2VlbikgLyBzLnBhcmFtcy5zbGlkZXNQZXJWaWV3O1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucm91bmRMZW5ndGhzKSBzbGlkZVNpemUgPSByb3VuZChzbGlkZVNpemUpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuaXNIb3Jpem9udGFsKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuc2xpZGVzW2ldLnN0eWxlLndpZHRoID0gc2xpZGVTaXplICsgJ3B4JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuc2xpZGVzW2ldLnN0eWxlLmhlaWdodCA9IHNsaWRlU2l6ZSArICdweCc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcy5zbGlkZXNbaV0uc3dpcGVyU2xpZGVTaXplID0gc2xpZGVTaXplO1xuICAgICAgICAgICAgICAgIHMuc2xpZGVzU2l6ZXNHcmlkLnB1c2goc2xpZGVTaXplKTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5jZW50ZXJlZFNsaWRlcykge1xuICAgICAgICAgICAgICAgICAgICBzbGlkZVBvc2l0aW9uID0gc2xpZGVQb3NpdGlvbiArIHNsaWRlU2l6ZSAvIDIgKyBwcmV2U2xpZGVTaXplIC8gMiArIHNwYWNlQmV0d2VlbjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGkgPT09IDApIHNsaWRlUG9zaXRpb24gPSBzbGlkZVBvc2l0aW9uIC0gcy5zaXplIC8gMiAtIHNwYWNlQmV0d2VlbjtcbiAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHNsaWRlUG9zaXRpb24pIDwgMSAvIDEwMDApIHNsaWRlUG9zaXRpb24gPSAwO1xuICAgICAgICAgICAgICAgICAgICBpZiAoKGluZGV4KSAlIHMucGFyYW1zLnNsaWRlc1Blckdyb3VwID09PSAwKSBzLnNuYXBHcmlkLnB1c2goc2xpZGVQb3NpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIHMuc2xpZGVzR3JpZC5wdXNoKHNsaWRlUG9zaXRpb24pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKChpbmRleCkgJSBzLnBhcmFtcy5zbGlkZXNQZXJHcm91cCA9PT0gMCkgcy5zbmFwR3JpZC5wdXNoKHNsaWRlUG9zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICBzLnNsaWRlc0dyaWQucHVzaChzbGlkZVBvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgc2xpZGVQb3NpdGlvbiA9IHNsaWRlUG9zaXRpb24gKyBzbGlkZVNpemUgKyBzcGFjZUJldHdlZW47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBzLnZpcnR1YWxTaXplICs9IHNsaWRlU2l6ZSArIHNwYWNlQmV0d2VlbjtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgcHJldlNsaWRlU2l6ZSA9IHNsaWRlU2l6ZTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaW5kZXggKys7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzLnZpcnR1YWxTaXplID0gTWF0aC5tYXgocy52aXJ0dWFsU2l6ZSwgcy5zaXplKSArIHMucGFyYW1zLnNsaWRlc09mZnNldEFmdGVyO1xuICAgICAgICAgICAgdmFyIG5ld1NsaWRlc0dyaWQ7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIHMucnRsICYmIHMud3JvbmdSVEwgJiYgKHMucGFyYW1zLmVmZmVjdCA9PT0gJ3NsaWRlJyB8fCBzLnBhcmFtcy5lZmZlY3QgPT09ICdjb3ZlcmZsb3cnKSkge1xuICAgICAgICAgICAgICAgIHMud3JhcHBlci5jc3Moe3dpZHRoOiBzLnZpcnR1YWxTaXplICsgcy5wYXJhbXMuc3BhY2VCZXR3ZWVuICsgJ3B4J30pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFzLnN1cHBvcnQuZmxleGJveCB8fCBzLnBhcmFtcy5zZXRXcmFwcGVyU2l6ZSkge1xuICAgICAgICAgICAgICAgIGlmIChzLmlzSG9yaXpvbnRhbCgpKSBzLndyYXBwZXIuY3NzKHt3aWR0aDogcy52aXJ0dWFsU2l6ZSArIHMucGFyYW1zLnNwYWNlQmV0d2VlbiArICdweCd9KTtcbiAgICAgICAgICAgICAgICBlbHNlIHMud3JhcHBlci5jc3Moe2hlaWdodDogcy52aXJ0dWFsU2l6ZSArIHMucGFyYW1zLnNwYWNlQmV0d2VlbiArICdweCd9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuc2xpZGVzUGVyQ29sdW1uID4gMSkge1xuICAgICAgICAgICAgICAgIHMudmlydHVhbFNpemUgPSAoc2xpZGVTaXplICsgcy5wYXJhbXMuc3BhY2VCZXR3ZWVuKSAqIHNsaWRlc051bWJlckV2ZW5Ub1Jvd3M7XG4gICAgICAgICAgICAgICAgcy52aXJ0dWFsU2l6ZSA9IE1hdGguY2VpbChzLnZpcnR1YWxTaXplIC8gcy5wYXJhbXMuc2xpZGVzUGVyQ29sdW1uKSAtIHMucGFyYW1zLnNwYWNlQmV0d2VlbjtcbiAgICAgICAgICAgICAgICBzLndyYXBwZXIuY3NzKHt3aWR0aDogcy52aXJ0dWFsU2l6ZSArIHMucGFyYW1zLnNwYWNlQmV0d2VlbiArICdweCd9KTtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuY2VudGVyZWRTbGlkZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgbmV3U2xpZGVzR3JpZCA9IFtdO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcy5zbmFwR3JpZC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMuc25hcEdyaWRbaV0gPCBzLnZpcnR1YWxTaXplICsgcy5zbmFwR3JpZFswXSkgbmV3U2xpZGVzR3JpZC5wdXNoKHMuc25hcEdyaWRbaV0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHMuc25hcEdyaWQgPSBuZXdTbGlkZXNHcmlkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBSZW1vdmUgbGFzdCBncmlkIGVsZW1lbnRzIGRlcGVuZGluZyBvbiB3aWR0aFxuICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5jZW50ZXJlZFNsaWRlcykge1xuICAgICAgICAgICAgICAgIG5ld1NsaWRlc0dyaWQgPSBbXTtcbiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcy5zbmFwR3JpZC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5zbmFwR3JpZFtpXSA8PSBzLnZpcnR1YWxTaXplIC0gcy5zaXplKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdTbGlkZXNHcmlkLnB1c2gocy5zbmFwR3JpZFtpXSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcy5zbmFwR3JpZCA9IG5ld1NsaWRlc0dyaWQ7XG4gICAgICAgICAgICAgICAgaWYgKE1hdGguZmxvb3Iocy52aXJ0dWFsU2l6ZSAtIHMuc2l6ZSkgLSBNYXRoLmZsb29yKHMuc25hcEdyaWRbcy5zbmFwR3JpZC5sZW5ndGggLSAxXSkgPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuc25hcEdyaWQucHVzaChzLnZpcnR1YWxTaXplIC0gcy5zaXplKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5zbmFwR3JpZC5sZW5ndGggPT09IDApIHMuc25hcEdyaWQgPSBbMF07XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNwYWNlQmV0d2VlbiAhPT0gMCkge1xuICAgICAgICAgICAgICAgIGlmIChzLmlzSG9yaXpvbnRhbCgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnJ0bCkgcy5zbGlkZXMuY3NzKHttYXJnaW5MZWZ0OiBzcGFjZUJldHdlZW4gKyAncHgnfSk7XG4gICAgICAgICAgICAgICAgICAgIGVsc2Ugcy5zbGlkZXMuY3NzKHttYXJnaW5SaWdodDogc3BhY2VCZXR3ZWVuICsgJ3B4J30pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHMuc2xpZGVzLmNzcyh7bWFyZ2luQm90dG9tOiBzcGFjZUJldHdlZW4gKyAncHgnfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMud2F0Y2hTbGlkZXNQcm9ncmVzcykge1xuICAgICAgICAgICAgICAgIHMudXBkYXRlU2xpZGVzT2Zmc2V0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHMudXBkYXRlU2xpZGVzT2Zmc2V0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzLnNsaWRlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHMuc2xpZGVzW2ldLnN3aXBlclNsaWRlT2Zmc2V0ID0gcy5pc0hvcml6b250YWwoKSA/IHMuc2xpZGVzW2ldLm9mZnNldExlZnQgOiBzLnNsaWRlc1tpXS5vZmZzZXRUb3A7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBTbGlkZXIvc2xpZGVzIHByb2dyZXNzXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgcy51cGRhdGVTbGlkZXNQcm9ncmVzcyA9IGZ1bmN0aW9uICh0cmFuc2xhdGUpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdHJhbnNsYXRlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIHRyYW5zbGF0ZSA9IHMudHJhbnNsYXRlIHx8IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5zbGlkZXMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgICAgICBpZiAodHlwZW9mIHMuc2xpZGVzWzBdLnN3aXBlclNsaWRlT2Zmc2V0ID09PSAndW5kZWZpbmVkJykgcy51cGRhdGVTbGlkZXNPZmZzZXQoKTtcbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgb2Zmc2V0Q2VudGVyID0gLXRyYW5zbGF0ZTtcbiAgICAgICAgICAgIGlmIChzLnJ0bCkgb2Zmc2V0Q2VudGVyID0gdHJhbnNsYXRlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFZpc2libGUgU2xpZGVzXG4gICAgICAgICAgICBzLnNsaWRlcy5yZW1vdmVDbGFzcyhzLnBhcmFtcy5zbGlkZVZpc2libGVDbGFzcyk7XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHMuc2xpZGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNsaWRlID0gcy5zbGlkZXNbaV07XG4gICAgICAgICAgICAgICAgdmFyIHNsaWRlUHJvZ3Jlc3MgPSAob2Zmc2V0Q2VudGVyIC0gc2xpZGUuc3dpcGVyU2xpZGVPZmZzZXQpIC8gKHNsaWRlLnN3aXBlclNsaWRlU2l6ZSArIHMucGFyYW1zLnNwYWNlQmV0d2Vlbik7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLndhdGNoU2xpZGVzVmlzaWJpbGl0eSkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGVCZWZvcmUgPSAtKG9mZnNldENlbnRlciAtIHNsaWRlLnN3aXBlclNsaWRlT2Zmc2V0KTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRlQWZ0ZXIgPSBzbGlkZUJlZm9yZSArIHMuc2xpZGVzU2l6ZXNHcmlkW2ldO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaXNWaXNpYmxlID1cbiAgICAgICAgICAgICAgICAgICAgICAgIChzbGlkZUJlZm9yZSA+PSAwICYmIHNsaWRlQmVmb3JlIDwgcy5zaXplKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgKHNsaWRlQWZ0ZXIgPiAwICYmIHNsaWRlQWZ0ZXIgPD0gcy5zaXplKSB8fFxuICAgICAgICAgICAgICAgICAgICAgICAgKHNsaWRlQmVmb3JlIDw9IDAgJiYgc2xpZGVBZnRlciA+PSBzLnNpemUpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoaXNWaXNpYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnNsaWRlcy5lcShpKS5hZGRDbGFzcyhzLnBhcmFtcy5zbGlkZVZpc2libGVDbGFzcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc2xpZGUucHJvZ3Jlc3MgPSBzLnJ0bCA/IC1zbGlkZVByb2dyZXNzIDogc2xpZGVQcm9ncmVzcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgcy51cGRhdGVQcm9ncmVzcyA9IGZ1bmN0aW9uICh0cmFuc2xhdGUpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdHJhbnNsYXRlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIHRyYW5zbGF0ZSA9IHMudHJhbnNsYXRlIHx8IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgdHJhbnNsYXRlc0RpZmYgPSBzLm1heFRyYW5zbGF0ZSgpIC0gcy5taW5UcmFuc2xhdGUoKTtcbiAgICAgICAgICAgIHZhciB3YXNCZWdpbm5pbmcgPSBzLmlzQmVnaW5uaW5nO1xuICAgICAgICAgICAgdmFyIHdhc0VuZCA9IHMuaXNFbmQ7XG4gICAgICAgICAgICBpZiAodHJhbnNsYXRlc0RpZmYgPT09IDApIHtcbiAgICAgICAgICAgICAgICBzLnByb2dyZXNzID0gMDtcbiAgICAgICAgICAgICAgICBzLmlzQmVnaW5uaW5nID0gcy5pc0VuZCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzLnByb2dyZXNzID0gKHRyYW5zbGF0ZSAtIHMubWluVHJhbnNsYXRlKCkpIC8gKHRyYW5zbGF0ZXNEaWZmKTtcbiAgICAgICAgICAgICAgICBzLmlzQmVnaW5uaW5nID0gcy5wcm9ncmVzcyA8PSAwO1xuICAgICAgICAgICAgICAgIHMuaXNFbmQgPSBzLnByb2dyZXNzID49IDE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5pc0JlZ2lubmluZyAmJiAhd2FzQmVnaW5uaW5nKSBzLmVtaXQoJ29uUmVhY2hCZWdpbm5pbmcnLCBzKTtcbiAgICAgICAgICAgIGlmIChzLmlzRW5kICYmICF3YXNFbmQpIHMuZW1pdCgnb25SZWFjaEVuZCcsIHMpO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy53YXRjaFNsaWRlc1Byb2dyZXNzKSBzLnVwZGF0ZVNsaWRlc1Byb2dyZXNzKHRyYW5zbGF0ZSk7XG4gICAgICAgICAgICBzLmVtaXQoJ29uUHJvZ3Jlc3MnLCBzLCBzLnByb2dyZXNzKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy51cGRhdGVBY3RpdmVJbmRleCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciB0cmFuc2xhdGUgPSBzLnJ0bCA/IHMudHJhbnNsYXRlIDogLXMudHJhbnNsYXRlO1xuICAgICAgICAgICAgdmFyIG5ld0FjdGl2ZUluZGV4LCBpLCBzbmFwSW5kZXg7XG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcy5zbGlkZXNHcmlkLmxlbmd0aDsgaSArKykge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygcy5zbGlkZXNHcmlkW2kgKyAxXSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRyYW5zbGF0ZSA+PSBzLnNsaWRlc0dyaWRbaV0gJiYgdHJhbnNsYXRlIDwgcy5zbGlkZXNHcmlkW2kgKyAxXSAtIChzLnNsaWRlc0dyaWRbaSArIDFdIC0gcy5zbGlkZXNHcmlkW2ldKSAvIDIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0FjdGl2ZUluZGV4ID0gaTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0cmFuc2xhdGUgPj0gcy5zbGlkZXNHcmlkW2ldICYmIHRyYW5zbGF0ZSA8IHMuc2xpZGVzR3JpZFtpICsgMV0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld0FjdGl2ZUluZGV4ID0gaSArIDE7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0cmFuc2xhdGUgPj0gcy5zbGlkZXNHcmlkW2ldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdBY3RpdmVJbmRleCA9IGk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBOb3JtYWxpemUgc2xpZGVJbmRleFxuICAgICAgICAgICAgaWYgKG5ld0FjdGl2ZUluZGV4IDwgMCB8fCB0eXBlb2YgbmV3QWN0aXZlSW5kZXggPT09ICd1bmRlZmluZWQnKSBuZXdBY3RpdmVJbmRleCA9IDA7XG4gICAgICAgICAgICAvLyBmb3IgKGkgPSAwOyBpIDwgcy5zbGlkZXNHcmlkLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgLy8gaWYgKC0gdHJhbnNsYXRlID49IHMuc2xpZGVzR3JpZFtpXSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBuZXdBY3RpdmVJbmRleCA9IGk7XG4gICAgICAgICAgICAgICAgLy8gfVxuICAgICAgICAgICAgLy8gfVxuICAgICAgICAgICAgc25hcEluZGV4ID0gTWF0aC5mbG9vcihuZXdBY3RpdmVJbmRleCAvIHMucGFyYW1zLnNsaWRlc1Blckdyb3VwKTtcbiAgICAgICAgICAgIGlmIChzbmFwSW5kZXggPj0gcy5zbmFwR3JpZC5sZW5ndGgpIHNuYXBJbmRleCA9IHMuc25hcEdyaWQubGVuZ3RoIC0gMTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAobmV3QWN0aXZlSW5kZXggPT09IHMuYWN0aXZlSW5kZXgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzLnNuYXBJbmRleCA9IHNuYXBJbmRleDtcbiAgICAgICAgICAgIHMucHJldmlvdXNJbmRleCA9IHMuYWN0aXZlSW5kZXg7XG4gICAgICAgICAgICBzLmFjdGl2ZUluZGV4ID0gbmV3QWN0aXZlSW5kZXg7XG4gICAgICAgICAgICBzLnVwZGF0ZUNsYXNzZXMoKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIENsYXNzZXNcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLnVwZGF0ZUNsYXNzZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBzLnNsaWRlcy5yZW1vdmVDbGFzcyhzLnBhcmFtcy5zbGlkZUFjdGl2ZUNsYXNzICsgJyAnICsgcy5wYXJhbXMuc2xpZGVOZXh0Q2xhc3MgKyAnICcgKyBzLnBhcmFtcy5zbGlkZVByZXZDbGFzcyk7XG4gICAgICAgICAgICB2YXIgYWN0aXZlU2xpZGUgPSBzLnNsaWRlcy5lcShzLmFjdGl2ZUluZGV4KTtcbiAgICAgICAgICAgIC8vIEFjdGl2ZSBjbGFzc2VzXG4gICAgICAgICAgICBhY3RpdmVTbGlkZS5hZGRDbGFzcyhzLnBhcmFtcy5zbGlkZUFjdGl2ZUNsYXNzKTtcbiAgICAgICAgICAgIC8vIE5leHQgU2xpZGVcbiAgICAgICAgICAgIHZhciBuZXh0U2xpZGUgPSBhY3RpdmVTbGlkZS5uZXh0KCcuJyArIHMucGFyYW1zLnNsaWRlQ2xhc3MpLmFkZENsYXNzKHMucGFyYW1zLnNsaWRlTmV4dENsYXNzKTtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5sb29wICYmIG5leHRTbGlkZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICBzLnNsaWRlcy5lcSgwKS5hZGRDbGFzcyhzLnBhcmFtcy5zbGlkZU5leHRDbGFzcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBQcmV2IFNsaWRlXG4gICAgICAgICAgICB2YXIgcHJldlNsaWRlID0gYWN0aXZlU2xpZGUucHJldignLicgKyBzLnBhcmFtcy5zbGlkZUNsYXNzKS5hZGRDbGFzcyhzLnBhcmFtcy5zbGlkZVByZXZDbGFzcyk7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMubG9vcCAmJiBwcmV2U2xpZGUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcy5zbGlkZXMuZXEoLTEpLmFkZENsYXNzKHMucGFyYW1zLnNsaWRlUHJldkNsYXNzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBQYWdpbmF0aW9uXG4gICAgICAgICAgICBpZiAocy5wYWdpbmF0aW9uQ29udGFpbmVyICYmIHMucGFnaW5hdGlvbkNvbnRhaW5lci5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgLy8gQ3VycmVudC9Ub3RhbFxuICAgICAgICAgICAgICAgIHZhciBjdXJyZW50LFxuICAgICAgICAgICAgICAgICAgICB0b3RhbCA9IHMucGFyYW1zLmxvb3AgPyBNYXRoLmNlaWwoKHMuc2xpZGVzLmxlbmd0aCAtIHMubG9vcGVkU2xpZGVzICogMikgLyBzLnBhcmFtcy5zbGlkZXNQZXJHcm91cCkgOiBzLnNuYXBHcmlkLmxlbmd0aDtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMubG9vcCkge1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gTWF0aC5jZWlsKChzLmFjdGl2ZUluZGV4IC0gcy5sb29wZWRTbGlkZXMpL3MucGFyYW1zLnNsaWRlc1Blckdyb3VwKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnQgPiBzLnNsaWRlcy5sZW5ndGggLSAxIC0gcy5sb29wZWRTbGlkZXMgKiAyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gY3VycmVudCAtIChzLnNsaWRlcy5sZW5ndGggLSBzLmxvb3BlZFNsaWRlcyAqIDIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50ID4gdG90YWwgLSAxKSBjdXJyZW50ID0gY3VycmVudCAtIHRvdGFsO1xuICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudCA8IDAgJiYgcy5wYXJhbXMucGFnaW5hdGlvblR5cGUgIT09ICdidWxsZXRzJykgY3VycmVudCA9IHRvdGFsICsgY3VycmVudDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygcy5zbmFwSW5kZXggIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gcy5zbmFwSW5kZXg7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50ID0gcy5hY3RpdmVJbmRleCB8fCAwO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIFR5cGVzXG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnBhZ2luYXRpb25UeXBlID09PSAnYnVsbGV0cycgJiYgcy5idWxsZXRzICYmIHMuYnVsbGV0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuYnVsbGV0cy5yZW1vdmVDbGFzcyhzLnBhcmFtcy5idWxsZXRBY3RpdmVDbGFzcyk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhZ2luYXRpb25Db250YWluZXIubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5idWxsZXRzLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkKHRoaXMpLmluZGV4KCkgPT09IGN1cnJlbnQpICQodGhpcykuYWRkQ2xhc3Mocy5wYXJhbXMuYnVsbGV0QWN0aXZlQ2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmJ1bGxldHMuZXEoY3VycmVudCkuYWRkQ2xhc3Mocy5wYXJhbXMuYnVsbGV0QWN0aXZlQ2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wYWdpbmF0aW9uVHlwZSA9PT0gJ2ZyYWN0aW9uJykge1xuICAgICAgICAgICAgICAgICAgICBzLnBhZ2luYXRpb25Db250YWluZXIuZmluZCgnLicgKyBzLnBhcmFtcy5wYWdpbmF0aW9uQ3VycmVudENsYXNzKS50ZXh0KGN1cnJlbnQgKyAxKTtcbiAgICAgICAgICAgICAgICAgICAgcy5wYWdpbmF0aW9uQ29udGFpbmVyLmZpbmQoJy4nICsgcy5wYXJhbXMucGFnaW5hdGlvblRvdGFsQ2xhc3MpLnRleHQodG90YWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucGFnaW5hdGlvblR5cGUgPT09ICdwcm9ncmVzcycpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNjYWxlID0gKGN1cnJlbnQgKyAxKSAvIHRvdGFsLFxuICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGVYID0gc2NhbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBzY2FsZVkgPSAxO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXMuaXNIb3Jpem9udGFsKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlWSA9IHNjYWxlO1xuICAgICAgICAgICAgICAgICAgICAgICAgc2NhbGVYID0gMTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzLnBhZ2luYXRpb25Db250YWluZXIuZmluZCgnLicgKyBzLnBhcmFtcy5wYWdpbmF0aW9uUHJvZ3Jlc3NiYXJDbGFzcykudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwLDAsMCkgc2NhbGVYKCcgKyBzY2FsZVggKyAnKSBzY2FsZVkoJyArIHNjYWxlWSArICcpJykudHJhbnNpdGlvbihzLnBhcmFtcy5zcGVlZCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wYWdpbmF0aW9uVHlwZSA9PT0gJ2N1c3RvbScgJiYgcy5wYXJhbXMucGFnaW5hdGlvbkN1c3RvbVJlbmRlcikge1xuICAgICAgICAgICAgICAgICAgICBzLnBhZ2luYXRpb25Db250YWluZXIuaHRtbChzLnBhcmFtcy5wYWdpbmF0aW9uQ3VzdG9tUmVuZGVyKHMsIGN1cnJlbnQgKyAxLCB0b3RhbCkpO1xuICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uUGFnaW5hdGlvblJlbmRlcmVkJywgcywgcy5wYWdpbmF0aW9uQ29udGFpbmVyWzBdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gTmV4dC9hY3RpdmUgYnV0dG9uc1xuICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5sb29wKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnByZXZCdXR0b24gJiYgcy5wcmV2QnV0dG9uICYmIHMucHJldkJ1dHRvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLmlzQmVnaW5uaW5nKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnByZXZCdXR0b24uYWRkQ2xhc3Mocy5wYXJhbXMuYnV0dG9uRGlzYWJsZWRDbGFzcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuYTExeSAmJiBzLmExMXkpIHMuYTExeS5kaXNhYmxlKHMucHJldkJ1dHRvbik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnByZXZCdXR0b24ucmVtb3ZlQ2xhc3Mocy5wYXJhbXMuYnV0dG9uRGlzYWJsZWRDbGFzcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuYTExeSAmJiBzLmExMXkpIHMuYTExeS5lbmFibGUocy5wcmV2QnV0dG9uKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMubmV4dEJ1dHRvbiAmJiBzLm5leHRCdXR0b24gJiYgcy5uZXh0QnV0dG9uLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuaXNFbmQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMubmV4dEJ1dHRvbi5hZGRDbGFzcyhzLnBhcmFtcy5idXR0b25EaXNhYmxlZENsYXNzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5hMTF5ICYmIHMuYTExeSkgcy5hMTF5LmRpc2FibGUocy5uZXh0QnV0dG9uKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMubmV4dEJ1dHRvbi5yZW1vdmVDbGFzcyhzLnBhcmFtcy5idXR0b25EaXNhYmxlZENsYXNzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5hMTF5ICYmIHMuYTExeSkgcy5hMTF5LmVuYWJsZShzLm5leHRCdXR0b24pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgUGFnaW5hdGlvblxuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMudXBkYXRlUGFnaW5hdGlvbiA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICghcy5wYXJhbXMucGFnaW5hdGlvbikgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKHMucGFnaW5hdGlvbkNvbnRhaW5lciAmJiBzLnBhZ2luYXRpb25Db250YWluZXIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIHZhciBwYWdpbmF0aW9uSFRNTCA9ICcnO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wYWdpbmF0aW9uVHlwZSA9PT0gJ2J1bGxldHMnKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBudW1iZXJPZkJ1bGxldHMgPSBzLnBhcmFtcy5sb29wID8gTWF0aC5jZWlsKChzLnNsaWRlcy5sZW5ndGggLSBzLmxvb3BlZFNsaWRlcyAqIDIpIC8gcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXApIDogcy5zbmFwR3JpZC5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtYmVyT2ZCdWxsZXRzOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wYWdpbmF0aW9uQnVsbGV0UmVuZGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFnaW5hdGlvbkhUTUwgKz0gcy5wYXJhbXMucGFnaW5hdGlvbkJ1bGxldFJlbmRlcihpLCBzLnBhcmFtcy5idWxsZXRDbGFzcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYWdpbmF0aW9uSFRNTCArPSAnPCcgKyBzLnBhcmFtcy5wYWdpbmF0aW9uRWxlbWVudCsnIGNsYXNzPVwiJyArIHMucGFyYW1zLmJ1bGxldENsYXNzICsgJ1wiPjwvJyArIHMucGFyYW1zLnBhZ2luYXRpb25FbGVtZW50ICsgJz4nO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHMucGFnaW5hdGlvbkNvbnRhaW5lci5odG1sKHBhZ2luYXRpb25IVE1MKTtcbiAgICAgICAgICAgICAgICAgICAgcy5idWxsZXRzID0gcy5wYWdpbmF0aW9uQ29udGFpbmVyLmZpbmQoJy4nICsgcy5wYXJhbXMuYnVsbGV0Q2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucGFnaW5hdGlvbkNsaWNrYWJsZSAmJiBzLnBhcmFtcy5hMTF5ICYmIHMuYTExeSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5hMTF5LmluaXRQYWdpbmF0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnBhZ2luYXRpb25UeXBlID09PSAnZnJhY3Rpb24nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wYWdpbmF0aW9uRnJhY3Rpb25SZW5kZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2luYXRpb25IVE1MID0gcy5wYXJhbXMucGFnaW5hdGlvbkZyYWN0aW9uUmVuZGVyKHMsIHMucGFyYW1zLnBhZ2luYXRpb25DdXJyZW50Q2xhc3MsIHMucGFyYW1zLnBhZ2luYXRpb25Ub3RhbENsYXNzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2luYXRpb25IVE1MID1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnPHNwYW4gY2xhc3M9XCInICsgcy5wYXJhbXMucGFnaW5hdGlvbkN1cnJlbnRDbGFzcyArICdcIj48L3NwYW4+JyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJyAvICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICc8c3BhbiBjbGFzcz1cIicgKyBzLnBhcmFtcy5wYWdpbmF0aW9uVG90YWxDbGFzcysnXCI+PC9zcGFuPic7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcy5wYWdpbmF0aW9uQ29udGFpbmVyLmh0bWwocGFnaW5hdGlvbkhUTUwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucGFnaW5hdGlvblR5cGUgPT09ICdwcm9ncmVzcycpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnBhZ2luYXRpb25Qcm9ncmVzc1JlbmRlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFnaW5hdGlvbkhUTUwgPSBzLnBhcmFtcy5wYWdpbmF0aW9uUHJvZ3Jlc3NSZW5kZXIocywgcy5wYXJhbXMucGFnaW5hdGlvblByb2dyZXNzYmFyQ2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcGFnaW5hdGlvbkhUTUwgPSAnPHNwYW4gY2xhc3M9XCInICsgcy5wYXJhbXMucGFnaW5hdGlvblByb2dyZXNzYmFyQ2xhc3MgKyAnXCI+PC9zcGFuPic7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcy5wYWdpbmF0aW9uQ29udGFpbmVyLmh0bWwocGFnaW5hdGlvbkhUTUwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucGFnaW5hdGlvblR5cGUgIT09ICdjdXN0b20nKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuZW1pdCgnb25QYWdpbmF0aW9uUmVuZGVyZWQnLCBzLCBzLnBhZ2luYXRpb25Db250YWluZXJbMF0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgQ29tbW9uIHVwZGF0ZSBtZXRob2RcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLnVwZGF0ZSA9IGZ1bmN0aW9uICh1cGRhdGVUcmFuc2xhdGUpIHtcbiAgICAgICAgICAgIHMudXBkYXRlQ29udGFpbmVyU2l6ZSgpO1xuICAgICAgICAgICAgcy51cGRhdGVTbGlkZXNTaXplKCk7XG4gICAgICAgICAgICBzLnVwZGF0ZVByb2dyZXNzKCk7XG4gICAgICAgICAgICBzLnVwZGF0ZVBhZ2luYXRpb24oKTtcbiAgICAgICAgICAgIHMudXBkYXRlQ2xhc3NlcygpO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNjcm9sbGJhciAmJiBzLnNjcm9sbGJhcikge1xuICAgICAgICAgICAgICAgIHMuc2Nyb2xsYmFyLnNldCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZnVuY3Rpb24gZm9yY2VTZXRUcmFuc2xhdGUoKSB7XG4gICAgICAgICAgICAgICAgbmV3VHJhbnNsYXRlID0gTWF0aC5taW4oTWF0aC5tYXgocy50cmFuc2xhdGUsIHMubWF4VHJhbnNsYXRlKCkpLCBzLm1pblRyYW5zbGF0ZSgpKTtcbiAgICAgICAgICAgICAgICBzLnNldFdyYXBwZXJUcmFuc2xhdGUobmV3VHJhbnNsYXRlKTtcbiAgICAgICAgICAgICAgICBzLnVwZGF0ZUFjdGl2ZUluZGV4KCk7XG4gICAgICAgICAgICAgICAgcy51cGRhdGVDbGFzc2VzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodXBkYXRlVHJhbnNsYXRlKSB7XG4gICAgICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZWQsIG5ld1RyYW5zbGF0ZTtcbiAgICAgICAgICAgICAgICBpZiAocy5jb250cm9sbGVyICYmIHMuY29udHJvbGxlci5zcGxpbmUpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5jb250cm9sbGVyLnNwbGluZSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmZyZWVNb2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvcmNlU2V0VHJhbnNsYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5hdXRvSGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnVwZGF0ZUF1dG9IZWlnaHQoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKChzLnBhcmFtcy5zbGlkZXNQZXJWaWV3ID09PSAnYXV0bycgfHwgcy5wYXJhbXMuc2xpZGVzUGVyVmlldyA+IDEpICYmIHMuaXNFbmQgJiYgIXMucGFyYW1zLmNlbnRlcmVkU2xpZGVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGVkID0gcy5zbGlkZVRvKHMuc2xpZGVzLmxlbmd0aCAtIDEsIDAsIGZhbHNlLCB0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0ZWQgPSBzLnNsaWRlVG8ocy5hY3RpdmVJbmRleCwgMCwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICghdHJhbnNsYXRlZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yY2VTZXRUcmFuc2xhdGUoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKHMucGFyYW1zLmF1dG9IZWlnaHQpIHtcbiAgICAgICAgICAgICAgICBzLnVwZGF0ZUF1dG9IZWlnaHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIFJlc2l6ZSBIYW5kbGVyXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgcy5vblJlc2l6ZSA9IGZ1bmN0aW9uIChmb3JjZVVwZGF0ZVBhZ2luYXRpb24pIHtcbiAgICAgICAgICAgIC8vQnJlYWtwb2ludHNcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5icmVha3BvaW50cykge1xuICAgICAgICAgICAgICAgIHMuc2V0QnJlYWtwb2ludCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIERpc2FibGUgbG9ja3Mgb24gcmVzaXplXG4gICAgICAgICAgICB2YXIgYWxsb3dTd2lwZVRvUHJldiA9IHMucGFyYW1zLmFsbG93U3dpcGVUb1ByZXY7XG4gICAgICAgICAgICB2YXIgYWxsb3dTd2lwZVRvTmV4dCA9IHMucGFyYW1zLmFsbG93U3dpcGVUb05leHQ7XG4gICAgICAgICAgICBzLnBhcmFtcy5hbGxvd1N3aXBlVG9QcmV2ID0gcy5wYXJhbXMuYWxsb3dTd2lwZVRvTmV4dCA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICAgICAgcy51cGRhdGVDb250YWluZXJTaXplKCk7XG4gICAgICAgICAgICBzLnVwZGF0ZVNsaWRlc1NpemUoKTtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zbGlkZXNQZXJWaWV3ID09PSAnYXV0bycgfHwgcy5wYXJhbXMuZnJlZU1vZGUgfHwgZm9yY2VVcGRhdGVQYWdpbmF0aW9uKSBzLnVwZGF0ZVBhZ2luYXRpb24oKTtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zY3JvbGxiYXIgJiYgcy5zY3JvbGxiYXIpIHtcbiAgICAgICAgICAgICAgICBzLnNjcm9sbGJhci5zZXQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLmNvbnRyb2xsZXIgJiYgcy5jb250cm9sbGVyLnNwbGluZSkge1xuICAgICAgICAgICAgICAgIHMuY29udHJvbGxlci5zcGxpbmUgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgc2xpZGVDaGFuZ2VkQnlTbGlkZVRvID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuZnJlZU1vZGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgbmV3VHJhbnNsYXRlID0gTWF0aC5taW4oTWF0aC5tYXgocy50cmFuc2xhdGUsIHMubWF4VHJhbnNsYXRlKCkpLCBzLm1pblRyYW5zbGF0ZSgpKTtcbiAgICAgICAgICAgICAgICBzLnNldFdyYXBwZXJUcmFuc2xhdGUobmV3VHJhbnNsYXRlKTtcbiAgICAgICAgICAgICAgICBzLnVwZGF0ZUFjdGl2ZUluZGV4KCk7XG4gICAgICAgICAgICAgICAgcy51cGRhdGVDbGFzc2VzKCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5hdXRvSGVpZ2h0KSB7XG4gICAgICAgICAgICAgICAgICAgIHMudXBkYXRlQXV0b0hlaWdodCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHMudXBkYXRlQ2xhc3NlcygpO1xuICAgICAgICAgICAgICAgIGlmICgocy5wYXJhbXMuc2xpZGVzUGVyVmlldyA9PT0gJ2F1dG8nIHx8IHMucGFyYW1zLnNsaWRlc1BlclZpZXcgPiAxKSAmJiBzLmlzRW5kICYmICFzLnBhcmFtcy5jZW50ZXJlZFNsaWRlcykge1xuICAgICAgICAgICAgICAgICAgICBzbGlkZUNoYW5nZWRCeVNsaWRlVG8gPSBzLnNsaWRlVG8ocy5zbGlkZXMubGVuZ3RoIC0gMSwgMCwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc2xpZGVDaGFuZ2VkQnlTbGlkZVRvID0gcy5zbGlkZVRvKHMuYWN0aXZlSW5kZXgsIDAsIGZhbHNlLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMubGF6eUxvYWRpbmcgJiYgIXNsaWRlQ2hhbmdlZEJ5U2xpZGVUbyAmJiBzLmxhenkpIHtcbiAgICAgICAgICAgICAgICBzLmxhenkubG9hZCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gUmV0dXJuIGxvY2tzIGFmdGVyIHJlc2l6ZVxuICAgICAgICAgICAgcy5wYXJhbXMuYWxsb3dTd2lwZVRvUHJldiA9IGFsbG93U3dpcGVUb1ByZXY7XG4gICAgICAgICAgICBzLnBhcmFtcy5hbGxvd1N3aXBlVG9OZXh0ID0gYWxsb3dTd2lwZVRvTmV4dDtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIEV2ZW50c1xuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIFxuICAgICAgICAvL0RlZmluZSBUb3VjaCBFdmVudHNcbiAgICAgICAgdmFyIGRlc2t0b3BFdmVudHMgPSBbJ21vdXNlZG93bicsICdtb3VzZW1vdmUnLCAnbW91c2V1cCddO1xuICAgICAgICBpZiAod2luZG93Lm5hdmlnYXRvci5wb2ludGVyRW5hYmxlZCkgZGVza3RvcEV2ZW50cyA9IFsncG9pbnRlcmRvd24nLCAncG9pbnRlcm1vdmUnLCAncG9pbnRlcnVwJ107XG4gICAgICAgIGVsc2UgaWYgKHdpbmRvdy5uYXZpZ2F0b3IubXNQb2ludGVyRW5hYmxlZCkgZGVza3RvcEV2ZW50cyA9IFsnTVNQb2ludGVyRG93bicsICdNU1BvaW50ZXJNb3ZlJywgJ01TUG9pbnRlclVwJ107XG4gICAgICAgIHMudG91Y2hFdmVudHMgPSB7XG4gICAgICAgICAgICBzdGFydCA6IHMuc3VwcG9ydC50b3VjaCB8fCAhcy5wYXJhbXMuc2ltdWxhdGVUb3VjaCAgPyAndG91Y2hzdGFydCcgOiBkZXNrdG9wRXZlbnRzWzBdLFxuICAgICAgICAgICAgbW92ZSA6IHMuc3VwcG9ydC50b3VjaCB8fCAhcy5wYXJhbXMuc2ltdWxhdGVUb3VjaCA/ICd0b3VjaG1vdmUnIDogZGVza3RvcEV2ZW50c1sxXSxcbiAgICAgICAgICAgIGVuZCA6IHMuc3VwcG9ydC50b3VjaCB8fCAhcy5wYXJhbXMuc2ltdWxhdGVUb3VjaCA/ICd0b3VjaGVuZCcgOiBkZXNrdG9wRXZlbnRzWzJdXG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgLy8gV1A4IFRvdWNoIEV2ZW50cyBGaXhcbiAgICAgICAgaWYgKHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQgfHwgd2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkKSB7XG4gICAgICAgICAgICAocy5wYXJhbXMudG91Y2hFdmVudHNUYXJnZXQgPT09ICdjb250YWluZXInID8gcy5jb250YWluZXIgOiBzLndyYXBwZXIpLmFkZENsYXNzKCdzd2lwZXItd3A4LScgKyBzLnBhcmFtcy5kaXJlY3Rpb24pO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBBdHRhY2gvZGV0YWNoIGV2ZW50c1xuICAgICAgICBzLmluaXRFdmVudHMgPSBmdW5jdGlvbiAoZGV0YWNoKSB7XG4gICAgICAgICAgICB2YXIgYWN0aW9uRG9tID0gZGV0YWNoID8gJ29mZicgOiAnb24nO1xuICAgICAgICAgICAgdmFyIGFjdGlvbiA9IGRldGFjaCA/ICdyZW1vdmVFdmVudExpc3RlbmVyJyA6ICdhZGRFdmVudExpc3RlbmVyJztcbiAgICAgICAgICAgIHZhciB0b3VjaEV2ZW50c1RhcmdldCA9IHMucGFyYW1zLnRvdWNoRXZlbnRzVGFyZ2V0ID09PSAnY29udGFpbmVyJyA/IHMuY29udGFpbmVyWzBdIDogcy53cmFwcGVyWzBdO1xuICAgICAgICAgICAgdmFyIHRhcmdldCA9IHMuc3VwcG9ydC50b3VjaCA/IHRvdWNoRXZlbnRzVGFyZ2V0IDogZG9jdW1lbnQ7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIG1vdmVDYXB0dXJlID0gcy5wYXJhbXMubmVzdGVkID8gdHJ1ZSA6IGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vVG91Y2ggRXZlbnRzXG4gICAgICAgICAgICBpZiAocy5icm93c2VyLmllKSB7XG4gICAgICAgICAgICAgICAgdG91Y2hFdmVudHNUYXJnZXRbYWN0aW9uXShzLnRvdWNoRXZlbnRzLnN0YXJ0LCBzLm9uVG91Y2hTdGFydCwgZmFsc2UpO1xuICAgICAgICAgICAgICAgIHRhcmdldFthY3Rpb25dKHMudG91Y2hFdmVudHMubW92ZSwgcy5vblRvdWNoTW92ZSwgbW92ZUNhcHR1cmUpO1xuICAgICAgICAgICAgICAgIHRhcmdldFthY3Rpb25dKHMudG91Y2hFdmVudHMuZW5kLCBzLm9uVG91Y2hFbmQsIGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChzLnN1cHBvcnQudG91Y2gpIHtcbiAgICAgICAgICAgICAgICAgICAgdG91Y2hFdmVudHNUYXJnZXRbYWN0aW9uXShzLnRvdWNoRXZlbnRzLnN0YXJ0LCBzLm9uVG91Y2hTdGFydCwgZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICB0b3VjaEV2ZW50c1RhcmdldFthY3Rpb25dKHMudG91Y2hFdmVudHMubW92ZSwgcy5vblRvdWNoTW92ZSwgbW92ZUNhcHR1cmUpO1xuICAgICAgICAgICAgICAgICAgICB0b3VjaEV2ZW50c1RhcmdldFthY3Rpb25dKHMudG91Y2hFdmVudHMuZW5kLCBzLm9uVG91Y2hFbmQsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHBhcmFtcy5zaW11bGF0ZVRvdWNoICYmICFzLmRldmljZS5pb3MgJiYgIXMuZGV2aWNlLmFuZHJvaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgdG91Y2hFdmVudHNUYXJnZXRbYWN0aW9uXSgnbW91c2Vkb3duJywgcy5vblRvdWNoU3RhcnQsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnRbYWN0aW9uXSgnbW91c2Vtb3ZlJywgcy5vblRvdWNoTW92ZSwgbW92ZUNhcHR1cmUpO1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudFthY3Rpb25dKCdtb3VzZXVwJywgcy5vblRvdWNoRW5kLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgd2luZG93W2FjdGlvbl0oJ3Jlc2l6ZScsIHMub25SZXNpemUpO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIE5leHQsIFByZXYsIEluZGV4XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMubmV4dEJ1dHRvbiAmJiBzLm5leHRCdXR0b24gJiYgcy5uZXh0QnV0dG9uLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBzLm5leHRCdXR0b25bYWN0aW9uRG9tXSgnY2xpY2snLCBzLm9uQ2xpY2tOZXh0KTtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuYTExeSAmJiBzLmExMXkpIHMubmV4dEJ1dHRvblthY3Rpb25Eb21dKCdrZXlkb3duJywgcy5hMTF5Lm9uRW50ZXJLZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnByZXZCdXR0b24gJiYgcy5wcmV2QnV0dG9uICYmIHMucHJldkJ1dHRvbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgcy5wcmV2QnV0dG9uW2FjdGlvbkRvbV0oJ2NsaWNrJywgcy5vbkNsaWNrUHJldik7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmExMXkgJiYgcy5hMTF5KSBzLnByZXZCdXR0b25bYWN0aW9uRG9tXSgna2V5ZG93bicsIHMuYTExeS5vbkVudGVyS2V5KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wYWdpbmF0aW9uICYmIHMucGFyYW1zLnBhZ2luYXRpb25DbGlja2FibGUpIHtcbiAgICAgICAgICAgICAgICBzLnBhZ2luYXRpb25Db250YWluZXJbYWN0aW9uRG9tXSgnY2xpY2snLCAnLicgKyBzLnBhcmFtcy5idWxsZXRDbGFzcywgcy5vbkNsaWNrSW5kZXgpO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5hMTF5ICYmIHMuYTExeSkgcy5wYWdpbmF0aW9uQ29udGFpbmVyW2FjdGlvbkRvbV0oJ2tleWRvd24nLCAnLicgKyBzLnBhcmFtcy5idWxsZXRDbGFzcywgcy5hMTF5Lm9uRW50ZXJLZXkpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIC8vIFByZXZlbnQgTGlua3MgQ2xpY2tzXG4gICAgICAgICAgICBpZiAocy5wYXJhbXMucHJldmVudENsaWNrcyB8fCBzLnBhcmFtcy5wcmV2ZW50Q2xpY2tzUHJvcGFnYXRpb24pIHRvdWNoRXZlbnRzVGFyZ2V0W2FjdGlvbl0oJ2NsaWNrJywgcy5wcmV2ZW50Q2xpY2tzLCB0cnVlKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5hdHRhY2hFdmVudHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBzLmluaXRFdmVudHMoKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5kZXRhY2hFdmVudHMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBzLmluaXRFdmVudHModHJ1ZSk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBIYW5kbGUgQ2xpY2tzXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgLy8gUHJldmVudCBDbGlja3NcbiAgICAgICAgcy5hbGxvd0NsaWNrID0gdHJ1ZTtcbiAgICAgICAgcy5wcmV2ZW50Q2xpY2tzID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgIGlmICghcy5hbGxvd0NsaWNrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnByZXZlbnRDbGlja3MpIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucHJldmVudENsaWNrc1Byb3BhZ2F0aW9uICYmIHMuYW5pbWF0aW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICAvLyBDbGlja3NcbiAgICAgICAgcy5vbkNsaWNrTmV4dCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBpZiAocy5pc0VuZCAmJiAhcy5wYXJhbXMubG9vcCkgcmV0dXJuO1xuICAgICAgICAgICAgcy5zbGlkZU5leHQoKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5vbkNsaWNrUHJldiA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBpZiAocy5pc0JlZ2lubmluZyAmJiAhcy5wYXJhbXMubG9vcCkgcmV0dXJuO1xuICAgICAgICAgICAgcy5zbGlkZVByZXYoKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5vbkNsaWNrSW5kZXggPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgdmFyIGluZGV4ID0gJCh0aGlzKS5pbmRleCgpICogcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXA7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMubG9vcCkgaW5kZXggPSBpbmRleCArIHMubG9vcGVkU2xpZGVzO1xuICAgICAgICAgICAgcy5zbGlkZVRvKGluZGV4KTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIEhhbmRsZSBUb3VjaGVzXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgZnVuY3Rpb24gZmluZEVsZW1lbnRJbkV2ZW50KGUsIHNlbGVjdG9yKSB7XG4gICAgICAgICAgICB2YXIgZWwgPSAkKGUudGFyZ2V0KTtcbiAgICAgICAgICAgIGlmICghZWwuaXMoc2VsZWN0b3IpKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgZWwgPSBlbC5wYXJlbnRzKHNlbGVjdG9yKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoc2VsZWN0b3Iubm9kZVR5cGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGZvdW5kO1xuICAgICAgICAgICAgICAgICAgICBlbC5wYXJlbnRzKCkuZWFjaChmdW5jdGlvbiAoaW5kZXgsIF9lbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF9lbCA9PT0gc2VsZWN0b3IpIGZvdW5kID0gc2VsZWN0b3I7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWZvdW5kKSByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHJldHVybiBzZWxlY3RvcjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZWwubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBlbFswXTtcbiAgICAgICAgfVxuICAgICAgICBzLnVwZGF0ZUNsaWNrZWRTbGlkZSA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICB2YXIgc2xpZGUgPSBmaW5kRWxlbWVudEluRXZlbnQoZSwgJy4nICsgcy5wYXJhbXMuc2xpZGVDbGFzcyk7XG4gICAgICAgICAgICB2YXIgc2xpZGVGb3VuZCA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHNsaWRlKSB7XG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzLnNsaWRlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5zbGlkZXNbaV0gPT09IHNsaWRlKSBzbGlkZUZvdW5kID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHNsaWRlICYmIHNsaWRlRm91bmQpIHtcbiAgICAgICAgICAgICAgICBzLmNsaWNrZWRTbGlkZSA9IHNsaWRlO1xuICAgICAgICAgICAgICAgIHMuY2xpY2tlZEluZGV4ID0gJChzbGlkZSkuaW5kZXgoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHMuY2xpY2tlZFNsaWRlID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHMuY2xpY2tlZEluZGV4ID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zbGlkZVRvQ2xpY2tlZFNsaWRlICYmIHMuY2xpY2tlZEluZGV4ICE9PSB1bmRlZmluZWQgJiYgcy5jbGlja2VkSW5kZXggIT09IHMuYWN0aXZlSW5kZXgpIHtcbiAgICAgICAgICAgICAgICB2YXIgc2xpZGVUb0luZGV4ID0gcy5jbGlja2VkSW5kZXgsXG4gICAgICAgICAgICAgICAgICAgIHJlYWxJbmRleCxcbiAgICAgICAgICAgICAgICAgICAgZHVwbGljYXRlZFNsaWRlcztcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMubG9vcCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5hbmltYXRpbmcpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgcmVhbEluZGV4ID0gJChzLmNsaWNrZWRTbGlkZSkuYXR0cignZGF0YS1zd2lwZXItc2xpZGUtaW5kZXgnKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmNlbnRlcmVkU2xpZGVzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHNsaWRlVG9JbmRleCA8IHMubG9vcGVkU2xpZGVzIC0gcy5wYXJhbXMuc2xpZGVzUGVyVmlldy8yKSB8fCAoc2xpZGVUb0luZGV4ID4gcy5zbGlkZXMubGVuZ3RoIC0gcy5sb29wZWRTbGlkZXMgKyBzLnBhcmFtcy5zbGlkZXNQZXJWaWV3LzIpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5maXhMb29wKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGVUb0luZGV4ID0gcy53cmFwcGVyLmNoaWxkcmVuKCcuJyArIHMucGFyYW1zLnNsaWRlQ2xhc3MgKyAnW2RhdGEtc3dpcGVyLXNsaWRlLWluZGV4PVwiJyArIHJlYWxJbmRleCArICdcIl06bm90KC5zd2lwZXItc2xpZGUtZHVwbGljYXRlKScpLmVxKDApLmluZGV4KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMuc2xpZGVUbyhzbGlkZVRvSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5zbGlkZVRvKHNsaWRlVG9JbmRleCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2xpZGVUb0luZGV4ID4gcy5zbGlkZXMubGVuZ3RoIC0gcy5wYXJhbXMuc2xpZGVzUGVyVmlldykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMuZml4TG9vcCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlVG9JbmRleCA9IHMud3JhcHBlci5jaGlsZHJlbignLicgKyBzLnBhcmFtcy5zbGlkZUNsYXNzICsgJ1tkYXRhLXN3aXBlci1zbGlkZS1pbmRleD1cIicgKyByZWFsSW5kZXggKyAnXCJdOm5vdCguc3dpcGVyLXNsaWRlLWR1cGxpY2F0ZSknKS5lcSgwKS5pbmRleCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLnNsaWRlVG8oc2xpZGVUb0luZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMuc2xpZGVUbyhzbGlkZVRvSW5kZXgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzLnNsaWRlVG8oc2xpZGVUb0luZGV4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICB2YXIgaXNUb3VjaGVkLFxuICAgICAgICAgICAgaXNNb3ZlZCxcbiAgICAgICAgICAgIGFsbG93VG91Y2hDYWxsYmFja3MsXG4gICAgICAgICAgICB0b3VjaFN0YXJ0VGltZSxcbiAgICAgICAgICAgIGlzU2Nyb2xsaW5nLFxuICAgICAgICAgICAgY3VycmVudFRyYW5zbGF0ZSxcbiAgICAgICAgICAgIHN0YXJ0VHJhbnNsYXRlLFxuICAgICAgICAgICAgYWxsb3dUaHJlc2hvbGRNb3ZlLFxuICAgICAgICAgICAgLy8gRm9ybSBlbGVtZW50cyB0byBtYXRjaFxuICAgICAgICAgICAgZm9ybUVsZW1lbnRzID0gJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhLCBidXR0b24nLFxuICAgICAgICAgICAgLy8gTGFzdCBjbGljayB0aW1lXG4gICAgICAgICAgICBsYXN0Q2xpY2tUaW1lID0gRGF0ZS5ub3coKSwgY2xpY2tUaW1lb3V0LFxuICAgICAgICAgICAgLy9WZWxvY2l0aWVzXG4gICAgICAgICAgICB2ZWxvY2l0aWVzID0gW10sXG4gICAgICAgICAgICBhbGxvd01vbWVudHVtQm91bmNlO1xuICAgICAgICBcbiAgICAgICAgLy8gQW5pbWF0aW5nIEZsYWdcbiAgICAgICAgcy5hbmltYXRpbmcgPSBmYWxzZTtcbiAgICAgICAgXG4gICAgICAgIC8vIFRvdWNoZXMgaW5mb3JtYXRpb25cbiAgICAgICAgcy50b3VjaGVzID0ge1xuICAgICAgICAgICAgc3RhcnRYOiAwLFxuICAgICAgICAgICAgc3RhcnRZOiAwLFxuICAgICAgICAgICAgY3VycmVudFg6IDAsXG4gICAgICAgICAgICBjdXJyZW50WTogMCxcbiAgICAgICAgICAgIGRpZmY6IDBcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8vIFRvdWNoIGhhbmRsZXJzXG4gICAgICAgIHZhciBpc1RvdWNoRXZlbnQsIHN0YXJ0TW92aW5nO1xuICAgICAgICBzLm9uVG91Y2hTdGFydCA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICBpZiAoZS5vcmlnaW5hbEV2ZW50KSBlID0gZS5vcmlnaW5hbEV2ZW50O1xuICAgICAgICAgICAgaXNUb3VjaEV2ZW50ID0gZS50eXBlID09PSAndG91Y2hzdGFydCc7XG4gICAgICAgICAgICBpZiAoIWlzVG91Y2hFdmVudCAmJiAnd2hpY2gnIGluIGUgJiYgZS53aGljaCA9PT0gMykgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLm5vU3dpcGluZyAmJiBmaW5kRWxlbWVudEluRXZlbnQoZSwgJy4nICsgcy5wYXJhbXMubm9Td2lwaW5nQ2xhc3MpKSB7XG4gICAgICAgICAgICAgICAgcy5hbGxvd0NsaWNrID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuc3dpcGVIYW5kbGVyKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFmaW5kRWxlbWVudEluRXZlbnQoZSwgcy5wYXJhbXMuc3dpcGVIYW5kbGVyKSkgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIHZhciBzdGFydFggPSBzLnRvdWNoZXMuY3VycmVudFggPSBlLnR5cGUgPT09ICd0b3VjaHN0YXJ0JyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGUucGFnZVg7XG4gICAgICAgICAgICB2YXIgc3RhcnRZID0gcy50b3VjaGVzLmN1cnJlbnRZID0gZS50eXBlID09PSAndG91Y2hzdGFydCcgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVkgOiBlLnBhZ2VZO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIERvIE5PVCBzdGFydCBpZiBpT1MgZWRnZSBzd2lwZSBpcyBkZXRlY3RlZC4gT3RoZXJ3aXNlIGlPUyBhcHAgKFVJV2ViVmlldykgY2Fubm90IHN3aXBlLXRvLWdvLWJhY2sgYW55bW9yZVxuICAgICAgICAgICAgaWYocy5kZXZpY2UuaW9zICYmIHMucGFyYW1zLmlPU0VkZ2VTd2lwZURldGVjdGlvbiAmJiBzdGFydFggPD0gcy5wYXJhbXMuaU9TRWRnZVN3aXBlVGhyZXNob2xkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlzVG91Y2hlZCA9IHRydWU7XG4gICAgICAgICAgICBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgICAgICBhbGxvd1RvdWNoQ2FsbGJhY2tzID0gdHJ1ZTtcbiAgICAgICAgICAgIGlzU2Nyb2xsaW5nID0gdW5kZWZpbmVkO1xuICAgICAgICAgICAgc3RhcnRNb3ZpbmcgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICBzLnRvdWNoZXMuc3RhcnRYID0gc3RhcnRYO1xuICAgICAgICAgICAgcy50b3VjaGVzLnN0YXJ0WSA9IHN0YXJ0WTtcbiAgICAgICAgICAgIHRvdWNoU3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICAgIHMuYWxsb3dDbGljayA9IHRydWU7XG4gICAgICAgICAgICBzLnVwZGF0ZUNvbnRhaW5lclNpemUoKTtcbiAgICAgICAgICAgIHMuc3dpcGVEaXJlY3Rpb24gPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMudGhyZXNob2xkID4gMCkgYWxsb3dUaHJlc2hvbGRNb3ZlID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAoZS50eXBlICE9PSAndG91Y2hzdGFydCcpIHtcbiAgICAgICAgICAgICAgICB2YXIgcHJldmVudERlZmF1bHQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGlmICgkKGUudGFyZ2V0KS5pcyhmb3JtRWxlbWVudHMpKSBwcmV2ZW50RGVmYXVsdCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmICQoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkuaXMoZm9ybUVsZW1lbnRzKSkge1xuICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5hY3RpdmVFbGVtZW50LmJsdXIoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHByZXZlbnREZWZhdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzLmVtaXQoJ29uVG91Y2hTdGFydCcsIHMsIGUpO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgcy5vblRvdWNoTW92ZSA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICBpZiAoZS5vcmlnaW5hbEV2ZW50KSBlID0gZS5vcmlnaW5hbEV2ZW50O1xuICAgICAgICAgICAgaWYgKGlzVG91Y2hFdmVudCAmJiBlLnR5cGUgPT09ICdtb3VzZW1vdmUnKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoZS5wcmV2ZW50ZWRCeU5lc3RlZFN3aXBlcikge1xuICAgICAgICAgICAgICAgIHMudG91Y2hlcy5zdGFydFggPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZS5wYWdlWDtcbiAgICAgICAgICAgICAgICBzLnRvdWNoZXMuc3RhcnRZID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLm9ubHlFeHRlcm5hbCkge1xuICAgICAgICAgICAgICAgIC8vIGlzTW92ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHMuYWxsb3dDbGljayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChpc1RvdWNoZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgcy50b3VjaGVzLnN0YXJ0WCA9IHMudG91Y2hlcy5jdXJyZW50WCA9IGUudHlwZSA9PT0gJ3RvdWNobW92ZScgPyBlLnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBlLnBhZ2VYO1xuICAgICAgICAgICAgICAgICAgICBzLnRvdWNoZXMuc3RhcnRZID0gcy50b3VjaGVzLmN1cnJlbnRZID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVk7XG4gICAgICAgICAgICAgICAgICAgIHRvdWNoU3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGlzVG91Y2hFdmVudCAmJiBkb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgaWYgKGUudGFyZ2V0ID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmICQoZS50YXJnZXQpLmlzKGZvcm1FbGVtZW50cykpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNNb3ZlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHMuYWxsb3dDbGljayA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGFsbG93VG91Y2hDYWxsYmFja3MpIHtcbiAgICAgICAgICAgICAgICBzLmVtaXQoJ29uVG91Y2hNb3ZlJywgcywgZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZS50YXJnZXRUb3VjaGVzICYmIGUudGFyZ2V0VG91Y2hlcy5sZW5ndGggPiAxKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgcy50b3VjaGVzLmN1cnJlbnRYID0gZS50eXBlID09PSAndG91Y2htb3ZlJyA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGUucGFnZVg7XG4gICAgICAgICAgICBzLnRvdWNoZXMuY3VycmVudFkgPSBlLnR5cGUgPT09ICd0b3VjaG1vdmUnID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VZIDogZS5wYWdlWTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAodHlwZW9mIGlzU2Nyb2xsaW5nID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgICAgIHZhciB0b3VjaEFuZ2xlID0gTWF0aC5hdGFuMihNYXRoLmFicyhzLnRvdWNoZXMuY3VycmVudFkgLSBzLnRvdWNoZXMuc3RhcnRZKSwgTWF0aC5hYnMocy50b3VjaGVzLmN1cnJlbnRYIC0gcy50b3VjaGVzLnN0YXJ0WCkpICogMTgwIC8gTWF0aC5QSTtcbiAgICAgICAgICAgICAgICBpc1Njcm9sbGluZyA9IHMuaXNIb3Jpem9udGFsKCkgPyB0b3VjaEFuZ2xlID4gcy5wYXJhbXMudG91Y2hBbmdsZSA6ICg5MCAtIHRvdWNoQW5nbGUgPiBzLnBhcmFtcy50b3VjaEFuZ2xlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpc1Njcm9sbGluZykge1xuICAgICAgICAgICAgICAgIHMuZW1pdCgnb25Ub3VjaE1vdmVPcHBvc2l0ZScsIHMsIGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHR5cGVvZiBzdGFydE1vdmluZyA9PT0gJ3VuZGVmaW5lZCcgJiYgcy5icm93c2VyLmllVG91Y2gpIHtcbiAgICAgICAgICAgICAgICBpZiAocy50b3VjaGVzLmN1cnJlbnRYICE9PSBzLnRvdWNoZXMuc3RhcnRYIHx8IHMudG91Y2hlcy5jdXJyZW50WSAhPT0gcy50b3VjaGVzLnN0YXJ0WSkge1xuICAgICAgICAgICAgICAgICAgICBzdGFydE1vdmluZyA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFpc1RvdWNoZWQpIHJldHVybjtcbiAgICAgICAgICAgIGlmIChpc1Njcm9sbGluZykgIHtcbiAgICAgICAgICAgICAgICBpc1RvdWNoZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXN0YXJ0TW92aW5nICYmIHMuYnJvd3Nlci5pZVRvdWNoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcy5hbGxvd0NsaWNrID0gZmFsc2U7XG4gICAgICAgICAgICBzLmVtaXQoJ29uU2xpZGVyTW92ZScsIHMsIGUpO1xuICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnRvdWNoTW92ZVN0b3BQcm9wYWdhdGlvbiAmJiAhcy5wYXJhbXMubmVzdGVkKSB7XG4gICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoIWlzTW92ZWQpIHtcbiAgICAgICAgICAgICAgICBpZiAocGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICAgICAgcy5maXhMb29wKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHN0YXJ0VHJhbnNsYXRlID0gcy5nZXRXcmFwcGVyVHJhbnNsYXRlKCk7XG4gICAgICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNpdGlvbigwKTtcbiAgICAgICAgICAgICAgICBpZiAocy5hbmltYXRpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgcy53cmFwcGVyLnRyaWdnZXIoJ3dlYmtpdFRyYW5zaXRpb25FbmQgdHJhbnNpdGlvbmVuZCBvVHJhbnNpdGlvbkVuZCBNU1RyYW5zaXRpb25FbmQgbXNUcmFuc2l0aW9uRW5kJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5hdXRvcGxheSAmJiBzLmF1dG9wbGF5aW5nKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5hdXRvcGxheURpc2FibGVPbkludGVyYWN0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnN0b3BBdXRvcGxheSgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5wYXVzZUF1dG9wbGF5KCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYWxsb3dNb21lbnR1bUJvdW5jZSA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIC8vR3JhYiBDdXJzb3JcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuZ3JhYkN1cnNvcikge1xuICAgICAgICAgICAgICAgICAgICBzLmNvbnRhaW5lclswXS5zdHlsZS5jdXJzb3IgPSAnbW92ZSc7XG4gICAgICAgICAgICAgICAgICAgIHMuY29udGFpbmVyWzBdLnN0eWxlLmN1cnNvciA9ICctd2Via2l0LWdyYWJiaW5nJztcbiAgICAgICAgICAgICAgICAgICAgcy5jb250YWluZXJbMF0uc3R5bGUuY3Vyc29yID0gJy1tb3otZ3JhYmJpbic7XG4gICAgICAgICAgICAgICAgICAgIHMuY29udGFpbmVyWzBdLnN0eWxlLmN1cnNvciA9ICdncmFiYmluZyc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaXNNb3ZlZCA9IHRydWU7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIGRpZmYgPSBzLnRvdWNoZXMuZGlmZiA9IHMuaXNIb3Jpem9udGFsKCkgPyBzLnRvdWNoZXMuY3VycmVudFggLSBzLnRvdWNoZXMuc3RhcnRYIDogcy50b3VjaGVzLmN1cnJlbnRZIC0gcy50b3VjaGVzLnN0YXJ0WTtcbiAgICAgICAgXG4gICAgICAgICAgICBkaWZmID0gZGlmZiAqIHMucGFyYW1zLnRvdWNoUmF0aW87XG4gICAgICAgICAgICBpZiAocy5ydGwpIGRpZmYgPSAtZGlmZjtcbiAgICAgICAgXG4gICAgICAgICAgICBzLnN3aXBlRGlyZWN0aW9uID0gZGlmZiA+IDAgPyAncHJldicgOiAnbmV4dCc7XG4gICAgICAgICAgICBjdXJyZW50VHJhbnNsYXRlID0gZGlmZiArIHN0YXJ0VHJhbnNsYXRlO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBkaXNhYmxlUGFyZW50U3dpcGVyID0gdHJ1ZTtcbiAgICAgICAgICAgIGlmICgoZGlmZiA+IDAgJiYgY3VycmVudFRyYW5zbGF0ZSA+IHMubWluVHJhbnNsYXRlKCkpKSB7XG4gICAgICAgICAgICAgICAgZGlzYWJsZVBhcmVudFN3aXBlciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5yZXNpc3RhbmNlKSBjdXJyZW50VHJhbnNsYXRlID0gcy5taW5UcmFuc2xhdGUoKSAtIDEgKyBNYXRoLnBvdygtcy5taW5UcmFuc2xhdGUoKSArIHN0YXJ0VHJhbnNsYXRlICsgZGlmZiwgcy5wYXJhbXMucmVzaXN0YW5jZVJhdGlvKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGRpZmYgPCAwICYmIGN1cnJlbnRUcmFuc2xhdGUgPCBzLm1heFRyYW5zbGF0ZSgpKSB7XG4gICAgICAgICAgICAgICAgZGlzYWJsZVBhcmVudFN3aXBlciA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5yZXNpc3RhbmNlKSBjdXJyZW50VHJhbnNsYXRlID0gcy5tYXhUcmFuc2xhdGUoKSArIDEgLSBNYXRoLnBvdyhzLm1heFRyYW5zbGF0ZSgpIC0gc3RhcnRUcmFuc2xhdGUgLSBkaWZmLCBzLnBhcmFtcy5yZXNpc3RhbmNlUmF0aW8pO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmIChkaXNhYmxlUGFyZW50U3dpcGVyKSB7XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50ZWRCeU5lc3RlZFN3aXBlciA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGlyZWN0aW9ucyBsb2Nrc1xuICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5hbGxvd1N3aXBlVG9OZXh0ICYmIHMuc3dpcGVEaXJlY3Rpb24gPT09ICduZXh0JyAmJiBjdXJyZW50VHJhbnNsYXRlIDwgc3RhcnRUcmFuc2xhdGUpIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNsYXRlID0gc3RhcnRUcmFuc2xhdGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXMucGFyYW1zLmFsbG93U3dpcGVUb1ByZXYgJiYgcy5zd2lwZURpcmVjdGlvbiA9PT0gJ3ByZXYnICYmIGN1cnJlbnRUcmFuc2xhdGUgPiBzdGFydFRyYW5zbGF0ZSkge1xuICAgICAgICAgICAgICAgIGN1cnJlbnRUcmFuc2xhdGUgPSBzdGFydFRyYW5zbGF0ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoIXMucGFyYW1zLmZvbGxvd0ZpbmdlcikgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIFRocmVzaG9sZFxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnRocmVzaG9sZCA+IDApIHtcbiAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMoZGlmZikgPiBzLnBhcmFtcy50aHJlc2hvbGQgfHwgYWxsb3dUaHJlc2hvbGRNb3ZlKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYWxsb3dUaHJlc2hvbGRNb3ZlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxvd1RocmVzaG9sZE1vdmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy50b3VjaGVzLnN0YXJ0WCA9IHMudG91Y2hlcy5jdXJyZW50WDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMudG91Y2hlcy5zdGFydFkgPSBzLnRvdWNoZXMuY3VycmVudFk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50VHJhbnNsYXRlID0gc3RhcnRUcmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnRvdWNoZXMuZGlmZiA9IHMuaXNIb3Jpem9udGFsKCkgPyBzLnRvdWNoZXMuY3VycmVudFggLSBzLnRvdWNoZXMuc3RhcnRYIDogcy50b3VjaGVzLmN1cnJlbnRZIC0gcy50b3VjaGVzLnN0YXJ0WTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY3VycmVudFRyYW5zbGF0ZSA9IHN0YXJ0VHJhbnNsYXRlO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gVXBkYXRlIGFjdGl2ZSBpbmRleCBpbiBmcmVlIG1vZGVcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5mcmVlTW9kZSB8fCBzLnBhcmFtcy53YXRjaFNsaWRlc1Byb2dyZXNzKSB7XG4gICAgICAgICAgICAgICAgcy51cGRhdGVBY3RpdmVJbmRleCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmZyZWVNb2RlKSB7XG4gICAgICAgICAgICAgICAgLy9WZWxvY2l0eVxuICAgICAgICAgICAgICAgIGlmICh2ZWxvY2l0aWVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0aWVzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IHMudG91Y2hlc1tzLmlzSG9yaXpvbnRhbCgpID8gJ3N0YXJ0WCcgOiAnc3RhcnRZJ10sXG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lOiB0b3VjaFN0YXJ0VGltZVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdmVsb2NpdGllcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IHMudG91Y2hlc1tzLmlzSG9yaXpvbnRhbCgpID8gJ2N1cnJlbnRYJyA6ICdjdXJyZW50WSddLFxuICAgICAgICAgICAgICAgICAgICB0aW1lOiAobmV3IHdpbmRvdy5EYXRlKCkpLmdldFRpbWUoKVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gVXBkYXRlIHByb2dyZXNzXG4gICAgICAgICAgICBzLnVwZGF0ZVByb2dyZXNzKGN1cnJlbnRUcmFuc2xhdGUpO1xuICAgICAgICAgICAgLy8gVXBkYXRlIHRyYW5zbGF0ZVxuICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNsYXRlKGN1cnJlbnRUcmFuc2xhdGUpO1xuICAgICAgICB9O1xuICAgICAgICBzLm9uVG91Y2hFbmQgPSBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgaWYgKGUub3JpZ2luYWxFdmVudCkgZSA9IGUub3JpZ2luYWxFdmVudDtcbiAgICAgICAgICAgIGlmIChhbGxvd1RvdWNoQ2FsbGJhY2tzKSB7XG4gICAgICAgICAgICAgICAgcy5lbWl0KCdvblRvdWNoRW5kJywgcywgZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBhbGxvd1RvdWNoQ2FsbGJhY2tzID0gZmFsc2U7XG4gICAgICAgICAgICBpZiAoIWlzVG91Y2hlZCkgcmV0dXJuO1xuICAgICAgICAgICAgLy9SZXR1cm4gR3JhYiBDdXJzb3JcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5ncmFiQ3Vyc29yICYmIGlzTW92ZWQgJiYgaXNUb3VjaGVkKSB7XG4gICAgICAgICAgICAgICAgcy5jb250YWluZXJbMF0uc3R5bGUuY3Vyc29yID0gJ21vdmUnO1xuICAgICAgICAgICAgICAgIHMuY29udGFpbmVyWzBdLnN0eWxlLmN1cnNvciA9ICctd2Via2l0LWdyYWInO1xuICAgICAgICAgICAgICAgIHMuY29udGFpbmVyWzBdLnN0eWxlLmN1cnNvciA9ICctbW96LWdyYWInO1xuICAgICAgICAgICAgICAgIHMuY29udGFpbmVyWzBdLnN0eWxlLmN1cnNvciA9ICdncmFiJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBUaW1lIGRpZmZcbiAgICAgICAgICAgIHZhciB0b3VjaEVuZFRpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgdmFyIHRpbWVEaWZmID0gdG91Y2hFbmRUaW1lIC0gdG91Y2hTdGFydFRpbWU7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gVGFwLCBkb3VibGVUYXAsIENsaWNrXG4gICAgICAgICAgICBpZiAocy5hbGxvd0NsaWNrKSB7XG4gICAgICAgICAgICAgICAgcy51cGRhdGVDbGlja2VkU2xpZGUoZSk7XG4gICAgICAgICAgICAgICAgcy5lbWl0KCdvblRhcCcsIHMsIGUpO1xuICAgICAgICAgICAgICAgIGlmICh0aW1lRGlmZiA8IDMwMCAmJiAodG91Y2hFbmRUaW1lIC0gbGFzdENsaWNrVGltZSkgPiAzMDApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNsaWNrVGltZW91dCkgY2xlYXJUaW1lb3V0KGNsaWNrVGltZW91dCk7XG4gICAgICAgICAgICAgICAgICAgIGNsaWNrVGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucGFnaW5hdGlvbkhpZGUgJiYgcy5wYWdpbmF0aW9uQ29udGFpbmVyLmxlbmd0aCA+IDAgJiYgISQoZS50YXJnZXQpLmhhc0NsYXNzKHMucGFyYW1zLmJ1bGxldENsYXNzKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMucGFnaW5hdGlvbkNvbnRhaW5lci50b2dnbGVDbGFzcyhzLnBhcmFtcy5wYWdpbmF0aW9uSGlkZGVuQ2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgcy5lbWl0KCdvbkNsaWNrJywgcywgZSk7XG4gICAgICAgICAgICAgICAgICAgIH0sIDMwMCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAodGltZURpZmYgPCAzMDAgJiYgKHRvdWNoRW5kVGltZSAtIGxhc3RDbGlja1RpbWUpIDwgMzAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjbGlja1RpbWVvdXQpIGNsZWFyVGltZW91dChjbGlja1RpbWVvdXQpO1xuICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uRG91YmxlVGFwJywgcywgZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGxhc3RDbGlja1RpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMpIHMuYWxsb3dDbGljayA9IHRydWU7XG4gICAgICAgICAgICB9LCAwKTtcbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoIWlzVG91Y2hlZCB8fCAhaXNNb3ZlZCB8fCAhcy5zd2lwZURpcmVjdGlvbiB8fCBzLnRvdWNoZXMuZGlmZiA9PT0gMCB8fCBjdXJyZW50VHJhbnNsYXRlID09PSBzdGFydFRyYW5zbGF0ZSkge1xuICAgICAgICAgICAgICAgIGlzVG91Y2hlZCA9IGlzTW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpc1RvdWNoZWQgPSBpc01vdmVkID0gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAgICAgdmFyIGN1cnJlbnRQb3M7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuZm9sbG93RmluZ2VyKSB7XG4gICAgICAgICAgICAgICAgY3VycmVudFBvcyA9IHMucnRsID8gcy50cmFuc2xhdGUgOiAtcy50cmFuc2xhdGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjdXJyZW50UG9zID0gLWN1cnJlbnRUcmFuc2xhdGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuZnJlZU1vZGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoY3VycmVudFBvcyA8IC1zLm1pblRyYW5zbGF0ZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuc2xpZGVUbyhzLmFjdGl2ZUluZGV4KTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChjdXJyZW50UG9zID4gLXMubWF4VHJhbnNsYXRlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuc2xpZGVzLmxlbmd0aCA8IHMuc25hcEdyaWQubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnNsaWRlVG8ocy5zbmFwR3JpZC5sZW5ndGggLSAxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuc2xpZGVUbyhzLnNsaWRlcy5sZW5ndGggLSAxKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuZnJlZU1vZGVNb21lbnR1bSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAodmVsb2NpdGllcy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGFzdE1vdmVFdmVudCA9IHZlbG9jaXRpZXMucG9wKCksIHZlbG9jaXR5RXZlbnQgPSB2ZWxvY2l0aWVzLnBvcCgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkaXN0YW5jZSA9IGxhc3RNb3ZlRXZlbnQucG9zaXRpb24gLSB2ZWxvY2l0eUV2ZW50LnBvc2l0aW9uO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRpbWUgPSBsYXN0TW92ZUV2ZW50LnRpbWUgLSB2ZWxvY2l0eUV2ZW50LnRpbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnZlbG9jaXR5ID0gZGlzdGFuY2UgLyB0aW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy52ZWxvY2l0eSA9IHMudmVsb2NpdHkgLyAyO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHMudmVsb2NpdHkpIDwgcy5wYXJhbXMuZnJlZU1vZGVNaW5pbXVtVmVsb2NpdHkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLnZlbG9jaXR5ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoaXMgaW1wbGllcyB0aGF0IHRoZSB1c2VyIHN0b3BwZWQgbW92aW5nIGEgZmluZ2VyIHRoZW4gcmVsZWFzZWQuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGVyZSB3b3VsZCBiZSBubyBldmVudHMgd2l0aCBkaXN0YW5jZSB6ZXJvLCBzbyB0aGUgbGFzdCBldmVudCBpcyBzdGFsZS5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aW1lID4gMTUwIHx8IChuZXcgd2luZG93LkRhdGUoKS5nZXRUaW1lKCkgLSBsYXN0TW92ZUV2ZW50LnRpbWUpID4gMzAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy52ZWxvY2l0eSA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnZlbG9jaXR5ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgdmVsb2NpdGllcy5sZW5ndGggPSAwO1xuICAgICAgICAgICAgICAgICAgICB2YXIgbW9tZW50dW1EdXJhdGlvbiA9IDEwMDAgKiBzLnBhcmFtcy5mcmVlTW9kZU1vbWVudHVtUmF0aW87XG4gICAgICAgICAgICAgICAgICAgIHZhciBtb21lbnR1bURpc3RhbmNlID0gcy52ZWxvY2l0eSAqIG1vbWVudHVtRHVyYXRpb247XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB2YXIgbmV3UG9zaXRpb24gPSBzLnRyYW5zbGF0ZSArIG1vbWVudHVtRGlzdGFuY2U7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnJ0bCkgbmV3UG9zaXRpb24gPSAtIG5ld1Bvc2l0aW9uO1xuICAgICAgICAgICAgICAgICAgICB2YXIgZG9Cb3VuY2UgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGFmdGVyQm91bmNlUG9zaXRpb247XG4gICAgICAgICAgICAgICAgICAgIHZhciBib3VuY2VBbW91bnQgPSBNYXRoLmFicyhzLnZlbG9jaXR5KSAqIDIwICogcy5wYXJhbXMuZnJlZU1vZGVNb21lbnR1bUJvdW5jZVJhdGlvO1xuICAgICAgICAgICAgICAgICAgICBpZiAobmV3UG9zaXRpb24gPCBzLm1heFRyYW5zbGF0ZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuZnJlZU1vZGVNb21lbnR1bUJvdW5jZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChuZXdQb3NpdGlvbiArIHMubWF4VHJhbnNsYXRlKCkgPCAtYm91bmNlQW1vdW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1Bvc2l0aW9uID0gcy5tYXhUcmFuc2xhdGUoKSAtIGJvdW5jZUFtb3VudDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJCb3VuY2VQb3NpdGlvbiA9IHMubWF4VHJhbnNsYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9Cb3VuY2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93TW9tZW50dW1Cb3VuY2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UG9zaXRpb24gPSBzLm1heFRyYW5zbGF0ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKG5ld1Bvc2l0aW9uID4gcy5taW5UcmFuc2xhdGUoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmZyZWVNb2RlTW9tZW50dW1Cb3VuY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmV3UG9zaXRpb24gLSBzLm1pblRyYW5zbGF0ZSgpID4gYm91bmNlQW1vdW50KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1Bvc2l0aW9uID0gcy5taW5UcmFuc2xhdGUoKSArIGJvdW5jZUFtb3VudDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXJCb3VuY2VQb3NpdGlvbiA9IHMubWluVHJhbnNsYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZG9Cb3VuY2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93TW9tZW50dW1Cb3VuY2UgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UG9zaXRpb24gPSBzLm1pblRyYW5zbGF0ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHMucGFyYW1zLmZyZWVNb2RlU3RpY2t5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaiA9IDAsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV4dFNsaWRlO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChqID0gMDsgaiA8IHMuc25hcEdyaWQubGVuZ3RoOyBqICs9IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5zbmFwR3JpZFtqXSA+IC1uZXdQb3NpdGlvbikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXh0U2xpZGUgPSBqO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE1hdGguYWJzKHMuc25hcEdyaWRbbmV4dFNsaWRlXSAtIG5ld1Bvc2l0aW9uKSA8IE1hdGguYWJzKHMuc25hcEdyaWRbbmV4dFNsaWRlIC0gMV0gLSBuZXdQb3NpdGlvbikgfHwgcy5zd2lwZURpcmVjdGlvbiA9PT0gJ25leHQnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3UG9zaXRpb24gPSBzLnNuYXBHcmlkW25leHRTbGlkZV07XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5ld1Bvc2l0aW9uID0gcy5zbmFwR3JpZFtuZXh0U2xpZGUgLSAxXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcy5ydGwpIG5ld1Bvc2l0aW9uID0gLSBuZXdQb3NpdGlvbjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvL0ZpeCBkdXJhdGlvblxuICAgICAgICAgICAgICAgICAgICBpZiAocy52ZWxvY2l0eSAhPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMucnRsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9tZW50dW1EdXJhdGlvbiA9IE1hdGguYWJzKCgtbmV3UG9zaXRpb24gLSBzLnRyYW5zbGF0ZSkgLyBzLnZlbG9jaXR5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vbWVudHVtRHVyYXRpb24gPSBNYXRoLmFicygobmV3UG9zaXRpb24gLSBzLnRyYW5zbGF0ZSkgLyBzLnZlbG9jaXR5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChzLnBhcmFtcy5mcmVlTW9kZVN0aWNreSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5zbGlkZVJlc2V0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5mcmVlTW9kZU1vbWVudHVtQm91bmNlICYmIGRvQm91bmNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnVwZGF0ZVByb2dyZXNzKGFmdGVyQm91bmNlUG9zaXRpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNpdGlvbihtb21lbnR1bUR1cmF0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuc2V0V3JhcHBlclRyYW5zbGF0ZShuZXdQb3NpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLm9uVHJhbnNpdGlvblN0YXJ0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmFuaW1hdGluZyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLndyYXBwZXIudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzIHx8ICFhbGxvd01vbWVudHVtQm91bmNlKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5lbWl0KCdvbk1vbWVudHVtQm91bmNlJywgcyk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMuc2V0V3JhcHBlclRyYW5zaXRpb24ocy5wYXJhbXMuc3BlZWQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMuc2V0V3JhcHBlclRyYW5zbGF0ZShhZnRlckJvdW5jZVBvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLndyYXBwZXIudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcykgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLm9uVHJhbnNpdGlvbkVuZCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocy52ZWxvY2l0eSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy51cGRhdGVQcm9ncmVzcyhuZXdQb3NpdGlvbik7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnNldFdyYXBwZXJUcmFuc2l0aW9uKG1vbWVudHVtRHVyYXRpb24pO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNsYXRlKG5ld1Bvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMub25UcmFuc2l0aW9uU3RhcnQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcy5hbmltYXRpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLmFuaW1hdGluZyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcy53cmFwcGVyLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXMpIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcy5vblRyYW5zaXRpb25FbmQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLnVwZGF0ZVByb2dyZXNzKG5ld1Bvc2l0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgcy51cGRhdGVBY3RpdmVJbmRleCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIXMucGFyYW1zLmZyZWVNb2RlTW9tZW50dW0gfHwgdGltZURpZmYgPj0gcy5wYXJhbXMubG9uZ1N3aXBlc01zKSB7XG4gICAgICAgICAgICAgICAgICAgIHMudXBkYXRlUHJvZ3Jlc3MoKTtcbiAgICAgICAgICAgICAgICAgICAgcy51cGRhdGVBY3RpdmVJbmRleCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRmluZCBjdXJyZW50IHNsaWRlXG4gICAgICAgICAgICB2YXIgaSwgc3RvcEluZGV4ID0gMCwgZ3JvdXBTaXplID0gcy5zbGlkZXNTaXplc0dyaWRbMF07XG4gICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcy5zbGlkZXNHcmlkLmxlbmd0aDsgaSArPSBzLnBhcmFtcy5zbGlkZXNQZXJHcm91cCkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygcy5zbGlkZXNHcmlkW2kgKyBzLnBhcmFtcy5zbGlkZXNQZXJHcm91cF0gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50UG9zID49IHMuc2xpZGVzR3JpZFtpXSAmJiBjdXJyZW50UG9zIDwgcy5zbGlkZXNHcmlkW2kgKyBzLnBhcmFtcy5zbGlkZXNQZXJHcm91cF0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0b3BJbmRleCA9IGk7XG4gICAgICAgICAgICAgICAgICAgICAgICBncm91cFNpemUgPSBzLnNsaWRlc0dyaWRbaSArIHMucGFyYW1zLnNsaWRlc1Blckdyb3VwXSAtIHMuc2xpZGVzR3JpZFtpXTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnRQb3MgPj0gcy5zbGlkZXNHcmlkW2ldKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdG9wSW5kZXggPSBpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZ3JvdXBTaXplID0gcy5zbGlkZXNHcmlkW3Muc2xpZGVzR3JpZC5sZW5ndGggLSAxXSAtIHMuc2xpZGVzR3JpZFtzLnNsaWRlc0dyaWQubGVuZ3RoIC0gMl07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRmluZCBjdXJyZW50IHNsaWRlIHNpemVcbiAgICAgICAgICAgIHZhciByYXRpbyA9IChjdXJyZW50UG9zIC0gcy5zbGlkZXNHcmlkW3N0b3BJbmRleF0pIC8gZ3JvdXBTaXplO1xuICAgICAgICBcbiAgICAgICAgICAgIGlmICh0aW1lRGlmZiA+IHMucGFyYW1zLmxvbmdTd2lwZXNNcykge1xuICAgICAgICAgICAgICAgIC8vIExvbmcgdG91Y2hlc1xuICAgICAgICAgICAgICAgIGlmICghcy5wYXJhbXMubG9uZ1N3aXBlcykge1xuICAgICAgICAgICAgICAgICAgICBzLnNsaWRlVG8ocy5hY3RpdmVJbmRleCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMuc3dpcGVEaXJlY3Rpb24gPT09ICduZXh0Jykge1xuICAgICAgICAgICAgICAgICAgICBpZiAocmF0aW8gPj0gcy5wYXJhbXMubG9uZ1N3aXBlc1JhdGlvKSBzLnNsaWRlVG8oc3RvcEluZGV4ICsgcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXApO1xuICAgICAgICAgICAgICAgICAgICBlbHNlIHMuc2xpZGVUbyhzdG9wSW5kZXgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMuc3dpcGVEaXJlY3Rpb24gPT09ICdwcmV2Jykge1xuICAgICAgICAgICAgICAgICAgICBpZiAocmF0aW8gPiAoMSAtIHMucGFyYW1zLmxvbmdTd2lwZXNSYXRpbykpIHMuc2xpZGVUbyhzdG9wSW5kZXggKyBzLnBhcmFtcy5zbGlkZXNQZXJHcm91cCk7XG4gICAgICAgICAgICAgICAgICAgIGVsc2Ugcy5zbGlkZVRvKHN0b3BJbmRleCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gU2hvcnQgc3dpcGVzXG4gICAgICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5zaG9ydFN3aXBlcykge1xuICAgICAgICAgICAgICAgICAgICBzLnNsaWRlVG8ocy5hY3RpdmVJbmRleCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMuc3dpcGVEaXJlY3Rpb24gPT09ICduZXh0Jykge1xuICAgICAgICAgICAgICAgICAgICBzLnNsaWRlVG8oc3RvcEluZGV4ICsgcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXApO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMuc3dpcGVEaXJlY3Rpb24gPT09ICdwcmV2Jykge1xuICAgICAgICAgICAgICAgICAgICBzLnNsaWRlVG8oc3RvcEluZGV4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIFRyYW5zaXRpb25zXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgcy5fc2xpZGVUbyA9IGZ1bmN0aW9uIChzbGlkZUluZGV4LCBzcGVlZCkge1xuICAgICAgICAgICAgcmV0dXJuIHMuc2xpZGVUbyhzbGlkZUluZGV4LCBzcGVlZCwgdHJ1ZSwgdHJ1ZSk7XG4gICAgICAgIH07XG4gICAgICAgIHMuc2xpZGVUbyA9IGZ1bmN0aW9uIChzbGlkZUluZGV4LCBzcGVlZCwgcnVuQ2FsbGJhY2tzLCBpbnRlcm5hbCkge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBydW5DYWxsYmFja3MgPT09ICd1bmRlZmluZWQnKSBydW5DYWxsYmFja3MgPSB0cnVlO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBzbGlkZUluZGV4ID09PSAndW5kZWZpbmVkJykgc2xpZGVJbmRleCA9IDA7XG4gICAgICAgICAgICBpZiAoc2xpZGVJbmRleCA8IDApIHNsaWRlSW5kZXggPSAwO1xuICAgICAgICAgICAgcy5zbmFwSW5kZXggPSBNYXRoLmZsb29yKHNsaWRlSW5kZXggLyBzLnBhcmFtcy5zbGlkZXNQZXJHcm91cCk7XG4gICAgICAgICAgICBpZiAocy5zbmFwSW5kZXggPj0gcy5zbmFwR3JpZC5sZW5ndGgpIHMuc25hcEluZGV4ID0gcy5zbmFwR3JpZC5sZW5ndGggLSAxO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciB0cmFuc2xhdGUgPSAtIHMuc25hcEdyaWRbcy5zbmFwSW5kZXhdO1xuICAgICAgICAgICAgLy8gU3RvcCBhdXRvcGxheVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmF1dG9wbGF5ICYmIHMuYXV0b3BsYXlpbmcpIHtcbiAgICAgICAgICAgICAgICBpZiAoaW50ZXJuYWwgfHwgIXMucGFyYW1zLmF1dG9wbGF5RGlzYWJsZU9uSW50ZXJhY3Rpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcy5wYXVzZUF1dG9wbGF5KHNwZWVkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHMuc3RvcEF1dG9wbGF5KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gVXBkYXRlIHByb2dyZXNzXG4gICAgICAgICAgICBzLnVwZGF0ZVByb2dyZXNzKHRyYW5zbGF0ZSk7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gTm9ybWFsaXplIHNsaWRlSW5kZXhcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcy5zbGlkZXNHcmlkLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaWYgKC0gTWF0aC5mbG9vcih0cmFuc2xhdGUgKiAxMDApID49IE1hdGguZmxvb3Iocy5zbGlkZXNHcmlkW2ldICogMTAwKSkge1xuICAgICAgICAgICAgICAgICAgICBzbGlkZUluZGV4ID0gaTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gRGlyZWN0aW9ucyBsb2Nrc1xuICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5hbGxvd1N3aXBlVG9OZXh0ICYmIHRyYW5zbGF0ZSA8IHMudHJhbnNsYXRlICYmIHRyYW5zbGF0ZSA8IHMubWluVHJhbnNsYXRlKCkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIXMucGFyYW1zLmFsbG93U3dpcGVUb1ByZXYgJiYgdHJhbnNsYXRlID4gcy50cmFuc2xhdGUgJiYgdHJhbnNsYXRlID4gcy5tYXhUcmFuc2xhdGUoKSkge1xuICAgICAgICAgICAgICAgIGlmICgocy5hY3RpdmVJbmRleCB8fCAwKSAhPT0gc2xpZGVJbmRleCApIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBVcGRhdGUgSW5kZXhcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSBzcGVlZCA9IHMucGFyYW1zLnNwZWVkO1xuICAgICAgICAgICAgcy5wcmV2aW91c0luZGV4ID0gcy5hY3RpdmVJbmRleCB8fCAwO1xuICAgICAgICAgICAgcy5hY3RpdmVJbmRleCA9IHNsaWRlSW5kZXg7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKChzLnJ0bCAmJiAtdHJhbnNsYXRlID09PSBzLnRyYW5zbGF0ZSkgfHwgKCFzLnJ0bCAmJiB0cmFuc2xhdGUgPT09IHMudHJhbnNsYXRlKSkge1xuICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBIZWlnaHRcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuYXV0b0hlaWdodCkge1xuICAgICAgICAgICAgICAgICAgICBzLnVwZGF0ZUF1dG9IZWlnaHQoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcy51cGRhdGVDbGFzc2VzKCk7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmVmZmVjdCAhPT0gJ3NsaWRlJykge1xuICAgICAgICAgICAgICAgICAgICBzLnNldFdyYXBwZXJUcmFuc2xhdGUodHJhbnNsYXRlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcy51cGRhdGVDbGFzc2VzKCk7XG4gICAgICAgICAgICBzLm9uVHJhbnNpdGlvblN0YXJ0KHJ1bkNhbGxiYWNrcyk7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHNwZWVkID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNsYXRlKHRyYW5zbGF0ZSk7XG4gICAgICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNpdGlvbigwKTtcbiAgICAgICAgICAgICAgICBzLm9uVHJhbnNpdGlvbkVuZChydW5DYWxsYmFja3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNsYXRlKHRyYW5zbGF0ZSk7XG4gICAgICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNpdGlvbihzcGVlZCk7XG4gICAgICAgICAgICAgICAgaWYgKCFzLmFuaW1hdGluZykge1xuICAgICAgICAgICAgICAgICAgICBzLmFuaW1hdGluZyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIHMud3JhcHBlci50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcykgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5vblRyYW5zaXRpb25FbmQocnVuQ2FsbGJhY2tzKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIHMub25UcmFuc2l0aW9uU3RhcnQgPSBmdW5jdGlvbiAocnVuQ2FsbGJhY2tzKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHJ1bkNhbGxiYWNrcyA9PT0gJ3VuZGVmaW5lZCcpIHJ1bkNhbGxiYWNrcyA9IHRydWU7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuYXV0b0hlaWdodCkge1xuICAgICAgICAgICAgICAgIHMudXBkYXRlQXV0b0hlaWdodCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMubGF6eSkgcy5sYXp5Lm9uVHJhbnNpdGlvblN0YXJ0KCk7XG4gICAgICAgICAgICBpZiAocnVuQ2FsbGJhY2tzKSB7XG4gICAgICAgICAgICAgICAgcy5lbWl0KCdvblRyYW5zaXRpb25TdGFydCcsIHMpO1xuICAgICAgICAgICAgICAgIGlmIChzLmFjdGl2ZUluZGV4ICE9PSBzLnByZXZpb3VzSW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5lbWl0KCdvblNsaWRlQ2hhbmdlU3RhcnQnLCBzKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuYWN0aXZlSW5kZXggPiBzLnByZXZpb3VzSW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuZW1pdCgnb25TbGlkZU5leHRTdGFydCcsIHMpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5lbWl0KCdvblNsaWRlUHJldlN0YXJ0Jywgcyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBzLm9uVHJhbnNpdGlvbkVuZCA9IGZ1bmN0aW9uIChydW5DYWxsYmFja3MpIHtcbiAgICAgICAgICAgIHMuYW5pbWF0aW5nID0gZmFsc2U7XG4gICAgICAgICAgICBzLnNldFdyYXBwZXJUcmFuc2l0aW9uKDApO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBydW5DYWxsYmFja3MgPT09ICd1bmRlZmluZWQnKSBydW5DYWxsYmFja3MgPSB0cnVlO1xuICAgICAgICAgICAgaWYgKHMubGF6eSkgcy5sYXp5Lm9uVHJhbnNpdGlvbkVuZCgpO1xuICAgICAgICAgICAgaWYgKHJ1bkNhbGxiYWNrcykge1xuICAgICAgICAgICAgICAgIHMuZW1pdCgnb25UcmFuc2l0aW9uRW5kJywgcyk7XG4gICAgICAgICAgICAgICAgaWYgKHMuYWN0aXZlSW5kZXggIT09IHMucHJldmlvdXNJbmRleCkge1xuICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uU2xpZGVDaGFuZ2VFbmQnLCBzKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuYWN0aXZlSW5kZXggPiBzLnByZXZpb3VzSW5kZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuZW1pdCgnb25TbGlkZU5leHRFbmQnLCBzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuZW1pdCgnb25TbGlkZVByZXZFbmQnLCBzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5oYXNobmF2ICYmIHMuaGFzaG5hdikge1xuICAgICAgICAgICAgICAgIHMuaGFzaG5hdi5zZXRIYXNoKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB9O1xuICAgICAgICBzLnNsaWRlTmV4dCA9IGZ1bmN0aW9uIChydW5DYWxsYmFja3MsIHNwZWVkLCBpbnRlcm5hbCkge1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICBpZiAocy5hbmltYXRpbmcpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICBzLmZpeExvb3AoKTtcbiAgICAgICAgICAgICAgICB2YXIgY2xpZW50TGVmdCA9IHMuY29udGFpbmVyWzBdLmNsaWVudExlZnQ7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHMuc2xpZGVUbyhzLmFjdGl2ZUluZGV4ICsgcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXAsIHNwZWVkLCBydW5DYWxsYmFja3MsIGludGVybmFsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgcmV0dXJuIHMuc2xpZGVUbyhzLmFjdGl2ZUluZGV4ICsgcy5wYXJhbXMuc2xpZGVzUGVyR3JvdXAsIHNwZWVkLCBydW5DYWxsYmFja3MsIGludGVybmFsKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5fc2xpZGVOZXh0ID0gZnVuY3Rpb24gKHNwZWVkKSB7XG4gICAgICAgICAgICByZXR1cm4gcy5zbGlkZU5leHQodHJ1ZSwgc3BlZWQsIHRydWUpO1xuICAgICAgICB9O1xuICAgICAgICBzLnNsaWRlUHJldiA9IGZ1bmN0aW9uIChydW5DYWxsYmFja3MsIHNwZWVkLCBpbnRlcm5hbCkge1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICBpZiAocy5hbmltYXRpbmcpIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgICAgICBzLmZpeExvb3AoKTtcbiAgICAgICAgICAgICAgICB2YXIgY2xpZW50TGVmdCA9IHMuY29udGFpbmVyWzBdLmNsaWVudExlZnQ7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHMuc2xpZGVUbyhzLmFjdGl2ZUluZGV4IC0gMSwgc3BlZWQsIHJ1bkNhbGxiYWNrcywgaW50ZXJuYWwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSByZXR1cm4gcy5zbGlkZVRvKHMuYWN0aXZlSW5kZXggLSAxLCBzcGVlZCwgcnVuQ2FsbGJhY2tzLCBpbnRlcm5hbCk7XG4gICAgICAgIH07XG4gICAgICAgIHMuX3NsaWRlUHJldiA9IGZ1bmN0aW9uIChzcGVlZCkge1xuICAgICAgICAgICAgcmV0dXJuIHMuc2xpZGVQcmV2KHRydWUsIHNwZWVkLCB0cnVlKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5zbGlkZVJlc2V0ID0gZnVuY3Rpb24gKHJ1bkNhbGxiYWNrcywgc3BlZWQsIGludGVybmFsKSB7XG4gICAgICAgICAgICByZXR1cm4gcy5zbGlkZVRvKHMuYWN0aXZlSW5kZXgsIHNwZWVkLCBydW5DYWxsYmFja3MpO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgVHJhbnNsYXRlL3RyYW5zaXRpb24gaGVscGVyc1xuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMuc2V0V3JhcHBlclRyYW5zaXRpb24gPSBmdW5jdGlvbiAoZHVyYXRpb24sIGJ5Q29udHJvbGxlcikge1xuICAgICAgICAgICAgcy53cmFwcGVyLnRyYW5zaXRpb24oZHVyYXRpb24pO1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmVmZmVjdCAhPT0gJ3NsaWRlJyAmJiBzLmVmZmVjdHNbcy5wYXJhbXMuZWZmZWN0XSkge1xuICAgICAgICAgICAgICAgIHMuZWZmZWN0c1tzLnBhcmFtcy5lZmZlY3RdLnNldFRyYW5zaXRpb24oZHVyYXRpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnBhcmFsbGF4ICYmIHMucGFyYWxsYXgpIHtcbiAgICAgICAgICAgICAgICBzLnBhcmFsbGF4LnNldFRyYW5zaXRpb24oZHVyYXRpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNjcm9sbGJhciAmJiBzLnNjcm9sbGJhcikge1xuICAgICAgICAgICAgICAgIHMuc2Nyb2xsYmFyLnNldFRyYW5zaXRpb24oZHVyYXRpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmNvbnRyb2wgJiYgcy5jb250cm9sbGVyKSB7XG4gICAgICAgICAgICAgICAgcy5jb250cm9sbGVyLnNldFRyYW5zaXRpb24oZHVyYXRpb24sIGJ5Q29udHJvbGxlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzLmVtaXQoJ29uU2V0VHJhbnNpdGlvbicsIHMsIGR1cmF0aW9uKTtcbiAgICAgICAgfTtcbiAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNsYXRlID0gZnVuY3Rpb24gKHRyYW5zbGF0ZSwgdXBkYXRlQWN0aXZlSW5kZXgsIGJ5Q29udHJvbGxlcikge1xuICAgICAgICAgICAgdmFyIHggPSAwLCB5ID0gMCwgeiA9IDA7XG4gICAgICAgICAgICBpZiAocy5pc0hvcml6b250YWwoKSkge1xuICAgICAgICAgICAgICAgIHggPSBzLnJ0bCA/IC10cmFuc2xhdGUgOiB0cmFuc2xhdGU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB5ID0gdHJhbnNsYXRlO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5yb3VuZExlbmd0aHMpIHtcbiAgICAgICAgICAgICAgICB4ID0gcm91bmQoeCk7XG4gICAgICAgICAgICAgICAgeSA9IHJvdW5kKHkpO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGlmICghcy5wYXJhbXMudmlydHVhbFRyYW5zbGF0ZSkge1xuICAgICAgICAgICAgICAgIGlmIChzLnN1cHBvcnQudHJhbnNmb3JtczNkKSBzLndyYXBwZXIudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgeCArICdweCwgJyArIHkgKyAncHgsICcgKyB6ICsgJ3B4KScpO1xuICAgICAgICAgICAgICAgIGVsc2Ugcy53cmFwcGVyLnRyYW5zZm9ybSgndHJhbnNsYXRlKCcgKyB4ICsgJ3B4LCAnICsgeSArICdweCknKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBzLnRyYW5zbGF0ZSA9IHMuaXNIb3Jpem9udGFsKCkgPyB4IDogeTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBDaGVjayBpZiB3ZSBuZWVkIHRvIHVwZGF0ZSBwcm9ncmVzc1xuICAgICAgICAgICAgdmFyIHByb2dyZXNzO1xuICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZXNEaWZmID0gcy5tYXhUcmFuc2xhdGUoKSAtIHMubWluVHJhbnNsYXRlKCk7XG4gICAgICAgICAgICBpZiAodHJhbnNsYXRlc0RpZmYgPT09IDApIHtcbiAgICAgICAgICAgICAgICBwcm9ncmVzcyA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBwcm9ncmVzcyA9ICh0cmFuc2xhdGUgLSBzLm1pblRyYW5zbGF0ZSgpKSAvICh0cmFuc2xhdGVzRGlmZik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocHJvZ3Jlc3MgIT09IHMucHJvZ3Jlc3MpIHtcbiAgICAgICAgICAgICAgICBzLnVwZGF0ZVByb2dyZXNzKHRyYW5zbGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHVwZGF0ZUFjdGl2ZUluZGV4KSBzLnVwZGF0ZUFjdGl2ZUluZGV4KCk7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuZWZmZWN0ICE9PSAnc2xpZGUnICYmIHMuZWZmZWN0c1tzLnBhcmFtcy5lZmZlY3RdKSB7XG4gICAgICAgICAgICAgICAgcy5lZmZlY3RzW3MucGFyYW1zLmVmZmVjdF0uc2V0VHJhbnNsYXRlKHMudHJhbnNsYXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wYXJhbGxheCAmJiBzLnBhcmFsbGF4KSB7XG4gICAgICAgICAgICAgICAgcy5wYXJhbGxheC5zZXRUcmFuc2xhdGUocy50cmFuc2xhdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNjcm9sbGJhciAmJiBzLnNjcm9sbGJhcikge1xuICAgICAgICAgICAgICAgIHMuc2Nyb2xsYmFyLnNldFRyYW5zbGF0ZShzLnRyYW5zbGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuY29udHJvbCAmJiBzLmNvbnRyb2xsZXIpIHtcbiAgICAgICAgICAgICAgICBzLmNvbnRyb2xsZXIuc2V0VHJhbnNsYXRlKHMudHJhbnNsYXRlLCBieUNvbnRyb2xsZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcy5lbWl0KCdvblNldFRyYW5zbGF0ZScsIHMsIHMudHJhbnNsYXRlKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIHMuZ2V0VHJhbnNsYXRlID0gZnVuY3Rpb24gKGVsLCBheGlzKSB7XG4gICAgICAgICAgICB2YXIgbWF0cml4LCBjdXJUcmFuc2Zvcm0sIGN1clN0eWxlLCB0cmFuc2Zvcm1NYXRyaXg7XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gYXV0b21hdGljIGF4aXMgZGV0ZWN0aW9uXG4gICAgICAgICAgICBpZiAodHlwZW9mIGF4aXMgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgYXhpcyA9ICd4JztcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAocy5wYXJhbXMudmlydHVhbFRyYW5zbGF0ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzLnJ0bCA/IC1zLnRyYW5zbGF0ZSA6IHMudHJhbnNsYXRlO1xuICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgIGN1clN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwsIG51bGwpO1xuICAgICAgICAgICAgaWYgKHdpbmRvdy5XZWJLaXRDU1NNYXRyaXgpIHtcbiAgICAgICAgICAgICAgICBjdXJUcmFuc2Zvcm0gPSBjdXJTdHlsZS50cmFuc2Zvcm0gfHwgY3VyU3R5bGUud2Via2l0VHJhbnNmb3JtO1xuICAgICAgICAgICAgICAgIGlmIChjdXJUcmFuc2Zvcm0uc3BsaXQoJywnKS5sZW5ndGggPiA2KSB7XG4gICAgICAgICAgICAgICAgICAgIGN1clRyYW5zZm9ybSA9IGN1clRyYW5zZm9ybS5zcGxpdCgnLCAnKS5tYXAoZnVuY3Rpb24oYSl7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYS5yZXBsYWNlKCcsJywnLicpO1xuICAgICAgICAgICAgICAgICAgICB9KS5qb2luKCcsICcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBTb21lIG9sZCB2ZXJzaW9ucyBvZiBXZWJraXQgY2hva2Ugd2hlbiAnbm9uZScgaXMgcGFzc2VkOyBwYXNzXG4gICAgICAgICAgICAgICAgLy8gZW1wdHkgc3RyaW5nIGluc3RlYWQgaW4gdGhpcyBjYXNlXG4gICAgICAgICAgICAgICAgdHJhbnNmb3JtTWF0cml4ID0gbmV3IHdpbmRvdy5XZWJLaXRDU1NNYXRyaXgoY3VyVHJhbnNmb3JtID09PSAnbm9uZScgPyAnJyA6IGN1clRyYW5zZm9ybSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0cmFuc2Zvcm1NYXRyaXggPSBjdXJTdHlsZS5Nb3pUcmFuc2Zvcm0gfHwgY3VyU3R5bGUuT1RyYW5zZm9ybSB8fCBjdXJTdHlsZS5Nc1RyYW5zZm9ybSB8fCBjdXJTdHlsZS5tc1RyYW5zZm9ybSAgfHwgY3VyU3R5bGUudHJhbnNmb3JtIHx8IGN1clN0eWxlLmdldFByb3BlcnR5VmFsdWUoJ3RyYW5zZm9ybScpLnJlcGxhY2UoJ3RyYW5zbGF0ZSgnLCAnbWF0cml4KDEsIDAsIDAsIDEsJyk7XG4gICAgICAgICAgICAgICAgbWF0cml4ID0gdHJhbnNmb3JtTWF0cml4LnRvU3RyaW5nKCkuc3BsaXQoJywnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoYXhpcyA9PT0gJ3gnKSB7XG4gICAgICAgICAgICAgICAgLy9MYXRlc3QgQ2hyb21lIGFuZCB3ZWJraXRzIEZpeFxuICAgICAgICAgICAgICAgIGlmICh3aW5kb3cuV2ViS2l0Q1NTTWF0cml4KVxuICAgICAgICAgICAgICAgICAgICBjdXJUcmFuc2Zvcm0gPSB0cmFuc2Zvcm1NYXRyaXgubTQxO1xuICAgICAgICAgICAgICAgIC8vQ3JhenkgSUUxMCBNYXRyaXhcbiAgICAgICAgICAgICAgICBlbHNlIGlmIChtYXRyaXgubGVuZ3RoID09PSAxNilcbiAgICAgICAgICAgICAgICAgICAgY3VyVHJhbnNmb3JtID0gcGFyc2VGbG9hdChtYXRyaXhbMTJdKTtcbiAgICAgICAgICAgICAgICAvL05vcm1hbCBCcm93c2Vyc1xuICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAgY3VyVHJhbnNmb3JtID0gcGFyc2VGbG9hdChtYXRyaXhbNF0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGF4aXMgPT09ICd5Jykge1xuICAgICAgICAgICAgICAgIC8vTGF0ZXN0IENocm9tZSBhbmQgd2Via2l0cyBGaXhcbiAgICAgICAgICAgICAgICBpZiAod2luZG93LldlYktpdENTU01hdHJpeClcbiAgICAgICAgICAgICAgICAgICAgY3VyVHJhbnNmb3JtID0gdHJhbnNmb3JtTWF0cml4Lm00MjtcbiAgICAgICAgICAgICAgICAvL0NyYXp5IElFMTAgTWF0cml4XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAobWF0cml4Lmxlbmd0aCA9PT0gMTYpXG4gICAgICAgICAgICAgICAgICAgIGN1clRyYW5zZm9ybSA9IHBhcnNlRmxvYXQobWF0cml4WzEzXSk7XG4gICAgICAgICAgICAgICAgLy9Ob3JtYWwgQnJvd3NlcnNcbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIGN1clRyYW5zZm9ybSA9IHBhcnNlRmxvYXQobWF0cml4WzVdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnJ0bCAmJiBjdXJUcmFuc2Zvcm0pIGN1clRyYW5zZm9ybSA9IC1jdXJUcmFuc2Zvcm07XG4gICAgICAgICAgICByZXR1cm4gY3VyVHJhbnNmb3JtIHx8IDA7XG4gICAgICAgIH07XG4gICAgICAgIHMuZ2V0V3JhcHBlclRyYW5zbGF0ZSA9IGZ1bmN0aW9uIChheGlzKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGF4aXMgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgYXhpcyA9IHMuaXNIb3Jpem9udGFsKCkgPyAneCcgOiAneSc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcy5nZXRUcmFuc2xhdGUocy53cmFwcGVyWzBdLCBheGlzKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIE9ic2VydmVyXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgcy5vYnNlcnZlcnMgPSBbXTtcbiAgICAgICAgZnVuY3Rpb24gaW5pdE9ic2VydmVyKHRhcmdldCwgb3B0aW9ucykge1xuICAgICAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307XG4gICAgICAgICAgICAvLyBjcmVhdGUgYW4gb2JzZXJ2ZXIgaW5zdGFuY2VcbiAgICAgICAgICAgIHZhciBPYnNlcnZlckZ1bmMgPSB3aW5kb3cuTXV0YXRpb25PYnNlcnZlciB8fCB3aW5kb3cuV2Via2l0TXV0YXRpb25PYnNlcnZlcjtcbiAgICAgICAgICAgIHZhciBvYnNlcnZlciA9IG5ldyBPYnNlcnZlckZ1bmMoZnVuY3Rpb24gKG11dGF0aW9ucykge1xuICAgICAgICAgICAgICAgIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChtdXRhdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBzLm9uUmVzaXplKHRydWUpO1xuICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uT2JzZXJ2ZXJVcGRhdGUnLCBzLCBtdXRhdGlvbik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICBvYnNlcnZlci5vYnNlcnZlKHRhcmdldCwge1xuICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXM6IHR5cGVvZiBvcHRpb25zLmF0dHJpYnV0ZXMgPT09ICd1bmRlZmluZWQnID8gdHJ1ZSA6IG9wdGlvbnMuYXR0cmlidXRlcyxcbiAgICAgICAgICAgICAgICBjaGlsZExpc3Q6IHR5cGVvZiBvcHRpb25zLmNoaWxkTGlzdCA9PT0gJ3VuZGVmaW5lZCcgPyB0cnVlIDogb3B0aW9ucy5jaGlsZExpc3QsXG4gICAgICAgICAgICAgICAgY2hhcmFjdGVyRGF0YTogdHlwZW9mIG9wdGlvbnMuY2hhcmFjdGVyRGF0YSA9PT0gJ3VuZGVmaW5lZCcgPyB0cnVlIDogb3B0aW9ucy5jaGFyYWN0ZXJEYXRhXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICBzLm9ic2VydmVycy5wdXNoKG9ic2VydmVyKTtcbiAgICAgICAgfVxuICAgICAgICBzLmluaXRPYnNlcnZlcnMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMub2JzZXJ2ZVBhcmVudHMpIHtcbiAgICAgICAgICAgICAgICB2YXIgY29udGFpbmVyUGFyZW50cyA9IHMuY29udGFpbmVyLnBhcmVudHMoKTtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbnRhaW5lclBhcmVudHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgaW5pdE9ic2VydmVyKGNvbnRhaW5lclBhcmVudHNbaV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAvLyBPYnNlcnZlIGNvbnRhaW5lclxuICAgICAgICAgICAgaW5pdE9ic2VydmVyKHMuY29udGFpbmVyWzBdLCB7Y2hpbGRMaXN0OiBmYWxzZX0pO1xuICAgICAgICBcbiAgICAgICAgICAgIC8vIE9ic2VydmUgd3JhcHBlclxuICAgICAgICAgICAgaW5pdE9ic2VydmVyKHMud3JhcHBlclswXSwge2F0dHJpYnV0ZXM6IGZhbHNlfSk7XG4gICAgICAgIH07XG4gICAgICAgIHMuZGlzY29ubmVjdE9ic2VydmVycyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcy5vYnNlcnZlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBzLm9ic2VydmVyc1tpXS5kaXNjb25uZWN0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzLm9ic2VydmVycyA9IFtdO1xuICAgICAgICB9O1xuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBMb29wXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgLy8gQ3JlYXRlIGxvb3BlZCBzbGlkZXNcbiAgICAgICAgcy5jcmVhdGVMb29wID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZWQgc2xpZGVzXG4gICAgICAgICAgICBzLndyYXBwZXIuY2hpbGRyZW4oJy4nICsgcy5wYXJhbXMuc2xpZGVDbGFzcyArICcuJyArIHMucGFyYW1zLnNsaWRlRHVwbGljYXRlQ2xhc3MpLnJlbW92ZSgpO1xuICAgICAgICBcbiAgICAgICAgICAgIHZhciBzbGlkZXMgPSBzLndyYXBwZXIuY2hpbGRyZW4oJy4nICsgcy5wYXJhbXMuc2xpZGVDbGFzcyk7XG4gICAgICAgIFxuICAgICAgICAgICAgaWYocy5wYXJhbXMuc2xpZGVzUGVyVmlldyA9PT0gJ2F1dG8nICYmICFzLnBhcmFtcy5sb29wZWRTbGlkZXMpIHMucGFyYW1zLmxvb3BlZFNsaWRlcyA9IHNsaWRlcy5sZW5ndGg7XG4gICAgICAgIFxuICAgICAgICAgICAgcy5sb29wZWRTbGlkZXMgPSBwYXJzZUludChzLnBhcmFtcy5sb29wZWRTbGlkZXMgfHwgcy5wYXJhbXMuc2xpZGVzUGVyVmlldywgMTApO1xuICAgICAgICAgICAgcy5sb29wZWRTbGlkZXMgPSBzLmxvb3BlZFNsaWRlcyArIHMucGFyYW1zLmxvb3BBZGRpdGlvbmFsU2xpZGVzO1xuICAgICAgICAgICAgaWYgKHMubG9vcGVkU2xpZGVzID4gc2xpZGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHMubG9vcGVkU2xpZGVzID0gc2xpZGVzLmxlbmd0aDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICB2YXIgcHJlcGVuZFNsaWRlcyA9IFtdLCBhcHBlbmRTbGlkZXMgPSBbXSwgaTtcbiAgICAgICAgICAgIHNsaWRlcy5lYWNoKGZ1bmN0aW9uIChpbmRleCwgZWwpIHtcbiAgICAgICAgICAgICAgICB2YXIgc2xpZGUgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgIGlmIChpbmRleCA8IHMubG9vcGVkU2xpZGVzKSBhcHBlbmRTbGlkZXMucHVzaChlbCk7XG4gICAgICAgICAgICAgICAgaWYgKGluZGV4IDwgc2xpZGVzLmxlbmd0aCAmJiBpbmRleCA+PSBzbGlkZXMubGVuZ3RoIC0gcy5sb29wZWRTbGlkZXMpIHByZXBlbmRTbGlkZXMucHVzaChlbCk7XG4gICAgICAgICAgICAgICAgc2xpZGUuYXR0cignZGF0YS1zd2lwZXItc2xpZGUtaW5kZXgnLCBpbmRleCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBhcHBlbmRTbGlkZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBzLndyYXBwZXIuYXBwZW5kKCQoYXBwZW5kU2xpZGVzW2ldLmNsb25lTm9kZSh0cnVlKSkuYWRkQ2xhc3Mocy5wYXJhbXMuc2xpZGVEdXBsaWNhdGVDbGFzcykpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZm9yIChpID0gcHJlcGVuZFNsaWRlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICAgICAgICAgIHMud3JhcHBlci5wcmVwZW5kKCQocHJlcGVuZFNsaWRlc1tpXS5jbG9uZU5vZGUodHJ1ZSkpLmFkZENsYXNzKHMucGFyYW1zLnNsaWRlRHVwbGljYXRlQ2xhc3MpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgcy5kZXN0cm95TG9vcCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHMud3JhcHBlci5jaGlsZHJlbignLicgKyBzLnBhcmFtcy5zbGlkZUNsYXNzICsgJy4nICsgcy5wYXJhbXMuc2xpZGVEdXBsaWNhdGVDbGFzcykucmVtb3ZlKCk7XG4gICAgICAgICAgICBzLnNsaWRlcy5yZW1vdmVBdHRyKCdkYXRhLXN3aXBlci1zbGlkZS1pbmRleCcpO1xuICAgICAgICB9O1xuICAgICAgICBzLnJlTG9vcCA9IGZ1bmN0aW9uICh1cGRhdGVQb3NpdGlvbikge1xuICAgICAgICAgICAgdmFyIG9sZEluZGV4ID0gcy5hY3RpdmVJbmRleCAtIHMubG9vcGVkU2xpZGVzO1xuICAgICAgICAgICAgcy5kZXN0cm95TG9vcCgpO1xuICAgICAgICAgICAgcy5jcmVhdGVMb29wKCk7XG4gICAgICAgICAgICBzLnVwZGF0ZVNsaWRlc1NpemUoKTtcbiAgICAgICAgICAgIGlmICh1cGRhdGVQb3NpdGlvbikge1xuICAgICAgICAgICAgICAgIHMuc2xpZGVUbyhvbGRJbmRleCArIHMubG9vcGVkU2xpZGVzLCAwLCBmYWxzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB9O1xuICAgICAgICBzLmZpeExvb3AgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgbmV3SW5kZXg7XG4gICAgICAgICAgICAvL0ZpeCBGb3IgTmVnYXRpdmUgT3ZlcnNsaWRpbmdcbiAgICAgICAgICAgIGlmIChzLmFjdGl2ZUluZGV4IDwgcy5sb29wZWRTbGlkZXMpIHtcbiAgICAgICAgICAgICAgICBuZXdJbmRleCA9IHMuc2xpZGVzLmxlbmd0aCAtIHMubG9vcGVkU2xpZGVzICogMyArIHMuYWN0aXZlSW5kZXg7XG4gICAgICAgICAgICAgICAgbmV3SW5kZXggPSBuZXdJbmRleCArIHMubG9vcGVkU2xpZGVzO1xuICAgICAgICAgICAgICAgIHMuc2xpZGVUbyhuZXdJbmRleCwgMCwgZmFsc2UsIHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy9GaXggRm9yIFBvc2l0aXZlIE92ZXJzbGlkaW5nXG4gICAgICAgICAgICBlbHNlIGlmICgocy5wYXJhbXMuc2xpZGVzUGVyVmlldyA9PT0gJ2F1dG8nICYmIHMuYWN0aXZlSW5kZXggPj0gcy5sb29wZWRTbGlkZXMgKiAyKSB8fCAocy5hY3RpdmVJbmRleCA+IHMuc2xpZGVzLmxlbmd0aCAtIHMucGFyYW1zLnNsaWRlc1BlclZpZXcgKiAyKSkge1xuICAgICAgICAgICAgICAgIG5ld0luZGV4ID0gLXMuc2xpZGVzLmxlbmd0aCArIHMuYWN0aXZlSW5kZXggKyBzLmxvb3BlZFNsaWRlcztcbiAgICAgICAgICAgICAgICBuZXdJbmRleCA9IG5ld0luZGV4ICsgcy5sb29wZWRTbGlkZXM7XG4gICAgICAgICAgICAgICAgcy5zbGlkZVRvKG5ld0luZGV4LCAwLCBmYWxzZSwgdHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIEFwcGVuZC9QcmVwZW5kL1JlbW92ZSBTbGlkZXNcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLmFwcGVuZFNsaWRlID0gZnVuY3Rpb24gKHNsaWRlcykge1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICBzLmRlc3Ryb3lMb29wKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodHlwZW9mIHNsaWRlcyA9PT0gJ29iamVjdCcgJiYgc2xpZGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2xpZGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzbGlkZXNbaV0pIHMud3JhcHBlci5hcHBlbmQoc2xpZGVzW2ldKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzLndyYXBwZXIuYXBwZW5kKHNsaWRlcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMubG9vcCkge1xuICAgICAgICAgICAgICAgIHMuY3JlYXRlTG9vcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCEocy5wYXJhbXMub2JzZXJ2ZXIgJiYgcy5zdXBwb3J0Lm9ic2VydmVyKSkge1xuICAgICAgICAgICAgICAgIHMudXBkYXRlKHRydWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBzLnByZXBlbmRTbGlkZSA9IGZ1bmN0aW9uIChzbGlkZXMpIHtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5sb29wKSB7XG4gICAgICAgICAgICAgICAgcy5kZXN0cm95TG9vcCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIG5ld0FjdGl2ZUluZGV4ID0gcy5hY3RpdmVJbmRleCArIDE7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHNsaWRlcyA9PT0gJ29iamVjdCcgJiYgc2xpZGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2xpZGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzbGlkZXNbaV0pIHMud3JhcHBlci5wcmVwZW5kKHNsaWRlc1tpXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG5ld0FjdGl2ZUluZGV4ID0gcy5hY3RpdmVJbmRleCArIHNsaWRlcy5sZW5ndGg7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzLndyYXBwZXIucHJlcGVuZChzbGlkZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICBzLmNyZWF0ZUxvb3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghKHMucGFyYW1zLm9ic2VydmVyICYmIHMuc3VwcG9ydC5vYnNlcnZlcikpIHtcbiAgICAgICAgICAgICAgICBzLnVwZGF0ZSh0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHMuc2xpZGVUbyhuZXdBY3RpdmVJbmRleCwgMCwgZmFsc2UpO1xuICAgICAgICB9O1xuICAgICAgICBzLnJlbW92ZVNsaWRlID0gZnVuY3Rpb24gKHNsaWRlc0luZGV4ZXMpIHtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5sb29wKSB7XG4gICAgICAgICAgICAgICAgcy5kZXN0cm95TG9vcCgpO1xuICAgICAgICAgICAgICAgIHMuc2xpZGVzID0gcy53cmFwcGVyLmNoaWxkcmVuKCcuJyArIHMucGFyYW1zLnNsaWRlQ2xhc3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIG5ld0FjdGl2ZUluZGV4ID0gcy5hY3RpdmVJbmRleCxcbiAgICAgICAgICAgICAgICBpbmRleFRvUmVtb3ZlO1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBzbGlkZXNJbmRleGVzID09PSAnb2JqZWN0JyAmJiBzbGlkZXNJbmRleGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2xpZGVzSW5kZXhlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBpbmRleFRvUmVtb3ZlID0gc2xpZGVzSW5kZXhlc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuc2xpZGVzW2luZGV4VG9SZW1vdmVdKSBzLnNsaWRlcy5lcShpbmRleFRvUmVtb3ZlKS5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4VG9SZW1vdmUgPCBuZXdBY3RpdmVJbmRleCkgbmV3QWN0aXZlSW5kZXgtLTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgbmV3QWN0aXZlSW5kZXggPSBNYXRoLm1heChuZXdBY3RpdmVJbmRleCwgMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpbmRleFRvUmVtb3ZlID0gc2xpZGVzSW5kZXhlcztcbiAgICAgICAgICAgICAgICBpZiAocy5zbGlkZXNbaW5kZXhUb1JlbW92ZV0pIHMuc2xpZGVzLmVxKGluZGV4VG9SZW1vdmUpLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgIGlmIChpbmRleFRvUmVtb3ZlIDwgbmV3QWN0aXZlSW5kZXgpIG5ld0FjdGl2ZUluZGV4LS07XG4gICAgICAgICAgICAgICAgbmV3QWN0aXZlSW5kZXggPSBNYXRoLm1heChuZXdBY3RpdmVJbmRleCwgMCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICBzLmNyZWF0ZUxvb3AoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoIShzLnBhcmFtcy5vYnNlcnZlciAmJiBzLnN1cHBvcnQub2JzZXJ2ZXIpKSB7XG4gICAgICAgICAgICAgICAgcy51cGRhdGUodHJ1ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMubG9vcCkge1xuICAgICAgICAgICAgICAgIHMuc2xpZGVUbyhuZXdBY3RpdmVJbmRleCArIHMubG9vcGVkU2xpZGVzLCAwLCBmYWxzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBzLnNsaWRlVG8obmV3QWN0aXZlSW5kZXgsIDAsIGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIH07XG4gICAgICAgIHMucmVtb3ZlQWxsU2xpZGVzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIHNsaWRlc0luZGV4ZXMgPSBbXTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcy5zbGlkZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBzbGlkZXNJbmRleGVzLnB1c2goaSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzLnJlbW92ZVNsaWRlKHNsaWRlc0luZGV4ZXMpO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgRWZmZWN0c1xuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMuZWZmZWN0cyA9IHtcbiAgICAgICAgICAgIGZhZGU6IHtcbiAgICAgICAgICAgICAgICBzZXRUcmFuc2xhdGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzLnNsaWRlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRlID0gcy5zbGlkZXMuZXEoaSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2Zmc2V0ID0gc2xpZGVbMF0uc3dpcGVyU2xpZGVPZmZzZXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHggPSAtb2Zmc2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy52aXJ0dWFsVHJhbnNsYXRlKSB0eCA9IHR4IC0gcy50cmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHkgPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzLmlzSG9yaXpvbnRhbCgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHkgPSB0eDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eCA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGVPcGFjaXR5ID0gcy5wYXJhbXMuZmFkZS5jcm9zc0ZhZGUgP1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXRoLm1heCgxIC0gTWF0aC5hYnMoc2xpZGVbMF0ucHJvZ3Jlc3MpLCAwKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDEgKyBNYXRoLm1pbihNYXRoLm1heChzbGlkZVswXS5wcm9ncmVzcywgLTEpLCAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IHNsaWRlT3BhY2l0eVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRyYW5zZm9ybSgndHJhbnNsYXRlM2QoJyArIHR4ICsgJ3B4LCAnICsgdHkgKyAncHgsIDBweCknKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzZXRUcmFuc2l0aW9uOiBmdW5jdGlvbiAoZHVyYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcy5zbGlkZXMudHJhbnNpdGlvbihkdXJhdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy52aXJ0dWFsVHJhbnNsYXRlICYmIGR1cmF0aW9uICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnRUcmlnZ2VyZWQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuc2xpZGVzLnRyYW5zaXRpb25FbmQoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudFRyaWdnZXJlZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcykgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50VHJpZ2dlcmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLmFuaW1hdGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmlnZ2VyRXZlbnRzID0gWyd3ZWJraXRUcmFuc2l0aW9uRW5kJywgJ3RyYW5zaXRpb25lbmQnLCAnb1RyYW5zaXRpb25FbmQnLCAnTVNUcmFuc2l0aW9uRW5kJywgJ21zVHJhbnNpdGlvbkVuZCddO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHJpZ2dlckV2ZW50cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLndyYXBwZXIudHJpZ2dlcih0cmlnZ2VyRXZlbnRzW2ldKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmbGlwOiB7XG4gICAgICAgICAgICAgICAgc2V0VHJhbnNsYXRlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcy5zbGlkZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGlkZSA9IHMuc2xpZGVzLmVxKGkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByb2dyZXNzID0gc2xpZGVbMF0ucHJvZ3Jlc3M7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuZmxpcC5saW1pdFJvdGF0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MgPSBNYXRoLm1heChNYXRoLm1pbihzbGlkZVswXS5wcm9ncmVzcywgMSksIC0xKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvZmZzZXQgPSBzbGlkZVswXS5zd2lwZXJTbGlkZU9mZnNldDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByb3RhdGUgPSAtMTgwICogcHJvZ3Jlc3MsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRlWSA9IHJvdGF0ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3RhdGVYID0gMCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eCA9IC1vZmZzZXQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHkgPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzLmlzSG9yaXpvbnRhbCgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHkgPSB0eDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eCA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcm90YXRlWCA9IC1yb3RhdGVZO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvdGF0ZVkgPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAocy5ydGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3RhdGVZID0gLXJvdGF0ZVk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGVbMF0uc3R5bGUuekluZGV4ID0gLU1hdGguYWJzKE1hdGgucm91bmQocHJvZ3Jlc3MpKSArIHMuc2xpZGVzLmxlbmd0aDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuZmxpcC5zbGlkZVNoYWRvd3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL1NldCBzaGFkb3dzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNoYWRvd0JlZm9yZSA9IHMuaXNIb3Jpem9udGFsKCkgPyBzbGlkZS5maW5kKCcuc3dpcGVyLXNsaWRlLXNoYWRvdy1sZWZ0JykgOiBzbGlkZS5maW5kKCcuc3dpcGVyLXNsaWRlLXNoYWRvdy10b3AnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2hhZG93QWZ0ZXIgPSBzLmlzSG9yaXpvbnRhbCgpID8gc2xpZGUuZmluZCgnLnN3aXBlci1zbGlkZS1zaGFkb3ctcmlnaHQnKSA6IHNsaWRlLmZpbmQoJy5zd2lwZXItc2xpZGUtc2hhZG93LWJvdHRvbScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGFkb3dCZWZvcmUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRvd0JlZm9yZSA9ICQoJzxkaXYgY2xhc3M9XCJzd2lwZXItc2xpZGUtc2hhZG93LScgKyAocy5pc0hvcml6b250YWwoKSA/ICdsZWZ0JyA6ICd0b3AnKSArICdcIj48L2Rpdj4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGUuYXBwZW5kKHNoYWRvd0JlZm9yZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGFkb3dBZnRlci5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhZG93QWZ0ZXIgPSAkKCc8ZGl2IGNsYXNzPVwic3dpcGVyLXNsaWRlLXNoYWRvdy0nICsgKHMuaXNIb3Jpem9udGFsKCkgPyAncmlnaHQnIDogJ2JvdHRvbScpICsgJ1wiPjwvZGl2PicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGlkZS5hcHBlbmQoc2hhZG93QWZ0ZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hhZG93QmVmb3JlLmxlbmd0aCkgc2hhZG93QmVmb3JlWzBdLnN0eWxlLm9wYWNpdHkgPSBNYXRoLm1heCgtcHJvZ3Jlc3MsIDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGFkb3dBZnRlci5sZW5ndGgpIHNoYWRvd0FmdGVyWzBdLnN0eWxlLm9wYWNpdHkgPSBNYXRoLm1heChwcm9ncmVzcywgMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgdHggKyAncHgsICcgKyB0eSArICdweCwgMHB4KSByb3RhdGVYKCcgKyByb3RhdGVYICsgJ2RlZykgcm90YXRlWSgnICsgcm90YXRlWSArICdkZWcpJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNldFRyYW5zaXRpb246IGZ1bmN0aW9uIChkdXJhdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBzLnNsaWRlcy50cmFuc2l0aW9uKGR1cmF0aW9uKS5maW5kKCcuc3dpcGVyLXNsaWRlLXNoYWRvdy10b3AsIC5zd2lwZXItc2xpZGUtc2hhZG93LXJpZ2h0LCAuc3dpcGVyLXNsaWRlLXNoYWRvdy1ib3R0b20sIC5zd2lwZXItc2xpZGUtc2hhZG93LWxlZnQnKS50cmFuc2l0aW9uKGR1cmF0aW9uKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnZpcnR1YWxUcmFuc2xhdGUgJiYgZHVyYXRpb24gIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBldmVudFRyaWdnZXJlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5zbGlkZXMuZXEocy5hY3RpdmVJbmRleCkudHJhbnNpdGlvbkVuZChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGV2ZW50VHJpZ2dlcmVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCEkKHRoaXMpLmhhc0NsYXNzKHMucGFyYW1zLnNsaWRlQWN0aXZlQ2xhc3MpKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnRUcmlnZ2VyZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMuYW5pbWF0aW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHRyaWdnZXJFdmVudHMgPSBbJ3dlYmtpdFRyYW5zaXRpb25FbmQnLCAndHJhbnNpdGlvbmVuZCcsICdvVHJhbnNpdGlvbkVuZCcsICdNU1RyYW5zaXRpb25FbmQnLCAnbXNUcmFuc2l0aW9uRW5kJ107XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0cmlnZ2VyRXZlbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMud3JhcHBlci50cmlnZ2VyKHRyaWdnZXJFdmVudHNbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGN1YmU6IHtcbiAgICAgICAgICAgICAgICBzZXRUcmFuc2xhdGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHdyYXBwZXJSb3RhdGUgPSAwLCBjdWJlU2hhZG93O1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuY3ViZS5zaGFkb3cpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLmlzSG9yaXpvbnRhbCgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3ViZVNoYWRvdyA9IHMud3JhcHBlci5maW5kKCcuc3dpcGVyLWN1YmUtc2hhZG93Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGN1YmVTaGFkb3cubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1YmVTaGFkb3cgPSAkKCc8ZGl2IGNsYXNzPVwic3dpcGVyLWN1YmUtc2hhZG93XCI+PC9kaXY+Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMud3JhcHBlci5hcHBlbmQoY3ViZVNoYWRvdyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1YmVTaGFkb3cuY3NzKHtoZWlnaHQ6IHMud2lkdGggKyAncHgnfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdWJlU2hhZG93ID0gcy5jb250YWluZXIuZmluZCgnLnN3aXBlci1jdWJlLXNoYWRvdycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdWJlU2hhZG93Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdWJlU2hhZG93ID0gJCgnPGRpdiBjbGFzcz1cInN3aXBlci1jdWJlLXNoYWRvd1wiPjwvZGl2PicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLmNvbnRhaW5lci5hcHBlbmQoY3ViZVNoYWRvdyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcy5zbGlkZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGlkZSA9IHMuc2xpZGVzLmVxKGkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRlQW5nbGUgPSBpICogOTA7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm91bmQgPSBNYXRoLmZsb29yKHNsaWRlQW5nbGUgLyAzNjApO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMucnRsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGVBbmdsZSA9IC1zbGlkZUFuZ2xlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvdW5kID0gTWF0aC5mbG9vcigtc2xpZGVBbmdsZSAvIDM2MCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJvZ3Jlc3MgPSBNYXRoLm1heChNYXRoLm1pbihzbGlkZVswXS5wcm9ncmVzcywgMSksIC0xKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0eCA9IDAsIHR5ID0gMCwgdHogPSAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkgJSA0ID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHggPSAtIHJvdW5kICogNCAqIHMuc2l6ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eiA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICgoaSAtIDEpICUgNCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eiA9IC0gcm91bmQgKiA0ICogcy5zaXplO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoKGkgLSAyKSAlIDQgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eCA9IHMuc2l6ZSArIHJvdW5kICogNCAqIHMuc2l6ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eiA9IHMuc2l6ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKChpIC0gMykgJSA0ID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHggPSAtIHMuc2l6ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eiA9IDMgKiBzLnNpemUgKyBzLnNpemUgKiA0ICogcm91bmQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5ydGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eCA9IC10eDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXMuaXNIb3Jpem9udGFsKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eSA9IHR4O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR4ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgdHJhbnNmb3JtID0gJ3JvdGF0ZVgoJyArIChzLmlzSG9yaXpvbnRhbCgpID8gMCA6IC1zbGlkZUFuZ2xlKSArICdkZWcpIHJvdGF0ZVkoJyArIChzLmlzSG9yaXpvbnRhbCgpID8gc2xpZGVBbmdsZSA6IDApICsgJ2RlZykgdHJhbnNsYXRlM2QoJyArIHR4ICsgJ3B4LCAnICsgdHkgKyAncHgsICcgKyB0eiArICdweCknO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByb2dyZXNzIDw9IDEgJiYgcHJvZ3Jlc3MgPiAtMSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdyYXBwZXJSb3RhdGUgPSBpICogOTAgKyBwcm9ncmVzcyAqIDkwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLnJ0bCkgd3JhcHBlclJvdGF0ZSA9IC1pICogOTAgLSBwcm9ncmVzcyAqIDkwO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGUudHJhbnNmb3JtKHRyYW5zZm9ybSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuY3ViZS5zbGlkZVNoYWRvd3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL1NldCBzaGFkb3dzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNoYWRvd0JlZm9yZSA9IHMuaXNIb3Jpem9udGFsKCkgPyBzbGlkZS5maW5kKCcuc3dpcGVyLXNsaWRlLXNoYWRvdy1sZWZ0JykgOiBzbGlkZS5maW5kKCcuc3dpcGVyLXNsaWRlLXNoYWRvdy10b3AnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2hhZG93QWZ0ZXIgPSBzLmlzSG9yaXpvbnRhbCgpID8gc2xpZGUuZmluZCgnLnN3aXBlci1zbGlkZS1zaGFkb3ctcmlnaHQnKSA6IHNsaWRlLmZpbmQoJy5zd2lwZXItc2xpZGUtc2hhZG93LWJvdHRvbScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGFkb3dCZWZvcmUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRvd0JlZm9yZSA9ICQoJzxkaXYgY2xhc3M9XCJzd2lwZXItc2xpZGUtc2hhZG93LScgKyAocy5pc0hvcml6b250YWwoKSA/ICdsZWZ0JyA6ICd0b3AnKSArICdcIj48L2Rpdj4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGUuYXBwZW5kKHNoYWRvd0JlZm9yZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGFkb3dBZnRlci5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhZG93QWZ0ZXIgPSAkKCc8ZGl2IGNsYXNzPVwic3dpcGVyLXNsaWRlLXNoYWRvdy0nICsgKHMuaXNIb3Jpem9udGFsKCkgPyAncmlnaHQnIDogJ2JvdHRvbScpICsgJ1wiPjwvZGl2PicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGlkZS5hcHBlbmQoc2hhZG93QWZ0ZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hhZG93QmVmb3JlLmxlbmd0aCkgc2hhZG93QmVmb3JlWzBdLnN0eWxlLm9wYWNpdHkgPSBNYXRoLm1heCgtcHJvZ3Jlc3MsIDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGFkb3dBZnRlci5sZW5ndGgpIHNoYWRvd0FmdGVyWzBdLnN0eWxlLm9wYWNpdHkgPSBNYXRoLm1heChwcm9ncmVzcywgMCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcy53cmFwcGVyLmNzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAnLXdlYmtpdC10cmFuc2Zvcm0tb3JpZ2luJzogJzUwJSA1MCUgLScgKyAocy5zaXplIC8gMikgKyAncHgnLFxuICAgICAgICAgICAgICAgICAgICAgICAgJy1tb3otdHJhbnNmb3JtLW9yaWdpbic6ICc1MCUgNTAlIC0nICsgKHMuc2l6ZSAvIDIpICsgJ3B4JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICctbXMtdHJhbnNmb3JtLW9yaWdpbic6ICc1MCUgNTAlIC0nICsgKHMuc2l6ZSAvIDIpICsgJ3B4JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICd0cmFuc2Zvcm0tb3JpZ2luJzogJzUwJSA1MCUgLScgKyAocy5zaXplIC8gMikgKyAncHgnXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmN1YmUuc2hhZG93KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5pc0hvcml6b250YWwoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1YmVTaGFkb3cudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwcHgsICcgKyAocy53aWR0aCAvIDIgKyBzLnBhcmFtcy5jdWJlLnNoYWRvd09mZnNldCkgKyAncHgsICcgKyAoLXMud2lkdGggLyAyKSArICdweCkgcm90YXRlWCg5MGRlZykgcm90YXRlWigwZGVnKSBzY2FsZSgnICsgKHMucGFyYW1zLmN1YmUuc2hhZG93U2NhbGUpICsgJyknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzaGFkb3dBbmdsZSA9IE1hdGguYWJzKHdyYXBwZXJSb3RhdGUpIC0gTWF0aC5mbG9vcihNYXRoLmFicyh3cmFwcGVyUm90YXRlKSAvIDkwKSAqIDkwO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtdWx0aXBsaWVyID0gMS41IC0gKE1hdGguc2luKHNoYWRvd0FuZ2xlICogMiAqIE1hdGguUEkgLyAzNjApIC8gMiArIE1hdGguY29zKHNoYWRvd0FuZ2xlICogMiAqIE1hdGguUEkgLyAzNjApIC8gMik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNjYWxlMSA9IHMucGFyYW1zLmN1YmUuc2hhZG93U2NhbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlMiA9IHMucGFyYW1zLmN1YmUuc2hhZG93U2NhbGUgLyBtdWx0aXBsaWVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZmZzZXQgPSBzLnBhcmFtcy5jdWJlLnNoYWRvd09mZnNldDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdWJlU2hhZG93LnRyYW5zZm9ybSgnc2NhbGUzZCgnICsgc2NhbGUxICsgJywgMSwgJyArIHNjYWxlMiArICcpIHRyYW5zbGF0ZTNkKDBweCwgJyArIChzLmhlaWdodCAvIDIgKyBvZmZzZXQpICsgJ3B4LCAnICsgKC1zLmhlaWdodCAvIDIgLyBzY2FsZTIpICsgJ3B4KSByb3RhdGVYKC05MGRlZyknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB2YXIgekZhY3RvciA9IChzLmlzU2FmYXJpIHx8IHMuaXNVaVdlYlZpZXcpID8gKC1zLnNpemUgLyAyKSA6IDA7XG4gICAgICAgICAgICAgICAgICAgIHMud3JhcHBlci50cmFuc2Zvcm0oJ3RyYW5zbGF0ZTNkKDBweCwwLCcgKyB6RmFjdG9yICsgJ3B4KSByb3RhdGVYKCcgKyAocy5pc0hvcml6b250YWwoKSA/IDAgOiB3cmFwcGVyUm90YXRlKSArICdkZWcpIHJvdGF0ZVkoJyArIChzLmlzSG9yaXpvbnRhbCgpID8gLXdyYXBwZXJSb3RhdGUgOiAwKSArICdkZWcpJyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzZXRUcmFuc2l0aW9uOiBmdW5jdGlvbiAoZHVyYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcy5zbGlkZXMudHJhbnNpdGlvbihkdXJhdGlvbikuZmluZCgnLnN3aXBlci1zbGlkZS1zaGFkb3ctdG9wLCAuc3dpcGVyLXNsaWRlLXNoYWRvdy1yaWdodCwgLnN3aXBlci1zbGlkZS1zaGFkb3ctYm90dG9tLCAuc3dpcGVyLXNsaWRlLXNoYWRvdy1sZWZ0JykudHJhbnNpdGlvbihkdXJhdGlvbik7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5jdWJlLnNoYWRvdyAmJiAhcy5pc0hvcml6b250YWwoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5jb250YWluZXIuZmluZCgnLnN3aXBlci1jdWJlLXNoYWRvdycpLnRyYW5zaXRpb24oZHVyYXRpb24pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGNvdmVyZmxvdzoge1xuICAgICAgICAgICAgICAgIHNldFRyYW5zbGF0ZTogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdHJhbnNmb3JtID0gcy50cmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjZW50ZXIgPSBzLmlzSG9yaXpvbnRhbCgpID8gLXRyYW5zZm9ybSArIHMud2lkdGggLyAyIDogLXRyYW5zZm9ybSArIHMuaGVpZ2h0IC8gMjtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJvdGF0ZSA9IHMuaXNIb3Jpem9udGFsKCkgPyBzLnBhcmFtcy5jb3ZlcmZsb3cucm90YXRlOiAtcy5wYXJhbXMuY292ZXJmbG93LnJvdGF0ZTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRyYW5zbGF0ZSA9IHMucGFyYW1zLmNvdmVyZmxvdy5kZXB0aDtcbiAgICAgICAgICAgICAgICAgICAgLy9FYWNoIHNsaWRlIG9mZnNldCBmcm9tIGNlbnRlclxuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gcy5zbGlkZXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzbGlkZSA9IHMuc2xpZGVzLmVxKGkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRlU2l6ZSA9IHMuc2xpZGVzU2l6ZXNHcmlkW2ldO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRlT2Zmc2V0ID0gc2xpZGVbMF0uc3dpcGVyU2xpZGVPZmZzZXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgb2Zmc2V0TXVsdGlwbGllciA9IChjZW50ZXIgLSBzbGlkZU9mZnNldCAtIHNsaWRlU2l6ZSAvIDIpIC8gc2xpZGVTaXplICogcy5wYXJhbXMuY292ZXJmbG93Lm1vZGlmaWVyO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByb3RhdGVZID0gcy5pc0hvcml6b250YWwoKSA/IHJvdGF0ZSAqIG9mZnNldE11bHRpcGxpZXIgOiAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvdGF0ZVggPSBzLmlzSG9yaXpvbnRhbCgpID8gMCA6IHJvdGF0ZSAqIG9mZnNldE11bHRpcGxpZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB2YXIgcm90YXRlWiA9IDBcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2xhdGVaID0gLXRyYW5zbGF0ZSAqIE1hdGguYWJzKG9mZnNldE11bHRpcGxpZXIpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2xhdGVZID0gcy5pc0hvcml6b250YWwoKSA/IDAgOiBzLnBhcmFtcy5jb3ZlcmZsb3cuc3RyZXRjaCAqIChvZmZzZXRNdWx0aXBsaWVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0cmFuc2xhdGVYID0gcy5pc0hvcml6b250YWwoKSA/IHMucGFyYW1zLmNvdmVyZmxvdy5zdHJldGNoICogKG9mZnNldE11bHRpcGxpZXIpIDogMDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAvL0ZpeCBmb3IgdWx0cmEgc21hbGwgdmFsdWVzXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModHJhbnNsYXRlWCkgPCAwLjAwMSkgdHJhbnNsYXRlWCA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModHJhbnNsYXRlWSkgPCAwLjAwMSkgdHJhbnNsYXRlWSA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnModHJhbnNsYXRlWikgPCAwLjAwMSkgdHJhbnNsYXRlWiA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocm90YXRlWSkgPCAwLjAwMSkgcm90YXRlWSA9IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5hYnMocm90YXRlWCkgPCAwLjAwMSkgcm90YXRlWCA9IDA7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHNsaWRlVHJhbnNmb3JtID0gJ3RyYW5zbGF0ZTNkKCcgKyB0cmFuc2xhdGVYICsgJ3B4LCcgKyB0cmFuc2xhdGVZICsgJ3B4LCcgKyB0cmFuc2xhdGVaICsgJ3B4KSAgcm90YXRlWCgnICsgcm90YXRlWCArICdkZWcpIHJvdGF0ZVkoJyArIHJvdGF0ZVkgKyAnZGVnKSc7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGUudHJhbnNmb3JtKHNsaWRlVHJhbnNmb3JtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlWzBdLnN0eWxlLnpJbmRleCA9IC1NYXRoLmFicyhNYXRoLnJvdW5kKG9mZnNldE11bHRpcGxpZXIpKSArIDE7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuY292ZXJmbG93LnNsaWRlU2hhZG93cykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vU2V0IHNoYWRvd3NcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2hhZG93QmVmb3JlID0gcy5pc0hvcml6b250YWwoKSA/IHNsaWRlLmZpbmQoJy5zd2lwZXItc2xpZGUtc2hhZG93LWxlZnQnKSA6IHNsaWRlLmZpbmQoJy5zd2lwZXItc2xpZGUtc2hhZG93LXRvcCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzaGFkb3dBZnRlciA9IHMuaXNIb3Jpem9udGFsKCkgPyBzbGlkZS5maW5kKCcuc3dpcGVyLXNsaWRlLXNoYWRvdy1yaWdodCcpIDogc2xpZGUuZmluZCgnLnN3aXBlci1zbGlkZS1zaGFkb3ctYm90dG9tJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNoYWRvd0JlZm9yZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hhZG93QmVmb3JlID0gJCgnPGRpdiBjbGFzcz1cInN3aXBlci1zbGlkZS1zaGFkb3ctJyArIChzLmlzSG9yaXpvbnRhbCgpID8gJ2xlZnQnIDogJ3RvcCcpICsgJ1wiPjwvZGl2PicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGlkZS5hcHBlbmQoc2hhZG93QmVmb3JlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNoYWRvd0FmdGVyLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaGFkb3dBZnRlciA9ICQoJzxkaXYgY2xhc3M9XCJzd2lwZXItc2xpZGUtc2hhZG93LScgKyAocy5pc0hvcml6b250YWwoKSA/ICdyaWdodCcgOiAnYm90dG9tJykgKyAnXCI+PC9kaXY+Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsaWRlLmFwcGVuZChzaGFkb3dBZnRlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaGFkb3dCZWZvcmUubGVuZ3RoKSBzaGFkb3dCZWZvcmVbMF0uc3R5bGUub3BhY2l0eSA9IG9mZnNldE11bHRpcGxpZXIgPiAwID8gb2Zmc2V0TXVsdGlwbGllciA6IDA7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNoYWRvd0FmdGVyLmxlbmd0aCkgc2hhZG93QWZ0ZXJbMF0uc3R5bGUub3BhY2l0eSA9ICgtb2Zmc2V0TXVsdGlwbGllcikgPiAwID8gLW9mZnNldE11bHRpcGxpZXIgOiAwO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvL1NldCBjb3JyZWN0IHBlcnNwZWN0aXZlIGZvciBJRTEwXG4gICAgICAgICAgICAgICAgICAgIGlmIChzLmJyb3dzZXIuaWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB3cyA9IHMud3JhcHBlclswXS5zdHlsZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdzLnBlcnNwZWN0aXZlT3JpZ2luID0gY2VudGVyICsgJ3B4IDUwJSc7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNldFRyYW5zaXRpb246IGZ1bmN0aW9uIChkdXJhdGlvbikge1xuICAgICAgICAgICAgICAgICAgICBzLnNsaWRlcy50cmFuc2l0aW9uKGR1cmF0aW9uKS5maW5kKCcuc3dpcGVyLXNsaWRlLXNoYWRvdy10b3AsIC5zd2lwZXItc2xpZGUtc2hhZG93LXJpZ2h0LCAuc3dpcGVyLXNsaWRlLXNoYWRvdy1ib3R0b20sIC5zd2lwZXItc2xpZGUtc2hhZG93LWxlZnQnKS50cmFuc2l0aW9uKGR1cmF0aW9uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIEltYWdlcyBMYXp5IExvYWRpbmdcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLmxhenkgPSB7XG4gICAgICAgICAgICBpbml0aWFsSW1hZ2VMb2FkZWQ6IGZhbHNlLFxuICAgICAgICAgICAgbG9hZEltYWdlSW5TbGlkZTogZnVuY3Rpb24gKGluZGV4LCBsb2FkSW5EdXBsaWNhdGUpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGluZGV4ID09PSAndW5kZWZpbmVkJykgcmV0dXJuO1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgbG9hZEluRHVwbGljYXRlID09PSAndW5kZWZpbmVkJykgbG9hZEluRHVwbGljYXRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBpZiAocy5zbGlkZXMubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBzbGlkZSA9IHMuc2xpZGVzLmVxKGluZGV4KTtcbiAgICAgICAgICAgICAgICB2YXIgaW1nID0gc2xpZGUuZmluZCgnLnN3aXBlci1sYXp5Om5vdCguc3dpcGVyLWxhenktbG9hZGVkKTpub3QoLnN3aXBlci1sYXp5LWxvYWRpbmcpJyk7XG4gICAgICAgICAgICAgICAgaWYgKHNsaWRlLmhhc0NsYXNzKCdzd2lwZXItbGF6eScpICYmICFzbGlkZS5oYXNDbGFzcygnc3dpcGVyLWxhenktbG9hZGVkJykgJiYgIXNsaWRlLmhhc0NsYXNzKCdzd2lwZXItbGF6eS1sb2FkaW5nJykpIHtcbiAgICAgICAgICAgICAgICAgICAgaW1nID0gaW1nLmFkZChzbGlkZVswXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChpbWcubGVuZ3RoID09PSAwKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIGltZy5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIF9pbWcgPSAkKHRoaXMpO1xuICAgICAgICAgICAgICAgICAgICBfaW1nLmFkZENsYXNzKCdzd2lwZXItbGF6eS1sb2FkaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBiYWNrZ3JvdW5kID0gX2ltZy5hdHRyKCdkYXRhLWJhY2tncm91bmQnKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHNyYyA9IF9pbWcuYXR0cignZGF0YS1zcmMnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNyY3NldCA9IF9pbWcuYXR0cignZGF0YS1zcmNzZXQnKTtcbiAgICAgICAgICAgICAgICAgICAgcy5sb2FkSW1hZ2UoX2ltZ1swXSwgKHNyYyB8fCBiYWNrZ3JvdW5kKSwgc3Jjc2V0LCBmYWxzZSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGJhY2tncm91bmQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfaW1nLmNzcygnYmFja2dyb3VuZC1pbWFnZScsICd1cmwoXCInICsgYmFja2dyb3VuZCArICdcIiknKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfaW1nLnJlbW92ZUF0dHIoJ2RhdGEtYmFja2dyb3VuZCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNyY3NldCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfaW1nLmF0dHIoJ3NyY3NldCcsIHNyY3NldCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9pbWcucmVtb3ZlQXR0cignZGF0YS1zcmNzZXQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNyYykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBfaW1nLmF0dHIoJ3NyYycsIHNyYyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9pbWcucmVtb3ZlQXR0cignZGF0YS1zcmMnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIF9pbWcuYWRkQ2xhc3MoJ3N3aXBlci1sYXp5LWxvYWRlZCcpLnJlbW92ZUNsYXNzKCdzd2lwZXItbGF6eS1sb2FkaW5nJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzbGlkZS5maW5kKCcuc3dpcGVyLWxhenktcHJlbG9hZGVyLCAucHJlbG9hZGVyJykucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMubG9vcCAmJiBsb2FkSW5EdXBsaWNhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGVPcmlnaW5hbEluZGV4ID0gc2xpZGUuYXR0cignZGF0YS1zd2lwZXItc2xpZGUtaW5kZXgnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2xpZGUuaGFzQ2xhc3Mocy5wYXJhbXMuc2xpZGVEdXBsaWNhdGVDbGFzcykpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9yaWdpbmFsU2xpZGUgPSBzLndyYXBwZXIuY2hpbGRyZW4oJ1tkYXRhLXN3aXBlci1zbGlkZS1pbmRleD1cIicgKyBzbGlkZU9yaWdpbmFsSW5kZXggKyAnXCJdOm5vdCguJyArIHMucGFyYW1zLnNsaWRlRHVwbGljYXRlQ2xhc3MgKyAnKScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLmxhenkubG9hZEltYWdlSW5TbGlkZShvcmlnaW5hbFNsaWRlLmluZGV4KCksIGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkdXBsaWNhdGVkU2xpZGUgPSBzLndyYXBwZXIuY2hpbGRyZW4oJy4nICsgcy5wYXJhbXMuc2xpZGVEdXBsaWNhdGVDbGFzcyArICdbZGF0YS1zd2lwZXItc2xpZGUtaW5kZXg9XCInICsgc2xpZGVPcmlnaW5hbEluZGV4ICsgJ1wiXScpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzLmxhenkubG9hZEltYWdlSW5TbGlkZShkdXBsaWNhdGVkU2xpZGUuaW5kZXgoKSwgZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHMuZW1pdCgnb25MYXp5SW1hZ2VSZWFkeScsIHMsIHNsaWRlWzBdLCBfaW1nWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBzLmVtaXQoJ29uTGF6eUltYWdlTG9hZCcsIHMsIHNsaWRlWzBdLCBfaW1nWzBdKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbG9hZDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHZhciBpO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy53YXRjaFNsaWRlc1Zpc2liaWxpdHkpIHtcbiAgICAgICAgICAgICAgICAgICAgcy53cmFwcGVyLmNoaWxkcmVuKCcuJyArIHMucGFyYW1zLnNsaWRlVmlzaWJsZUNsYXNzKS5lYWNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMubGF6eS5sb2FkSW1hZ2VJblNsaWRlKCQodGhpcykuaW5kZXgoKSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNsaWRlc1BlclZpZXcgPiAxKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSBzLmFjdGl2ZUluZGV4OyBpIDwgcy5hY3RpdmVJbmRleCArIHMucGFyYW1zLnNsaWRlc1BlclZpZXcgOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocy5zbGlkZXNbaV0pIHMubGF6eS5sb2FkSW1hZ2VJblNsaWRlKGkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5sYXp5LmxvYWRJbWFnZUluU2xpZGUocy5hY3RpdmVJbmRleCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxhenlMb2FkaW5nSW5QcmV2TmV4dCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuc2xpZGVzUGVyVmlldyA+IDEgfHwgKHMucGFyYW1zLmxhenlMb2FkaW5nSW5QcmV2TmV4dEFtb3VudCAmJiBzLnBhcmFtcy5sYXp5TG9hZGluZ0luUHJldk5leHRBbW91bnQgPiAxKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGFtb3VudCA9IHMucGFyYW1zLmxhenlMb2FkaW5nSW5QcmV2TmV4dEFtb3VudDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzcHYgPSBzLnBhcmFtcy5zbGlkZXNQZXJWaWV3O1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG1heEluZGV4ID0gTWF0aC5taW4ocy5hY3RpdmVJbmRleCArIHNwdiArIE1hdGgubWF4KGFtb3VudCwgc3B2KSwgcy5zbGlkZXMubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtaW5JbmRleCA9IE1hdGgubWF4KHMuYWN0aXZlSW5kZXggLSBNYXRoLm1heChzcHYsIGFtb3VudCksIDApO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gTmV4dCBTbGlkZXNcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IHMuYWN0aXZlSW5kZXggKyBzLnBhcmFtcy5zbGlkZXNQZXJWaWV3OyBpIDwgbWF4SW5kZXg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzLnNsaWRlc1tpXSkgcy5sYXp5LmxvYWRJbWFnZUluU2xpZGUoaSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBQcmV2IFNsaWRlc1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gbWluSW5kZXg7IGkgPCBzLmFjdGl2ZUluZGV4IDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHMuc2xpZGVzW2ldKSBzLmxhenkubG9hZEltYWdlSW5TbGlkZShpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXh0U2xpZGUgPSBzLndyYXBwZXIuY2hpbGRyZW4oJy4nICsgcy5wYXJhbXMuc2xpZGVOZXh0Q2xhc3MpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5leHRTbGlkZS5sZW5ndGggPiAwKSBzLmxhenkubG9hZEltYWdlSW5TbGlkZShuZXh0U2xpZGUuaW5kZXgoKSk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByZXZTbGlkZSA9IHMud3JhcHBlci5jaGlsZHJlbignLicgKyBzLnBhcmFtcy5zbGlkZVByZXZDbGFzcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJldlNsaWRlLmxlbmd0aCA+IDApIHMubGF6eS5sb2FkSW1hZ2VJblNsaWRlKHByZXZTbGlkZS5pbmRleCgpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvblRyYW5zaXRpb25TdGFydDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5sYXp5TG9hZGluZykge1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMubGF6eUxvYWRpbmdPblRyYW5zaXRpb25TdGFydCB8fCAoIXMucGFyYW1zLmxhenlMb2FkaW5nT25UcmFuc2l0aW9uU3RhcnQgJiYgIXMubGF6eS5pbml0aWFsSW1hZ2VMb2FkZWQpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmxhenkubG9hZCgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9uVHJhbnNpdGlvbkVuZDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5sYXp5TG9hZGluZyAmJiAhcy5wYXJhbXMubGF6eUxvYWRpbmdPblRyYW5zaXRpb25TdGFydCkge1xuICAgICAgICAgICAgICAgICAgICBzLmxhenkubG9hZCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICAgIFNjcm9sbGJhclxuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMuc2Nyb2xsYmFyID0ge1xuICAgICAgICAgICAgaXNUb3VjaGVkOiBmYWxzZSxcbiAgICAgICAgICAgIHNldERyYWdQb3NpdGlvbjogZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgc2IgPSBzLnNjcm9sbGJhcjtcbiAgICAgICAgICAgICAgICB2YXIgeCA9IDAsIHkgPSAwO1xuICAgICAgICAgICAgICAgIHZhciB0cmFuc2xhdGU7XG4gICAgICAgICAgICAgICAgdmFyIHBvaW50ZXJQb3NpdGlvbiA9IHMuaXNIb3Jpem9udGFsKCkgP1xuICAgICAgICAgICAgICAgICAgICAoKGUudHlwZSA9PT0gJ3RvdWNoc3RhcnQnIHx8IGUudHlwZSA9PT0gJ3RvdWNobW92ZScpID8gZS50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZS5wYWdlWCB8fCBlLmNsaWVudFgpIDpcbiAgICAgICAgICAgICAgICAgICAgKChlLnR5cGUgPT09ICd0b3VjaHN0YXJ0JyB8fCBlLnR5cGUgPT09ICd0b3VjaG1vdmUnKSA/IGUudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSA6IGUucGFnZVkgfHwgZS5jbGllbnRZKSA7XG4gICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9uID0gKHBvaW50ZXJQb3NpdGlvbikgLSBzYi50cmFjay5vZmZzZXQoKVtzLmlzSG9yaXpvbnRhbCgpID8gJ2xlZnQnIDogJ3RvcCddIC0gc2IuZHJhZ1NpemUgLyAyO1xuICAgICAgICAgICAgICAgIHZhciBwb3NpdGlvbk1pbiA9IC1zLm1pblRyYW5zbGF0ZSgpICogc2IubW92ZURpdmlkZXI7XG4gICAgICAgICAgICAgICAgdmFyIHBvc2l0aW9uTWF4ID0gLXMubWF4VHJhbnNsYXRlKCkgKiBzYi5tb3ZlRGl2aWRlcjtcbiAgICAgICAgICAgICAgICBpZiAocG9zaXRpb24gPCBwb3NpdGlvbk1pbikge1xuICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbiA9IHBvc2l0aW9uTWluO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmIChwb3NpdGlvbiA+IHBvc2l0aW9uTWF4KSB7XG4gICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uID0gcG9zaXRpb25NYXg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHBvc2l0aW9uID0gLXBvc2l0aW9uIC8gc2IubW92ZURpdmlkZXI7XG4gICAgICAgICAgICAgICAgcy51cGRhdGVQcm9ncmVzcyhwb3NpdGlvbik7XG4gICAgICAgICAgICAgICAgcy5zZXRXcmFwcGVyVHJhbnNsYXRlKHBvc2l0aW9uLCB0cnVlKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkcmFnU3RhcnQ6IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgdmFyIHNiID0gcy5zY3JvbGxiYXI7XG4gICAgICAgICAgICAgICAgc2IuaXNUb3VjaGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgc2Iuc2V0RHJhZ1Bvc2l0aW9uKGUpO1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChzYi5kcmFnVGltZW91dCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHNiLnRyYWNrLnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNjcm9sbGJhckhpZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgc2IudHJhY2suY3NzKCdvcGFjaXR5JywgMSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHMud3JhcHBlci50cmFuc2l0aW9uKDEwMCk7XG4gICAgICAgICAgICAgICAgc2IuZHJhZy50cmFuc2l0aW9uKDEwMCk7XG4gICAgICAgICAgICAgICAgcy5lbWl0KCdvblNjcm9sbGJhckRyYWdTdGFydCcsIHMpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGRyYWdNb3ZlOiBmdW5jdGlvbiAoZSkge1xuICAgICAgICAgICAgICAgIHZhciBzYiA9IHMuc2Nyb2xsYmFyO1xuICAgICAgICAgICAgICAgIGlmICghc2IuaXNUb3VjaGVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgaWYgKGUucHJldmVudERlZmF1bHQpIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICBlbHNlIGUucmV0dXJuVmFsdWUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBzYi5zZXREcmFnUG9zaXRpb24oZSk7XG4gICAgICAgICAgICAgICAgcy53cmFwcGVyLnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgc2IudHJhY2sudHJhbnNpdGlvbigwKTtcbiAgICAgICAgICAgICAgICBzYi5kcmFnLnRyYW5zaXRpb24oMCk7XG4gICAgICAgICAgICAgICAgcy5lbWl0KCdvblNjcm9sbGJhckRyYWdNb3ZlJywgcyk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZHJhZ0VuZDogZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgc2IgPSBzLnNjcm9sbGJhcjtcbiAgICAgICAgICAgICAgICBpZiAoIXNiLmlzVG91Y2hlZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgIHNiLmlzVG91Y2hlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zY3JvbGxiYXJIaWRlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChzYi5kcmFnVGltZW91dCk7XG4gICAgICAgICAgICAgICAgICAgIHNiLmRyYWdUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzYi50cmFjay5jc3MoJ29wYWNpdHknLCAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNiLnRyYWNrLnRyYW5zaXRpb24oNDAwKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgMTAwMCk7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzLmVtaXQoJ29uU2Nyb2xsYmFyRHJhZ0VuZCcsIHMpO1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zY3JvbGxiYXJTbmFwT25SZWxlYXNlKSB7XG4gICAgICAgICAgICAgICAgICAgIHMuc2xpZGVSZXNldCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlbmFibGVEcmFnZ2FibGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgc2IgPSBzLnNjcm9sbGJhcjtcbiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gcy5zdXBwb3J0LnRvdWNoID8gc2IudHJhY2sgOiBkb2N1bWVudDtcbiAgICAgICAgICAgICAgICAkKHNiLnRyYWNrKS5vbihzLnRvdWNoRXZlbnRzLnN0YXJ0LCBzYi5kcmFnU3RhcnQpO1xuICAgICAgICAgICAgICAgICQodGFyZ2V0KS5vbihzLnRvdWNoRXZlbnRzLm1vdmUsIHNiLmRyYWdNb3ZlKTtcbiAgICAgICAgICAgICAgICAkKHRhcmdldCkub24ocy50b3VjaEV2ZW50cy5lbmQsIHNiLmRyYWdFbmQpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGRpc2FibGVEcmFnZ2FibGU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICB2YXIgc2IgPSBzLnNjcm9sbGJhcjtcbiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gcy5zdXBwb3J0LnRvdWNoID8gc2IudHJhY2sgOiBkb2N1bWVudDtcbiAgICAgICAgICAgICAgICAkKHNiLnRyYWNrKS5vZmYocy50b3VjaEV2ZW50cy5zdGFydCwgc2IuZHJhZ1N0YXJ0KTtcbiAgICAgICAgICAgICAgICAkKHRhcmdldCkub2ZmKHMudG91Y2hFdmVudHMubW92ZSwgc2IuZHJhZ01vdmUpO1xuICAgICAgICAgICAgICAgICQodGFyZ2V0KS5vZmYocy50b3VjaEV2ZW50cy5lbmQsIHNiLmRyYWdFbmQpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNldDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmICghcy5wYXJhbXMuc2Nyb2xsYmFyKSByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIHNiID0gcy5zY3JvbGxiYXI7XG4gICAgICAgICAgICAgICAgc2IudHJhY2sgPSAkKHMucGFyYW1zLnNjcm9sbGJhcik7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnVuaXF1ZU5hdkVsZW1lbnRzICYmIHR5cGVvZiBzLnBhcmFtcy5zY3JvbGxiYXIgPT09ICdzdHJpbmcnICYmIHNiLnRyYWNrLmxlbmd0aCA+IDEgJiYgcy5jb250YWluZXIuZmluZChzLnBhcmFtcy5zY3JvbGxiYXIpLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICAgICAgICAgICAgICBzYi50cmFjayA9IHMuY29udGFpbmVyLmZpbmQocy5wYXJhbXMuc2Nyb2xsYmFyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc2IuZHJhZyA9IHNiLnRyYWNrLmZpbmQoJy5zd2lwZXItc2Nyb2xsYmFyLWRyYWcnKTtcbiAgICAgICAgICAgICAgICBpZiAoc2IuZHJhZy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgc2IuZHJhZyA9ICQoJzxkaXYgY2xhc3M9XCJzd2lwZXItc2Nyb2xsYmFyLWRyYWdcIj48L2Rpdj4nKTtcbiAgICAgICAgICAgICAgICAgICAgc2IudHJhY2suYXBwZW5kKHNiLmRyYWcpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzYi5kcmFnWzBdLnN0eWxlLndpZHRoID0gJyc7XG4gICAgICAgICAgICAgICAgc2IuZHJhZ1swXS5zdHlsZS5oZWlnaHQgPSAnJztcbiAgICAgICAgICAgICAgICBzYi50cmFja1NpemUgPSBzLmlzSG9yaXpvbnRhbCgpID8gc2IudHJhY2tbMF0ub2Zmc2V0V2lkdGggOiBzYi50cmFja1swXS5vZmZzZXRIZWlnaHQ7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHNiLmRpdmlkZXIgPSBzLnNpemUgLyBzLnZpcnR1YWxTaXplO1xuICAgICAgICAgICAgICAgIHNiLm1vdmVEaXZpZGVyID0gc2IuZGl2aWRlciAqIChzYi50cmFja1NpemUgLyBzLnNpemUpO1xuICAgICAgICAgICAgICAgIHNiLmRyYWdTaXplID0gc2IudHJhY2tTaXplICogc2IuZGl2aWRlcjtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHMuaXNIb3Jpem9udGFsKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgc2IuZHJhZ1swXS5zdHlsZS53aWR0aCA9IHNiLmRyYWdTaXplICsgJ3B4JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNiLmRyYWdbMF0uc3R5bGUuaGVpZ2h0ID0gc2IuZHJhZ1NpemUgKyAncHgnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKHNiLmRpdmlkZXIgPj0gMSkge1xuICAgICAgICAgICAgICAgICAgICBzYi50cmFja1swXS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc2IudHJhY2tbMF0uc3R5bGUuZGlzcGxheSA9ICcnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuc2Nyb2xsYmFySGlkZSkge1xuICAgICAgICAgICAgICAgICAgICBzYi50cmFja1swXS5zdHlsZS5vcGFjaXR5ID0gMDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2V0VHJhbnNsYXRlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5zY3JvbGxiYXIpIHJldHVybjtcbiAgICAgICAgICAgICAgICB2YXIgZGlmZjtcbiAgICAgICAgICAgICAgICB2YXIgc2IgPSBzLnNjcm9sbGJhcjtcbiAgICAgICAgICAgICAgICB2YXIgdHJhbnNsYXRlID0gcy50cmFuc2xhdGUgfHwgMDtcbiAgICAgICAgICAgICAgICB2YXIgbmV3UG9zO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICB2YXIgbmV3U2l6ZSA9IHNiLmRyYWdTaXplO1xuICAgICAgICAgICAgICAgIG5ld1BvcyA9IChzYi50cmFja1NpemUgLSBzYi5kcmFnU2l6ZSkgKiBzLnByb2dyZXNzO1xuICAgICAgICAgICAgICAgIGlmIChzLnJ0bCAmJiBzLmlzSG9yaXpvbnRhbCgpKSB7XG4gICAgICAgICAgICAgICAgICAgIG5ld1BvcyA9IC1uZXdQb3M7XG4gICAgICAgICAgICAgICAgICAgIGlmIChuZXdQb3MgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdTaXplID0gc2IuZHJhZ1NpemUgLSBuZXdQb3M7XG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdQb3MgPSAwO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKC1uZXdQb3MgKyBzYi5kcmFnU2l6ZSA+IHNiLnRyYWNrU2l6ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbmV3U2l6ZSA9IHNiLnRyYWNrU2l6ZSArIG5ld1BvcztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1BvcyA8IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1NpemUgPSBzYi5kcmFnU2l6ZSArIG5ld1BvcztcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1BvcyA9IDA7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAobmV3UG9zICsgc2IuZHJhZ1NpemUgPiBzYi50cmFja1NpemUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ld1NpemUgPSBzYi50cmFja1NpemUgLSBuZXdQb3M7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKHMuaXNIb3Jpem9udGFsKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuc3VwcG9ydC50cmFuc2Zvcm1zM2QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNiLmRyYWcudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgKG5ld1BvcykgKyAncHgsIDAsIDApJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzYi5kcmFnLnRyYW5zZm9ybSgndHJhbnNsYXRlWCgnICsgKG5ld1BvcykgKyAncHgpJyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgc2IuZHJhZ1swXS5zdHlsZS53aWR0aCA9IG5ld1NpemUgKyAncHgnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMuc3VwcG9ydC50cmFuc2Zvcm1zM2QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNiLmRyYWcudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgwcHgsICcgKyAobmV3UG9zKSArICdweCwgMCknKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNiLmRyYWcudHJhbnNmb3JtKCd0cmFuc2xhdGVZKCcgKyAobmV3UG9zKSArICdweCknKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBzYi5kcmFnWzBdLnN0eWxlLmhlaWdodCA9IG5ld1NpemUgKyAncHgnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMuc2Nyb2xsYmFySGlkZSkge1xuICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoc2IudGltZW91dCk7XG4gICAgICAgICAgICAgICAgICAgIHNiLnRyYWNrWzBdLnN0eWxlLm9wYWNpdHkgPSAxO1xuICAgICAgICAgICAgICAgICAgICBzYi50aW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzYi50cmFja1swXS5zdHlsZS5vcGFjaXR5ID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNiLnRyYWNrLnRyYW5zaXRpb24oNDAwKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgMTAwMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNldFRyYW5zaXRpb246IGZ1bmN0aW9uIChkdXJhdGlvbikge1xuICAgICAgICAgICAgICAgIGlmICghcy5wYXJhbXMuc2Nyb2xsYmFyKSByZXR1cm47XG4gICAgICAgICAgICAgICAgcy5zY3JvbGxiYXIuZHJhZy50cmFuc2l0aW9uKGR1cmF0aW9uKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgQ29udHJvbGxlclxuICAgICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHMuY29udHJvbGxlciA9IHtcbiAgICAgICAgICAgIExpbmVhclNwbGluZTogZnVuY3Rpb24gKHgsIHkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnggPSB4O1xuICAgICAgICAgICAgICAgIHRoaXMueSA9IHk7XG4gICAgICAgICAgICAgICAgdGhpcy5sYXN0SW5kZXggPSB4Lmxlbmd0aCAtIDE7XG4gICAgICAgICAgICAgICAgLy8gR2l2ZW4gYW4geCB2YWx1ZSAoeDIpLCByZXR1cm4gdGhlIGV4cGVjdGVkIHkyIHZhbHVlOlxuICAgICAgICAgICAgICAgIC8vICh4MSx5MSkgaXMgdGhlIGtub3duIHBvaW50IGJlZm9yZSBnaXZlbiB2YWx1ZSxcbiAgICAgICAgICAgICAgICAvLyAoeDMseTMpIGlzIHRoZSBrbm93biBwb2ludCBhZnRlciBnaXZlbiB2YWx1ZS5cbiAgICAgICAgICAgICAgICB2YXIgaTEsIGkzO1xuICAgICAgICAgICAgICAgIHZhciBsID0gdGhpcy54Lmxlbmd0aDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgdGhpcy5pbnRlcnBvbGF0ZSA9IGZ1bmN0aW9uICh4Mikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXgyKSByZXR1cm4gMDtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIEdldCB0aGUgaW5kZXhlcyBvZiB4MSBhbmQgeDMgKHRoZSBhcnJheSBpbmRleGVzIGJlZm9yZSBhbmQgYWZ0ZXIgZ2l2ZW4geDIpOlxuICAgICAgICAgICAgICAgICAgICBpMyA9IGJpbmFyeVNlYXJjaCh0aGlzLngsIHgyKTtcbiAgICAgICAgICAgICAgICAgICAgaTEgPSBpMyAtIDE7XG4gICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvLyBXZSBoYXZlIG91ciBpbmRleGVzIGkxICYgaTMsIHNvIHdlIGNhbiBjYWxjdWxhdGUgYWxyZWFkeTpcbiAgICAgICAgICAgICAgICAgICAgLy8geTIgOj0gKCh4MuKIkngxKSDDlyAoeTPiiJJ5MSkpIMO3ICh4M+KIkngxKSArIHkxXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAoKHgyIC0gdGhpcy54W2kxXSkgKiAodGhpcy55W2kzXSAtIHRoaXMueVtpMV0pKSAvICh0aGlzLnhbaTNdIC0gdGhpcy54W2kxXSkgKyB0aGlzLnlbaTFdO1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAgICAgICAgIHZhciBiaW5hcnlTZWFyY2ggPSAoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBtYXhJbmRleCwgbWluSW5kZXgsIGd1ZXNzO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJyYXksIHZhbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWluSW5kZXggPSAtMTtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1heEluZGV4ID0gYXJyYXkubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUgKG1heEluZGV4IC0gbWluSW5kZXggPiAxKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcnJheVtndWVzcyA9IG1heEluZGV4ICsgbWluSW5kZXggPj4gMV0gPD0gdmFsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1pbkluZGV4ID0gZ3Vlc3M7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4SW5kZXggPSBndWVzcztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbWF4SW5kZXg7XG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfSkoKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAvL3h4eDogZm9yIG5vdyBpIHdpbGwganVzdCBzYXZlIG9uZSBzcGxpbmUgZnVuY3Rpb24gdG8gdG9cbiAgICAgICAgICAgIGdldEludGVycG9sYXRlRnVuY3Rpb246IGZ1bmN0aW9uKGMpe1xuICAgICAgICAgICAgICAgIGlmKCFzLmNvbnRyb2xsZXIuc3BsaW5lKSBzLmNvbnRyb2xsZXIuc3BsaW5lID0gcy5wYXJhbXMubG9vcCA/XG4gICAgICAgICAgICAgICAgICAgIG5ldyBzLmNvbnRyb2xsZXIuTGluZWFyU3BsaW5lKHMuc2xpZGVzR3JpZCwgYy5zbGlkZXNHcmlkKSA6XG4gICAgICAgICAgICAgICAgICAgIG5ldyBzLmNvbnRyb2xsZXIuTGluZWFyU3BsaW5lKHMuc25hcEdyaWQsIGMuc25hcEdyaWQpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHNldFRyYW5zbGF0ZTogZnVuY3Rpb24gKHRyYW5zbGF0ZSwgYnlDb250cm9sbGVyKSB7XG4gICAgICAgICAgICAgICB2YXIgY29udHJvbGxlZCA9IHMucGFyYW1zLmNvbnRyb2w7XG4gICAgICAgICAgICAgICB2YXIgbXVsdGlwbGllciwgY29udHJvbGxlZFRyYW5zbGF0ZTtcbiAgICAgICAgICAgICAgIGZ1bmN0aW9uIHNldENvbnRyb2xsZWRUcmFuc2xhdGUoYykge1xuICAgICAgICAgICAgICAgICAgICAvLyB0aGlzIHdpbGwgY3JlYXRlIGFuIEludGVycG9sYXRlIGZ1bmN0aW9uIGJhc2VkIG9uIHRoZSBzbmFwR3JpZHNcbiAgICAgICAgICAgICAgICAgICAgLy8geCBpcyB0aGUgR3JpZCBvZiB0aGUgc2Nyb2xsZWQgc2Nyb2xsZXIgYW5kIHkgd2lsbCBiZSB0aGUgY29udHJvbGxlZCBzY3JvbGxlclxuICAgICAgICAgICAgICAgICAgICAvLyBpdCBtYWtlcyBzZW5zZSB0byBjcmVhdGUgdGhpcyBvbmx5IG9uY2UgYW5kIHJlY2FsbCBpdCBmb3IgdGhlIGludGVycG9sYXRpb25cbiAgICAgICAgICAgICAgICAgICAgLy8gdGhlIGZ1bmN0aW9uIGRvZXMgYSBsb3Qgb2YgdmFsdWUgY2FjaGluZyBmb3IgcGVyZm9ybWFuY2VcbiAgICAgICAgICAgICAgICAgICAgdHJhbnNsYXRlID0gYy5ydGwgJiYgYy5wYXJhbXMuZGlyZWN0aW9uID09PSAnaG9yaXpvbnRhbCcgPyAtcy50cmFuc2xhdGUgOiBzLnRyYW5zbGF0ZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmNvbnRyb2xCeSA9PT0gJ3NsaWRlJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5jb250cm9sbGVyLmdldEludGVycG9sYXRlRnVuY3Rpb24oYyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBpIGFtIG5vdCBzdXJlIHdoeSB0aGUgdmFsdWVzIGhhdmUgdG8gYmUgbXVsdGlwbGljYXRlZCB0aGlzIHdheSwgdHJpZWQgdG8gaW52ZXJ0IHRoZSBzbmFwR3JpZFxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnV0IGl0IGRpZCBub3Qgd29yayBvdXRcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRyb2xsZWRUcmFuc2xhdGUgPSAtcy5jb250cm9sbGVyLnNwbGluZS5pbnRlcnBvbGF0ZSgtdHJhbnNsYXRlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYoIWNvbnRyb2xsZWRUcmFuc2xhdGUgfHwgcy5wYXJhbXMuY29udHJvbEJ5ID09PSAnY29udGFpbmVyJyl7XG4gICAgICAgICAgICAgICAgICAgICAgICBtdWx0aXBsaWVyID0gKGMubWF4VHJhbnNsYXRlKCkgLSBjLm1pblRyYW5zbGF0ZSgpKSAvIChzLm1heFRyYW5zbGF0ZSgpIC0gcy5taW5UcmFuc2xhdGUoKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb250cm9sbGVkVHJhbnNsYXRlID0gKHRyYW5zbGF0ZSAtIHMubWluVHJhbnNsYXRlKCkpICogbXVsdGlwbGllciArIGMubWluVHJhbnNsYXRlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5jb250cm9sSW52ZXJzZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udHJvbGxlZFRyYW5zbGF0ZSA9IGMubWF4VHJhbnNsYXRlKCkgLSBjb250cm9sbGVkVHJhbnNsYXRlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGMudXBkYXRlUHJvZ3Jlc3MoY29udHJvbGxlZFRyYW5zbGF0ZSk7XG4gICAgICAgICAgICAgICAgICAgIGMuc2V0V3JhcHBlclRyYW5zbGF0ZShjb250cm9sbGVkVHJhbnNsYXRlLCBmYWxzZSwgcyk7XG4gICAgICAgICAgICAgICAgICAgIGMudXBkYXRlQWN0aXZlSW5kZXgoKTtcbiAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgIGlmIChzLmlzQXJyYXkoY29udHJvbGxlZCkpIHtcbiAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNvbnRyb2xsZWQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRyb2xsZWRbaV0gIT09IGJ5Q29udHJvbGxlciAmJiBjb250cm9sbGVkW2ldIGluc3RhbmNlb2YgU3dpcGVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRDb250cm9sbGVkVHJhbnNsYXRlKGNvbnRyb2xsZWRbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgZWxzZSBpZiAoY29udHJvbGxlZCBpbnN0YW5jZW9mIFN3aXBlciAmJiBieUNvbnRyb2xsZXIgIT09IGNvbnRyb2xsZWQpIHtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgc2V0Q29udHJvbGxlZFRyYW5zbGF0ZShjb250cm9sbGVkKTtcbiAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzZXRUcmFuc2l0aW9uOiBmdW5jdGlvbiAoZHVyYXRpb24sIGJ5Q29udHJvbGxlcikge1xuICAgICAgICAgICAgICAgIHZhciBjb250cm9sbGVkID0gcy5wYXJhbXMuY29udHJvbDtcbiAgICAgICAgICAgICAgICB2YXIgaTtcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiBzZXRDb250cm9sbGVkVHJhbnNpdGlvbihjKSB7XG4gICAgICAgICAgICAgICAgICAgIGMuc2V0V3JhcHBlclRyYW5zaXRpb24oZHVyYXRpb24sIHMpO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZHVyYXRpb24gIT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGMub25UcmFuc2l0aW9uU3RhcnQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGMud3JhcHBlci50cmFuc2l0aW9uRW5kKGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFjb250cm9sbGVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGMucGFyYW1zLmxvb3AgJiYgcy5wYXJhbXMuY29udHJvbEJ5ID09PSAnc2xpZGUnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGMuZml4TG9vcCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjLm9uVHJhbnNpdGlvbkVuZCgpO1xuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChzLmlzQXJyYXkoY29udHJvbGxlZCkpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNvbnRyb2xsZWQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb250cm9sbGVkW2ldICE9PSBieUNvbnRyb2xsZXIgJiYgY29udHJvbGxlZFtpXSBpbnN0YW5jZW9mIFN3aXBlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNldENvbnRyb2xsZWRUcmFuc2l0aW9uKGNvbnRyb2xsZWRbaV0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKGNvbnRyb2xsZWQgaW5zdGFuY2VvZiBTd2lwZXIgJiYgYnlDb250cm9sbGVyICE9PSBjb250cm9sbGVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHNldENvbnRyb2xsZWRUcmFuc2l0aW9uKGNvbnRyb2xsZWQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgUGFyYWxsYXhcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBmdW5jdGlvbiBzZXRQYXJhbGxheFRyYW5zZm9ybShlbCwgcHJvZ3Jlc3MpIHtcbiAgICAgICAgICAgIGVsID0gJChlbCk7XG4gICAgICAgICAgICB2YXIgcCwgcFgsIHBZO1xuICAgICAgICAgICAgdmFyIHJ0bEZhY3RvciA9IHMucnRsID8gLTEgOiAxO1xuICAgICAgICBcbiAgICAgICAgICAgIHAgPSBlbC5hdHRyKCdkYXRhLXN3aXBlci1wYXJhbGxheCcpIHx8ICcwJztcbiAgICAgICAgICAgIHBYID0gZWwuYXR0cignZGF0YS1zd2lwZXItcGFyYWxsYXgteCcpO1xuICAgICAgICAgICAgcFkgPSBlbC5hdHRyKCdkYXRhLXN3aXBlci1wYXJhbGxheC15Jyk7XG4gICAgICAgICAgICBpZiAocFggfHwgcFkpIHtcbiAgICAgICAgICAgICAgICBwWCA9IHBYIHx8ICcwJztcbiAgICAgICAgICAgICAgICBwWSA9IHBZIHx8ICcwJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChzLmlzSG9yaXpvbnRhbCgpKSB7XG4gICAgICAgICAgICAgICAgICAgIHBYID0gcDtcbiAgICAgICAgICAgICAgICAgICAgcFkgPSAnMCc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBwWSA9IHA7XG4gICAgICAgICAgICAgICAgICAgIHBYID0gJzAnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICBpZiAoKHBYKS5pbmRleE9mKCclJykgPj0gMCkge1xuICAgICAgICAgICAgICAgIHBYID0gcGFyc2VJbnQocFgsIDEwKSAqIHByb2dyZXNzICogcnRsRmFjdG9yICsgJyUnO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcFggPSBwWCAqIHByb2dyZXNzICogcnRsRmFjdG9yICsgJ3B4JyA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoKHBZKS5pbmRleE9mKCclJykgPj0gMCkge1xuICAgICAgICAgICAgICAgIHBZID0gcGFyc2VJbnQocFksIDEwKSAqIHByb2dyZXNzICsgJyUnO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcFkgPSBwWSAqIHByb2dyZXNzICsgJ3B4JyA7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgZWwudHJhbnNmb3JtKCd0cmFuc2xhdGUzZCgnICsgcFggKyAnLCAnICsgcFkgKyAnLDBweCknKTtcbiAgICAgICAgfVxuICAgICAgICBzLnBhcmFsbGF4ID0ge1xuICAgICAgICAgICAgc2V0VHJhbnNsYXRlOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcy5jb250YWluZXIuY2hpbGRyZW4oJ1tkYXRhLXN3aXBlci1wYXJhbGxheF0sIFtkYXRhLXN3aXBlci1wYXJhbGxheC14XSwgW2RhdGEtc3dpcGVyLXBhcmFsbGF4LXldJykuZWFjaChmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgICAgICBzZXRQYXJhbGxheFRyYW5zZm9ybSh0aGlzLCBzLnByb2dyZXNzKTtcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcy5zbGlkZXMuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBzbGlkZSA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIHNsaWRlLmZpbmQoJ1tkYXRhLXN3aXBlci1wYXJhbGxheF0sIFtkYXRhLXN3aXBlci1wYXJhbGxheC14XSwgW2RhdGEtc3dpcGVyLXBhcmFsbGF4LXldJykuZWFjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJvZ3Jlc3MgPSBNYXRoLm1pbihNYXRoLm1heChzbGlkZVswXS5wcm9ncmVzcywgLTEpLCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNldFBhcmFsbGF4VHJhbnNmb3JtKHRoaXMsIHByb2dyZXNzKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgc2V0VHJhbnNpdGlvbjogZnVuY3Rpb24gKGR1cmF0aW9uKSB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBkdXJhdGlvbiA9PT0gJ3VuZGVmaW5lZCcpIGR1cmF0aW9uID0gcy5wYXJhbXMuc3BlZWQ7XG4gICAgICAgICAgICAgICAgcy5jb250YWluZXIuZmluZCgnW2RhdGEtc3dpcGVyLXBhcmFsbGF4XSwgW2RhdGEtc3dpcGVyLXBhcmFsbGF4LXhdLCBbZGF0YS1zd2lwZXItcGFyYWxsYXgteV0nKS5lYWNoKGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgICAgIHZhciBlbCA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBwYXJhbGxheER1cmF0aW9uID0gcGFyc2VJbnQoZWwuYXR0cignZGF0YS1zd2lwZXItcGFyYWxsYXgtZHVyYXRpb24nKSwgMTApIHx8IGR1cmF0aW9uO1xuICAgICAgICAgICAgICAgICAgICBpZiAoZHVyYXRpb24gPT09IDApIHBhcmFsbGF4RHVyYXRpb24gPSAwO1xuICAgICAgICAgICAgICAgICAgICBlbC50cmFuc2l0aW9uKHBhcmFsbGF4RHVyYXRpb24pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgUGx1Z2lucyBBUEkuIENvbGxlY3QgYWxsIGFuZCBpbml0IGFsbCBwbHVnaW5zXG4gICAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgcy5fcGx1Z2lucyA9IFtdO1xuICAgICAgICBmb3IgKHZhciBwbHVnaW4gaW4gcy5wbHVnaW5zKSB7XG4gICAgICAgICAgICB2YXIgcCA9IHMucGx1Z2luc1twbHVnaW5dKHMsIHMucGFyYW1zW3BsdWdpbl0pO1xuICAgICAgICAgICAgaWYgKHApIHMuX3BsdWdpbnMucHVzaChwKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBNZXRob2QgdG8gY2FsbCBhbGwgcGx1Z2lucyBldmVudC9tZXRob2RcbiAgICAgICAgcy5jYWxsUGx1Z2lucyA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcy5fcGx1Z2lucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGlmIChldmVudE5hbWUgaW4gcy5fcGx1Z2luc1tpXSkge1xuICAgICAgICAgICAgICAgICAgICBzLl9wbHVnaW5zW2ldW2V2ZW50TmFtZV0oYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0sIGFyZ3VtZW50c1szXSwgYXJndW1lbnRzWzRdLCBhcmd1bWVudHNbNV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICBcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgICAgRXZlbnRzL0NhbGxiYWNrcy9QbHVnaW5zIEVtaXR0ZXJcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBmdW5jdGlvbiBub3JtYWxpemVFdmVudE5hbWUgKGV2ZW50TmFtZSkge1xuICAgICAgICAgICAgaWYgKGV2ZW50TmFtZS5pbmRleE9mKCdvbicpICE9PSAwKSB7XG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50TmFtZVswXSAhPT0gZXZlbnROYW1lWzBdLnRvVXBwZXJDYXNlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgZXZlbnROYW1lID0gJ29uJyArIGV2ZW50TmFtZVswXS50b1VwcGVyQ2FzZSgpICsgZXZlbnROYW1lLnN1YnN0cmluZygxKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGV2ZW50TmFtZSA9ICdvbicgKyBldmVudE5hbWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGV2ZW50TmFtZTtcbiAgICAgICAgfVxuICAgICAgICBzLmVtaXR0ZXJFdmVudExpc3RlbmVycyA9IHtcbiAgICAgICAgXG4gICAgICAgIH07XG4gICAgICAgIHMuZW1pdCA9IGZ1bmN0aW9uIChldmVudE5hbWUpIHtcbiAgICAgICAgICAgIC8vIFRyaWdnZXIgY2FsbGJhY2tzXG4gICAgICAgICAgICBpZiAocy5wYXJhbXNbZXZlbnROYW1lXSkge1xuICAgICAgICAgICAgICAgIHMucGFyYW1zW2V2ZW50TmFtZV0oYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0sIGFyZ3VtZW50c1szXSwgYXJndW1lbnRzWzRdLCBhcmd1bWVudHNbNV0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIGk7XG4gICAgICAgICAgICAvLyBUcmlnZ2VyIGV2ZW50c1xuICAgICAgICAgICAgaWYgKHMuZW1pdHRlckV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0pIHtcbiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcy5lbWl0dGVyRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBzLmVtaXR0ZXJFdmVudExpc3RlbmVyc1tldmVudE5hbWVdW2ldKGFyZ3VtZW50c1sxXSwgYXJndW1lbnRzWzJdLCBhcmd1bWVudHNbM10sIGFyZ3VtZW50c1s0XSwgYXJndW1lbnRzWzVdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBUcmlnZ2VyIHBsdWdpbnNcbiAgICAgICAgICAgIGlmIChzLmNhbGxQbHVnaW5zKSBzLmNhbGxQbHVnaW5zKGV2ZW50TmFtZSwgYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0sIGFyZ3VtZW50c1szXSwgYXJndW1lbnRzWzRdLCBhcmd1bWVudHNbNV0pO1xuICAgICAgICB9O1xuICAgICAgICBzLm9uID0gZnVuY3Rpb24gKGV2ZW50TmFtZSwgaGFuZGxlcikge1xuICAgICAgICAgICAgZXZlbnROYW1lID0gbm9ybWFsaXplRXZlbnROYW1lKGV2ZW50TmFtZSk7XG4gICAgICAgICAgICBpZiAoIXMuZW1pdHRlckV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0pIHMuZW1pdHRlckV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0gPSBbXTtcbiAgICAgICAgICAgIHMuZW1pdHRlckV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0ucHVzaChoYW5kbGVyKTtcbiAgICAgICAgICAgIHJldHVybiBzO1xuICAgICAgICB9O1xuICAgICAgICBzLm9mZiA9IGZ1bmN0aW9uIChldmVudE5hbWUsIGhhbmRsZXIpIHtcbiAgICAgICAgICAgIHZhciBpO1xuICAgICAgICAgICAgZXZlbnROYW1lID0gbm9ybWFsaXplRXZlbnROYW1lKGV2ZW50TmFtZSk7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGhhbmRsZXIgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGFsbCBoYW5kbGVycyBmb3Igc3VjaCBldmVudFxuICAgICAgICAgICAgICAgIHMuZW1pdHRlckV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0gPSBbXTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghcy5lbWl0dGVyRXZlbnRMaXN0ZW5lcnNbZXZlbnROYW1lXSB8fCBzLmVtaXR0ZXJFdmVudExpc3RlbmVyc1tldmVudE5hbWVdLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHMuZW1pdHRlckV2ZW50TGlzdGVuZXJzW2V2ZW50TmFtZV0ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBpZihzLmVtaXR0ZXJFdmVudExpc3RlbmVyc1tldmVudE5hbWVdW2ldID09PSBoYW5kbGVyKSBzLmVtaXR0ZXJFdmVudExpc3RlbmVyc1tldmVudE5hbWVdLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBzO1xuICAgICAgICB9O1xuICAgICAgICBzLm9uY2UgPSBmdW5jdGlvbiAoZXZlbnROYW1lLCBoYW5kbGVyKSB7XG4gICAgICAgICAgICBldmVudE5hbWUgPSBub3JtYWxpemVFdmVudE5hbWUoZXZlbnROYW1lKTtcbiAgICAgICAgICAgIHZhciBfaGFuZGxlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBoYW5kbGVyKGFyZ3VtZW50c1swXSwgYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0sIGFyZ3VtZW50c1szXSwgYXJndW1lbnRzWzRdKTtcbiAgICAgICAgICAgICAgICBzLm9mZihldmVudE5hbWUsIF9oYW5kbGVyKTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBzLm9uKGV2ZW50TmFtZSwgX2hhbmRsZXIpO1xuICAgICAgICAgICAgcmV0dXJuIHM7XG4gICAgICAgIH07XG4gICAgXG4gICAgICAgIC8vIEFjY2Vzc2liaWxpdHkgdG9vbHNcbiAgICAgICAgcy5hMTF5ID0ge1xuICAgICAgICAgICAgbWFrZUZvY3VzYWJsZTogZnVuY3Rpb24gKCRlbCkge1xuICAgICAgICAgICAgICAgICRlbC5hdHRyKCd0YWJJbmRleCcsICcwJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuICRlbDtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBhZGRSb2xlOiBmdW5jdGlvbiAoJGVsLCByb2xlKSB7XG4gICAgICAgICAgICAgICAgJGVsLmF0dHIoJ3JvbGUnLCByb2xlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gJGVsO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgXG4gICAgICAgICAgICBhZGRMYWJlbDogZnVuY3Rpb24gKCRlbCwgbGFiZWwpIHtcbiAgICAgICAgICAgICAgICAkZWwuYXR0cignYXJpYS1sYWJlbCcsIGxhYmVsKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gJGVsO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgXG4gICAgICAgICAgICBkaXNhYmxlOiBmdW5jdGlvbiAoJGVsKSB7XG4gICAgICAgICAgICAgICAgJGVsLmF0dHIoJ2FyaWEtZGlzYWJsZWQnLCB0cnVlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gJGVsO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgXG4gICAgICAgICAgICBlbmFibGU6IGZ1bmN0aW9uICgkZWwpIHtcbiAgICAgICAgICAgICAgICAkZWwuYXR0cignYXJpYS1kaXNhYmxlZCcsIGZhbHNlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gJGVsO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgXG4gICAgICAgICAgICBvbkVudGVyS2V5OiBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQua2V5Q29kZSAhPT0gMTMpIHJldHVybjtcbiAgICAgICAgICAgICAgICBpZiAoJChldmVudC50YXJnZXQpLmlzKHMucGFyYW1zLm5leHRCdXR0b24pKSB7XG4gICAgICAgICAgICAgICAgICAgIHMub25DbGlja05leHQoZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5pc0VuZCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5hMTF5Lm5vdGlmeShzLnBhcmFtcy5sYXN0U2xpZGVNZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMuYTExeS5ub3RpZnkocy5wYXJhbXMubmV4dFNsaWRlTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoJChldmVudC50YXJnZXQpLmlzKHMucGFyYW1zLnByZXZCdXR0b24pKSB7XG4gICAgICAgICAgICAgICAgICAgIHMub25DbGlja1ByZXYoZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5pc0JlZ2lubmluZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5hMTF5Lm5vdGlmeShzLnBhcmFtcy5maXJzdFNsaWRlTWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmExMXkubm90aWZ5KHMucGFyYW1zLnByZXZTbGlkZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICgkKGV2ZW50LnRhcmdldCkuaXMoJy4nICsgcy5wYXJhbXMuYnVsbGV0Q2xhc3MpKSB7XG4gICAgICAgICAgICAgICAgICAgICQoZXZlbnQudGFyZ2V0KVswXS5jbGljaygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgIFxuICAgICAgICAgICAgbGl2ZVJlZ2lvbjogJCgnPHNwYW4gY2xhc3M9XCJzd2lwZXItbm90aWZpY2F0aW9uXCIgYXJpYS1saXZlPVwiYXNzZXJ0aXZlXCIgYXJpYS1hdG9taWM9XCJ0cnVlXCI+PC9zcGFuPicpLFxuICAgICAgICBcbiAgICAgICAgICAgIG5vdGlmeTogZnVuY3Rpb24gKG1lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICB2YXIgbm90aWZpY2F0aW9uID0gcy5hMTF5LmxpdmVSZWdpb247XG4gICAgICAgICAgICAgICAgaWYgKG5vdGlmaWNhdGlvbi5sZW5ndGggPT09IDApIHJldHVybjtcbiAgICAgICAgICAgICAgICBub3RpZmljYXRpb24uaHRtbCgnJyk7XG4gICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uLmh0bWwobWVzc2FnZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIC8vIFNldHVwIGFjY2Vzc2liaWxpdHlcbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMubmV4dEJ1dHRvbiAmJiBzLm5leHRCdXR0b24gJiYgcy5uZXh0QnV0dG9uLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcy5hMTF5Lm1ha2VGb2N1c2FibGUocy5uZXh0QnV0dG9uKTtcbiAgICAgICAgICAgICAgICAgICAgcy5hMTF5LmFkZFJvbGUocy5uZXh0QnV0dG9uLCAnYnV0dG9uJyk7XG4gICAgICAgICAgICAgICAgICAgIHMuYTExeS5hZGRMYWJlbChzLm5leHRCdXR0b24sIHMucGFyYW1zLm5leHRTbGlkZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAocy5wYXJhbXMucHJldkJ1dHRvbiAmJiBzLnByZXZCdXR0b24gJiYgcy5wcmV2QnV0dG9uLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcy5hMTF5Lm1ha2VGb2N1c2FibGUocy5wcmV2QnV0dG9uKTtcbiAgICAgICAgICAgICAgICAgICAgcy5hMTF5LmFkZFJvbGUocy5wcmV2QnV0dG9uLCAnYnV0dG9uJyk7XG4gICAgICAgICAgICAgICAgICAgIHMuYTExeS5hZGRMYWJlbChzLnByZXZCdXR0b24sIHMucGFyYW1zLnByZXZTbGlkZU1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgICAgICAgICAgJChzLmNvbnRhaW5lcikuYXBwZW5kKHMuYTExeS5saXZlUmVnaW9uKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBpbml0UGFnaW5hdGlvbjogZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wYWdpbmF0aW9uICYmIHMucGFyYW1zLnBhZ2luYXRpb25DbGlja2FibGUgJiYgcy5idWxsZXRzICYmIHMuYnVsbGV0cy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5idWxsZXRzLmVhY2goZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGJ1bGxldCA9ICQodGhpcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmExMXkubWFrZUZvY3VzYWJsZShidWxsZXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5hMTF5LmFkZFJvbGUoYnVsbGV0LCAnYnV0dG9uJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzLmExMXkuYWRkTGFiZWwoYnVsbGV0LCBzLnBhcmFtcy5wYWdpbmF0aW9uQnVsbGV0TWVzc2FnZS5yZXBsYWNlKC97e2luZGV4fX0vLCBidWxsZXQuaW5kZXgoKSArIDEpKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAocy5hMTF5LmxpdmVSZWdpb24gJiYgcy5hMTF5LmxpdmVSZWdpb24ubGVuZ3RoID4gMCkgcy5hMTF5LmxpdmVSZWdpb24ucmVtb3ZlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgIFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgICBJbml0L0Rlc3Ryb3lcbiAgICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBzLmluaXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMubG9vcCkgcy5jcmVhdGVMb29wKCk7XG4gICAgICAgICAgICBzLnVwZGF0ZUNvbnRhaW5lclNpemUoKTtcbiAgICAgICAgICAgIHMudXBkYXRlU2xpZGVzU2l6ZSgpO1xuICAgICAgICAgICAgcy51cGRhdGVQYWdpbmF0aW9uKCk7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuc2Nyb2xsYmFyICYmIHMuc2Nyb2xsYmFyKSB7XG4gICAgICAgICAgICAgICAgcy5zY3JvbGxiYXIuc2V0KCk7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNjcm9sbGJhckRyYWdnYWJsZSkge1xuICAgICAgICAgICAgICAgICAgICBzLnNjcm9sbGJhci5lbmFibGVEcmFnZ2FibGUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMuZWZmZWN0ICE9PSAnc2xpZGUnICYmIHMuZWZmZWN0c1tzLnBhcmFtcy5lZmZlY3RdKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzLnBhcmFtcy5sb29wKSBzLnVwZGF0ZVByb2dyZXNzKCk7XG4gICAgICAgICAgICAgICAgcy5lZmZlY3RzW3MucGFyYW1zLmVmZmVjdF0uc2V0VHJhbnNsYXRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMubG9vcCkge1xuICAgICAgICAgICAgICAgIHMuc2xpZGVUbyhzLnBhcmFtcy5pbml0aWFsU2xpZGUgKyBzLmxvb3BlZFNsaWRlcywgMCwgcy5wYXJhbXMucnVuQ2FsbGJhY2tzT25Jbml0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHMuc2xpZGVUbyhzLnBhcmFtcy5pbml0aWFsU2xpZGUsIDAsIHMucGFyYW1zLnJ1bkNhbGxiYWNrc09uSW5pdCk7XG4gICAgICAgICAgICAgICAgaWYgKHMucGFyYW1zLmluaXRpYWxTbGlkZSA9PT0gMCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocy5wYXJhbGxheCAmJiBzLnBhcmFtcy5wYXJhbGxheCkgcy5wYXJhbGxheC5zZXRUcmFuc2xhdGUoKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHMubGF6eSAmJiBzLnBhcmFtcy5sYXp5TG9hZGluZykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcy5sYXp5LmxvYWQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHMubGF6eS5pbml0aWFsSW1hZ2VMb2FkZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcy5hdHRhY2hFdmVudHMoKTtcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5vYnNlcnZlciAmJiBzLnN1cHBvcnQub2JzZXJ2ZXIpIHtcbiAgICAgICAgICAgICAgICBzLmluaXRPYnNlcnZlcnMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5wcmVsb2FkSW1hZ2VzICYmICFzLnBhcmFtcy5sYXp5TG9hZGluZykge1xuICAgICAgICAgICAgICAgIHMucHJlbG9hZEltYWdlcygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmF1dG9wbGF5KSB7XG4gICAgICAgICAgICAgICAgcy5zdGFydEF1dG9wbGF5KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMua2V5Ym9hcmRDb250cm9sKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMuZW5hYmxlS2V5Ym9hcmRDb250cm9sKSBzLmVuYWJsZUtleWJvYXJkQ29udHJvbCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLm1vdXNld2hlZWxDb250cm9sKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMuZW5hYmxlTW91c2V3aGVlbENvbnRyb2wpIHMuZW5hYmxlTW91c2V3aGVlbENvbnRyb2woKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5oYXNobmF2KSB7XG4gICAgICAgICAgICAgICAgaWYgKHMuaGFzaG5hdikgcy5oYXNobmF2LmluaXQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5hMTF5ICYmIHMuYTExeSkgcy5hMTF5LmluaXQoKTtcbiAgICAgICAgICAgIHMuZW1pdCgnb25Jbml0Jywgcyk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvLyBDbGVhbnVwIGR5bmFtaWMgc3R5bGVzXG4gICAgICAgIHMuY2xlYW51cFN0eWxlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIC8vIENvbnRhaW5lclxuICAgICAgICAgICAgcy5jb250YWluZXIucmVtb3ZlQ2xhc3Mocy5jbGFzc05hbWVzLmpvaW4oJyAnKSkucmVtb3ZlQXR0cignc3R5bGUnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBXcmFwcGVyXG4gICAgICAgICAgICBzLndyYXBwZXIucmVtb3ZlQXR0cignc3R5bGUnKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTbGlkZXNcbiAgICAgICAgICAgIGlmIChzLnNsaWRlcyAmJiBzLnNsaWRlcy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBzLnNsaWRlc1xuICAgICAgICAgICAgICAgICAgICAucmVtb3ZlQ2xhc3MoW1xuICAgICAgICAgICAgICAgICAgICAgIHMucGFyYW1zLnNsaWRlVmlzaWJsZUNsYXNzLFxuICAgICAgICAgICAgICAgICAgICAgIHMucGFyYW1zLnNsaWRlQWN0aXZlQ2xhc3MsXG4gICAgICAgICAgICAgICAgICAgICAgcy5wYXJhbXMuc2xpZGVOZXh0Q2xhc3MsXG4gICAgICAgICAgICAgICAgICAgICAgcy5wYXJhbXMuc2xpZGVQcmV2Q2xhc3NcbiAgICAgICAgICAgICAgICAgICAgXS5qb2luKCcgJykpXG4gICAgICAgICAgICAgICAgICAgIC5yZW1vdmVBdHRyKCdzdHlsZScpXG4gICAgICAgICAgICAgICAgICAgIC5yZW1vdmVBdHRyKCdkYXRhLXN3aXBlci1jb2x1bW4nKVxuICAgICAgICAgICAgICAgICAgICAucmVtb3ZlQXR0cignZGF0YS1zd2lwZXItcm93Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gUGFnaW5hdGlvbi9CdWxsZXRzXG4gICAgICAgICAgICBpZiAocy5wYWdpbmF0aW9uQ29udGFpbmVyICYmIHMucGFnaW5hdGlvbkNvbnRhaW5lci5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBzLnBhZ2luYXRpb25Db250YWluZXIucmVtb3ZlQ2xhc3Mocy5wYXJhbXMucGFnaW5hdGlvbkhpZGRlbkNsYXNzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChzLmJ1bGxldHMgJiYgcy5idWxsZXRzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHMuYnVsbGV0cy5yZW1vdmVDbGFzcyhzLnBhcmFtcy5idWxsZXRBY3RpdmVDbGFzcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAgICAgLy8gQnV0dG9uc1xuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnByZXZCdXR0b24pICQocy5wYXJhbXMucHJldkJ1dHRvbikucmVtb3ZlQ2xhc3Mocy5wYXJhbXMuYnV0dG9uRGlzYWJsZWRDbGFzcyk7XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMubmV4dEJ1dHRvbikgJChzLnBhcmFtcy5uZXh0QnV0dG9uKS5yZW1vdmVDbGFzcyhzLnBhcmFtcy5idXR0b25EaXNhYmxlZENsYXNzKTtcbiAgICAgICAgXG4gICAgICAgICAgICAvLyBTY3JvbGxiYXJcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zY3JvbGxiYXIgJiYgcy5zY3JvbGxiYXIpIHtcbiAgICAgICAgICAgICAgICBpZiAocy5zY3JvbGxiYXIudHJhY2sgJiYgcy5zY3JvbGxiYXIudHJhY2subGVuZ3RoKSBzLnNjcm9sbGJhci50cmFjay5yZW1vdmVBdHRyKCdzdHlsZScpO1xuICAgICAgICAgICAgICAgIGlmIChzLnNjcm9sbGJhci5kcmFnICYmIHMuc2Nyb2xsYmFyLmRyYWcubGVuZ3RoKSBzLnNjcm9sbGJhci5kcmFnLnJlbW92ZUF0dHIoJ3N0eWxlJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvLyBEZXN0cm95XG4gICAgICAgIHMuZGVzdHJveSA9IGZ1bmN0aW9uIChkZWxldGVJbnN0YW5jZSwgY2xlYW51cFN0eWxlcykge1xuICAgICAgICAgICAgLy8gRGV0YWNoIGV2ZWJ0c1xuICAgICAgICAgICAgcy5kZXRhY2hFdmVudHMoKTtcbiAgICAgICAgICAgIC8vIFN0b3AgYXV0b3BsYXlcbiAgICAgICAgICAgIHMuc3RvcEF1dG9wbGF5KCk7XG4gICAgICAgICAgICAvLyBEaXNhYmxlIGRyYWdnYWJsZVxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLnNjcm9sbGJhciAmJiBzLnNjcm9sbGJhcikge1xuICAgICAgICAgICAgICAgIGlmIChzLnBhcmFtcy5zY3JvbGxiYXJEcmFnZ2FibGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcy5zY3JvbGxiYXIuZGlzYWJsZURyYWdnYWJsZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIERlc3Ryb3kgbG9vcFxuICAgICAgICAgICAgaWYgKHMucGFyYW1zLmxvb3ApIHtcbiAgICAgICAgICAgICAgICBzLmRlc3Ryb3lMb29wKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBDbGVhbnVwIHN0eWxlc1xuICAgICAgICAgICAgaWYgKGNsZWFudXBTdHlsZXMpIHtcbiAgICAgICAgICAgICAgICBzLmNsZWFudXBTdHlsZXMoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIERpc2Nvbm5lY3Qgb2JzZXJ2ZXJcbiAgICAgICAgICAgIHMuZGlzY29ubmVjdE9ic2VydmVycygpO1xuICAgICAgICAgICAgLy8gRGlzYWJsZSBrZXlib2FyZC9tb3VzZXdoZWVsXG4gICAgICAgICAgICBpZiAocy5wYXJhbXMua2V5Ym9hcmRDb250cm9sKSB7XG4gICAgICAgICAgICAgICAgaWYgKHMuZGlzYWJsZUtleWJvYXJkQ29udHJvbCkgcy5kaXNhYmxlS2V5Ym9hcmRDb250cm9sKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocy5wYXJhbXMubW91c2V3aGVlbENvbnRyb2wpIHtcbiAgICAgICAgICAgICAgICBpZiAocy5kaXNhYmxlTW91c2V3aGVlbENvbnRyb2wpIHMuZGlzYWJsZU1vdXNld2hlZWxDb250cm9sKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBEaXNhYmxlIGExMXlcbiAgICAgICAgICAgIGlmIChzLnBhcmFtcy5hMTF5ICYmIHMuYTExeSkgcy5hMTF5LmRlc3Ryb3koKTtcbiAgICAgICAgICAgIC8vIERlc3Ryb3kgY2FsbGJhY2tcbiAgICAgICAgICAgIHMuZW1pdCgnb25EZXN0cm95Jyk7XG4gICAgICAgICAgICAvLyBEZWxldGUgaW5zdGFuY2VcbiAgICAgICAgICAgIGlmIChkZWxldGVJbnN0YW5jZSAhPT0gZmFsc2UpIHMgPSBudWxsO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgcy5pbml0KCk7XG4gICAgICAgIFxuICAgIFxuICAgIFxuICAgICAgICAvLyBSZXR1cm4gc3dpcGVyIGluc3RhbmNlXG4gICAgICAgIHJldHVybiBzO1xuICAgIH07XG4gICAgXG4gICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICBQcm90b3R5cGVcbiAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICBTd2lwZXIucHJvdG90eXBlID0ge1xuICAgICAgICBpc1NhZmFyaTogKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIHJldHVybiAodWEuaW5kZXhPZignc2FmYXJpJykgPj0gMCAmJiB1YS5pbmRleE9mKCdjaHJvbWUnKSA8IDAgJiYgdWEuaW5kZXhPZignYW5kcm9pZCcpIDwgMCk7XG4gICAgICAgIH0pKCksXG4gICAgICAgIGlzVWlXZWJWaWV3OiAvKGlQaG9uZXxpUG9kfGlQYWQpLipBcHBsZVdlYktpdCg/IS4qU2FmYXJpKS9pLnRlc3QobmF2aWdhdG9yLnVzZXJBZ2VudCksXG4gICAgICAgIGlzQXJyYXk6IGZ1bmN0aW9uIChhcnIpIHtcbiAgICAgICAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmFwcGx5KGFycikgPT09ICdbb2JqZWN0IEFycmF5XSc7XG4gICAgICAgIH0sXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgQnJvd3NlclxuICAgICAgICA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Ki9cbiAgICAgICAgYnJvd3Nlcjoge1xuICAgICAgICAgICAgaWU6IHdpbmRvdy5uYXZpZ2F0b3IucG9pbnRlckVuYWJsZWQgfHwgd2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkLFxuICAgICAgICAgICAgaWVUb3VjaDogKHdpbmRvdy5uYXZpZ2F0b3IubXNQb2ludGVyRW5hYmxlZCAmJiB3aW5kb3cubmF2aWdhdG9yLm1zTWF4VG91Y2hQb2ludHMgPiAxKSB8fCAod2luZG93Lm5hdmlnYXRvci5wb2ludGVyRW5hYmxlZCAmJiB3aW5kb3cubmF2aWdhdG9yLm1heFRvdWNoUG9pbnRzID4gMSlcbiAgICAgICAgfSxcbiAgICAgICAgLyo9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuICAgICAgICBEZXZpY2VzXG4gICAgICAgID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0qL1xuICAgICAgICBkZXZpY2U6IChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50O1xuICAgICAgICAgICAgdmFyIGFuZHJvaWQgPSB1YS5tYXRjaCgvKEFuZHJvaWQpOz9bXFxzXFwvXSsoW1xcZC5dKyk/Lyk7XG4gICAgICAgICAgICB2YXIgaXBhZCA9IHVhLm1hdGNoKC8oaVBhZCkuKk9TXFxzKFtcXGRfXSspLyk7XG4gICAgICAgICAgICB2YXIgaXBvZCA9IHVhLm1hdGNoKC8oaVBvZCkoLipPU1xccyhbXFxkX10rKSk/Lyk7XG4gICAgICAgICAgICB2YXIgaXBob25lID0gIWlwYWQgJiYgdWEubWF0Y2goLyhpUGhvbmVcXHNPUylcXHMoW1xcZF9dKykvKTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgaW9zOiBpcGFkIHx8IGlwaG9uZSB8fCBpcG9kLFxuICAgICAgICAgICAgICAgIGFuZHJvaWQ6IGFuZHJvaWRcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pKCksXG4gICAgICAgIC8qPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbiAgICAgICAgRmVhdHVyZSBEZXRlY3Rpb25cbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHN1cHBvcnQ6IHtcbiAgICAgICAgICAgIHRvdWNoIDogKHdpbmRvdy5Nb2Rlcm5penIgJiYgTW9kZXJuaXpyLnRvdWNoID09PSB0cnVlKSB8fCAoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgIHJldHVybiAhISgoJ29udG91Y2hzdGFydCcgaW4gd2luZG93KSB8fCB3aW5kb3cuRG9jdW1lbnRUb3VjaCAmJiBkb2N1bWVudCBpbnN0YW5jZW9mIERvY3VtZW50VG91Y2gpO1xuICAgICAgICAgICAgfSkoKSxcbiAgICBcbiAgICAgICAgICAgIHRyYW5zZm9ybXMzZCA6ICh3aW5kb3cuTW9kZXJuaXpyICYmIE1vZGVybml6ci5jc3N0cmFuc2Zvcm1zM2QgPT09IHRydWUpIHx8IChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLnN0eWxlO1xuICAgICAgICAgICAgICAgIHJldHVybiAoJ3dlYmtpdFBlcnNwZWN0aXZlJyBpbiBkaXYgfHwgJ01velBlcnNwZWN0aXZlJyBpbiBkaXYgfHwgJ09QZXJzcGVjdGl2ZScgaW4gZGl2IHx8ICdNc1BlcnNwZWN0aXZlJyBpbiBkaXYgfHwgJ3BlcnNwZWN0aXZlJyBpbiBkaXYpO1xuICAgICAgICAgICAgfSkoKSxcbiAgICBcbiAgICAgICAgICAgIGZsZXhib3g6IChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLnN0eWxlO1xuICAgICAgICAgICAgICAgIHZhciBzdHlsZXMgPSAoJ2FsaWduSXRlbXMgd2Via2l0QWxpZ25JdGVtcyB3ZWJraXRCb3hBbGlnbiBtc0ZsZXhBbGlnbiBtb3pCb3hBbGlnbiB3ZWJraXRGbGV4RGlyZWN0aW9uIG1zRmxleERpcmVjdGlvbiBtb3pCb3hEaXJlY3Rpb24gbW96Qm94T3JpZW50IHdlYmtpdEJveERpcmVjdGlvbiB3ZWJraXRCb3hPcmllbnQnKS5zcGxpdCgnICcpO1xuICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3R5bGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzdHlsZXNbaV0gaW4gZGl2KSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KSgpLFxuICAgIFxuICAgICAgICAgICAgb2JzZXJ2ZXI6IChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICgnTXV0YXRpb25PYnNlcnZlcicgaW4gd2luZG93IHx8ICdXZWJraXRNdXRhdGlvbk9ic2VydmVyJyBpbiB3aW5kb3cpO1xuICAgICAgICAgICAgfSkoKVxuICAgICAgICB9LFxuICAgICAgICAvKj09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4gICAgICAgIFBsdWdpbnNcbiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSovXG4gICAgICAgIHBsdWdpbnM6IHt9XG4gICAgfTtcblxufSkoKTtcblxuLy8jIHNvdXJjZU1hcHBpbmdVUkw9ZnJhbWV3b3JrNy5qcy5tYXBcbiJdfQ==
